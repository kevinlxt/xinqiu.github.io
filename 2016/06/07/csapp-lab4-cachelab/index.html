
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="一人Code">
    <title>CSAPP Lab4 解题分析 - 一人Code</title>
    <meta name="author" content="Xin Qiu">
    
    
    
    <meta name="description" content="csapp">
<meta property="og:type" content="blog">
<meta property="og:title" content="CSAPP Lab4 解题分析">
<meta property="og:url" content="http://xinqiu.me/2016/06/07/csapp-lab4-cachelab/index.html">
<meta property="og:site_name" content="一人Code">
<meta property="og:description" content="csapp">
<meta property="og:updated_time" content="2016-06-10T14:12:07.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CSAPP Lab4 解题分析">
<meta name="twitter:description" content="csapp">
    
    
        
    
    
        <meta property="og:image" content="http://xinqiu.me/assets/images/avatar.png"/>
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-ejlztp1tasruqfvoz6xmgqng0anzae8ox7cqjj5yibieqgcmhe9fwxfae6zj.min.css">
    <!--STYLES END-->
    
    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-57881840-1']);
        _gaq.push(['_trackPageview']);
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>

    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="3">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <h1 class="header-title">
        <a class="header-title-link" href="/ ">一人Code</a>
    </h1>
    
        
            <a  class="header-right-picture "
                href="#about">
        
        
            <img class="header-picture" src="/assets/images/avatar.png"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="3">
    
        <div class="sidebar-profile">
            <a href="/#about">
                    <img class="sidebar-profile-picture" src="/assets/images/avatar.png"/>
            </a>
            <span class="sidebar-profile-name">Xin Qiu</span>
        </div>
    
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/ "
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-home"></i>
                    <span class="sidebar-button-desc">Home</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-archives"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
                    <span class="sidebar-button-desc">Archives</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-categories"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
                    <span class="sidebar-button-desc">Categories</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-tags"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
                    <span class="sidebar-button-desc">Tags</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/projects"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-code"></i>
                    <span class="sidebar-button-desc">Projects</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/reading-list"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-book"></i>
                    <span class="sidebar-button-desc">Reading List</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/timeline"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-calendar"></i>
                    <span class="sidebar-button-desc">Timeline</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="#about"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-user"></i>
                    <span class="sidebar-button-desc">About</span>
                </a>
        </li>
        
    </ul>
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="https://github.com/xinqiu" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-github"></i>
                    <span class="sidebar-button-desc">GitHub</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="mailto:xinqiu.94@gmail.com" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-envelope-o"></i>
                    <span class="sidebar-button-desc">Mail</span>
                </a>
        </li>
        
    </ul>
    
</nav>

            
            <div id="main" data-behavior="3"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post" itemscope itemType="http://schema.org/BlogPosting">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title" itemprop="headline">
            CSAPP Lab4 解题分析
        </h1>
    
    <div class="post-meta">
    <time itemprop="datePublished" content="Tue Jun 07 2016 00:00:00 GMT+0800">
	
		    Jun 07, 2016
    	
    </time>
    
</div>
</div>
    
    <div class="post-content markdown" itemprop="articleBody">
        <div class="main-content-wrap">
            <script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<blockquote>
<p>Lab4 的Cache Lab 的说明资料太少了，<code>csim.c</code> 里面空空的，惊了。身为弱渣的我只好先拿别人的代码来参考参考。这里选取的代码<a href="https://github.com/zhoudiqiu/Cache-lab/blob/master/lab4/csim.c" target="_blank" rel="external">csim.c</a>。</p>
</blockquote>
<h2 id="Part_A_3A_Writing_a_Cache_Simulator"><a href="#Part_A_3A_Writing_a_Cache_Simulator" class="headerlink" title="Part A: Writing a Cache Simulator"></a>Part A: Writing a Cache Simulator</h2><p>需要些一个Cache模拟器，将 <code>valgrind</code> 内存访问记录作为参数，模拟是否命中缓存。输出命中，不命中，移除。</p>
<p>lab里提供了一个写好的程序 <code>csim-ref</code> ，使用LRU(least-recently used)替换原则，模拟缓存命中情况。</p>
<p>实验指导上给出了命令行参数</p>
<p><code>Usage: ./csim-ref [-hv] -s &lt;s&gt; -E &lt;E&gt; -b &lt;b&gt; -t &lt;tracefile&gt;</code></p>
<ul>
<li><p><code>-h</code>: Optional help flag that prints usage info</p>
</li>
<li><p><code>-v</code>: Optional verbose flag that displays trace info</p>
</li>
<li><p><code>-s &lt;s&gt;</code>: Number of set index bits ($ S = 2^{s} $ is the number of sets) </p>
</li>
<li><p><code>-E &lt;E&gt;</code>: Associativity (number of lines per set)</p>
</li>
<li><p><code>-b &lt;b&gt;</code>: Number of block bits ($ B = 2^{b} $ is the block size)</p>
</li>
<li><p><code>-t &lt;tracefile&gt;</code>: Name of the valgrind trace to replay</p>
</li>
</ul>
<p>所以在 <code>csim.c</code> 里也可以写个打印帮助的函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">printUsage</span><span class="params">()</span></span>&#123;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Usage: ./csim [-h] [-v] -s &lt;s&gt; -E &lt;E&gt; -b &lt;b&gt; -t &lt;tracefile&gt;\n"</span>);</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"-s: number of set index(2^s sets)\n"</span>);</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"-E: number of lines per set\n"</span>);</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"-b: number of block offset bits\n"</span>);</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"-t: trace file name\n"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<a id="more"></a>
<p>参考书中对cache的描述，需要些用结构体定义出cache的一些属性</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span>&#123;</div><div class="line">    <span class="keyword">int</span> s;<span class="comment">//2^s sets</span></div><div class="line">    <span class="keyword">int</span> S;<span class="comment">//S=2^s</span></div><div class="line">    <span class="keyword">int</span> b;<span class="comment">//2^b per block	</span></div><div class="line">    <span class="keyword">int</span> B;<span class="comment">//B=2^b</span></div><div class="line">    <span class="keyword">int</span> E;<span class="comment">//number of lines per set</span></div><div class="line">    <span class="comment">//number to track the solution	</span></div><div class="line">    <span class="keyword">int</span> hitNum;</div><div class="line">    <span class="keyword">int</span> missNum;</div><div class="line">    <span class="keyword">int</span> evictionNum;</div><div class="line">    <span class="keyword">int</span> verbosity;</div><div class="line">&#125; cacheProperty;</div></pre></td></tr></table></figure>
<p>对应的说明可以看书中 Figure 6.28.</p>
<p>根据Figure 6.27，cache是一个set的数组，每个set包含一个或者多个行，每个行又包括一个有效位，tag标识位， 数据块。所以可以定义出cache的组成</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</div><div class="line">    <span class="keyword">int</span> valid;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> tag;</div><div class="line">    <span class="keyword">char</span> *block;</div><div class="line">    <span class="keyword">int</span> usedCounter;</div><div class="line">&#125; setLine;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</div><div class="line">    setLine *lines;</div><div class="line">&#125; cacheSet;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</div><div class="line">    cacheSet *sets;</div><div class="line">&#125; cache;</div></pre></td></tr></table></figure>
<p>接着就需要考虑cache的初始化。其实就是使用malloc分配内存给定义的cache。一开始所有的有效位和tag标识位都为0。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function">cache <span class="title">initiate</span><span class="params">(<span class="keyword">long</span> <span class="keyword">long</span> S, <span class="keyword">int</span> E)</span> </span></div><div class="line">&#123;</div><div class="line">    cache currentCache;	</div><div class="line">    cacheSet <span class="built_in">set</span>;</div><div class="line">    setLine line;</div><div class="line">    currentCache.sets = (cacheSet *) <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(cacheSet) * S);</div><div class="line">    <span class="comment">//loop to construct the set of the cache</span></div><div class="line">    <span class="keyword">int</span> i;</div><div class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; S; i++) </div><div class="line">    &#123;</div><div class="line">        <span class="built_in">set</span>.lines =  (setLine *) <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(setLine) * E);</div><div class="line">        currentCache.sets[i] = <span class="built_in">set</span>;</div><div class="line">        <span class="comment">//loop to construct the lines</span></div><div class="line">        <span class="keyword">int</span> j;</div><div class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; E; j++) </div><div class="line">        &#123;</div><div class="line">            line.valid = <span class="number">0</span>; </div><div class="line">            line.tag = <span class="number">0</span>; </div><div class="line">            <span class="built_in">set</span>.lines[j] = line;</div><div class="line">            line.usedCounter = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">    &#125; </div><div class="line">    <span class="keyword">return</span> currentCache;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对于判断是否命中，要判断两个部分，有效位是否设置，cache的line中tag标识位是否匹配。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">checkHit</span><span class="params">(setLine line, <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> tag)</span></span>&#123;</div><div class="line">    <span class="keyword">if</span>(line.valid)&#123;</div><div class="line">        <span class="keyword">if</span>(line.tag == tag)&#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>判断行里是否已经满了。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">checkFull</span><span class="params">(cacheSet <span class="built_in">set</span>, cacheProperty property)</span></span>&#123;</div><div class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i&lt;property.E; i++)&#123;</div><div class="line">        <span class="keyword">if</span>(<span class="built_in">set</span>.lines[i].valid == <span class="number">0</span>)&#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当需要缓存时，需要找到一个有效的缓存空间。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">findIndex</span><span class="params">(cacheSet <span class="built_in">set</span>, cacheProperty property)</span></span>&#123;</div><div class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i&lt;property.E; i++)&#123;</div><div class="line">        <span class="keyword">if</span>(<span class="built_in">set</span>.lines[i].valid == <span class="number">0</span>)&#123;</div><div class="line">            <span class="keyword">return</span> i;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//shouldn't get a -1 anyway, method only called when there is granted space</span></div><div class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当缓存不用了，需要移出这块缓存里的内容。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">findEvict</span><span class="params">(cacheSet <span class="built_in">set</span>, cacheProperty property)</span></span>&#123;</div><div class="line">    <span class="keyword">int</span> min = <span class="built_in">set</span>.lines[<span class="number">0</span>].usedCounter;</div><div class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> index = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; property.E ; i++)&#123;</div><div class="line">        <span class="keyword">if</span>(min&gt;<span class="built_in">set</span>.lines[i].usedCounter)&#123;</div><div class="line">            index = i;</div><div class="line">            min = <span class="built_in">set</span>.lines[i].usedCounter;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> index;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">findMax</span><span class="params">(cacheSet <span class="built_in">set</span>, cacheProperty property)</span></span>&#123;</div><div class="line">    <span class="keyword">int</span> max = <span class="built_in">set</span>.lines[<span class="number">0</span>].usedCounter;</div><div class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> index = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; property.E ; i++)&#123;</div><div class="line">        <span class="keyword">if</span>(<span class="built_in">set</span>.lines[i].usedCounter&gt;max)&#123;</div><div class="line">            index = i;</div><div class="line">            max = <span class="built_in">set</span>.lines[i].usedCounter;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> index;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接下来最关键的是写一个模拟器，模拟cache操作。首先，按照书中的介绍，tag的数量在64位系统下等于64减去块偏移位数量和组索引位数量。根据tag数量，可以求出组索引。接着将这块cache记录到Cache区中。通过循环遍历一块cache块里的行，查看命中情况。</p>
<p>如果命中，更新cache的属性。如果不命中，并且缓存并没满，那么需要添加新的缓存内容。如果因为缓存满了，那么需要将缓存中最先使用的缓存块移除缓存。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="function">cacheProperty <span class="title">simulate</span><span class="params">(cache currentCache,cacheProperty property, <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> address)</span></span>&#123;</div><div class="line">    <span class="comment">//compute the size of the tag, 64 bit system</span></div><div class="line">    <span class="keyword">int</span> tagSize = <span class="number">64</span>-(property.b + property.s);</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> tag = address &gt;&gt; (property.s + property.b);</div><div class="line">    <span class="comment">//use the tagSize to compute for the set index</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> temp = address &lt;&lt; (tagSize);</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> setIndex = temp &gt;&gt; (tagSize + property.b);</div><div class="line">    cacheSet <span class="built_in">set</span> = currentCache.sets[setIndex];</div><div class="line">    <span class="comment">//loop through lines in the set</span></div><div class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> hit = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i&lt;property.E; i++)&#123;</div><div class="line">        setLine currentLine = <span class="built_in">set</span>.lines[i];</div><div class="line">        <span class="comment">//check if there is a hit</span></div><div class="line">        <span class="keyword">if</span>(checkHit(currentLine, tag) == <span class="number">1</span>)&#123;</div><div class="line">            <span class="comment">//if hit, update the staffs in the property</span></div><div class="line">            property.hitNum+=<span class="number">1</span>;</div><div class="line">            <span class="keyword">int</span> max = <span class="number">0</span>;</div><div class="line">            hit = <span class="number">1</span>;</div><div class="line">            max = findMax(<span class="built_in">set</span>, property);</div><div class="line">            currentCache.sets[setIndex].lines[i].usedCounter = currentCache.sets[setIndex].lines[max].usedCounter+<span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>(hit == <span class="number">0</span> &amp;&amp; checkFull(<span class="built_in">set</span>, property) == <span class="number">1</span>)&#123;</div><div class="line">    <span class="comment">//if not full then it is a miss, update the staffs in the property&amp;set</span></div><div class="line">        property.missNum+=<span class="number">1</span>;</div><div class="line">        <span class="keyword">int</span> index = <span class="number">0</span>;</div><div class="line">        index = findIndex(<span class="built_in">set</span>, property);</div><div class="line">        <span class="built_in">set</span>.lines[index].tag = tag;</div><div class="line">        <span class="built_in">set</span>.lines[index].valid = <span class="number">1</span>;</div><div class="line">        <span class="keyword">int</span> max = <span class="number">0</span>;</div><div class="line">        max = findMax(<span class="built_in">set</span>, property);</div><div class="line">        currentCache.sets[setIndex].lines[index].usedCounter = currentCache.sets[setIndex].lines[max].usedCounter+<span class="number">1</span>;</div><div class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(hit == <span class="number">0</span>)&#123;</div><div class="line">        <span class="comment">//evict, update the staffs in the property&amp;set</span></div><div class="line">        property.missNum+=<span class="number">1</span>;</div><div class="line">        property.evictionNum+=<span class="number">1</span>;</div><div class="line">        <span class="keyword">int</span> evictIndex = <span class="number">0</span>;</div><div class="line">        <span class="comment">//find the evict line</span></div><div class="line">        evictIndex = findEvict(<span class="built_in">set</span>, property);</div><div class="line">        <span class="built_in">set</span>.lines[evictIndex].tag = tag;</div><div class="line">        <span class="keyword">int</span> max = <span class="number">0</span>;</div><div class="line">        max = findMax(<span class="built_in">set</span>, property);</div><div class="line">        currentCache.sets[setIndex].lines[evictIndex].usedCounter = currentCache.sets[setIndex].lines[max].usedCounter+<span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> property;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当然最后需要些一个主函数来调用测试接口。这里关于trace文件。每一条对内存访问的记录格式是 [空格]操作符 地址,大小，以 I 开头的是载入指令的记录，不算在内存访问中。</p>
<ul>
<li>M 表示数据修改，需要一次载入 + 一次存储，也就是相当于两次访问</li>
<li>S 表示数据存储</li>
<li>L 表示数据载入</li>
<li>地址指的是一个 64 位的 16 进制内存地址</li>
<li>大小表示该操作内存访问的字节数</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span></span></div><div class="line">&#123;</div><div class="line">    cache currentCache;</div><div class="line">    cacheProperty property;</div><div class="line">    <span class="comment">//initiate the char to store the trace</span></div><div class="line">    <span class="keyword">char</span>* trace;</div><div class="line">    <span class="keyword">char</span> input;</div><div class="line">    property.verbosity = <span class="number">0</span>;</div><div class="line">    <span class="comment">//parse input</span></div><div class="line">    <span class="keyword">while</span>( (input=getopt(argc,argv,<span class="string">"s:E:b:t:vh"</span>)) != <span class="number">-1</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">switch</span>(input)&#123;</div><div class="line">        <span class="keyword">case</span> <span class="string">'s'</span>:</div><div class="line">            property.s = atoi(optarg);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> <span class="string">'E'</span>:</div><div class="line">            property.E = atoi(optarg);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> <span class="string">'b'</span>:</div><div class="line">            property.b = atoi(optarg);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> <span class="string">'t'</span>:</div><div class="line">            trace = optarg;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> <span class="string">'v'</span>:</div><div class="line">            property.verbosity = <span class="number">1</span>;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="comment">//help</span></div><div class="line">        <span class="keyword">case</span> <span class="string">'h'</span>:</div><div class="line">            printUsage();</div><div class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            printUsage();</div><div class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//compute S and B</span></div><div class="line">    property.S = <span class="built_in">pow</span>(<span class="number">2.0</span>,property.s);</div><div class="line">    property.B = <span class="built_in">pow</span>(<span class="number">2.0</span>,property.b);</div><div class="line">    <span class="comment">//initialize the cache</span></div><div class="line">    currentCache = initiate(property.S, property.E);</div><div class="line">    <span class="comment">//initialize the counters</span></div><div class="line">    property.missNum = <span class="number">0</span>;</div><div class="line">    property.hitNum = <span class="number">0</span>;</div><div class="line">    property.evictionNum = <span class="number">0</span>;</div><div class="line">    <span class="comment">//input file</span></div><div class="line">    FILE *tmp;</div><div class="line">    <span class="comment">//wrap the trace into tmp</span></div><div class="line">    <span class="keyword">char</span> command;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> address;</div><div class="line">    <span class="keyword">int</span> size;</div><div class="line">    tmp = fopen(trace, <span class="string">"r"</span>);</div><div class="line">    <span class="keyword">while</span>(<span class="built_in">fscanf</span>(tmp, <span class="string">" %c %llx,%d"</span>, &amp;command, &amp;address, &amp;size) == <span class="number">3</span>)&#123;</div><div class="line">        <span class="keyword">switch</span>(command)&#123;</div><div class="line">            <span class="comment">//just ignore I</span></div><div class="line">            <span class="keyword">case</span> <span class="string">'I'</span>:</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="string">'L'</span>:</div><div class="line">                property = simulate(currentCache, property, address);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="string">'S'</span>:</div><div class="line">                property = simulate(currentCache, property, address);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="comment">//twice for M</span></div><div class="line">            <span class="keyword">case</span> <span class="string">'M'</span>:</div><div class="line">                property = simulate(currentCache, property, address);</div><div class="line">                property = simulate(currentCache, property, address);	</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//print result</span></div><div class="line">    printSummary(property.hitNum, property.missNum, property.evictionNum);</div><div class="line">    fclose(tmp);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="u603B_u7ED3"><a href="#u603B_u7ED3" class="headerlink" title="总结"></a>总结</h2><p>先总结Part A部分。虽然并没有完全动手写这个代码，仅仅是参考分析他人的代码(主要是没看懂trace文件和不知道怎么调用接口)，但对于cache的操作，通过上面分析源码的含义并参考书中的知识，大致有了比较深刻的理解。</p>

            
                

            
        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/csapp/">csapp</a>

            </div>
        
        <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2016/07/12/csapp-lab5-shelllab/"  data-tooltip="CSAPP Lab5 解题分析">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2016/06/02/ml-1/" data-tooltip="Machine Learning Note 1">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://xinqiu.me/2016/06/07/csapp-lab4-cachelab/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://xinqiu.me/2016/06/07/csapp-lab4-cachelab/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://xinqiu.me/2016/06/07/csapp-lab4-cachelab/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#disqus_thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>


        
            
                <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2016 Xin Qiu. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="3">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2016/07/12/csapp-lab5-shelllab/"  data-tooltip="CSAPP Lab5 解题分析">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2016/06/02/ml-1/" data-tooltip="Machine Learning Note 1">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://xinqiu.me/2016/06/07/csapp-lab4-cachelab/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://xinqiu.me/2016/06/07/csapp-lab4-cachelab/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://xinqiu.me/2016/06/07/csapp-lab4-cachelab/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#disqus_thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                <div id="share-options-bar" class="share-options-bar" data-behavior="3">
    <ul class="share-options">
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=http://xinqiu.me/2016/06/07/csapp-lab4-cachelab/">
                <i class="fa fa-google-plus"></i><span class="">Share on Google Plus</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://xinqiu.me/2016/06/07/csapp-lab4-cachelab/">
                <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=http://xinqiu.me/2016/06/07/csapp-lab4-cachelab/">
                <i class="fa fa-twitter"></i><span>Share on Twitter</span>
            </a>
        </li>
    </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-remove"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/avatar.png"/>
        
            <h4 id="about-card-name">Xin Qiu</h4>
        
            <h5 id="about-card-bio"><p>Life is short.<a href="http://xinqiu.me/2015/09/11/Me/">More</a></p>
</h5>
        
        
            <h5 id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Student</p>

            </h5>
        
        
            <h5 id="about-card-location">
                <i class="fa fa-map-marker"></i>
                <br/>
                China Jiangsu
            </h5>
        
    </div>
</div>

        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
    </body>
    <!--SCRIPTS-->
<script src="/assets/js/scrip-gfmrkxcl0qohe3cfdgxhzvc0yrceqta8i4iix0txvn8q4o2adlqd5n0jmkvt.min.js"></script>
<!--SCRIPTS END-->

    
        <script>
             var disqus_config = function () {
                 this.page.url = 'http://xinqiu.me/2016/06/07/csapp-lab4-cachelab/';
                 
                    this.page.identifier = '2016/06/07/csapp-lab4-cachelab/';
                                  
             };
            (function() {
                var d = document, s = d.createElement('script');
                var disqus_shortname = 'xinqiu';
                s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
            })();
        </script>
    



</html>
